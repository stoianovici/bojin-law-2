# Mapa (Document Binder/Dossier) GraphQL Schema
# OPS-101: Mapa GraphQL Schema & Resolvers
#
# Mape are structured document binders with defined slots for expected documents.
# Used for court submissions and organized case documentation.

# ============================================================================
# Enums
# ============================================================================

"""
Status of a slot within a mapa.
"""
enum SlotStatus {
  """No document assigned yet"""
  pending
  """Document request has been sent"""
  requested
  """Document has been received"""
  received
  """Document is final/approved"""
  final
}

# ============================================================================
# Types
# ============================================================================

"""
Mapa entity - a structured document binder with slots for expected documents.
Each slot can be filled with a document or left empty (indicating missing document).
Can be associated with a case (case-level) or a client (client-level).
"""
type Mapa {
  """Unique identifier"""
  id: UUID!

  """Case ID this mapa belongs to (null for client-level mape)"""
  caseId: UUID

  """Client ID this mapa belongs to (null for case-level mape)"""
  clientId: UUID

  """Case this mapa belongs to (null for client-level mape)"""
  case: Case

  """Client this mapa belongs to (null for case-level mape)"""
  client: Client

  """Name of the mapa"""
  name: String!

  """Optional description"""
  description: String

  """Template ID this mapa was created from (if any)"""
  templateId: UUID

  """Template this mapa was created from (if any)"""
  template: MapaTemplate

  """Ordered list of slots in this mapa"""
  slots: [MapaSlot!]!

  """Completion status summary"""
  completionStatus: MapaCompletionStatus!

  """When the mapa was created"""
  createdAt: DateTime!

  """When the mapa was last updated"""
  updatedAt: DateTime!

  """User who created the mapa"""
  createdBy: User!
}

"""
MapaSlot entity - a slot within a mapa that can hold a document.
Slots can be required or optional, and may have a document assigned.
"""
type MapaSlot {
  """Unique identifier"""
  id: UUID!

  """Parent mapa ID"""
  mapaId: UUID!

  """Parent mapa"""
  mapa: Mapa!

  """Name of the slot (e.g., 'Cerere de chemare in judecata')"""
  name: String!

  """Optional description or guidance"""
  description: String

  """Category for grouping (e.g., 'Acte procedurale', 'Dovezi')"""
  category: String

  """Whether this slot is required for completeness"""
  required: Boolean!

  """Order position within the mapa"""
  order: Int!

  """Assigned document (null = empty slot)"""
  document: CaseDocumentWithContext

  """When a document was assigned"""
  assignedAt: DateTime

  """User who assigned the document"""
  assignedBy: User

  """Current status of the slot"""
  status: SlotStatus!

  """When the slot was created"""
  createdAt: DateTime!

  """When the slot was last updated"""
  updatedAt: DateTime!
}

"""
Completion status for a mapa - tracks how many slots are filled.
"""
type MapaCompletionStatus {
  """Total number of slots"""
  totalSlots: Int!

  """Number of slots with documents assigned"""
  filledSlots: Int!

  """Number of required slots"""
  requiredSlots: Int!

  """Number of required slots with documents assigned"""
  filledRequiredSlots: Int!

  """Whether all required slots have documents"""
  isComplete: Boolean!

  """Names of required slots that are empty"""
  missingRequired: [String!]!

  """Percentage of slots filled (0-100)"""
  percentComplete: Float!
}

"""
MapaTemplate entity - a reusable template for creating mape.
Templates define standard slot structures for common case types.
Can be firm-specific or system-wide ONRC templates.
"""
type MapaTemplate {
  """Unique identifier"""
  id: UUID!

  """Template name"""
  name: String!

  """Optional description"""
  description: String

  """Optional case type this template is designed for"""
  caseType: String

  """Slot definitions for the template"""
  slotDefinitions: [SlotDefinition!]!

  """Whether the template is active"""
  isActive: Boolean!

  """When the template was created"""
  createdAt: DateTime!

  """User who created the template (null for system templates)"""
  createdBy: User

  """Number of mape created from this template"""
  usageCount: Int!

  # ONRC-specific fields (for Romanian Trade Registry templates)

  """Whether this is an ONRC system template"""
  isONRC: Boolean!

  """Whether the template is locked from editing (ONRC templates)"""
  isLocked: Boolean!

  """ONRC procedure ID (e.g., 'infiintare-srl')"""
  procedureId: String

  """Source URL of the ONRC page"""
  sourceUrl: String

  """When the template was last synced from ONRC"""
  lastSynced: DateTime

  """Content hash for change detection"""
  contentHash: String

  """AI enhancement metadata (if template was AI-analyzed)"""
  aiMetadata: JSON
}

"""
Result of an ONRC template sync operation
"""
type ONRCSyncResult {
  """Whether the sync was successful"""
  success: Boolean!

  """Human-readable message"""
  message: String!

  """Number of templates synced"""
  syncedCount: Int!

  """Number of templates that failed to sync"""
  errorCount: Int!

  """Detailed errors for failed templates"""
  errors: [ONRCSyncError!]!

  """When the sync was performed"""
  syncedAt: DateTime!
}

"""
Error details for a failed ONRC template sync
"""
type ONRCSyncError {
  """Procedure ID that failed"""
  procedureId: String!

  """Error message"""
  error: String!
}

"""
Slot definition within a template - describes a slot to be created.
"""
type SlotDefinition {
  """Slot name"""
  name: String!

  """Optional description"""
  description: String

  """Optional category"""
  category: String

  """Whether the slot should be required"""
  required: Boolean!

  """Order position"""
  order: Int!
}

# ============================================================================
# Input Types
# ============================================================================

"""Input for creating a new mapa"""
input CreateMapaInput {
  """Case ID where the mapa will be created (required for case-level mapa)"""
  caseId: UUID

  """Client ID where the mapa will be created (required for client-level mapa)"""
  clientId: UUID

  """Name of the mapa"""
  name: String!

  """Optional description"""
  description: String

  """Optional template ID to create mapa from"""
  templateId: UUID
}

"""Input for creating a mapa with slots in one operation (quick list)"""
input CreateMapaWithSlotsInput {
  """Case ID where the mapa will be created (required for case-level mapa)"""
  caseId: UUID

  """Client ID where the mapa will be created (required for client-level mapa)"""
  clientId: UUID

  """Name of the mapa"""
  name: String!

  """Optional description"""
  description: String

  """Slots to create with the mapa"""
  slots: [QuickSlotInput!]!
}

"""Simplified slot input for quick list creation"""
input QuickSlotInput {
  """Slot name"""
  name: String!

  """Whether the slot is required (default: false)"""
  required: Boolean = false
}

"""Input for updating a mapa"""
input UpdateMapaInput {
  """New name"""
  name: String

  """New description"""
  description: String
}

"""Input for creating a new slot"""
input CreateSlotInput {
  """Slot name"""
  name: String!

  """Optional description"""
  description: String

  """Optional category"""
  category: String

  """Whether the slot is required (default: true)"""
  required: Boolean = true

  """Order position"""
  order: Int!
}

"""Input for updating a slot"""
input UpdateSlotInput {
  """New name"""
  name: String

  """New description"""
  description: String

  """New category"""
  category: String

  """Whether the slot is required"""
  required: Boolean

  """New order position"""
  order: Int
}

"""Input for assigning a document to a slot"""
input AssignDocumentInput {
  """Slot ID"""
  slotId: UUID!

  """Case document ID to assign"""
  caseDocumentId: UUID!
}

"""Input for reordering slots"""
input ReorderSlotsInput {
  """Mapa ID"""
  mapaId: UUID!

  """Ordered list of slot IDs"""
  slotIds: [UUID!]!
}

"""Input for creating a template"""
input CreateTemplateInput {
  """Template name"""
  name: String!

  """Optional description"""
  description: String

  """Optional case type"""
  caseType: String

  """Slot definitions"""
  slotDefinitions: [SlotDefinitionInput!]!
}

"""Input for a slot definition within a template"""
input SlotDefinitionInput {
  """Slot name"""
  name: String!

  """Optional description"""
  description: String

  """Optional category"""
  category: String

  """Whether the slot is required (default: true)"""
  required: Boolean = true

  """Order position"""
  order: Int!
}

"""Input for updating a template"""
input UpdateTemplateInput {
  """New name"""
  name: String

  """New description"""
  description: String

  """New case type"""
  caseType: String

  """New slot definitions"""
  slotDefinitions: [SlotDefinitionInput!]

  """Whether the template is active"""
  isActive: Boolean
}

# ============================================================================
# Queries
# ============================================================================

extend type Query {
  """
  Get a single mapa by ID with all slots and completion status.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  mapa(id: UUID!): Mapa

  """
  Get all mape for a case.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  caseMape(caseId: UUID!): [Mapa!]!

  """
  Get all mape for a client (client-level mape, not associated with any case).

  Authorization: User must have access to the client OR be a Partner.
  """
  clientMape(clientId: UUID!): [Mapa!]!

  """
  Get all active mapa templates for the firm.

  Authorization: Any authenticated user in the firm.
  """
  mapaTemplates: [MapaTemplate!]!

  """
  Get a single mapa template by ID.

  Authorization: Any authenticated user in the firm.
  """
  mapaTemplate(id: UUID!): MapaTemplate

  """
  Get all ONRC (system) templates.
  These are official Romanian Trade Registry document templates.

  Authorization: Any authenticated user.
  """
  onrcTemplates: [MapaTemplate!]!

  """
  Get ONRC sync status (last sync time, template count, etc.)

  Authorization: Partner only.
  """
  onrcSyncStatus: ONRCSyncStatus!
}

"""
ONRC sync status information
"""
type ONRCSyncStatus {
  """When templates were last synced"""
  lastSyncAt: DateTime

  """Total number of ONRC templates"""
  templateCount: Int!

  """Number of templates with AI enhancement"""
  aiEnhancedCount: Int!

  """Whether sync is available (has all required config)"""
  syncAvailable: Boolean!
}

# ============================================================================
# Mutations
# ============================================================================

extend type Mutation {
  # --- Mapa CRUD ---

  """
  Create a new mapa for a case.
  If templateId is provided, slots will be created from the template.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  createMapa(input: CreateMapaInput!): Mapa!

  """
  Create a new mapa from a template.
  Note: templateId can be a UUID for firm templates or a string like "onrc-*" for ONRC templates.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  createMapaFromTemplate(templateId: String!, caseId: UUID!): Mapa!

  """
  Create a new mapa with slots in one operation (quick list).
  Useful for creating a mapa with a predefined checklist of expected documents.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  createMapaWithSlots(input: CreateMapaWithSlotsInput!): Mapa!

  """
  Update a mapa's name or description.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  updateMapa(id: UUID!, input: UpdateMapaInput!): Mapa!

  """
  Delete a mapa and all its slots.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  deleteMapa(id: UUID!): Boolean!

  # --- Slot Management ---

  """
  Add a new slot to a mapa.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  addMapaSlot(mapaId: UUID!, input: CreateSlotInput!): MapaSlot!

  """
  Add multiple slots to a mapa at once.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  addMapaSlots(mapaId: UUID!, inputs: [CreateSlotInput!]!): [MapaSlot!]!

  """
  Update a slot's properties.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  updateMapaSlot(slotId: UUID!, input: UpdateSlotInput!): MapaSlot!

  """
  Delete a slot from a mapa.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  deleteMapaSlot(slotId: UUID!): Boolean!

  """
  Reorder slots within a mapa.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  reorderMapaSlots(input: ReorderSlotsInput!): [MapaSlot!]!

  # --- Document Assignment ---

  """
  Assign a document to a slot.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  assignDocumentToSlot(slotId: UUID!, caseDocumentId: UUID!): MapaSlot!

  """
  Remove a document from a slot (unassign).

  Authorization: User must be assigned to the case OR be a Partner.
  """
  unassignDocumentFromSlot(slotId: UUID!): MapaSlot!

  """
  Assign multiple documents to slots at once.

  Authorization: User must be assigned to the case OR be a Partner.
  """
  bulkAssignDocuments(assignments: [AssignDocumentInput!]!): [MapaSlot!]!

  # --- Template Operations (Partner only) ---

  """
  Create a new mapa template for the firm.

  Authorization: Any authenticated user in the firm.
  """
  createMapaTemplate(input: CreateTemplateInput!): MapaTemplate!

  """
  Update a mapa template.

  Authorization: Any authenticated user in the firm.
  """
  updateMapaTemplate(id: UUID!, input: UpdateTemplateInput!): MapaTemplate!

  """
  Delete a mapa template (soft delete).

  Authorization: Any authenticated user in the firm.
  """
  deleteMapaTemplate(id: UUID!): Boolean!

  # --- ONRC Template Operations (Partner only) ---

  """
  Save ONRC templates to the database.
  Called by the sync process after scraping templates from ONRC website.

  Authorization: Partner only.
  """
  saveONRCTemplates(templates: [ONRCTemplateInput!]!): ONRCSyncResult!
}

"""
Input for saving an ONRC template from the sync process
"""
input ONRCTemplateInput {
  """ONRC procedure ID (e.g., 'infiintare-srl')"""
  procedureId: String!

  """Template name"""
  name: String!

  """Description (may include AI summary)"""
  description: String

  """Category (e.g., 'infiintare', 'modificare')"""
  category: String

  """Subcategory (e.g., 'srl', 'sa')"""
  subcategory: String

  """Source URL of the ONRC page"""
  sourceUrl: String!

  """Content hash for change detection"""
  contentHash: String!

  """When the template was scraped"""
  scrapedAt: DateTime!

  """Slot definitions (JSON)"""
  slotDefinitions: JSON!

  """Whether the template was AI-enhanced"""
  aiEnhanced: Boolean

  """AI confidence score (0-1)"""
  aiConfidence: Float

  """AI-generated procedure summary"""
  procedureSummary: String

  """AI-generated legal context"""
  legalContext: String

  """AI warnings/notes"""
  aiWarnings: [String!]
}
