# Case Management GraphQL Schema
# Story 2.6: Case Management Data Model and API

# ============================================================================
# Types
# ============================================================================

"""
User type represents a lawyer or staff member at the firm
"""
type User {
  """Unique identifier for the user"""
  id: UUID!

  """Firm the user belongs to (null for system users)"""
  firmId: UUID

  """User's email address (used for authentication)"""
  email: String!

  """User's first name"""
  firstName: String!

  """User's last name"""
  lastName: String!

  """User's role within the firm"""
  role: UserRole!

  """Timestamp when the user was created"""
  createdAt: DateTime!
}

"""
Client entity - represents the firm's client relationships
"""
type Client {
  """Unique identifier for the client"""
  id: UUID!

  """Firm that manages this client"""
  firmId: UUID!

  """Client's full name or organization name"""
  name: String!

  """Contact information as JSON (phone, email, etc.)"""
  contactInfo: JSON

  """Physical address of the client"""
  address: String

  """Timestamp when the client record was created"""
  createdAt: DateTime!

  """Timestamp when the client record was last updated"""
  updatedAt: DateTime!
}

"""
Case entity - represents legal cases managed by the firm
"""
type Case {
  """Unique identifier for the case"""
  id: UUID!

  """Firm that manages this case"""
  firmId: UUID!

  """Unique case number for tracking (auto-generated)"""
  caseNumber: String!

  """Title or name of the case"""
  title: String!

  """Client associated with this case"""
  client: Client!

  """Current status of the case"""
  status: CaseStatus!

  """Type of legal case (dynamic, from CaseTypeConfig)"""
  type: String!

  """Detailed description of the case"""
  description: String!

  """Date when the case was opened"""
  openedDate: DateTime!

  """Date when the case was closed (null if still open)"""
  closedDate: DateTime

  """Monetary value of the case (optional) - Partners only"""
  value: Float @requiresFinancialAccess

  """Additional case metadata as JSON (optional)"""
  metadata: JSON

  """Billing type for this case (Hourly or Fixed) - Partners only (Story 2.8.1)"""
  billingType: BillingType @requiresFinancialAccess

  """Fixed fee amount in USD cents (required if billingType=FIXED) - Partners only (Story 2.8.1)"""
  fixedAmount: Float @requiresFinancialAccess

  """Custom hourly rates for this case (null = inherit from firm defaults) - Partners only (Story 2.8.1)"""
  customRates: CustomRates @requiresFinancialAccess

  """Rate change history for this case - Partners only (Story 2.8.1)"""
  rateHistory: [RateHistoryEntry!]! @requiresFinancialAccess

  """Retainer amount per billing period in USD cents (Story 2.11.2)"""
  retainerAmount: Float @requiresFinancialAccess

  """Retainer billing period (Story 2.11.2)"""
  retainerPeriod: RetainerPeriod @requiresFinancialAccess

  """Whether unused retainer hours roll over to next period (Story 2.11.2)"""
  retainerRollover: Boolean @requiresFinancialAccess

  """Whether retainer auto-renews each period (Story 2.11.2)"""
  retainerAutoRenew: Boolean @requiresFinancialAccess

  """Current retainer usage for this billing period (Story 2.11.2)"""
  currentRetainerUsage: RetainerUsage @requiresFinancialAccess

  """Approval information for cases requiring Partner approval (Story 2.8.2)"""
  approval: CaseApproval

  """Keywords for email classification (OPS-028)"""
  keywords: [String!]!

  """Reference numbers for email classification - court file numbers, contract refs (OPS-028)"""
  referenceNumbers: [String!]!

  """Email subject patterns for classification - glob-style (OPS-028)"""
  subjectPatterns: [String!]!

  """Free text guidance for AI email classifier (OPS-028)"""
  classificationNotes: String

  """Current sync status for email/document synchronization"""
  syncStatus: CaseSyncStatus!

  """Error message if sync failed (null if not failed)"""
  syncError: String

  """List of team members assigned to this case"""
  teamMembers: [CaseTeam!]!

  """List of external actors involved in this case"""
  actors: [CaseActor!]!

  # ============================================================================
  # Multi-Case Email Support (OPS-060)
  # ============================================================================

  """
  All email links for this case with classification metadata
  """
  emailLinks: [EmailCaseLink!]!

  """
  All emails linked to this case (convenience field)
  Equivalent to Case.emailLinks.map(link => link.email)
  """
  communications: [Email!]!

  """
  Latest health score for this case (OPS-239)
  Updated nightly by batch processor
  """
  latestHealthScore: CaseHealthScore

  """Timestamp when the case was created"""
  createdAt: DateTime!

  """Timestamp when the case was last updated"""
  updatedAt: DateTime!
}

"""
Custom hourly rates for a case (Story 2.8.1)
All rates are in USD cents. If null, inherits from firm defaults.
All fields optional - can override only specific roles.
"""
type CustomRates {
  """Partner hourly rate in USD cents (null = use firm default)"""
  partnerRate: Float

  """Associate hourly rate in USD cents (null = use firm default)"""
  associateRate: Float

  """Paralegal hourly rate in USD cents (null = use firm default)"""
  paralegalRate: Float
}

"""
Rate history entry (Story 2.8.1)
Tracks all changes to case billing rates for audit trail
"""
type RateHistoryEntry {
  """Unique identifier for this history entry"""
  id: UUID!

  """Case this history entry belongs to"""
  caseId: UUID!

  """Timestamp when the rate was changed"""
  changedAt: DateTime!

  """User who changed the rate"""
  changedBy: User!

  """Type of rate that was changed"""
  rateType: RateType!

  """Previous rate value in USD cents"""
  oldRate: Float!

  """New rate value in USD cents"""
  newRate: Float!
}

"""
Case team assignment - represents user assignments to cases
"""
type CaseTeam {
  """Unique identifier for the case team assignment"""
  id: UUID!

  """Case this assignment belongs to"""
  caseId: UUID!

  """User assigned to the case"""
  userId: UUID!

  """User object for the assigned user"""
  user: User!

  """Role of the user on the case team (e.g., Lead, Support, Observer)"""
  role: String!

  """Timestamp when the user was assigned to the case"""
  assignedAt: DateTime!

  """ID of the user who created this assignment (optional)"""
  assignedBy: UUID
}

"""
Case actor - represents external parties involved in a case
These are people/entities external to the firm (clients, opposing parties, witnesses, etc.)
"""
type CaseActor {
  """Unique identifier for the case actor"""
  id: UUID!

  """Case this actor is involved in"""
  caseId: UUID!

  """Role of the actor in the case"""
  role: CaseActorRole!

  """Custom role code for firm-specific actor types (OPS-223)"""
  customRoleCode: String

  """Full name of the actor"""
  name: String!

  """Organization or company the actor represents (optional)"""
  organization: String

  """Email address of the actor (optional)"""
  email: String

  """Additional email domains for this actor - used for email classification (OPS-038)"""
  emailDomains: [String!]!

  """Phone number of the actor (optional)"""
  phone: String

  """Physical address of the actor (optional)"""
  address: String

  """Additional notes about this actor (optional)"""
  notes: String

  """Timestamp when the actor was added to the case"""
  createdAt: DateTime!

  """Timestamp when the actor information was last updated"""
  updatedAt: DateTime!

  """ID of the user who added this actor"""
  createdBy: UUID!
}

"""
Case Health Score - nightly-computed health metrics
OPS-239: Case Health Scoring Processor
"""
type CaseHealthScore {
  """Unique identifier"""
  id: UUID!

  """Case this score belongs to"""
  caseId: UUID!

  """Overall health score (0-100)"""
  score: Int!

  """Activity score component (0-100) - based on days since last activity"""
  activityScore: Int!

  """Email score component (0-100) - based on unanswered emails"""
  emailScore: Int!

  """Task score component (0-100) - based on overdue tasks"""
  taskScore: Int!

  """Deadline score component (0-100) - based on upcoming deadlines"""
  deadlineScore: Int!

  """Top concerns identified by AI (in Romanian)"""
  concerns: [String!]!

  """Suggested actions from AI (in Romanian)"""
  suggestions: [String!]!

  """Risk level: low, medium, high, critical"""
  riskLevel: String!

  """When this score was calculated"""
  calculatedAt: DateTime!
}

"""
Retainer usage for a billing period (Story 2.11.2)
Shows usage, included hours, rollover, and remaining balance
"""
type RetainerUsage {
  """Start date of the billing period"""
  periodStart: DateTime!

  """End date of the billing period"""
  periodEnd: DateTime!

  """Hours used in this period"""
  hoursUsed: Float!

  """Hours included in the retainer"""
  hoursIncluded: Float!

  """Hours rolled over from previous period"""
  rolledOver: Float!

  """Remaining hours available (included + rolledOver - used)"""
  remaining: Float!

  """Utilization percentage (hoursUsed / (hoursIncluded + rolledOver) * 100)"""
  utilizationPercent: Float!
}

"""
Sync status for case email/document synchronization
"""
enum CaseSyncStatus {
  Pending
  Syncing
  Completed
  Failed
}

# ============================================================================
# Input Types
# ============================================================================

"""
Custom rates input for case creation/updates (Story 2.8.1)
All rates are in USD cents. All fields optional.
"""
input CustomRatesInput {
  """Partner hourly rate in USD cents"""
  partnerRate: Float

  """Associate hourly rate in USD cents"""
  associateRate: Float

  """Paralegal hourly rate in USD cents"""
  paralegalRate: Float
}

"""
Input for adding a contact during case creation
"""
input CreateCaseContactInput {
  """Email address of the contact (required)"""
  email: String!

  """Optional name of the contact"""
  name: String

  """Role - use CaseActorRole values (Client, OpposingParty, etc.) or free text"""
  role: String
}

"""
Input for creating a new case
"""
input CreateCaseInput {
  """Title of the case (3-500 characters)"""
  title: String!

  """Court case number / Nr. Dosar Instanță (optional)"""
  caseNumber: String

  """Client name - will create or find existing client"""
  clientName: String!

  """Client email address - used when creating new client"""
  clientEmail: String

  """Client phone number - used when creating new client"""
  clientPhone: String

  """Client physical address - used when creating new client"""
  clientAddress: String

  """Client type: individual or company - used when creating new client"""
  clientType: String

  """Company type: SRL, SA, PFA, etc. - used when creating new client"""
  companyType: String

  """CUI / Cod Fiscal - used when creating new client"""
  clientCui: String

  """Registration number - used when creating new client"""
  clientRegistrationNumber: String

  """Administrators list - used when creating new client"""
  clientAdministrators: [ClientPersonInput!]

  """Contacts list - used when creating new client"""
  clientContacts: [ClientPersonInput!]

  """Type of case (dynamic code from CaseTypeConfig)"""
  type: String!

  """Detailed description of the case (minimum 10 characters)"""
  description: String!

  """Monetary value of the case (optional)"""
  value: Float

  """Additional metadata as JSON (optional)"""
  metadata: JSON

  """Billing type for this case (default: HOURLY) - Story 2.8.1"""
  billingType: BillingType

  """Fixed fee amount in USD cents (required if billingType=FIXED) - Story 2.8.1"""
  fixedAmount: Float

  """Custom hourly rates (optional, overrides firm defaults) - Story 2.8.1"""
  customRates: CustomRatesInput

  """Whether to submit case for approval (default: true for Associates, false for Partners) - Story 2.8.2"""
  submitForApproval: Boolean

  """Contacts to add to the case (triggers historical email sync)"""
  contacts: [CreateCaseContactInput!]

  """Team members to assign to the case (in addition to creator as Lead)"""
  teamMembers: [CreateCaseTeamMemberInput!]

  """Keywords for email classification"""
  keywords: [String!]

  """Reference numbers for email classification - court file numbers, contract refs"""
  referenceNumbers: [String!]
}

"""
Input for assigning a team member during case creation
"""
input CreateCaseTeamMemberInput {
  """User ID to assign"""
  userId: UUID!

  """Role of the user on the case team (Lead, Support, Observer)"""
  role: String!
}

"""
Input for updating an existing case
All fields are optional - only provided fields will be updated
"""
input UpdateCaseInput {
  """Updated title (3-500 characters if provided)"""
  title: String

  """Updated court case number (Nr. Dosar Instanță)"""
  caseNumber: String

  """Updated status"""
  status: CaseStatus

  """Updated case type (dynamic code from CaseTypeConfig)"""
  type: String

  """Updated description"""
  description: String

  """Case closure date"""
  closedDate: DateTime

  """Updated monetary value"""
  value: Float

  """Updated metadata"""
  metadata: JSON

  """Updated billing type - Story 2.8.1"""
  billingType: BillingType

  """Updated fixed fee amount in USD cents - Story 2.8.1"""
  fixedAmount: Float

  """Updated custom rates (use null to revert to firm defaults) - Story 2.8.1"""
  customRates: CustomRatesInput
}

"""
Input for assigning a user to a case team
"""
input AssignTeamInput {
  """Case ID"""
  caseId: UUID!

  """User ID to assign"""
  userId: UUID!

  """Role of the user on the case team (e.g., Lead, Support, Observer)"""
  role: String!
}

"""
Input for adding an external actor to a case
"""
input AddCaseActorInput {
  """Case ID"""
  caseId: UUID!

  """Role of the actor in the case"""
  role: CaseActorRole!

  """Custom role code for firm-specific actor types (OPS-223)"""
  customRoleCode: String

  """Name of the actor (2-200 characters)"""
  name: String!

  """Organization/company name (optional)"""
  organization: String

  """Email address (optional)"""
  email: String

  """Additional email domains for classification (OPS-038)"""
  emailDomains: [String!]

  """Phone number (optional)"""
  phone: String

  """Physical address (optional)"""
  address: String

  """Additional notes about this actor (optional)"""
  notes: String
}

"""
Input for updating a case actor
All fields are optional - only provided fields will be updated
"""
input UpdateCaseActorInput {
  """Updated name (2-200 characters if provided)"""
  name: String

  """Updated organization"""
  organization: String

  """Updated email"""
  email: String

  """Updated email domains for classification (OPS-038)"""
  emailDomains: [String!]

  """Updated phone"""
  phone: String

  """Updated address"""
  address: String

  """Updated notes"""
  notes: String
}

"""
Input for deleting a case with options for handling related data
"""
input DeleteCaseInput {
  """
  If true, documents are archived to client folder.
  If false, in-app documents are deleted, external docs are moved to client.
  """
  archiveDocuments: Boolean!
}

"""
Input for updating case classification metadata (OPS-038)
All fields optional - only provided fields will be updated
"""
input CaseMetadataInput {
  """Court file numbers, contract references (e.g., \"1234/5/2024\")"""
  referenceNumbers: [String!]

  """User-defined keywords for matching emails to this case"""
  keywords: [String!]

  """Email subject patterns for classification - glob-style"""
  subjectPatterns: [String!]

  """Free text guidance for AI email classifier"""
  classificationNotes: String
}

# ============================================================================
# Pagination Types
# ============================================================================

"""
Page info for cursor-based pagination
"""
type PageInfo {
  """Whether there are more items after the current page"""
  hasNextPage: Boolean!
  """Whether there are more items before the current page"""
  hasPreviousPage: Boolean!
  """Cursor of the first item in this page"""
  startCursor: String
  """Cursor of the last item in this page"""
  endCursor: String
}

"""
Case edge for pagination
"""
type CaseEdge {
  """The case"""
  node: Case!
  """Cursor for this case"""
  cursor: String!
}

"""
Paginated cases connection
"""
type CasesConnection {
  """List of case edges"""
  edges: [CaseEdge!]!
  """Pagination info"""
  pageInfo: PageInfo!
  """Total count of matching cases"""
  totalCount: Int!
}

# ============================================================================
# Queries
# ============================================================================

type Query {
  """
  Get multiple cases with optional filters
  Authorization: Partners see all cases, Associates/Paralegals see only assigned cases
  """
  cases(
    """Filter by case status"""
    status: CaseStatus

    """Filter by client ID"""
    clientId: UUID

    """Filter to cases assigned to the current user"""
    assignedToMe: Boolean
  ): [Case!]!

  """
  Get paginated cases with optional filters (cursor-based pagination)
  Authorization: Partners see all cases, Associates/Paralegals see only assigned cases
  """
  paginatedCases(
    """Filter by case status"""
    status: CaseStatus
    """Number of items to fetch (default 50, max 100)"""
    first: Int
    """Cursor to fetch items after"""
    after: String
  ): CasesConnection!

  """
  Get a single case by ID
  Returns null if case not found or user is not authorized to view it
  Authorization: User must be assigned to case OR be a Partner
  """
  case(id: UUID!): Case

  """
  Full-text search across case title, description, and client name
  Returns results ordered by relevance
  Authorization: Respects case access rules (Partners see all, others see assigned only)
  """
  searchCases(
    """Search query (minimum 3 characters)"""
    query: String!

    """Maximum number of results (default 50, max 100)"""
    limit: Int
  ): [Case!]!

  """
  Get all actors for a specific case
  Authorization: User must be assigned to case OR be a Partner
  """
  caseActors(caseId: UUID!): [CaseActor!]!

  """
  Get actors for a case filtered by role
  Authorization: User must be assigned to case OR be a Partner
  """
  caseActorsByRole(
    caseId: UUID!
    role: CaseActorRole!
  ): [CaseActor!]!

  """
  Search clients by name for autocomplete
  Returns clients matching the search query (minimum 1 character)
  Authorization: Authenticated users in the same firm
  """
  searchClients(
    """Search query (minimum 1 character)"""
    query: String!

    """Maximum number of results (default 10, max 50)"""
    limit: Int
  ): [Client!]!

  """
  Get retainer usage for a specific period (Story 2.11.2)
  Returns null if case is not a retainer billing type
  Authorization: Requires financial access (Partner or BusinessOwner)
  """
  retainerUsage(
    """Case ID"""
    caseId: UUID!

    """Start of period to query (optional, defaults to current period)"""
    periodStart: DateTime
  ): RetainerUsage

  """
  Get retainer usage history for a case (Story 2.11.2)
  Returns historical periods in reverse chronological order
  Authorization: Requires financial access (Partner or BusinessOwner)
  """
  retainerUsageHistory(
    """Case ID"""
    caseId: UUID!

    """Maximum number of periods to return (default 12)"""
    limit: Int
  ): [RetainerUsage!]!

  """
  Get cases sorted by health score (OPS-239)
  Returns active cases ordered by score (worst first by default)
  Authorization: Partner role required (dashboard view)
  """
  casesByHealthScore(
    """Maximum score to include (default 100 = all cases)"""
    maxScore: Int

    """Order: asc (worst first) or desc (best first). Default: asc"""
    order: String

    """Maximum number of results (default 50)"""
    limit: Int
  ): [Case!]!

  """
  Get health score history for a case (OPS-239)
  Returns scores in reverse chronological order
  Authorization: User must be assigned to case OR be a Partner
  """
  caseHealthHistory(
    """Case ID"""
    caseId: UUID!

    """Maximum number of scores to return (default 30)"""
    limit: Int
  ): [CaseHealthScore!]!
}

# ============================================================================
# Mutations
# ============================================================================

type Mutation {
  """
  Create a new case
  Side effects: Assigns creator to case team as "Lead", creates audit log entry
  Authorization: Authenticated users can create cases
  """
  createCase(input: CreateCaseInput!): Case!

  """
  Update an existing case
  Side effects: Creates audit log entry for each changed field
  Authorization: User must be on case team OR be a Partner
  """
  updateCase(id: UUID!, input: UpdateCaseInput!): Case!

  """
  Archive a case (sets status to ARCHIVED)
  Side effects: Sets closedDate to current date, creates audit log entry
  Authorization: Partner role required
  """
  archiveCase(id: UUID!): Case!

  """
  Permanently delete a case and all associated data.

  Effects:
  - Tasks are moved to client inbox (unassigned from case)
  - Emails are moved to client inbox (preserve clientId, set state to ClientInbox)
  - Documents: based on input.archiveDocuments:
    - true: Move all to client folder (caseId: null, clientId: X)
    - false: Delete in-app docs, move external docs to client
  - All case-specific data is permanently deleted (AI extractions, summaries, etc.)

  Authorization: Partner role required. Cannot delete archived cases.
  """
  deleteCase(id: UUID!, input: DeleteCaseInput!): Case!

  """
  Assign a user to a case team
  Side effects: Creates case team record, creates audit log entry
  Authorization: User must be on case team OR be a Partner
  """
  assignTeam(input: AssignTeamInput!): CaseTeam!

  """
  Remove a user from a case team
  Side effects: Deletes case team record, creates audit log entry
  Authorization: User must be on case team OR be a Partner
  """
  removeTeamMember(caseId: UUID!, userId: UUID!): Boolean!

  """
  Add an external actor to a case
  Side effects: Creates case actor record, creates audit log entry
  Authorization: User must be on case team OR be a Partner
  """
  addCaseActor(input: AddCaseActorInput!): CaseActor!

  """
  Update an existing case actor
  Side effects: Updates case actor record, creates audit log for changed fields
  Authorization: User must be on case team OR be a Partner
  """
  updateCaseActor(id: UUID!, input: UpdateCaseActorInput!): CaseActor!

  """
  Remove an actor from a case
  Side effects: Deletes case actor record, creates audit log entry
  Authorization: User must be on case team OR be a Partner
  """
  removeCaseActor(id: UUID!): Boolean!

  """
  Update case classification metadata (OPS-038)
  Side effects: Updates case classification fields, creates audit log entry
  Authorization: User must be on case team OR be a Partner
  """
  updateCaseMetadata(caseId: UUID!, input: CaseMetadataInput!): Case!

  """
  Retry a failed case sync
  Side effects: Resets syncStatus to Syncing, queues new sync job
  Authorization: User must be on case team OR be a Partner
  """
  retryCaseSync(caseId: UUID!): Case!
}

# ============================================================================
# Subscriptions
# ============================================================================

"""
GraphQL Subscriptions for real-time updates
"""
type Subscription {
  """
  Placeholder subscription - real subscriptions defined in extensions
  """
  _placeholder: Boolean
}
