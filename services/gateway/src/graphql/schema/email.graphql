# Email Integration GraphQL Schema
# Story 5.1: Email Integration and Synchronization
# OPS-060: Multi-Case Email Support
#
# Provides types and operations for email synchronization,
# threading, categorization, and search.

# ============================================================================
# Types
# ============================================================================

"""
Email address with optional display name
"""
type EmailAddress {
  name: String
  address: String!
}

"""
Classification match type - how an email was linked to a case (OPS-060)
"""
enum ClassificationMatchType {
  """Matched by sender/recipient in CaseActor"""
  Actor
  """Matched court file or contract reference"""
  ReferenceNumber
  """Matched case keywords"""
  Keyword
  """AI semantic similarity match"""
  Semantic
  """Matched global email source (court, authority)"""
  GlobalSource
  """User manually assigned"""
  Manual
  """Matched by conversation thread"""
  ThreadContinuity
}

"""
Email-to-Case link with classification metadata (OPS-060)
Represents a many-to-many relationship between emails and cases
"""
type EmailCaseLink {
  id: ID!
  email: Email!
  case: Case!
  """The ID of the linked case (for convenience)"""
  caseId: ID!
  """Confidence score for this assignment (0.0 - 1.0)"""
  confidence: Float
  """How this link was created"""
  matchType: ClassificationMatchType
  """When this link was created"""
  linkedAt: DateTime!
  """Who created this link - 'auto' or userId"""
  linkedBy: String!
  """Whether this is the primary (first) assignment"""
  isPrimary: Boolean!
}

"""
Email classification state machine (OPS-035)
"""
enum EmailClassificationState {
  """Just synced, not yet processed"""
  Pending
  """Assigned to case (auto or manual)"""
  Classified
  """In NECLAR queue (needs user review)"""
  Uncertain
  """In INSTANȚE folder (court email, no case match)"""
  CourtUnassigned
  """Marked as not relevant"""
  Ignored
}

"""
Email message from Microsoft Graph
"""
type Email {
  id: ID!
  graphMessageId: String!
  conversationId: String
  subject: String!
  bodyPreview: String!
  bodyContent: String!
  bodyContentType: String!
  """AI-cleaned content - new message only, no signatures/quotes (OPS-090)"""
  bodyContentClean: String
  """Source folder: 'inbox' for received emails, 'sent' for sent emails (OPS-091)"""
  folderType: String
  from: EmailAddress!
  toRecipients: [EmailAddress!]!
  ccRecipients: [EmailAddress!]!
  receivedDateTime: DateTime!
  sentDateTime: DateTime!
  hasAttachments: Boolean!
  importance: String!
  isRead: Boolean!
  """Classification state machine (OPS-035)"""
  classificationState: EmailClassificationState!
  """AI confidence score for classification (0.0 - 1.0)"""
  classificationConfidence: Float
  """When the email was classified"""
  classifiedAt: DateTime
  """Who classified the email - 'auto' or userId"""
  classifiedBy: String

  # ============================================================================
  # Multi-Case Support (OPS-060)
  # ============================================================================

  """
  All case links for this email with classification metadata
  Replaces direct case relationship for multi-case support
  """
  caseLinks: [EmailCaseLink!]!

  """
  All cases this email is linked to (convenience field)
  """
  cases: [Case!]!

  """
  The primary case for this email (first/original assignment)
  Returns null if email is not linked to any case
  """
  primaryCase: Case

  """
  @deprecated Use primaryCase instead. Kept for backwards compatibility.
  """
  case: Case

  attachments: [EmailAttachment!]!
  thread: EmailThread
}

"""
Email attachment with storage information
"""
type EmailAttachment {
  id: ID!
  name: String!
  contentType: String!
  size: Int!
  downloadUrl: String
  document: Document
  """
  If attachment was saved as document, reference to that document.
  Alias for 'document' field for semantic clarity.
  """
  savedAsDocument: Document
  """
  Whether user marked this attachment as irrelevant (signature, logo, etc.)
  OPS-136: Allows filtering out non-useful attachments
  """
  irrelevant: Boolean!

  """
  OPS-175: Whether this attachment has been promoted to a working document.
  True if the saved document has promotedToDocumentId in metadata.
  """
  isPromoted: Boolean!

  """
  OPS-175: ID of the promoted working document (if isPromoted is true)
  """
  promotedDocumentId: ID
}

"""
Attachment content for direct download from MS Graph
"""
type AttachmentContent {
  content: String! # Base64 encoded content
  name: String!
  contentType: String!
  size: Int!
}

"""
Email thread (conversation) grouping related messages
"""
type EmailThread {
  id: ID!
  conversationId: String!
  subject: String!
  participantCount: Int!
  messageCount: Int!
  emails: [Email!]!
  case: Case
  hasUnread: Boolean!
  hasAttachments: Boolean!
  lastMessageDate: DateTime!
  firstMessageDate: DateTime!
}

"""
Email synchronization status
"""
type EmailSyncStatus {
  status: String!
  lastSyncAt: DateTime
  emailCount: Int!
  pendingCategorization: Int!
}

"""
Paginated email search results
"""
type EmailSearchResult {
  emails: [Email!]!
  totalCount: Int!
  hasMore: Boolean!
}

"""
Email thread with participant details
"""
type EmailThreadParticipant {
  email: String!
  name: String
  messageCount: Int!
  roles: [String!]!
}

"""
Email categorization result from AI
"""
type EmailCategorizationResult {
  emailId: ID!
  caseId: ID
  confidence: Float!
  reasoning: String!
}

"""
Email statistics for dashboard
"""
type EmailStats {
  totalEmails: Int!
  unreadEmails: Int!
  uncategorizedEmails: Int!
  emailsWithAttachments: Int!
  emailsByCase: [EmailCaseCount!]!
}

type EmailCaseCount {
  caseId: ID!
  caseName: String!
  count: Int!
}

# ============================================================================
# INSTANȚE Types (OPS-040: Court Email Detection)
# ============================================================================

"""
Suggested case for unassigned court emails
"""
type SuggestedCase {
  id: ID!
  caseNumber: String!
  title: String!
  referenceNumbers: [String!]!
}

"""
Unassigned court email for the INSTANȚE folder
"""
type UnassignedCourtEmail {
  id: ID!
  subject: String!
  from: EmailAddress!
  receivedDateTime: DateTime!
  """Reference numbers extracted from email but no case match"""
  extractedReferences: [String!]!
  """If multiple cases match, these are the suggestions"""
  suggestedCases: [SuggestedCase!]!
  """Institution category (Court, Notary, Bailiff, Authority, Other)"""
  institutionCategory: String
  """Body preview for context"""
  bodyPreview: String!
}

# ============================================================================
# NECLAR Types (OPS-042: Classification Modal)
# ============================================================================

"""
Classification signal explaining why a case was suggested
"""
type ClassificationSignal {
  """Signal type: KEYWORD_SUBJECT, KEYWORD_BODY, REFERENCE_NUMBER, RECENT_ACTIVITY, CONTACT_MATCH"""
  type: String!
  """Weight of this signal (higher = more important)"""
  weight: Int!
  """What matched (e.g., the keyword or reference number)"""
  matched: String!
}

"""
Suggested case for uncertain email classification
"""
type UncertainEmailCase {
  id: ID!
  caseNumber: String!
  title: String!
  """Match confidence score (0-100)"""
  score: Int!
  """Signals explaining why this case was suggested"""
  signals: [ClassificationSignal!]!
  """Last activity date for context"""
  lastActivityAt: DateTime
}

"""
Uncertain email from the NECLAR queue
"""
type UncertainEmail {
  id: ID!
  subject: String!
  from: EmailAddress!
  receivedDateTime: DateTime!
  """Body preview for context"""
  bodyPreview: String!
  """Full body content (expandable)"""
  bodyContent: String
  """Suggested cases with confidence scores"""
  suggestedCases: [UncertainEmailCase!]!
  """Reason for uncertainty: AMBIGUOUS, LOW_CONFIDENCE, UNKNOWN_CONTACT"""
  uncertaintyReason: String
}

"""
Result of assigning a court email to a case
"""
type AssignCourtEmailResult {
  email: Email!
  case: Case!
  """Whether reference number was added to case"""
  referenceAdded: Boolean!
}

"""
Action type for classifying uncertain emails
"""
enum ClassificationActionType {
  """Assign email to selected case"""
  ASSIGN_TO_CASE
  """Mark email as not relevant (ignored)"""
  IGNORE
}

"""
Input for classifying an uncertain email
"""
input ClassificationActionInput {
  """Action type: ASSIGN_TO_CASE or IGNORE"""
  type: ClassificationActionType!
  """Case ID - required if type is ASSIGN_TO_CASE"""
  caseId: ID
}

"""
Result of classifying an uncertain email
"""
type ClassifyUncertainEmailResult {
  email: Email!
  """The case it was assigned to (null if ignored)"""
  case: Case
  """Whether this was an ignore action"""
  wasIgnored: Boolean!
}

"""
Result of assigning a thread to a case (OPS-125)
"""
type AssignThreadResult {
  thread: EmailThread!
  """Whether a new contact was auto-added to the case"""
  newContactAdded: Boolean!
  """Name of the added contact (if any)"""
  contactName: String
  """Email of the added contact (if any)"""
  contactEmail: String
}

# ============================================================================
# Inputs
# ============================================================================

"""
Filters for email queries
"""
input EmailFilters {
  caseId: ID
  search: String
  hasAttachments: Boolean
  isUnread: Boolean
  dateFrom: DateTime
  dateTo: DateTime
  uncategorizedOnly: Boolean
  importance: String
}

"""
Filters for email thread queries
"""
input EmailThreadFilters {
  caseId: ID
  hasUnread: Boolean
  hasAttachments: Boolean
  search: String
  dateFrom: DateTime
  dateTo: DateTime
}

# ============================================================================
# Queries
# ============================================================================

extend type Query {
  """
  Search emails with filters and pagination
  """
  emails(filters: EmailFilters, limit: Int, offset: Int): EmailSearchResult!

  """
  Get email threads for current user
  """
  emailThreads(
    filters: EmailThreadFilters
    limit: Int
    offset: Int
  ): [EmailThread!]!

  """
  Get single email thread by conversation ID
  """
  emailThread(conversationId: String!): EmailThread

  """
  Get single email by ID
  """
  email(id: ID!): Email

  """
  Get email synchronization status
  """
  emailSyncStatus: EmailSyncStatus!

  """
  Get thread participants
  """
  emailThreadParticipants(conversationId: String!): [EmailThreadParticipant!]!

  """
  Get email statistics for dashboard
  """
  emailStats: EmailStats!

  """
  Get search suggestions based on email content
  """
  emailSearchSuggestions(prefix: String!): [String!]!

  """
  Get attachment content directly from MS Graph (for download)
  """
  emailAttachmentContent(emailId: ID!, attachmentId: ID!): AttachmentContent

  """
  Get preview URL for an email attachment (OPS-087)
  Returns URL for embedding attachment preview in iframe:
  - PDFs: Direct OneDrive URL (browser renders natively)
  - Office docs: Office Online embed URL
  - Images: Direct OneDrive URL
  Returns null for attachments stored in R2 or unsupported types

  Authorization: User must have access to the email
  """
  attachmentPreviewUrl(attachmentId: ID!): PreviewUrlResponse

  # ============================================================================
  # INSTANȚE Queries (OPS-040)
  # ============================================================================

  """
  Get unassigned court emails for the INSTANȚE folder
  Returns emails from courts/authorities that couldn't be matched to a case
  """
  unassignedCourtEmails(limit: Int, offset: Int): [UnassignedCourtEmail!]!

  """
  Get count of unassigned court emails
  """
  unassignedCourtEmailsCount: Int!

  # ============================================================================
  # NECLAR Queries (OPS-042)
  # ============================================================================

  """
  Get uncertain emails for the NECLAR queue (needs user classification)
  Returns emails with classificationState = Uncertain
  """
  uncertainEmails(limit: Int, offset: Int): [UncertainEmail!]!

  """
  Get count of uncertain emails
  """
  uncertainEmailsCount: Int!

  """
  Get a single uncertain email with full details for the classification modal
  """
  uncertainEmail(id: ID!): UncertainEmail
}

# ============================================================================
# Mutations
# ============================================================================

extend type Mutation {
  """
  Start email synchronization for current user
  """
  startEmailSync: EmailSyncStatus!

  """
  Assign email to a case
  """
  assignEmailToCase(emailId: ID!, caseId: ID!): Email!

  """
  Assign all emails in thread to a case (OPS-125: auto-adds sender as contact)
  """
  assignThreadToCase(conversationId: String!, caseId: ID!): AssignThreadResult!

  """
  Mark email as read/unread
  """
  markEmailRead(emailId: ID!, isRead: Boolean!): Email!

  """
  Mark entire thread as read
  """
  markThreadRead(conversationId: String!): EmailThread!

  """
  Sync attachments for an email
  """
  syncEmailAttachments(emailId: ID!): [EmailAttachment!]!

  """
  Trigger AI categorization for uncategorized emails
  """
  triggerEmailCategorization: Int!

  """
  Backfill AI-cleaned content for existing emails (OPS-090)
  Processes emails without bodyContentClean, extracting new content only.
  Authorization: Partner, Admin, or BusinessOwner role required
  """
  backfillEmailCleanContent(
    """Number of emails to process (default: 50)"""
    limit: Int
  ): Int!

  """
  Create or renew email webhook subscription
  """
  createEmailSubscription: EmailSyncStatus!

  """
  Ignore an email thread (mark as not case-related, hide from main view)
  """
  ignoreEmailThread(conversationId: String!): EmailThread!

  """
  Unignore an email thread (restore to main view)
  """
  unignoreEmailThread(conversationId: String!): EmailThread!

  """
  Send a new email via MS Graph API
  """
  sendNewEmail(input: SendEmailInput!): SendEmailResult!

  """
  Reply to an email thread via MS Graph API
  """
  replyToEmail(input: ReplyEmailInput!): SendEmailResult!

  """
  Bulk clear all case data (emails and documents) - Admin cleanup
  Permanently DELETES all emails linked to the case and all case documents
  Authorization: Partner or BusinessOwner role required
  """
  bulkClearCaseData(caseId: ID!): BulkClearCaseDataResult!

  """
  Permanently delete a single email and all its attachments
  Authorization: Partner or BusinessOwner role required
  """
  permanentlyDeleteEmail(emailId: ID!): DeleteEmailResult!

  """
  Permanently delete all emails linked to a case
  Authorization: Partner or BusinessOwner role required
  """
  bulkDeleteCaseEmails(caseId: ID!): BulkDeleteEmailsResult!

  # ============================================================================
  # INSTANȚE Mutations (OPS-040)
  # ============================================================================

  """
  Assign a court email to a case manually
  Optionally adds the extracted reference number to the case
  """
  assignCourtEmailToCase(
    emailId: ID!
    caseId: ID!
    """If true and there are extracted references, add them to the case"""
    addReference: Boolean
  ): AssignCourtEmailResult!

  # ============================================================================
  # NECLAR Mutations (OPS-042: Classification Modal)
  # ============================================================================

  """
  Classify an uncertain email (NECLAR queue)
  User selects a case or marks as ignored
  """
  classifyUncertainEmail(
    emailId: ID!
    action: ClassificationActionInput!
  ): ClassifyUncertainEmailResult!

  # ============================================================================
  # Multi-Case Email Mutations (OPS-060)
  # ============================================================================

  """
  Link an email to an additional case (multi-case support)
  Creates a new EmailCaseLink for the email-case pair
  """
  linkEmailToCase(
    emailId: ID!
    caseId: ID!
    """Optional: Set as primary case (default: false)"""
    isPrimary: Boolean
  ): EmailCaseLink!

  """
  Remove an email from a case (multi-case support)
  Deletes the EmailCaseLink for the email-case pair
  """
  unlinkEmailFromCase(
    emailId: ID!
    caseId: ID!
  ): Boolean!

  # ============================================================================
  # Attachment Actions (OPS-135)
  # ============================================================================

  """
  Save an email attachment as a case document (OPS-135).
  Creates Document record, uploads to SharePoint, links to case.
  Returns existing document if attachment was already saved.

  Authorization: User must be assigned to the case (via CaseTeam)
  """
  saveEmailAttachmentAsDocument(
    """Email ID containing the attachment"""
    emailId: ID!
    """Attachment ID to save"""
    attachmentId: ID!
    """Case ID to link the document to"""
    caseId: ID!
    """Optional folder ID to place document in specific folder"""
    folderId: ID
  ): SaveAttachmentAsDocumentResult!

  # ============================================================================
  # Attachment Filtering (OPS-136)
  # ============================================================================

  """
  Mark an email attachment as irrelevant (or restore it).
  Used for filtering out signatures, logos, and other non-useful attachments.
  Irrelevant attachments are hidden by default but can be shown with includeIrrelevant flag.

  Authorization: User must have access to the email's case
  """
  markAttachmentIrrelevant(
    """Attachment ID to mark"""
    attachmentId: ID!
    """Whether to mark as irrelevant (true) or restore (false)"""
    irrelevant: Boolean!
  ): EmailAttachment!
}

"""
Result of bulk clearing case data
"""
type BulkClearCaseDataResult {
  emailsDeleted: Int!
  caseDocumentsDeleted: Int!
  documentsDeleted: Int!
  attachmentReferencesCleared: Int!
  success: Boolean!
}

"""
Result of deleting a single email
"""
type DeleteEmailResult {
  success: Boolean!
  attachmentsDeleted: Int!
}

"""
Result of bulk deleting emails for a case
"""
type BulkDeleteEmailsResult {
  emailsDeleted: Int!
  attachmentsDeleted: Int!
  success: Boolean!
}

"""
Result of saving an email attachment as a document (OPS-135)
"""
type SaveAttachmentAsDocumentResult {
  """The created or existing document"""
  document: Document!
  """Whether this was a new document (false if already saved)"""
  isNew: Boolean!
  """OPS-175: The CaseDocument ID linking the document to the case"""
  caseDocumentId: UUID!
}

# ============================================================================
# Input Types for Sending
# ============================================================================

"""
Email attachment input for sending emails
"""
input EmailAttachmentInput {
  name: String!
  contentType: String!
  contentBase64: String!
}

"""
Input for sending a new email
"""
input SendEmailInput {
  to: [String!]!
  cc: [String!]
  subject: String!
  body: String!
  isHtml: Boolean
  caseId: ID
  attachments: [EmailAttachmentInput!]
}

"""
Input for replying to an email
"""
input ReplyEmailInput {
  conversationId: String!
  to: [String!]!
  cc: [String!]
  subject: String!
  body: String!
  isHtml: Boolean
  includeOriginal: Boolean
  attachments: [EmailAttachmentInput!]
}

"""
Result of sending an email
"""
type SendEmailResult {
  success: Boolean!
  messageId: String
  error: String
}

# ============================================================================
# Subscriptions
# ============================================================================

extend type Subscription {
  """
  Subscribe to new email notifications
  """
  emailReceived: Email!

  """
  Subscribe to email sync progress updates
  """
  emailSyncProgress: EmailSyncStatus!

  """
  Subscribe to email categorization results
  """
  emailCategorized: EmailCategorizationResult!
}
