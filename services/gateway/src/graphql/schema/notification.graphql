# Story 2.8.2: Case Approval Workflow - Notifications
# GraphQL schema for in-app notifications

enum NotificationType {
  # Case Approval (Story 2.8.2)
  CasePendingApproval
  CaseApproved
  CaseRejected
  # Document Review (Story 3.6)
  DocumentReviewRequested
  DocumentReviewAssigned
  DocumentApproved
  DocumentRejected
  DocumentRevisionRequested
  DocumentCommentAdded
  DocumentCommentMentioned
  # Task Delegation (Story 4.2)
  DelegationRequested
  DelegationAccepted
  DelegationDeclined
  # Task Reminder and Dependency (Story 4.4)
  TaskDeadlineReminder
  TaskOverdue
  DependencyBlocked
  DependencyUnblocked
  # Task Collaboration (Story 4.6)
  TaskCommentAdded
  TaskCommentMentioned
  TaskCommentReplied
  TaskStatusUpdated
  SubtaskCreated
  TaskAttachmentAdded
  # AI Suggestions (Story 5.4)
  MorningBriefingReady
  AISuggestionCreated
  # Communication Hub (Story 5.5)
  BulkCommunicationCompleted
  CommunicationExportReady
  # Privacy (OPS-191)
  EmailMadePublic
  DocumentMadePublic
  # Case Activity Notifications
  NewEmailWithAttachments
  NewTaskAssigned
  NewEventAssigned
  NewDocumentUploaded
  NewMapaCreated
  MapaCompleted
}

type Notification {
  id: UUID!
  userId: UUID!
  user: User!
  type: NotificationType!
  title: String!
  message: String!
  link: String
  read: Boolean!
  caseId: UUID
  createdAt: DateTime!
  readAt: DateTime
}

extend type Query {
  """
  Get notifications for current user
  Ordered by createdAt descending (newest first)
  Optional filter by read status
  """
  notifications(read: Boolean, limit: Int): [Notification!]!

  """
  Get count of unread notifications for current user
  Used for notification badge
  """
  unreadNotificationCount: Int!
}

extend type Mutation {
  """
  Mark a notification as read
  Returns the updated notification
  """
  markNotificationAsRead(id: UUID!): Notification!

  """
  Mark all notifications as read for current user
  Returns count of notifications marked as read
  """
  markAllNotificationsAsRead: Int!

  # ==========================================================================
  # OPS-120: In-App Notifications (Activity Event-based)
  # ==========================================================================

  """
  Mark an in-app notification as read
  Returns success status
  """
  markInAppNotificationRead(id: ID!): Boolean!

  """
  Mark all in-app notifications as read for current user
  Returns count of notifications marked as read
  """
  markAllInAppNotificationsRead: Int!

  """
  Subscribe to push notifications
  Returns the subscription ID
  """
  subscribeToPush(input: PushSubscriptionInput!): ID!

  """
  Unsubscribe from push notifications
  """
  unsubscribeFromPush(subscriptionId: ID!): Boolean!
}

# ==========================================================================
# OPS-120: In-App Notifications (Activity Event-based)
# ==========================================================================

"""
In-app notification created from user activity events
Part of the Notification Engine (OPS-120)
"""
type InAppNotification {
  id: ID!
  title: String!
  body: String!
  icon: String
  read: Boolean!
  action: NotificationAction
  createdAt: DateTime!
}

"""
Action to perform when notification is clicked
"""
type NotificationAction {
  type: String!
  entityId: ID
  caseId: ID
}

"""
Input for push notification subscription
"""
input PushSubscriptionInput {
  endpoint: String!
  p256dhKey: String!
  authKey: String!
  userAgent: String
}

extend type Query {
  # ==========================================================================
  # OPS-120: In-App Notifications (Activity Event-based)
  # ==========================================================================

  """
  Get in-app notifications for current user
  Returns unread notifications by default, newest first
  """
  inAppNotifications(includeRead: Boolean, limit: Int): [InAppNotification!]!

  """
  Get count of unread in-app notifications
  Used for notification badge in UI
  """
  inAppNotificationCount: Int!

  # ==========================================================================
  # Flipboard-style Briefing (Mobile)
  # ==========================================================================

  """
  Get Flipboard-style pages for mobile briefing
  Returns enriched notifications grouped into magazine-style pages
  @deprecated Use flipboardPagesConnection for pagination support
  """
  flipboardPages(limit: Int): [FlipboardPage!]!

  """
  Get paginated Flipboard-style pages for mobile briefing
  Supports cursor-based pagination for infinite scroll
  """
  flipboardPagesConnection(limit: Int, after: String): FlipboardPagesConnection!
}

# ==========================================================================
# Flipboard Briefing Types (Mobile)
# ==========================================================================

"""
Enrichment status for notifications
"""
enum EnrichmentStatus {
  """Notification is pending AI enrichment"""
  PENDING
  """Notification has been enriched"""
  ENRICHED
}

"""
Enriched notification with AI-generated magazine-style content
"""
type EnrichedNotification {
  id: ID!
  notificationId: ID!
  headline: String!
  summary: String!
  imageUrl: String
  priority: String!
  relatedItems: [RelatedItem!]!
  suggestedActions: [SuggestedAction!]!
  originalTitle: String!
  action: NotificationAction
  createdAt: DateTime!
  read: Boolean!
  enrichmentStatus: EnrichmentStatus!
}

"""
Related item linked to a notification (case, client, task, etc.)
"""
type RelatedItem {
  type: String!
  id: ID!
  title: String!
  subtitle: String
  href: String!
}

"""
Suggested action for a notification
"""
type SuggestedAction {
  id: ID!
  label: String!
  icon: String!
  type: String!
  payload: JSON
  href: String
}

"""
A page in the Flipboard-style briefing (contains 3 notifications)
"""
type FlipboardPage {
  pageIndex: Int!
  layoutVariant: Int!
  notifications: [EnrichedNotification!]!
}

"""
Pagination info for flipboard pages
"""
type FlipboardPageInfo {
  hasNextPage: Boolean!
  endCursor: String
}

"""
Paginated connection for flipboard pages
"""
type FlipboardPagesConnection {
  pages: [FlipboardPage!]!
  pageInfo: FlipboardPageInfo!
  totalCount: Int!
}

extend type Mutation {
  """
  Execute a suggested action from a notification
  """
  executeNotificationAction(notificationId: ID!, actionId: ID!): Boolean!

  """
  Mark a flipboard notification as read by enriched notification ID
  Returns success status
  """
  markFlipboardNotificationRead(id: ID!): Boolean!
}
