# Document Management GraphQL Schema
# Story 2.8.4: Cross-Case Document Linking
# Story 2.9: Document Storage with OneDrive Integration

# ============================================================================
# Types
# ============================================================================

"""
Document entity - owned by Client (not Case) for cross-case sharing
Documents can be linked to multiple cases without file duplication
Story 2.9: Extended with OneDrive integration and versioning
"""
type Document {
  """Unique identifier for the document"""
  id: UUID!

  """Client that owns this document"""
  clientId: UUID!

  """Client object for this document"""
  client: Client!

  """Firm that owns this document (for isolation)"""
  firmId: UUID!

  """Original file name"""
  fileName: String!

  """File MIME type or extension"""
  fileType: String!

  """File size in bytes"""
  fileSize: Int!

  """Storage path in cloud storage"""
  storagePath: String!

  """User who originally uploaded this document"""
  uploadedBy: User!

  """Timestamp when document was uploaded"""
  uploadedAt: DateTime!

  """Additional metadata (tags, description, etc.)"""
  metadata: JSON

  """Cases where this document is linked"""
  linkedCases: [CaseDocumentLink!]!

  """Original case where document was first uploaded (null if uploaded to client directly)"""
  originalCase: Case

  """Timestamp when the document was created"""
  createdAt: DateTime!

  """Timestamp when the document was last updated"""
  updatedAt: DateTime!

  # Story 2.9: OneDrive integration fields

  """OneDrive item ID (null if not synced to OneDrive)"""
  oneDriveId: String

  """Full OneDrive path"""
  oneDrivePath: String

  # OPS-107: SharePoint migration fields

  """Storage type - where the file is physically stored (computed from IDs)"""
  storageType: DocumentStorageType!

  """SharePoint item ID (null if not stored in SharePoint)"""
  sharePointItemId: String

  """Full SharePoint path"""
  sharePointPath: String

  # OPS-107: Thumbnail fields for grid view

  """Small thumbnail URL (48x48) - for list views"""
  thumbnailSmall: String

  """Medium thumbnail URL (176x176) - for compact grid"""
  thumbnailMedium: String

  """Large thumbnail URL (800x800) - for expanded grid view"""
  thumbnailLarge: String

  """Thumbnail generation status (OPS-114)"""
  thumbnailStatus: ThumbnailStatus

  """Document status (DRAFT, FINAL, ARCHIVED)"""
  status: DocumentStatus!

  """Temporary download URL (computed field, expires in ~1 hour)"""
  downloadUrl: String

  """Thumbnail URL (computed field, for preview)"""
  thumbnailUrl: String

  """Version history for the document"""
  versions: [DocumentVersion!]!

  """Number of versions (computed, for UI display)"""
  versionCount: Int!

  # OPS-171: Document source type and review fields

  """Source type indicating origin of document (UPLOAD, EMAIL_ATTACHMENT, AI_GENERATED, TEMPLATE)"""
  sourceType: DocumentSourceType!

  """User assigned to review this document (null if not assigned for review)"""
  reviewer: User

  """When the document was submitted for review (null if not submitted)"""
  submittedAt: DateTime

  # Content extraction fields for AI processing

  """Extracted text content from the document (for AI context)"""
  extractedContent: String

  """When the content was last extracted"""
  extractedContentUpdatedAt: DateTime

  """Content extraction status"""
  extractionStatus: ExtractionStatus!

  """Error message if extraction failed"""
  extractionError: String

  """Whether to process this document with AI (extract content for summaries)"""
  processWithAI: Boolean!

  # ============================================================================
  # Privacy (Private-by-Default)
  # ============================================================================

  """Whether this document is private (visible only to uploader, not team)"""
  isPrivate: Boolean!

  """When the document was made public"""
  markedPublicAt: DateTime

  """User ID who made the document public"""
  markedPublicBy: ID

  # ============================================================================
  # Email Attachment Sender Info
  # ============================================================================

  """Sender name from original email (for EMAIL_ATTACHMENT source type)"""
  senderName: String

  """Sender email address from original email (for EMAIL_ATTACHMENT source type)"""
  senderEmail: String

  # ============================================================================
  # User Description (for scans that can't be AI-processed)
  # ============================================================================

  """User-provided description for documents that can't be AI-processed (scans, etc.)"""
  userDescription: String

  """User who provided the description"""
  userDescriptionBy: User

  """When the description was provided"""
  userDescriptionAt: DateTime

  """Whether this document needs a user description (computed: extraction failed and no description)"""
  needsDescription: Boolean!
}

"""
Document version for tracking changes from OneDrive sync
Story 2.9: Version tracking for bidirectional sync
"""
type DocumentVersion {
  """Unique identifier"""
  id: UUID!

  """Parent document ID"""
  documentId: UUID!

  """Version number (1, 2, 3, etc.)"""
  versionNumber: Int!

  """OneDrive version ID (if synced from OneDrive)"""
  oneDriveVersionId: String

  """Summary of changes in this version"""
  changesSummary: String

  """User who created this version"""
  createdBy: User!

  """Timestamp when version was created"""
  createdAt: DateTime!

  """File size of this version in bytes"""
  fileSize: Int
}

"""
Document status enum - simplified 3-status workflow
Team members draft in Word, supervisors review in Word, status tracking only.
"""
enum DocumentStatus {
  """Work in progress"""
  DRAFT

  """Team member marked ready for supervisor review"""
  READY_FOR_REVIEW

  """Supervisor approved, locked"""
  FINAL
}

"""
OPS-114: Thumbnail generation status
"""
enum ThumbnailStatus {
  """Thumbnail not yet generated"""
  PENDING

  """Thumbnail currently being generated"""
  PROCESSING

  """Thumbnail successfully generated and stored"""
  COMPLETED

  """Thumbnail generation failed"""
  FAILED

  """File type doesn't support thumbnails"""
  NOT_SUPPORTED
}

"""
Content extraction status for AI processing
"""
enum ExtractionStatus {
  """Content extraction not requested"""
  NONE

  """Extraction queued, awaiting processing"""
  PENDING

  """Currently extracting content"""
  PROCESSING

  """Content successfully extracted"""
  COMPLETED

  """Content extraction failed"""
  FAILED

  """File type doesn't support text extraction"""
  UNSUPPORTED
}

"""
Case-Document link information
Shows details about how a document is linked to a specific case
"""
type CaseDocumentLink {
  """Case ID this document is linked to"""
  caseId: UUID!

  """Case object"""
  case: Case!

  """User who linked this document to the case"""
  linkedBy: User!

  """When the document was linked to this case"""
  linkedAt: DateTime!

  """True if document was originally uploaded to this case, false if imported"""
  isOriginal: Boolean!

  # OPS-171: Promotion tracking

  """True if this was promoted from an email attachment"""
  promotedFromAttachment: Boolean!
}

"""
Document in case context
Includes document details plus case-specific linking information
"""
type CaseDocumentWithContext {
  """ID of the CaseDocument record (for folder operations)"""
  id: UUID!

  """The document"""
  document: Document!

  """User who linked this document to the case"""
  linkedBy: User!

  """When the document was linked to this case"""
  linkedAt: DateTime!

  """True if document was uploaded to this case, false if imported from another case"""
  isOriginal: Boolean!

  """Source case if document was imported (null if original upload)"""
  sourceCase: Case

  # OPS-171: Promotion tracking

  """True if this was promoted from an email attachment"""
  promotedFromAttachment: Boolean!

  """ID of the original email attachment if promoted"""
  originalAttachmentId: UUID

  """Original received date - from email if promoted from attachment, otherwise linkedAt"""
  receivedAt: DateTime!

  """Folder ID if document is in a folder (null if at case root)"""
  folderId: UUID
}

"""
Documents grouped by source case
Used in document browser modal
"""
type DocumentsByCase {
  """The case these documents came from"""
  case: Case!

  """Documents from this case"""
  documents: [Document!]!

  """Number of documents in this case"""
  documentCount: Int!
}

# OPS-107: Grid view types for document display

"""
Paginated connection for document grid view
"""
type DocumentGridConnection {
  """List of document edges"""
  edges: [DocumentGridEdge!]!

  """Pagination info"""
  pageInfo: PageInfo!

  """Total number of documents matching filters"""
  totalCount: Int!
}

"""
Edge type for document grid pagination
"""
type DocumentGridEdge {
  """The document with context"""
  node: CaseDocumentWithContext!

  """Cursor for pagination"""
  cursor: String!
}

"""
Pagination info for connections
"""
type PageInfo {
  """Whether there are more items after this page"""
  hasNextPage: Boolean!

  """Whether there are items before this page"""
  hasPreviousPage: Boolean!

  """Cursor of the first item"""
  startCursor: String

  """Cursor of the last item"""
  endCursor: String
}

"""
Document audit log entry
Tracks all document operations for compliance
"""
type DocumentAuditLog {
  """Unique identifier"""
  id: UUID!

  """Document ID (null if permanently deleted)"""
  documentId: UUID

  """User who performed the action"""
  user: User!

  """Action performed"""
  action: DocumentAuditAction!

  """Related case (for link/unlink operations)"""
  caseId: UUID

  """Additional details about the action"""
  details: JSON

  """When the action occurred"""
  timestamp: DateTime!
}

# ============================================================================
# Enums
# ============================================================================

"""
Document storage type - indicates where the file is physically stored
OPS-107: Added for SharePoint migration
"""
enum DocumentStorageType {
  """Legacy - personal OneDrive (before SharePoint migration)"""
  ONEDRIVE

  """New - firm SharePoint site (default for new uploads)"""
  SHAREPOINT

  """Fallback - Cloudflare R2 storage"""
  R2
}

"""
Sort fields for document grid (OPS-107)
"""
enum DocumentSortField {
  """Sort by when document was linked to case"""
  LINKED_AT

  """Sort by when document was uploaded"""
  UPLOADED_AT

  """Sort by file name"""
  FILE_NAME

  """Sort by file size"""
  FILE_SIZE

  """Sort by file type"""
  FILE_TYPE
}

"""
Sort direction
"""
enum SortDirection {
  """Ascending order"""
  ASC

  """Descending order"""
  DESC
}

"""
Document audit action types
"""
enum DocumentAuditAction {
  """Document was uploaded"""
  UPLOADED

  """Document was linked to a case"""
  LINKED_TO_CASE

  """Document was unlinked from a case"""
  UNLINKED_FROM_CASE

  """Document was permanently deleted (Partners only)"""
  PERMANENTLY_DELETED

  """Document metadata was updated"""
  METADATA_UPDATED
}

# ============================================================================
# Input Types
# ============================================================================

"""
Input for uploading a new document
Story 2.9: Extended with OneDrive integration fields
Supports both case-level and client-level uploads (for client inbox)
"""
input UploadDocumentInput {
  """Case ID where document is being uploaded (optional - provide caseId OR clientId)"""
  caseId: UUID

  """Client ID for client inbox upload (optional - provide caseId OR clientId)"""
  clientId: UUID

  """Original file name"""
  fileName: String!

  """File MIME type"""
  fileType: String!

  """File size in bytes"""
  fileSize: Int!

  """Storage path after file upload (optional if uploading to OneDrive)"""
  storagePath: String

  """Optional metadata (tags, description)"""
  metadata: JSON

  """Optional title for the document"""
  title: String

  """Optional description"""
  description: String

  """Upload to OneDrive (default: true)"""
  uploadToOneDrive: Boolean
}

"""
Input for uploading a document with file data (Story 2.9)
Used when uploading directly via GraphQL with base64 file content
"""
input UploadDocumentWithFileInput {
  """Case ID where document is being uploaded (optional - provide caseId OR clientId)"""
  caseId: UUID

  """Client ID for client inbox upload (optional - provide caseId OR clientId)"""
  clientId: UUID

  """Optional folder ID to place the document in"""
  folderId: UUID

  """Original file name"""
  fileName: String!

  """File MIME type"""
  fileType: String!

  """Base64 encoded file content"""
  fileContent: String!

  """Optional title for the document"""
  title: String

  """Optional description"""
  description: String

  """Parse document content immediately (high priority) instead of queuing"""
  parseImmediately: Boolean
}

"""
Input for updating document status
Story 2.9: Allow changing document status
"""
input UpdateDocumentStatusInput {
  """New document status"""
  status: DocumentStatus!
}

"""
Input for linking existing documents to a case
"""
input LinkDocumentsInput {
  """Target case ID"""
  caseId: UUID!

  """Document IDs to link (can link multiple at once)"""
  documentIds: [UUID!]!
}

"""
Input for updating document metadata
"""
input UpdateDocumentMetadataInput {
  """Optional new tags"""
  tags: [String!]

  """Optional description"""
  description: String

  """Any additional metadata"""
  custom: JSON
}

# ============================================================================
# Queries
# ============================================================================

extend type Query {
  """
  Get all documents for a client
  Used in document browser modal to show available documents for import

  Authorization: User must have access to at least one of the client's cases
  """
  clientDocuments(
    """Client ID to get documents for"""
    clientId: UUID!

    """Optional: Exclude documents already linked to this case"""
    excludeCaseId: UUID

    """Optional: Search filter (filename, description)"""
    search: String

    """Optional: Filter by file types"""
    fileTypes: [String!]
  ): [Document!]!

  """
  Get documents for a client grouped by source case
  Organized view for document browser modal

  Authorization: User must have access to at least one of the client's cases
  """
  clientDocumentsGroupedByCase(
    """Client ID to get documents for"""
    clientId: UUID!

    """Optional: Exclude documents from this case"""
    excludeCaseId: UUID

    """Optional: Search filter"""
    search: String
  ): [DocumentsByCase!]!

  """
  Get all documents linked to a specific case

  Authorization: User must be assigned to case OR be a Partner
  """
  caseDocuments(
    """Case ID"""
    caseId: UUID!
    """Exclude documents assigned to mapa slots (default: true)"""
    excludeMapaAssigned: Boolean = true
  ): [CaseDocumentWithContext!]!

  """
  Get documents in a client's inbox (not assigned to any case yet)
  These are email attachments synced at the client level awaiting case assignment.

  Authorization: User must have access to the client
  """
  clientInboxDocuments(
    """Client ID"""
    clientId: UUID!
  ): [CaseDocumentWithContext!]!

  """
  Get a single document by ID

  Authorization: User must have access to at least one case the document is linked to
  """
  document(id: UUID!): Document

  """
  Get audit history for a document

  Authorization: User must have access to the document
  """
  documentAuditHistory(
    """Document ID"""
    documentId: UUID!

    """Maximum number of entries to return"""
    limit: Int
  ): [DocumentAuditLog!]!

  """
  Get version history for a document (OPS-176)
  Returns all versions ordered by version number (newest first)

  Authorization: User must have access to the document
  """
  documentVersions(
    """Document ID"""
    documentId: UUID!
  ): [DocumentVersion!]!

  """
  Get document thumbnail (Story 2.9 AC5)
  Returns thumbnail URL for document preview

  Authorization: User must have access to the document
  """
  getDocumentThumbnail(
    """Document ID"""
    documentId: UUID!
  ): ThumbnailResponse

  """
  Get preview URL for a document (OPS-087)
  Returns URL for embedding document preview in iframe:
  - PDFs: Direct OneDrive URL (browser renders natively)
  - Office docs: Office Online embed URL
  - Images: Direct OneDrive URL

  Authorization: User must have access to the document
  """
  documentPreviewUrl(
    """Document ID"""
    documentId: UUID!
  ): PreviewUrlResponse

  """
  Get text content for a text file document (OPS-109)
  Fetches and returns the actual content for text files (txt, csv, json, etc.)
  This proxies through the backend to avoid CORS issues with SharePoint

  Authorization: User must have access to the document
  """
  documentTextContent(
    """Document ID"""
    documentId: UUID!
  ): TextContentResponse

  # OPS-107: Grid view queries

  """
  Get case documents with thumbnails for grid view display
  Returns paginated documents with pre-fetched thumbnail URLs

  Authorization: User must be assigned to case OR be a Partner
  """
  caseDocumentsGrid(
    """Case ID"""
    caseId: UUID!

    """Number of documents to return (default: 20)"""
    first: Int

    """Cursor for pagination"""
    after: String

    """Filter by file types (e.g., ['application/pdf', 'image/*'])"""
    fileTypes: [String!]

    """OPS-173: Filter by document source types (e.g., [UPLOAD, AI_GENERATED])"""
    sourceTypes: [DocumentSourceType!]

    """OPS-173: Include promoted attachments in working documents tab"""
    includePromotedAttachments: Boolean

    """Sort field (default: linkedAt)"""
    sortBy: DocumentSortField

    """Sort direction (default: DESC)"""
    sortDirection: SortDirection
  ): DocumentGridConnection!

  # Simplified Review Queue

  """
  Get documents pending review by the current user
  Returns documents where:
  - Current user is supervisor (from case team)
  - Document status is DRAFT or READY_FOR_REVIEW

  Authorization: PARTNER or SENIOR_ASSOCIATE role required
  """
  documentsForReview: [DocumentForReview!]!

  """
  Get count of documents pending review by the current user
  Used to display badge on the review tab.

  Authorization: PARTNER or SENIOR_ASSOCIATE role required
  """
  documentsForReviewCount: Int!
}

# ============================================================================
# Review Queue Types
# ============================================================================

"""
Document pending review with case context
"""
type DocumentForReview {
  """Unique identifier (same as document ID for simplicity)"""
  id: ID!

  """The document pending review"""
  document: Document!

  """The case this document belongs to"""
  case: Case!
}

# ============================================================================
# Mutations
# ============================================================================

extend type Mutation {
  """
  Upload a new document to a case
  Creates document owned by case's client and links it to the case

  Authorization: User must be assigned to case OR be a Partner
  """
  uploadDocument(input: UploadDocumentInput!): Document!

  """
  Link existing documents to a case (import from other cases)

  Authorization: User must be assigned to target case OR be a Partner
  All documents must belong to the same client as the case
  """
  linkDocumentsToCase(input: LinkDocumentsInput!): [Document!]!

  """
  Unlink a document from a case (soft delete)
  Document remains in storage and other cases

  Authorization: User must be assigned to case OR be a Partner
  """
  unlinkDocumentFromCase(
    """Case ID to unlink from"""
    caseId: UUID!

    """Document ID to unlink"""
    documentId: UUID!
  ): Boolean!

  """
  Permanently delete a document (Partners only)
  Removes from all cases and deletes from storage

  Authorization: Partner role required
  """
  permanentlyDeleteDocument(
    """Document ID to delete"""
    documentId: UUID!
  ): Boolean!

  """
  Bulk delete all documents linked to a case (Admin cleanup)
  Removes CaseDocument links, clears EmailAttachment references, deletes Document records

  Authorization: Partner role required
  """
  bulkDeleteCaseDocuments(
    """Case ID to delete all documents from"""
    caseId: UUID!
  ): BulkDeleteResult!

  """
  Update document metadata

  Authorization: User must have access to the document
  """
  updateDocumentMetadata(
    """Document ID"""
    documentId: UUID!

    """Updated metadata"""
    input: UpdateDocumentMetadataInput!
  ): Document!

  """
  Rename a document (OPS-162)
  Updates the fileName in database. Does NOT rename in SharePoint/OneDrive storage.

  Authorization: User must have access to the document
  """
  renameDocument(
    """Document ID"""
    documentId: UUID!

    """New file name (including extension)"""
    newFileName: String!
  ): Document!

  # Story 2.9: OneDrive integration mutations

  """
  Upload document with file content to OneDrive
  Creates document in OneDrive, syncs metadata to database

  Authorization: User must be assigned to case OR be a Partner
  """
  uploadDocumentToOneDrive(input: UploadDocumentWithFileInput!): Document!

  """
  Get temporary download URL for a document
  Returns a pre-signed URL that expires in 1 hour

  Authorization: User must have access to the document
  """
  getDocumentDownloadUrl(
    """Document ID"""
    documentId: UUID!
  ): DownloadUrlResponse!

  """
  Sync document from OneDrive
  Fetches latest metadata and creates new version if changed

  Authorization: User must have access to the document
  """
  syncDocumentFromOneDrive(
    """Document ID"""
    documentId: UUID!
  ): SyncResult!

  """
  Update document status

  Authorization: User must have access to the document
  """
  updateDocumentStatus(
    """Document ID"""
    documentId: UUID!

    """New status"""
    input: UpdateDocumentStatusInput!
  ): Document!

  """
  Share a document with the organization (OPS-104)
  Creates an organization-scoped sharing link so all firm members can access the file
  This is required for documents uploaded before organization sharing was enabled

  Authorization: User must have access to the document
  """
  shareDocumentWithOrganization(
    """Document ID"""
    documentId: UUID!
  ): ShareDocumentResult!

  """
  Batch share all documents for a case with the organization (OPS-104)
  Useful for backfilling existing documents that were uploaded before org sharing

  Authorization: Partner role required
  """
  batchShareCaseDocuments(
    """Case ID to share all documents for"""
    caseId: UUID!
  ): BatchShareResult!

  # OPS-108: SharePoint upload mutation

  """
  Upload document to SharePoint firm storage (OPS-108)
  Creates document in firm's SharePoint site under Cases/{CaseNumber}/Documents/
  All firm members can access documents stored in SharePoint

  Authorization: User must be assigned to case OR be a Partner
  """
  uploadDocumentToSharePoint(input: UploadDocumentWithFileInput!): Document!

  """
  Promote an email attachment to a working document (OPS-175)
  Creates an editable copy of an email attachment in the working documents folder,
  enabling version tracking and editing workflow.

  The original attachment remains in the correspondence tab for reference.
  A link is maintained between the promoted document and original attachment.

  Authorization: User must be assigned to case OR be a Partner
  Roles: Partner, Associate, Paralegal
  """
  promoteAttachmentToDocument(input: PromoteAttachmentInput!): PromoteAttachmentResult!

  # ==========================================================================
  # Content Extraction for AI
  # ==========================================================================

  """
  Enable or disable AI processing for a document
  When enabling, queues content extraction job if not already extracted.
  When disabling, clears extracted content.

  Authorization: User must have access to the document
  """
  setDocumentProcessWithAI(documentId: UUID!, processWithAI: Boolean!): Document!

  # ==========================================================================
  # Simplified Review Workflow Mutations
  # ==========================================================================

  """
  Mark a document as ready for review
  Sets document status to READY_FOR_REVIEW.
  Supervisor is derived from the case team (Partner/team lead).

  Conditions:
  - Document must be in DRAFT status
  - User must be the document author

  Authorization: User must be the document author
  """
  markReadyForReview(documentId: ID!): Document!

  """
  Mark a document as final (supervisor approval)
  Sets document status to FINAL.

  Conditions:
  - Document must be in READY_FOR_REVIEW status
  - User must be a supervisor (derived from case team)

  Authorization: User must be a supervisor for the document's case
  """
  markFinal(documentId: ID!): Document!

  # ============================================================================
  # Privacy Mutations (Private-by-Default)
  # ============================================================================

  """
  Make a private document public (visible to team)
  Only the document owner (uploader) can make their documents public.

  Authorization: User must be the document uploader (Partner/BusinessOwner)
  """
  markDocumentPublic(
    """Document ID to make public"""
    documentId: UUID!
  ): Document!

  """
  Make a public document private (hidden from team)
  Only the document owner (uploader) can make their documents private.

  Authorization: User must be the document uploader (Partner/BusinessOwner)
  """
  markDocumentPrivate(
    """Document ID to make private"""
    documentId: UUID!
  ): Document!

  """
  Make a private email attachment public (visible to team)
  Only the email owner can make their attachments public.
  Attachments can be made public independently of the parent email.

  Authorization: User must be the email owner (Partner/BusinessOwner)
  """
  markAttachmentPublic(
    """Attachment ID to make public"""
    attachmentId: UUID!
  ): EmailAttachment!

  # ============================================================================
  # User Description Mutations (for scans/failed extraction)
  # ============================================================================

  """
  Set a user-provided description for a document that can't be AI-processed.
  Useful for scanned documents, images, or files with failed content extraction.
  The description will be included in AI context instead of extracted content.

  Triggers case context document invalidation for all linked cases.

  Authorization: User must have access to the document
  """
  setDocumentDescription(
    """Document ID"""
    documentId: UUID!
    """User-provided description of the document contents"""
    description: String!
  ): DocumentDescriptionResult!

  """
  Remove user description from a document.
  Clears the userDescription, userDescriptionBy, and userDescriptionAt fields.

  Authorization: User must have access to the document
  """
  removeDocumentDescription(
    """Document ID"""
    documentId: UUID!
  ): Boolean!

  """
  Create a blank Word document and open it for editing
  Creates a new empty .docx file in SharePoint, registers it in the database,
  and returns URLs to open it in Word.

  Supports two modes:
  - Case-level: Creates in Cases/{CaseNumber}/Documents/ with caseId
  - Client inbox: Creates in Clients/{ClientName}/Documents/ with clientId

  Flow:
  1. Creates blank .docx file in SharePoint (case or client folder)
  2. Creates Document record (linked to case or client inbox)
  3. Acquires document lock for editing
  4. Returns Word protocol URL and web URL for editing

  Authorization: User must be assigned to case OR have client access OR be a Partner
  """
  createBlankDocument(input: CreateBlankDocumentInput!): CreateBlankDocumentResult!
}

# ============================================================================
# Create Blank Document Types
# ============================================================================

"""
Input for creating a blank Word document
Supports both case-level and client-level (inbox) document creation
"""
input CreateBlankDocumentInput {
  """Case ID where the document will be created (optional - provide caseId OR clientId)"""
  caseId: UUID

  """Client ID for client inbox document (optional - provide caseId OR clientId)"""
  clientId: UUID

  """File name for the new document (without extension, .docx will be added)"""
  fileName: String!
}

"""
Result of creating a blank document
"""
type CreateBlankDocumentResult {
  """Whether the operation was successful"""
  success: Boolean!

  """The newly created document (null if failed)"""
  document: Document

  """ms-word: protocol URL to open in Word desktop"""
  wordUrl: String

  """Web URL for Word Online fallback"""
  webUrl: String

  """Lock token for the editing session"""
  lockToken: String

  """When the lock expires"""
  lockExpiresAt: DateTime

  """Error message if the operation failed"""
  error: String
}

# ============================================================================
# Response Types (Story 2.9)
# ============================================================================

"""
Result of setting document description
"""
type DocumentDescriptionResult {
  """Whether the operation was successful"""
  success: Boolean!

  """The document ID"""
  documentId: ID!

  """The description that was set"""
  description: String!

  """User who set the description"""
  describedBy: User!

  """When the description was set"""
  describedAt: DateTime!
}

"""
Result of bulk delete operation
"""
type BulkDeleteResult {
  """Number of CaseDocument links deleted"""
  caseDocumentsDeleted: Int!

  """Number of EmailAttachment references cleared"""
  attachmentReferencesCleared: Int!

  """Number of Document records deleted"""
  documentsDeleted: Int!

  """Number of files deleted from OneDrive"""
  oneDriveFilesDeleted: Int!

  """Whether the operation was successful"""
  success: Boolean!
}

"""
Response for download URL request
"""
type DownloadUrlResponse {
  """Pre-signed download URL"""
  url: String!

  """Expiration time for the URL"""
  expirationDateTime: DateTime!
}

"""
Result of document sync operation
"""
type SyncResult {
  """Whether the document was updated"""
  updated: Boolean!

  """New version number if updated"""
  newVersionNumber: Int

  """The synced document"""
  document: Document!
}

"""
Thumbnail response for document preview (Story 2.9 AC5)
"""
type ThumbnailResponse {
  """Thumbnail URL (either base64 data URI or OneDrive URL)"""
  url: String!

  """Source of the thumbnail (local, onedrive, or cache)"""
  source: String!
}

"""
Preview URL response for document preview (OPS-087)
OPS-183: Added syncResult for auto-sync integration
"""
type PreviewUrlResponse {
  """Preview URL for embedding in iframe"""
  url: String!

  """Source of the preview (pdf, office365, image)"""
  source: String!

  """Expiration time for the URL"""
  expiresAt: DateTime!

  """OPS-183: Sync result if document was synced from SharePoint before preview"""
  syncResult: PreviewSyncResult
}

"""
OPS-183: Sync result included in preview URL response
Indicates if a new version was synced from SharePoint during preview access
"""
type PreviewSyncResult {
  """Whether a new version was synced from SharePoint"""
  synced: Boolean!

  """New version number if sync occurred"""
  newVersionNumber: Int
}

"""
Text content response for text file preview (OPS-109)
"""
type TextContentResponse {
  """The text content of the file"""
  content: String!

  """File MIME type"""
  mimeType: String!

  """File size in bytes"""
  size: Int!
}

"""
Result of sharing a document with the organization (OPS-104)
"""
type ShareDocumentResult {
  """Whether the sharing was successful"""
  success: Boolean!

  """The document that was shared"""
  document: Document!

  """Web URL for the sharing link (if created)"""
  sharingLinkUrl: String
}

"""
Result of batch sharing documents (OPS-104)
"""
type BatchShareResult {
  """Total number of documents processed"""
  total: Int!

  """Number successfully shared"""
  shared: Int!

  """Number that failed to share"""
  failed: Int!

  """Number already shared (skipped)"""
  skipped: Int!

  """Whether the operation was successful"""
  success: Boolean!
}

# ============================================================================
# OPS-175: Promote Attachment to Working Document
# ============================================================================

"""
Input for promoting an email attachment to a working document
"""
input PromoteAttachmentInput {
  """ID of the CaseDocument record linking the attachment to the case"""
  caseDocumentId: UUID!

  """Optional folder ID in the working documents section to place the new document"""
  targetFolderId: UUID
}

"""
Result of promoting an attachment to a working document
"""
type PromoteAttachmentResult {
  """Whether the promotion was successful"""
  success: Boolean!

  """The newly created working document (null if failed)"""
  document: Document

  """The new CaseDocument link for the working document (null if failed)"""
  caseDocument: CaseDocumentWithContext

  """Error message if the promotion failed"""
  error: String
}

# ============================================================================
# Storage Quota
# ============================================================================

"""
OneDrive storage quota information
"""
type StorageQuota {
  """Total storage in bytes"""
  total: Float!

  """Used storage in bytes"""
  used: Float!

  """Remaining storage in bytes"""
  remaining: Float!

  """Storage state: normal, nearing, critical, or exceeded"""
  state: String!
}

extend type Query {
  """
  Get OneDrive storage quota for the current user
  Returns total, used, and remaining storage in bytes

  Authorization: Requires authenticated user with Microsoft connection
  """
  storageQuota: StorageQuota

  """
  Get document counts for all cases the user has access to.
  Returns case ID and total document count for sidebar display.

  Authorization: Requires authenticated user
  """
  caseDocumentCounts: [CaseDocumentCount!]!

  """
  Get clients that have documents in their inbox (not assigned to any case).
  Used to show the "Client Inbox" section in the documents sidebar.

  Authorization: Requires authenticated user
  """
  clientsWithInboxDocuments: [ClientInboxInfo!]!

  """
  Get recent documents from cases the current user has access to.
  Used in the dashboard for junior associates to show their recent documents.
  Returns documents ordered by most recent uploadedAt.

  Authorization: Requires authenticated user
  """
  myRecentDocuments(
    """Maximum number of documents to return (default: 5)"""
    limit: Int
  ): [RecentDocument!]!
}

"""
Client with inbox document count (for sidebar display)
"""
type ClientInboxInfo {
  """Client ID"""
  clientId: UUID!

  """Client name"""
  clientName: String!

  """Number of documents in the client's inbox (not assigned to any case)"""
  inboxDocumentCount: Int!
}

"""
Document count for a single case
"""
type CaseDocumentCount {
  """Case ID"""
  caseId: UUID!

  """Total number of documents linked to this case"""
  documentCount: Int!
}

"""
Recent document for dashboard widget
"""
type RecentDocument {
  """Document ID"""
  id: UUID!

  """File name"""
  fileName: String!

  """File type (MIME type or extension)"""
  fileType: String!

  """When the document was uploaded"""
  uploadedAt: DateTime!

  """Case this document is linked to"""
  case: Case!
}

