generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pg_trgm, uuid_ossp(map: "uuid-ossp"), vector]
}

model Firm {
  id                           String                        @id @default(uuid())
  name                         String                        @db.VarChar(200)
  defaultRates                 Json?                         @map("default_rates")
  createdAt                    DateTime                      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                    DateTime                      @updatedAt @map("updated_at") @db.Timestamptz(6)
  documentTemplateUrl          String?                       @map("document_template_url") @db.VarChar(1000)
  documentTemplateDriveItemId  String?                       @map("document_template_drive_item_id") @db.VarChar(255)
  documentTemplateFileName     String?                       @map("document_template_file_name") @db.VarChar(255)
  actorTypeConfigs             ActorTypeConfig[]
  aiConversations              AIConversation[]
  aiModelConfigs               AIModelConfig[]
  suggestions                  AISuggestion[]
  bulkCommunications           BulkCommunication[]
  approvals                    CaseApproval[]
  billingHistory               CaseBillingHistory[]
  caseChapters                 CaseChapter[]
  caseContextDocuments         CaseContextDocument[]
  caseContextFiles             CaseContextFile[]
  caseDocuments                CaseDocument[]
  rateHistory                  CaseRateHistory[]
  caseTypeConfigs              CaseTypeConfig[]
  cases                        Case[]
  caseComprehensions           CaseComprehension[]
  clientContextDocuments       ClientContextDocument[]
  clients                      Client[]
  communicationEntries         CommunicationEntry[]
  communicationExports         CommunicationExport[]
  communicationTemplates       CommunicationTemplate[]
  contextProfiles              ContextProfile[]
  documentAuditLogs            DocumentAuditLog[]
  documentFolders              DocumentFolder[]
  documentStructurePreferences DocumentStructurePreference[]
  documents                    Document[]
  draftEditHistory             DraftEditHistory[]
  classificationLogs           EmailClassificationLog[]
  emailDrafts                  EmailDraft[]
  emails                       Email[]
  extractedActionItems         ExtractedActionItem[]
  extractedCommitments         ExtractedCommitment[]
  extractedDeadlines           ExtractedDeadline[]
  extractedQuestions           ExtractedQuestion[]
  globalEmailSources           GlobalEmailSource[]
  invoices                     Invoice[]
  mapaTemplates                MapaTemplate[]
  morningBriefings             MorningBriefing[]
  firmBriefings                FirmBriefing[]
  firmBriefingRuns             FirmBriefingRun[]
  userFlipboards               UserFlipboard[]
  userFlipboardRuns            UserFlipboardRun[]
  oblioConfig                  OblioConfig?
  pendingClassifications       PendingClassification[]
  personalSnippets             PersonalSnippet[]
  personalThreads              PersonalThread[]
  responseTimePatterns         ResponseTimePattern[]
  riskIndicators               RiskIndicator[]
  sentEmailDrafts              SentEmailDraft[]
  taskCreationPatterns         TaskCreationPattern[]
  taskTemplates                TaskTemplate[]
  tasks                        Task[]
  teamChatMessages             TeamChatMessage[]
  threadSummaries              ThreadSummary[]
  timeEntries                  TimeEntry[]
  userActionPatterns           UserActionPattern[]
  activityEvents               UserActivityEvent[]
  users                        User[]
  wordContentTemplates         WordContentTemplate[]
  writingStyleProfiles         WritingStyleProfile[]
  contextFiles                 ContextFile[]

  @@map("firms")
}

model User {
  id                           String                        @id @default(uuid())
  firmId                       String?                       @map("firm_id")
  email                        String                        @unique @db.VarChar(255)
  firstName                    String                        @map("first_name") @db.VarChar(100)
  lastName                     String                        @map("last_name") @db.VarChar(100)
  role                         UserRole                      @default(AssociateJr)
  status                       UserStatus                    @default(Pending)
  azureAdId                    String                        @unique @map("azure_ad_id") @db.VarChar(255)
  preferences                  Json                          @default("{}")
  hasOperationalOversight      Boolean                       @default(false) @map("has_operational_oversight")
  createdAt                    DateTime                      @default(now()) @map("created_at") @db.Timestamptz(6)
  lastActive                   DateTime                      @default(now()) @map("last_active") @db.Timestamptz(6)
  createdActorTypes            ActorTypeConfig[]             @relation("ActorTypeCreator")
  aiConversations              AIConversation[]
  aiModelConfigUpdates         AIModelConfig[]               @relation("AIModelConfigUpdater")
  suggestions                  AISuggestion[]
  bulkCommunications           BulkCommunication[]           @relation("BulkCommunicationCreator")
  caseActivities               CaseActivityEntry[]           @relation("CaseActivityActor")
  createdCaseActors            CaseActor[]
  reviewedApprovals            CaseApproval[]                @relation("CaseApprovalReviewer")
  submittedApprovals           CaseApproval[]                @relation("CaseApprovalSubmitter")
  caseAuditLogs                CaseAuditLog[]
  billingHistoryEntries        CaseBillingHistory[]
  linkedDocuments              CaseDocument[]                @relation("DocumentLinker")
  caseNotes                    CaseNote[]
  rateChanges                  CaseRateHistory[]
  caseSubscriptions            CaseSubscription[]
  assignedCases                CaseTeam[]                    @relation("AssignedBy")
  cases                        CaseTeam[]
  createdCaseTypes             CaseTypeConfig[]
  assignedClients              ClientTeam[]                  @relation("ClientAssignedBy")
  clients                      ClientTeam[]                  @relation("ClientTeamMembers")
  sentCommunications           CommunicationEntry[]          @relation("CommunicationSender")
  communicationExports         CommunicationExport[]         @relation("CommunicationExporter")
  createdTemplates             CommunicationTemplate[]       @relation("TemplateCreator")
  documentAuditLogs            DocumentAuditLog[]            @relation("DocumentAuditUser")
  documentEditSessions         DocumentEditSession[]         @relation("DocumentEditSessionUser")
  documentStructurePreferences DocumentStructurePreference[]
  documentVersions             DocumentVersion[]             @relation("DocumentVersionCreator")
  reviewingDocuments           Document[]                    @relation("DocumentReviewer")
  uploadedDocuments            Document[]                    @relation("DocumentUploader")
  describedDocuments           Document[]                    @relation("DocumentDescriptionUser")
  draftEditHistory             DraftEditHistory[]
  classificationLogs           EmailClassificationLog[]
  emailDrafts                  EmailDraft[]
  emailSyncState               EmailSyncState?
  emails                       Email[]
  inAppNotifications           InAppNotification[]
  enrichedNotifications        EnrichedNotification[]
  createdInvoices              Invoice[]                     @relation("InvoiceCreator")
  assignedSlots                MapaSlot[]                    @relation("SlotAssigner")
  createdMapaTemplates         MapaTemplate[]                @relation("MapaTemplateCreator")
  createdMape                  Mapa[]                        @relation("MapaCreator")
  morningBriefings             MorningBriefing[]
  firmBriefings                FirmBriefing[]
  firmBriefingRuns             FirmBriefingRun[]
  userFlipboard                UserFlipboard?
  userFlipboardRuns            UserFlipboardRun[]
  notifications                Notification[]
  resolvedClassifications      PendingClassification[]
  personalContacts             PersonalContact[]
  personalSnippets             PersonalSnippet[]
  personalThreads              PersonalThread[]
  pushSubscriptions            PushSubscription[]
  responseTimePatterns         ResponseTimePattern[]
  sentEmailDrafts              SentEmailDraft[]
  taskAttachments              TaskAttachment[]              @relation("TaskAttachmentUploader")
  taskAttendees                TaskAttendee[]
  taskComments                 TaskComment[]                 @relation("TaskCommentAuthor")
  taskCreationPatterns         TaskCreationPattern[]
  delegationsFrom              TaskDelegation[]              @relation("DelegationDelegator")
  delegationsTo                TaskDelegation[]              @relation("DelegationDelegate")
  taskDocumentLinks            TaskDocumentLink[]
  taskHistoryActions           TaskHistory[]                 @relation("TaskHistoryActor")
  assignedTasks                Task[]                        @relation("TaskAssignee")
  createdTasks                 Task[]                        @relation("TaskCreator")
  sentChatMessages             TeamChatMessage[]             @relation("SentChatMessages")
  timeEntries                  TimeEntry[]
  actionPatterns               UserActionPattern[]
  activityEvents               UserActivityEvent[]
  auditLogsAsAdmin             UserAuditLog[]                @relation("AuditLogAdmin")
  auditLogsAsUser              UserAuditLog[]                @relation("AuditLogUser")
  delegatedFor                 UserAvailability[]            @relation("UserDelegates")
  availabilities               UserAvailability[]            @relation("UserAvailabilities")
  dailyContext                 UserDailyContext?
  skills                       UserSkill[]
  workloadSettings             UserWorkloadSettings?
  firm                         Firm?                         @relation(fields: [firmId], references: [id])
  wordTemplatesCreated         WordContentTemplate[]         @relation("WordTemplateCreator")
  writingStyleProfile          WritingStyleProfile?

  @@map("users")
}

model UserAuditLog {
  id          String          @id @default(uuid())
  userId      String          @map("user_id")
  action      UserAuditAction
  adminUserId String          @map("admin_user_id")
  oldValue    String?         @map("old_value") @db.VarChar(255)
  newValue    String?         @map("new_value") @db.VarChar(255)
  timestamp   DateTime        @default(now()) @db.Timestamptz(6)
  admin       User            @relation("AuditLogAdmin", fields: [adminUserId], references: [id])
  user        User            @relation("AuditLogUser", fields: [userId], references: [id])

  @@map("user_audit_logs")
}

model GraphSubscription {
  id                 String    @id @default(uuid())
  subscriptionId     String    @unique @map("subscription_id") @db.VarChar(255)
  resource           String    @db.VarChar(500)
  changeTypes        String    @map("change_types") @db.VarChar(255)
  notificationUrl    String    @map("notification_url")
  clientState        String?   @map("client_state") @db.VarChar(255)
  expirationDateTime DateTime  @map("expiration_datetime") @db.Timestamptz(6)
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  lastRenewedAt      DateTime? @map("last_renewed_at") @db.Timestamptz(6)
  isActive           Boolean   @default(true) @map("is_active")

  @@index([expirationDateTime])
  @@index([isActive])
  @@map("graph_subscriptions")
}

model CaseTypeConfig {
  id        String   @id @default(uuid())
  firmId    String   @map("firm_id")
  name      String   @db.VarChar(100)
  code      String   @db.VarChar(50)
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String   @map("created_by")
  creator   User     @relation(fields: [createdBy], references: [id])
  firm      Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@unique([firmId, code])
  @@index([firmId])
  @@map("case_type_configs")
}

model ActorTypeConfig {
  id        String   @id @default(uuid())
  firmId    String   @map("firm_id")
  name      String   @db.VarChar(100)
  code      String   @db.VarChar(50)
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy String   @map("created_by")
  creator   User     @relation("ActorTypeCreator", fields: [createdBy], references: [id])
  firm      Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@unique([firmId, code])
  @@index([firmId])
  @@map("actor_type_configs")
}

model Client {
  id                 String                 @id @default(uuid())
  firmId             String                 @map("firm_id")
  name               String                 @db.VarChar(200)
  contactInfo        Json                   @default("{}") @map("contact_info")
  address            String?
  createdAt          DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime               @updatedAt @map("updated_at") @db.Timestamptz(6)
  clientType         String?                @default("company") @map("client_type") @db.VarChar(20)
  companyType        String?                @map("company_type") @db.VarChar(20)
  cui                String?                @db.VarChar(20)
  registrationNumber String?                @map("registration_number") @db.VarChar(50)
  administrators     Json                   @default("[]")
  contacts           Json                   @default("[]")
  billingType        BillingType?           @default(Hourly) @map("billing_type")
  customRates        Json?                  @map("custom_rates")
  fixedAmount        Decimal?               @map("fixed_amount") @db.Decimal(15, 2)
  retainerAmount     Decimal?               @map("retainer_amount") @db.Decimal(15, 2)
  retainerAutoRenew  Boolean                @default(false) @map("retainer_auto_renew")
  retainerPeriod     RetainerPeriod?        @map("retainer_period")
  retainerRollover   Boolean                @default(false) @map("retainer_rollover")
  inboxDocuments     CaseDocument[]         @relation("ClientInboxDocuments")
  cases              Case[]
  contextDocument    ClientContextDocument?
  unifiedContextFile ContextFile?           @relation("UnifiedClientContextFile")
  teamMembers        ClientTeam[]
  firm               Firm                   @relation(fields: [firmId], references: [id])
  documentFolders    DocumentFolder[]       @relation("ClientFolders")
  documents          Document[]
  inboxEmails        Email[]                @relation("ClientInboxEmails")
  invoices           Invoice[]
  mape               Mapa[]                 @relation("ClientMape")
  inboxTasks         Task[]                 @relation("ClientInboxTasks")
  timeEntries        TimeEntry[]

  @@unique([firmId, name])
  @@index([firmId])
  @@map("clients")
}

model ClientTeam {
  id         String   @id @default(uuid())
  clientId   String   @map("client_id")
  userId     String   @map("user_id")
  role       String   @db.VarChar(50)
  assignedAt DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)
  assignedBy String?  @map("assigned_by")
  assigner   User?    @relation("ClientAssignedBy", fields: [assignedBy], references: [id])
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user       User     @relation("ClientTeamMembers", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clientId, userId])
  @@index([clientId])
  @@index([userId])
  @@map("client_team")
}

model GlobalEmailSource {
  id                 String                    @id @default(uuid())
  firmId             String                    @map("firm_id")
  category           GlobalEmailSourceCategory
  name               String                    @db.VarChar(200)
  domains            String[]                  @default([])
  emails             String[]                  @default([])
  classificationHint String?                   @map("classification_hint")
  createdAt          DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime                  @updatedAt @map("updated_at") @db.Timestamptz(6)
  firm               Firm                      @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@index([firmId])
  @@index([category])
  @@map("global_email_sources")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Case {
  id                      String                   @id @default(uuid())
  firmId                  String                   @map("firm_id")
  caseNumber              String                   @map("case_number") @db.VarChar(100)
  title                   String                   @db.VarChar(500)
  clientId                String                   @map("client_id")
  status                  CaseStatus               @default(Active)
  description             String
  openedDate              DateTime                 @map("opened_date") @db.Date
  closedDate              DateTime?                @map("closed_date") @db.Date
  value                   Decimal?                 @db.Decimal(15, 2)
  metadata                Json                     @default("{}")
  createdAt               DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime                 @updatedAt @map("updated_at") @db.Timestamptz(6)
  billingType             BillingType              @default(Hourly) @map("billing_type")
  customRates             Json?                    @map("custom_rates")
  fixedAmount             Decimal?                 @map("fixed_amount") @db.Decimal(15, 2)
  contentEmbedding        Unsupported("vector")?   @map("content_embedding")
  searchText              String?                  @map("search_text")
  retainerAmount          Decimal?                 @map("retainer_amount") @db.Decimal(15, 2)
  retainerAutoRenew       Boolean                  @default(false) @map("retainer_auto_renew")
  retainerPeriod          RetainerPeriod?          @map("retainer_period")
  retainerRollover        Boolean                  @default(false) @map("retainer_rollover")
  type                    String                   @db.VarChar(50)
  keywords                String[]                 @default([])
  referenceNumbers        String[]                 @default([]) @map("reference_numbers")
  subjectPatterns         String[]                 @default([]) @map("subject_patterns")
  companyDomain           String?                  @map("company_domain") @db.VarChar(255)
  classificationNotes     String?                  @map("classification_notes")
  searchTerms             String?                  @map("search_terms")
  searchTermsUpdatedAt    DateTime?                @map("search_terms_updated_at") @db.Timestamptz(6)
  syncError               String?                  @map("sync_error")
  syncStatus              CaseSyncStatus           @default(Pending) @map("sync_status")
  aiConversations         AIConversation[]
  suggestions             AISuggestion[]
  bulkCommunications      BulkCommunication[]
  activityFeed            CaseActivityEntry[]
  actors                  CaseActor[]
  approval                CaseApproval?
  auditLogs               CaseAuditLog[]
  billingHistory          CaseBillingHistory[]
  briefing                CaseBriefing?
  chapters                CaseChapter[]
  contextDocument         CaseContextDocument?
  contextFiles            CaseContextFile[]
  unifiedContextFile      ContextFile?             @relation("UnifiedCaseContextFile")
  documents               CaseDocument[]
  healthScores            CaseHealthScore[]
  notes                   CaseNote[]
  rateHistory             CaseRateHistory[]
  subscriptions           CaseSubscription[]
  summary                 CaseSummary?
  teamMembers             CaseTeam[]
  client                  Client                   @relation(fields: [clientId], references: [id])
  firm                    Firm                     @relation(fields: [firmId], references: [id])
  communicationEntries    CommunicationEntry[]
  communicationExports    CommunicationExport[]
  documentFolders         DocumentFolder[]
  emailLinks              EmailCaseLink[]
  classificationLogsFrom  EmailClassificationLog[] @relation("ClassificationFromCase")
  classificationLogsTo    EmailClassificationLog[] @relation("ClassificationToCase")
  emailDrafts             EmailDraft[]
  emails                  Email[]
  extractedActionItems    ExtractedActionItem[]
  extractedCommitments    ExtractedCommitment[]
  extractedDeadlines      ExtractedDeadline[]
  extractedQuestions      ExtractedQuestion[]
  historicalEmailSyncJobs HistoricalEmailSyncJob[]
  invoices                Invoice[]
  mape                    Mapa[]
  riskIndicators          RiskIndicator[]
  sentEmailDrafts         SentEmailDraft[]
  tasks                   Task[]
  threadSummaries         ThreadSummary[]
  timeEntries             TimeEntry[]
  comprehension           CaseComprehension?

  @@unique([firmId, caseNumber])
  @@index([firmId])
  @@index([clientId])
  @@index([status])
  @@index([openedDate])
  @@map("cases")
}

model CaseTeam {
  id         String   @id @default(uuid())
  caseId     String   @map("case_id")
  userId     String   @map("user_id")
  role       String   @db.VarChar(50)
  assignedAt DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)
  assignedBy String?  @map("assigned_by")
  assigner   User?    @relation("AssignedBy", fields: [assignedBy], references: [id])
  case       Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([caseId, userId])
  @@index([caseId])
  @@index([userId])
  @@map("case_team")
}

model CaseNote {
  id        String   @id @default(uuid())
  caseId    String   @map("case_id")
  firmId    String   @map("firm_id")
  authorId  String   @map("author_id")
  content   String
  color     String   @default("yellow") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([firmId])
  @@index([authorId])
  @@map("case_notes")
}

model CaseAuditLog {
  id        String   @id @default(uuid())
  caseId    String   @map("case_id")
  userId    String?  @map("user_id")
  action    String   @db.VarChar(100)
  fieldName String?  @map("field_name") @db.VarChar(100)
  oldValue  String?  @map("old_value")
  newValue  String?  @map("new_value")
  timestamp DateTime @default(now()) @db.Timestamptz(6)
  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([caseId])
  @@index([timestamp])
  @@map("case_audit_logs")
}

model CaseActor {
  id                 String        @id @default(uuid())
  caseId             String        @map("case_id")
  role               CaseActorRole
  name               String        @db.VarChar(200)
  organization       String?       @db.VarChar(200)
  email              String?       @db.VarChar(255)
  phone              String?       @db.VarChar(50)
  address            String?
  notes              String?
  createdAt          DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy          String?       @map("created_by")
  emailDomains       String[]      @default([]) @map("email_domains")
  customRoleCode     String?       @map("custom_role_code") @db.VarChar(50)
  communicationNotes String?       @map("communication_notes")
  preferredTone      String?       @map("preferred_tone") @db.VarChar(50)
  case               Case          @relation(fields: [caseId], references: [id], onDelete: Cascade)
  creator            User?         @relation(fields: [createdBy], references: [id])

  @@index([caseId])
  @@map("case_actors")
}

model CaseApproval {
  id              String         @id @default(uuid())
  caseId          String         @unique @map("case_id")
  submittedBy     String         @map("submitted_by")
  submittedAt     DateTime       @default(now()) @map("submitted_at") @db.Timestamptz(6)
  reviewedBy      String?        @map("reviewed_by")
  reviewedAt      DateTime?      @map("reviewed_at") @db.Timestamptz(6)
  status          ApprovalStatus @default(Pending)
  rejectionReason String?        @map("rejection_reason")
  revisionCount   Int            @default(0) @map("revision_count")
  firmId          String         @map("firm_id")
  case            Case           @relation(fields: [caseId], references: [id], onDelete: Cascade)
  firm            Firm           @relation(fields: [firmId], references: [id])
  reviewer        User?          @relation("CaseApprovalReviewer", fields: [reviewedBy], references: [id])
  submitter       User           @relation("CaseApprovalSubmitter", fields: [submittedBy], references: [id])

  @@index([caseId])
  @@index([status])
  @@index([submittedBy])
  @@index([firmId])
  @@map("case_approvals")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String           @db.VarChar(200)
  message   String
  link      String?          @db.VarChar(500)
  read      Boolean          @default(false)
  caseId    String?          @map("case_id")
  createdAt DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  readAt    DateTime?        @map("read_at") @db.Timestamptz(6)
  taskId    String?          @map("task_id")
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

model CaseRateHistory {
  id        String   @id @default(uuid())
  caseId    String   @map("case_id")
  changedAt DateTime @default(now()) @map("changed_at") @db.Timestamptz(6)
  changedBy String   @map("changed_by")
  rateType  RateType @map("rate_type")
  oldRate   Decimal  @map("old_rate") @db.Decimal(15, 2)
  newRate   Decimal  @map("new_rate") @db.Decimal(15, 2)
  firmId    String   @map("firm_id")
  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  changer   User     @relation(fields: [changedBy], references: [id])
  firm      Firm     @relation(fields: [firmId], references: [id])

  @@index([caseId])
  @@index([changedAt])
  @@index([firmId])
  @@map("case_rate_history")
}

model CaseBillingHistory {
  id                String           @id @default(uuid())
  caseId            String           @map("case_id")
  firmId            String           @map("firm_id")
  invoiceId         String?          @map("invoice_id")
  eventType         BillingEventType @map("event_type")
  billingType       BillingType      @map("billing_type")
  amountEur         Decimal          @map("amount_eur") @db.Decimal(15, 2)
  previousAmountEur Decimal?         @map("previous_amount_eur") @db.Decimal(15, 2)
  notes             String?
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy         String           @map("created_by")
  case              Case             @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user              User             @relation(fields: [createdBy], references: [id])
  firm              Firm             @relation(fields: [firmId], references: [id])
  invoice           Invoice?         @relation(fields: [invoiceId], references: [id])

  @@index([caseId])
  @@index([invoiceId])
  @@index([firmId])
  @@index([createdAt])
  @@index([eventType])
  @@map("case_billing_history")
}

model TimeEntry {
  id               String            @id @default(uuid())
  caseId           String?           @map("case_id")
  userId           String            @map("user_id")
  date             DateTime          @db.Date
  hours            Decimal           @db.Decimal(5, 2)
  hourlyRate       Decimal           @map("hourly_rate") @db.Decimal(15, 2)
  description      String
  billable         Boolean           @default(true)
  firmId           String            @map("firm_id")
  createdAt        DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  narrative        String?
  taskId           String?           @map("task_id")
  clientId         String?           @map("client_id")
  invoiceLineItems InvoiceLineItem[]
  case             Case?             @relation(fields: [caseId], references: [id], onDelete: Cascade)
  client           Client?           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  firm             Firm              @relation(fields: [firmId], references: [id])
  task             Task?             @relation(fields: [taskId], references: [id])
  user             User              @relation(fields: [userId], references: [id])

  @@index([caseId])
  @@index([clientId])
  @@index([userId])
  @@index([taskId])
  @@index([date])
  @@index([firmId])
  @@map("time_entries")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model Document {
  id                        String                    @id @default(uuid())
  clientId                  String                    @map("client_id")
  firmId                    String                    @map("firm_id")
  fileName                  String                    @map("file_name") @db.VarChar(500)
  fileType                  String                    @map("file_type") @db.VarChar(100)
  fileSize                  Int                       @map("file_size")
  storagePath               String                    @map("storage_path")
  uploadedBy                String                    @map("uploaded_by")
  uploadedAt                DateTime                  @default(now()) @map("uploaded_at") @db.Timestamptz(6)
  metadata                  Json                      @default("{}")
  createdAt                 DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                 DateTime                  @updatedAt @map("updated_at") @db.Timestamptz(6)
  oneDriveId                String?                   @map("one_drive_id") @db.VarChar(255)
  oneDrivePath              String?                   @map("one_drive_path")
  status                    DocumentStatus            @default(DRAFT)
  metadataEmbedding         Unsupported("vector")?    @map("metadata_embedding")
  oneDriveUserId            String?                   @map("one_drive_user_id") @db.VarChar(255)
  sharePointItemId          String?                   @map("share_point_item_id") @db.VarChar(255)
  sharePointPath            String?                   @map("share_point_path")
  thumbnailSmallUrl         String?                   @map("thumbnail_small_url")
  thumbnailMediumUrl        String?                   @map("thumbnail_medium_url")
  thumbnailLargeUrl         String?                   @map("thumbnail_large_url")
  thumbnailStatus           ThumbnailStatus           @default(PENDING) @map("thumbnail_status")
  thumbnailError            String?                   @map("thumbnail_error") @db.VarChar(500)
  sourceType                DocumentSourceType        @default(UPLOAD) @map("source_type")
  reviewerId                String?                   @map("reviewer_id")
  submittedAt               DateTime?                 @map("submitted_at") @db.Timestamptz(6)
  sharePointLastModified    DateTime?                 @map("share_point_last_modified") @db.Timestamptz(6)
  sharePointETag            String?                   @map("share_point_etag") @db.VarChar(255)
  searchTerms               String?                   @map("search_terms")
  searchTermsUpdatedAt      DateTime?                 @map("search_terms_updated_at") @db.Timestamptz(6)
  extractedContent          String?                   @map("extracted_content")
  extractedContentUpdatedAt DateTime?                 @map("extracted_content_updated_at") @db.Timestamptz(6)
  extractionStatus          DocumentExtractionStatus  @default(NONE) @map("extraction_status")
  extractionError           String?                   @map("extraction_error") @db.VarChar(500)
  processWithAI             Boolean                   @default(false) @map("process_with_ai")
  isPrivate                 Boolean                   @default(false) @map("is_private")
  markedPublicAt            DateTime?                 @map("marked_public_at") @db.Timestamptz(6)
  markedPublicBy            String?                   @map("marked_public_by")
  userDescription           String?                   @map("user_description")
  userDescriptionBy         String?                   @map("user_description_by")
  userDescriptionAt         DateTime?                 @map("user_description_at") @db.Timestamptz(6)
  contentHash               String?                   @map("content_hash")
  attachmentSuggestions     AttachmentSuggestion[]
  caseLinks                 CaseDocument[]
  communicationAttachments  CommunicationAttachment[]
  auditLogs                 DocumentAuditLog[]
  editSession               DocumentEditSession?
  versions                  DocumentVersion[]
  client                    Client                    @relation(fields: [clientId], references: [id])
  firm                      Firm                      @relation(fields: [firmId], references: [id])
  reviewer                  User?                     @relation("DocumentReviewer", fields: [reviewerId], references: [id])
  uploader                  User                      @relation("DocumentUploader", fields: [uploadedBy], references: [id])
  descriptionUser           User?                     @relation("DocumentDescriptionUser", fields: [userDescriptionBy], references: [id])
  emailAttachments          EmailAttachment[]
  taskAttachments           TaskAttachment[]
  taskLinks                 TaskDocumentLink[]

  @@index([clientId])
  @@index([firmId])
  @@index([uploadedAt])
  @@index([fileName])
  @@index([oneDriveId])
  @@index([sharePointItemId])
  @@index([thumbnailStatus])
  @@index([sourceType])
  @@index([reviewerId])
  @@index([extractionStatus])
  @@map("documents")
}

model CaseDocument {
  id                     String           @id @default(uuid())
  caseId                 String?          @map("case_id")
  documentId             String           @map("document_id")
  linkedBy               String           @map("linked_by")
  linkedAt               DateTime         @default(now()) @map("linked_at") @db.Timestamptz(6)
  isOriginal             Boolean          @default(false) @map("is_original")
  firmId                 String           @map("firm_id")
  folderId               String?          @map("folder_id")
  promotedFromAttachment Boolean          @default(false) @map("promoted_from_attachment")
  originalAttachmentId   String?          @map("original_attachment_id")
  clientId               String?          @map("client_id")
  case                   Case?            @relation(fields: [caseId], references: [id], onDelete: Cascade)
  client                 Client?          @relation("ClientInboxDocuments", fields: [clientId], references: [id], onDelete: Cascade)
  document               Document         @relation(fields: [documentId], references: [id], onDelete: Cascade)
  firm                   Firm             @relation(fields: [firmId], references: [id])
  folder                 DocumentFolder?  @relation(fields: [folderId], references: [id])
  linker                 User             @relation("DocumentLinker", fields: [linkedBy], references: [id])
  originalAttachment     EmailAttachment? @relation("PromotedFromAttachment", fields: [originalAttachmentId], references: [id])
  mapaSlots              MapaSlot[]

  @@unique([caseId, documentId])
  @@index([caseId])
  @@index([clientId])
  @@index([documentId])
  @@index([firmId])
  @@index([folderId])
  @@index([promotedFromAttachment])
  @@map("case_documents")
}

model DocumentFolder {
  id        String           @id @default(uuid())
  name      String           @db.VarChar(255)
  caseId    String?          @map("case_id")
  parentId  String?          @map("parent_id")
  order     Int              @default(0)
  createdAt DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  firmId    String           @map("firm_id")
  clientId  String?          @map("client_id")
  documents CaseDocument[]
  case      Case?            @relation(fields: [caseId], references: [id], onDelete: Cascade)
  client    Client?          @relation("ClientFolders", fields: [clientId], references: [id], onDelete: Cascade)
  firm      Firm             @relation(fields: [firmId], references: [id])
  parent    DocumentFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  DocumentFolder[] @relation("FolderHierarchy")

  @@index([caseId])
  @@index([clientId])
  @@index([parentId])
  @@index([firmId])
  @@map("document_folders")
}

model DocumentAuditLog {
  id         String              @id @default(uuid())
  documentId String?             @map("document_id")
  userId     String              @map("user_id")
  action     DocumentAuditAction
  caseId     String?             @map("case_id")
  details    Json                @default("{}")
  timestamp  DateTime            @default(now()) @db.Timestamptz(6)
  firmId     String              @map("firm_id")
  document   Document?           @relation(fields: [documentId], references: [id])
  firm       Firm                @relation(fields: [firmId], references: [id])
  user       User                @relation("DocumentAuditUser", fields: [userId], references: [id])

  @@index([documentId])
  @@index([userId])
  @@index([caseId])
  @@index([timestamp])
  @@index([firmId])
  @@map("document_audit_logs")
}

model DocumentVersion {
  id                String   @id @default(uuid())
  documentId        String   @map("document_id")
  versionNumber     Int      @map("version_number")
  oneDriveVersionId String?  @map("one_drive_version_id") @db.VarChar(255)
  changesSummary    String?  @map("changes_summary")
  createdBy         String   @map("created_by")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  creator           User     @relation("DocumentVersionCreator", fields: [createdBy], references: [id])
  document          Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, versionNumber])
  @@index([documentId])
  @@map("document_versions")
}

model DocumentEditSession {
  id                     String    @id @default(uuid())
  documentId             String    @unique @map("document_id")
  userId                 String    @map("user_id")
  startedAt              DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  sharePointLastModified DateTime? @map("share_point_last_modified") @db.Timestamptz(6)
  sharePointETag         String?   @map("share_point_etag") @db.VarChar(255)
  lockToken              String    @map("lock_token") @db.VarChar(255)
  document               Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user                   User      @relation("DocumentEditSessionUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startedAt])
  @@map("document_edit_sessions")
}

model AIFeatureConfig {
  id               String   @id @default(uuid())
  firmId           String   @map("firm_id")
  feature          String   @db.VarChar(100)
  enabled          Boolean  @default(true)
  monthlyBudgetEur Decimal? @map("monthly_budget_eur") @db.Decimal(10, 2)
  dailyLimitEur    Decimal? @map("daily_limit_eur") @db.Decimal(10, 2)
  schedule         String?  @db.VarChar(50)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  updatedBy        String   @map("updated_by")
  model            String?  @db.VarChar(100)

  @@unique([firmId, feature])
  @@index([firmId])
  @@map("ai_feature_configs")
}

model LegacyImportSession {
  id                 String              @id @default(uuid())
  firmId             String              @map("firm_id")
  pstFileName        String              @map("pst_file_name") @db.VarChar(500)
  pstFileSize        BigInt              @map("pst_file_size")
  pstStoragePath     String?             @map("pst_storage_path")
  uploadedBy         String              @map("uploaded_by")
  status             ImportSessionStatus @default(Uploading)
  totalDocuments     Int                 @default(0) @map("total_documents")
  categorizedCount   Int                 @default(0) @map("categorized_count")
  skippedCount       Int                 @default(0) @map("skipped_count")
  analyzedCount      Int                 @default(0) @map("analyzed_count")
  extractionErrors   Json?               @map("extraction_errors")
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  exportedAt         DateTime?           @map("exported_at") @db.Timestamptz(6)
  cleanedUpAt        DateTime?           @map("cleaned_up_at") @db.Timestamptz(6)
  extractionProgress Json?               @map("extraction_progress")
  cleanupScheduledAt DateTime?           @map("cleanup_scheduled_at") @db.Timestamptz(6)
  lastSnapshotAt     DateTime?           @map("last_snapshot_at") @db.Timestamptz(6)

  @@index([firmId])
  @@index([uploadedBy])
  @@index([status])
  @@index([createdAt])
  @@map("legacy_import_sessions")
}

model DocumentComment {
  id            String    @id @default(uuid())
  documentId    String    @map("document_id")
  versionId     String?   @map("version_id")
  authorId      String    @map("author_id")
  content       String
  anchorText    String?   @map("anchor_text")
  anchorStart   Int?      @map("anchor_start")
  anchorEnd     Int?      @map("anchor_end")
  wordCommentId String?   @map("word_comment_id") @db.VarChar(255)
  resolved      Boolean   @default(false)
  resolvedBy    String?   @map("resolved_by")
  resolvedAt    DateTime? @map("resolved_at") @db.Timestamptz(6)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([documentId])
  @@index([authorId])
  @@index([wordCommentId])
  @@map("document_comments")
}

model Task {
  id                      String                @id @default(uuid())
  firmId                  String                @map("firm_id")
  caseId                  String?               @map("case_id")
  type                    TaskTypeEnum
  title                   String                @db.VarChar(500)
  description             String?
  assignedTo              String                @map("assigned_to")
  dueDate                 DateTime              @map("due_date") @db.Date
  dueTime                 String?               @map("due_time") @db.VarChar(5)
  status                  TaskStatus            @default(Pending)
  priority                TaskPriority          @default(Medium)
  estimatedHours          Decimal?              @map("estimated_hours") @db.Decimal(5, 2)
  typeMetadata            Json?                 @map("type_metadata")
  parentTaskId            String?               @map("parent_task_id")
  templateStepId          String?               @map("template_step_id")
  templateUsageId         String?               @map("template_usage_id")
  isCriticalPath          Boolean               @default(false) @map("is_critical_path")
  blockedReason           String?               @map("blocked_reason") @db.VarChar(500)
  createdBy               String                @map("created_by")
  createdAt               DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  completedAt             DateTime?             @map("completed_at") @db.Timestamptz(6)
  scheduledDate           DateTime?             @map("scheduled_date") @db.Date
  scheduledStartTime      String?               @map("scheduled_start_time") @db.VarChar(5)
  version                 Int                   @default(1)
  clientId                String?               @map("client_id")
  invoiceId               String?               @map("invoice_id")
  invoicedAt              DateTime?             @map("invoiced_at") @db.Timestamptz(6)
  convertedFromActionItem ExtractedActionItem[] @relation("ActionItemConvertedTask")
  convertedFromCommitment ExtractedCommitment[] @relation("CommitmentConvertedTask")
  convertedFromDeadline   ExtractedDeadline[]   @relation("DeadlineConvertedTask")
  invoiceLineItems        InvoiceLineItem[]
  attachments             TaskAttachment[]
  attendees               TaskAttendee[]
  comments                TaskComment[]
  delegatedTasks          TaskDelegation[]      @relation("DelegatedTask")
  delegationsSource       TaskDelegation[]      @relation("DelegationSource")
  successors              TaskDependency[]      @relation("TaskPredecessor")
  predecessors            TaskDependency[]      @relation("TaskSuccessor")
  documentLinks           TaskDocumentLink[]
  history                 TaskHistory[]
  assignee                User                  @relation("TaskAssignee", fields: [assignedTo], references: [id])
  case                    Case?                 @relation(fields: [caseId], references: [id], onDelete: Cascade)
  client                  Client?               @relation("ClientInboxTasks", fields: [clientId], references: [id], onDelete: Cascade)
  creator                 User                  @relation("TaskCreator", fields: [createdBy], references: [id])
  firm                    Firm                  @relation(fields: [firmId], references: [id])
  invoice                 Invoice?              @relation(fields: [invoiceId], references: [id])
  parentTask              Task?                 @relation("TaskSubtasks", fields: [parentTaskId], references: [id])
  subtasks                Task[]                @relation("TaskSubtasks")
  timeEntries             TimeEntry[]

  @@index([firmId])
  @@index([caseId])
  @@index([clientId])
  @@index([assignedTo])
  @@index([status])
  @@index([dueDate])
  @@index([type])
  @@index([parentTaskId])
  @@index([firmId, scheduledDate, status])
  @@index([invoiceId])
  @@map("tasks")
}

model TaskAttendee {
  id            String           @id @default(uuid())
  taskId        String           @map("task_id")
  userId        String?          @map("user_id")
  externalName  String?          @map("external_name") @db.VarChar(200)
  externalEmail String?          @map("external_email") @db.VarChar(255)
  isOrganizer   Boolean          @default(false) @map("is_organizer")
  response      AttendeeResponse @default(Pending)
  createdAt     DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  task          Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user          User?            @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@map("task_attendees")
}

model TaskDocumentLink {
  id         String               @id @default(uuid())
  taskId     String               @map("task_id")
  documentId String               @map("document_id")
  linkType   TaskDocumentLinkType @map("link_type")
  notes      String?
  linkedBy   String               @map("linked_by")
  linkedAt   DateTime             @default(now()) @map("linked_at") @db.Timestamptz(6)
  document   Document             @relation(fields: [documentId], references: [id])
  linker     User                 @relation(fields: [linkedBy], references: [id])
  task       Task                 @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, documentId])
  @@index([taskId])
  @@map("task_document_links")
}

model TaskDelegation {
  id              String             @id @default(uuid())
  sourceTaskId    String             @map("source_task_id")
  delegatedTaskId String?            @map("delegated_task_id")
  delegatedTo     String             @map("delegated_to")
  delegatedBy     String             @map("delegated_by")
  reason          String
  startDate       DateTime           @map("start_date") @db.Date
  endDate         DateTime           @map("end_date") @db.Date
  status          DelegationStatus   @default(Pending)
  notes           String?
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  acceptedAt      DateTime?          @map("accepted_at") @db.Timestamptz(6)
  handoff         DelegationHandoff?
  delegator       User               @relation("DelegationDelegator", fields: [delegatedBy], references: [id])
  delegatedTask   Task?              @relation("DelegatedTask", fields: [delegatedTaskId], references: [id])
  delegate        User               @relation("DelegationDelegate", fields: [delegatedTo], references: [id])
  sourceTask      Task               @relation("DelegationSource", fields: [sourceTaskId], references: [id])

  @@index([sourceTaskId])
  @@index([delegatedTo])
  @@index([startDate, endDate])
  @@map("task_delegations")
}

model TaskTemplate {
  id          String    @id @default(uuid())
  firmId      String    @map("firm_id")
  name        String    @db.VarChar(200)
  description String?
  caseType    CaseType? @map("case_type")
  isDefault   Boolean   @default(false) @map("is_default")
  isActive    Boolean   @default(true) @map("is_active")
  createdBy   String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  firm        Firm      @relation(fields: [firmId], references: [id])

  @@unique([firmId, name])
  @@index([firmId])
  @@index([caseType])
  @@map("task_templates")
}

model TaskDependency {
  id             String         @id @default(uuid())
  predecessorId  String         @map("predecessor_id")
  successorId    String         @map("successor_id")
  dependencyType DependencyType @default(FinishToStart) @map("dependency_type")
  lagDays        Int            @default(0) @map("lag_days")
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  predecessor    Task           @relation("TaskPredecessor", fields: [predecessorId], references: [id], onDelete: Cascade)
  successor      Task           @relation("TaskSuccessor", fields: [successorId], references: [id], onDelete: Cascade)

  @@unique([predecessorId, successorId])
  @@index([predecessorId])
  @@index([successorId])
  @@map("task_dependencies")
}

model UserAvailability {
  id               String           @id @default(uuid())
  userId           String           @map("user_id")
  firmId           String           @map("firm_id")
  availabilityType AvailabilityType @map("availability_type")
  startDate        DateTime         @map("start_date") @db.Date
  endDate          DateTime         @map("end_date") @db.Date
  hoursPerDay      Decimal?         @map("hours_per_day") @db.Decimal(4, 2)
  reason           String?          @db.VarChar(500)
  autoReassign     Boolean          @default(true) @map("auto_reassign")
  delegateTo       String?          @map("delegate_to")
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  delegate         User?            @relation("UserDelegates", fields: [delegateTo], references: [id])
  user             User             @relation("UserAvailabilities", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([firmId])
  @@index([startDate, endDate])
  @@map("user_availabilities")
}

model UserSkill {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  firmId      String    @map("firm_id")
  skillType   SkillType @map("skill_type")
  proficiency Int       @default(3)
  verified    Boolean   @default(false)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillType])
  @@index([firmId])
  @@index([skillType])
  @@map("user_skills")
}

model DelegationHandoff {
  id             String         @id @default(uuid())
  delegationId   String         @unique @map("delegation_id")
  handoffNotes   String         @map("handoff_notes")
  contextSummary String?        @map("context_summary")
  relatedTaskIds String[]       @map("related_task_ids")
  relatedDocIds  String[]       @map("related_doc_ids")
  aiGenerated    Boolean        @default(false) @map("ai_generated")
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  delegation     TaskDelegation @relation(fields: [delegationId], references: [id], onDelete: Cascade)

  @@map("delegation_handoffs")
}

model UserWorkloadSettings {
  id                  String   @id @default(uuid())
  userId              String   @unique @map("user_id")
  firmId              String   @map("firm_id")
  dailyCapacityHours  Decimal  @default(8) @map("daily_capacity_hours") @db.Decimal(4, 2)
  weeklyCapacityHours Decimal  @default(40) @map("weekly_capacity_hours") @db.Decimal(5, 2)
  workingDays         Int[]    @map("working_days")
  maxConcurrentTasks  Int      @default(10) @map("max_concurrent_tasks")
  overloadThreshold   Decimal  @default(1.2) @map("overload_threshold") @db.Decimal(3, 2)
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([firmId])
  @@map("user_workload_settings")
}

model TaskComment {
  id        String        @id @default(uuid())
  taskId    String        @map("task_id")
  authorId  String        @map("author_id")
  content   String
  parentId  String?       @map("parent_id")
  mentions  String[]
  createdAt DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  editedAt  DateTime?     @map("edited_at") @db.Timestamptz(6)
  author    User          @relation("TaskCommentAuthor", fields: [authorId], references: [id])
  parent    TaskComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   TaskComment[] @relation("CommentReplies")
  task      Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([authorId])
  @@index([createdAt])
  @@map("task_comments")
}

model TaskHistory {
  id        String            @id @default(uuid())
  taskId    String            @map("task_id")
  actorId   String            @map("actor_id")
  action    TaskHistoryAction
  field     String?           @db.VarChar(100)
  oldValue  String?           @map("old_value")
  newValue  String?           @map("new_value")
  metadata  Json?
  createdAt DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  actor     User              @relation("TaskHistoryActor", fields: [actorId], references: [id])
  task      Task              @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([actorId])
  @@index([createdAt])
  @@map("task_history")
}

model CaseActivityEntry {
  id           String           @id @default(uuid())
  caseId       String           @map("case_id")
  actorId      String           @map("actor_id")
  activityType CaseActivityType @map("activity_type")
  entityType   String           @map("entity_type") @db.VarChar(50)
  entityId     String           @map("entity_id")
  title        String           @db.VarChar(500)
  summary      String?
  metadata     Json?
  createdAt    DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  actor        User             @relation("CaseActivityActor", fields: [actorId], references: [id])
  case         Case             @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([actorId])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@map("case_activity_entries")
}

model TaskAttachment {
  id                String           @id @default(uuid())
  taskId            String           @map("task_id")
  documentId        String?          @map("document_id")
  fileName          String           @map("file_name") @db.VarChar(255)
  fileSize          Int              @map("file_size")
  mimeType          String           @map("mime_type") @db.VarChar(100)
  storageUrl        String           @map("storage_url") @db.VarChar(1000)
  uploadedBy        String           @map("uploaded_by")
  version           Int              @default(1)
  previousVersionId String?          @map("previous_version_id")
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  document          Document?        @relation(fields: [documentId], references: [id])
  previousVersion   TaskAttachment?  @relation("AttachmentVersions", fields: [previousVersionId], references: [id])
  nextVersions      TaskAttachment[] @relation("AttachmentVersions")
  task              Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploader          User             @relation("TaskAttachmentUploader", fields: [uploadedBy], references: [id])

  @@index([taskId])
  @@index([documentId])
  @@index([uploadedBy])
  @@map("task_attachments")
}

model CaseSubscription {
  id               String   @id @default(uuid())
  caseId           String   @map("case_id")
  userId           String   @map("user_id")
  digestEnabled    Boolean  @default(true) @map("digest_enabled")
  notifyOnTask     Boolean  @default(true) @map("notify_on_task")
  notifyOnDocument Boolean  @default(true) @map("notify_on_document")
  notifyOnComment  Boolean  @default(true) @map("notify_on_comment")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  case             Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([caseId, userId])
  @@index([userId])
  @@index([digestEnabled])
  @@map("case_subscriptions")
}

model Email {
  id                       String                   @id @default(uuid())
  graphMessageId           String                   @unique @map("graph_message_id")
  conversationId           String                   @map("conversation_id")
  internetMessageId        String?                  @map("internet_message_id")
  subject                  String                   @db.VarChar(1000)
  bodyPreview              String                   @map("body_preview") @db.VarChar(500)
  bodyContent              String                   @map("body_content")
  bodyContentType          String                   @map("body_content_type") @db.VarChar(10)
  from                     Json
  toRecipients             Json                     @map("to_recipients")
  ccRecipients             Json                     @map("cc_recipients")
  bccRecipients            Json                     @map("bcc_recipients")
  receivedDateTime         DateTime                 @map("received_date_time") @db.Timestamptz(6)
  sentDateTime             DateTime                 @map("sent_date_time") @db.Timestamptz(6)
  hasAttachments           Boolean                  @map("has_attachments")
  importance               String                   @db.VarChar(10)
  isRead                   Boolean                  @map("is_read")
  userId                   String                   @map("user_id")
  caseId                   String?                  @map("case_id")
  firmId                   String                   @map("firm_id")
  syncedAt                 DateTime                 @default(now()) @map("synced_at") @db.Timestamptz(6)
  createdAt                DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime                 @updatedAt @map("updated_at") @db.Timestamptz(6)
  isIgnored                Boolean                  @default(false) @map("is_ignored")
  ignoredAt                DateTime?                @map("ignored_at") @db.Timestamptz(6)
  classificationState      EmailClassificationState @default(Pending) @map("classification_state")
  classificationConfidence Float?                   @map("classification_confidence")
  classifiedAt             DateTime?                @map("classified_at") @db.Timestamptz(6)
  classifiedBy             String?                  @map("classified_by")
  classificationReason     String?                  @map("classification_reason")
  aiClassificationCost     Float?                   @map("ai_classification_cost")
  bodyContentClean         String?                  @map("body_content_clean")
  folderType               String?                  @map("folder_type") @db.VarChar(10)
  isPrivate                Boolean                  @default(false) @map("is_private")
  markedPrivateAt          DateTime?                @map("marked_private_at") @db.Timestamptz(6)
  markedPrivateBy          String?                  @map("marked_private_by")
  parentFolderId           String?                  @map("parent_folder_id") @db.VarChar(255)
  parentFolderName         String?                  @map("parent_folder_name") @db.VarChar(255)
  isSuggestedAssignment    Boolean                  @default(false) @map("is_suggested_assignment")
  clientId                 String?                  @map("client_id")
  markedPublicAt           DateTime?                @map("marked_public_at") @db.Timestamptz(6)
  markedPublicBy           String?                  @map("marked_public_by")
  attachments              EmailAttachment[]
  caseLinks                EmailCaseLink[]
  classificationLogs       EmailClassificationLog[]
  drafts                   EmailDraft[]
  case                     Case?                    @relation(fields: [caseId], references: [id])
  client                   Client?                  @relation("ClientInboxEmails", fields: [clientId], references: [id])
  firm                     Firm                     @relation(fields: [firmId], references: [id])
  user                     User                     @relation(fields: [userId], references: [id])
  extractedActionItems     ExtractedActionItem[]
  extractedCommitments     ExtractedCommitment[]
  extractedDeadlines       ExtractedDeadline[]
  extractedQuestions       ExtractedQuestion[]
  pendingClassification    PendingClassification?
  riskIndicators           RiskIndicator[]

  @@index([userId])
  @@index([caseId])
  @@index([clientId])
  @@index([conversationId])
  @@index([receivedDateTime])
  @@index([firmId])
  @@index([isIgnored])
  @@index([classificationState])
  @@index([folderType])
  @@index([parentFolderName])
  @@map("emails")
}

model EmailAttachment {
  id                    String         @id @default(uuid())
  emailId               String         @map("email_id")
  graphAttachmentId     String         @map("graph_attachment_id")
  name                  String         @db.VarChar(500)
  contentType           String         @map("content_type") @db.VarChar(200)
  size                  Int
  storageUrl            String?        @map("storage_url")
  documentId            String?        @map("document_id")
  createdAt             DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  filterStatus          String?        @map("filter_status") @db.VarChar(20)
  filterRuleId          String?        @map("filter_rule_id") @db.VarChar(50)
  filterReason          String?        @map("filter_reason") @db.VarChar(200)
  dismissedAt           DateTime?      @map("dismissed_at") @db.Timestamptz(6)
  irrelevant            Boolean        @default(false)
  isPrivate             Boolean        @default(false) @map("is_private")
  markedPublicAt        DateTime?      @map("marked_public_at") @db.Timestamptz(6)
  markedPublicBy        String?        @map("marked_public_by")
  promotedCaseDocuments CaseDocument[] @relation("PromotedFromAttachment")
  document              Document?      @relation(fields: [documentId], references: [id])
  email                 Email          @relation(fields: [emailId], references: [id], onDelete: Cascade)

  @@index([emailId])
  @@index([documentId])
  @@index([filterStatus])
  @@map("email_attachments")
}

model EmailSyncState {
  id                 String    @id @default(uuid())
  userId             String    @unique @map("user_id")
  deltaToken         String?   @map("delta_token")
  subscriptionId     String?   @map("subscription_id") @db.VarChar(255)
  subscriptionExpiry DateTime? @map("subscription_expiry") @db.Timestamptz(6)
  lastSyncAt         DateTime? @map("last_sync_at") @db.Timestamptz(6)
  syncStatus         String    @default("pending") @map("sync_status") @db.VarChar(20)
  errorMessage       String?   @map("error_message")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  user               User      @relation(fields: [userId], references: [id])

  @@map("email_sync_states")
}

model PersonalContact {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  email     String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, email])
  @@index([userId])
  @@map("personal_contacts")
}

model PersonalThread {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  userId         String   @map("user_id")
  firmId         String   @map("firm_id")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  firm           Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, firmId])
  @@index([userId])
  @@index([firmId])
  @@map("personal_threads")
}

model ExtractedDeadline {
  id              String           @id @default(uuid())
  emailId         String           @map("email_id")
  caseId          String?          @map("case_id")
  firmId          String           @map("firm_id")
  description     String
  dueDate         DateTime         @map("due_date") @db.Timestamptz(6)
  confidence      Float
  status          ExtractionStatus @default(Pending)
  convertedTaskId String?          @map("converted_task_id")
  dismissedAt     DateTime?        @map("dismissed_at") @db.Timestamptz(6)
  dismissReason   String?          @map("dismiss_reason") @db.VarChar(500)
  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  case            Case?            @relation(fields: [caseId], references: [id])
  convertedTask   Task?            @relation("DeadlineConvertedTask", fields: [convertedTaskId], references: [id])
  email           Email            @relation(fields: [emailId], references: [id], onDelete: Cascade)
  firm            Firm             @relation(fields: [firmId], references: [id])

  @@index([emailId])
  @@index([caseId])
  @@index([status])
  @@map("extracted_deadlines")
}

model ExtractedCommitment {
  id              String           @id @default(uuid())
  emailId         String           @map("email_id")
  caseId          String?          @map("case_id")
  firmId          String           @map("firm_id")
  party           String           @db.VarChar(200)
  commitmentText  String           @map("commitment_text")
  dueDate         DateTime?        @map("due_date") @db.Timestamptz(6)
  confidence      Float
  status          ExtractionStatus @default(Pending)
  convertedTaskId String?          @map("converted_task_id")
  dismissedAt     DateTime?        @map("dismissed_at") @db.Timestamptz(6)
  dismissReason   String?          @map("dismiss_reason") @db.VarChar(500)
  createdAt       DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  case            Case?            @relation(fields: [caseId], references: [id])
  convertedTask   Task?            @relation("CommitmentConvertedTask", fields: [convertedTaskId], references: [id])
  email           Email            @relation(fields: [emailId], references: [id], onDelete: Cascade)
  firm            Firm             @relation(fields: [firmId], references: [id])

  @@index([emailId])
  @@index([caseId])
  @@map("extracted_commitments")
}

model ExtractedActionItem {
  id                String           @id @default(uuid())
  emailId           String           @map("email_id")
  caseId            String?          @map("case_id")
  firmId            String           @map("firm_id")
  description       String
  suggestedAssignee String?          @map("suggested_assignee") @db.VarChar(200)
  priority          TaskPriority     @default(Medium)
  confidence        Float
  status            ExtractionStatus @default(Pending)
  convertedTaskId   String?          @map("converted_task_id")
  dismissedAt       DateTime?        @map("dismissed_at") @db.Timestamptz(6)
  dismissReason     String?          @map("dismiss_reason") @db.VarChar(500)
  createdAt         DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  case              Case?            @relation(fields: [caseId], references: [id])
  convertedTask     Task?            @relation("ActionItemConvertedTask", fields: [convertedTaskId], references: [id])
  email             Email            @relation(fields: [emailId], references: [id], onDelete: Cascade)
  firm              Firm             @relation(fields: [firmId], references: [id])

  @@index([emailId])
  @@index([caseId])
  @@map("extracted_action_items")
}

model ExtractedQuestion {
  id            String           @id @default(uuid())
  emailId       String           @map("email_id")
  caseId        String?          @map("case_id")
  firmId        String           @map("firm_id")
  questionText  String           @map("question_text")
  respondBy     DateTime?        @map("respond_by") @db.Timestamptz(6)
  confidence    Float
  status        ExtractionStatus @default(Pending)
  isAnswered    Boolean          @default(false) @map("is_answered")
  answeredAt    DateTime?        @map("answered_at") @db.Timestamptz(6)
  dismissedAt   DateTime?        @map("dismissed_at") @db.Timestamptz(6)
  dismissReason String?          @map("dismiss_reason") @db.VarChar(500)
  createdAt     DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime         @updatedAt @map("updated_at") @db.Timestamptz(6)
  case          Case?            @relation(fields: [caseId], references: [id])
  email         Email            @relation(fields: [emailId], references: [id], onDelete: Cascade)
  firm          Firm             @relation(fields: [firmId], references: [id])

  @@index([emailId])
  @@index([caseId])
  @@index([status])
  @@map("extracted_questions")
}

model RiskIndicator {
  id              String       @id @default(uuid())
  emailId         String       @map("email_id")
  caseId          String?      @map("case_id")
  firmId          String       @map("firm_id")
  type            RiskType
  severity        RiskSeverity
  description     String
  evidence        String
  suggestedAction String?      @map("suggested_action")
  isResolved      Boolean      @default(false) @map("is_resolved")
  resolvedAt      DateTime?    @map("resolved_at") @db.Timestamptz(6)
  resolvedBy      String?      @map("resolved_by")
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  case            Case?        @relation(fields: [caseId], references: [id])
  email           Email        @relation(fields: [emailId], references: [id], onDelete: Cascade)
  firm            Firm         @relation(fields: [firmId], references: [id])

  @@index([caseId])
  @@index([type])
  @@index([severity])
  @@map("risk_indicators")
}

model ThreadSummary {
  id                      String   @id @default(uuid())
  conversationId          String   @unique @map("conversation_id")
  caseId                  String?  @map("case_id")
  firmId                  String   @map("firm_id")
  opposingCounselPosition String?  @map("opposing_counsel_position")
  keyArguments            Json?    @map("key_arguments")
  positionChanges         Json?    @map("position_changes")
  lastAnalyzedAt          DateTime @map("last_analyzed_at") @db.Timestamptz(6)
  messageCount            Int      @map("message_count")
  createdAt               DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  overview                String?
  keyPoints               Json?    @map("key_points")
  actionItems             Json?    @map("action_items")
  sentiment               String?  @map("sentiment") @db.VarChar(20)
  participants            Json?
  case                    Case?    @relation(fields: [caseId], references: [id])
  firm                    Firm     @relation(fields: [firmId], references: [id])

  @@index([caseId])
  @@map("thread_summaries")
}

model EmailDraft {
  id                    String                 @id @default(uuid())
  emailId               String                 @map("email_id")
  caseId                String?                @map("case_id")
  firmId                String                 @map("firm_id")
  userId                String                 @map("user_id")
  tone                  EmailTone              @default(Professional)
  recipientType         RecipientType          @default(Client)
  subject               String                 @db.VarChar(500)
  body                  String
  htmlBody              String?                @map("html_body")
  suggestedAttachments  Json?                  @map("suggested_attachments")
  confidence            Float
  status                DraftStatus            @default(Generated)
  userEdits             Json?                  @map("user_edits")
  sentAt                DateTime?              @map("sent_at") @db.Timestamptz(6)
  createdAt             DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime               @updatedAt @map("updated_at") @db.Timestamptz(6)
  outlookDraftId        String?                @map("outlook_draft_id")
  attachmentSuggestions AttachmentSuggestion[]
  editHistory           DraftEditHistory[]
  case                  Case?                  @relation(fields: [caseId], references: [id])
  email                 Email                  @relation(fields: [emailId], references: [id], onDelete: Cascade)
  firm                  Firm                   @relation(fields: [firmId], references: [id])
  user                  User                   @relation(fields: [userId], references: [id])

  @@index([emailId])
  @@index([caseId])
  @@index([userId])
  @@index([status])
  @@map("email_drafts")
}

model SentEmailDraft {
  id             String          @id @default(uuid())
  outlookDraftId String          @map("outlook_draft_id")
  userId         String          @map("user_id")
  firmId         String          @map("firm_id")
  recipientEmail String          @map("recipient_email")
  subject        String          @db.VarChar(500)
  caseId         String?         @map("case_id")
  source         SentEmailSource
  createdAt      DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  case           Case?           @relation(fields: [caseId], references: [id])
  firm           Firm            @relation(fields: [firmId], references: [id])
  user           User            @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([firmId])
  @@index([outlookDraftId])
  @@index([createdAt])
  @@map("sent_email_drafts")
}

model AttachmentSuggestion {
  id             String     @id @default(uuid())
  draftId        String     @map("draft_id")
  documentId     String     @map("document_id")
  title          String     @db.VarChar(500)
  reason         String
  relevanceScore Float      @map("relevance_score")
  isSelected     Boolean    @default(false) @map("is_selected")
  createdAt      DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  document       Document   @relation(fields: [documentId], references: [id])
  draft          EmailDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@index([draftId])
  @@map("attachment_suggestions")
}

model AISuggestion {
  id              String             @id @default(uuid())
  firmId          String             @map("firm_id")
  userId          String             @map("user_id")
  caseId          String?            @map("case_id")
  type            SuggestionType
  category        SuggestionCategory
  title           String             @db.VarChar(500)
  description     String
  suggestedAction String?            @map("suggested_action")
  actionPayload   Json?              @map("action_payload")
  confidence      Float
  priority        SuggestionPriority @default(Normal)
  context         Json?
  status          SuggestionStatus   @default(Pending)
  dismissedAt     DateTime?          @map("dismissed_at") @db.Timestamptz(6)
  dismissReason   String?            @map("dismiss_reason") @db.VarChar(500)
  acceptedAt      DateTime?          @map("accepted_at") @db.Timestamptz(6)
  expiresAt       DateTime?          @map("expires_at") @db.Timestamptz(6)
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  case            Case?              @relation(fields: [caseId], references: [id])
  firm            Firm               @relation(fields: [firmId], references: [id])
  user            User               @relation(fields: [userId], references: [id])

  @@index([userId, status])
  @@index([caseId])
  @@index([firmId])
  @@index([type])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("ai_suggestions")
}

model UserActionPattern {
  id              String   @id @default(uuid())
  firmId          String   @map("firm_id")
  userId          String   @map("user_id")
  patternType     String   @map("pattern_type") @db.VarChar(100)
  triggerContext  Json     @map("trigger_context")
  actionSequence  Json     @map("action_sequence")
  occurrenceCount Int      @default(1) @map("occurrence_count")
  lastOccurrence  DateTime @map("last_occurrence") @db.Timestamptz(6)
  confidence      Float
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  firm            Firm     @relation(fields: [firmId], references: [id])
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, patternType])
  @@index([firmId])
  @@index([userId])
  @@index([confidence])
  @@map("user_action_patterns")
}

model MorningBriefing {
  id               String    @id @default(uuid())
  firmId           String    @map("firm_id")
  userId           String    @map("user_id")
  briefingDate     DateTime  @map("briefing_date") @db.Date
  prioritizedTasks Json      @map("prioritized_tasks")
  keyDeadlines     Json      @map("key_deadlines")
  riskAlerts       Json      @map("risk_alerts")
  suggestions      Json
  summary          String
  isViewed         Boolean   @default(false) @map("is_viewed")
  viewedAt         DateTime? @map("viewed_at") @db.Timestamptz(6)
  generatedAt      DateTime  @default(now()) @map("generated_at") @db.Timestamptz(6)
  tokensUsed       Int       @map("tokens_used")
  firm             Firm      @relation(fields: [firmId], references: [id])
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, briefingDate])
  @@index([firmId])
  @@index([userId])
  @@index([briefingDate])
  @@map("morning_briefings")
}

// ============================================================================
// Firm Operations Agent (Phase 1: Smart Morning Briefing)
// ============================================================================

model FirmBriefing {
  id           String    @id @default(uuid())
  firmId       String    @map("firm_id")
  userId       String    @map("user_id")
  briefingDate DateTime  @map("briefing_date") @db.Date

  // Narrative content (for greeting section)
  summary String @db.Text // AI-generated narrative (~150 tokens)

  // Structured data (for interactive UI)
  // V1: Array of FirmBriefingItem with severity-based classification
  // V2: Editor-in-Chief model with edition, lead, secondary, tertiary
  items      Json // Flexible JSON for both V1 and V2 structures
  quickStats Json @map("quick_stats") // { activeCases, urgentTasks, teamUtilization, etc. }

  // Schema version for backwards compatibility
  // V1 = severity-based, V2 = editor-in-chief model
  schemaVersion Int @default(2) @map("schema_version")

  // Metadata
  totalTokens  Int       @map("total_tokens")
  totalCostEur Float?    @map("total_cost_eur") // Cost visibility for this briefing
  isStale      Boolean   @default(false) @map("is_stale")
  isViewed     Boolean   @default(false) @map("is_viewed")
  viewedAt     DateTime? @map("viewed_at") @db.Timestamptz(6)
  generatedAt  DateTime  @default(now()) @map("generated_at") @db.Timestamptz(6)

  // Relations
  firm Firm @relation(fields: [firmId], references: [id])
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, briefingDate])
  @@index([firmId, briefingDate])
  @@index([userId, briefingDate])
  @@map("firm_briefings")
}

model FirmBriefingRun {
  id     String @id @default(uuid())
  firmId String @map("firm_id")
  userId String @map("user_id")

  // Execution tracking
  status      String    @default("pending") // pending, running, completed, failed
  startedAt   DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)

  // Cost tracking
  inputTokens    Int?   @map("input_tokens")
  outputTokens   Int?   @map("output_tokens")
  thinkingTokens Int?   @map("thinking_tokens")
  costEur        Float? @map("cost_eur")

  // Debug
  toolCalls Json?   @map("tool_calls") // Record of tool invocations
  error     String?

  // Relations
  firm Firm @relation(fields: [firmId], references: [id])
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([firmId, startedAt])
  @@index([userId, startedAt])
  @@index([status])
  @@map("firm_briefing_runs")
}

model CommunicationEntry {
  id             String                    @id @default(uuid())
  firmId         String                    @map("firm_id")
  caseId         String                    @map("case_id")
  channelType    CommunicationChannel      @map("channel_type")
  direction      CommunicationDirection
  subject        String?                   @db.VarChar(500)
  body           String
  htmlBody       String?                   @map("html_body")
  senderId       String                    @map("sender_id")
  senderName     String                    @map("sender_name") @db.VarChar(200)
  senderEmail    String?                   @map("sender_email") @db.VarChar(255)
  recipients     Json
  externalId     String?                   @map("external_id") @db.VarChar(255)
  parentId       String?                   @map("parent_id")
  isPrivate      Boolean                   @default(false) @map("is_private")
  privacyLevel   PrivacyLevel              @default(Normal) @map("privacy_level")
  allowedViewers String[]                  @map("allowed_viewers")
  hasAttachments Boolean                   @default(false) @map("has_attachments")
  metadata       Json?
  sentAt         DateTime                  @map("sent_at") @db.Timestamptz(6)
  createdAt      DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime                  @updatedAt @map("updated_at") @db.Timestamptz(6)
  attachments    CommunicationAttachment[]
  case           Case                      @relation(fields: [caseId], references: [id])
  firm           Firm                      @relation(fields: [firmId], references: [id])
  parent         CommunicationEntry?       @relation("CommunicationThread", fields: [parentId], references: [id])
  children       CommunicationEntry[]      @relation("CommunicationThread")
  sender         User                      @relation("CommunicationSender", fields: [senderId], references: [id])

  @@index([caseId, sentAt])
  @@index([firmId])
  @@index([channelType])
  @@index([senderId])
  @@index([parentId])
  @@index([externalId])
  @@map("communication_entries")
}

model CommunicationAttachment {
  id                   String             @id @default(uuid())
  communicationEntryId String             @map("communication_entry_id")
  documentId           String?            @map("document_id")
  fileName             String             @map("file_name") @db.VarChar(500)
  fileSize             Int                @map("file_size")
  mimeType             String             @map("mime_type") @db.VarChar(200)
  storageUrl           String             @map("storage_url")
  createdAt            DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  communicationEntry   CommunicationEntry @relation(fields: [communicationEntryId], references: [id], onDelete: Cascade)
  document             Document?          @relation(fields: [documentId], references: [id])

  @@index([communicationEntryId])
  @@index([documentId])
  @@map("communication_attachments")
}

model CommunicationTemplate {
  id          String               @id @default(uuid())
  firmId      String               @map("firm_id")
  name        String               @db.VarChar(200)
  description String?              @db.VarChar(500)
  category    TemplateCategory
  channelType CommunicationChannel @map("channel_type")
  subject     String?              @db.VarChar(500)
  body        String
  htmlBody    String?              @map("html_body")
  variables   Json
  isActive    Boolean              @default(true) @map("is_active")
  isGlobal    Boolean              @default(false) @map("is_global")
  createdBy   String               @map("created_by")
  usageCount  Int                  @default(0) @map("usage_count")
  lastUsedAt  DateTime?            @map("last_used_at") @db.Timestamptz(6)
  createdAt   DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)
  creator     User                 @relation("TemplateCreator", fields: [createdBy], references: [id])
  firm        Firm                 @relation(fields: [firmId], references: [id])

  @@index([firmId])
  @@index([category])
  @@index([channelType])
  @@index([isActive])
  @@map("communication_templates")
}

model BulkCommunication {
  id              String                  @id @default(uuid())
  firmId          String                  @map("firm_id")
  caseId          String?                 @map("case_id")
  createdBy       String                  @map("created_by")
  templateId      String?                 @map("template_id")
  channelType     CommunicationChannel    @map("channel_type")
  subject         String                  @db.VarChar(500)
  body            String
  status          BulkCommunicationStatus @default(Draft)
  startedAt       DateTime?               @map("started_at") @db.Timestamptz(6)
  completedAt     DateTime?               @map("completed_at") @db.Timestamptz(6)
  createdAt       DateTime                @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime                @updatedAt @map("updated_at") @db.Timestamptz(6)
  failedCount     Int                     @default(0) @map("failed_count")
  htmlBody        String?                 @map("html_body")
  recipientFilter Json                    @map("recipient_filter")
  recipients      Json
  scheduledFor    DateTime?               @map("scheduled_for") @db.Timestamptz(6)
  sentCount       Int                     @default(0) @map("sent_count")
  totalRecipients Int                     @map("total_recipients")
  recipientType   BulkRecipientType       @map("recipient_type")
  logs            BulkCommunicationLog[]
  case            Case?                   @relation(fields: [caseId], references: [id])
  creator         User                    @relation("BulkCommunicationCreator", fields: [createdBy], references: [id])
  firm            Firm                    @relation(fields: [firmId], references: [id])

  @@index([firmId])
  @@index([caseId])
  @@index([status])
  @@index([createdBy])
  @@map("bulk_communications")
}

model BulkCommunicationLog {
  id                  String            @id @default(uuid())
  bulkCommunicationId String            @map("bulk_communication_id")
  recipientId         String            @map("recipient_id")
  recipientEmail      String            @map("recipient_email") @db.VarChar(255)
  recipientName       String            @map("recipient_name") @db.VarChar(200)
  status              String            @db.VarChar(20)
  errorMessage        String?           @map("error_message")
  sentAt              DateTime?         @map("sent_at") @db.Timestamptz(6)
  createdAt           DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  bulkCommunication   BulkCommunication @relation(fields: [bulkCommunicationId], references: [id], onDelete: Cascade)

  @@index([bulkCommunicationId])
  @@index([status])
  @@map("bulk_communication_logs")
}

model CommunicationExport {
  id                 String       @id @default(uuid())
  firmId             String       @map("firm_id")
  caseId             String       @map("case_id")
  exportedBy         String       @map("exported_by")
  format             ExportFormat
  dateRangeFrom      DateTime?    @map("date_range_from") @db.Timestamptz(6)
  dateRangeTo        DateTime?    @map("date_range_to") @db.Timestamptz(6)
  channelTypes       Json         @map("channel_types")
  includeAttachments Boolean      @default(false) @map("include_attachments")
  totalEntries       Int          @map("total_entries")
  fileUrl            String?      @map("file_url")
  status             ExportStatus @default(Processing)
  errorMessage       String?      @map("error_message")
  expiresAt          DateTime     @map("expires_at") @db.Timestamptz(6)
  createdAt          DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  completedAt        DateTime?    @map("completed_at") @db.Timestamptz(6)
  case               Case         @relation(fields: [caseId], references: [id])
  exporter           User         @relation("CommunicationExporter", fields: [exportedBy], references: [id])
  firm               Firm         @relation(fields: [firmId], references: [id])

  @@index([caseId])
  @@index([exportedBy])
  @@index([status])
  @@map("communication_exports")
}

model WritingStyleProfile {
  id                    String    @id @default(uuid())
  firmId                String    @map("firm_id")
  userId                String    @unique @map("user_id")
  formalityLevel        Float     @default(0.5) @map("formality_level")
  averageSentenceLength Float     @default(15) @map("average_sentence_length")
  vocabularyComplexity  Float     @default(0.5) @map("vocabulary_complexity")
  preferredTone         String    @default("Professional") @map("preferred_tone") @db.VarChar(50)
  commonPhrases         Json      @default("[]") @map("common_phrases")
  punctuationStyle      Json      @default("{}") @map("punctuation_style")
  languagePatterns      Json      @default("{}") @map("language_patterns")
  sampleCount           Int       @default(0) @map("sample_count")
  lastAnalyzedAt        DateTime? @map("last_analyzed_at") @db.Timestamptz(6)
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  firm                  Firm      @relation(fields: [firmId], references: [id])
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([firmId])
  @@map("writing_style_profiles")
}

model PersonalSnippet {
  id             String          @id @default(uuid())
  firmId         String          @map("firm_id")
  userId         String          @map("user_id")
  shortcut       String          @db.VarChar(50)
  title          String          @db.VarChar(200)
  content        String
  category       SnippetCategory
  usageCount     Int             @default(0) @map("usage_count")
  lastUsedAt     DateTime?       @map("last_used_at") @db.Timestamptz(6)
  isAutoDetected Boolean         @default(false) @map("is_auto_detected")
  sourceContext  Json?           @map("source_context")
  createdAt      DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime        @updatedAt @map("updated_at") @db.Timestamptz(6)
  firm           Firm            @relation(fields: [firmId], references: [id])
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, shortcut])
  @@index([firmId])
  @@index([userId])
  @@index([category])
  @@map("personal_snippets")
}

model TaskCreationPattern {
  id              String    @id @default(uuid())
  firmId          String    @map("firm_id")
  userId          String    @map("user_id")
  patternName     String    @map("pattern_name") @db.VarChar(200)
  triggerType     String    @map("trigger_type") @db.VarChar(100)
  triggerContext  Json      @map("trigger_context")
  taskTemplate    Json      @map("task_template")
  occurrenceCount Int       @default(1) @map("occurrence_count")
  confidence      Float
  isActive        Boolean   @default(true) @map("is_active")
  lastTriggeredAt DateTime? @map("last_triggered_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  firm            Firm      @relation(fields: [firmId], references: [id])
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, patternName])
  @@index([firmId])
  @@index([userId])
  @@index([confidence])
  @@map("task_creation_patterns")
}

model DocumentStructurePreference {
  id                String    @id @default(uuid())
  firmId            String    @map("firm_id")
  userId            String    @map("user_id")
  documentType      String    @map("document_type") @db.VarChar(100)
  preferredSections Json      @map("preferred_sections")
  headerStyle       Json      @map("header_style")
  footerContent     String?   @map("footer_content")
  marginPreferences Json?     @map("margin_preferences")
  fontPreferences   Json?     @map("font_preferences")
  usageCount        Int       @default(0) @map("usage_count")
  lastUsedAt        DateTime? @map("last_used_at") @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  firm              Firm      @relation(fields: [firmId], references: [id])
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, documentType])
  @@index([firmId])
  @@index([userId])
  @@map("document_structure_preferences")
}

model ResponseTimePattern {
  id                   String   @id @default(uuid())
  firmId               String   @map("firm_id")
  userId               String   @map("user_id")
  taskType             String   @map("task_type") @db.VarChar(100)
  caseType             String?  @map("case_type") @db.VarChar(100)
  averageResponseHours Float    @map("average_response_hours")
  medianResponseHours  Float    @map("median_response_hours")
  minResponseHours     Float    @map("min_response_hours")
  maxResponseHours     Float    @map("max_response_hours")
  sampleCount          Int      @default(0) @map("sample_count")
  stdDeviation         Float?   @map("std_deviation")
  dayOfWeekPattern     Json?    @map("day_of_week_pattern")
  timeOfDayPattern     Json?    @map("time_of_day_pattern")
  lastCalculatedAt     DateTime @map("last_calculated_at") @db.Timestamptz(6)
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  firm                 Firm     @relation(fields: [firmId], references: [id])
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, taskType, caseType])
  @@index([firmId])
  @@index([userId])
  @@map("response_time_patterns")
}

model DraftEditHistory {
  id              String     @id @default(uuid())
  firmId          String     @map("firm_id")
  userId          String     @map("user_id")
  draftId         String     @map("draft_id")
  originalText    String     @map("original_text")
  editedText      String     @map("edited_text")
  editType        EditType   @map("edit_type")
  editLocation    String     @map("edit_location") @db.VarChar(100)
  isStyleAnalyzed Boolean    @default(false) @map("is_style_analyzed")
  createdAt       DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  draft           EmailDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)
  firm            Firm       @relation(fields: [firmId], references: [id])
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([firmId])
  @@index([isStyleAnalyzed])
  @@map("draft_edit_history")
}

model EmailClassificationLog {
  id               String                   @id @default(uuid())
  emailId          String                   @map("email_id")
  firmId           String                   @map("firm_id")
  action           ClassificationAction
  fromCaseId       String?                  @map("from_case_id")
  toCaseId         String?                  @map("to_case_id")
  wasAutomatic     Boolean                  @default(false) @map("was_automatic")
  confidence       Float?
  matchType        ClassificationMatchType? @map("match_type")
  correctionReason String?                  @map("correction_reason")
  performedBy      String                   @map("performed_by")
  performedAt      DateTime                 @default(now()) @map("performed_at") @db.Timestamptz(6)
  email            Email                    @relation(fields: [emailId], references: [id], onDelete: Cascade)
  firm             Firm                     @relation(fields: [firmId], references: [id])
  fromCase         Case?                    @relation("ClassificationFromCase", fields: [fromCaseId], references: [id])
  user             User                     @relation(fields: [performedBy], references: [id])
  toCase           Case?                    @relation("ClassificationToCase", fields: [toCaseId], references: [id])

  @@index([emailId])
  @@index([fromCaseId])
  @@index([toCaseId])
  @@index([firmId])
  @@index([performedAt])
  @@index([action])
  @@map("email_classification_logs")
}

model PendingClassification {
  id                 String               @id @default(uuid())
  emailId            String               @unique @map("email_id")
  firmId             String               @map("firm_id")
  reason             ClassificationReason
  suggestedCases     Json                 @default("[]") @map("suggested_cases")
  detectedReferences String[]             @default([]) @map("detected_references")
  isResolved         Boolean              @default(false) @map("is_resolved")
  resolvedAt         DateTime?            @map("resolved_at") @db.Timestamptz(6)
  resolvedBy         String?              @map("resolved_by")
  createdAt          DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)
  email              Email                @relation(fields: [emailId], references: [id], onDelete: Cascade)
  firm               Firm                 @relation(fields: [firmId], references: [id])
  resolver           User?                @relation(fields: [resolvedBy], references: [id])

  @@index([firmId])
  @@index([isResolved])
  @@index([reason])
  @@index([createdAt])
  @@map("pending_classifications")
}

model CaseSummary {
  id               String   @id @default(cuid())
  caseId           String   @unique @map("case_id")
  executiveSummary String   @map("executive_summary")
  currentStatus    String   @map("current_status")
  keyDevelopments  Json     @default("[]") @map("key_developments")
  openIssues       Json     @default("[]") @map("open_issues")
  generatedAt      DateTime @map("generated_at") @db.Timestamptz(6)
  isStale          Boolean  @default(false) @map("is_stale")
  dataVersionHash  String?  @map("data_version_hash")
  emailCount       Int      @default(0) @map("email_count")
  documentCount    Int      @default(0) @map("document_count")
  noteCount        Int      @default(0) @map("note_count")
  taskCount        Int      @default(0) @map("task_count")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  case             Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([isStale])
  @@map("case_summaries")
}

model EmailCaseLink {
  id         String                   @id @default(uuid())
  emailId    String                   @map("email_id")
  caseId     String                   @map("case_id")
  confidence Float?                   @default(1.0)
  matchType  ClassificationMatchType? @map("match_type")
  linkedAt   DateTime                 @default(now()) @map("linked_at") @db.Timestamptz(6)
  linkedBy   String                   @map("linked_by")
  isPrimary  Boolean                  @default(false) @map("is_primary")
  case       Case                     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  email      Email                    @relation(fields: [emailId], references: [id], onDelete: Cascade)

  @@unique([emailId, caseId])
  @@index([emailId])
  @@index([caseId])
  @@index([linkedAt])
  @@map("email_case_links")
}

model EmailThreadShare {
  id             String           @id @default(uuid())
  conversationId String           @map("conversation_id")
  sharedBy       String           @map("shared_by")
  sharedWith     String           @map("shared_with")
  firmId         String           @map("firm_id")
  accessLevel    ShareAccessLevel @default(Read) @map("access_level")
  createdAt      DateTime         @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([conversationId, sharedWith, firmId])
  @@index([sharedWith, firmId])
  @@index([conversationId])
  @@map("email_thread_shares")
}

model HistoricalEmailSyncJob {
  id           String                    @id @default(uuid())
  caseId       String                    @map("case_id")
  contactEmail String                    @map("contact_email") @db.VarChar(320)
  contactRole  String                    @default("Client") @map("contact_role") @db.VarChar(50)
  status       HistoricalEmailSyncStatus @default(Pending)
  totalEmails  Int?                      @map("total_emails")
  syncedEmails Int                       @default(0) @map("synced_emails")
  errorMessage String?                   @map("error_message")
  startedAt    DateTime?                 @map("started_at") @db.Timestamptz(6)
  completedAt  DateTime?                 @map("completed_at") @db.Timestamptz(6)
  createdAt    DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime                  @updatedAt @map("updated_at") @db.Timestamptz(6)
  case         Case                      @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@unique([caseId, contactEmail])
  @@index([caseId])
  @@index([status])
  @@map("historical_email_sync_jobs")
}

model AIConversation {
  id        String             @id @default(uuid())
  firmId    String             @map("firm_id")
  userId    String             @map("user_id")
  caseId    String?            @map("case_id")
  status    ConversationStatus @default(Active)
  context   Json               @default("{}")
  closedAt  DateTime?          @map("closed_at") @db.Timestamptz(6)
  createdAt DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  case      Case?              @relation(fields: [caseId], references: [id])
  firm      Firm               @relation(fields: [firmId], references: [id], onDelete: Cascade)
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  AIMessage[]

  @@index([firmId])
  @@index([userId, status])
  @@index([caseId])
  @@map("ai_conversations")
}

model AIMessage {
  id             String          @id @default(uuid())
  conversationId String          @map("conversation_id")
  role           AIMessageRole
  content        String
  intent         String?         @db.VarChar(100)
  confidence     Float?
  actionType     String?         @map("action_type") @db.VarChar(100)
  actionPayload  Json?           @map("action_payload")
  actionStatus   AIActionStatus? @map("action_status")
  tokensUsed     Int?            @map("tokens_used")
  modelUsed      String?         @map("model_used") @db.VarChar(50)
  latencyMs      Int?            @map("latency_ms")
  createdAt      DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  conversation   AIConversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("ai_messages")
}

model Mapa {
  id          String        @id @default(uuid())
  caseId      String?       @map("case_id")
  name        String        @db.VarChar(255)
  description String?
  templateId  String?       @map("template_id")
  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdById String        @map("created_by_id")
  clientId    String?       @map("client_id")
  slots       MapaSlot[]
  case        Case?         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  client      Client?       @relation("ClientMape", fields: [clientId], references: [id], onDelete: Cascade)
  createdBy   User          @relation("MapaCreator", fields: [createdById], references: [id])
  template    MapaTemplate? @relation(fields: [templateId], references: [id])

  @@index([caseId])
  @@index([clientId])
  @@index([templateId])
  @@map("mape")
}

model MapaSlot {
  id             String        @id @default(uuid())
  mapaId         String        @map("mapa_id")
  name           String        @db.VarChar(255)
  description    String?
  category       String?       @db.VarChar(100)
  required       Boolean       @default(true)
  order          Int
  caseDocumentId String?       @map("case_document_id")
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  assignedAt     DateTime?     @map("assigned_at") @db.Timestamptz(6)
  assignedById   String?       @map("assigned_by_id")
  assignedBy     User?         @relation("SlotAssigner", fields: [assignedById], references: [id])
  caseDocument   CaseDocument? @relation(fields: [caseDocumentId], references: [id])
  mapa           Mapa          @relation(fields: [mapaId], references: [id], onDelete: Cascade)

  @@unique([mapaId, order])
  @@index([mapaId])
  @@index([caseDocumentId])
  @@map("mapa_slots")
}

model MapaTemplate {
  id              String    @id @default(uuid())
  firmId          String?   @map("firm_id")
  name            String    @db.VarChar(255)
  description     String?
  caseType        String?   @map("case_type") @db.VarChar(50)
  slotDefinitions Json      @default("[]") @map("slot_definitions")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdById     String?   @map("created_by_id")
  aiMetadata      Json?     @map("ai_metadata")
  contentHash     String?   @map("content_hash") @db.VarChar(64)
  isLocked        Boolean   @default(false) @map("is_locked")
  isONRC          Boolean   @default(false) @map("is_onrc")
  lastSynced      DateTime? @map("last_synced") @db.Timestamptz(6)
  procedureId     String?   @unique @map("procedure_id") @db.VarChar(100)
  sourceUrl       String?   @map("source_url") @db.VarChar(500)
  createdBy       User?     @relation("MapaTemplateCreator", fields: [createdById], references: [id], onDelete: Restrict)
  firm            Firm?     @relation(fields: [firmId], references: [id], onDelete: Cascade)
  mape            Mapa[]

  @@index([firmId])
  @@index([caseType])
  @@index([isONRC])
  @@map("mapa_templates")
}

model UserActivityEvent {
  id          String             @id @default(uuid())
  userId      String             @map("user_id")
  firmId      String             @map("firm_id")
  eventType   ActivityEventType  @map("event_type")
  entityType  ActivityEntityType @map("entity_type")
  entityId    String             @map("entity_id")
  entityTitle String?            @map("entity_title") @db.VarChar(500)
  metadata    Json?
  importance  EventImportance    @default(NORMAL)
  notified    Boolean            @default(false)
  seenAt      DateTime?          @map("seen_at") @db.Timestamptz(6)
  occurredAt  DateTime           @default(now()) @map("occurred_at") @db.Timestamptz(6)
  createdAt   DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  firm        Firm               @relation(fields: [firmId], references: [id], onDelete: Cascade)
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, notified, occurredAt])
  @@index([userId, eventType, occurredAt])
  @@index([firmId, occurredAt])
  @@map("user_activity_events")
}

model UserDailyContext {
  id              String    @id @default(uuid())
  userId          String    @unique @map("user_id")
  firmId          String    @map("firm_id")
  contextData     Json      @map("context_data")
  lastComputedAt  DateTime  @map("last_computed_at") @db.Timestamptz(6)
  lastBriefingAt  DateTime? @map("last_briefing_at") @db.Timestamptz(6)
  lastSeenEventId String?   @map("last_seen_event_id")
  validUntil      DateTime  @map("valid_until") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([validUntil])
  @@map("user_daily_contexts")
}

model CaseBriefing {
  id                   String    @id @default(uuid())
  caseId               String    @unique @map("case_id")
  firmId               String    @map("firm_id")
  briefingText         String    @map("briefing_text")
  briefingData         Json      @map("briefing_data")
  lastComputedAt       DateTime  @map("last_computed_at") @db.Timestamptz(6)
  validUntil           DateTime  @map("valid_until") @db.Timestamptz(6)
  lastEmailAt          DateTime? @map("last_email_at") @db.Timestamptz(6)
  lastDocumentAt       DateTime? @map("last_document_at") @db.Timestamptz(6)
  lastTaskAt           DateTime? @map("last_task_at") @db.Timestamptz(6)
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  documentSummaries    Json?     @map("document_summaries")
  emailThreadSummaries Json?     @map("email_thread_summaries")
  upcomingDeadlines    Json?     @map("upcoming_deadlines")
  contactContext       Json?     @map("contact_context")
  clientContext        Json?     @map("client_context")
  caseHealthIndicators Json?     @map("case_health_indicators")
  contextVersion       Int       @default(1) @map("context_version")
  correctionsAppliedAt DateTime? @map("corrections_applied_at") @db.Timestamptz(6)
  lastCorrectedBy      String?   @map("last_corrected_by")
  userCorrections      Json?     @map("user_corrections")
  case                 Case      @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([validUntil])
  @@map("case_briefings")
}

model CaseContextFile {
  id              String    @id @default(uuid())
  caseId          String    @map("case_id")
  firmId          String    @map("firm_id")
  source          String    @db.VarChar(50)
  content         String
  tokenCount      Int       @map("token_count")
  contextCritical String?   @map("context_critical")
  contextStandard String?   @map("context_standard")
  compressedAt    DateTime? @map("compressed_at") @db.Timestamptz(6)
  version         Int       @default(1)
  generatedAt     DateTime  @map("generated_at") @db.Timestamptz(6)
  validUntil      DateTime  @map("valid_until") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  case            Case      @relation(fields: [caseId], references: [id], onDelete: Cascade)
  firm            Firm      @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@unique([caseId, source])
  @@index([caseId])
  @@index([firmId])
  @@index([validUntil])
  @@map("case_context_files")
}

model ContextProfile {
  id                 String   @id @default(uuid())
  firmId             String   @map("firm_id")
  name               String   @db.VarChar(100)
  code               String   @db.VarChar(50)
  description        String?
  isDefault          Boolean  @default(false) @map("is_default")
  sections           Json     @default("[]")
  maxTokens          Int      @default(4000) @map("max_tokens")
  summarizationLevel String   @default("standard") @map("summarization_level") @db.VarChar(20)
  targetContext      String   @default("general") @map("target_context") @db.VarChar(30)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  firm               Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@unique([firmId, code])
  @@index([firmId])
  @@map("context_profiles")
}

model WordContentTemplate {
  id               String              @id @default(uuid())
  firmId           String              @map("firm_id")
  name             String              @db.VarChar(255)
  description      String?
  caseType         String?             @map("case_type") @db.VarChar(50)
  documentType     String              @default("Other") @map("document_type") @db.VarChar(50)
  sharePointItemId String              @map("share_point_item_id") @db.VarChar(255)
  sharePointPath   String              @map("share_point_path")
  sharePointWebUrl String?             @map("share_point_web_url")
  contentText      String?             @map("content_text")
  contentHash      String?             @map("content_hash") @db.VarChar(64)
  lastSynced       DateTime?           @map("last_synced") @db.Timestamptz(6)
  category         String?             @db.VarChar(100)
  tags             String[]            @default([])
  usageCount       Int                 @default(0) @map("usage_count")
  isActive         Boolean             @default(true) @map("is_active")
  createdById      String              @map("created_by_id")
  createdAt        DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  createdBy        User                @relation("WordTemplateCreator", fields: [createdById], references: [id])
  firm             Firm                @relation(fields: [firmId], references: [id], onDelete: Cascade)
  usages           WordTemplateUsage[]

  @@index([firmId])
  @@index([caseType])
  @@index([documentType])
  @@index([category])
  @@map("word_content_templates")
}

model WordTemplateUsage {
  id         String              @id @default(uuid())
  templateId String              @map("template_id")
  userId     String              @map("user_id")
  caseId     String?             @map("case_id")
  documentId String?             @map("document_id")
  usedAt     DateTime            @default(now()) @map("used_at") @db.Timestamptz(6)
  template   WordContentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([userId])
  @@map("word_template_usages")
}

model InAppNotification {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  title         String   @db.VarChar(255)
  body          String
  icon          String?  @db.VarChar(50)
  read          Boolean  @default(false)
  actionType    String?  @map("action_type") @db.VarChar(50)
  actionData    Json?    @map("action_data")
  sourceEventId String?  @map("source_event_id")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrichedNotification EnrichedNotification?

  @@index([userId, read, createdAt])
  @@index([userId, createdAt])
  @@map("in_app_notifications")
}

/// Flipboard-style enriched notification with AI-generated content
model EnrichedNotification {
  id               String   @id @default(uuid())
  notificationId   String   @unique @map("notification_id")
  userId           String   @map("user_id")
  headline         String   @db.VarChar(100)
  summary          String   @db.VarChar(300)
  imageUrl         String?  @map("image_url")
  priority         String   @db.VarChar(20)  // 'featured' | 'secondary'
  relatedItems     Json     @default("[]") @map("related_items")
  suggestedActions Json     @default("[]") @map("suggested_actions")
  enrichedAt       DateTime @default(now()) @map("enriched_at") @db.Timestamptz(6)

  notification     InAppNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, enrichedAt])
  @@map("enriched_notifications")
}

// ============================================================================
// User Flipboard - AI-generated actionable items for mobile
// ============================================================================

model UserFlipboard {
  id     String @id @default(uuid())
  firmId String @map("firm_id")
  userId String @unique @map("user_id") // One flipboard per user

  // Generated content
  items Json @default("[]") // FlipboardItem[] with actions

  // Generation metadata
  totalTokens  Int    @default(0) @map("total_tokens")
  totalCostEur Float? @map("total_cost_eur")

  // State tracking
  isRefreshing Boolean   @default(false) @map("is_refreshing")
  generatedAt  DateTime  @default(now()) @map("generated_at") @db.Timestamptz(6)
  refreshedAt  DateTime? @map("refreshed_at") @db.Timestamptz(6)

  // Relations
  firm Firm @relation(fields: [firmId], references: [id])
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([firmId])
  @@index([userId])
  @@map("user_flipboards")
}

model UserFlipboardRun {
  id     String @id @default(uuid())
  firmId String @map("firm_id")
  userId String @map("user_id")

  // Trigger info
  triggerType String @map("trigger_type") @db.VarChar(50) // 'login' | 'event' | 'batch' | 'manual'
  triggerEventType String? @map("trigger_event_type") @db.VarChar(100) // e.g., 'email_from_court', 'task_overdue'

  // Execution tracking
  status      String    @default("pending") @db.VarChar(20) // pending, running, completed, failed
  startedAt   DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)

  // Cost tracking
  inputTokens  Int?   @map("input_tokens")
  outputTokens Int?   @map("output_tokens")
  costEur      Float? @map("cost_eur")

  // Debug
  toolCalls Json?   @map("tool_calls")
  error     String?

  // Relations
  firm Firm @relation(fields: [firmId], references: [id])
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([firmId, startedAt])
  @@index([userId, startedAt])
  @@index([status])
  @@map("user_flipboard_runs")
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  endpoint  String
  p256dhKey String   @map("p256dh_key") @db.VarChar(255)
  authKey   String   @map("auth_key") @db.VarChar(255)
  userAgent String?  @map("user_agent") @db.VarChar(500)
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, active])
  @@map("push_subscriptions")
}

model DigestQueue {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  eventId      String   @map("event_id")
  eventType    String   @map("event_type") @db.VarChar(50)
  eventTitle   String?  @map("event_title") @db.VarChar(500)
  eventData    Json?    @map("event_data")
  scheduledFor DateTime @map("scheduled_for") @db.Timestamptz(6)
  sent         Boolean  @default(false)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([userId, scheduledFor, sent])
  @@index([scheduledFor, sent])
  @@map("digest_queue")
}

model AIUsageLog {
  id                  String   @id @default(uuid())
  feature             String   @db.VarChar(100)
  model               String   @db.VarChar(100)
  inputTokens         Int      @map("input_tokens")
  outputTokens        Int      @map("output_tokens")
  costEur             Decimal  @map("cost_eur") @db.Decimal(10, 6)
  userId              String?  @map("user_id")
  firmId              String   @map("firm_id")
  entityType          String?  @map("entity_type") @db.VarChar(50)
  entityId            String?  @map("entity_id")
  durationMs          Int      @map("duration_ms")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  batchJobId          String?  @map("batch_job_id")
  cacheCreationTokens Int?     @map("cache_creation_tokens")
  cacheReadTokens     Int?     @map("cache_read_tokens")
  thinkingTokens      Int?     @map("thinking_tokens")

  @@index([firmId, createdAt])
  @@index([feature, createdAt])
  @@index([batchJobId])
  @@map("ai_usage_logs")
}

model AIBatchJobRun {
  id               String    @id @default(uuid())
  firmId           String    @map("firm_id")
  feature          String    @db.VarChar(100)
  status           String    @db.VarChar(20)
  startedAt        DateTime  @map("started_at") @db.Timestamptz(6)
  completedAt      DateTime? @map("completed_at") @db.Timestamptz(6)
  itemsProcessed   Int       @default(0) @map("items_processed")
  itemsFailed      Int       @default(0) @map("items_failed")
  totalTokens      Int       @default(0) @map("total_tokens")
  totalCostEur     Decimal   @default(0) @map("total_cost_eur") @db.Decimal(10, 6)
  errorMessage     String?   @map("error_message")
  // Anthropic Batch API fields
  anthropicBatchId String?   @map("anthropic_batch_id") @db.VarChar(100)
  batchMode        String?   @map("batch_mode") @db.VarChar(20) // 'sync' | 'async_batch'
  itemsSubmitted   Int       @default(0) @map("items_submitted")
  itemsSucceeded   Int       @default(0) @map("items_succeeded")
  itemsErrored     Int       @default(0) @map("items_errored")
  itemsExpired     Int       @default(0) @map("items_expired")
  baseCostEur      Decimal   @default(0) @map("base_cost_eur") @db.Decimal(10, 6)
  discountApplied  Decimal   @default(0) @map("discount_applied") @db.Decimal(10, 6)

  requests AIBatchRequest[]

  @@index([firmId, feature, startedAt])
  @@index([status])
  @@index([anthropicBatchId])
  @@map("ai_batch_job_runs")
}

model AIBatchRequest {
  id           String    @id @default(uuid())
  batchJobId   String    @map("batch_job_id")
  customId     String    @map("custom_id") @db.VarChar(64) // Anthropic requires <= 64 chars
  entityType   String    @map("entity_type") @db.VarChar(50)
  entityId     String    @map("entity_id")
  status       String    @db.VarChar(20) // pending|succeeded|errored|expired
  inputTokens  Int?      @map("input_tokens")
  outputTokens Int?      @map("output_tokens")
  errorMessage String?   @map("error_message")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  processedAt  DateTime? @map("processed_at") @db.Timestamptz(6)
  // Retry tracking for transient failures
  retryCount   Int       @default(0) @map("retry_count")
  lastRetryAt  DateTime? @map("last_retry_at") @db.Timestamptz(6)

  batchJob AIBatchJobRun @relation(fields: [batchJobId], references: [id], onDelete: Cascade)

  @@unique([batchJobId, customId])
  @@index([entityType, entityId])
  @@map("ai_batch_requests")
}

model AIModelConfig {
  id            String   @id @default(uuid())
  firmId        String   @map("firm_id")
  operationType String   @map("operation_type") @db.VarChar(100)
  model         String   @db.VarChar(50)
  updatedById   String   @map("updated_by_id")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  firm          Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)
  updatedBy     User     @relation("AIModelConfigUpdater", fields: [updatedById], references: [id])

  @@unique([operationType, firmId])
  @@index([firmId])
  @@map("ai_model_configs")
}

model CaseHealthScore {
  id            String   @id @default(uuid())
  caseId        String   @map("case_id")
  firmId        String   @map("firm_id")
  score         Int
  activityScore Int      @map("activity_score")
  emailScore    Int      @map("email_score")
  taskScore     Int      @map("task_score")
  deadlineScore Int      @map("deadline_score")
  concerns      String[]
  suggestions   String[]
  riskLevel     String   @map("risk_level") @db.VarChar(20)
  calculatedAt  DateTime @default(now()) @map("calculated_at") @db.Timestamptz(6)
  case          Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([firmId, calculatedAt])
  @@index([caseId])
  @@index([score])
  @@map("case_health_scores")
}

model TeamChatMessage {
  id           String              @id @default(uuid())
  firmId       String              @map("firm_id")
  authorId     String              @map("author_id")
  content      String
  parentId     String?             @map("parent_id")
  mentions     String[]
  createdAt    DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  expiresAt    DateTime            @map("expires_at") @db.Timestamptz(6)
  activityRef  String?             @map("activity_ref")
  activityType String?             @map("activity_type")
  attachments  Json?
  type         TeamChatMessageType @default(User)
  author       User                @relation("SentChatMessages", fields: [authorId], references: [id])
  firm         Firm                @relation(fields: [firmId], references: [id])
  parent       TeamChatMessage?    @relation("MessageThread", fields: [parentId], references: [id])
  replies      TeamChatMessage[]   @relation("MessageThread")

  @@index([firmId, createdAt])
  @@index([authorId])
  @@index([parentId])
  @@index([expiresAt])
  @@map("team_chat_messages")
}

model CaseChapter {
  id              String             @id @default(uuid())
  caseId          String             @map("case_id")
  firmId          String             @map("firm_id")
  phase           CasePhase
  title           String             @db.VarChar(200)
  summary         String
  startDate       DateTime?          @map("start_date") @db.Date
  endDate         DateTime?          @map("end_date") @db.Date
  generatedAt     DateTime           @default(now()) @map("generated_at") @db.Timestamptz(6)
  dataVersionHash String             @map("data_version_hash") @db.VarChar(64)
  isStale         Boolean            @default(false) @map("is_stale")
  sortOrder       Int                @default(0) @map("sort_order")
  createdAt       DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  events          CaseChapterEvent[]
  case            Case               @relation(fields: [caseId], references: [id], onDelete: Cascade)
  firm            Firm               @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@unique([caseId, phase])
  @@index([caseId])
  @@index([firmId])
  @@index([phase])
  @@index([isStale])
  @@map("case_chapters")
}

model CaseChapterEvent {
  id         String               @id @default(uuid())
  chapterId  String               @map("chapter_id")
  eventType  CaseChapterEventType @map("event_type")
  title      String               @db.VarChar(300)
  summary    String
  occurredAt DateTime             @map("occurred_at") @db.Timestamptz(6)
  metadata   Json                 @default("{}")
  sortOrder  Int                  @default(0) @map("sort_order")
  createdAt  DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  chapter    CaseChapter          @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([chapterId])
  @@index([eventType])
  @@index([occurredAt])
  @@map("case_chapter_events")
}

model ClientContextDocument {
  id                 String   @id @default(uuid())
  clientId           String   @unique @map("client_id")
  firmId             String   @map("firm_id")
  content            Json
  contextFull        String   @map("context_full")
  contextStandard    String?  @map("context_standard")
  contextCritical    String?  @map("context_critical")
  tokenCountFull     Int      @map("token_count_full")
  tokenCountStandard Int?     @map("token_count_standard")
  tokenCountCritical Int?     @map("token_count_critical")
  version            Int      @default(1)
  generatedAt        DateTime @map("generated_at") @db.Timestamptz(6)
  validUntil         DateTime @map("valid_until") @db.Timestamptz(6)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  client             Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  firm               Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@index([firmId])
  @@index([validUntil])
  @@map("client_context_documents")
}

model CaseContextDocument {
  id                    String   @id @default(uuid())
  caseId                String   @unique @map("case_id")
  firmId                String   @map("firm_id")
  content               Json
  contextFull           String   @map("context_full")
  contextStandard       String?  @map("context_standard")
  contextCritical       String?  @map("context_critical")
  tokenCountFull        Int      @map("token_count_full")
  tokenCountStandard    Int?     @map("token_count_standard")
  tokenCountCritical    Int?     @map("token_count_critical")
  clientContextSnapshot Json?    @map("client_context_snapshot")
  version               Int      @default(1)
  generatedAt           DateTime @map("generated_at") @db.Timestamptz(6)
  validUntil            DateTime @map("valid_until") @db.Timestamptz(6)
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  case                  Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  firm                  Firm     @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@index([firmId])
  @@index([validUntil])
  @@map("case_context_documents")
}

// ============================================================================
// Unified Context System (replaces CaseContextFile, CaseContextDocument, ClientContextDocument)
// ============================================================================

model ContextFile {
  id     String @id @default(uuid())
  firmId String @map("firm_id")

  // Polymorphic: Either clientId OR caseId is set, never both
  entityType ContextEntityType @map("entity_type")
  clientId   String?           @unique @map("client_id")
  caseId     String?           @unique @map("case_id")

  // Structured sections (JSON) - same structure for both client and case
  identity       Json // ClientIdentitySection or CaseIdentitySection
  people         Json // ClientPeopleSection or CasePeopleSection
  documents      Json // DocumentsSection (same for both)
  communications Json // CommunicationsSection (same for both)

  // User corrections metadata
  lastCorrectedBy      String?   @map("last_corrected_by")
  correctionsAppliedAt DateTime? @map("corrections_applied_at") @db.Timestamptz(6)

  // Pre-rendered markdown tiers
  contentCritical String @map("content_critical")
  contentStandard String @map("content_standard")
  contentFull     String @map("content_full")
  tokensCritical  Int    @map("tokens_critical")
  tokensStandard  Int    @map("tokens_standard")
  tokensFull      Int    @map("tokens_full")

  // For CASE only: embedded snapshot of parent client context
  parentContextSnapshot Json? @map("parent_context_snapshot")

  // Metadata
  version       Int      @default(1)
  schemaVersion Int      @default(1) @map("schema_version")
  generatedAt   DateTime @map("generated_at") @db.Timestamptz(6)
  validUntil    DateTime @map("valid_until") @db.Timestamptz(6)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  client      Client?            @relation("UnifiedClientContextFile", fields: [clientId], references: [id], onDelete: Cascade)
  case        Case?              @relation("UnifiedCaseContextFile", fields: [caseId], references: [id], onDelete: Cascade)
  firm        Firm               @relation(fields: [firmId], references: [id], onDelete: Cascade)
  references  ContextReference[]
  corrections UserCorrection[]

  @@index([firmId])
  @@index([entityType])
  @@index([validUntil])
  @@index([firmId, validUntil]) // Composite index for cleanup queries filtering by firm + expiration
  @@map("context_files")
}

enum ContextEntityType {
  CLIENT
  CASE
}

model ContextReference {
  id            String @id @default(uuid())
  contextFileId String @map("context_file_id")

  // Reference ID for citations: DOC-abc12, EMAIL-xyz89, THR-m5n6o
  refId   String         @map("ref_id") @db.VarChar(20)
  refType ContextRefType @map("ref_type")

  // Source entity
  sourceId   String @map("source_id")
  sourceType String @map("source_type") @db.VarChar(30) // "Document" | "Email" | "ThreadSummary"

  // Cached info for context (avoids re-fetching)
  title      String    @db.VarChar(500)
  summary    String?
  sourceDate DateTime? @map("source_date") @db.Timestamptz(6)
  metadata   Json? // Extra: fileName, sender, participants, etc.

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  contextFile ContextFile @relation(fields: [contextFileId], references: [id], onDelete: Cascade)

  @@unique([contextFileId, refId])
  @@index([contextFileId])
  @@index([sourceId])
  @@index([refId])
  @@map("context_references")
}

enum ContextRefType {
  DOCUMENT
  EMAIL
  THREAD
}

enum CorrectionType {
  OVERRIDE
  APPEND
  REMOVE
  NOTE
}

// ============================================================================
// User Corrections (Normalized from JSON)
// ============================================================================

model UserCorrection {
  id             String         @id @default(uuid())
  contextFileId  String         @map("context_file_id")
  sectionId      String         @map("section_id") @db.VarChar(100)
  fieldPath      String?        @map("field_path") @db.VarChar(200)
  correctionType CorrectionType @map("correction_type")
  originalValue  String?        @map("original_value")
  correctedValue String         @map("corrected_value")
  reason         String?
  createdBy      String         @map("created_by")
  isActive       Boolean        @default(true) @map("is_active")
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)

  contextFile ContextFile @relation(fields: [contextFileId], references: [id], onDelete: Cascade)

  @@index([contextFileId])
  @@index([createdBy])
  @@index([isActive])
  @@map("user_corrections")
}

// ============================================================================
// Case Comprehension System (Agent-Generated Understanding)
// ============================================================================

enum AgentRunStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model CaseComprehension {
  id     String @id @default(uuid())
  caseId String @unique @map("case_id")
  firmId String @map("firm_id")

  // Current Picture - free-form markdown, agent decides structure
  currentPicture String @map("current_picture") @db.Text

  // Data Map - semantic index for Word Add-in agent
  dataMap Json @default("{}") @map("data_map")

  // Compressed tiers for Word Add-in
  contentCritical String @map("content_critical") @db.Text
  contentStandard String @map("content_standard") @db.Text
  tokensFull      Int    @map("tokens_full")
  tokensCritical  Int    @map("tokens_critical")
  tokensStandard  Int    @map("tokens_standard")

  // Generation metadata
  version     Int       @default(1)
  generatedAt DateTime  @map("generated_at") @db.Timestamptz(6)
  generatedBy String?   @map("generated_by")
  validUntil  DateTime  @map("valid_until") @db.Timestamptz(6)
  isStale     Boolean   @default(false) @map("is_stale")
  staleSince  DateTime? @map("stale_since") @db.Timestamptz(6) // When marked stale (for priority ordering)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  case        Case                      @relation(fields: [caseId], references: [id], onDelete: Cascade)
  firm        Firm                      @relation(fields: [firmId], references: [id], onDelete: Cascade)
  corrections ComprehensionCorrection[]
  agentRuns   ComprehensionAgentRun[]

  @@index([firmId])
  @@index([isStale])
  @@index([validUntil])
  @@index([staleSince])
  @@map("case_comprehensions")
}

model ComprehensionCorrection {
  id              String @id @default(uuid())
  comprehensionId String @map("comprehension_id")

  // What text this correction applies to
  anchorText String @map("anchor_text") @db.VarChar(500)
  anchorHash String @map("anchor_hash") @db.VarChar(64)

  // The correction (reuse existing CorrectionType enum)
  correctionType CorrectionType @map("correction_type")
  correctedValue String         @map("corrected_value") @db.Text
  reason         String?

  // Metadata
  createdBy String    @map("created_by")
  isActive  Boolean   @default(true) @map("is_active")
  appliedAt DateTime? @map("applied_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  comprehension CaseComprehension @relation(fields: [comprehensionId], references: [id], onDelete: Cascade)

  @@index([comprehensionId])
  @@index([isActive])
  @@index([anchorHash])
  @@map("comprehension_corrections")
}

model ComprehensionAgentRun {
  id              String  @id @default(uuid())
  comprehensionId String? @map("comprehension_id")
  caseId          String  @map("case_id")
  firmId          String  @map("firm_id")

  // Trigger info
  trigger      String  @db.VarChar(50)
  triggerEvent String? @map("trigger_event") @db.VarChar(100)

  // Execution
  status      AgentRunStatus @default(PENDING)
  startedAt   DateTime?      @map("started_at") @db.Timestamptz(6)
  completedAt DateTime?      @map("completed_at") @db.Timestamptz(6)
  durationMs  Int?           @map("duration_ms")

  // Agent details
  toolCalls  Json    @default("[]") @map("tool_calls")
  tokensUsed Int?    @map("tokens_used")
  modelId    String? @map("model_id") @db.VarChar(100)

  // Token breakdown for cost tracking
  inputTokens    Int?     @map("input_tokens")
  outputTokens   Int?     @map("output_tokens")
  thinkingTokens Int?     @map("thinking_tokens")
  estimatedCost  Decimal? @map("estimated_cost") @db.Decimal(10, 6)

  // Debugging: persisted thinking content from the agent
  thinkingContent String? @map("thinking_content") @db.Text

  // Error handling
  error      String? @db.Text
  retryCount Int     @default(0) @map("retry_count")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  comprehension CaseComprehension? @relation(fields: [comprehensionId], references: [id], onDelete: SetNull)

  @@index([caseId])
  @@index([firmId])
  @@index([status])
  @@index([createdAt])
  @@map("comprehension_agent_runs")
}

model OblioConfig {
  id                 String    @id @default(uuid())
  firmId             String    @unique @map("firm_id")
  email              String    @db.VarChar(255)
  secretEncrypted    String    @map("secret_encrypted")
  companyCif         String    @map("company_cif") @db.VarChar(20)
  defaultSeries      String    @map("default_series") @db.VarChar(20)
  workStation        String?   @map("work_station") @db.VarChar(100)
  isVatPayer         Boolean   @default(true) @map("is_vat_payer")
  defaultVatRate     Decimal   @default(19) @map("default_vat_rate") @db.Decimal(5, 2)
  defaultDueDays     Int       @default(30) @map("default_due_days")
  exchangeRateSource String    @default("BNR") @map("exchange_rate_source") @db.VarChar(20)
  autoSubmitEFactura Boolean   @default(false) @map("auto_submit_efactura")
  lastTestedAt       DateTime? @map("last_tested_at") @db.Timestamptz(6)
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  firm               Firm      @relation(fields: [firmId], references: [id], onDelete: Cascade)

  @@map("oblio_configs")
}

model Invoice {
  id                  String               @id @default(uuid())
  firmId              String               @map("firm_id")
  clientId            String               @map("client_id")
  caseId              String?              @map("case_id")
  oblioSeries         String?              @map("oblio_series") @db.VarChar(20)
  oblioNumber         Int?                 @map("oblio_number")
  oblioDocumentId     String?              @map("oblio_document_id") @db.VarChar(100)
  issueDate           DateTime             @map("issue_date") @db.Date
  dueDate             DateTime             @map("due_date") @db.Date
  originalCurrency    String               @default("EUR") @map("original_currency") @db.VarChar(3)
  invoiceCurrency     String               @default("RON") @map("invoice_currency") @db.VarChar(3)
  exchangeRate        Decimal?             @map("exchange_rate") @db.Decimal(10, 6)
  exchangeRateDate    DateTime?            @map("exchange_rate_date") @db.Date
  exchangeRateSource  String?              @map("exchange_rate_source") @db.VarChar(20)
  subtotalEur         Decimal              @map("subtotal_eur") @db.Decimal(15, 2)
  subtotalRon         Decimal?             @map("subtotal_ron") @db.Decimal(15, 2)
  vatAmount           Decimal              @map("vat_amount") @db.Decimal(15, 2)
  total               Decimal              @db.Decimal(15, 2)
  status              InvoiceStatus        @default(Draft)
  eFacturaStatus      EFacturaStatus?      @map("efactura_status")
  eFacturaId          String?              @map("efactura_id") @db.VarChar(100)
  eFacturaSubmittedAt DateTime?            @map("efactura_submitted_at") @db.Timestamptz(6)
  eFacturaError       String?              @map("efactura_error")
  notes               String?
  internalNote        String?              @map("internal_note")
  pdfUrl              String?              @map("pdf_url")
  createdById         String               @map("created_by_id")
  issuedAt            DateTime?            @map("issued_at") @db.Timestamptz(6)
  paidAt              DateTime?            @map("paid_at") @db.Timestamptz(6)
  cancelledAt         DateTime?            @map("cancelled_at") @db.Timestamptz(6)
  cancellationReason  String?              @map("cancellation_reason")
  createdAt           DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)
  billingHistory      CaseBillingHistory[]
  lineItems           InvoiceLineItem[]
  case                Case?                @relation(fields: [caseId], references: [id])
  client              Client               @relation(fields: [clientId], references: [id])
  createdBy           User                 @relation("InvoiceCreator", fields: [createdById], references: [id])
  firm                Firm                 @relation(fields: [firmId], references: [id])
  tasks               Task[]

  @@unique([firmId, oblioSeries, oblioNumber])
  @@index([firmId])
  @@index([clientId])
  @@index([status])
  @@map("invoices")
}

model InvoiceLineItem {
  id              String       @id @default(uuid())
  invoiceId       String       @map("invoice_id")
  name            String       @db.VarChar(500)
  description     String?
  lineType        LineItemType @map("line_type")
  originalHours   Decimal?     @map("original_hours") @db.Decimal(10, 2)
  originalRateEur Decimal?     @map("original_rate_eur") @db.Decimal(15, 2)
  quantity        Decimal      @db.Decimal(10, 2)
  measuringUnit   String       @default("ore") @map("measuring_unit") @db.VarChar(20)
  unitPriceEur    Decimal      @map("unit_price_eur") @db.Decimal(15, 2)
  unitPriceRon    Decimal?     @map("unit_price_ron") @db.Decimal(15, 2)
  amountEur       Decimal      @map("amount_eur") @db.Decimal(15, 2)
  amountRon       Decimal?     @map("amount_ron") @db.Decimal(15, 2)
  vatRate         Decimal      @default(19) @map("vat_rate") @db.Decimal(5, 2)
  vatAmount       Decimal      @map("vat_amount") @db.Decimal(15, 2)
  total           Decimal      @db.Decimal(15, 2)
  wasAdjusted     Boolean      @default(false) @map("was_adjusted")
  adjustmentNote  String?      @map("adjustment_note")
  timeEntryId     String?      @map("time_entry_id")
  taskId          String?      @map("task_id")
  sortOrder       Int          @default(0) @map("sort_order")
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  invoice         Invoice      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  task            Task?        @relation(fields: [taskId], references: [id])
  timeEntry       TimeEntry?   @relation(fields: [timeEntryId], references: [id])

  @@index([invoiceId])
  @@index([timeEntryId])
  @@index([taskId])
  @@map("invoice_line_items")
}

enum TeamChatMessageType {
  User
  System
}

enum UserRole {
  Partner
  Associate
  Paralegal
  BusinessOwner
  AssociateJr
}

enum UserStatus {
  Pending
  Active
  Inactive
}

enum UserAuditAction {
  Activated
  Deactivated
  RoleChanged
}

enum CaseStatus {
  Active
  OnHold
  Closed
  Archived
  PendingApproval
  Deleted
}

enum CaseSyncStatus {
  Pending
  Syncing
  Completed
  Failed
}

enum CaseType {
  Litigation
  Contract
  Advisory
  Criminal
  Other
}

enum CaseActorRole {
  Client
  OpposingParty
  OpposingCounsel
  Witness
  Expert
  Intervenient
  Mandatar
  Court
  Prosecutor
  Bailiff
  Notary
  LegalRepresentative
  Other
}

enum GlobalEmailSourceCategory {
  Court
  Notary
  Bailiff
  Authority
  Other
}

enum BillingType {
  Hourly
  Fixed
  Retainer
}

enum BillingEventType {
  InvoiceCreated
  InvoiceCancelled
  InvoicePaid
  FixedAmountChanged
  RetainerAmountChanged
}

enum RetainerPeriod {
  Monthly
  Quarterly
  Annually
}

enum ApprovalStatus {
  Pending
  Approved
  Rejected
}

enum NotificationType {
  CasePendingApproval
  CaseApproved
  CaseRejected
  CaseNeedsFinancialSetup
  DocumentReviewRequested
  DocumentReviewAssigned
  DocumentApproved
  DocumentRejected
  DocumentRevisionRequested
  DocumentCommentAdded
  DocumentCommentMentioned
  DelegationRequested
  DelegationAccepted
  DelegationDeclined
  TaskDeadlineReminder
  TaskOverdue
  DependencyBlocked
  DependencyUnblocked
  TaskCommentAdded
  TaskCommentMentioned
  TaskCommentReplied
  TaskStatusUpdated
  SubtaskCreated
  TaskAttachmentAdded
  MorningBriefingReady
  AISuggestionCreated
  BulkCommunicationCompleted
  CommunicationExportReady
  EmailMadePublic
  DocumentMadePublic
  NewEmailWithAttachments
  NewTaskAssigned
  NewEventAssigned
  NewDocumentUploaded
  NewMapaCreated
  MapaCompleted
}

enum RateType {
  partner
  associate
  paralegal
  fixed
}

enum DocumentStatus {
  DRAFT
  READY_FOR_REVIEW
  FINAL
}

enum ThumbnailStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  NOT_SUPPORTED
}

enum DocumentExtractionStatus {
  NONE
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  UNSUPPORTED
}

enum DocumentSourceType {
  UPLOAD
  EMAIL_ATTACHMENT
  AI_GENERATED
  TEMPLATE
}

enum DocumentAuditAction {
  Uploaded
  LinkedToCase
  UnlinkedFromCase
  PermanentlyDeleted
  MetadataUpdated
}

enum SearchType {
  FullText
  Semantic
  Hybrid
}

enum ImportSessionStatus {
  Uploading
  Extracting
  InProgress
  Completed
  Exported
}

enum PrimaryLanguage {
  Romanian
  English
  Italian
  French
  Mixed
}

enum TemplatePotential {
  High
  Medium
  Low
}

enum StructureType {
  structured
  semi_structured @map("semi-structured")
  unstructured
}

enum DocumentCategorizationStatus {
  Uncategorized
  Categorized
  Skipped
}

enum SkipReason {
  Scanned
  Duplicate
  Empty
  Corrupted
}

enum PatternType {
  phrase
  clause
  structure
}

enum PipelineRunType {
  scheduled
  manual
}

enum PipelineStatus {
  running
  completed
  failed
}

enum ChangeType {
  ADDED
  REMOVED
  MODIFIED
  MOVED
}

enum ChangeSignificance {
  FORMATTING
  MINOR_WORDING
  SUBSTANTIVE
  CRITICAL
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum ResponseType {
  ACCEPT
  REJECT
  COUNTER_PROPOSAL
  CLARIFICATION
}

enum TaskTypeEnum {
  Research
  DocumentCreation
  DocumentRetrieval
  CourtDate
  Meeting
  BusinessTrip
  Hearing
  LegalDeadline
  Reminder
  GeneralTask
}

enum TaskStatus {
  Pending
  InProgress
  Completed
  Cancelled
}

enum TaskPriority {
  Low
  Medium
  High
  Urgent
}

enum AttendeeResponse {
  Pending
  Accepted
  Declined
  Tentative
}

enum TaskDocumentLinkType {
  Source
  Output
  Reference
}

enum DelegationStatus {
  Pending
  Accepted
  Declined
}

enum OffsetType {
  CaseStart
  PreviousTask
  CaseDeadline
}

enum DependencyType {
  FinishToStart
  StartToStart
  FinishToFinish
  StartToFinish
}

enum AvailabilityType {
  OutOfOffice
  ReducedHours
  Vacation
  SickLeave
  Training
}

enum SkillType {
  Litigation
  ContractDrafting
  LegalResearch
  ClientCommunication
  CourtProcedures
  DocumentReview
  Negotiation
  DueDiligence
  RegulatoryCompliance
  IntellectualProperty
}

enum TaskHistoryAction {
  Created
  Updated
  StatusChanged
  AssigneeChanged
  PriorityChanged
  DueDateChanged
  CommentAdded
  CommentEdited
  CommentDeleted
  AttachmentAdded
  AttachmentRemoved
  SubtaskCreated
  SubtaskCompleted
  DependencyAdded
  DependencyRemoved
  Delegated
}

enum CaseActivityType {
  TaskCreated
  TaskStatusChanged
  TaskCompleted
  TaskAssigned
  TaskCommented
  DocumentUploaded
  DocumentVersioned
  CommunicationReceived
  CommunicationSent
  DeadlineApproaching
  MilestoneReached
}

enum TaskPatternType {
  CoOccurrence
  Sequence
  CaseTypeSpecific
}

enum ExtractionStatus {
  Pending
  Converted
  Dismissed
  Expired
}

enum RiskType {
  ClientDissatisfaction
  DeadlineRisk
  ScopeCreep
  PaymentRisk
  RelationshipRisk
}

enum RiskSeverity {
  Low
  Medium
  High
}

enum EmailTone {
  Formal
  Professional
  Brief
  Detailed
}

enum RecipientType {
  Client
  OpposingCounsel
  Court
  ThirdParty
  Internal
}

enum DraftStatus {
  Generated
  Editing
  Ready
  Sent
  Discarded
}

enum SentEmailSource {
  NEW_EMAIL
  REPLY
  TASK_REMINDER
  OVERDUE_NOTIFICATION
}

enum SuggestionType {
  MorningBriefing
  TaskSuggestion
  PatternMatch
  DeadlineWarning
  DocumentCheck
  FollowUp
  RiskAlert
}

enum SuggestionCategory {
  Task
  Communication
  Document
  Calendar
  Compliance
}

enum SuggestionPriority {
  Low
  Normal
  High
  Urgent
}

enum SuggestionStatus {
  Pending
  Accepted
  Dismissed
  Expired
  AutoApplied
}

enum CommunicationChannel {
  Email
  InternalNote
  WhatsApp
  Phone
  Meeting
  SMS
}

enum CommunicationDirection {
  Inbound
  Outbound
  Internal
}

enum PrivacyLevel {
  Normal
  Confidential
  AttorneyOnly
  PartnerOnly
}

enum TemplateCategory {
  ClientUpdate
  CourtFiling
  AppointmentReminder
  DocumentRequest
  InvoiceReminder
  CaseOpening
  CaseClosing
  General
}

enum BulkRecipientType {
  CaseClients
  CaseTeam
  AllClients
  CustomList
  CaseTypeClients
}

enum BulkCommunicationStatus {
  Draft
  Scheduled
  InProgress
  Completed
  PartiallyFailed
  Cancelled
}

enum ExportFormat {
  PDF
  CSV
  JSON
  DOCX
}

enum ExportStatus {
  Processing
  Completed
  Failed
  Expired
}

enum SnippetCategory {
  Greeting
  Closing
  LegalPhrase
  ClientResponse
  InternalNote
  Custom
}

enum EditType {
  Addition
  Deletion
  Replacement
  Reorder
  StyleChange
}

enum ClassificationAction {
  Assigned
  Moved
  Ignored
  Unassigned
  MANUAL_COURT_ASSIGN
  MANUAL_IGNORE
  MANUAL_CLASSIFY
  MANUAL_LINK
  MANUAL_UNLINK
  CONFIRMED
  MANUAL_REASSIGN
}

enum ClassificationMatchType {
  Actor
  ReferenceNumber
  Keyword
  Semantic
  GlobalSource
  Manual
  ThreadContinuity
}

enum ClassificationReason {
  MultiCaseConflict
  LowConfidence
  NoMatchingCase
  CourtNoReference
  UnknownContact
}

enum EmailClassificationState {
  Pending
  Classified
  Uncertain
  CourtUnassigned
  Ignored
  ClientInbox
}

enum HistoricalEmailSyncStatus {
  Pending
  InProgress
  Completed
  Failed
}

enum ConversationStatus {
  Active
  AwaitingConfirmation
  Completed
  Expired
}

enum AIMessageRole {
  User
  Assistant
  System
}

enum AIActionStatus {
  Proposed
  Confirmed
  Executed
  Rejected
  Failed
}

enum ActivityEventType {
  EMAIL_RECEIVED
  EMAIL_CLASSIFIED
  EMAIL_FROM_COURT
  DOCUMENT_UPLOADED
  DOCUMENT_SHARED
  TASK_ASSIGNED
  TASK_DUE_TODAY
  TASK_OVERDUE
  TASK_COMPLETED
  CASE_DEADLINE_APPROACHING
  CASE_HEARING_TODAY
  CASE_STATUS_CHANGED
  CALENDAR_EVENT_TODAY
  CALENDAR_EVENT_REMINDER
}

enum ActivityEntityType {
  EMAIL
  DOCUMENT
  TASK
  CASE
  CALENDAR_EVENT
}

enum EventImportance {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum CasePhase {
  ConsultantaInitiala
  Negociere
  DueDiligence
  PrimaInstanta
  Apel
  Executare
  Mediere
  Arbitraj
  Inchis
}

enum CaseChapterEventType {
  Document
  Email
  Task
  CourtOutcome
  ContractSigned
  Negotiation
  Deadline
  ClientDecision
  TeamChange
  StatusChange
  Milestone
}

enum InvoiceStatus {
  Draft
  Issued
  Paid
  PartiallyPaid
  Cancelled
  Overdue
}

enum EFacturaStatus {
  Pending
  Submitted
  Accepted
  Rejected
  Error
}

enum LineItemType {
  TimeEntry
  Fixed
  Expense
  Discount
  Manual
}

enum ShareAccessLevel {
  Read
  ReadWrite
}

// ============================================================================
// Legacy Import - Document Templates (for Word Add-in)
// Tables created by legacy-import app, accessed by gateway for Word add-in
// ============================================================================

enum ClusterStatus {
  Pending
  Approved
  Rejected
}

model DocumentCluster {
  id        String @id @default(uuid())
  sessionId String @map("session_id")

  // AI-suggested naming
  suggestedName   String  @map("suggested_name") @db.VarChar(200)
  suggestedNameEn String? @map("suggested_name_en") @db.VarChar(200)
  description     String? @db.Text

  // Human validation
  approvedName String?       @map("approved_name") @db.VarChar(200)
  status       ClusterStatus @default(Pending)
  validatedBy  String?       @map("validated_by")
  validatedAt  DateTime?     @map("validated_at") @db.Timestamptz(6)

  // Stats
  documentCount     Int      @map("document_count")
  sampleDocumentIds String[] @map("sample_document_ids")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  template DocumentTemplate?

  @@index([sessionId])
  @@index([sessionId, status])
  @@map("document_clusters")
}

model DocumentTemplate {
  id        String @id @default(uuid())
  clusterId String @unique @map("cluster_id")

  name        String  @db.VarChar(200)
  nameEn      String? @map("name_en") @db.VarChar(200)
  description String? @db.Text

  // Extracted structure
  sections           Json @map("sections")
  variableFields     Json @map("variable_fields")
  boilerplateClauses Json @map("boilerplate_clauses")
  styleGuide         Json @map("style_guide")

  // Metadata
  sourceDocumentIds    String[] @map("source_document_ids")
  extractionConfidence Float    @map("extraction_confidence")
  language             String   @db.VarChar(20)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  cluster DocumentCluster @relation(fields: [clusterId], references: [id], onDelete: Cascade)

  @@map("document_templates")
}
