# Render.com Infrastructure Configuration
# Legal Platform - Full Stack Deployment
#
# ############################################################################
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#                    DO NOT IMPORT THIS FILE AS A BLUEPRINT
# !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
#
# Services ALREADY EXIST on Render. Re-importing will create DUPLICATES that
# waste money and cause confusion. This has happened before - don't do it again.
#
# EXISTING SERVICE IDs (DO NOT RECREATE):
#   - legal-platform-web:        srv-d4dk9fodl3ps73d3d7ig
#   - legal-platform-gateway:    srv-d4pkv8q4i8rc73fq3mvg
#   - legal-platform-ai-service: srv-d4uor5be5dus73a0hs3g
#   - bojin-legacy-import:       srv-d4k84gogjchc73a0lqo0
#
# HOW TO DEPLOY:
#   1. Run: pnpm deploy:production (triggers deploy via API)
#   2. OR: Go to Render Dashboard → Select service → Manual Deploy
#
# TO CHANGE SERVICE SETTINGS:
#   Edit directly in Render Dashboard, not in this file.
#   This file is DOCUMENTATION ONLY - changes here won't auto-apply.
#
# ############################################################################

services:
  ##############################################################################
  # Web Service - Next.js Frontend
  ##############################################################################
  - type: web
    name: legal-platform-web
    runtime: docker
    repo: https://github.com/stoianovici/bojin-law-2.git
    branch: main # Production deploys from main
    dockerfilePath: ./infrastructure/docker/Dockerfile.web
    dockerContext: .
    plan: starter # 512MB RAM - for testing (upgrade to 'standard' for production)
    numInstances: 1 # Single instance for testing (increase to 2+ for production HA)
    region: oregon # US West
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_APP_URL
        value: https://legal-platform-web.onrender.com # Will update with custom domain later
      - key: NEXT_PUBLIC_API_URL
        sync: false # Set in Render dashboard when backend is ready
      - key: DATABASE_URL
        fromDatabase:
          name: legal-platform-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: legal-platform-redis
          property: connectionString

      # Azure AD Authentication (set in Render dashboard - same as legacy-import)
      - key: NEXT_PUBLIC_AZURE_AD_CLIENT_ID
        sync: false
      - key: NEXT_PUBLIC_AZURE_AD_TENANT_ID
        sync: false
      # GraphQL API endpoint (gateway service URL + /graphql path)
      - key: GRAPHQL_ENDPOINT
        value: https://legal-platform-gateway.onrender.com/graphql
    healthCheckPath: /api/health
    autoDeploy: false # Manual deploy only - use: npm run deploy:production

  ##############################################################################
  # Gateway Service - GraphQL API
  ##############################################################################
  - type: web
    name: legal-platform-gateway
    runtime: docker
    repo: https://github.com/stoianovici/bojin-law-2.git
    branch: main
    dockerfilePath: ./infrastructure/docker/Dockerfile.gateway
    dockerContext: .
    plan: starter # 512MB RAM
    numInstances: 1
    region: oregon
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: '4000'
      - key: DATABASE_URL
        fromDatabase:
          name: legal-platform-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: legal-platform-redis
          property: connectionString
      # CORS - allow requests from web frontend
      - key: CORS_ORIGIN
        value: https://legal-platform-web.onrender.com
      # Azure AD Authentication (set in Render dashboard)
      - key: AZURE_AD_CLIENT_ID
        sync: false
      - key: AZURE_AD_CLIENT_SECRET
        sync: false
      - key: AZURE_AD_TENANT_ID
        sync: false
      - key: AZURE_AD_REDIRECT_URI
        value: https://legal-platform-gateway.onrender.com/auth/callback
      # JWT Secret (set in Render dashboard)
      - key: JWT_SECRET
        sync: false
      # Session Secret (set in Render dashboard)
      - key: SESSION_SECRET
        sync: false
      # AI Service Integration
      - key: AI_SERVICE_URL
        value: https://legal-platform-ai-service.onrender.com
      - key: AI_SERVICE_API_KEY
        sync: false
    healthCheckPath: /health
    autoDeploy: false # Manual deploy only - use: npm run deploy:production

  ##############################################################################
  # AI Service - Email Drafting, Document Generation, Suggestions
  ##############################################################################
  - type: web
    name: legal-platform-ai-service
    runtime: docker
    repo: https://github.com/stoianovici/bojin-law-2.git
    branch: main
    dockerfilePath: ./infrastructure/docker/Dockerfile.ai-service
    dockerContext: .
    plan: starter # 512MB RAM
    numInstances: 1
    region: oregon
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: '3002'
      - key: DATABASE_URL
        fromDatabase:
          name: legal-platform-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: legal-platform-redis
          property: connectionString
      # Anthropic API Key (set in Render dashboard)
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: ANTHROPIC_MODEL
        value: claude-3-5-sonnet-20241022
      # API Key for service-to-service auth
      - key: AI_SERVICE_API_KEY
        sync: false
    healthCheckPath: /api/ai/health
    autoDeploy: false

  ##############################################################################
  # Cache - Redis for Session Management
  ##############################################################################
  - type: redis
    name: legal-platform-redis
    plan: pro # 1GB Redis
    region: oregon # US West
    maxmemoryPolicy: allkeys-lru # LRU eviction when memory limit reached
    ipAllowList: [] # Empty = allow all Render services

  ##############################################################################
  # Legacy Document Import App (Story 3.2.5)
  # Standalone app for PST import and document categorization
  ##############################################################################
  - type: web
    name: bojin-legacy-import
    runtime: node
    repo: https://github.com/stoianovici/bojin-law-2.git
    branch: main
    buildCommand: npm install -g pnpm && pnpm install --no-frozen-lockfile && pnpm --filter @legal-platform/database build && pnpm --filter @legal-platform/legacy-import build
    startCommand: pnpm --filter @legal-platform/legacy-import start
    plan: starter # 512MB RAM - upgrade for large PST processing
    numInstances: 1
    region: oregon # Same region as other services
    envVars:
      # Node Environment
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: '22'

      # App URL - Update after first deploy with actual URL
      - key: NEXT_PUBLIC_APP_URL
        value: https://bojin-legacy-import.onrender.com

      # Database (same as main app)
      - key: DATABASE_URL
        fromDatabase:
          name: legal-platform-db
          property: connectionString

      # Redis
      - key: REDIS_URL
        fromService:
          type: redis
          name: legal-platform-redis
          property: connectionString

      # Azure AD Authentication (set in Render dashboard)
      - key: NEXT_PUBLIC_AZURE_AD_CLIENT_ID
        sync: false
      - key: NEXT_PUBLIC_AZURE_AD_TENANT_ID
        sync: false
      - key: AZURE_AD_CLIENT_SECRET
        sync: false

      # Cloudflare R2 Storage (set in Render dashboard)
      - key: R2_ACCOUNT_ID
        sync: false
      - key: R2_ACCESS_KEY_ID
        sync: false
      - key: R2_SECRET_ACCESS_KEY
        sync: false
      - key: R2_BUCKET_NAME
        value: legacy-import
      - key: R2_ENDPOINT
        sync: false

      # Anthropic AI for document analysis (set in Render dashboard)
      - key: ANTHROPIC_API_KEY
        sync: false

    healthCheckPath: /api/health
    autoDeploy: false # Manual deploy only - stable service, shared packages may change

##############################################################################
# Database - PostgreSQL with pgvector
##############################################################################
databases:
  - name: legal-platform-db
    databaseName: legal_platform_prod
    user: legal_platform_user
    plan: basic-1gb # 1GB RAM, pay-per-GB storage
    region: oregon # US West
    ipAllowList: [] # Empty = allow all Render services (recommended)

##############################################################################
# Future Services (uncomment when implemented)
##############################################################################
# - Gateway Service (GraphQL API)
# - Document Service (File Processing & Storage)
# - AI Service (Claude + Grok with Semantic Search)
# - Task Service (Background Job Processing)
# - Integration Service (Third-Party APIs)
# - Notification Service (Email, SMS, Push)
#
# See infrastructure/ARCHITECTURE.md for full system design
##############################################################################
