# Render.com Infrastructure Configuration
# Legal Platform - Web Frontend Only (for now)
#
# Backend services, database, and Redis will be added when implemented

services:
  ##############################################################################
  # Web Service - Next.js Frontend
  ##############################################################################
  - type: web
    name: legal-platform-web
    runtime: docker
    repo: https://github.com/stoianovici/bojin-law-2.git
    branch: main # Production deploys from main
    dockerfilePath: ./infrastructure/docker/Dockerfile.web
    dockerContext: .
    plan: starter # 512MB RAM - for testing (upgrade to 'standard' for production)
    numInstances: 1 # Single instance for testing (increase to 2+ for production HA)
    region: oregon # US West
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_APP_URL
        value: https://legal-platform-web.onrender.com # Will update with custom domain later
      - key: NEXT_PUBLIC_API_URL
        sync: false # Set in Render dashboard when backend is ready
      - key: DATABASE_URL
        fromDatabase:
          name: legal-platform-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: legal-platform-redis
          property: connectionString
    healthCheckPath: /api/health
    autoDeployTrigger: commit # Auto-deploy on each commit to main

  ##############################################################################
  # Cache - Redis for Session Management
  ##############################################################################
  - type: redis
    name: legal-platform-redis
    plan: pro # 1GB Redis
    region: oregon # US West
    maxmemoryPolicy: allkeys-lru # LRU eviction when memory limit reached
    ipAllowList: [] # Empty = allow all Render services

  ##############################################################################
  # Legacy Document Import App (Story 3.2.5)
  # Standalone app for PST import and document categorization
  ##############################################################################
  - type: web
    name: bojin-legacy-import
    runtime: node
    repo: https://github.com/stoianovici/bojin-law-2.git
    branch: main
    buildCommand: npm install -g pnpm && pnpm install --frozen-lockfile && pnpm --filter @legal-platform/database build && cd apps/legacy-import && npx prisma generate --schema=../../packages/database/prisma/schema.prisma && cd ../.. && pnpm --filter @legal-platform/legacy-import build
    startCommand: pnpm --filter @legal-platform/legacy-import start -- -p $PORT
    plan: starter # 512MB RAM - upgrade for large PST processing
    numInstances: 1
    region: oregon # Same region as other services
    envVars:
      # Node Environment
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: '22'

      # App URL - Update after first deploy with actual URL
      - key: NEXT_PUBLIC_APP_URL
        value: https://bojin-legacy-import.onrender.com

      # Database (same as main app)
      - key: DATABASE_URL
        fromDatabase:
          name: legal-platform-db
          property: connectionString

      # Redis
      - key: REDIS_URL
        fromService:
          type: redis
          name: legal-platform-redis
          property: connectionString

      # Azure AD Authentication (set in Render dashboard)
      - key: NEXT_PUBLIC_AZURE_AD_CLIENT_ID
        sync: false
      - key: NEXT_PUBLIC_AZURE_AD_TENANT_ID
        sync: false
      - key: AZURE_AD_CLIENT_SECRET
        sync: false

      # Cloudflare R2 Storage (set in Render dashboard)
      - key: R2_ACCOUNT_ID
        sync: false
      - key: R2_ACCESS_KEY_ID
        sync: false
      - key: R2_SECRET_ACCESS_KEY
        sync: false
      - key: R2_BUCKET_NAME
        value: legacy-import
      - key: R2_ENDPOINT
        sync: false

      # Anthropic AI for document analysis (set in Render dashboard)
      - key: ANTHROPIC_API_KEY
        sync: false

    healthCheckPath: /api/health

##############################################################################
# Database - PostgreSQL with pgvector
##############################################################################
databases:
  - name: legal-platform-db
    databaseName: legal_platform_prod
    user: legal_platform_user
    plan: basic-1gb # 1GB RAM, pay-per-GB storage
    region: oregon # US West
    ipAllowList: [] # Empty = allow all Render services (recommended)

##############################################################################
# Future Services (uncomment when implemented)
##############################################################################
# - Gateway Service (GraphQL API)
# - Document Service (File Processing & Storage)
# - AI Service (Claude + Grok with Semantic Search)
# - Task Service (Background Job Processing)
# - Integration Service (Third-Party APIs)
# - Notification Service (Email, SMS, Push)
#
# See infrastructure/ARCHITECTURE.md for full system design
##############################################################################
