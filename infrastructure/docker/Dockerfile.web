# Production Dockerfile for Next.js Web Application
# Simplified build for pnpm workspaces

# Stage 1: Builder
FROM node:22-alpine AS builder
RUN apk add --no-cache libc6-compat openssl
WORKDIR /app

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

# Copy everything first (pnpm workspaces need all files for symlinks)
COPY . .

# Install all dependencies (creates correct symlinks)
RUN pnpm install --frozen-lockfile --prod=false

# Set dummy DATABASE_URL for Prisma client generation (doesn't connect, just generates types)
ENV DATABASE_URL="postgresql://build:build@localhost:5432/build?schema=public"

# Build workspace packages (all compiled fresh - no pre-built dist in git)
# 1. Types package
RUN pnpm build --filter=@legal-platform/types

# 2. Database package - compile TypeScript fresh (ensures parity with local dev)
# Note: Using tsc --build because composite: true requires project references mode
RUN echo "=== Building database package ===" && \
    cd packages/database && \
    pnpm prisma generate --schema=./prisma/schema.prisma && \
    pnpm exec tsc --build --force && \
    echo "Database package built:" && \
    ls -la dist/ && \
    echo "=== Finding and copying Prisma client ===" && \
    PRISMA_PATH=$(find /app -path "*/.prisma/client" -type d 2>/dev/null | head -1) && \
    echo "Found Prisma at: $PRISMA_PATH" && \
    mkdir -p /app/prisma-client/client && \
    cp -r "$PRISMA_PATH"/* /app/prisma-client/client/ && \
    echo "Contents of /app/prisma-client/client:" && \
    ls -la /app/prisma-client/client/ && \
    echo "=== Finding and copying @prisma/client package ===" && \
    PRISMA_NODE_MODULES=$(dirname $(dirname "$PRISMA_PATH")) && \
    PRISMA_CLIENT_PATH="$PRISMA_NODE_MODULES/@prisma/client" && \
    echo "Found @prisma/client at: $PRISMA_CLIENT_PATH" && \
    ls -la "$PRISMA_CLIENT_PATH" && \
    mkdir -p /app/prisma-client-pkg/client && \
    cp -r "$PRISMA_CLIENT_PATH"/* /app/prisma-client-pkg/client/ && \
    echo "Contents of /app/prisma-client-pkg/client:" && \
    ls -la /app/prisma-client-pkg/client/ && \
    echo "=== Database package setup complete ===" && \
    echo "=== Installing ioredis with all transitive dependencies ===" && \
    mkdir -p /app/ioredis-install && \
    cd /app/ioredis-install && \
    echo '{"dependencies":{"ioredis":"5.4.1"}}' > package.json && \
    npm install --omit=dev && \
    echo "Installed ioredis dependencies:" && \
    ls -la node_modules/

# 3. UI package
RUN pnpm build --filter=@legal-platform/ui

# Fix pnpm symlink issue: remove symlink and copy actual files
# This ensures the externalized module can be resolved during Next.js static page generation
RUN echo "=== Fixing database module resolution ===" && \
    rm -rf apps/web/node_modules/@legal-platform/database && \
    mkdir -p apps/web/node_modules/@legal-platform/database && \
    cp -r packages/database/dist apps/web/node_modules/@legal-platform/database/ && \
    cp packages/database/package.json apps/web/node_modules/@legal-platform/database/ && \
    echo "Database package copied. Contents:" && \
    ls -la apps/web/node_modules/@legal-platform/database/dist/

# Set environment variables directly for build (only NEXT_PUBLIC_* vars are embedded)
# These are public values (not secrets) - client IDs are safe to expose in the bundle
ENV NEXT_PUBLIC_APP_URL=https://app.bojin-law.com
ENV NEXT_PUBLIC_AZURE_AD_CLIENT_ID=0ac0c3a6-6482-4ff4-81a6-c2f96c506cfd
ENV NEXT_PUBLIC_AZURE_AD_TENANT_ID=e39d7b1e-9d0c-41ae-b1db-99aecc04fa42

# Build Next.js app with webpack (not Turbopack) for workspace package support
ENV NODE_ENV=production
ENV NODE_OPTIONS="--max-old-space-size=2048"
RUN cd apps/web && pnpm next build --webpack

# Stage 2: Production runner
FROM node:22-alpine AS runner
WORKDIR /app

# Install OpenSSL for Prisma runtime
RUN apk add --no-cache openssl

ENV NODE_ENV=production

# Note: Prisma CLI is copied from builder stage below

# Create non-root user
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# Copy built application
COPY --from=builder /app/apps/web/public ./apps/web/public
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/static ./apps/web/.next/static

# Copy workspace database package (externalized, needed at runtime)
COPY --from=builder --chown=nextjs:nodejs /app/packages/database/dist ./packages/database/dist
COPY --from=builder --chown=nextjs:nodejs /app/packages/database/package.json ./packages/database/package.json
COPY --from=builder --chown=nextjs:nodejs /app/packages/database/prisma ./packages/database/prisma

# Copy Prisma client from builder stage to multiple possible locations
# Next.js with pnpm may look for the engine in different paths depending on bundling
COPY --from=builder --chown=nextjs:nodejs /app/prisma-client/client ./node_modules/.prisma/client
COPY --from=builder --chown=nextjs:nodejs /app/prisma-client/client ./apps/web/.prisma/client
COPY --from=builder --chown=nextjs:nodejs /app/prisma-client/client ./apps/web/.next/server/.prisma/client

# Copy @prisma/client package (the entry point that re-exports from .prisma/client)
COPY --from=builder --chown=nextjs:nodejs /app/prisma-client-pkg/client/ ./node_modules/@prisma/client/

# Install Prisma CLI for migrations
RUN npm install -g prisma@5.8.0

# Copy ioredis with all transitive dependencies from builder (needed by @legal-platform/database redis exports)
COPY --from=builder --chown=nextjs:nodejs /app/ioredis-install/node_modules/ ./node_modules/

# Re-copy Prisma after ioredis (in case it was overwritten)
COPY --from=builder --chown=nextjs:nodejs /app/prisma-client/client ./node_modules/.prisma/client
COPY --from=builder --chown=nextjs:nodejs /app/prisma-client-pkg/client/ ./node_modules/@prisma/client/

# Create symlink for workspace package resolution
RUN mkdir -p node_modules/@legal-platform && \
    ln -sf /app/packages/database node_modules/@legal-platform/database

# Copy Prisma engine to all possible locations that Next.js/pnpm might look
RUN mkdir -p "node_modules/.pnpm/@prisma+client@5.22.0_prisma@5.22.0/node_modules/.prisma/client" && \
    cp -r node_modules/.prisma/client/* "node_modules/.pnpm/@prisma+client@5.22.0_prisma@5.22.0/node_modules/.prisma/client/" && \
    mkdir -p "node_modules/.pnpm/@prisma+client@5.22.0_prisma@5.22.0/node_modules/@prisma/client" && \
    cp -r node_modules/@prisma/client/* "node_modules/.pnpm/@prisma+client@5.22.0_prisma@5.22.0/node_modules/@prisma/client/"

# Create startup script that runs migrations then starts the app
RUN echo '#!/bin/sh' > /app/start.sh && \
    echo 'echo "Running database migrations..."' >> /app/start.sh && \
    echo 'prisma migrate deploy --schema=/app/packages/database/prisma/schema.prisma || echo "Migration failed, continuing anyway..."' >> /app/start.sh && \
    echo 'echo "Starting Next.js server..."' >> /app/start.sh && \
    echo 'exec node apps/web/server.js' >> /app/start.sh && \
    chmod +x /app/start.sh

USER nextjs

EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
  CMD node -e "require('http').get('http://localhost:' + (process.env.PORT || 3000) + '/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

CMD ["/app/start.sh"]
