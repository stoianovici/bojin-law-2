# Story 2.4 - Next Session Guide

**Last Updated:** 2025-11-20
**Status:** Phase 2 Complete (Backend Auth Infrastructure)
**Next Priority:** Task 7 (User Schema & Migration)

## Quick Start for Next Session

### What's Been Completed âœ…

1. **Azure AD Configuration** - Documented (needs manual setup by admin)
2. **MSAL Node Setup** - Complete with tests (17/17 passing)
3. **OAuth 2.0 Flow** - Complete with tests (20/20 passing)
4. **JWT Token Management** - Complete (tests pending)

**Total Tests Passing:** 37/37 âœ…

### What You Need to Do Next ğŸ¯

#### CRITICAL: Task 7 - User Schema & Migration (START HERE)

**Location:** `packages/database/prisma/schema.prisma`

**Add this model:**
```prisma
model User {
  id            String          @id @default(uuid())
  firmId        String?         @map("firm_id")
  email         String          @unique @db.VarChar(255)
  firstName     String          @map("first_name") @db.VarChar(100)
  lastName      String          @map("last_name") @db.VarChar(100)
  role          UserRole        @default(Paralegal)
  status        UserStatus      @default(Pending)
  azureAdId     String          @unique @map("azure_ad_id") @db.VarChar(255)
  preferences   Json            @default("{}")
  createdAt     DateTime        @default(now()) @map("created_at") @db.Timestamptz
  lastActive    DateTime        @default(now()) @map("last_active") @db.Timestamptz

  @@map("users")
}

enum UserRole {
  Partner
  Associate
  Paralegal
}

enum UserStatus {
  Pending
  Active
  Inactive
}
```

**Then run:**
```bash
cd packages/database
npx prisma migrate dev --name add_users_table
npx prisma generate
```

**Update seed data:** `packages/database/prisma/seed.ts`

---

#### Task 8 - User Provisioning Service

**Create:** `services/gateway/src/services/user.service.ts`

**Key Methods:**
- `findOrCreateUser(azureAdId, email, firstName, lastName)`
  - Check if user exists by azureAdId
  - If not, create with status='Pending', role='Paralegal', firmId=null
  - If exists, update lastActive timestamp
  - Return user object

**Update:** `services/gateway/src/routes/auth.routes.ts`
- In `/auth/callback` endpoint, call user service after token exchange
- Create user or get existing user
- Check user status (Task 9)
- Generate JWT tokens (already implemented)
- Create session (Task 11)

---

#### Task 9 - User Status Validation

**In:** `services/gateway/src/routes/auth.routes.ts`

**After user provisioning:**
```typescript
if (user.status === 'Pending') {
  return res.status(403).json({
    error: 'account_pending',
    message: 'Your account is pending activation. Please contact your firm\'s partner for access.',
  });
}

if (user.status === 'Inactive') {
  return res.status(403).json({
    error: 'account_inactive',
    message: 'Your account has been deactivated. Please contact your firm\'s partner.',
  });
}
```

---

## Files You'll Be Working With

### Already Created (Reference These)
```
services/gateway/src/
â”œâ”€â”€ config/auth.config.ts          â† Azure AD & MSAL config
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ auth.service.ts            â† OAuth flow (complete)
â”‚   â””â”€â”€ jwt.service.ts             â† JWT tokens (complete)
â”œâ”€â”€ middleware/auth.middleware.ts  â† JWT validation (complete)
â”œâ”€â”€ routes/auth.routes.ts          â† Auth endpoints (needs updates)
â””â”€â”€ types/auth.types.ts            â† TypeScript types (complete)
```

### Need to Create
```
services/gateway/src/
â””â”€â”€ services/
    â””â”€â”€ user.service.ts            â† CREATE THIS (Task 8)

packages/database/
â””â”€â”€ prisma/
    â”œâ”€â”€ schema.prisma              â† UPDATE THIS (Task 7)
    â””â”€â”€ seed.ts                    â† UPDATE THIS (Task 7)
```

---

## Testing Commands

**Run all gateway tests:**
```bash
cd services/gateway
pnpm test
```

**Run specific test:**
```bash
cd services/gateway
pnpm test auth.service.test.ts
```

**Run database migration:**
```bash
cd packages/database
npx prisma migrate dev --name add_users_table
```

**Generate Prisma Client:**
```bash
cd packages/database
npx prisma generate
```

---

## Environment Variables Needed

**Already in `.env`:**
- DATABASE_URL
- REDIS_URL

**Need to Add (before testing):**
```bash
# Azure AD (get from admin after app registration)
AZURE_AD_CLIENT_ID=<guid>
AZURE_AD_CLIENT_SECRET=<secret>
AZURE_AD_TENANT_ID=<guid>
AZURE_AD_REDIRECT_URI=http://localhost:3000/auth/callback

# JWT (generate random strings)
JWT_SECRET=<min-32-chars-random-string>
JWT_ISSUER=http://localhost:3000
JWT_AUDIENCE=bojin-law-api

# Session
SESSION_SECRET=<random-string>
SESSION_MAX_AGE=604800000
```

---

## Dependency Chain (Critical Path)

```
Task 7 (User Schema)
  â†“
Task 8 (User Provisioning)
  â†“
Task 9 (User Status Validation)
  â†“
Task 10 (Redis Session Config)
  â†“
Task 11 (Session Storage)
  â†“
Tasks 12-14 (Token Refresh, Logout, Cleanup)
  â†“
Tasks 15-18 (Frontend)
  â†“
Tasks 19-21 (Testing & Docs)
```

**You must complete Task 7 before anything else!**

---

## Common Issues & Solutions

### Issue: Prisma not generating types
**Solution:** Run `npx prisma generate` after schema changes

### Issue: Tests can't find @legal-platform/database
**Solution:** Run `pnpm install` from root directory

### Issue: MSAL errors about environment variables
**Solution:** Set all AZURE_AD_* env vars, even for testing (use dummy values)

### Issue: JWT_SECRET too short
**Solution:** Must be minimum 32 characters

---

## Architecture Decisions Made

1. **PKCE with SHA-256** - More secure than plain text
2. **Tokens in httpOnly cookies** - Prevents XSS attacks
3. **7-day session TTL** - Matches refresh token lifetime
4. **HS256 JWT signing** - Sufficient for internal API
5. **Composable middleware** - Flexible auth + role + status checks

---

## What Works Right Now

âœ… OAuth login flow initiation
âœ… PKCE generation and validation
âœ… Azure AD authorization URL creation
âœ… OAuth callback parameter validation
âœ… Token exchange (MSAL)
âœ… User profile extraction from ID token
âœ… JWT access token generation
âœ… JWT refresh token generation
âœ… JWT validation middleware
âœ… Role-based authorization middleware
âœ… Active user requirement middleware

## What Doesn't Work Yet

âŒ User creation/retrieval from database (no User model)
âŒ User status validation (no User model)
âŒ Session storage in Redis (waiting for user data)
âŒ Complete OAuth callback endpoint (needs user provisioning)
âŒ Token refresh endpoint (needs session storage)
âŒ Logout endpoint (needs session storage)
âŒ Frontend integration (no login page yet)

---

## Estimated Time to Complete

- **Tasks 7-9 (User provisioning):** 2-3 hours
- **Tasks 10-14 (Session management):** 2-3 hours
- **Tasks 15-18 (Frontend):** 2-3 hours
- **Tasks 19-21 (Testing & docs):** 2-3 hours

**Total remaining:** ~8-12 hours for full story completion

---

## Quick Reference - File Locations

**Gateway Service:**
- Config: `services/gateway/src/config/`
- Services: `services/gateway/src/services/`
- Routes: `services/gateway/src/routes/`
- Middleware: `services/gateway/src/middleware/`
- Types: `services/gateway/src/types/`
- Tests: `services/gateway/__tests__/`

**Database:**
- Schema: `packages/database/prisma/schema.prisma`
- Migrations: `packages/database/prisma/migrations/`
- Seed: `packages/database/prisma/seed.ts`
- Client: `packages/database/src/client.ts`
- Redis: `packages/database/src/redis.ts`

**Frontend (when ready):**
- Auth Context: `apps/web/src/contexts/AuthContext.tsx`
- Login Page: `apps/web/src/app/login/page.tsx`
- Callback: `apps/web/src/app/auth/callback/page.tsx`

---

## Questions? Check These

1. **Full story details:** `docs/stories/2.4.story.md`
2. **Architecture docs:** `docs/architecture/`
3. **Coding standards:** `docs/architecture/coding-standards.md`
4. **Tech stack:** `docs/architecture/tech-stack.md`

---

**Good luck! Start with Task 7 (User Schema) and work sequentially through Tasks 8-9. The foundation is solid - you're just connecting the pieces now.**
