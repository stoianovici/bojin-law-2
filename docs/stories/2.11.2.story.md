# Story 2.11.2: Retainer Billing Support

## Status

Done

## Story

**As a** Partner,
**I want** to configure cases with Retainer billing type,
**so that** I can track retainer usage, remaining balance, and historical utilization for clients on retainer agreements.

## Background

The current billing system (Story 2.8.1) supports Hourly and Fixed billing types. This story adds Retainer as a third billing type, enabling firms to manage monthly/quarterly retainer agreements with usage tracking.

### Current State

- BillingType enum: `Hourly`, `Fixed`
- No retainer configuration on Case model
- No retainer usage tracking

### Target State

- BillingType enum: `Hourly`, `Fixed`, `Retainer`
- Cases can have retainer configuration (amount, period, rollover, auto-renewal)
- Retainer usage tracked per period
- Remaining balance calculated and displayed

## Acceptance Criteria

1. `Retainer` added to BillingType enum in database and GraphQL schema
2. Retainer configuration fields added to Case model: `retainerAmount`, `retainerPeriod`, `retainerRollover`, `retainerAutoRenew`
3. `RetainerPeriod` enum created: `Monthly`, `Quarterly`, `Annually`
4. `RetainerPeriodUsage` model created to track usage per period
5. Retainer usage shows: current period usage, included hours, remaining balance, rollover
6. GraphQL queries available for retainer usage (by case, by period)
7. Retainer data protected by `@requiresFinancialAccess` directive
8. Retainer calculations handle rollover amounts correctly
9. Unit tests cover retainer calculations and edge cases

## Tasks / Subtasks

### Phase 1: Database Schema (AC: 1-4)

- [x] **Task 1: Add Retainer to BillingType Enum** (AC: 1)
  - [x] Update Prisma schema: Add `Retainer` to BillingType enum
  - [x] Update GraphQL schema: Add `RETAINER` to BillingType enum
  - [x] Create migration
  - [x] Location: `packages/database/prisma/schema.prisma`, `services/gateway/src/graphql/schema/enums.graphql`

- [x] **Task 2: Create RetainerPeriod Enum** (AC: 3)
  - [x] Add `RetainerPeriod` enum to Prisma schema: `Monthly`, `Quarterly`, `Annually`
  - [x] Add `RetainerPeriod` enum to GraphQL schema
  - [x] Location: `packages/database/prisma/schema.prisma`, `services/gateway/src/graphql/schema/enums.graphql`

- [x] **Task 3: Add Retainer Fields to Case Model** (AC: 2)
  - [x] Add fields to Prisma Case model:
    ```prisma
    retainerAmount    Decimal?       @map("retainer_amount") @db.Decimal(15, 2)
    retainerPeriod    RetainerPeriod? @map("retainer_period")
    retainerRollover  Boolean        @default(false) @map("retainer_rollover")
    retainerAutoRenew Boolean        @default(false) @map("retainer_auto_renew")
    ```
  - [x] Create migration
  - [x] Location: `packages/database/prisma/schema.prisma`

- [x] **Task 4: Create RetainerPeriodUsage Model** (AC: 4)
  - [x] Create model:

    ```prisma
    model RetainerPeriodUsage {
      id            String   @id @default(uuid())
      caseId        String   @map("case_id")
      firmId        String   @map("firm_id")
      periodStart   DateTime @map("period_start") @db.Date
      periodEnd     DateTime @map("period_end") @db.Date
      hoursUsed     Decimal  @map("hours_used") @db.Decimal(10, 2) @default(0)
      hoursIncluded Decimal  @map("hours_included") @db.Decimal(10, 2)
      rolledOver    Decimal  @map("rolled_over") @db.Decimal(10, 2) @default(0)
      createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
      updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

      case          Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
      firm          Firm     @relation(fields: [firmId], references: [id], onDelete: Restrict)

      @@unique([caseId, periodStart])
      @@index([caseId])
      @@index([firmId])
      @@index([periodStart])
      @@map("retainer_period_usage")
    }
    ```

  - [x] Add relation to Case model: `retainerUsage RetainerPeriodUsage[]`
  - [x] Add relation to Firm model: `retainerUsage RetainerPeriodUsage[]`
  - [x] Create migration
  - [x] Location: `packages/database/prisma/schema.prisma`

### Phase 2: Shared Types (AC: 2-5)

- [x] **Task 5: Add Retainer Types** (AC: 2-5)
  - [x] Add `RetainerPeriod` type: `'Monthly' | 'Quarterly' | 'Annually'`
  - [x] Add `RetainerConfig` interface with retainer fields
  - [x] Add `RetainerUsage` interface for usage tracking
  - [x] Update `BillingType` to include `'Retainer'`
  - [x] Export from index
  - [x] Location: `packages/shared/types/src/entities.ts`, `packages/shared/types/src/financial.ts`

### Phase 3: GraphQL Schema & Resolvers (AC: 5-7)

- [x] **Task 6: Add Retainer Fields to Case Type** (AC: 5, 7)
  - [x] Add retainer fields to Case type in GraphQL schema:
    ```graphql
    type Case {
      # ... existing fields
      retainerAmount: Float @requiresFinancialAccess
      retainerPeriod: RetainerPeriod @requiresFinancialAccess
      retainerRollover: Boolean @requiresFinancialAccess
      retainerAutoRenew: Boolean @requiresFinancialAccess
      currentRetainerUsage: RetainerUsage @requiresFinancialAccess
    }
    ```
  - [x] Location: `services/gateway/src/graphql/schema/case.graphql`

- [x] **Task 7: Create RetainerUsage Type and Queries** (AC: 5-6)
  - [x] Define RetainerUsage type:
    ```graphql
    type RetainerUsage {
      periodStart: DateTime!
      periodEnd: DateTime!
      hoursUsed: Float!
      hoursIncluded: Float!
      rolledOver: Float!
      remaining: Float!
      utilizationPercent: Float!
    }
    ```
  - [x] Add query: `retainerUsage(caseId: UUID!, periodStart: DateTime): RetainerUsage`
  - [x] Add query: `retainerUsageHistory(caseId: UUID!, limit: Int): [RetainerUsage!]!`
  - [x] Location: `services/gateway/src/graphql/schema/case.graphql`

- [x] **Task 8: Create Retainer Service** (AC: 5, 8)
  - [x] Create `RetainerService` class with methods:
    - `getRetainerPeriodDates(period: RetainerPeriod, date: Date)` - returns { start, end }
    - `calculateCurrentUsage(caseId: string, context: Context)` - returns RetainerUsage
    - `calculateRollover(caseId: string, periodStart: Date)` - returns rollover amount
    - `getIncludedHours(retainerAmount: number, effectiveRate: number)` - returns hours
  - [x] Handle edge cases: no time entries, zero rates, period transitions
  - [x] Location: `services/gateway/src/services/retainer.service.ts`

- [x] **Task 9: Implement Retainer Resolvers** (AC: 5-7)
  - [x] Implement `Case.currentRetainerUsage` field resolver
  - [x] Implement `retainerUsage` query resolver
  - [x] Implement `retainerUsageHistory` query resolver
  - [x] Apply `@requiresFinancialAccess` directive
  - [x] Apply data scope filter from Story 2.11.1
  - [x] Location: `services/gateway/src/graphql/resolvers/case.resolvers.ts`

### Phase 4: Frontend Hooks (AC: 5-6)

- [x] **Task 10: Create Retainer Hooks** (AC: 5-6)
  - [x] Create `useRetainerUsage(caseId)` hook
  - [x] Create `useRetainerHistory(caseId, limit)` hook
  - [x] Handle loading, error states
  - [x] Location: `apps/web/src/hooks/useRetainerUsage.ts`

### Phase 5: Testing (AC: 9)

- [x] **Task 11: Backend Unit Tests** (AC: 9)
  - [x] Test RetainerService.getRetainerPeriodDates for all periods
  - [x] Test RetainerService.calculateCurrentUsage
  - [x] Test RetainerService.calculateRollover with various scenarios
  - [x] Test edge cases: no time entries, zero rates, mid-period
  - [x] Location: `services/gateway/src/services/retainer.service.test.ts`

- [x] **Task 12: Resolver Tests** (AC: 9)
  - [x] Test retainerUsage query with Partner (sees own cases)
  - [x] Test retainerUsage query with BusinessOwner (sees all cases)
  - [x] Test @requiresFinancialAccess enforcement
  - [x] Location: `services/gateway/__tests__/resolvers/retainer.resolvers.test.ts`

## Dev Notes

### Dependencies

**Depends on:**

- Story 2.11.1: Business Owner Role & Data Scope (provides `getFinancialDataFilter`)
- Story 2.8.1: Billing & Rate Management (provides billing infrastructure)
- Story 2.6: Case Management Data Model (provides Case, TimeEntry models)

[Source: Project story dependencies]

### Retainer Period Calculation

```typescript
// services/gateway/src/services/retainer.service.ts

function getRetainerPeriodDates(
  period: RetainerPeriod,
  referenceDate: Date = new Date()
): { start: Date; end: Date } {
  const start = new Date(referenceDate);
  const end = new Date(referenceDate);

  switch (period) {
    case 'Monthly':
      start.setDate(1);
      end.setMonth(end.getMonth() + 1);
      end.setDate(0); // Last day of current month
      break;
    case 'Quarterly':
      const quarter = Math.floor(start.getMonth() / 3);
      start.setMonth(quarter * 3, 1);
      end.setMonth((quarter + 1) * 3, 0);
      break;
    case 'Annually':
      start.setMonth(0, 1);
      end.setMonth(11, 31);
      break;
  }

  return { start, end };
}

function calculateRetainerUsage(
  case_: Case,
  timeEntries: TimeEntry[],
  previousRollover: number
): RetainerUsage {
  const { start, end } = getRetainerPeriodDates(case_.retainerPeriod);

  // Sum hours from time entries in current period
  const hoursUsed = timeEntries
    .filter((te) => te.date >= start && te.date <= end)
    .reduce((sum, te) => sum + te.hours, 0);

  // Calculate included hours from retainer amount
  const effectiveRate = case_.customRates?.partnerRate || firm.defaultRates.partnerRate;
  const hoursIncluded = case_.retainerAmount / effectiveRate;

  // Calculate rollover (only if enabled)
  const rolledOver = case_.retainerRollover ? previousRollover : 0;

  const totalAvailable = hoursIncluded + rolledOver;
  const remaining = totalAvailable - hoursUsed;
  const utilizationPercent = (hoursUsed / totalAvailable) * 100;

  return {
    periodStart: start,
    periodEnd: end,
    hoursUsed,
    hoursIncluded,
    rolledOver,
    remaining,
    utilizationPercent,
  };
}
```

### Existing Models (from Schema)

**TimeEntry Model:**

```prisma
model TimeEntry {
  id          String   @id @default(uuid())
  caseId      String   @map("case_id")
  userId      String   @map("user_id")
  date        DateTime @db.Date
  hours       Decimal  @db.Decimal(5, 2)
  hourlyRate  Decimal  @map("hourly_rate") @db.Decimal(15, 2)
  billable    Boolean  @default(true)
  firmId      String   @map("firm_id")
}
```

**Current BillingType Enum:**

```prisma
enum BillingType {
  Hourly
  Fixed
  // NEW: Retainer - to be added by this story
}
```

[Source: packages/database/prisma/schema.prisma]

### Project Structure Alignment

| Component Type  | Location Pattern                                        |
| --------------- | ------------------------------------------------------- |
| Database Schema | `packages/database/prisma/schema.prisma`                |
| GraphQL Schema  | `services/gateway/src/graphql/schema/*.graphql`         |
| Services        | `services/gateway/src/services/*.service.ts`            |
| Resolvers       | `services/gateway/src/graphql/resolvers/*.resolvers.ts` |
| Frontend Hooks  | `apps/web/src/hooks/*.ts`                               |
| Shared Types    | `packages/shared/types/src/*.ts`                        |

[Source: docs/architecture/unified-project-structure.md]

### Edge Cases to Handle

1. **No time entries**: Return usage with `hoursUsed: 0`
2. **Zero effective rate**: Return null or error (cannot calculate hours)
3. **Mid-period queries**: Always use current period boundaries
4. **Rollover disabled**: `rolledOver` should be 0
5. **New period without previous usage record**: Create new record with rollover from previous

## Testing

### Unit Tests

- **Framework**: Jest 29+
- **Location**: `services/gateway/src/services/retainer.service.test.ts`
- **Coverage Target**: 80%
- **Key Test Cases**:
  - Period date calculations for Monthly/Quarterly/Annually
  - Usage calculation with various time entry scenarios
  - Rollover calculation with/without rollover enabled
  - Edge cases: no entries, zero rates, period boundaries

### Integration Tests

- **Location**: `services/gateway/__tests__/resolvers/retainer.resolvers.test.ts`
- **Key Flows**:
  - Partner queries retainer usage for managed case
  - BusinessOwner queries retainer usage for any firm case
  - Non-financial users get null for retainer fields

[Source: docs/architecture/testing-strategy.md]

## Security Considerations

- All retainer data protected by `@requiresFinancialAccess` directive
- Data scope filter applied (Partner sees managed cases, BusinessOwner sees all)
- Firm isolation enforced via `firmId` filter

## File List

### Modified Files

| File                                                       | Changes                                                                                                                       |
| ---------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------- |
| `packages/database/prisma/schema.prisma`                   | Added `Retainer` to BillingType enum, `RetainerPeriod` enum, retainer fields to Case model, `RetainerPeriodUsage` model       |
| `services/gateway/src/graphql/schema/enums.graphql`        | Added `Retainer` to BillingType enum, added `RetainerPeriod` enum                                                             |
| `services/gateway/src/graphql/schema/case.graphql`         | Added retainer fields to Case type, `RetainerUsage` type, `retainerUsage` and `retainerUsageHistory` queries                  |
| `packages/shared/types/src/entities.ts`                    | Added `RetainerPeriod` type, updated `BillingType`, added `RetainerConfig`, `RetainerUsage`, `RetainerPeriodUsage` interfaces |
| `packages/shared/types/src/financial.ts`                   | Added retainer financial field enums and metadata                                                                             |
| `services/gateway/src/graphql/resolvers/case.resolvers.ts` | Added `retainerUsage`, `retainerUsageHistory` query resolvers and `currentRetainerUsage` field resolver                       |

### New Files

| File                                                                                            | Description                                                                  |
| ----------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------- |
| `packages/database/prisma/migrations/20251126084144_add_retainer_billing_support/migration.sql` | Database migration for retainer billing support                              |
| `services/gateway/src/services/retainer.service.ts`                                             | RetainerService with period calculations, usage tracking, and rollover logic |
| `services/gateway/src/services/retainer.service.test.ts`                                        | Unit tests for RetainerService (26 tests)                                    |
| `apps/web/src/hooks/useRetainerUsage.ts`                                                        | React hooks for retainer usage queries                                       |
| `services/gateway/__tests__/resolvers/retainer.resolvers.test.ts`                               | Resolver tests for authorization and data access (31 tests)                  |

## Change Log

| Date       | Version | Description                      | Author             |
| ---------- | ------- | -------------------------------- | ------------------ |
| 2025-11-26 | 1.0     | Story split from original 2.11.1 | Bob (Scrum Master) |
| 2025-11-26 | 1.1     | Implementation complete          | James (Dev)        |

## QA Results

### Review Date: 2025-11-26

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**Review Depth: Deep** (Auto-escalated due to: financial data handling, 9 acceptance criteria)

This story involves sensitive billing/financial data and impacts the retainer billing workflow. Deep review required.

### Code Quality Assessment

The implementation is **well-structured and production-ready**. Key observations:

1. **RetainerService (`services/gateway/src/services/retainer.service.ts`)**: Clean, well-documented service with clear separation of concerns. Period date calculations are correctly implemented for Monthly, Quarterly, and Annually periods. Edge cases for leap years and month boundaries are handled correctly.

2. **Database Schema**: The migration adds `Retainer` to BillingType enum, creates `RetainerPeriod` enum, adds retainer fields to Case model, and creates `RetainerPeriodUsage` table with appropriate indexes and foreign keys.

3. **GraphQL Schema & Resolvers**: Retainer fields added to Case type with `@requiresFinancialAccess` directive. Queries for `retainerUsage` and `retainerUsageHistory` properly check for Partner/BusinessOwner roles.

4. **Shared Types**: `RetainerPeriod`, `RetainerConfig`, `RetainerUsage`, and `RetainerPeriodUsage` interfaces correctly defined in `entities.ts`. Financial field enums updated in `financial.ts`.

5. **Frontend Hooks**: `useRetainerUsage` and `useRetainerHistory` hooks properly implemented with loading/error states and skip logic.

### Requirements Traceability

| AC  | Description                          | Test Coverage                                               | Status    |
| --- | ------------------------------------ | ----------------------------------------------------------- | --------- |
| 1   | `Retainer` added to BillingType enum | `migration.sql` enum alteration, `enums.graphql`            | ✓ Covered |
| 2   | Retainer config fields on Case model | Schema has all fields, `retainer.service.test.ts` validates | ✓ Covered |
| 3   | `RetainerPeriod` enum created        | Prisma schema, GraphQL enum, TypeScript type                | ✓ Covered |
| 4   | `RetainerPeriodUsage` model created  | Prisma schema with proper relations and indexes             | ✓ Covered |
| 5   | Retainer usage display data          | `calculateCurrentUsage`, `getUsageForPeriod` methods tested | ✓ Covered |
| 6   | GraphQL queries for retainer usage   | `retainerUsage`, `retainerUsageHistory` queries + tests     | ✓ Covered |
| 7   | `@requiresFinancialAccess` directive | Resolver tests verify Partner/BusinessOwner access          | ✓ Covered |
| 8   | Rollover calculations                | `calculateRollover` with 4 test scenarios                   | ✓ Covered |
| 9   | Unit tests for calculations          | 26 unit tests + 31 resolver tests                           | ✓ Covered |

### Test Architecture Assessment

**Unit Tests (`retainer.service.test.ts`):**

- 26 tests covering period date calculations, included hours calculation, rollover logic, usage calculation, and history retrieval
- Good coverage of edge cases: leap years, zero rates, negative rollover prevention, empty time entries
- Proper mocking of Prisma client

**Resolver Tests (`retainer.resolvers.test.ts`):**

- 31 tests covering authorization, firm isolation, and multi-tenancy security
- Tests for Partner, BusinessOwner, Associate, Paralegal roles
- Proper testing of @requiresFinancialAccess enforcement
- Multi-tenancy isolation tests verify Partner from Firm A cannot access Firm B data

**Test Coverage Summary:**

- Service layer: Comprehensive (period calculations, usage calculations, rollover logic)
- Authorization: Comprehensive (all role combinations tested)
- Multi-tenancy: Comprehensive (firm isolation enforced and tested)

### Compliance Check

- Coding Standards: ✓ Code follows established patterns, proper TypeScript typing
- Project Structure: ✓ Files in correct locations per `unified-project-structure.md`
- Testing Strategy: ✓ Unit + resolver tests, proper mocking
- All ACs Met: ✓ All 9 acceptance criteria implemented and tested

### Security Review

**PASS** - No security concerns identified.

1. **Authorization**: All retainer endpoints require Partner or BusinessOwner role
2. **Multi-tenancy**: Firm isolation enforced via `firmId` filter in all queries
3. **Data Protection**: Retainer fields protected by `@requiresFinancialAccess` directive
4. **Input Validation**: Effective rate validation (zero/negative rate handling)

### Performance Considerations

**PASS** - No significant performance concerns.

1. **Database Indexes**: Appropriate indexes on `retainer_period_usage` table:
   - `case_id` index for case lookups
   - `firm_id` index for firm isolation
   - `period_start` index for period queries
   - Composite unique index on `(case_id, period_start)`

2. **Query Efficiency**: `aggregate` used for summing time entries (efficient database-side calculation)

3. **Limit Enforcement**: `retainerUsageHistory` capped at 100 periods to prevent unbounded queries

### Refactoring Performed

None required. The implementation is clean and well-structured.

### Improvements Checklist

- [x] Database schema with proper migrations
- [x] GraphQL schema with financial access protection
- [x] Service layer with comprehensive business logic
- [x] Unit tests for all service methods
- [x] Resolver tests for authorization
- [x] Frontend hooks for data fetching
- [x] Shared types updated

**Optional Future Improvements (not blocking):**

- [ ] Consider adding integration tests for end-to-end retainer workflows
- [ ] Consider adding a scheduled job to snapshot period usage at period boundaries

### Files Modified During Review

None - no refactoring was necessary.

### Gate Status

Gate: **PASS** → docs/qa/gates/2.11.2-retainer-billing-support.yml

### Recommended Status

**✓ Ready for Done**

All acceptance criteria are met, tests are comprehensive, security is properly enforced, and the implementation follows established patterns. The story is ready for final approval.
