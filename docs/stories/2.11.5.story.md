# Story 2.11.5: Financial Dashboard Testing

## Status

Ready for development

## Story

**As a** QA Engineer,
**I want** comprehensive test coverage for the financial dashboard feature,
**so that** I can ensure the dashboard works correctly across all roles and scenarios before release.

## Background

This story consolidates all testing tasks for Stories 2.11.1-2.11.4. It ensures comprehensive coverage across unit, integration, and E2E tests for the entire Partner Financial Insights Dashboard feature.

### Previous Stories in This Epic

- **2.11.1**: Business Owner Role & Data Scope (12 tasks)
- **2.11.2**: Retainer Billing Support (12 tasks)
- **2.11.3**: Financial KPIs Backend (10 tasks)
- **2.11.4**: Financial Dashboard UI (16 tasks)

### Testing Scope

Each previous story includes inline testing tasks. This story adds:

- Cross-story integration tests
- E2E tests for complete user journeys
- Manual testing checklist
- Performance testing considerations

## Acceptance Criteria

1. Unit test coverage ≥80% for backend services (Stories 2.11.1, 2.11.2, 2.11.3)
2. Unit test coverage ≥70% for frontend components (Story 2.11.4)
3. Integration tests verify data scope filtering works correctly
4. Integration tests verify retainer calculations across periods
5. E2E test covers Partner → Analytics → View KPIs journey
6. E2E test covers BusinessOwner → Analytics → Firm-wide KPIs journey
7. Manual testing checklist completed for edge cases
8. Performance baseline established for KPI query (<500ms p95)

## Tasks / Subtasks

### Phase 1: Backend Unit Tests (AC: 1)

- [ ] **Task 1: Complete Financial Data Scope Tests** (AC: 1)
  - [ ] Verify tests from Story 2.11.1 Task 10-12 are complete
  - [ ] Add additional edge cases:
    - User with no cases (should return empty dataset)
    - User with 100+ cases (pagination/performance)
    - Cross-firm isolation (cannot see other firm's data)
  - [ ] Run coverage report: target 80%+
  - [ ] Location: `services/gateway/src/graphql/resolvers/utils/financialDataScope.test.ts`

- [ ] **Task 2: Complete Retainer Service Tests** (AC: 1)
  - [ ] Verify tests from Story 2.11.2 Task 11-12 are complete
  - [ ] Add edge cases:
    - Retainer with 0 hours used
    - Retainer with 150% overutilization
    - Period boundary transitions (Dec 31 → Jan 1)
    - Leap year handling for annual retainers
  - [ ] Run coverage report: target 80%+
  - [ ] Location: `services/gateway/src/services/retainer.service.test.ts`

- [ ] **Task 3: Complete KPI Service Tests** (AC: 1)
  - [ ] Verify tests from Story 2.11.3 Task 9-10 are complete
  - [ ] Add edge cases:
    - Zero revenue period
    - All non-billable hours (0% utilization)
    - Mixed billing types in same query
    - Date range spanning multiple years
  - [ ] Test cache behavior: hit, miss, expiry, invalidation
  - [ ] Run coverage report: target 80%+
  - [ ] Location: `services/gateway/src/services/financial-kpis.service.test.ts`

### Phase 2: Frontend Unit Tests (AC: 2)

- [ ] **Task 4: Complete Widget Component Tests** (AC: 2)
  - [ ] Test RevenueOverviewWidget:
    - Renders pie chart with correct data
    - Shows loading skeleton
    - Shows error state with retry
    - Delta badge appears when comparison enabled
  - [ ] Test RevenueTrendWidget:
    - Line chart renders with data points
    - Two lines when comparison enabled
    - Tooltip shows correct values
  - [ ] Test UtilizationWidget:
    - Gauge shows correct percentage
    - Color changes based on thresholds
    - Role breakdown displays correctly
  - [ ] Test ProfitabilityWidget:
    - Top/bottom cases listed
    - Links navigate to case detail
    - Warning icons on negative margin
  - [ ] Test RetainerStatusWidget:
    - Hides when no retainer cases
    - Shows average utilization
    - Color coding works
  - [ ] Location: `apps/web/src/components/analytics/widgets/*.test.tsx`

- [ ] **Task 5: Complete Filter Component Tests** (AC: 2)
  - [ ] Test DateRangePicker:
    - Preset buttons set correct dates
    - Custom range inputs work
    - Validation for invalid ranges (end < start)
  - [ ] Test PeriodComparisonToggle:
    - Toggle state changes
    - Previous period calculated correctly
  - [ ] Test analyticsFiltersStore:
    - Actions update state correctly
    - Selectors return expected values
  - [ ] Location: `apps/web/src/components/analytics/*.test.tsx`, `apps/web/src/stores/analyticsFiltersStore.test.ts`

- [ ] **Task 6: Complete Hook Tests** (AC: 2)
  - [ ] Test useFinancialKPIs:
    - Fetches data on mount
    - Refetches on date range change
    - Returns loading/error states
  - [ ] Test useFinancialKPIsComparison:
    - Fetches both periods
    - Calculates deltas correctly
  - [ ] Test useFinancialDataScope:
    - Returns 'own' for Partner
    - Returns 'firm' for BusinessOwner
    - Returns null for non-financial roles
  - [ ] Run coverage report: target 70%+
  - [ ] Location: `apps/web/src/hooks/*.test.ts`

### Phase 3: Integration Tests (AC: 3-4)

- [ ] **Task 7: Data Scope Integration Tests** (AC: 3)
  - [ ] Create test scenarios:
    - Partner logs in → queries financialKPIs → only sees managed cases
    - BusinessOwner logs in → queries financialKPIs → sees all firm cases
    - Associate logs in → queries financialKPIs → gets null/unauthorized
  - [ ] Verify caseCount matches expected scope
  - [ ] Verify no cross-firm data leakage
  - [ ] Location: `services/gateway/__tests__/integration/financial-data-scope.integration.test.ts`

- [ ] **Task 8: Retainer Calculation Integration Tests** (AC: 4)
  - [ ] Create test scenarios:
    - New retainer case → first period usage starts at 0
    - End of period → rollover calculated if enabled
    - Rollover disabled → no rollover amount
    - Multiple periods → history tracks correctly
  - [ ] Use real database with test data
  - [ ] Location: `services/gateway/__tests__/integration/retainer-calculations.integration.test.ts`

- [ ] **Task 9: Analytics Page Integration Tests** (AC: 3)
  - [ ] Test page renders with mocked GraphQL data
  - [ ] Test date range selection updates all widgets
  - [ ] Test comparison toggle shows delta values
  - [ ] Test data scope indicator matches user role
  - [ ] Use MSW for GraphQL mocking
  - [ ] Location: `apps/web/src/app/analytics/analytics.integration.test.tsx`

### Phase 4: E2E Tests (AC: 5-6)

- [ ] **Task 10: Partner Analytics E2E Test** (AC: 5)
  - [ ] Test flow:
    1. Partner logs in with test credentials
    2. Navigate to /analytics
    3. Verify "My Cases" scope indicator
    4. Verify widgets load with data
    5. Change date range → widgets update
    6. Enable comparison → deltas appear
    7. Click case in profitability widget → navigates to case
  - [ ] Use Playwright
  - [ ] Location: `tests/e2e/analytics/partner-analytics.spec.ts`

- [ ] **Task 11: BusinessOwner Analytics E2E Test** (AC: 6)
  - [ ] Test flow:
    1. BusinessOwner logs in with test credentials
    2. Navigate to /analytics
    3. Verify "Firm-wide" scope indicator
    4. Verify caseCount > Partner's caseCount
    5. Verify retainer widget shows if retainer cases exist
  - [ ] Use Playwright
  - [ ] Location: `tests/e2e/analytics/business-owner-analytics.spec.ts`

- [ ] **Task 12: Authorization E2E Test** (AC: 5-6)
  - [ ] Test flow:
    1. Associate logs in
    2. Navigate to /analytics
    3. Verify access denied or redirect
    4. Verify no financial data visible
  - [ ] Use Playwright
  - [ ] Location: `tests/e2e/analytics/analytics-authorization.spec.ts`

### Phase 5: Manual Testing (AC: 7)

- [ ] **Task 13: Create Manual Testing Checklist** (AC: 7)
  - [ ] Create checklist document with scenarios:

    ```markdown
    ## Manual Testing Checklist - Financial Dashboard

    ### Data Accuracy

    - [ ] Revenue totals match sum of individual cases
    - [ ] Utilization % matches manual calculation
    - [ ] Retainer usage matches time entries for period

    ### Edge Cases

    - [ ] Empty state: new firm with no cases
    - [ ] Zero revenue period: firm with only non-billable time
    - [ ] Large dataset: firm with 500+ cases (performance)
    - [ ] Currency formatting: values > $1,000,000

    ### Responsiveness

    - [ ] Desktop (1920px): 3-column layout
    - [ ] Tablet (768px): 2-column layout
    - [ ] Mobile (375px): single column, touch-friendly

    ### Accessibility

    - [ ] Keyboard navigation works
    - [ ] Screen reader announces widget titles
    - [ ] Color contrast meets WCAG AA
    - [ ] Charts have text alternatives

    ### Cross-Browser

    - [ ] Chrome (latest)
    - [ ] Firefox (latest)
    - [ ] Safari (latest)
    - [ ] Edge (latest)
    ```

  - [ ] Location: `docs/qa/manual-testing/financial-dashboard-checklist.md`

### Phase 6: Performance Testing (AC: 8)

- [ ] **Task 14: Establish Performance Baseline** (AC: 8)
  - [ ] Create performance test script:
    - Query financialKPIs with various date ranges
    - Measure p50, p95, p99 latency
    - Test with 100, 500, 1000 cases
  - [ ] Target: p95 < 500ms for 500 cases
  - [ ] Document baseline in performance.md
  - [ ] Location: `tests/performance/financial-kpis-performance.ts`

- [ ] **Task 15: Cache Effectiveness Test** (AC: 8)
  - [ ] Test scenarios:
    - First request (cache miss) latency
    - Second request (cache hit) latency
    - Request after 5 min (cache expiry)
  - [ ] Verify cache reduces latency by >80%
  - [ ] Location: `tests/performance/kpi-cache-effectiveness.ts`

## Dev Notes

### Dependencies

**Depends on:**

- Story 2.11.1: Must be complete with BusinessOwner role working
- Story 2.11.2: Must be complete with retainer calculations working
- Story 2.11.3: Must be complete with KPI service working
- Story 2.11.4: Must be complete with all widgets implemented

[Source: Project story dependencies]

### Test Data Requirements

**Seed data needed for tests:**

- 1 Firm with:
  - 1 BusinessOwner user
  - 2 Partner users (each managing different cases)
  - 2 Associate users
  - 10+ cases with mixed billing types (Hourly, Fixed, Retainer)
  - 100+ time entries across cases
  - At least 2 retainer cases with usage data

```typescript
// packages/database/prisma/seed.ts additions

// BusinessOwner user
await prisma.user.create({
  data: {
    id: 'business-owner-1',
    email: 'owner@testfirm.com',
    role: 'BusinessOwner',
    firmId: 'test-firm-1',
  },
});

// Ensure variety of billing types
const casesToCreate = [
  { billingType: 'Hourly', count: 5 },
  { billingType: 'Fixed', count: 3 },
  { billingType: 'Retainer', count: 2 },
];
```

### Testing Framework Summary

| Layer         | Framework            | Location                            | Coverage Target |
| ------------- | -------------------- | ----------------------------------- | --------------- |
| Backend Unit  | Jest                 | `services/gateway/src/**/*.test.ts` | 80%             |
| Frontend Unit | Jest + RTL           | `apps/web/src/**/*.test.tsx`        | 70%             |
| Integration   | Jest + Supertest/MSW | `**/*.integration.test.ts`          | Key flows       |
| E2E           | Playwright           | `tests/e2e/**/*.spec.ts`            | Critical paths  |
| Performance   | Custom               | `tests/performance/`                | Baseline        |

[Source: docs/architecture/testing-strategy.md]

### MSW Handler Setup

```typescript
// apps/web/src/test-utils/mocks/handlers.ts

import { graphql } from 'msw';

export const financialKPIHandlers = [
  graphql.query('GetFinancialKPIs', (req, res, ctx) => {
    const { dateRange } = req.variables;
    return res(
      ctx.data({
        financialKPIs: {
          totalRevenue: 150000, // $1,500 in cents
          revenueByBillingType: {
            hourly: 80000,
            fixed: 50000,
            retainer: 20000,
          },
          utilizationRate: 75.5,
          realizationRate: 92.3,
          effectiveHourlyRate: 28500, // $285/hr
          dataScope: 'OWN',
          calculatedAt: new Date().toISOString(),
          caseCount: 12,
          dateRange: {
            start:
              dateRange?.start || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
            end: dateRange?.end || new Date().toISOString(),
          },
        },
      })
    );
  }),
];
```

### Playwright Setup

```typescript
// tests/e2e/analytics/partner-analytics.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Partner Analytics Dashboard', () => {
  test.beforeEach(async ({ page }) => {
    // Login as Partner
    await page.goto('/login');
    await page.fill('[data-testid="email"]', 'partner@testfirm.com');
    await page.fill('[data-testid="password"]', 'testpassword');
    await page.click('[data-testid="login-button"]');
    await page.waitForURL('/');
  });

  test('displays dashboard with correct scope', async ({ page }) => {
    await page.goto('/analytics');

    // Verify scope indicator
    await expect(page.getByTestId('scope-indicator')).toHaveText('My Cases');

    // Verify widgets load
    await expect(page.getByTestId('revenue-overview-widget')).toBeVisible();
    await expect(page.getByTestId('utilization-widget')).toBeVisible();
  });

  test('date range changes update widgets', async ({ page }) => {
    await page.goto('/analytics');

    // Click "Last Quarter" preset
    await page.click('[data-testid="preset-last-quarter"]');

    // Verify widgets show loading then update
    await expect(page.getByTestId('revenue-overview-widget')).not.toHaveClass(/loading/);
  });
});
```

### Coverage Commands

```bash
# Backend coverage
cd services/gateway
npm run test:coverage

# Frontend coverage
cd apps/web
npm run test:coverage

# E2E tests
npx playwright test tests/e2e/analytics/

# Performance tests
npx ts-node tests/performance/financial-kpis-performance.ts
```

## Testing

This story IS the testing story, so the testing section here covers meta-testing (testing the tests).

### Quality Gates

- [ ] All unit tests pass (exit code 0)
- [ ] Backend coverage ≥80% (check coverage report)
- [ ] Frontend coverage ≥70% (check coverage report)
- [ ] All integration tests pass
- [ ] All E2E tests pass
- [ ] No flaky tests (3 consecutive runs stable)
- [ ] Manual testing checklist signed off
- [ ] Performance baseline documented

### Test Report Location

After test runs, reports available at:

- Unit: `coverage/lcov-report/index.html`
- E2E: `playwright-report/index.html`
- Performance: `tests/performance/results/`

## Security Considerations

- E2E tests use isolated test database
- Test credentials not committed to repo (use env vars)
- Performance tests don't run in production

## Change Log

| Date       | Version | Description                      | Author             |
| ---------- | ------- | -------------------------------- | ------------------ |
| 2025-11-26 | 1.0     | Story split from original 2.11.1 | Bob (Scrum Master) |
