# Story 4.7: Task Analytics and Optimization

**Epic:** 4 - Natural Language Task Management & Workflow Automation
**Story Type:** Full-Stack (Backend Analytics Services + Frontend Dashboard)
**Priority:** High
**Dependencies:** Story 4.2 (Task Type System - Done), Story 4.3 (Time Estimation & Manual Time Logging - Done), Story 4.4 (Task Dependencies - Done), Story 4.5 (Team Workload Management - Done), Story 4.6 (Task Collaboration - In Progress)

## Status

Done

## Story

**As a** firm optimizing operations,
**I want** insights into task patterns and efficiency,
**so that** we can improve our workflows.

## Acceptance Criteria

1. Average task completion time by type and user
2. Overdue task analysis identifies bottleneck patterns
3. Task velocity trends show productivity changes
4. AI identifies frequently co-occurring tasks for template creation
5. Delegation patterns reveal training opportunities
6. ROI calculator shows time savings from automation

## Tasks / Subtasks

### Phase 0: Dependency Verification (Gate)

- [x] **Task 0: Verify Story 4.6 Schema Completion** (Blocking)
  - [ ] Confirm `TaskComment` model exists in `packages/database/prisma/schema.prisma`
  - [ ] Confirm `TaskHistory` model exists in `packages/database/prisma/schema.prisma`
  - [ ] Confirm `CaseActivityEntry` model exists in `packages/database/prisma/schema.prisma`
  - [ ] Run `pnpm prisma generate` to verify schema compiles
  - [ ] **STOP if any model is missing** - Story 4.6 must be completed first
  - [ ] Location: `packages/database/prisma/schema.prisma`

### Phase 1: Database Schema Extensions (AC: 1, 2, 3, 4, 5, 6)

- [x] **Task 1: Create TaskAnalyticsSnapshot Model** (AC: 1, 2, 3)
  - [ ] Add `TaskAnalyticsSnapshot` model to `packages/database/prisma/schema.prisma`:

    ```prisma
    model TaskAnalyticsSnapshot {
      id                String   @id @default(uuid())
      firmId            String   @map("firm_id")
      snapshotDate      DateTime @map("snapshot_date") @db.Date
      snapshotType      SnapshotType @map("snapshot_type") @default(Daily)

      // Completion metrics (AC: 1)
      totalTasksCreated     Int    @map("total_tasks_created")
      totalTasksCompleted   Int    @map("total_tasks_completed")
      avgCompletionTimeHours Decimal @map("avg_completion_time_hours") @db.Decimal(8, 2)

      // By type breakdown (stored as JSON for flexibility)
      completionByType      Json   @map("completion_by_type") // { [TaskTypeEnum]: { count, avgHours } }
      completionByUser      Json   @map("completion_by_user") // { [userId]: { count, avgHours } }

      // Overdue metrics (AC: 2)
      overdueCount          Int    @map("overdue_count")
      overdueByType         Json   @map("overdue_by_type")
      overdueByUser         Json   @map("overdue_by_user")
      bottleneckTasks       Json   @map("bottleneck_tasks") // Task IDs causing most delays

      // Velocity metrics (AC: 3)
      velocityScore         Decimal @map("velocity_score") @db.Decimal(5, 2) // Tasks completed / target
      velocityTrend         String  @map("velocity_trend") @db.VarChar(20) // 'improving' | 'stable' | 'declining'

      createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz

      @@unique([firmId, snapshotDate, snapshotType])
      @@index([firmId])
      @@index([snapshotDate])
      @@map("task_analytics_snapshots")
    }

    enum SnapshotType {
      Daily
      Weekly
      Monthly
    }
    ```

  - [ ] Location: `packages/database/prisma/schema.prisma`

- [x] **Task 2: Create TaskPatternAnalysis Model** (AC: 4)
  - [ ] Add `TaskPatternAnalysis` model for AI-detected task co-occurrence patterns:

    ```prisma
    model TaskPatternAnalysis {
      id               String   @id @default(uuid())
      firmId           String   @map("firm_id")
      patternType      PatternType @map("pattern_type")

      // Co-occurring task pattern (AC: 4)
      taskTypes        String[] @map("task_types") // TaskTypeEnum values
      caseTypes        CaseType[] @map("case_types") // Associated case types
      occurrenceCount  Int      @map("occurrence_count")
      confidence       Decimal  @map("confidence") @db.Decimal(3, 2) // 0.00-1.00
      suggestedName    String?  @map("suggested_name") @db.VarChar(200) // AI-suggested template name

      // Pattern details
      avgSequenceGap   Decimal? @map("avg_sequence_gap") @db.Decimal(5, 2) // Days between tasks
      commonAssignees  String[] @map("common_assignees") // User IDs frequently assigned

      isTemplateCreated Boolean @default(false) @map("is_template_created")
      templateId        String? @map("template_id") // Created template ID if converted

      analyzedAt        DateTime @default(now()) @map("analyzed_at") @db.Timestamptz
      expiresAt         DateTime @map("expires_at") @db.Timestamptz // Pattern validity

      @@index([firmId])
      @@index([patternType])
      @@index([confidence])
      @@map("task_pattern_analyses")
    }

    enum PatternType {
      CoOccurrence    // Tasks frequently created together
      Sequence        // Tasks frequently follow each other
      CaseTypeSpecific // Patterns specific to case type
    }
    ```

  - [ ] Location: `packages/database/prisma/schema.prisma`

- [x] **Task 3: Create DelegationAnalytics Model** (AC: 5)
  - [ ] Add `DelegationAnalytics` model for delegation pattern analysis:

    ```prisma
    model DelegationAnalytics {
      id                  String   @id @default(uuid())
      firmId              String   @map("firm_id")
      userId              String   @map("user_id")
      analysisMonth       DateTime @map("analysis_month") @db.Date // First of month

      // Delegation metrics (AC: 5)
      delegationsReceived Int      @map("delegations_received")
      delegationsGiven    Int      @map("delegations_given")
      delegationsByType   Json     @map("delegations_by_type") // { [TaskTypeEnum]: count }

      // Success metrics
      successRate         Decimal  @map("success_rate") @db.Decimal(3, 2) // Completed on time
      avgCompletionTime   Decimal? @map("avg_completion_time") @db.Decimal(8, 2)

      // Training opportunities
      struggleAreas       String[] @map("struggle_areas") // Task types with low success
      strengthAreas       String[] @map("strength_areas") // Task types with high success
      suggestedTraining   Json?    @map("suggested_training") // AI recommendations

      createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz

      @@unique([firmId, userId, analysisMonth])
      @@index([firmId])
      @@index([userId])
      @@map("delegation_analytics")
    }
    ```

  - [ ] Location: `packages/database/prisma/schema.prisma`

- [x] **Task 4: Create AutomationROIMetrics Model** (AC: 6)
  - [ ] Add `AutomationROIMetrics` model for ROI calculations:

    ```prisma
    model AutomationROIMetrics {
      id                   String   @id @default(uuid())
      firmId               String   @map("firm_id")
      metricMonth          DateTime @map("metric_month") @db.Date

      // Time savings (AC: 6)
      templateTasksCreated Int      @map("template_tasks_created") // Tasks from templates
      manualTasksCreated   Int      @map("manual_tasks_created")
      estimatedTimeSavedMin Int     @map("estimated_time_saved_min") // Minutes saved

      // NLP parser savings
      nlpTasksCreated      Int      @map("nlp_tasks_created")
      avgParseTimeMs       Int      @map("avg_parse_time_ms")
      estimatedFormTimeSavedMin Int @map("estimated_form_time_saved_min")

      // Automation impact
      autoRemindersSet     Int      @map("auto_reminders_sent")
      autoDependencyTriggers Int    @map("auto_dependency_triggers")
      autoReassignments    Int      @map("auto_reassignments") // OOO auto-reassign

      // ROI calculation inputs
      avgHourlyRate        Decimal  @map("avg_hourly_rate") @db.Decimal(10, 2)
      totalValueSaved      Decimal  @map("total_value_saved") @db.Decimal(12, 2)

      createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz

      @@unique([firmId, metricMonth])
      @@index([firmId])
      @@map("automation_roi_metrics")
    }
    ```

  - [ ] Location: `packages/database/prisma/schema.prisma`

- [x] **Task 5: Run Prisma Migration**
  - [ ] Run `pnpm prisma generate`
  - [ ] Create migration: `pnpm prisma migrate dev --name story_4_7_task_analytics`
  - [ ] Verify all relations are correct
  - [ ] Location: `packages/database/prisma/`

### Phase 2: Type Definitions (AC: 1, 2, 3, 4, 5, 6)

- [x] **Task 6: Create Task Analytics Types** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `packages/shared/types/src/task-analytics.ts`:

    ```typescript
    import type { TaskTypeEnum, CaseType } from './entities';

    // ============================================================================
    // Completion Time Analytics (AC: 1)
    // ============================================================================

    export interface CompletionTimeMetrics {
      avgCompletionTimeHours: number;
      medianCompletionTimeHours: number;
      minCompletionTimeHours: number;
      maxCompletionTimeHours: number;
      totalTasksAnalyzed: number;
    }

    export interface CompletionByType {
      taskType: TaskTypeEnum;
      metrics: CompletionTimeMetrics;
      comparedToPrevious?: number; // Percentage change
    }

    export interface CompletionByUser {
      userId: string;
      userName: string;
      metrics: CompletionTimeMetrics;
      taskCount: number;
      comparedToTeamAvg?: number; // Percentage vs team average
    }

    export interface CompletionTimeAnalyticsResponse {
      firmMetrics: CompletionTimeMetrics;
      byType: CompletionByType[];
      byUser: CompletionByUser[];
      dateRange: { start: Date; end: Date };
    }

    // ============================================================================
    // Overdue Analysis (AC: 2)
    // ============================================================================

    export interface OverdueTask {
      taskId: string;
      taskTitle: string;
      taskType: TaskTypeEnum;
      assigneeId: string;
      assigneeName: string;
      caseId: string;
      caseTitle: string;
      dueDate: Date;
      daysOverdue: number;
      blockedBy?: string[]; // Task IDs blocking this task
      estimatedImpact: 'low' | 'medium' | 'high' | 'critical';
    }

    export interface BottleneckPattern {
      patternType: 'user_overload' | 'task_type_delay' | 'dependency_chain' | 'case_complexity';
      description: string;
      affectedTasks: number;
      suggestedAction: string;
      relatedUsers?: string[];
      relatedTaskTypes?: TaskTypeEnum[];
    }

    export interface OverdueAnalyticsResponse {
      totalOverdue: number;
      overdueByType: { taskType: TaskTypeEnum; count: number; avgDaysOverdue: number }[];
      overdueByUser: { userId: string; userName: string; count: number }[];
      bottleneckPatterns: BottleneckPattern[];
      criticalTasks: OverdueTask[]; // Top 10 most impactful
    }

    // ============================================================================
    // Velocity Trends (AC: 3)
    // ============================================================================

    export interface VelocityDataPoint {
      date: Date;
      tasksCreated: number;
      tasksCompleted: number;
      velocityScore: number; // completed / target
      trend: 'improving' | 'stable' | 'declining';
    }

    export interface VelocityByUser {
      userId: string;
      userName: string;
      currentVelocity: number;
      previousVelocity: number;
      trendDirection: 'up' | 'stable' | 'down';
      percentageChange: number;
    }

    export interface VelocityTrendsResponse {
      firmVelocity: {
        current: number;
        previous: number;
        trend: 'improving' | 'stable' | 'declining';
        percentageChange: number;
      };
      timeSeries: VelocityDataPoint[];
      byUser: VelocityByUser[];
      interval: 'daily' | 'weekly' | 'monthly';
    }

    // ============================================================================
    // Task Pattern Detection (AC: 4)
    // ============================================================================

    export interface TaskCoOccurrencePattern {
      id: string;
      taskTypes: TaskTypeEnum[];
      caseTypes: CaseType[];
      occurrenceCount: number;
      confidence: number; // 0-1
      suggestedTemplateName: string;
      avgSequenceGapDays?: number;
      commonAssignees: { userId: string; userName: string; frequency: number }[];
      sampleCases: { caseId: string; caseTitle: string }[];
      isTemplateCreated: boolean;
    }

    export interface PatternDetectionResponse {
      patterns: TaskCoOccurrencePattern[];
      analysisDate: Date;
      totalPatternsFound: number;
      highConfidenceCount: number; // confidence > 0.8
    }

    export interface CreateTemplateFromPatternInput {
      patternId: string;
      templateName: string;
      description?: string;
    }

    // ============================================================================
    // Delegation Analysis (AC: 5)
    // ============================================================================

    export interface DelegationPatternUser {
      userId: string;
      userName: string;
      role: string;
      delegationsReceived: number;
      delegationsGiven: number;
      successRate: number; // Percentage completed on time
      avgCompletionDays: number;
      strengthAreas: TaskTypeEnum[];
      struggleAreas: TaskTypeEnum[];
      suggestedTraining: TrainingSuggestion[];
    }

    export interface TrainingSuggestion {
      skillArea: TaskTypeEnum;
      reason: string;
      priority: 'low' | 'medium' | 'high';
      suggestedAction: string;
    }

    export interface DelegationFlow {
      fromUserId: string;
      fromUserName: string;
      toUserId: string;
      toUserName: string;
      count: number;
      avgSuccessRate: number;
    }

    export interface DelegationAnalyticsResponse {
      byUser: DelegationPatternUser[];
      topDelegationFlows: DelegationFlow[];
      firmWideSuccessRate: number;
      trainingOpportunities: {
        userId: string;
        userName: string;
        suggestions: TrainingSuggestion[];
      }[];
    }

    // ============================================================================
    // ROI Calculator (AC: 6)
    // ============================================================================

    export interface ROIMetrics {
      // Template automation
      templateTasksCreated: number;
      manualTasksCreated: number;
      templateAdoptionRate: number; // Percentage
      estimatedTemplateTimeSavedHours: number;

      // NLP parser
      nlpTasksCreated: number;
      estimatedNLPTimeSavedHours: number;

      // Automation features
      autoRemindersSet: number;
      autoDependencyTriggers: number;
      autoReassignments: number;
      estimatedAutomationTimeSavedHours: number;

      // Total savings
      totalTimeSavedHours: number;
      avgHourlyRate: number;
      totalValueSaved: number;

      // Comparison
      comparisonPeriod: { start: Date; end: Date };
      previousPeriodSavings?: number;
      savingsGrowthPercent?: number;
    }

    export interface ROIDashboardResponse {
      currentPeriod: ROIMetrics;
      timeSeries: {
        date: Date;
        timeSavedHours: number;
        valueSaved: number;
      }[];
      projectedAnnualSavings: number;
      topSavingsCategories: {
        category: string;
        hoursSaved: number;
        valueSaved: number;
        percentageOfTotal: number;
      }[];
    }

    // ============================================================================
    // Combined Analytics Dashboard
    // ============================================================================

    export interface TaskAnalyticsDashboard {
      completion: CompletionTimeAnalyticsResponse;
      overdue: OverdueAnalyticsResponse;
      velocity: VelocityTrendsResponse;
      dateRange: { start: Date; end: Date };
    }

    export interface AnalyticsFilters {
      firmId: string;
      dateRange: { start: Date; end: Date };
      taskTypes?: TaskTypeEnum[];
      userIds?: string[];
      caseIds?: string[];
    }
    ```

  - [ ] Export from `packages/shared/types/src/index.ts`
  - [ ] Location: `packages/shared/types/src/task-analytics.ts`

### Phase 3: Backend Analytics Services (AC: 1, 2, 3, 4, 5, 6)

- [x] **Task 7: Create Task Completion Analytics Service** (AC: 1)
  - [ ] Create `services/gateway/src/services/task-completion-analytics.service.ts`:
    - `getCompletionTimeAnalytics(firmId: string, filters: AnalyticsFilters): Promise<CompletionTimeAnalyticsResponse>`
    - `calculateAvgCompletionTime(tasks: Task[]): CompletionTimeMetrics`
    - `getCompletionByType(firmId: string, filters: AnalyticsFilters): Promise<CompletionByType[]>`
    - `getCompletionByUser(firmId: string, filters: AnalyticsFilters): Promise<CompletionByUser[]>`
  - [ ] Use `completedAt - createdAt` for completion time calculation
  - [ ] Support date range filtering and period comparison
  - [ ] Cache results in Redis for 15 minutes (configurable)
  - [ ] Location: `services/gateway/src/services/task-completion-analytics.service.ts`

- [x] **Task 8: Create Overdue Analysis Service** (AC: 2)
  - [ ] Create `services/gateway/src/services/overdue-analysis.service.ts`:
    - `getOverdueAnalytics(firmId: string, filters: AnalyticsFilters): Promise<OverdueAnalyticsResponse>`
    - `identifyBottlenecks(firmId: string): Promise<BottleneckPattern[]>`
    - `getCriticalOverdueTasks(firmId: string, limit: number): Promise<OverdueTask[]>`
    - `calculateEstimatedImpact(task: Task): 'low' | 'medium' | 'high' | 'critical'`
  - [ ] Analyze dependency chains to identify blockers
  - [ ] Group by user workload patterns
  - [ ] Provide actionable suggestions for each bottleneck
  - [ ] Location: `services/gateway/src/services/overdue-analysis.service.ts`

- [x] **Task 9: Create Velocity Trends Service** (AC: 3)
  - [ ] Create `services/gateway/src/services/velocity-trends.service.ts`:
    - `getVelocityTrends(firmId: string, filters: AnalyticsFilters, interval: 'daily' | 'weekly' | 'monthly'): Promise<VelocityTrendsResponse>`
    - `calculateVelocityScore(created: number, completed: number, target: number): number`
    - `determineTrend(current: number, previous: number): 'improving' | 'stable' | 'declining'`
    - `getUserVelocityComparison(firmId: string, filters: AnalyticsFilters): Promise<VelocityByUser[]>`
  - [ ] Target velocity based on historical firm average
  - [ ] Support configurable comparison periods
  - [ ] Location: `services/gateway/src/services/velocity-trends.service.ts`

- [x] **Task 10: Create Pattern Detection Service** (AC: 4)
  - [ ] Create `services/gateway/src/services/pattern-detection.service.ts`:
    - `detectTaskPatterns(firmId: string): Promise<PatternDetectionResponse>`
    - `findCoOccurrences(tasks: Task[], minOccurrences: number): TaskCoOccurrencePattern[]`
    - `findSequencePatterns(tasks: Task[], minOccurrences: number): TaskCoOccurrencePattern[]`
    - `generateTemplateSuggestion(pattern: TaskCoOccurrencePattern): string`
    - `createTemplateFromPattern(input: CreateTemplateFromPatternInput, userId: string): Promise<TaskTemplate>`
  - [ ] Use AI service for pattern naming suggestions
  - [ ] Minimum 3 occurrences to suggest pattern
  - [ ] Confidence threshold: 0.6 minimum, 0.8 for high confidence
  - [ ] Location: `services/gateway/src/services/pattern-detection.service.ts`

- [x] **Task 11: Create Delegation Analytics Service** (AC: 5)
  - [ ] Create `services/gateway/src/services/delegation-analytics.service.ts`:
    - `getDelegationAnalytics(firmId: string, filters: AnalyticsFilters): Promise<DelegationAnalyticsResponse>`
    - `analyzeDelegationPatterns(firmId: string, userId: string): Promise<DelegationPatternUser>`
    - `identifyTrainingOpportunities(userPatterns: DelegationPatternUser[]): TrainingSuggestion[]`
    - `getDelegationFlows(firmId: string): Promise<DelegationFlow[]>`
  - [ ] Compare success rates by task type per user
  - [ ] AI-powered training suggestions based on struggle areas
  - [ ] Location: `services/gateway/src/services/delegation-analytics.service.ts`

- [x] **Task 12: Create ROI Calculator Service** (AC: 6)
  - [ ] Create `services/gateway/src/services/roi-calculator.service.ts`:
    - `calculateROI(firmId: string, filters: AnalyticsFilters): Promise<ROIDashboardResponse>`
    - `getTemplateTimeSavings(firmId: string, dateRange: DateRange): number`
    - `getNLPTimeSavings(firmId: string, dateRange: DateRange): number`
    - `getAutomationTimeSavings(firmId: string, dateRange: DateRange): number`
    - `projectAnnualSavings(monthlyData: ROIMetrics[]): number`
  - [ ] Time savings assumptions (configurable):
    - Template task creation: 5 minutes saved per task vs manual
    - NLP parsing: 2 minutes saved per task vs form entry
    - Auto-reminder: 1 minute saved per reminder
    - Auto-reassignment: 10 minutes saved per reassignment
  - [ ] Use firm's average hourly rate from `Firm.defaultRates`
  - [ ] Location: `services/gateway/src/services/roi-calculator.service.ts`

- [x] **Task 13: Create Analytics Aggregation Worker** (AC: 1, 2, 3)
  - [ ] Create `services/gateway/src/workers/analytics-aggregation.worker.ts`:
    - Runs daily at 2 AM (configurable via `ANALYTICS_WORKER_CRON`)
    - Creates daily `TaskAnalyticsSnapshot` for each firm
    - Aggregates completion times, overdue counts, velocity scores
    - Prunes snapshots older than 365 days (configurable)
  - [ ] Follow pattern from `task-reminder.worker.ts`
  - [ ] Location: `services/gateway/src/workers/analytics-aggregation.worker.ts`

- [x] **Task 14: Create Pattern Analysis Worker** (AC: 4, 5)
  - [ ] Create `services/gateway/src/workers/pattern-analysis.worker.ts`:
    - Runs weekly on Sunday at 3 AM
    - Detects new task patterns for each firm
    - Analyzes delegation patterns and generates training suggestions
    - Updates `TaskPatternAnalysis` and `DelegationAnalytics` tables
  - [ ] Location: `services/gateway/src/workers/pattern-analysis.worker.ts`

- [x] **Task 15: Create ROI Metrics Worker** (AC: 6)
  - [ ] Create `services/gateway/src/workers/roi-metrics.worker.ts`:
    - Runs monthly on 1st at 4 AM
    - Aggregates monthly automation metrics
    - Calculates and stores ROI data in `AutomationROIMetrics`
  - [ ] Location: `services/gateway/src/workers/roi-metrics.worker.ts`

- [x] **Task 16: Register Workers in Gateway** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Update `services/gateway/src/index.ts`:
    - Import and start analytics aggregation worker
    - Import and start pattern analysis worker
    - Import and start ROI metrics worker
    - Add to graceful shutdown handler
  - [ ] Add environment variables:
    ```env
    # Analytics Workers Configuration
    ANALYTICS_WORKER_ENABLED=true
    ANALYTICS_AGGREGATION_CRON="0 2 * * *"     # 2 AM daily
    PATTERN_ANALYSIS_CRON="0 3 * * 0"          # 3 AM Sunday
    ROI_METRICS_CRON="0 4 1 * *"               # 4 AM 1st of month
    ANALYTICS_RETENTION_DAYS=365
    ```
  - [ ] **Worker Failure Recovery:**
    - Store last successful run timestamp in Redis key `analytics:worker:{workerName}:lastRun`
    - On startup, check if scheduled run was missed and trigger catch-up
    - Log failures to `analytics:worker:{workerName}:errors` with timestamp and error message
    - Implement health check endpoint `/health/workers` returning worker status
    - Add alert threshold: if worker hasn't run in 2x scheduled interval, log warning
  - [ ] Location: `services/gateway/src/index.ts`

### Phase 4: GraphQL API (AC: 1, 2, 3, 4, 5, 6)

- [x] **Task 17: Create Task Analytics GraphQL Schema** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `services/gateway/src/graphql/schema/task-analytics.graphql`:

    ```graphql
    # Date range input for analytics filtering
    input DateRangeInput {
      start: DateTime!
      end: DateTime!
    }

    input AnalyticsFiltersInput {
      dateRange: DateRangeInput! # Max 365 days enforced by resolver
      taskTypes: [TaskType!]
      userIds: [ID!]
      caseIds: [ID!]
      limit: Int # Default 100, max 500
      offset: Int # For pagination, default 0
    }

    # Error handling for analytics queries
    enum AnalyticsErrorCode {
      INSUFFICIENT_DATA # Not enough data for meaningful analysis
      DATE_RANGE_INVALID # End date before start, or range > 365 days
      DATE_RANGE_TOO_LARGE # Range exceeds maximum allowed
      DATA_STALE # Worker hasn't run, data may be outdated
      FIRM_NOT_FOUND # Invalid firm context
    }

    type AnalyticsError {
      code: AnalyticsErrorCode!
      message: String!
      lastDataUpdate: DateTime # When data was last refreshed
    }

    # Union type for analytics responses that may fail gracefully
    union CompletionAnalyticsResult = CompletionTimeAnalyticsResponse | AnalyticsError
    union OverdueAnalyticsResult = OverdueAnalyticsResponse | AnalyticsError
    union VelocityTrendsResult = VelocityTrendsResponse | AnalyticsError

    # Completion Time Analytics (AC: 1)
    type CompletionTimeMetrics {
      avgCompletionTimeHours: Float!
      medianCompletionTimeHours: Float!
      minCompletionTimeHours: Float!
      maxCompletionTimeHours: Float!
      totalTasksAnalyzed: Int!
    }

    type CompletionByType {
      taskType: TaskType!
      metrics: CompletionTimeMetrics!
      comparedToPrevious: Float
    }

    type CompletionByUser {
      userId: ID!
      userName: String!
      metrics: CompletionTimeMetrics!
      taskCount: Int!
      comparedToTeamAvg: Float
    }

    type CompletionTimeAnalyticsResponse {
      firmMetrics: CompletionTimeMetrics!
      byType: [CompletionByType!]!
      byUser: [CompletionByUser!]!
      dateRange: DateRange!
    }

    # Overdue Analysis (AC: 2)
    type OverdueTask {
      taskId: ID!
      taskTitle: String!
      taskType: TaskType!
      assigneeId: ID!
      assigneeName: String!
      caseId: ID!
      caseTitle: String!
      dueDate: DateTime!
      daysOverdue: Int!
      blockedBy: [ID!]
      estimatedImpact: ImpactLevel!
    }

    enum ImpactLevel {
      LOW
      MEDIUM
      HIGH
      CRITICAL
    }

    type BottleneckPattern {
      patternType: BottleneckType!
      description: String!
      affectedTasks: Int!
      suggestedAction: String!
      relatedUsers: [ID!]
      relatedTaskTypes: [TaskType!]
    }

    enum BottleneckType {
      USER_OVERLOAD
      TASK_TYPE_DELAY
      DEPENDENCY_CHAIN
      CASE_COMPLEXITY
    }

    type OverdueAnalyticsResponse {
      totalOverdue: Int!
      overdueByType: [OverdueByTypeItem!]!
      overdueByUser: [OverdueByUserItem!]!
      bottleneckPatterns: [BottleneckPattern!]!
      criticalTasks: [OverdueTask!]!
    }

    type OverdueByTypeItem {
      taskType: TaskType!
      count: Int!
      avgDaysOverdue: Float!
    }

    type OverdueByUserItem {
      userId: ID!
      userName: String!
      count: Int!
    }

    # Velocity Trends (AC: 3)
    type VelocityDataPoint {
      date: DateTime!
      tasksCreated: Int!
      tasksCompleted: Int!
      velocityScore: Float!
      trend: TrendDirection!
    }

    enum TrendDirection {
      IMPROVING
      STABLE
      DECLINING
    }

    type VelocityByUser {
      userId: ID!
      userName: String!
      currentVelocity: Float!
      previousVelocity: Float!
      trendDirection: TrendDirectionSimple!
      percentageChange: Float!
    }

    enum TrendDirectionSimple {
      UP
      STABLE
      DOWN
    }

    type FirmVelocity {
      current: Float!
      previous: Float!
      trend: TrendDirection!
      percentageChange: Float!
    }

    type VelocityTrendsResponse {
      firmVelocity: FirmVelocity!
      timeSeries: [VelocityDataPoint!]!
      byUser: [VelocityByUser!]!
      interval: VelocityInterval!
    }

    enum VelocityInterval {
      DAILY
      WEEKLY
      MONTHLY
    }

    # Pattern Detection (AC: 4)
    type PatternAssignee {
      userId: ID!
      userName: String!
      frequency: Int!
    }

    type PatternSampleCase {
      caseId: ID!
      caseTitle: String!
    }

    type TaskCoOccurrencePattern {
      id: ID!
      taskTypes: [TaskType!]!
      caseTypes: [CaseType!]!
      occurrenceCount: Int!
      confidence: Float!
      suggestedTemplateName: String!
      avgSequenceGapDays: Float
      commonAssignees: [PatternAssignee!]!
      sampleCases: [PatternSampleCase!]!
      isTemplateCreated: Boolean!
    }

    type PatternDetectionResponse {
      patterns: [TaskCoOccurrencePattern!]!
      analysisDate: DateTime!
      totalPatternsFound: Int!
      highConfidenceCount: Int!
    }

    input CreateTemplateFromPatternInput {
      patternId: ID!
      templateName: String!
      description: String
    }

    # Delegation Analysis (AC: 5)
    type TrainingSuggestion {
      skillArea: TaskType!
      reason: String!
      priority: TrainingPriority!
      suggestedAction: String!
    }

    enum TrainingPriority {
      LOW
      MEDIUM
      HIGH
    }

    type DelegationPatternUser {
      userId: ID!
      userName: String!
      role: String!
      delegationsReceived: Int!
      delegationsGiven: Int!
      successRate: Float!
      avgCompletionDays: Float!
      strengthAreas: [TaskType!]!
      struggleAreas: [TaskType!]!
      suggestedTraining: [TrainingSuggestion!]!
    }

    type DelegationFlow {
      fromUserId: ID!
      fromUserName: String!
      toUserId: ID!
      toUserName: String!
      count: Int!
      avgSuccessRate: Float!
    }

    type UserTrainingOpportunities {
      userId: ID!
      userName: String!
      suggestions: [TrainingSuggestion!]!
    }

    type DelegationAnalyticsResponse {
      byUser: [DelegationPatternUser!]!
      topDelegationFlows: [DelegationFlow!]!
      firmWideSuccessRate: Float!
      trainingOpportunities: [UserTrainingOpportunities!]!
    }

    # ROI Calculator (AC: 6)
    type ROIMetrics {
      templateTasksCreated: Int!
      manualTasksCreated: Int!
      templateAdoptionRate: Float!
      estimatedTemplateTimeSavedHours: Float!
      nlpTasksCreated: Int!
      estimatedNLPTimeSavedHours: Float!
      autoRemindersSet: Int!
      autoDependencyTriggers: Int!
      autoReassignments: Int!
      estimatedAutomationTimeSavedHours: Float!
      totalTimeSavedHours: Float!
      avgHourlyRate: Float!
      totalValueSaved: Float!
    }

    type ROITimeSeriesPoint {
      date: DateTime!
      timeSavedHours: Float!
      valueSaved: Float!
    }

    type SavingsCategory {
      category: String!
      hoursSaved: Float!
      valueSaved: Float!
      percentageOfTotal: Float!
    }

    type ROIDashboardResponse {
      currentPeriod: ROIMetrics!
      timeSeries: [ROITimeSeriesPoint!]!
      projectedAnnualSavings: Float!
      topSavingsCategories: [SavingsCategory!]!
    }

    # Date range helper type
    type DateRange {
      start: DateTime!
      end: DateTime!
    }

    # Queries
    extend type Query {
      # Completion Analytics (AC: 1)
      taskCompletionAnalytics(filters: AnalyticsFiltersInput!): CompletionTimeAnalyticsResponse!

      # Overdue Analysis (AC: 2)
      overdueAnalytics(filters: AnalyticsFiltersInput!): OverdueAnalyticsResponse!

      # Velocity Trends (AC: 3)
      velocityTrends(
        filters: AnalyticsFiltersInput!
        interval: VelocityInterval!
      ): VelocityTrendsResponse!

      # Pattern Detection (AC: 4)
      taskPatterns: PatternDetectionResponse!
      taskPattern(patternId: ID!): TaskCoOccurrencePattern

      # Delegation Analysis (AC: 5)
      delegationAnalytics(filters: AnalyticsFiltersInput!): DelegationAnalyticsResponse!
      userDelegationPattern(userId: ID!, filters: AnalyticsFiltersInput!): DelegationPatternUser

      # ROI Calculator (AC: 6)
      roiDashboard(filters: AnalyticsFiltersInput!): ROIDashboardResponse!
    }

    # Mutations
    extend type Mutation {
      # Create template from detected pattern (AC: 4)
      createTemplateFromPattern(input: CreateTemplateFromPatternInput!): TaskTemplate!

      # Manually trigger analytics workers (admin only)
      triggerPatternAnalysis: PatternDetectionResponse!
      triggerAnalyticsAggregation(date: DateTime): Boolean! # Re-run daily aggregation
      triggerROIMetricsCalculation(month: DateTime): Boolean! # Re-run monthly ROI
      # Dismiss/acknowledge a pattern (won't show again)
      dismissPattern(patternId: ID!): Boolean!
    }

    # Worker health status query
    type WorkerHealthStatus {
      workerName: String!
      lastRunAt: DateTime
      nextScheduledRun: DateTime
      status: WorkerStatus!
      lastError: String
    }

    enum WorkerStatus {
      HEALTHY
      STALE # Hasn't run in 2x scheduled interval
      ERROR # Last run failed
      DISABLED # Worker is disabled via config
    }

    extend type Query {
      # Worker health (admin only)
      analyticsWorkersHealth: [WorkerHealthStatus!]!
    }
    ```

  - [ ] Register schema in `services/gateway/src/graphql/schema/index.ts`
  - [ ] Location: `services/gateway/src/graphql/schema/task-analytics.graphql`

- [x] **Task 18: Create GraphQL Resolvers** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `services/gateway/src/graphql/resolvers/task-analytics.resolvers.ts`:
    - Implement all query resolvers
    - Implement all mutation resolvers
    - Add partner-only permission check for firm-wide analytics
    - Add user-level access for personal analytics
  - [ ] Include firm isolation checks
  - [ ] Register resolvers in `services/gateway/src/graphql/server.ts`
  - [ ] Location: `services/gateway/src/graphql/resolvers/task-analytics.resolvers.ts`

### Phase 5: Frontend Components (AC: 1, 2, 3, 4, 5, 6)

**UI Standards for All Components:**

- All components must be responsive (desktop/tablet/mobile breakpoints)
- Use Recharts 2.5+ for data visualization (approved in tech stack)
- Include ARIA labels for accessibility
- Support keyboard navigation for interactive elements
- Follow existing component patterns in `apps/web/src/components/ui/`
- Use existing `analyticsFiltersStore` pattern for filter state

- [x] **Task 19: Create Analytics Dashboard Page** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `apps/web/src/app/analytics/tasks/page.tsx`:
    - Main task analytics dashboard page
    - Tab navigation: Overview, Completion, Overdue, Velocity, Patterns, Delegation, ROI
    - Date range picker with presets (last 30 days, last quarter, YTD)
    - Partner/Business Owner role access only
  - [ ] Location: `apps/web/src/app/analytics/tasks/page.tsx`

- [x] **Task 20: Create Completion Time Charts Component** (AC: 1)
  - [ ] Create `apps/web/src/components/analytics/CompletionTimeCharts.tsx`:
    - Bar chart: Average completion time by task type
    - Table: Completion time by user with team average comparison
    - Trend indicator showing change from previous period
    - Drill-down capability to see individual tasks
  - [ ] Use Recharts `BarChart` and `ResponsiveContainer`
  - [ ] Location: `apps/web/src/components/analytics/CompletionTimeCharts.tsx`

- [x] **Task 21: Create Overdue Analysis Panel** (AC: 2)
  - [ ] Create `apps/web/src/components/analytics/OverdueAnalysisPanel.tsx`:
    - Summary cards: Total overdue, by type breakdown, by user
    - Bottleneck pattern cards with suggested actions
    - Critical tasks table with impact indicators
    - Click-through to task detail
  - [ ] Color-coded severity indicators
  - [ ] Location: `apps/web/src/components/analytics/OverdueAnalysisPanel.tsx`

- [x] **Task 22: Create Velocity Trends Chart** (AC: 3)
  - [ ] Create `apps/web/src/components/analytics/VelocityTrendsChart.tsx`:
    - Line chart: Tasks created vs completed over time
    - Velocity score trend line
    - User comparison table with trend arrows
    - Interval selector (daily/weekly/monthly)
  - [ ] Use Recharts `LineChart` with multiple Y-axes
  - [ ] Location: `apps/web/src/components/analytics/VelocityTrendsChart.tsx`

- [x] **Task 23: Create Pattern Detection Panel** (AC: 4)
  - [ ] Create `apps/web/src/components/analytics/PatternDetectionPanel.tsx`:
    - Pattern cards showing task type combinations
    - Confidence score badges
    - "Create Template" button for each pattern
    - Sample cases preview
    - Dismiss pattern option
  - [ ] Location: `apps/web/src/components/analytics/PatternDetectionPanel.tsx`

- [x] **Task 24: Create Template Creation Modal** (AC: 4)
  - [ ] Create `apps/web/src/components/analytics/CreateTemplateFromPatternModal.tsx`:
    - Pre-filled template name from AI suggestion
    - Editable description field
    - Preview of tasks that will be in template
    - Confirm/Cancel buttons
  - [ ] Location: `apps/web/src/components/analytics/CreateTemplateFromPatternModal.tsx`

- [x] **Task 25: Create Delegation Analysis Panel** (AC: 5)
  - [ ] Create `apps/web/src/components/analytics/DelegationAnalysisPanel.tsx`:
    - Sankey diagram or flow chart showing delegation patterns
    - User cards with strength/struggle areas
    - Training opportunity cards with priority badges
    - Success rate gauges per user
  - [ ] Use Recharts `Sankey` or custom flow visualization
  - [ ] Location: `apps/web/src/components/analytics/DelegationAnalysisPanel.tsx`

- [x] **Task 26: Create Training Opportunities List** (AC: 5)
  - [ ] Create `apps/web/src/components/analytics/TrainingOpportunitiesList.tsx`:
    - List of users with training suggestions
    - Priority-sorted recommendations
    - Expandable details for each suggestion
    - Mark as addressed functionality
  - [ ] Location: `apps/web/src/components/analytics/TrainingOpportunitiesList.tsx`

- [x] **Task 27: Create ROI Dashboard Component** (AC: 6)
  - [ ] Create `apps/web/src/components/analytics/ROIDashboard.tsx`:
    - Summary cards: Total time saved, value saved, projected annual
    - Stacked area chart: Time savings over time by category
    - Pie chart: Savings by category breakdown
    - Comparison with previous period
  - [ ] Currency formatting for value saved (RON)
  - [ ] Location: `apps/web/src/components/analytics/ROIDashboard.tsx`

- [x] **Task 28: Create Analytics Filter Bar** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `apps/web/src/components/analytics/AnalyticsFilterBar.tsx`:
    - Date range picker with presets
    - Task type multi-select filter
    - User filter (for Partners)
    - Case filter
    - Export to CSV/PDF button
  - [ ] Use existing `analyticsFiltersStore` pattern
  - [ ] Location: `apps/web/src/components/analytics/AnalyticsFilterBar.tsx`

- [x] **Task 29: Create Frontend Hooks** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `apps/web/src/hooks/useTaskCompletionAnalytics.ts`
  - [ ] Create `apps/web/src/hooks/useOverdueAnalytics.ts`
  - [ ] Create `apps/web/src/hooks/useVelocityTrends.ts`
  - [ ] Create `apps/web/src/hooks/useTaskPatterns.ts`
  - [ ] Create `apps/web/src/hooks/useDelegationAnalytics.ts`
  - [ ] Create `apps/web/src/hooks/useROIDashboard.ts`
  - [ ] All hooks should use React Query for caching
  - [ ] Location: `apps/web/src/hooks/`

- [x] **Task 30: Create Task Analytics Store** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Create `apps/web/src/stores/taskAnalyticsStore.ts`:
    - Extend existing `analyticsFiltersStore` pattern
    - Add task-specific filter state
    - Add active tab state
    - Add export state
  - [ ] Use Zustand following existing pattern
  - [ ] Location: `apps/web/src/stores/taskAnalyticsStore.ts`

- [x] **Task 31: Add Navigation Link** (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Update `apps/web/src/components/layout/Sidebar.tsx`:
    - Add "Task Analytics" link under Analytics section
    - Show only for Partner and BusinessOwner roles
  - [ ] Location: `apps/web/src/components/layout/Sidebar.tsx`

### Phase 6: Testing (AC: 1, 2, 3, 4, 5, 6)

**Test Data Requirements:**
Before writing tests, create test fixtures in `services/gateway/__tests__/fixtures/task-analytics.fixtures.ts`:

- Sample tasks with various completion times and statuses
- Overdue tasks with dependency chains
- Task patterns for co-occurrence detection
- Delegation records with success/failure outcomes
- Time entries and template usage data for ROI

- [x] **Task 32: Unit Tests for Completion Analytics Service** (AC: 1)
  - [x] Create `services/gateway/src/services/task-completion-analytics.service.test.ts`:
    - Test completion time calculation
    - Test grouping by type and user
    - Test date range filtering
    - Test comparison calculations
  - [x] Location: `services/gateway/src/services/task-completion-analytics.service.test.ts`

- [x] **Task 33: Unit Tests for Overdue Analysis Service** (AC: 2)
  - [x] Create `services/gateway/src/services/overdue-analysis.service.test.ts`:
    - Test overdue detection
    - Test bottleneck identification
    - Test impact estimation
  - [x] Location: `services/gateway/src/services/overdue-analysis.service.test.ts`

- [x] **Task 34: Unit Tests for Velocity Trends Service** (AC: 3)
  - [x] Create `services/gateway/src/services/velocity-trends.service.test.ts`:
    - Test velocity score calculation
    - Test trend determination
    - Test time series aggregation
  - [x] Location: `services/gateway/src/services/velocity-trends.service.test.ts`

- [x] **Task 35: Unit Tests for Pattern Detection Service** (AC: 4)
  - [x] Create `services/gateway/src/services/pattern-detection.service.test.ts`:
    - Test co-occurrence detection
    - Test sequence pattern detection
    - Test confidence calculation
    - Test template creation from pattern
  - [x] Location: `services/gateway/src/services/pattern-detection.service.test.ts`

- [x] **Task 36: Unit Tests for Delegation Analytics Service** (AC: 5)
  - [x] Create `services/gateway/src/services/delegation-analytics.service.test.ts`:
    - Test delegation pattern analysis
    - Test training opportunity identification
    - Test success rate calculation
  - [x] Location: `services/gateway/src/services/delegation-analytics.service.test.ts`

- [x] **Task 37: Unit Tests for ROI Calculator Service** (AC: 6)
  - [x] Create `services/gateway/src/services/roi-calculator.service.test.ts`:
    - Test time savings calculations
    - Test value calculation with hourly rates
    - Test projection calculations
  - [x] Location: `services/gateway/src/services/roi-calculator.service.test.ts`

- [x] **Task 38: Integration Tests** (AC: 1, 2, 3, 4, 5, 6)
  - [x] Create `services/gateway/__tests__/integration/task-analytics.test.ts`:
    - Test analytics queries via GraphQL
    - Test template creation from pattern mutation
    - Test firm isolation
    - Test role-based access (Partner only)
  - [x] Location: `services/gateway/__tests__/integration/task-analytics.test.ts`

- [x] **Task 39: E2E Tests** (AC: 1, 2, 3, 4, 5, 6)
  - [x] Create `tests/e2e/task-analytics.spec.ts`:
    - Test loading analytics dashboard
    - Test date range filtering
    - Test tab navigation
    - Test chart interactions
    - Test creating template from pattern
    - Test export functionality
  - [x] Use Playwright
  - [x] Location: `tests/e2e/task-analytics.spec.ts`

## Dev Notes

### Previous Story Insights

**From Story 4.6 (Task Collaboration - In Progress):**

- Task model at `packages/database/prisma/schema.prisma` (search for `model Task {`)
- TaskHistory model tracks all task changes (useful for analytics)
- Task has `completedAt` timestamp for completion time calculation
- Story 4.6 adds TaskComment, TaskHistory, CaseActivityEntry models
- **Note:** Phase 0 gate verifies these models exist before proceeding
  [Source: docs/stories/4.6.story.md]

**From Story 4.5 (Team Workload Management - Done):**

- UserSkill model with proficiency levels (for delegation strength/weakness)
- UserAvailability for OOO tracking
- DelegationHandoff for context preservation
- WorkloadSettings for capacity calculations
  [Source: packages/database/prisma/schema.prisma - search for `model UserSkill {`, `model DelegationHandoff {`]

**From Story 4.4 (Task Dependencies - Done):**

- TaskTemplate and TaskTemplateStep models exist
- TaskDependency model for dependency chain analysis
- TemplateStepDependency for template patterns
- Task.isCriticalPath for critical path highlighting
  [Source: packages/database/prisma/schema.prisma - search for `model TaskTemplate {`, `model TaskDependency {`]

**From Story 4.3 (Time Estimation - Done):**

- TimeEntry model links to tasks
- Task.estimatedHours for estimates vs actuals comparison
- Time tracking patterns for ROI calculations
  [Source: packages/database/prisma/schema.prisma]

**From Story 4.2 (Task Type System - Done):**

- TaskTypeEnum: Research, DocumentCreation, DocumentRetrieval, CourtDate, Meeting, BusinessTrip
- TaskDelegation model for delegation tracking
- Task.parseHistoryId links to NLP parser (for NLP savings calculation)
  [Source: packages/database/prisma/schema.prisma - search for `enum TaskTypeEnum {`, `model TaskDelegation {`]

### Existing Analytics Patterns

**Performance Metrics Service (Story 3.8):**

- Pattern for Redis-based metrics aggregation at `services/gateway/src/services/performance-metrics.service.ts`
- Uses buffered writes to database
- Percentile calculations
- Time series data structure
  [Source: services/gateway/src/services/performance-metrics.service.ts]

**Analytics Filters Store:**

- Pattern for date range filtering at `apps/web/src/stores/analyticsFiltersStore.ts`
- Zustand store with presets (last30, lastQuarter, ytd, custom)
- Previous period calculation for comparisons
  [Source: apps/web/src/stores/analyticsFiltersStore.ts]

### Data Models

**Existing Task Model (relevant fields):**

```prisma
model Task {
  id            String       @id @default(uuid())
  firmId        String       @map("firm_id")
  caseId        String       @map("case_id")
  type          TaskTypeEnum
  status        TaskStatus   @default(Pending)
  dueDate       DateTime     @map("due_date") @db.Date
  estimatedHours Decimal?    @map("estimated_hours")
  parentTaskId  String?      @map("parent_task_id")
  templateStepId   String?   @map("template_step_id")
  isCriticalPath   Boolean   @default(false)
  createdBy     String       @map("created_by")
  createdAt     DateTime     @default(now())
  completedAt   DateTime?    @map("completed_at")

  // Relations for analytics
  predecessors      TaskDependency[] @relation("TaskSuccessor")
  successors        TaskDependency[] @relation("TaskPredecessor")
  history           TaskHistory[]
  timeEntries       TimeEntry[]
}
```

[Source: packages/database/prisma/schema.prisma - search for `model Task {`]

**Existing TaskDelegation Model:**

```prisma
model TaskDelegation {
  id              String   @id @default(uuid())
  sourceTaskId    String   @map("source_task_id")
  delegatedTaskId String?  @map("delegated_task_id")
  delegatedTo     String   @map("delegated_to")
  delegatedBy     String   @map("delegated_by")
  status          DelegationStatus @default(Pending)

  handoff         DelegationHandoff?
}
```

[Source: packages/database/prisma/schema.prisma - search for `model TaskDelegation {`]

### API Specifications

**GraphQL Operations (new):**

- Queries: `taskCompletionAnalytics`, `overdueAnalytics`, `velocityTrends`, `taskPatterns`, `delegationAnalytics`, `roiDashboard`
- Mutations: `createTemplateFromPattern`, `triggerPatternAnalysis`, `dismissPattern`

### File Locations

```
packages/database/prisma/
└── schema.prisma                              # MODIFY - Add TaskAnalyticsSnapshot, TaskPatternAnalysis, DelegationAnalytics, AutomationROIMetrics models

packages/shared/types/src/
├── task-analytics.ts                          # NEW - All task analytics types
└── index.ts                                   # MODIFY - Export new types

services/gateway/src/
├── services/
│   ├── task-completion-analytics.service.ts   # NEW - Completion time analytics
│   ├── task-completion-analytics.service.test.ts
│   ├── overdue-analysis.service.ts            # NEW - Overdue analysis
│   ├── overdue-analysis.service.test.ts
│   ├── velocity-trends.service.ts             # NEW - Velocity trends
│   ├── velocity-trends.service.test.ts
│   ├── pattern-detection.service.ts           # NEW - Pattern detection
│   ├── pattern-detection.service.test.ts
│   ├── delegation-analytics.service.ts        # NEW - Delegation patterns
│   ├── delegation-analytics.service.test.ts
│   └── roi-calculator.service.ts              # NEW - ROI calculations
│   └── roi-calculator.service.test.ts
├── graphql/
│   ├── schema/
│   │   ├── task-analytics.graphql             # NEW - Analytics schema
│   │   └── index.ts                           # MODIFY - Register schema
│   └── resolvers/
│       ├── task-analytics.resolvers.ts        # NEW - Analytics resolvers
│       └── index.ts                           # MODIFY - Register resolvers
├── workers/
│   ├── analytics-aggregation.worker.ts        # NEW - Daily aggregation
│   ├── pattern-analysis.worker.ts             # NEW - Weekly pattern analysis
│   └── roi-metrics.worker.ts                  # NEW - Monthly ROI metrics
└── __tests__/integration/
    └── task-analytics.test.ts                 # NEW - Integration tests

apps/web/src/
├── app/analytics/tasks/
│   └── page.tsx                               # NEW - Analytics dashboard page
├── hooks/
│   ├── useTaskCompletionAnalytics.ts          # NEW
│   ├── useOverdueAnalytics.ts                 # NEW
│   ├── useVelocityTrends.ts                   # NEW
│   ├── useTaskPatterns.ts                     # NEW
│   ├── useDelegationAnalytics.ts              # NEW
│   └── useROIDashboard.ts                     # NEW
├── stores/
│   └── taskAnalyticsStore.ts                  # NEW - Analytics state
└── components/
    ├── analytics/
    │   ├── CompletionTimeCharts.tsx           # NEW
    │   ├── OverdueAnalysisPanel.tsx           # NEW
    │   ├── VelocityTrendsChart.tsx            # NEW
    │   ├── PatternDetectionPanel.tsx          # NEW
    │   ├── CreateTemplateFromPatternModal.tsx # NEW
    │   ├── DelegationAnalysisPanel.tsx        # NEW
    │   ├── TrainingOpportunitiesList.tsx      # NEW
    │   ├── ROIDashboard.tsx                   # NEW
    │   └── AnalyticsFilterBar.tsx             # NEW
    └── layout/
        └── Sidebar.tsx                        # MODIFY - Add nav link

tests/e2e/
└── task-analytics.spec.ts                     # NEW - E2E tests
```

[Source: docs/architecture/unified-project-structure.md]

### Technical Constraints

**Data Visualization:**

- Use Recharts 2.5+ for all charts (approved in tech stack)
- Chart types: BarChart (completion), LineChart (velocity), PieChart (ROI), Sankey (delegation flows)
- Use ResponsiveContainer for responsive charts
  [Source: docs/architecture/tech-stack.md:28]

**Caching Strategy:**

- Cache analytics results in Redis for 15 minutes
- Follow pattern from `performance-metrics.service.ts`
- Use hour-based keys for aggregated data
  [Source: services/gateway/src/services/performance-metrics.service.ts:180-208]

**Worker Configuration:**

- Follow `task-reminder.worker.ts` pattern
- Use node-cron for scheduling
- Add graceful shutdown handling
- Store worker state in Redis to prevent duplicate runs
  [Source: services/gateway/src/workers/task-reminder.worker.ts]

**Role-Based Access:**

- Task analytics dashboard: Partner and BusinessOwner only
- Personal analytics (own tasks): All users
- Firm-wide analytics with user breakdown: Partner only
  [Source: docs/architecture/coding-standards.md]

### Testing

**Testing Standards (from Architecture):**

- Unit tests: Jest 29+ co-located with services
- Integration tests: `services/gateway/__tests__/integration/`
- E2E tests: Playwright in `tests/e2e/`
- Coverage target: 80% for new services
  [Source: docs/architecture/testing-strategy.md]

**Test Scenarios:**

- Completion time calculations with edge cases (no tasks, single task)
- Overdue detection with complex dependency chains
- Velocity trend calculations across different intervals
- Pattern detection with various occurrence thresholds
- Delegation success rate calculations
- ROI calculations with different time savings assumptions
- Firm isolation for all analytics queries

### Security Considerations

- Firm isolation: All analytics queries must filter by user's firmId
- Role-based access: Firm-wide analytics require Partner or BusinessOwner role
- User-level data: Users can only see their own detailed performance metrics
- Pattern data: AI-generated patterns visible to Partners only
- Training suggestions: Visible to Partners and the individual user
  [Source: docs/architecture/coding-standards.md]

### Performance Considerations

- Pre-aggregate daily snapshots via worker to avoid expensive real-time queries
- Cache analytics results in Redis (15-minute TTL)
- Limit pattern detection to last 90 days of data
- Pagination for large result sets (overdue tasks, user lists)
- Use database indexes on (firmId, createdAt), (firmId, status), (firmId, dueDate)
  [Source: services/gateway/src/services/performance-metrics.service.ts]

## Rollback Plan

**If issues arise after deployment:**

1. **Database Rollback:**
   - Run `npx prisma migrate revert` to remove new tables
   - TaskAnalyticsSnapshot, TaskPatternAnalysis, DelegationAnalytics, AutomationROIMetrics tables can be dropped
   - Note: This will delete all analytics history data

2. **Backend Rollback:**
   - Remove new GraphQL schemas from schema index
   - Remove new resolver imports
   - Stop analytics workers
   - Analytics queries will return empty data

3. **Frontend Rollback:**
   - Remove analytics page route
   - Remove navigation link from sidebar
   - Other features continue to work normally

4. **Worker Rollback:**
   - Stop analytics workers
   - No data aggregation will occur (no data loss beyond that point)

5. **Monitoring:**
   - Track query performance for analytics endpoints
   - Monitor worker execution times
   - Alert on failed aggregation runs
   - Track cache hit rates for analytics queries

## Change Log

| Date       | Version | Description                                                                                                                                   | Author                      |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------- |
| 2025-12-02 | 1.0     | Initial story draft from Epic 4 requirements                                                                                                  | Bob (Scrum Master)          |
| 2025-12-02 | 1.1     | Validation fixes: Added Phase 0 dependency gate, error handling types, pagination params, worker failure recovery, fixed line references      | Sarah (PO)                  |
| 2025-12-03 | 1.2     | Implementation complete: Phases 0-5 done (Database, Types, Backend Services, Workers, GraphQL, Frontend). Phase 6 (Testing) pending.          | Dev Agent (Claude Opus 4.5) |
| 2025-12-03 | 1.3     | Testing complete: Phase 6 done with 103 total tests (90 unit + 13 integration). E2E tests created. All tests passing. Story ready for review. | Dev Agent (Claude Opus 4.5) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Type compilation verified for all analytics components
- Fixed TaskType enum values to match schema (Research, DocumentCreation, DocumentRetrieval, CourtDate, Meeting, BusinessTrip)
- Fixed TrendDirection type handling in VelocityTrendsChart
- Fixed nullable property handling in OverdueAnalysisPanel and ROIDashboard

### Completion Notes List

1. **Phase 0-2 (Complete):** Database schema models added for TaskAnalyticsSnapshot, TaskPatternAnalysis, DelegationAnalytics, AutomationROIMetrics. Type definitions created in packages/shared/types/src/task-analytics.ts.

2. **Phase 3 (Complete):** Backend services created:
   - task-completion-analytics.service.ts - Completion time calculations with Redis caching
   - overdue-analysis.service.ts - Bottleneck detection and critical task identification
   - velocity-trends.service.ts - Productivity trend calculations
   - pattern-detection.service.ts - AI task pattern co-occurrence detection
   - delegation-analytics.service.ts - Delegation patterns and training opportunities
   - roi-calculator.service.ts - Time/value savings calculations

3. **Workers (Complete):** Created analytics-aggregation.worker.ts (daily), pattern-analysis.worker.ts (weekly), roi-metrics.worker.ts (monthly)

4. **Phase 4 (Complete):** GraphQL schema and resolvers for all analytics queries and mutations

5. **Phase 5 (Complete):** Frontend components:
   - CompletionTimeCharts.tsx - Bar charts with firm/type/user breakdowns
   - OverdueAnalysisPanel.tsx - Tabbed view with patterns and critical tasks
   - VelocityTrendsChart.tsx - Time series with interval selector
   - PatternDetectionPanel.tsx - Pattern cards with template creation
   - DelegationAnalysisPanel.tsx - Success rates, flows, training suggestions
   - ROIDashboard.tsx - Value saved metrics with projections
   - AnalyticsFilterBar.tsx - Date range, task type, user filters
   - useTaskAnalytics.ts - Apollo Client hooks for all analytics
   - taskAnalyticsStore.ts - Zustand store for filter state
   - analytics/tasks/page.tsx - Main dashboard with tabbed navigation

6. **Phase 6 (Complete):** Unit, integration, and E2E tests
   - Test fixtures created in services/gateway/**tests**/fixtures/task-analytics.fixtures.ts
   - 90 unit tests across 6 analytics services (all passing)
   - 13 integration tests for GraphQL API (all passing)
   - E2E tests with comprehensive Playwright test suite and manual test plan documentation

### File List

**Backend Services:**

- services/gateway/src/services/task-completion-analytics.service.ts
- services/gateway/src/services/overdue-analysis.service.ts
- services/gateway/src/services/velocity-trends.service.ts
- services/gateway/src/services/pattern-detection.service.ts
- services/gateway/src/services/delegation-analytics.service.ts
- services/gateway/src/services/roi-calculator.service.ts

**Workers:**

- services/gateway/src/workers/analytics-aggregation.worker.ts
- services/gateway/src/workers/pattern-analysis.worker.ts
- services/gateway/src/workers/roi-metrics.worker.ts

**GraphQL:**

- services/gateway/src/graphql/schema/task-analytics.graphql
- services/gateway/src/graphql/resolvers/task-analytics.resolvers.ts

**Frontend Components:**

- apps/web/src/components/analytics/CompletionTimeCharts.tsx
- apps/web/src/components/analytics/OverdueAnalysisPanel.tsx
- apps/web/src/components/analytics/VelocityTrendsChart.tsx
- apps/web/src/components/analytics/PatternDetectionPanel.tsx
- apps/web/src/components/analytics/DelegationAnalysisPanel.tsx
- apps/web/src/components/analytics/ROIDashboard.tsx
- apps/web/src/components/analytics/AnalyticsFilterBar.tsx
- apps/web/src/components/analytics/index.ts (updated)

**Frontend Hooks/Stores:**

- apps/web/src/hooks/useTaskAnalytics.ts
- apps/web/src/stores/taskAnalyticsStore.ts

**Pages:**

- apps/web/src/app/analytics/tasks/page.tsx

**Tests:**

- services/gateway/**tests**/fixtures/task-analytics.fixtures.ts
- services/gateway/src/services/task-completion-analytics.service.test.ts
- services/gateway/src/services/overdue-analysis.service.test.ts
- services/gateway/src/services/velocity-trends.service.test.ts
- services/gateway/src/services/pattern-detection.service.test.ts
- services/gateway/src/services/delegation-analytics.service.test.ts
- services/gateway/src/services/roi-calculator.service.test.ts
- services/gateway/**tests**/integration/task-analytics.test.ts
- tests/e2e/task-analytics.spec.ts

**Modified:**

- apps/web/src/components/layout/Sidebar.tsx (added Task Analytics nav link)
- packages/shared/types/src/task-analytics.ts (type definitions)
- packages/shared/types/src/index.ts (exports)
- packages/database/prisma/schema.prisma (analytics models)

---

## QA Results

### Review Date: 2025-12-03

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - The implementation is comprehensive, well-structured, and follows established patterns in the codebase. All 6 acceptance criteria are addressed with proper backend services, GraphQL API, frontend components, and test coverage.

**Architecture Highlights:**

- Clean separation between services (6 analytics services), workers (3 scheduled workers), and GraphQL resolvers
- Proper use of Redis caching with 15-minute TTL for performance
- Zustand state management for frontend following existing patterns
- Role-based access control (Partner/BusinessOwner) properly enforced at GraphQL resolver level

**Code Quality Observations:**

- Services follow consistent patterns with constructor injection for testability
- Proper TypeScript typing throughout with comprehensive type definitions
- Good error handling with GraphQL error codes
- Workers implement health checks, missed run detection, and graceful shutdown support

### Refactoring Performed

No refactoring required - implementation follows established patterns.

### Compliance Check

- Coding Standards: ✓ Follows TypeScript patterns, consistent naming, proper exports
- Project Structure: ✓ Files in correct locations per unified-project-structure.md
- Testing Strategy: ✓ Unit tests (90), Integration tests (13), E2E tests with manual plan
- All ACs Met: ✓ All 6 acceptance criteria have corresponding implementation and tests

### Improvements Checklist

- [x] Database schema models created for all 4 analytics tables
- [x] Type definitions exported from packages/shared/types
- [x] Backend services with Redis caching
- [x] Three workers for scheduled aggregation
- [x] GraphQL schema registered in schema/index.ts
- [x] Frontend dashboard with 7 tabs
- [x] Sidebar navigation link added
- [x] Unit tests for all 6 services
- [x] Integration tests for GraphQL API
- [x] E2E test suite created
- [ ] Consider adding data-testid attributes to frontend components for E2E test reliability
- [ ] Consider adding monitoring/alerting for worker health status

### Security Review

**Status: PASS**

- Role-based access properly enforced (Partner/BusinessOwner only for firm-wide analytics)
- Users can view their own delegation patterns without elevated roles
- Firm isolation enforced at service level via firmId filtering
- Date range validation prevents excessive data queries (365-day max)
- No sensitive data exposure in analytics responses

### Performance Considerations

**Status: PASS**

- Redis caching with 15-minute TTL reduces database load
- Pre-aggregated snapshots via daily worker avoid expensive real-time calculations
- Pagination support in GraphQL API (limit/offset with max 500)
- Database indexes on firmId, snapshotDate for analytics queries
- Worker runs during off-peak hours (2 AM, 3 AM, 4 AM)

### Files Modified During Review

No files modified during this review.

### Gate Status

Gate: **PASS** → docs/qa/gates/4.7-task-analytics-and-optimization.yml

### Recommended Status

**✓ Ready for Done** - All acceptance criteria implemented with comprehensive test coverage. Minor suggestions (data-testid attributes, monitoring) are non-blocking enhancements.
