# Story 1.6: Enhanced Partner Dashboard with Operational Focus

## Status
In Progress

## Story
**As a** law firm Partner,
**I want** my dashboard to prioritize operational oversight of supervised cases, tasks, and team workload,
**so that** I can effectively manage day-to-day operations before reviewing strategic KPIs.

## Acceptance Criteria
1. Partner dashboard shows supervised cases widget first (cases where partner is lead/supervisor, not just assigned)
2. My Tasks widget displays tasks from supervised cases with priority and deadline visibility
3. Firm Cases Overview widget displays:
   - At-risk cases (approaching deadlines)
   - High-value cases requiring attention
   - AI-detected patterns or anomalies
4. Firm Tasks Overview widget shows aggregate task insights across the firm
5. Employee Workload widget displays:
   - Daily and weekly utilization views based on task estimates
   - Visual indicators for over-utilization (>100%) and under-utilization (<50%)
   - Drill-down capability to see individual employee task breakdown
6. KPI widgets (firm KPIs, billable hours, case distribution, pending approvals) moved to separate Analytics section/tab
7. Navigation includes new "Analytics" section for accessing KPI dashboard
8. All new widgets support drag-and-drop rearrangement within dashboard grid
9. Widgets maintain collapsed/expanded state via Zustand store
10. Romanian language support maintained in all new widgets

## Tasks / Subtasks

- [x] **Task 1: Create New Widget Type Definitions** (AC: 1, 2, 3, 4, 5)
  - [x] Update `packages/shared/types/src/dashboard.ts` with new widget types:
    - `SupervisedCasesWidget` - extends `CaseListWidget` with supervisor-specific fields (supervisorId, teamSize, riskLevel)
    - `FirmCasesOverviewWidget` - new type with atRiskCases[], highValueCases[], aiInsights[] arrays
    - `FirmTasksOverviewWidget` - new type with taskMetrics, overdueCount, completionRate
    - `EmployeeWorkloadWidget` - new type with employeeUtilization[] array containing: employeeId, name, dailyUtilization%, weeklyUtilization%, taskCount, estimatedHours, status ('over' | 'optimal' | 'under')
  - [x] Add new widget types to `WidgetType` union: 'supervisedCases' | 'firmCasesOverview' | 'firmTasksOverview' | 'employeeWorkload'
  - [x] Update `DashboardWidget` discriminated union to include new types
  - [x] Export all new types from `packages/shared/types/src/index.ts`

- [x] **Task 2: Create Supervised Cases Widget** (AC: 1)
  - [x] Create `apps/web/src/components/dashboard/widgets/SupervisedCasesWidget.tsx`
  - [x] Display cases where current partner is supervisor/lead
  - [x] Show for each case:
    - Case number with clickable link to case workspace
    - Case title with client name
    - Team size indicator (number of assigned team members)
    - Status badge (Active, OnHold, etc.)
    - Risk level indicator (high/medium/low based on deadlines and activity)
    - Next deadline with urgency color coding
  - [x] Implement sorting: by risk level (high first), then by next deadline
  - [x] Add "View All Supervised Cases" link at bottom
  - [x] Use Card component from Story 1.1 and design tokens
  - [x] Support Romanian diacritics in case titles and client names

- [x] **Task 3: Create Firm Cases Overview Widget** (AC: 3)
  - [x] Create `apps/web/src/components/dashboard/widgets/FirmCasesOverviewWidget.tsx`
  - [x] Implement tabbed interface with 3 tabs:
    - "At Risk" - cases with approaching deadlines (<7 days) or overdue tasks
    - "High Value" - cases above certain monetary threshold with attention flags
    - "AI Insights" - AI-detected patterns, bottlenecks, or opportunities
  - [x] Display summary metrics at top:
    - Total active cases across firm
    - At-risk count with red badge
    - High-value count with gold badge
    - New AI insights count with blue badge
  - [x] Each tab shows list of relevant cases with:
    - Case number and title
    - Reason for inclusion (e.g., "Deadline in 3 days", "High value: €50,000")
    - Assigned partner/lead
    - Quick action button (e.g., "Review", "Assign")
  - [x] Use Radix UI Tabs for tabbed interface [Source: architecture/tech-stack.md]
  - [x] Implement smooth tab transitions with Tailwind CSS animations

- [x] **Task 4: Create Firm Tasks Overview Widget** (AC: 4)
  - [x] Create `apps/web/src/components/dashboard/widgets/FirmTasksOverviewWidget.tsx`
  - [x] Display aggregate task metrics:
    - Total active tasks across firm
    - Overdue tasks count with red badge
    - Tasks due today with orange badge
    - Tasks due this week with blue badge
    - Average completion rate (%) with trend indicator
  - [x] Show task breakdown by type (Research, Document Creation, etc.)
  - [x] Display top 5 priority tasks requiring partner attention
  - [x] Include "View Task Management" link to dedicated task section
  - [x] Use recharts for visualizing task breakdown by type [Source: architecture/tech-stack.md]

- [x] **Task 5: Create Employee Workload Widget** (AC: 5)
  - [x] Create `apps/web/src/components/dashboard/widgets/EmployeeWorkloadWidget.tsx`
  - [x] Implement view toggle: Daily / Weekly (button group at top)
  - [x] Display employee utilization data in table format:
    - Employee name with avatar
    - Utilization percentage bar (color-coded: green 50-100%, red >100%, yellow <50%)
    - Task count
    - Total estimated hours
    - Status indicator icon (⚠️ over-utilized, ✓ optimal, ⏸️ under-utilized)
  - [x] Sort by utilization % descending (over-utilized employees at top)
  - [x] Add collapsible detail row for each employee showing:
    - List of assigned tasks with estimates
    - Breakdown by task type
    - Available capacity calculation
  - [x] Calculate utilization based on:
    - Daily view: Sum of task estimates due today / 8 hours * 100%
    - Weekly view: Sum of task estimates due this week / 40 hours * 100%
  - [x] Include threshold indicators:
    - Over-utilization: >100% (red)
    - Optimal: 50-100% (green)
    - Under-utilization: <50% (yellow)
  - [x] Add "Rebalance Workload" action button for partners
  - [x] Support Romanian names with diacritics

- [x] **Task 6: Update Partner Dashboard Default Layout** (AC: 1, 2, 3, 4, 5, 8)
  - [x] Update `apps/web/src/stores/dashboard.store.ts` Partner layout
  - [x] New default layout order:
    1. `supervised-cases` - Supervised Cases Widget (x: 0, y: 0, w: 6, h: 5)
    2. `my-tasks` - My Tasks Widget (x: 6, y: 0, w: 6, h: 5)
    3. `firm-cases-overview` - Firm Cases Overview (x: 0, y: 5, w: 8, h: 5)
    4. `firm-tasks-overview` - Firm Tasks Overview (x: 8, y: 5, w: 4, h: 5)
    5. `employee-workload` - Employee Workload (x: 0, y: 10, w: 12, h: 6)
    6. `ai-suggestions` - AI Suggestions (x: 0, y: 16, w: 12, h: 4)
  - [x] Remove KPI widgets from default Partner layout:
    - Remove `firm-kpis`
    - Remove `billable-hours-chart`
    - Remove `case-distribution`
    - Remove `pending-approvals` (or decide if this stays in operational view)
  - [x] Add migration logic to update existing user layouts from old to new structure
  - [x] Ensure backward compatibility for users who have customized layouts

- [x] **Task 7: Create Analytics Section with KPI Dashboard** (AC: 6, 7)
  - [x] Create `apps/web/src/app/analytics/page.tsx` (new Analytics page)
  - [x] Move KPI widgets to Analytics page:
    - Firm KPIs widget
    - Billable Hours Chart widget
    - Case Distribution widget
    - Pending Approvals widget (if moved from operational dashboard)
  - [x] Create Analytics-specific layout with larger widget sizes for data visualization
  - [x] Implement separate Zustand store slice for Analytics layout: `analyticsLayout: WidgetPosition[]`
  - [x] Add Analytics navigation item to sidebar navigation in `apps/web/src/components/layout/Sidebar.tsx`
  - [x] Update `packages/shared/types/src/navigation.ts` to add 'analytics' to `currentSection` type
  - [x] Style Analytics page header with title "Analytics & KPIs" and description
  - [x] Add date range selector for filtering KPI data (mockup for now)
  - [x] Ensure only Partner role can access Analytics section (role-based rendering)

- [x] **Task 8: Update Navigation Store and Sidebar** (AC: 7)
  - [x] Update `apps/web/src/stores/navigation.store.ts`:
    - Add 'analytics' to NavigationState.currentSection type
  - [x] Update `apps/web/src/components/layout/Sidebar.tsx`:
    - Add Analytics navigation item with chart-bar icon
    - Position after Dashboard, before Cases
    - Set roles: ['Partner'] only (associates and paralegals don't see it)
  - [x] Update active section highlighting to include Analytics
  - [x] Add navigation transition animation when switching between Dashboard and Analytics

- [ ] **Task 9: Create Test Data Factories for New Widgets** (AC: All)
  - [ ] Update `packages/shared/test-utils/src/factories/dashboard.factory.ts`:
    - Add `createSupervisedCasesWidget()` factory function
    - Add `createFirmCasesOverviewWidget()` factory with mock at-risk cases, high-value cases, AI insights
    - Add `createFirmTasksOverviewWidget()` factory with task metrics
    - Add `createEmployeeWorkloadWidget()` factory with employee utilization data
  - [ ] Create mock data generators:
    - `generateEmployeeUtilization(count: number)` - returns array of employee utilization objects
    - `generateAtRiskCases(count: number)` - returns cases with approaching deadlines
    - `generateHighValueCases(count: number)` - returns cases with high monetary value
    - `generateAIInsights(count: number)` - returns mock AI insights
  - [ ] Ensure all factories support Romanian names and diacritics
  - [ ] Write unit tests for all new factory functions (80% coverage threshold)

- [ ] **Task 10: Create Storybook Stories for New Widgets** (AC: All)
  - [ ] Create `apps/web/src/components/dashboard/widgets/SupervisedCasesWidget.stories.tsx`
    - Show widget with 0, 3, 10, 20+ supervised cases
    - Demonstrate risk levels (high, medium, low)
    - Show all status types (Active, OnHold, etc.)
  - [ ] Create `apps/web/src/components/dashboard/widgets/FirmCasesOverviewWidget.stories.tsx`
    - Show all 3 tabs (At Risk, High Value, AI Insights)
    - Demonstrate empty states for each tab
    - Show populated states with various case counts
  - [ ] Create `apps/web/src/components/dashboard/widgets/FirmTasksOverviewWidget.stories.tsx`
    - Show task metrics with different completion rates
    - Demonstrate task breakdown visualization
  - [ ] Create `apps/web/src/components/dashboard/widgets/EmployeeWorkloadWidget.stories.tsx`
    - Show Daily and Weekly views
    - Demonstrate over-utilization, optimal, and under-utilization states
    - Show expanded detail rows
  - [ ] Create Analytics page story: `apps/web/src/app/analytics/page.stories.tsx`
  - [ ] Include accessibility notes in all stories

- [ ] **Task 11: Write Unit Tests for New Components** (AC: All)
  - [ ] Create unit tests for SupervisedCasesWidget:
    - Test rendering with various case counts
    - Test sorting by risk level and deadline
    - Test Romanian diacritics in case titles
    - Test click handlers for case links
  - [ ] Create unit tests for FirmCasesOverviewWidget:
    - Test tab switching functionality
    - Test rendering of all 3 tab contents
    - Test summary metrics calculation
    - Test empty states
  - [ ] Create unit tests for FirmTasksOverviewWidget:
    - Test task metrics display
    - Test chart rendering with mock data
  - [ ] Create unit tests for EmployeeWorkloadWidget:
    - Test Daily/Weekly view toggle
    - Test utilization percentage calculations
    - Test color coding (red/green/yellow)
    - Test detail row expansion
    - Test sorting by utilization
  - [ ] Create integration test for Analytics page:
    - Test navigation from Dashboard to Analytics
    - Test role-based access (Partner only)
    - Test KPI widget rendering
  - [ ] Achieve minimum 80% test coverage for all new components [Source: architecture/testing-strategy.md]

- [ ] **Task 12: Update Dashboard Store Tests** (AC: 9)
  - [ ] Update `apps/web/src/stores/dashboard.store.test.ts`:
    - Test new Partner layout structure
    - Test Analytics layout state management
    - Test layout migration logic
    - Test backward compatibility
  - [ ] Test widget collapse/expand for new widgets
  - [ ] Test localStorage persistence of new layout structure

- [ ] **Task 13: Create E2E Tests for Partner Dashboard** (AC: All)
  - [ ] Create `tests/e2e/dashboard/partner-operational-dashboard.spec.ts`:
    - Test Partner dashboard loads with new operational layout
    - Test all new widgets render correctly
    - Test drag-and-drop rearrangement of new widgets
    - Test widget collapse/expand functionality
    - Test navigation to Analytics section
    - Test role switching preserves widget states
  - [ ] Create `tests/e2e/analytics/analytics-page.spec.ts`:
    - Test Analytics page loads only for Partner role
    - Test KPI widgets render correctly
    - Test Associates/Paralegals cannot access Analytics page (redirect to Dashboard)
  - [ ] Test Romanian diacritics render correctly in all widgets

- [ ] **Task 14: Update Documentation** (AC: All)
  - [ ] Update README.md with information about new Partner dashboard structure
  - [ ] Document Analytics section and role-based access
  - [ ] Add dashboard customization guide to CONTRIBUTING.md
  - [ ] Document widget types and how to create new widgets
  - [ ] Include screenshots of new Partner dashboard layout
  - [ ] Document employee workload calculation methodology

- [ ] **Task 15: Accessibility Testing** (AC: All)
  - [ ] Run axe-core accessibility tests on all new widgets
  - [ ] Test keyboard navigation for:
    - Tab switching in FirmCasesOverviewWidget
    - Daily/Weekly toggle in EmployeeWorkloadWidget
    - Detail row expansion in EmployeeWorkloadWidget
    - Navigation to Analytics section
  - [ ] Test screen reader compatibility for:
    - Utilization percentage announcements
    - Risk level indicators
    - At-risk case alerts
  - [ ] Ensure all interactive elements have proper ARIA labels
  - [ ] Test focus management in widget interactions

- [ ] **Task 16: Performance Optimization** (AC: 5, 8)
  - [ ] Optimize EmployeeWorkloadWidget rendering for 50+ employees:
    - Implement virtualization for employee list (react-window)
    - Lazy load detail rows on expansion
    - Debounce view toggle (Daily/Weekly) to prevent rapid re-renders
  - [ ] Optimize FirmCasesOverviewWidget:
    - Lazy load tab content (only render active tab)
    - Memoize case filtering and sorting logic
  - [ ] Test dashboard performance with Lighthouse CI:
    - Target Performance score >= 90
    - First Contentful Paint < 1.5s
    - Time to Interactive < 3.5s
  - [ ] Monitor bundle size impact of new widgets (should not exceed 50KB increase)

- [ ] **Task 17: Verification and Cleanup** (AC: All)
  - [ ] Verify all 10 acceptance criteria are met
  - [ ] Run full test suite: `pnpm test:coverage`
  - [ ] Verify 80% test coverage maintained
  - [ ] Run E2E tests: `pnpm test:e2e`
  - [ ] Run accessibility tests: `pnpm test:a11y`
  - [ ] Run Storybook build: `pnpm build-storybook`
  - [ ] Test dashboard in all 3 browsers (Chromium, Firefox, WebKit)
  - [ ] Test responsive behavior on mobile/tablet
  - [ ] Test with Romanian language content
  - [ ] Document any known issues or limitations

## Dev Notes

### Previous Story Insights

**From Story 1.4** [Source: docs/stories/1.4.story.md]:
- Dashboard mockups created for all roles with drag-and-drop functionality
- Partner dashboard initially focused on strategic KPIs (firm KPIs, billable hours, case distribution, pending approvals)
- React Grid Layout integrated for widget rearrangement
- Dashboard layouts stored in Zustand with localStorage persistence
- This story refactors Partner dashboard from strategic KPI focus to operational oversight focus

**From Story 1.3** [Source: docs/stories/1.3.story.md]:
- Navigation structure established with sidebar and role switching
- Navigation sections: Dashboard, Cases, Documents, Tasks, Communications, Time Tracking, Reports
- This story adds new "Analytics" section for KPI dashboard

**From Story 1.1** [Source: docs/stories/1.1.story.md]:
- Design tokens and component library available
- Card, Button, Tooltip components can be reused
- Romanian diacritic support already established

**From Story 1.2** [Source: docs/stories/1.2.story.md]:
- Testing infrastructure in place with 80% coverage requirement
- Factory pattern established for test data generation
- Accessibility testing with axe-core configured

### Tech Stack Considerations

**State Management** [Source: architecture/tech-stack.md]:
- Zustand 4.5+ for dashboard and analytics layout state
- Persist middleware for localStorage caching

**UI Components** [Source: architecture/tech-stack.md]:
- Radix UI for accessible primitives (Tabs, Dialog, DropdownMenu)
- Tailwind CSS for styling with design tokens
- recharts for data visualization (task breakdown, utilization charts)

**Testing** [Source: architecture/testing-strategy.md]:
- Jest for unit tests (80% coverage minimum)
- React Testing Library for component tests
- Playwright for E2E tests
- axe-core for accessibility validation

### Data Models

**Employee Utilization Calculation**:
- **Daily Utilization**: `(Sum of task estimates due today in hours / 8 hours) * 100%`
- **Weekly Utilization**: `(Sum of task estimates due this week in hours / 40 hours) * 100%`
- **Thresholds**:
  - Over-utilization: >100% (red indicator)
  - Optimal: 50-100% (green indicator)
  - Under-utilization: <50% (yellow indicator)

**Supervised Cases**:
- Cases where `supervisorId` or `leadPartnerId` matches current partner's user ID
- Different from assigned cases (where user is team member but not lead)

**At-Risk Cases**:
- Cases with deadlines within 7 days
- Cases with overdue tasks
- Cases with no recent activity (>14 days)
- Cases flagged by AI as requiring attention

**High-Value Cases**:
- Cases with monetary value above threshold (e.g., €25,000)
- Cases marked as strategic priority
- Cases with VIP clients

### Romanian Language Support

All new widgets must support Romanian diacritics (ă, â, î, ș, ț) in:
- Case titles and client names
- Employee names
- Task descriptions
- AI insight messages
- Widget titles and labels

Test string: "Șeful a vândut o sticlă în oraș și țară"

### Architecture Considerations

**Analytics Section Routing**:
- Route: `/analytics`
- Role-based access control: Partner only
- Associates/Paralegals attempting to access should be redirected to dashboard with info message

**Layout Migration Strategy**:
- Detect old Partner layout structure (presence of 'firm-kpis' widget)
- If old layout detected, replace with new operational layout
- Preserve user customizations where possible (widget positions)
- Log migration event for analytics

**Widget Loading Strategy**:
- Lazy load widget components to reduce initial bundle size
- Use React.lazy() and Suspense for code splitting
- Show loading skeleton while widget data fetches
- Implement error boundaries for individual widget failures

### Performance Budgets

- **Bundle Size**: New widgets should not exceed 50KB total (gzipped)
- **Rendering**: Initial paint should occur within 1.5s
- **Data Fetching**: Widget data should load within 2s
- **Interactions**: Widget interactions (collapse, expand, tab switch) should respond within 100ms

### Accessibility Requirements

- **WCAG AA Compliance**: All new widgets must pass axe-core with zero violations
- **Keyboard Navigation**: All interactive elements accessible via keyboard
- **Screen Readers**: Proper ARIA labels for utilization percentages, risk indicators, status badges
- **Focus Management**: Focus indicator visible on all interactive elements
- **Color Contrast**: Utilization color coding must meet 4.5:1 contrast ratio

### Known Dependencies

- Employee workload calculation requires task time estimates (may need backend API)
- AI insights require AI service integration (mockup for this story)
- High-value case threshold may need configuration (hardcode €25,000 for now)
- Supervised cases require case data model to include `supervisorId` field

### Testing Strategy

**Unit Tests** (70% of tests):
- Widget rendering with various data states
- Utilization calculations
- Sorting and filtering logic
- State management actions

**Integration Tests** (20% of tests):
- Dashboard layout management
- Navigation between Dashboard and Analytics
- Widget drag-and-drop with state persistence

**E2E Tests** (10% of tests):
- Complete user workflow: login as Partner, view dashboard, rearrange widgets, navigate to Analytics
- Role-based access control for Analytics
- Cross-browser compatibility

### Security Considerations

- Ensure Analytics section enforces role-based access on backend (not just frontend)
- Employee workload data should respect privacy settings
- Case data visibility should respect case permissions
- Widget actions (e.g., "Rebalance Workload") should have proper authorization checks

## Testing

### Test Coverage Requirements

- **Unit Tests**: Minimum 80% coverage for all new components
- **Integration Tests**: Dashboard layout state management, navigation flows
- **E2E Tests**: Complete user workflows for Partner role
- **Accessibility Tests**: Zero violations on axe-core for all new widgets

### Test Data Requirements

- Mock employee utilization data with over-utilization, optimal, and under-utilization scenarios
- Mock supervised cases with various risk levels and deadlines
- Mock at-risk, high-value, and AI insight data for firm overview widgets
- Mock task data with different types, priorities, and statuses

### Test Files to Create

- `apps/web/src/components/dashboard/widgets/SupervisedCasesWidget.test.tsx`
- `apps/web/src/components/dashboard/widgets/FirmCasesOverviewWidget.test.tsx`
- `apps/web/src/components/dashboard/widgets/FirmTasksOverviewWidget.test.tsx`
- `apps/web/src/components/dashboard/widgets/EmployeeWorkloadWidget.test.tsx`
- `apps/web/src/app/analytics/page.test.tsx`
- `tests/e2e/dashboard/partner-operational-dashboard.spec.ts`
- `tests/e2e/analytics/analytics-page.spec.ts`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-13 | 1.0 | Initial story creation based on user requirements for Partner dashboard refactoring | Mary (Business Analyst) |
| 2025-11-13 | 1.1 | Tasks 1-8 completed: Core implementation (widgets, layouts, Analytics page, navigation) | James (Dev Agent - Claude Sonnet 4.5) |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used
- Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- None

### Completion Notes List
- **Tasks 1-8 Complete**: Core implementation finished including all 4 new widgets, dashboard layout updates, Analytics page, and navigation changes
- **Migration Logic**: Implemented automatic migration from old Partner KPI-based layout to new operational layout with backward compatibility
- **Romanian Language Support**: All widgets include proper Romanian diacritic support (ă, â, î, ș, ț)
- **Accessibility**: Used Radix UI primitives for accessible tabbed interfaces and keyboard navigation
- **Type Safety**: All new widget types added to discriminated union with full TypeScript support
- **Remaining Work**: Tasks 9-17 (testing, documentation, optimization) still pending

### File List
#### Created
- `apps/web/src/components/dashboard/widgets/SupervisedCasesWidget.tsx`
- `apps/web/src/components/dashboard/widgets/FirmCasesOverviewWidget.tsx`
- `apps/web/src/components/dashboard/widgets/FirmTasksOverviewWidget.tsx`
- `apps/web/src/components/dashboard/widgets/EmployeeWorkloadWidget.tsx`
- `apps/web/src/app/analytics/page.tsx`

#### Modified
- `packages/shared/types/src/dashboard.ts` - Added SupervisedCasesWidget, FirmCasesOverviewWidget, FirmTasksOverviewWidget, EmployeeWorkloadWidget types + analyticsLayout to DashboardState
- `packages/shared/types/src/navigation.ts` - Added 'analytics' to NavigationSection union
- `apps/web/src/stores/dashboard.store.ts` - Updated Partner layout, added analyticsLayout, implemented migration logic
- `apps/web/src/components/layout/Sidebar.tsx` - Added Analytics navigation item (Partner-only)
- `docs/stories/1.5.5.story.md` - Updated task completion status

## QA Results
*This section will be populated by the QA agent during review*
