# Story 2.5: Microsoft Graph API Integration Foundation

## Status
Ready for development

## Story

**As a** platform developer,
**I want** Microsoft Graph API integrated,
**so that** we can access Outlook, OneDrive, and Calendar data.

## Acceptance Criteria

1. Microsoft Graph client configured with app-level permissions
2. Token management implements refresh token flow automatically
3. Rate limiting middleware prevents exceeding API quotas
4. Webhook subscriptions created for email and file change notifications
5. Error handling includes retry logic for transient failures
6. Graph API responses cached in Redis for performance

## Tasks / Subtasks

### Phase 1: Microsoft Graph Client Configuration (AC: 1)

- [ ] **Task 1: Install Microsoft Graph SDK and Configure Client** (AC: 1)
  - [ ] Install `@microsoft/microsoft-graph-client@^3.0.0` package
  - [ ] Install `@microsoft/microsoft-graph-types` for TypeScript types
  - [ ] Create `services/gateway/src/config/graph.config.ts` for Graph API configuration
  - [ ] Configure Graph client with authentication provider using existing MSAL config
  - [ ] Set base URL to `https://graph.microsoft.com/v1.0`
  - [ ] Configure default timeout and retry settings
  - [ ] Write unit tests for graph.config.ts (100% coverage)

- [ ] **Task 2: Configure Application Permissions in Azure AD** (AC: 1)
  - [ ] Document required application permissions (Mail.Read, Mail.Send, Files.Read.All, Files.ReadWrite.All, Calendars.Read, Calendars.ReadWrite)
  - [ ] Document delegated permissions for user context operations
  - [ ] Update Azure AD app registration documentation with new permissions
  - [ ] Note: Manual Azure Portal configuration required by admin

- [ ] **Task 3: Create Graph API Service Layer** (AC: 1)
  - [ ] Create `services/gateway/src/services/graph.service.ts`
  - [ ] Implement `GraphService` class with authentication provider integration
  - [ ] Implement `getAuthenticatedClient(accessToken: string)` for user-delegated calls
  - [ ] Implement `getAppClient()` for application-level calls
  - [ ] Add proper TypeScript types from @microsoft/microsoft-graph-types
  - [ ] Write unit tests for GraphService (100% coverage)

### Phase 2: Token Management Enhancement (AC: 2)

- [ ] **Task 4: Enhance Token Refresh Logic for Graph API** (AC: 2)
  - [ ] Review existing token refresh in `services/gateway/src/routes/auth.routes.ts` (Task 12 from Story 2.4)
  - [ ] Ensure refresh token flow automatically renews Graph API access tokens
  - [ ] Implement automatic token refresh when Graph API returns 401 Unauthorized
  - [ ] Update session with new Graph API access token after refresh
  - [ ] Add token expiry checking middleware for Graph API calls
  - [ ] Write integration tests for automatic token refresh (3+ test cases)

- [ ] **Task 5: Implement Token Storage and Retrieval** (AC: 2)
  - [ ] Extend `UserSessionData` interface to include Graph API token metadata
  - [ ] Store Graph API access token in Redis session (already exists from Story 2.4)
  - [ ] Implement `getGraphToken(userId: string)` helper method
  - [ ] Implement token expiry validation before Graph API calls
  - [ ] Write unit tests for token storage and retrieval (100% coverage)

### Phase 3: Rate Limiting Middleware (AC: 3)

- [ ] **Task 6: Implement Rate Limiting Middleware** (AC: 3)
  - [ ] Create `services/gateway/src/middleware/rate-limit.middleware.ts`
  - [ ] Implement sliding window rate limiter using Redis
  - [ ] Configure rate limit: 10,000 requests per 10 minutes per app (from Microsoft Graph limits)
  - [ ] Track request counts in Redis with 10-minute TTL
  - [ ] Return 429 Too Many Requests with Retry-After header when limit exceeded
  - [ ] Implement per-user rate limiting (100 requests/min per user) as secondary protection
  - [ ] Write unit tests for rate limiter (100% coverage)

- [ ] **Task 7: Integrate Rate Limiter with Graph Service** (AC: 3)
  - [ ] Add rate limiting middleware to all Graph API routes
  - [ ] Implement rate limit headers (X-RateLimit-Remaining, X-RateLimit-Reset)
  - [ ] Log rate limit violations for monitoring
  - [ ] Write integration tests for rate limiting (5+ test cases including limit exceeded scenarios)

### Phase 4: Webhook Subscriptions (AC: 4)

- [ ] **Task 8: Create Webhook Infrastructure** (AC: 4)
  - [ ] Create `services/gateway/src/services/webhook.service.ts`
  - [ ] Implement `createSubscription(resource: string, changeType: string)` method
  - [ ] Configure webhook notification URL endpoint: `POST /webhooks/graph`
  - [ ] Implement subscription renewal logic (Graph subscriptions expire every 3 days)
  - [ ] Store active subscriptions in database with expiry tracking
  - [ ] Write unit tests for webhook service (100% coverage)

- [ ] **Task 9: Implement Email Change Notifications** (AC: 4)
  - [ ] Create subscription for `/me/messages` resource with changeType: created, updated
  - [ ] Implement webhook endpoint handler for email notifications
  - [ ] Validate webhook requests using validation token
  - [ ] Parse notification payload and extract message details
  - [ ] Queue email processing tasks (for future stories)
  - [ ] Write integration tests for email webhooks (4+ test cases)

- [ ] **Task 10: Implement File Change Notifications** (AC: 4)
  - [ ] Create subscription for `/me/drive/root` resource with changeType: created, updated, deleted
  - [ ] Implement webhook endpoint handler for OneDrive file changes
  - [ ] Parse file change notifications and extract file metadata
  - [ ] Queue file sync tasks (for future stories)
  - [ ] Write integration tests for file webhooks (4+ test cases)

- [ ] **Task 11: Implement Subscription Renewal Worker** (AC: 4)
  - [ ] Create background worker to renew expiring subscriptions
  - [ ] Query database for subscriptions expiring within 24 hours
  - [ ] Call Graph API PATCH /subscriptions/{id} to extend expiration
  - [ ] Update database with new expiration timestamp
  - [ ] Log renewal successes and failures
  - [ ] Write unit tests for renewal worker (100% coverage)

### Phase 5: Error Handling and Retry Logic (AC: 5)

- [ ] **Task 12: Implement Graph API Error Handler** (AC: 5)
  - [ ] Create `services/gateway/src/utils/graph-error-handler.ts`
  - [ ] Map Graph API error codes to meaningful error messages
  - [ ] Implement error categorization: transient (500, 503, 429) vs permanent (400, 401, 403)
  - [ ] Add structured logging for all Graph API errors
  - [ ] Return consistent error format to clients
  - [ ] Write unit tests for error handler (100% coverage for all error codes)

- [ ] **Task 13: Implement Exponential Backoff Retry Logic** (AC: 5)
  - [ ] Create `services/gateway/src/utils/retry.util.ts`
  - [ ] Implement exponential backoff: initial 1s, max 32s, max 5 retries
  - [ ] Only retry transient errors (429, 500, 503, network timeouts)
  - [ ] Respect Retry-After header from Graph API 429 responses
  - [ ] Add circuit breaker pattern for repeated failures (open circuit after 10 consecutive failures)
  - [ ] Write unit tests for retry logic (100% coverage)

- [ ] **Task 14: Integrate Error Handling with Graph Service** (AC: 5)
  - [ ] Wrap all Graph API calls with error handler and retry logic
  - [ ] Update `GraphService` methods to use retry utility
  - [ ] Add timeout handling (default 30s per request)
  - [ ] Implement fallback mechanisms where applicable
  - [ ] Write integration tests for error scenarios (network failures, timeouts, 429, 500, 503)

### Phase 6: Response Caching (AC: 6)

- [ ] **Task 15: Implement Graph Response Caching Layer** (AC: 6)
  - [ ] Create `services/gateway/src/middleware/cache.middleware.ts`
  - [ ] Implement Redis caching for GET requests to Graph API
  - [ ] Configure cache TTL based on resource type:
    - User profile: 1 hour
    - Calendar events: 5 minutes
    - File metadata: 15 minutes
    - Email messages: 1 minute
  - [ ] Implement cache key generation from request URL and user ID
  - [ ] Add cache invalidation on POST/PUT/DELETE operations
  - [ ] Write unit tests for cache middleware (100% coverage)

- [ ] **Task 16: Integrate Caching with Graph Service** (AC: 6)
  - [ ] Add caching middleware to Graph API routes
  - [ ] Implement cache-control headers (Cache-Control, ETag)
  - [ ] Add X-Cache header to responses (HIT or MISS)
  - [ ] Implement manual cache invalidation endpoint for admin: `POST /admin/cache/invalidate`
  - [ ] Monitor cache hit rate and log metrics
  - [ ] Write integration tests for caching (6+ test cases: cache miss, cache hit, invalidation)

### Phase 7: Testing and Documentation (All ACs)

- [ ] **Task 17: Integration Tests for Graph API Operations**
  - [ ] Create `services/gateway/__tests__/integration/graph-api.integration.test.ts`
  - [ ] Test user profile retrieval via Graph API
  - [ ] Test email listing and sending via Graph API
  - [ ] Test OneDrive file operations via Graph API
  - [ ] Test calendar event retrieval via Graph API
  - [ ] Test webhook subscription creation and renewal
  - [ ] Achieve 80%+ integration test coverage

- [ ] **Task 18: Create Graph API Service Documentation**
  - [ ] Document Graph API service architecture in `services/gateway/README.md`
  - [ ] Document rate limiting configuration and monitoring
  - [ ] Document webhook setup and subscription management
  - [ ] Document caching strategy and invalidation rules
  - [ ] Document error handling patterns and retry logic
  - [ ] Create runbook for common Graph API issues

- [ ] **Task 19: Performance Testing and Optimization**
  - [ ] Test Graph API response times under load
  - [ ] Validate rate limiting prevents quota exhaustion
  - [ ] Verify cache hit rates meet performance targets (>60% for user profile calls)
  - [ ] Test webhook notification handling latency (<500ms processing time)
  - [ ] Document performance baselines and optimization recommendations

## Dev Notes

### Previous Story Insights

**From Story 2.4 Completion:**
- Authentication infrastructure is complete with MSAL configuration in `services/gateway/src/config/auth.config.ts`
- Token refresh flow already implemented in `services/gateway/src/routes/auth.routes.ts` (Task 12)
- Redis session store configured with 7-day TTL in `services/gateway/src/config/session.config.ts`
- JWT service exists at `services/gateway/src/services/jwt.service.ts`
- User service with Graph API integration at `services/gateway/src/services/user.service.ts` includes `fetchUserProfileFromGraph()` method
- Error handling patterns established: Graph API failures with fallback logic, network errors and timeouts
- Session structure includes: userId, email, role, status, firmId, azureAdId, accessToken, refreshToken, accessTokenExpiry
- All dependencies installed: `@azure/msal-node@^2.0.0`, `express-session@^1.17.0`, `connect-redis@^7.0.0`

**Key Learnings:**
- Graph API `/me` endpoint already used successfully in Story 2.4
- Token refresh mechanism can be extended for Graph API token management
- Redis already configured and operational for session and caching needs
- Error handling patterns can be reused: fallback logic for API failures, retry on network errors

### Technical Architecture

#### Microsoft Graph API Configuration
[Source: architecture/external-apis.md#microsoft-graph-api]

**Base URL:** `https://graph.microsoft.com/v1.0`

**Authentication:** OAuth 2.0 with application and delegated permissions

**Rate Limits:** 10,000 requests per 10 minutes per app

**Key Endpoints:**
- `GET /me` - Get current user profile (already implemented in Story 2.4)
- `GET /users/{id}` - Retrieve user information
- `GET /me/messages` - Read emails
- `POST /me/messages` - Send emails
- `POST /subscriptions` - Create webhooks for change notifications
- `GET /drives/{drive-id}/items/{item-id}` - OneDrive file operations
- `PUT /drives/{drive-id}/items/{item-id}/content` - Upload document to OneDrive
- `GET /drives/{drive-id}/items/{item-id}/versions` - Get file version history

**Required Permissions:**
- Application Permissions: `Mail.Read`, `Mail.Send`, `Files.Read.All`, `Files.ReadWrite.All`, `Calendars.Read`, `Calendars.ReadWrite`
- Delegated Permissions: `User.Read`, `Mail.Read`, `Mail.Send`, `Files.ReadWrite`, `Calendars.ReadWrite`

#### Technology Stack
[Source: architecture/tech-stack.md]

**Backend Runtime:** Node.js 20 LTS with TypeScript 5.3+

**Backend Framework:** Express 4.19+

**Authentication:** MSAL 3.0+ (already installed: `@azure/msal-node@^2.0.0`)

**Cache:** Redis 7.2+ (already configured from Story 2.4)

**Required New Dependencies:**
- `@microsoft/microsoft-graph-client@^3.0.0` - Graph SDK client library
- `@microsoft/microsoft-graph-types@^2.40.0` - TypeScript type definitions for Graph API
- `@types/microsoft-graph` - Additional type definitions if needed

#### Project Structure
[Source: architecture/unified-project-structure.md]

**Service Location:** `services/gateway/`

**Shared Types Location:** `packages/shared/types/`

**Expected File Structure:**
```
services/gateway/
├── src/
│   ├── config/
│   │   ├── auth.config.ts (EXISTS from Story 2.4)
│   │   ├── session.config.ts (EXISTS from Story 2.4)
│   │   └── graph.config.ts (NEW - Task 1)
│   ├── services/
│   │   ├── auth.service.ts (EXISTS from Story 2.4)
│   │   ├── jwt.service.ts (EXISTS from Story 2.4)
│   │   ├── user.service.ts (EXISTS from Story 2.4)
│   │   ├── graph.service.ts (NEW - Task 3)
│   │   └── webhook.service.ts (NEW - Task 8)
│   ├── middleware/
│   │   ├── auth.middleware.ts (EXISTS from Story 2.4)
│   │   ├── session.middleware.ts (EXISTS from Story 2.4)
│   │   ├── rate-limit.middleware.ts (NEW - Task 6)
│   │   └── cache.middleware.ts (NEW - Task 15)
│   ├── utils/
│   │   ├── graph-error-handler.ts (NEW - Task 12)
│   │   └── retry.util.ts (NEW - Task 13)
│   ├── routes/
│   │   ├── auth.routes.ts (EXISTS from Story 2.4)
│   │   └── webhooks.routes.ts (NEW - Task 9)
│   └── types/
│       └── graph.types.ts (NEW - Task 3)
└── __tests__/
    ├── config/
    │   └── graph.config.test.ts (NEW - Task 1)
    ├── services/
    │   ├── graph.service.test.ts (NEW - Task 3)
    │   └── webhook.service.test.ts (NEW - Task 8)
    ├── middleware/
    │   ├── rate-limit.middleware.test.ts (NEW - Task 6)
    │   └── cache.middleware.test.ts (NEW - Task 15)
    ├── utils/
    │   ├── graph-error-handler.test.ts (NEW - Task 12)
    │   └── retry.util.test.ts (NEW - Task 13)
    └── integration/
        └── graph-api.integration.test.ts (NEW - Task 17)
```

#### Redis Caching Strategy
[Source: architecture/external-apis.md#microsoft-graph-api + Story 2.4 completion notes]

**Redis Connection:** Already configured in `services/gateway/src/config/session.config.ts`

**Cache Key Pattern:** `graph:{userId}:{resource}:{resourceId}`

**Cache TTL by Resource Type:**
- User profile (`/me`): 3600 seconds (1 hour)
- Calendar events (`/me/calendar/events`): 300 seconds (5 minutes)
- File metadata (`/drives/.../items`): 900 seconds (15 minutes)
- Email messages (`/me/messages`): 60 seconds (1 minute)

**Cache Invalidation Triggers:**
- Webhook notifications (email/file changes)
- POST/PUT/DELETE operations
- Manual admin invalidation

#### Rate Limiting Implementation
[Source: architecture/external-apis.md#microsoft-graph-api]

**Microsoft Graph Rate Limits:**
- 10,000 requests per 10 minutes per application
- Rate limit headers: `x-ms-ratelimit-remaining-requests`, `x-ms-ratelimit-reset-after`

**Implementation Strategy:**
- Use Redis sliding window counter with 10-minute TTL
- Track global app-level request count
- Implement per-user limit as secondary protection (100 requests/min per user)
- Return 429 Too Many Requests when limit exceeded
- Include Retry-After header in 429 responses
- Log all rate limit violations for monitoring

#### Webhook Subscriptions
[Source: architecture/external-apis.md#microsoft-graph-api]

**Subscription Lifecycle:**
- Subscriptions expire every 3 days (4320 minutes)
- Renewal required via PATCH /subscriptions/{id}
- Background worker checks expiring subscriptions every hour
- Renew subscriptions 24 hours before expiry

**Webhook Endpoint Requirements:**
- Validation: Return validation token on subscription creation
- Notification URL must be HTTPS
- Process notifications within 30 seconds to avoid timeout
- Return 202 Accepted for async processing

**Resources to Subscribe:**
1. Email notifications: `/me/messages` (changeType: created, updated)
2. File notifications: `/me/drive/root` (changeType: created, updated, deleted)

**Webhook Payload Structure:**
```json
{
  "value": [
    {
      "subscriptionId": "uuid",
      "clientState": "optional-secret",
      "changeType": "created",
      "resource": "me/messages/AAMkADk...",
      "resourceData": {
        "id": "AAMkADk...",
        "@odata.type": "#Microsoft.Graph.Message"
      }
    }
  ]
}
```

#### Error Handling and Retry Logic
[Source: architecture/coding-standards.md + architecture/external-apis.md]

**Error Categories:**
- **Transient Errors (Retry):** 429 (Rate Limit), 500 (Server Error), 503 (Service Unavailable), Network Timeouts
- **Permanent Errors (No Retry):** 400 (Bad Request), 401 (Unauthorized), 403 (Forbidden), 404 (Not Found)

**Retry Strategy:**
- Exponential backoff: 1s, 2s, 4s, 8s, 16s, 32s (max 5 retries)
- Respect Retry-After header from 429 responses
- Circuit breaker: Open circuit after 10 consecutive failures, half-open after 60s

**Error Response Format:**
```typescript
interface GraphApiError {
  code: string;
  message: string;
  innerError?: {
    code: string;
    date: string;
    'request-id': string;
    'client-request-id': string;
  };
}
```

**Common Graph API Error Codes:**
- `InvalidAuthenticationToken` - Access token expired or invalid → Trigger token refresh
- `Throttled` - Rate limit exceeded → Backoff and retry with Retry-After
- `ServiceNotAvailable` - Temporary outage → Exponential backoff retry
- `generalException` - Unexpected error → Log and return 500

#### Token Management
[Source: Story 2.4 completion notes + architecture/external-apis.md]

**Existing Token Infrastructure (from Story 2.4):**
- MSAL configuration: `services/gateway/src/config/auth.config.ts`
- Token refresh endpoint: `POST /auth/refresh` in `services/gateway/src/routes/auth.routes.ts`
- Session includes: accessToken, refreshToken, accessTokenExpiry
- Automatic refresh on expiry detection

**Graph API Token Requirements:**
- Access token required in Authorization header: `Bearer {token}`
- Token obtained via MSAL during OAuth 2.0 flow
- Token stored in Redis session (already implemented)
- Token refresh via MSAL acquireTokenSilent() method
- Automatic retry with new token on 401 Unauthorized

**Token Refresh Flow:**
```typescript
// Extend existing token refresh from Story 2.4
async function refreshGraphApiToken(userId: string): Promise<string> {
  const session = await getSession(userId);
  const msalApp = getMsalApp(); // From auth.config.ts

  try {
    const result = await msalApp.acquireTokenSilent({
      account: session.azureAdAccount,
      scopes: ['https://graph.microsoft.com/.default'],
    });

    // Update session with new token
    await updateSessionToken(userId, result.accessToken, result.expiresOn);

    return result.accessToken;
  } catch (error) {
    // Fallback to interactive flow if silent fails
    throw new Error('Token refresh failed - user must re-authenticate');
  }
}
```

#### Database Schema Updates
[Source: architecture/database-schema.md]

**New Table Required: graph_subscriptions**
```sql
CREATE TABLE graph_subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  subscription_id VARCHAR(255) UNIQUE NOT NULL,  -- Graph API subscription ID
  resource VARCHAR(500) NOT NULL,                -- e.g., "/me/messages"
  change_types VARCHAR(255) NOT NULL,            -- e.g., "created,updated"
  notification_url TEXT NOT NULL,                -- Webhook endpoint URL
  client_state VARCHAR(255),                     -- Optional validation secret
  expiration_datetime TIMESTAMPTZ NOT NULL,      -- Subscription expiry
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  last_renewed_at TIMESTAMPTZ,                   -- Last renewal timestamp
  is_active BOOLEAN DEFAULT true,                -- Active status
  CONSTRAINT valid_expiration CHECK (expiration_datetime > CURRENT_TIMESTAMP)
);

CREATE INDEX idx_graph_subscriptions_expiry ON graph_subscriptions(expiration_datetime);
CREATE INDEX idx_graph_subscriptions_active ON graph_subscriptions(is_active);
```

**No other schema changes required** - User session already stores Graph API tokens from Story 2.4.

#### Coding Standards to Follow
[Source: architecture/coding-standards.md]

**Critical Rules:**
- Define shared types in `packages/shared/types/` for Graph API models
- Use service layers for all Graph API calls (never direct HTTP)
- Access environment variables only through config objects
- All API routes must use standard error handler
- Never trust client-provided user IDs (always use session user)
- Database access only through repository pattern

**Naming Conventions:**
- API Routes: kebab-case (e.g., `/webhooks/graph-notifications`)
- Database Tables: snake_case (e.g., `graph_subscriptions`)
- TypeScript Classes: PascalCase (e.g., `GraphService`, `WebhookService`)
- TypeScript Functions: camelCase (e.g., `createSubscription`, `renewSubscription`)

### Testing

[Source: architecture/testing-strategy.md]

**Testing Pyramid:**
- Unit Tests (70%): Jest for services, middleware, utilities
- Integration Tests (20%): API endpoints with mocked Graph API
- E2E Tests (10%): Real Graph API calls in staging environment

**Test File Organization:**
- Unit tests: `__tests__/{category}/{file}.test.ts`
- Integration tests: `__tests__/integration/{feature}.integration.test.ts`
- Mock Graph API responses in `__mocks__/@microsoft/microsoft-graph-client.ts`

**Test Coverage Requirements:**
- Services: 100% coverage
- Middleware: 100% coverage
- Utilities: 100% coverage
- Integration tests: 80%+ coverage
- E2E tests: Critical user journeys only

**Testing Frameworks:**
- Jest 29+ for unit and integration tests
- Supertest 6.3+ for API endpoint testing
- Nock for HTTP mocking (optional for Graph API mocking)

**Key Test Scenarios:**
1. Graph client initialization with valid/invalid credentials
2. Token refresh on 401 Unauthorized
3. Rate limiting enforcement and 429 responses
4. Webhook subscription creation and renewal
5. Webhook notification validation and processing
6. Cache hit/miss scenarios
7. Error handling for transient failures (429, 500, 503)
8. Circuit breaker opening on repeated failures
9. Exponential backoff retry logic
10. Cache invalidation on webhook notifications

### Environment Variables Required

**New Environment Variables:**
```bash
# Microsoft Graph API
GRAPH_API_BASE_URL=https://graph.microsoft.com/v1.0
GRAPH_API_TIMEOUT=30000  # 30 seconds

# Rate Limiting
GRAPH_API_RATE_LIMIT_REQUESTS=10000
GRAPH_API_RATE_LIMIT_WINDOW=600  # 10 minutes in seconds
GRAPH_API_PER_USER_RATE_LIMIT=100  # Requests per minute per user

# Webhooks
WEBHOOK_BASE_URL=https://your-app.onrender.com  # Replace with actual Render URL
WEBHOOK_CLIENT_STATE=your-secret-validation-string

# Caching
GRAPH_CACHE_TTL_USER_PROFILE=3600  # 1 hour
GRAPH_CACHE_TTL_CALENDAR=300       # 5 minutes
GRAPH_CACHE_TTL_FILES=900          # 15 minutes
GRAPH_CACHE_TTL_EMAILS=60          # 1 minute

# Retry Configuration
GRAPH_RETRY_MAX_ATTEMPTS=5
GRAPH_RETRY_INITIAL_DELAY=1000     # 1 second
GRAPH_RETRY_MAX_DELAY=32000        # 32 seconds

# Circuit Breaker
CIRCUIT_BREAKER_FAILURE_THRESHOLD=10
CIRCUIT_BREAKER_RESET_TIMEOUT=60000  # 60 seconds
```

**Existing Environment Variables (from Story 2.4):**
- `AZURE_AD_CLIENT_ID` - Already configured
- `AZURE_AD_CLIENT_SECRET` - Already configured
- `AZURE_AD_TENANT_ID` - Already configured
- `REDIS_URL` - Already configured
- `SESSION_SECRET` - Already configured
- `JWT_SECRET` - Already configured

### Performance Considerations

**Expected Response Times:**
- Cache hit: <50ms
- Cache miss + Graph API call: 200-500ms
- Webhook processing: <500ms
- Token refresh: 100-300ms

**Optimization Strategies:**
- Cache GET requests aggressively (60%+ hit rate target)
- Use batch requests for multiple resources (future enhancement)
- Implement request deduplication for concurrent identical requests
- Monitor Graph API latency and adjust retry timeouts accordingly

### Security Considerations

1. **Authentication:** Always validate access token before Graph API calls
2. **Authorization:** Verify user permissions match requested Graph API resource
3. **Webhook Validation:** Verify validation token and client state on webhook creation
4. **Rate Limiting:** Prevent abuse with per-user and app-level rate limits
5. **Token Storage:** Store access tokens in Redis with encryption at rest
6. **Logging:** Log all Graph API errors but sanitize sensitive data (tokens, email content)

### Project Structure Alignment

**Verified Alignment:**
- Gateway service location matches structure: `services/gateway/`
- Shared types will be defined in: `packages/shared/types/`
- Config files follow pattern: `services/gateway/src/config/`
- Services follow pattern: `services/gateway/src/services/`
- Middleware follows pattern: `services/gateway/src/middleware/`
- Tests follow pattern: `services/gateway/__tests__/`

**No conflicts identified** with existing project structure from Story 2.4.

## Change Log

| Date       | Version | Description                  | Author        |
| ---------- | ------- | ---------------------------- | ------------- |
| 2025-11-20 | 1.0     | Initial story draft created  | Bob (SM)      |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

## QA Results

*This section will be populated by the QA agent after story completion.*
