# Story 2.11: Claude Skills Infrastructure and API Integration

## Status

Ready for Implementation

## Story

**As a** platform developer,
**I want** to integrate Claude Skills API infrastructure into our AI service,
**so that** we can leverage Skills for 70%+ token reduction and 35% cost savings on repetitive legal workflows.

## Business Value

- **Cost Reduction:** 35-40% reduction in AI costs (from $126 to $80/month for 100 users)
- **Performance:** 70% reduction in token usage for skill-enhanced tasks
- **Efficiency:** 73% reduction in prompt engineering time
- **Consistency:** Standardized execution of legal workflows

## Acceptance Criteria

1. Skills API client integrated with Anthropic SDK including beta flags configuration
2. Database schema updated to track skills metadata and usage metrics
3. SkillsManager service created for uploading, versioning, and managing skills
4. SkillsRegistry implemented for skill discovery and selection
5. Enhanced AnthropicClient supports skills in Messages API requests
6. Environment variables configured for skills feature flags
7. Cost tracking updated to account for skill-based optimizations
8. Unit tests achieve 80% coverage on new skills infrastructure
9. Integration tests validate skills API communication
10. Documentation created for skills infrastructure architecture

## Tasks / Subtasks

### Phase 1: Database and Configuration Setup (AC: 2, 6)

- [ ] **Task 1: Create Skills Database Schema** (AC: 2)
  - [ ] Create migration file: `migrations/add_skills_tables.sql`
  - [ ] Add `skills` table with columns: id, skill_id, display_name, description, version, type, category, effectiveness_score, token_savings_avg, usage_count, created_at, updated_at
  - [ ] Add `skill_usage_logs` table for tracking metrics
  - [ ] Add `skill_versions` table for version management
  - [ ] Create indexes on skill_id, category, and effectiveness_score
  - [ ] Run migration in development environment
  - [ ] Verify schema with Prisma introspection

- [ ] **Task 2: Configure Environment Variables** (AC: 6)
  - [ ] Update `services/ai-service/.env.example` with skills configuration:
    ```
    ANTHROPIC_SKILLS_ENABLED=true
    ANTHROPIC_CODE_EXECUTION_ENABLED=true
    ANTHROPIC_SKILLS_BETA_VERSION=skills-2025-10-02
    ANTHROPIC_CODE_EXECUTION_BETA_VERSION=code-execution-2025-08-25
    SKILLS_UPLOAD_MAX_SIZE_MB=10
    SKILLS_MAX_PER_WORKSPACE=50
    SKILLS_CACHE_TTL_SECONDS=3600
    ```
  - [ ] Update `infrastructure/ENVIRONMENT_VARIABLES.md` with skills section
  - [ ] Add skills configuration to `infrastructure/render/environment-template.yaml`
  - [ ] Create validation script to check required skills variables

### Phase 2: Skills API Client Implementation (AC: 1, 3, 5)

- [ ] **Task 3: Create Skills API Client** (AC: 1, 3)
  - [ ] Create `services/ai-service/src/skills/SkillsAPIClient.ts`
  - [ ] Implement methods:
    - `uploadSkill(payload: FormData): Promise<SkillMetadata>`
    - `listSkills(filters?: SkillFilters): Promise<SkillMetadata[]>`
    - `getSkill(skillId: string): Promise<Skill>`
    - `deleteSkill(skillId: string): Promise<void>`
    - `updateSkill(skillId: string, updates: Partial<Skill>): Promise<Skill>`
  - [ ] Add retry logic with exponential backoff
  - [ ] Implement request/response logging
  - [ ] Add error handling for beta API responses
  - [ ] Create types in `services/ai-service/src/types/skills.ts`

- [ ] **Task 4: Implement SkillsManager Service** (AC: 3)
  - [ ] Create `services/ai-service/src/skills/SkillsManager.ts`
  - [ ] Implement skill validation before upload
  - [ ] Add skill packaging/zip functionality
  - [ ] Implement version management logic
  - [ ] Create skill template generator
  - [ ] Add skill effectiveness tracking
  - [ ] Implement skill cleanup/deletion
  - [ ] Add caching layer for frequently used skills

- [ ] **Task 5: Create SkillsRegistry** (AC: 4)
  - [ ] Create `services/ai-service/src/skills/SkillsRegistry.ts`
  - [ ] Implement skill discovery based on task patterns
  - [ ] Create relevance scoring algorithm
  - [ ] Add skill-to-task mapping logic
  - [ ] Implement skill effectiveness metrics collection
  - [ ] Add skill recommendation engine
  - [ ] Create fallback logic for skill failures

### Phase 3: Enhanced Anthropic Client (AC: 5, 7)

- [ ] **Task 6: Extend Anthropic Client for Skills** (AC: 5)
  - [ ] Create `services/ai-service/src/clients/AnthropicEnhancedClient.ts`
  - [ ] Extend base client with skills support:
    ```typescript
    class AnthropicEnhancedClient extends AnthropicClient {
      async createMessageWithSkills(params: MessageWithSkillsParams): Promise<Response>;
      private addBetaFlags(request: Request): Request;
      private addCodeExecutionTool(request: Request): Request;
      private addSkillsContainer(request: Request, skillIds: string[]): Request;
    }
    ```
  - [ ] Implement progressive disclosure optimization
  - [ ] Add skill result parsing
  - [ ] Implement fallback to non-skill requests
  - [ ] Add request/response interceptors for metrics

- [ ] **Task 7: Update Cost Tracking for Skills** (AC: 7)
  - [ ] Modify `services/ai-service/src/monitoring/CostTracker.ts`
  - [ ] Add skill-based cost calculation:
    - Track tokens with/without skills
    - Calculate savings percentage
    - Log skill effectiveness
  - [ ] Update cost projection algorithms
  - [ ] Add skill-specific cost metrics
  - [ ] Create cost comparison reports
  - [ ] Implement real-time cost monitoring

### Phase 4: Testing and Validation (AC: 8, 9)

- [ ] **Task 8: Unit Tests for Skills Infrastructure** (AC: 8)
  - [ ] Create `services/ai-service/tests/skills/SkillsManager.test.ts`
  - [ ] Create `services/ai-service/tests/skills/SkillsRegistry.test.ts`
  - [ ] Create `services/ai-service/tests/skills/SkillsAPIClient.test.ts`
  - [ ] Test skill upload, validation, and deletion
  - [ ] Test skill discovery and selection logic
  - [ ] Test error handling and retries
  - [ ] Mock Anthropic API responses
  - [ ] Achieve 80% code coverage

- [ ] **Task 9: Integration Tests** (AC: 9)
  - [ ] Create `services/ai-service/tests/integration/skills.test.ts`
  - [ ] Test end-to-end skill upload flow
  - [ ] Test skill execution in Messages API
  - [ ] Validate beta flags configuration
  - [ ] Test fallback scenarios
  - [ ] Verify database logging
  - [ ] Test cost tracking accuracy

### Phase 5: Documentation (AC: 10)

- [ ] **Task 10: Create Skills Architecture Documentation** (AC: 10)
  - [ ] Create `docs/architecture/claude-skills-integration.md`
  - [ ] Document skills infrastructure components
  - [ ] Create sequence diagrams for skill execution
  - [ ] Document API integration patterns
  - [ ] Add troubleshooting guide
  - [ ] Create skills development guide
  - [ ] Document cost optimization strategies

## Definition of Done

- [ ] All database migrations successfully applied
- [ ] Skills API client fully functional
- [ ] All unit tests passing with >80% coverage
- [ ] Integration tests passing
- [ ] Documentation complete and reviewed
- [ ] Code reviewed and approved
- [ ] Deployed to staging environment
- [ ] Skills upload tested successfully
- [ ] Cost tracking validated

## Dependencies

- Anthropic API key with skills beta access
- Claude API version supporting skills-2025-10-02 beta
- PostgreSQL database with required permissions
- Redis for caching layer

## Risk Mitigation

- Maintain fallback to non-skills routing if API fails
- Implement circuit breaker for skills API
- Add feature flags for gradual rollout
- Monitor beta API deprecation notices
