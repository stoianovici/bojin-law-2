# Story 3.2.5: Legacy Document Import & Categorization for AI Training

**Epic:** 3 - AI-Powered Document Management & Semantic Version Control
**Story Type:** Feature
**Priority:** Medium
**Estimated Effort:** 11-14 days
**Dependencies:** Story 3.1 (AI Service Infrastructure), Story 2.9 (OneDrive Integration), Story 2.1.1 (Render Infrastructure Migration)

## User Story

**As a** law firm partner migrating to the platform,
**I want** to import and categorize legacy documents from my email archives with my assistants working in parallel,
**so that** the AI can learn from our firm's historical documents to provide better suggestions and we can complete the categorization efficiently.

## Business Context

Law firms have 10+ years of legal documents stored as email attachments in PST files. These documents contain valuable firm-specific language, clause structures, and document templates that should train the AI for better document generation. This is a **one-time migration workflow** that will be used in multiple sessions over several weeks.

**Collaborative Workflow:** Partner uploads PST file, and **multiple assistants work in parallel** to categorize documents. Each assistant is allocated a batch of documents (grouped by month) to avoid duplicate work. Assistants work independently without real-time sync, and batches persist across sessions.

**Deployment Model:** Web application hosted at `import.yourapp.com` via Render.com with **secure server-side PST processing**. PST files are uploaded to cloud storage (Cloudflare R2, encrypted AES-256), processed server-side, then automatically deleted after categorization completes. Only categorized documents are exported to OneDrive.

**Storage Provider Decision:** Using Cloudflare R2 for cost-effectiveness (zero egress fees, S3-compatible API) as recommended in Story 2.1.1 Render infrastructure migration.

**Key Requirements from Discovery:**

- Documents should NOT appear in the main app UI (training-only)
- **Multiple assistants can categorize in parallel without duplicate work**
- **Batch allocation by document month for fair distribution**
- Client needs document previews to categorize effectively
- Categories must be definable on-the-fly during categorization
- **Categories sync across all users on document load**
- Large volume (10 years of emails) requires session persistence
- Only PDF, DOCX, and DOC formats needed
- **Preserve original PST folder structure for systematic navigation**
- **Display sent/received status based on PST folder**
- **Partner can merge duplicate categories before export**
- **Secure handling of sensitive PST files** (temporary storage, automatic deletion)
- Output stored in OneDrive for AI training pipeline access

## Acceptance Criteria

### 1. PST File Upload & Processing

**Given** a partner has a local PST file with email attachments
**When** they upload the PST file via the import UI
**Then** the system:

- âœ… Accepts PST files up to 10GB in size via secure HTTPS upload
- âœ… **Uploads to Cloudflare R2 with server-side encryption (AES-256)**
- âœ… **Processes PST server-side** using Node.js pst-extractor library
- âœ… Extracts all attachments matching extensions: .pdf, .docx, .doc
- âœ… **Preserves original Outlook folder hierarchy** (Inbox, Sent Items, custom folders)
- âœ… Displays extraction progress with count of documents found per folder
- âœ… Preserves original filenames and email metadata (sender, date, subject, **folder path**)
- âœ… Stores extracted documents in temporary Cloudflare R2 bucket (encrypted)
- âœ… Handles extraction errors gracefully with error log
- âœ… **Creates audit log entry**: PST uploaded, size, timestamp, user

### 2. Multi-User Batch Allocation

**Given** a partner has uploaded and extracted a PST file with 500 documents
**When** assistants log in to categorize documents
**Then** the system:

- âœ… **Automatically allocates batches by document month** (based on email received date)
- âœ… **Distributes months fairly** across assistants who access the session
- âœ… **Shows assigned batch to each assistant**: "Your batch: Jan-Mar 2019 (127 documents)"
- âœ… **Displays overall session progress**: "Session total: 312 / 500 categorized (62%)"
- âœ… **Persists batch assignment** - same assistant gets same batch when returning
- âœ… **Auto-reassigns completed batches** - if Assistant A finishes while B stalls, A receives next batch from B's allocation
- âœ… **Prevents duplicate categorization** - each document assigned to exactly one assistant
- âœ… **Allows partner to view all batches and progress** in admin dashboard

### 3. Document Categorization Interface

**Given** an assistant is viewing their allocated batch
**When** they work through the categorization interface
**Then** they can:

- âœ… **See only documents in their assigned batch** (filtered automatically)
- âœ… **View overall progress**: "Your batch: 45 / 127 categorized" + "Session: 312 / 500"
- âœ… See document preview (PDF viewer for PDF, rendered doc for DOCX/DOC)
- âœ… View metadata: filename, email subject, sender/receiver, date received, **folder path**, **sent/received indicator**
- âœ… Assign document to a category (dropdown + "Add New Category" option)
- âœ… Skip/ignore irrelevant documents
- âœ… Navigate between documents with keyboard shortcuts (â† â†’ arrows)
- âœ… **Filter view: All / Categorized / Uncategorized / Skipped / Sent Only / Received Only**
- âœ… **Sent/Received determined by PST folder**: "Sent Items" = sent, "Inbox" and others = received
- âœ… **Categories sync on each document load** (fetch latest from server)

### 4. Category Management (Multi-User)

**Given** assistants are categorizing documents in parallel
**When** they create or use categories
**Then** the system:

- âœ… **Allows any assistant to add new categories** on-the-fly with Romanian names (e.g., "Contract", "Notificare Avocateasca", "Intampinare")
- âœ… **Syncs new categories to all users** when they load next document
- âœ… **Shows document count per category** aggregated across all batches
- âœ… **Categories persist in PostgreSQL database** (shared across all users)
- âœ… **Categories available to all assistants immediately** after creation

### 5. Merge Categories Workflow (Partner-Only)

**Given** the partner is ready to export categorized documents
**When** they initiate the export process
**Then** they can:

- âœ… **Review all categories** with document counts before export
- âœ… **Identify duplicate categories**: "Contract" (42 docs), "Contracts" (18 docs), "Contract " (3 docs)
- âœ… **Merge categories**: Select multiple â†’ Choose primary name â†’ Confirm merge
- âœ… **Preview merge impact**: "Merging 'Contracts' and 'Contract ' into 'Contract' will affect 21 documents"
- âœ… **Merge updates all document categorizations** atomically
- âœ… **Merged categories cannot be undone** after export begins
- âœ… **Only partners have access** to merge categories feature
- âœ… **Proceed to OneDrive export** after categories finalized

### 6. Session Persistence (Multi-User)

**Given** an assistant has categorized 100 of 127 documents in their batch
**When** they close the browser and return later (even days later)
**Then**:

- âœ… **All categorization progress is preserved in PostgreSQL**
- âœ… **They receive the same batch allocation** they had before
- âœ… They can resume from where they left off
- âœ… Previously skipped documents remain skipped
- âœ… **Other assistants' progress is also preserved** independently
- âœ… **IndexedDB used as local cache** for performance, PostgreSQL as source of truth

### 7. OneDrive Export & Automatic Cleanup

**Given** the partner has finished categorizing documents
**When** they click "Export to OneDrive"
**Then** the system:

- âœ… Creates folder structure: `/AI-Training/{CategoryName}/`
- âœ… Uploads all categorized documents to respective folders
- âœ… Generates metadata JSON file per category with document info
- âœ… Shows upload progress with retry on failures
- âœ… Provides completion summary with document counts per category
- âœ… Skipped documents are NOT uploaded
- âœ… **CRITICAL: Automatically deletes original PST file from Cloudflare R2**
- âœ… **Deletes all temporary extracted documents from Cloudflare R2**
- âœ… **Creates audit log entry**: PST deleted, export completed, timestamp
- âœ… **Retains IndexedDB session data** (browser-side only) for potential re-export
- âœ… Displays "Data Cleanup Complete" confirmation to user

### 8. Bulk Folder Operations (Removed - Not Needed for Assistant Workflow)

**Note:** With batch allocation by month, bulk folder operations are no longer needed since assistants work through documents sequentially within their assigned batch.

~~Removed - assistants work through assigned batch sequentially~~

### 9. AI Training Integration Point

**Given** documents are exported to OneDrive
**When** the AI training pipeline runs
**Then**:

- âœ… Category folders are discoverable via known OneDrive path
- âœ… Metadata JSON files provide document context (including original folder path)
- âœ… Documents are accessible for embedding generation
- âœ… This story does NOT implement the training pipeline (deferred to Story 3.2.6)

## Technical Approach

### Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Multiple Client Browsers (Partner + Assistants)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Next.js UI + IndexedDB (cache only)            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ HTTPS                           â”‚ API Calls
            â”‚ (PST Upload / Categorization)   â”‚
            â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Azure Backend Services                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PostgreSQL 16   â”‚  â”‚  API Routes (Next.js)       â”‚  â”‚
â”‚  â”‚  (Main DB)       â”‚  â”‚  - /api/upload-pst          â”‚  â”‚
â”‚  â”‚                  â”‚  â”‚  - /api/extract-documents   â”‚  â”‚
â”‚  â”‚  - Sessions      â”‚  â”‚  - /api/get-batch           â”‚  â”‚
â”‚  â”‚  - Batches       â”‚  â”‚  - /api/categorize-doc      â”‚  â”‚
â”‚  â”‚  - Documents     â”‚  â”‚  - /api/sync-categories     â”‚  â”‚
â”‚  â”‚  - Categories    â”‚  â”‚  - /api/merge-categories    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - /api/export-onedrive     â”‚  â”‚
â”‚           â”‚            â”‚  - /api/cleanup             â”‚  â”‚
â”‚           â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                        â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                     â”‚
â”‚  â”‚  Azure Blob      â”‚              â”‚                     â”‚
â”‚  â”‚  Storage         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚  â”‚  (Encrypted)     â”‚                                    â”‚
â”‚  â”‚  - PST files     â”‚                                    â”‚
â”‚  â”‚  - Temp docs     â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚           â”‚                                               â”‚
â”‚           â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PST Processor   â”‚  â”‚  Microsoft Graph API        â”‚  â”‚
â”‚  â”‚  (pst-extractor) â”‚  â”‚  (OneDrive Upload)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OneDrive (Partner's Account)                â”‚
â”‚               /AI-Training/{CategoryName}/               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Technology Stack

| Component             | Technology                               | Rationale                                                                      |
| --------------------- | ---------------------------------------- | ------------------------------------------------------------------------------ |
| **Frontend**          | Next.js standalone app                   | Reuse existing tech stack, easy deployment                                     |
| **Deployment**        | Render.com (web service)                 | Same infrastructure as main app (Story 2.1.1)                                  |
| **Database**          | PostgreSQL 16 (shared with main app)     | Multi-user session state, batch allocation, ACID guarantees                    |
| **PST Parsing**       | pst-extractor npm package (server-side)  | Proven library, handles PST format, MIT license, Node.js only                  |
| **Temporary Storage** | Cloudflare R2                            | Encrypted at rest (AES-256), secure, scalable, S3-compatible, zero egress fees |
| **Session Storage**   | PostgreSQL + IndexedDB (cache)           | PostgreSQL as source of truth, IndexedDB for local caching                     |
| **Document Preview**  | react-pdf + @microsoft/office-js-helpers | PDF and Office doc rendering (browser)                                         |
| **File Upload**       | tus-js-client                            | Resumable uploads for large files (10GB+)                                      |
| **OneDrive Upload**   | Microsoft Graph API                      | Existing integration, batch upload support                                     |
| **State Management**  | Zustand                                  | Lightweight, consistent with main app                                          |
| **UI Components**     | Radix UI + Tailwind                      | Reuse design system from main app                                              |
| **Authentication**    | OAuth 2.0 + JWT (via Render)             | Partner + Assistant roles, SSO support                                         |

### Data Model

```typescript
// PostgreSQL Schema (Prisma)

interface ImportSession {
  id: string;
  pstFileName: string;
  uploadedBy: string; // User ID (Partner)
  uploadedAt: Date;
  totalDocuments: number;
  categorizedCount: number;
  skippedCount: number;
  status: 'in-progress' | 'completed' | 'exported';
  createdAt: Date;
  updatedAt: Date;
}

interface DocumentBatch {
  id: string;
  sessionId: string;
  monthYear: string; // 'YYYY-MM' format (e.g., '2019-01')
  assignedTo: string; // User ID (Assistant)
  documentCount: number;
  categorizedCount: number;
  createdAt: Date;
  updatedAt: Date;
}

interface ExtractedDocument {
  id: string;
  sessionId: string;
  batchId: string; // Reference to DocumentBatch
  fileName: string;
  fileExtension: 'pdf' | 'docx' | 'doc';
  fileSizeBytes: number;
  blobUrl: string; // Azure Blob Storage URL
  folderPath: string; // Original PST folder path
  isSent: boolean; // Determined from folder path (Sent Items = true)
  emailMetadata: {
    subject: string;
    sender: string;
    receiver: string;
    receivedDate: Date;
  };
  categoryId?: string;
  status: 'uncategorized' | 'categorized' | 'skipped';
  categorizedBy?: string; // User ID
  categorizedAt?: Date;
  createdAt: Date;
  updatedAt: Date;
}

interface Category {
  id: string;
  sessionId: string;
  name: string;
  documentCount: number; // Computed from ExtractedDocument count
  createdBy: string; // User ID
  createdAt: Date;
  updatedAt: Date;
}

interface ExportMetadata {
  sessionId: string;
  exportedAt: Date;
  exportedBy: string; // User ID (Partner)
  categories: {
    categoryId: string;
    categoryName: string;
    documentCount: number;
    oneDriveFolderPath: string;
  }[];
}

// IndexedDB Schema (Dexie.js) - Local Cache Only
// Same structure as above, used for offline performance
// PostgreSQL is the source of truth
```

### OneDrive Folder Structure

```
/AI-Training/
â”œâ”€â”€ Contract/
â”‚   â”œâ”€â”€ doc-001.pdf
â”‚   â”œâ”€â”€ doc-002.docx
â”‚   â””â”€â”€ _metadata.json
â”œâ”€â”€ Notificare Avocateasca/
â”‚   â”œâ”€â”€ doc-003.pdf
â”‚   â””â”€â”€ _metadata.json
â”œâ”€â”€ Intampinare/
â”‚   â”œâ”€â”€ doc-004.docx
â”‚   â””â”€â”€ _metadata.json
â””â”€â”€ _session_summary.json
```

### Metadata JSON Format

```json
{
  "category": "Contract",
  "documentCount": 42,
  "exportedAt": "2024-11-13T10:30:00Z",
  "documents": [
    {
      "fileName": "doc-001.pdf",
      "originalFileName": "Purchase Agreement - Acme Corp.pdf",
      "originalFolderPath": "Inbox/Clients/Acme Corp",
      "emailSubject": "RE: Contract review needed",
      "emailSender": "client@example.com",
      "emailDate": "2019-03-15T14:22:00Z",
      "fileSize": 245678
    }
  ]
}
```

## Implementation Plan

### Phase 1: Database Schema & Infrastructure (Days 1-2)

1. **Create PostgreSQL schema** using Prisma migrations:
   - `legacy_import_sessions` table
   - `document_batches` table
   - `extracted_documents` table
   - `categories` table
   - Indexes for batch allocation and document queries
2. Set up standalone Next.js app at `apps/legacy-import`
3. Configure Azure Blob Storage container (encrypted)
4. **Implement resumable file upload** using tus-js-client
5. Create API route `/api/upload-pst` with authentication (Partner only)
6. Basic progress UI with upload status

### Phase 2: PST Processing & Batch Allocation (Days 3-4)

1. Implement server-side PST extraction with pst-extractor
2. **Extract email received date** for month-based grouping
3. **Determine sent/received** from PST folder path
4. Store extracted documents in PostgreSQL with batch assignments
5. **Implement batch allocation algorithm**:
   - Group documents by month (YYYY-MM)
   - Distribute months fairly when assistants log in
   - Persist batch assignments in `document_batches` table
6. Create API routes:
   - `/api/extract-documents` - Process PST and create batches
   - `/api/get-batch` - Get assistant's assigned batch
   - `/api/session-progress` - Overall progress stats
7. Store extracted files in temp Azure Blob (encrypted)

### Phase 3: Multi-User Categorization UI (Days 5-7)

1. Build document viewer (PDF + DOCX/DOC)
2. **Batch assignment UI** - show assigned month range
3. **Progress indicators**: personal batch + overall session
4. Category dropdown with "Add New" functionality
5. **Category sync API**: `/api/sync-categories` (called on document load)
6. Navigation controls (prev/next, keyboard shortcuts)
7. **Filter bar**: All/Categorized/Uncategorized/Skipped/Sent Only/Received Only
8. **Metadata display**: folder path, sent/received indicator, sender/receiver
9. **Categorization API**: `/api/categorize-doc` - Update document status
10. IndexedDB as local cache, sync with PostgreSQL

### Phase 4: Category Merge & Export (Days 8-9)

1. **Partner dashboard** showing all batches and assistants
2. **Merge categories UI** (Partner-only):
   - List all categories with document counts
   - Multi-select categories to merge
   - Preview merge impact
   - Confirm and execute merge
3. **Merge categories API**: `/api/merge-categories` - Atomic update
4. Microsoft Graph API authentication
5. Folder creation in OneDrive
6. Batch document upload (5 concurrent max)
7. Metadata JSON generation (including folder paths, sent/received)
8. Upload progress UI with retry logic
9. **Implement automatic cleanup after export**:
   - Delete PST file from Azure Blob
   - Delete temp extracted documents
   - Create audit log entry
10. **Create cleanup confirmation UI**

### Phase 5: Reassignment & Polish (Days 10-11)

1. **Auto-reassignment logic**: Monitor batch completion, reallocate stalled batches
2. Error handling and validation
3. Loading states and optimistic UI
4. Performance optimization (connection pooling, query optimization)
5. Documentation for partners and assistants

### Phase 6: Testing (Days 12-14)

1. Unit tests for batch allocation algorithm
2. Integration tests for multi-user scenarios
3. E2E testing with sample PST file and multiple users
4. Performance testing with 1000+ documents
5. Concurrent user testing (3+ assistants simultaneously)
6. Category sync testing
7. Merge categories testing

## Testing Strategy

### Unit Tests

- PST extraction logic **including email date and sent/received detection**
- **Batch allocation algorithm** (fair distribution by month)
- **Auto-reassignment logic** (when assistant finishes early)
- Category management operations (create, sync, merge)
- PostgreSQL data persistence
- Metadata JSON generation **with folder paths and sent/received**

### Integration Tests

- **Multi-user batch allocation**: 3 assistants â†’ receive different months
- **Category sync**: Assistant A creates category â†’ Assistant B sees it
- **Concurrent categorization**: Multiple assistants categorizing simultaneously
- **Batch persistence**: Assistant logs out â†’ logs back in â†’ same batch
- OneDrive upload flow
- Category merge functionality
- **Database transactions** for atomic operations

### E2E Tests (Playwright)

- **Complete multi-user flow**:
  - Partner uploads PST
  - 3 assistants log in â†’ each receives batch
  - Assistants categorize in parallel
  - Partner merges duplicate categories
  - Partner exports to OneDrive
- **Batch allocation**: Verify fair distribution and persistence
- **Category sync**: Create category in one session â†’ appears in another
- **Reassignment**: Assistant A finishes â†’ receives batch from Assistant B
- **Sent/Received filtering**: Verify correct filtering based on folder
- Session resume: Categorize 5 docs â†’ Close tab â†’ Reopen â†’ Verify state
- Error handling: Network failure during categorization â†’ Retry â†’ Success

### Performance Tests

- **Concurrent users**: 5 assistants categorizing simultaneously
- **Database load**: 1000+ documents with frequent category syncs
- **Query performance**: Batch allocation query < 100ms
- **Category sync**: < 500ms to fetch latest categories

### Manual Testing Checklist

- [ ] Upload real PST file (>1GB) with 10+ years of emails
- [ ] **Verify batch allocation**: 3 assistants receive fair distribution
- [ ] **Test sent/received detection**: "Sent Items" = sent, "Inbox" = received
- [ ] **Test category sync**: Create category â†’ Verify others see it
- [ ] **Test merge categories**: Merge "Contract" + "Contracts"
- [ ] Preview PDFs and DOCX files
- [ ] Create 5+ categories with Romanian names
- [ ] **Concurrent categorization**: 3 assistants work simultaneously
- [ ] **Test reassignment**: One assistant finishes â†’ receives new batch
- [ ] Verify OneDrive folder structure
- [ ] Confirm metadata JSON accuracy **including sent/received and folder path**
- [ ] Test session persistence over 24 hours
- [ ] **Test PostgreSQL consistency**: Verify no duplicate categorizations

## UI/UX Design

### Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Legacy Document Import & Categorization                              [Close]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Progress: 127 / 543 categorized  â”‚  Session: Active  â”‚  [Export to OneDrive]  â”‚
â”‚  [All] [Uncategorized] [Categorized] [Skipped] [By Folder]                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   â”‚                      â”‚  Document Preview                    â”‚
â”‚  PST Folders      â”‚  Document List       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚ â–¼ ğŸ“ Inbox   â”‚ â”‚  â”‚ doc-001.pdf ğŸ“„ â”‚  â”‚  â”‚   [PDF or DOCX rendered]       â”‚  â”‚
â”‚  â”‚   â–¸ Clients  â”‚ â”‚  â”‚ Contract       â”‚  â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚   â–¸ Court    â”‚ â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚   (127)      â”‚ â”‚  â”‚ doc-002.docxğŸ“ â”‚  â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚              â”‚ â”‚  â”‚ Uncategorized  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚ â–¼ ğŸ“ Sent    â”‚ â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                                      â”‚
â”‚  â”‚   (43)       â”‚ â”‚  â”‚ doc-003.pdf ğŸ“„ â”‚  â”‚  Metadata:                           â”‚
â”‚  â”‚              â”‚ â”‚  â”‚ Notificare...  â”‚  â”‚  Folder: Inbox/Clients/Acme Corp     â”‚
â”‚  â”‚ â–¸ ğŸ“ Archive â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  Subject: RE: Contract review        â”‚
â”‚  â”‚   â–¸ 2023     â”‚ â”‚                      â”‚  From: client@example.com            â”‚
â”‚  â”‚   â–¸ 2022     â”‚ â”‚  Showing: Inbox      â”‚  Date: Mar 15, 2019                  â”‚
â”‚  â”‚   (373)      â”‚ â”‚  Documents: 127      â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                      â”‚  Category: [Select...          â–¼]    â”‚
â”‚                   â”‚  Categories:         â”‚            [+ Add New Category]      â”‚
â”‚                   â”‚  â€¢ Contract (42)     â”‚                                      â”‚
â”‚                   â”‚  â€¢ Notificare.. (18) â”‚  [â† Previous]  [Skip]  [Next â†’]      â”‚
â”‚                   â”‚  â€¢ Intampinare (31)  â”‚                                      â”‚
â”‚                   â”‚  + Add Category      â”‚  [Right-click folder for bulk ops]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Interactions

- **Keyboard Shortcuts:**
  - `â†’` Next document
  - `â†` Previous document
  - `S` Skip document
  - `1-9` Quick assign to first 9 categories
  - `/` Focus category search
  - `Space` Expand/collapse selected folder

- **Folder Navigation:**
  - Click folder to filter documents to that folder
  - **Right-click folder** for context menu (Categorize All, Skip All)
  - Expand/collapse folders to navigate hierarchy
  - Folder document counts update in real-time

- **Drag & Drop:** PST file upload area

- **Quick Categorization:** Type to filter categories, Enter to assign

## Security & Compliance

### Data Protection Measures

**Upload Security:**

- âœ… HTTPS/TLS 1.3 for all data in transit
- âœ… Azure AD authentication required (Partner role minimum)
- âœ… File size validation before upload (reject >10GB)
- âœ… File type validation (only .pst accepted)
- âœ… Rate limiting on upload endpoint (1 upload per user per hour)

**Storage Security:**

- âœ… Azure Blob Storage with server-side encryption (AES-256)
- âœ… Temporary container with 7-day auto-delete policy (backup)
- âœ… Private blob access (no public URLs)
- âœ… SAS tokens with 1-hour expiration for downloads
- âœ… Blob versioning enabled for audit trail

**Data Lifecycle:**

1. **Upload:** PST encrypted at rest in Azure Blob
2. **Processing:** Extracted docs encrypted in temp blob
3. **Categorization:** IndexedDB in browser (never touches server)
4. **Export:** Only categorized docs go to OneDrive
5. **Cleanup:** PST + temp docs deleted from Azure Blob immediately
6. **Retention:** IndexedDB remains in browser for re-export (user can clear)

**Audit Logging:**

- All PST uploads logged with: userId, timestamp, filename, size
- All extractions logged with: documentCount, successCount, failureCount
- All exports logged with: categoryCount, documentCount, oneDrivePath
- All deletions logged with: what was deleted, when, by whom
- Logs retained for 90 days in Application Insights

**Access Control:**

- Only Partners can access `import.yourapp.com`
- Session timeout: 4 hours of inactivity
- Re-authentication required before export to OneDrive

### GDPR & Romanian Law Compliance

- âœ… **Data Minimization:** Only document attachments extracted, emails discarded
- âœ… **Right to Erasure:** Partner can manually delete OneDrive folder anytime
- âœ… **Data Portability:** Documents exported to partner's own OneDrive
- âœ… **Purpose Limitation:** Data used only for AI training, not in main app
- âœ… **Storage Limitation:** Automatic deletion from Azure after export
- âœ… **Confidentiality:** Encrypted at rest and in transit
- âœ… **Accountability:** Complete audit trail maintained

### Cost Considerations

**Azure Blob Storage:**

- Temporary storage cost: ~â‚¬0.02 per GB per month
- 10GB PST stored for ~2 hours during processing: <â‚¬0.01
- 100 documents (~500MB) stored 1 week: ~â‚¬0.01
- **Estimated total: <â‚¬1 per import session**

## Rollback Plan

Since this is a standalone app:

- No impact on main application if issues arise
- Can disable route to import app via feature flag
- Session data in IndexedDB can be exported as JSON backup
- OneDrive files can be manually deleted if needed
- Azure Blob cleanup can be run manually via admin script
- Failed uploads can be resumed via tus protocol

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Unit tests pass with >80% coverage
- [ ] E2E tests pass in Playwright
- [ ] Manual testing completed with real PST file
- [ ] Code reviewed and approved
- [ ] Documentation created in `apps/legacy-import/README.md`
- [ ] Deployed to staging environment
- [ ] Partner successfully categorizes 100+ documents
- [ ] Documents verified in OneDrive with correct structure

## Future Enhancements (Not in Scope)

- AI-suggested categorization based on document content
- Bulk categorization (select multiple â†’ assign category)
- Export to other storage providers (Azure Blob, Google Drive)
- Automatic duplicate detection
- OCR for scanned PDFs
- Category templates for common legal practice areas

## Integration with Main App

While this is a standalone flow, the categorized documents will feed into the main app's AI training pipeline (Story 3.2.6). The integration points are:

1. **OneDrive Path Convention:** Main app AI service knows to look in `/AI-Training/` folder
2. **Metadata Format:** `_metadata.json` follows agreed schema for training pipeline
3. **Authentication:** Uses same Azure AD app registration as main app
4. **Design System:** Reuses Radix UI + Tailwind components for consistency

## Questions & Answers

**Q: Why not integrate directly into main app?**
A: Standalone app keeps this one-time workflow isolated, avoiding complexity in main app. Easier to deprecate after migration complete.

**Q: Is it secure to upload sensitive PST files to the server?**
A: Yes. Files are encrypted in transit (HTTPS/TLS 1.3) and at rest (AES-256). They're automatically deleted after export. Only categorized documents remain (in partner's own OneDrive). Complete audit trail maintained for compliance.

**Q: What happens if PST file is corrupted?**
A: pst-extractor will throw errors for corrupted sections. We'll log errors and extract what's possible, showing user a report of failures.

**Q: Can they re-categorize documents?**
A: Yes, categorization is editable until export. After export, they'd need to re-run export (overwrites OneDrive).

**Q: How do we handle duplicate filenames?**
A: Append UUID to duplicate filenames: `contract.pdf` â†’ `contract-a3f2b1c4.pdf`

**Q: What if OneDrive is full?**
A: Graph API will return quota error. We display error and suggest cleaning up OneDrive or upgrading storage.

**Q: What if the user closes browser during upload?**
A: Resumable upload (tus) allows them to continue from where they left off. PST remains in Azure Blob until extraction completes or 7 days (auto-delete).

**Q: How does batch allocation work exactly?**
A: When PST is processed, documents are grouped by email received month (YYYY-MM). When first assistant logs in, they're assigned the earliest months. Second assistant gets the next months, etc. Assignments persist in PostgreSQL, so returning assistants always get their original batch.

**Q: What if one assistant finishes before others?**
A: System detects completed batches and automatically reassigns remaining uncategorized documents from stalled batches to finished assistants, ensuring efficient workload distribution.

**Q: How do we prevent duplicate categorization?**
A: Each document is assigned to exactly one batch, and batches are assigned to exactly one assistant. PostgreSQL transactions ensure atomicity. Assistants only see documents in their assigned batch.

**Q: How is sent/received determined?**
A: Based on PST folder path. If folder path contains "Sent Items" â†’ sent = true. All other folders (Inbox, Archive, etc.) â†’ sent = false. Displayed as badge in UI.

**Q: Can assistants see each other's progress?**
A: Assistants see overall session progress ("312 / 500 categorized") but not individual assistant progress. Only partner can see batch-level details in admin dashboard.

**Q: What happens if assistants create duplicate categories?**
A: Categories sync on every document load, so assistants see all existing categories. However, duplicates can still occur (typos, spacing). Partner uses merge workflow before export to consolidate duplicates.

**Q: Why PostgreSQL instead of just IndexedDB?**
A: PostgreSQL provides true multi-user support with ACID guarantees, preventing race conditions. IndexedDB is used only as local cache for performance. PostgreSQL is source of truth.

## Success Metrics

- **Multi-user efficiency**: 3 assistants categorize 500+ documents 3x faster than single user
- **Batch allocation fairness**: All assistants receive similar workload (Â±10% document count)
- **Zero duplicate categorizations**: No document categorized by multiple assistants
- **Category sync reliability**: 100% of new categories appear for other users within 1 second
- <5% error rate in PST extraction
- **Sent/received detection accuracy**: >95% correct based on folder structure
- Resumable upload works reliably for 10GB files
- OneDrive export completes with 100% success rate
- **Merge categories reduces duplicates by >80%**
- All assistants can resume sessions without data loss
- Average categorization time: <10 seconds per document
- **Concurrent users supported**: 5+ assistants without performance degradation
- **Automatic cleanup completes in <30 seconds after export**
- **Zero security incidents (encrypted storage + automatic deletion)**
- Azure Blob storage costs <â‚¬1 per import session
- **PostgreSQL queries**: p95 < 100ms for batch allocation and category sync

---

**Story Status:** Ready for Implementation
**Created:** 2024-11-13
**Last Updated:** 2025-11-16
**Author:** Mary (Business Analyst)
**Change Log:**

- 2025-11-16: Added multi-user collaborative batch allocation, PostgreSQL integration, sent/received filtering, category merge workflow
