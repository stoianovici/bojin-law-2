# Story 3.2.5: Legacy Document Import & Categorization for AI Training

**Epic:** 3 - AI-Powered Document Management & Semantic Version Control
**Story Type:** Feature
**Priority:** Medium
**Estimated Effort:** 8-10 days
**Dependencies:** Story 3.1 (AI Service Infrastructure), Story 2.9 (OneDrive Integration)

## User Story

**As a** law firm partner migrating to the platform,
**I want** to import and categorize legacy documents from my email archives,
**so that** the AI can learn from our firm's historical documents to provide better suggestions.

## Business Context

Law firms have 10+ years of legal documents stored as email attachments in PST files. These documents contain valuable firm-specific language, clause structures, and document templates that should train the AI for better document generation. This is a **one-time migration workflow** that will be used in multiple sessions over several weeks.

**Deployment Model:** Web application hosted at `import.yourapp.com` with **secure server-side PST processing**. PST files are uploaded to Azure Blob Storage (encrypted), processed server-side, then automatically deleted after categorization completes. Only categorized documents are exported to OneDrive.

**Key Requirements from Discovery:**
- Documents should NOT appear in the main app UI (training-only)
- Client needs document previews to categorize effectively
- Categories must be definable on-the-fly during categorization
- Large volume (10 years of emails) requires session persistence
- Only PDF, DOCX, and DOC formats needed
- **Preserve original PST folder structure for systematic navigation**
- **Secure handling of sensitive PST files** (temporary storage, automatic deletion)
- Output stored in OneDrive for AI training pipeline access

## Acceptance Criteria

### 1. PST File Upload & Processing

**Given** a partner has a local PST file with email attachments
**When** they upload the PST file via the import UI
**Then** the system:
- âœ… Accepts PST files up to 10GB in size via secure HTTPS upload
- âœ… **Uploads to Azure Blob Storage with server-side encryption (AES-256)**
- âœ… **Processes PST server-side** using Node.js pst-extractor library
- âœ… Extracts all attachments matching extensions: .pdf, .docx, .doc
- âœ… **Preserves original Outlook folder hierarchy** (Inbox, Sent Items, custom folders)
- âœ… Displays extraction progress with count of documents found per folder
- âœ… Preserves original filenames and email metadata (sender, date, subject, **folder path**)
- âœ… Stores extracted documents in temporary Azure Blob (encrypted)
- âœ… Handles extraction errors gracefully with error log
- âœ… **Creates audit log entry**: PST uploaded, size, timestamp, user

### 2. Document Categorization Interface

**Given** documents have been extracted from the PST file
**When** the partner views the categorization interface
**Then** they can:
- âœ… **See folder tree matching original PST structure** (collapsible/expandable)
- âœ… **Navigate systematically through folders** (click folder to see its documents)
- âœ… **See document count per folder** in tree view
- âœ… See document preview (PDF viewer for PDF, rendered doc for DOCX/DOC)
- âœ… View metadata: filename, email subject, sender, date received, **folder path**
- âœ… Assign document to a category (dropdown + "Add New Category" option)
- âœ… Skip/ignore irrelevant documents
- âœ… Navigate between documents with keyboard shortcuts (â† â†’ arrows)
- âœ… See progress indicator (X of Y documents categorized)
- âœ… Filter view: All / Categorized / Uncategorized / Skipped / **By Folder**

### 3. Category Management

**Given** the partner is categorizing documents
**When** they need to create or manage categories
**Then** they can:
- âœ… Add new categories on-the-fly with Romanian names (e.g., "Contract", "Notificare Avocateasca", "Intampinare")
- âœ… Edit existing category names
- âœ… Merge categories if duplicates created
- âœ… See document count per category in real-time
- âœ… Categories persist across sessions

### 4. Session Persistence

**Given** the partner has categorized 100 of 500 documents
**When** they close the browser and return later
**Then**:
- âœ… All categorization progress is preserved
- âœ… They can resume from where they left off
- âœ… Previously skipped documents remain skipped
- âœ… Session data stored in browser IndexedDB (local-first)

### 5. OneDrive Export & Automatic Cleanup

**Given** the partner has finished categorizing documents
**When** they click "Export to OneDrive"
**Then** the system:
- âœ… Creates folder structure: `/AI-Training/{CategoryName}/`
- âœ… Uploads all categorized documents to respective folders
- âœ… Generates metadata JSON file per category with document info
- âœ… Shows upload progress with retry on failures
- âœ… Provides completion summary with document counts per category
- âœ… Skipped documents are NOT uploaded
- âœ… **CRITICAL: Automatically deletes original PST file from Azure Blob**
- âœ… **Deletes all temporary extracted documents from Azure Blob**
- âœ… **Creates audit log entry**: PST deleted, export completed, timestamp
- âœ… **Retains IndexedDB session data** (browser-side only) for potential re-export
- âœ… Displays "Data Cleanup Complete" confirmation to user

### 6. Bulk Folder Operations

**Given** the partner is viewing a PST folder with multiple documents
**When** they want to categorize all documents in that folder
**Then** they can:
- âœ… **Right-click folder** to see context menu
- âœ… **"Categorize All in Folder"** option assigns category to all uncategorized documents
- âœ… **"Skip All in Folder"** option skips all uncategorized documents
- âœ… Confirmation dialog shows count before bulk action
- âœ… Bulk actions can be undone before export
- âœ… Already-categorized documents are not affected by bulk actions

### 7. AI Training Integration Point

**Given** documents are exported to OneDrive
**When** the AI training pipeline runs
**Then**:
- âœ… Category folders are discoverable via known OneDrive path
- âœ… Metadata JSON files provide document context (including original folder path)
- âœ… Documents are accessible for embedding generation
- âœ… This story does NOT implement the training pipeline (deferred to Story 3.2.6)

## Technical Approach

### Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Client Browser (import.yourapp.com)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Next.js UI + IndexedDB (Dexie.js)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ HTTPS Upload                    â”‚ Categorization
            â”‚ (PST File)                      â”‚ & Preview
            â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Azure Backend Services                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Azure Blob      â”‚  â”‚  API Routes (Next.js)       â”‚  â”‚
â”‚  â”‚  Storage         â”‚  â”‚  - /api/upload-pst          â”‚  â”‚
â”‚  â”‚  (Encrypted)     â”‚  â”‚  - /api/extract-documents   â”‚  â”‚
â”‚  â”‚                  â”‚  â”‚  - /api/export-onedrive     â”‚  â”‚
â”‚  â”‚  - PST files     â”‚  â”‚  - /api/cleanup             â”‚  â”‚
â”‚  â”‚  - Temp docs     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                     â”‚
â”‚           â”‚                        â”‚                     â”‚
â”‚           â–¼                        â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PST Processor   â”‚  â”‚  Microsoft Graph API        â”‚  â”‚
â”‚  â”‚  (pst-extractor) â”‚  â”‚  (OneDrive Upload)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OneDrive (Partner's Account)                â”‚
â”‚               /AI-Training/{CategoryName}/               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Technology Stack

| Component | Technology | Rationale |
|-----------|-----------|-----------|
| **Frontend** | Next.js standalone app | Reuse existing tech stack, easy deployment |
| **Deployment** | Azure App Service | Same infrastructure as main app |
| **PST Parsing** | pst-extractor npm package (server-side) | Proven library, handles PST format, MIT license, Node.js only |
| **Temporary Storage** | Azure Blob Storage | Encrypted at rest (AES-256), secure, scalable |
| **Session Storage** | Dexie.js (IndexedDB wrapper) | Browser-side session persistence |
| **Document Preview** | react-pdf + @microsoft/office-js-helpers | PDF and Office doc rendering (browser) |
| **File Upload** | tus-js-client | Resumable uploads for large files (10GB+) |
| **OneDrive Upload** | Microsoft Graph API | Existing integration, batch upload support |
| **State Management** | Zustand | Lightweight, consistent with main app |
| **UI Components** | Radix UI + Tailwind | Reuse design system from main app |
| **Authentication** | Azure AD (existing) | Partner-only access, SSO |

### Data Model

```typescript
// IndexedDB Schema (Dexie.js)

interface ImportSession {
  id: string;
  pstFileName: string;
  uploadedAt: Date;
  totalDocuments: number;
  categorizedCount: number;
  skippedCount: number;
  status: 'in-progress' | 'completed' | 'exported';
  folderStructure: PSTFolder[]; // Root-level folders
}

interface PSTFolder {
  id: string;
  name: string;
  path: string; // Full path: "Inbox/Clients/Acme Corp"
  parentId?: string; // For nested folders
  documentCount: number;
  children?: PSTFolder[]; // Subfolders
}

interface ExtractedDocument {
  id: string;
  sessionId: string;
  fileName: string;
  fileExtension: 'pdf' | 'docx' | 'doc';
  fileSizeBytes: number;
  blobUrl: string; // ObjectURL for preview
  folderPath: string; // Original PST folder path
  folderId: string; // Reference to PSTFolder
  emailMetadata: {
    subject: string;
    sender: string;
    receivedDate: Date;
  };
  categoryId?: string;
  status: 'uncategorized' | 'categorized' | 'skipped';
  categorizedAt?: Date;
}

interface Category {
  id: string;
  name: string;
  documentCount: number;
  createdAt: Date;
}

interface ExportMetadata {
  sessionId: string;
  exportedAt: Date;
  categories: {
    categoryId: string;
    categoryName: string;
    documentCount: number;
    oneDriveFolderPath: string;
  }[];
}
```

### OneDrive Folder Structure

```
/AI-Training/
â”œâ”€â”€ Contract/
â”‚   â”œâ”€â”€ doc-001.pdf
â”‚   â”œâ”€â”€ doc-002.docx
â”‚   â””â”€â”€ _metadata.json
â”œâ”€â”€ Notificare Avocateasca/
â”‚   â”œâ”€â”€ doc-003.pdf
â”‚   â””â”€â”€ _metadata.json
â”œâ”€â”€ Intampinare/
â”‚   â”œâ”€â”€ doc-004.docx
â”‚   â””â”€â”€ _metadata.json
â””â”€â”€ _session_summary.json
```

### Metadata JSON Format

```json
{
  "category": "Contract",
  "documentCount": 42,
  "exportedAt": "2024-11-13T10:30:00Z",
  "documents": [
    {
      "fileName": "doc-001.pdf",
      "originalFileName": "Purchase Agreement - Acme Corp.pdf",
      "originalFolderPath": "Inbox/Clients/Acme Corp",
      "emailSubject": "RE: Contract review needed",
      "emailSender": "client@example.com",
      "emailDate": "2019-03-15T14:22:00Z",
      "fileSize": 245678
    }
  ]
}
```

## Implementation Plan

### Phase 1: Infrastructure & Secure Upload (Days 1-2)

1. Set up standalone Next.js app at `apps/legacy-import`
2. Configure Azure Blob Storage container (encrypted)
3. **Implement resumable file upload** using tus-js-client
4. Create API route `/api/upload-pst` with authentication
5. Implement server-side PST extraction with pst-extractor
6. **Extract folder hierarchy from PST server-side**
7. Store extracted documents in temp Azure Blob (encrypted)
8. Return extraction results to frontend via API
9. Basic progress UI with upload status

### Phase 2: Categorization UI (Days 3-5)

1. **Build folder tree component** (collapsible, expandable, with document counts)
2. **Implement folder navigation and filtering**
3. Build document viewer (PDF + DOCX/DOC)
4. Category dropdown with "Add New" functionality
5. Navigation controls (prev/next, keyboard shortcuts)
6. Filter bar (All/Categorized/Uncategorized/Skipped/By Folder)
7. **Bulk folder operations** (categorize all, skip all)
8. Progress tracking UI

### Phase 3: OneDrive Export & Cleanup (Days 6-7)

1. Microsoft Graph API authentication
2. Folder creation in OneDrive
3. Batch document upload (5 concurrent max)
4. Metadata JSON generation (including folder paths)
5. Upload progress UI with retry logic
6. **Implement automatic cleanup after export**:
   - Delete PST file from Azure Blob
   - Delete temp extracted documents
   - Create audit log entry
7. **Create cleanup confirmation UI**

### Phase 4: Polish & Testing (Days 8-10)

1. Error handling and validation
2. Loading states and optimistic UI
3. E2E testing with sample PST file
4. Performance testing with 1000+ documents
5. Documentation for users

## Testing Strategy

### Unit Tests
- PST extraction logic **including folder hierarchy**
- **Folder tree navigation and filtering**
- Category management operations
- IndexedDB data persistence
- Metadata JSON generation **with folder paths**

### Integration Tests
- OneDrive upload flow
- Session persistence across page reloads
- Category merge functionality
- **Bulk folder operations (categorize all, skip all)**

### E2E Tests (Playwright)
- Complete flow: Upload PST â†’ **Navigate folder tree** â†’ Categorize 10 docs â†’ Export to OneDrive
- **Folder navigation: Click folder â†’ Verify filtered documents â†’ Bulk categorize folder**
- Session resume: Categorize 5 docs â†’ Close tab â†’ Reopen â†’ Verify state
- Error handling: Network failure during upload â†’ Retry â†’ Success

### Manual Testing Checklist
- [ ] Upload real PST file (>1GB) **with nested folder structure**
- [ ] **Verify folder tree matches original PST hierarchy**
- [ ] **Navigate through folders systematically**
- [ ] **Test bulk categorize on folder with 50+ documents**
- [ ] Preview PDFs and DOCX files
- [ ] Create 5+ categories with Romanian names
- [ ] Categorize 100+ documents
- [ ] Verify OneDrive folder structure
- [ ] Confirm metadata JSON accuracy **including originalFolderPath**
- [ ] Test session persistence over 24 hours

## UI/UX Design

### Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Legacy Document Import & Categorization                              [Close]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Progress: 127 / 543 categorized  â”‚  Session: Active  â”‚  [Export to OneDrive]  â”‚
â”‚  [All] [Uncategorized] [Categorized] [Skipped] [By Folder]                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   â”‚                      â”‚  Document Preview                    â”‚
â”‚  PST Folders      â”‚  Document List       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚ â–¼ ðŸ“ Inbox   â”‚ â”‚  â”‚ doc-001.pdf ðŸ“„ â”‚  â”‚  â”‚   [PDF or DOCX rendered]       â”‚  â”‚
â”‚  â”‚   â–¸ Clients  â”‚ â”‚  â”‚ Contract       â”‚  â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚   â–¸ Court    â”‚ â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚   (127)      â”‚ â”‚  â”‚ doc-002.docxðŸ“ â”‚  â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚              â”‚ â”‚  â”‚ Uncategorized  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚ â–¼ ðŸ“ Sent    â”‚ â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                                      â”‚
â”‚  â”‚   (43)       â”‚ â”‚  â”‚ doc-003.pdf ðŸ“„ â”‚  â”‚  Metadata:                           â”‚
â”‚  â”‚              â”‚ â”‚  â”‚ Notificare...  â”‚  â”‚  Folder: Inbox/Clients/Acme Corp     â”‚
â”‚  â”‚ â–¸ ðŸ“ Archive â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  Subject: RE: Contract review        â”‚
â”‚  â”‚   â–¸ 2023     â”‚ â”‚                      â”‚  From: client@example.com            â”‚
â”‚  â”‚   â–¸ 2022     â”‚ â”‚  Showing: Inbox      â”‚  Date: Mar 15, 2019                  â”‚
â”‚  â”‚   (373)      â”‚ â”‚  Documents: 127      â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                      â”‚  Category: [Select...          â–¼]    â”‚
â”‚                   â”‚  Categories:         â”‚            [+ Add New Category]      â”‚
â”‚                   â”‚  â€¢ Contract (42)     â”‚                                      â”‚
â”‚                   â”‚  â€¢ Notificare.. (18) â”‚  [â† Previous]  [Skip]  [Next â†’]      â”‚
â”‚                   â”‚  â€¢ Intampinare (31)  â”‚                                      â”‚
â”‚                   â”‚  + Add Category      â”‚  [Right-click folder for bulk ops]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Interactions

- **Keyboard Shortcuts:**
  - `â†’` Next document
  - `â†` Previous document
  - `S` Skip document
  - `1-9` Quick assign to first 9 categories
  - `/` Focus category search
  - `Space` Expand/collapse selected folder

- **Folder Navigation:**
  - Click folder to filter documents to that folder
  - **Right-click folder** for context menu (Categorize All, Skip All)
  - Expand/collapse folders to navigate hierarchy
  - Folder document counts update in real-time

- **Drag & Drop:** PST file upload area

- **Quick Categorization:** Type to filter categories, Enter to assign

## Security & Compliance

### Data Protection Measures

**Upload Security:**
- âœ… HTTPS/TLS 1.3 for all data in transit
- âœ… Azure AD authentication required (Partner role minimum)
- âœ… File size validation before upload (reject >10GB)
- âœ… File type validation (only .pst accepted)
- âœ… Rate limiting on upload endpoint (1 upload per user per hour)

**Storage Security:**
- âœ… Azure Blob Storage with server-side encryption (AES-256)
- âœ… Temporary container with 7-day auto-delete policy (backup)
- âœ… Private blob access (no public URLs)
- âœ… SAS tokens with 1-hour expiration for downloads
- âœ… Blob versioning enabled for audit trail

**Data Lifecycle:**
1. **Upload:** PST encrypted at rest in Azure Blob
2. **Processing:** Extracted docs encrypted in temp blob
3. **Categorization:** IndexedDB in browser (never touches server)
4. **Export:** Only categorized docs go to OneDrive
5. **Cleanup:** PST + temp docs deleted from Azure Blob immediately
6. **Retention:** IndexedDB remains in browser for re-export (user can clear)

**Audit Logging:**
- All PST uploads logged with: userId, timestamp, filename, size
- All extractions logged with: documentCount, successCount, failureCount
- All exports logged with: categoryCount, documentCount, oneDrivePath
- All deletions logged with: what was deleted, when, by whom
- Logs retained for 90 days in Application Insights

**Access Control:**
- Only Partners can access `import.yourapp.com`
- Session timeout: 4 hours of inactivity
- Re-authentication required before export to OneDrive

### GDPR & Romanian Law Compliance

- âœ… **Data Minimization:** Only document attachments extracted, emails discarded
- âœ… **Right to Erasure:** Partner can manually delete OneDrive folder anytime
- âœ… **Data Portability:** Documents exported to partner's own OneDrive
- âœ… **Purpose Limitation:** Data used only for AI training, not in main app
- âœ… **Storage Limitation:** Automatic deletion from Azure after export
- âœ… **Confidentiality:** Encrypted at rest and in transit
- âœ… **Accountability:** Complete audit trail maintained

### Cost Considerations

**Azure Blob Storage:**
- Temporary storage cost: ~â‚¬0.02 per GB per month
- 10GB PST stored for ~2 hours during processing: <â‚¬0.01
- 100 documents (~500MB) stored 1 week: ~â‚¬0.01
- **Estimated total: <â‚¬1 per import session**

## Rollback Plan

Since this is a standalone app:
- No impact on main application if issues arise
- Can disable route to import app via feature flag
- Session data in IndexedDB can be exported as JSON backup
- OneDrive files can be manually deleted if needed
- Azure Blob cleanup can be run manually via admin script
- Failed uploads can be resumed via tus protocol

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Unit tests pass with >80% coverage
- [ ] E2E tests pass in Playwright
- [ ] Manual testing completed with real PST file
- [ ] Code reviewed and approved
- [ ] Documentation created in `apps/legacy-import/README.md`
- [ ] Deployed to staging environment
- [ ] Partner successfully categorizes 100+ documents
- [ ] Documents verified in OneDrive with correct structure

## Future Enhancements (Not in Scope)

- AI-suggested categorization based on document content
- Bulk categorization (select multiple â†’ assign category)
- Export to other storage providers (Azure Blob, Google Drive)
- Automatic duplicate detection
- OCR for scanned PDFs
- Category templates for common legal practice areas

## Integration with Main App

While this is a standalone flow, the categorized documents will feed into the main app's AI training pipeline (Story 3.2.6). The integration points are:

1. **OneDrive Path Convention:** Main app AI service knows to look in `/AI-Training/` folder
2. **Metadata Format:** `_metadata.json` follows agreed schema for training pipeline
3. **Authentication:** Uses same Azure AD app registration as main app
4. **Design System:** Reuses Radix UI + Tailwind components for consistency

## Questions & Answers

**Q: Why not integrate directly into main app?**
A: Standalone app keeps this one-time workflow isolated, avoiding complexity in main app. Easier to deprecate after migration complete.

**Q: Is it secure to upload sensitive PST files to the server?**
A: Yes. Files are encrypted in transit (HTTPS/TLS 1.3) and at rest (AES-256). They're automatically deleted after export. Only categorized documents remain (in partner's own OneDrive). Complete audit trail maintained for compliance.

**Q: What happens if PST file is corrupted?**
A: pst-extractor will throw errors for corrupted sections. We'll log errors and extract what's possible, showing user a report of failures.

**Q: Can they re-categorize documents?**
A: Yes, categorization is editable until export. After export, they'd need to re-run export (overwrites OneDrive).

**Q: How do we handle duplicate filenames?**
A: Append UUID to duplicate filenames: `contract.pdf` â†’ `contract-a3f2b1c4.pdf`

**Q: What if OneDrive is full?**
A: Graph API will return quota error. We display error and suggest cleaning up OneDrive or upgrading storage.

**Q: What if the user closes browser during upload?**
A: Resumable upload (tus) allows them to continue from where they left off. PST remains in Azure Blob until extraction completes or 7 days (auto-delete).

## Success Metrics

- Partner successfully imports and categorizes 500+ documents in first session
- <5% error rate in PST extraction
- Resumable upload works reliably for 10GB files
- OneDrive export completes with 100% success rate
- Partner can resume session without data loss
- Average categorization time: <10 seconds per document
- **Automatic cleanup completes in <30 seconds after export**
- **Zero security incidents (encrypted storage + automatic deletion)**
- Azure Blob storage costs <â‚¬1 per import session

---

**Story Status:** Ready for Implementation
**Created:** 2024-11-13
**Last Updated:** 2024-11-13
**Author:** Mary (Business Analyst)
