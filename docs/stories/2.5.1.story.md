# Story 2.5.1: Graph API Integration - Test Infrastructure Refactoring

## Status

Draft

## Story

**As a** platform developer,
**I want** stable and reliable test infrastructure for the Graph API integration,
**so that** we have confidence in production deployments and can maintain the codebase with minimal test flakiness.

## Acceptance Criteria

1. All integration tests pass consistently (0 failures from current 61 failing tests)
2. Branch coverage meets 80% threshold (currently 76.16%)
3. Cache middleware integration tests pass without TypeError exceptions
4. Webhook service unit tests pass with properly configured mocks
5. Test execution is reliable and repeatable across environments
6. Test suite completes in <120 seconds with no timeout issues

## Tasks / Subtasks

### Phase 1: Cache Middleware Integration Fixes (AC: 1, 3)

- [ ] **Task 1: Investigate and Fix Cache Middleware TypeError** (AC: 3)
  - [ ] Analyze TypeError: "Cannot read properties of undefined (reading 'then')" in integration tests
  - [ ] Review Express response mocking differences between unit and integration test contexts
  - [ ] Refactor cache middleware res.json() override to be compatible with both test contexts
  - [ ] Alternative: Implement cache middleware using Express middleware chaining instead of response override
  - [ ] Verify all 34 unit tests still pass after changes
  - [ ] Verify integration tests pass (graph-api.integration.test.ts cache scenarios)
  - [ ] Document the fix and testing approach for future reference

- [ ] **Task 2: Add Missing Cache Integration Test Scenarios** (AC: 1, 3)
  - [ ] Test cache hit/miss cycles in realistic request flows
  - [ ] Test cache invalidation after POST/PUT/DELETE operations
  - [ ] Test concurrent requests with cache warming
  - [ ] Test cache TTL expiration and refresh
  - [ ] Achieve 100% passing rate for cache integration tests

### Phase 2: Webhook Service Mock Configuration (AC: 1, 4)

- [ ] **Task 3: Restructure Webhook Service Test Mocks** (AC: 4)
  - [ ] Document root cause: Jest clearAllMocks() clears mockImplementation in beforeEach
  - [ ] Refactor webhook.service.test.ts mock setup to avoid clearAllMocks lifecycle issue
  - [ ] Option A: Use mockImplementation inside each test instead of beforeEach
  - [ ] Option B: Remove clearAllMocks and use resetMocks with explicit mock setup
  - [ ] Option C: Create mock factory functions that preserve implementation
  - [ ] Fix all 8+ failing webhook service unit tests
  - [ ] Ensure webhook service maintains 84%+ coverage

- [ ] **Task 4: Standardize Mock Patterns Across Test Suite** (AC: 1, 4)
  - [ ] Document best practices for Graph API client mocking
  - [ ] Create reusable mock utilities in `__tests__/utils/test-helpers.ts`
  - [ ] Apply standardized mocking to graph.service.test.ts
  - [ ] Apply standardized mocking to webhook.service.test.ts
  - [ ] Create developer guide for adding new Graph API tests

### Phase 3: Integration Test Reliability (AC: 1, 5, 6)

- [ ] **Task 5: Fix Integration Test Timeouts and Timing Issues** (AC: 1, 6)
  - [ ] Review retry-error-handling.integration.test.ts timeout failures
  - [ ] Analyze graph-api.integration.test.ts timing-sensitive tests
  - [ ] Increase timeout for long-running retry tests (exponential backoff validation)
  - [ ] Add explicit wait/polling for async operations instead of fixed delays
  - [ ] Ensure all integration tests complete within individual 20-second timeout
  - [ ] Optimize test suite to complete in <120 seconds total

- [ ] **Task 6: Improve Integration Test Isolation** (AC: 1, 5)
  - [ ] Ensure tests properly clean up Redis cache between runs
  - [ ] Add beforeEach/afterEach cleanup for database state (graph_subscriptions table)
  - [ ] Mock external Graph API calls in integration tests (avoid real API dependency)
  - [ ] Use unique test data keys to prevent cross-test contamination
  - [ ] Run integration tests with --runInBand flag to ensure sequential execution

### Phase 4: Branch Coverage Improvements (AC: 2)

- [ ] **Task 7: Add Branch Coverage Tests for Middlewares** (AC: 2)
  - [ ] Identify uncovered branches in cache.middleware.ts (currently 96.96% but integration failures)
  - [ ] Identify uncovered branches in rate-limit.middleware.ts
  - [ ] Add edge case tests for error paths:
    - Redis connection failures
    - Invalid session data
    - Malformed request data
  - [ ] Add negative test cases:
    - Cache invalidation with no matching keys
    - Rate limiting with corrupted Redis data
    - Token refresh with expired credentials
  - [ ] Achieve 80%+ branch coverage overall

- [ ] **Task 8: Add Edge Case Tests for Services** (AC: 2)
  - [ ] GraphService: Test with invalid Graph API responses
  - [ ] WebhookService: Test subscription renewal failures and retries
  - [ ] Add boundary tests for retry logic (max retries, circuit breaker edge cases)
  - [ ] Add tests for concurrent operations (parallel requests, race conditions)

### Phase 5: Test Infrastructure Documentation (AC: 5)

- [ ] **Task 9: Document Test Patterns and Best Practices** (AC: 5)
  - [ ] Create `services/gateway/__tests__/README.md` with:
    - Mock configuration patterns
    - Integration test setup guide
    - Debugging failing tests guide
    - CI/CD considerations
  - [ ] Document common pitfalls:
    - Jest lifecycle (clearAllMocks vs resetMocks)
    - Express response mocking in different contexts
    - Async test timing and polling strategies
  - [ ] Add inline comments explaining complex test setups

- [ ] **Task 10: Improve Test Error Messages and Debugging** (AC: 5)
  - [ ] Add descriptive test names following pattern: "should [expected behavior] when [condition]"
  - [ ] Add custom error messages to assertions for clearer failure diagnostics
  - [ ] Add debug logging for integration test failures (conditional on DEBUG env var)
  - [ ] Create test failure troubleshooting guide

### Phase 6: Validation and Regression Prevention (All ACs)

- [ ] **Task 11: Full Test Suite Validation**
  - [ ] Run full test suite: `npx jest` with coverage
  - [ ] Verify 0 failing tests (572 total tests, 572 passing)
  - [ ] Verify branch coverage ≥ 80% (currently 76.16%)
  - [ ] Verify test execution time < 120 seconds
  - [ ] Run tests 5 times consecutively to ensure stability

- [ ] **Task 12: CI/CD Integration**
  - [ ] Document test execution requirements for CI/CD pipeline
  - [ ] Add test stability checks to pre-commit hooks (optional)
  - [ ] Create npm scripts for test suite subsets:
    - `npm run test:unit` - Unit tests only
    - `npm run test:integration` - Integration tests only
    - `npm run test:coverage` - With coverage threshold enforcement
  - [ ] Update CI/CD configuration with proper test timeouts and parallel execution settings

## Dev Notes

### Background Context

**From Story 2.5 QA Review (2025-11-21):**

Story 2.5 successfully implemented Microsoft Graph API integration with excellent code architecture and comprehensive unit test coverage. However, the test infrastructure has reliability issues:

- **Test Status**: 572 total tests, 511 passing (89.3%), 61 failing (10.7%)
- **Coverage**: Statements 83.79% ✓, Branches 76.16% ⚠ (3.84% below 80%), Functions 85.71% ✓
- **Quality Gate**: CONCERNS (60/100 score)
- **Core Issue**: Test infrastructure reliability, not production code quality

**Critical Issues Identified:**

1. **Cache Middleware Integration Failures**
   - Error: `TypeError: Cannot read properties of undefined (reading 'then')`
   - Location: `src/middleware/cache.middleware.ts:126`
   - Root Cause: Express response override (`res.json`) works in unit tests but fails in integration tests
   - Impact: Cache middleware unit tests pass (34/34), integration tests fail

2. **Webhook Service Mock Configuration**
   - 8+ failing unit tests in `__tests__/services/webhook.service.test.ts`
   - Root Cause: Jest `clearAllMocks()` in beforeEach clears mockImplementation
   - Previous attempts to fix using graph.service.test.ts pattern were unsuccessful
   - Impact: Core webhook functionality works (37 integration tests passing), but unit test mocks unstable

3. **Integration Test Timeouts**
   - Several integration tests timeout despite realistic test scenarios
   - Retry logic tests with exponential backoff may need longer timeouts
   - Graph API integration tests have timing-sensitive assertions

4. **Branch Coverage Gap**
   - Current: 76.16% branches
   - Required: 80% branches
   - Gap: 3.84% (~30-40 uncovered branches)
   - Primary gaps in error paths and edge cases

### Technical Architecture

#### Test File Structure

[Source: Story 2.5 implementation]

```
services/gateway/__tests__/
├── config/
│   └── graph.config.test.ts (32 tests, passing ✓)
├── middleware/
│   ├── cache.middleware.test.ts (34 tests, passing ✓) **UNIT ONLY**
│   ├── rate-limit.middleware.test.ts (14 tests, passing ✓)
│   └── token-refresh.middleware.test.ts (13 tests, passing ✓)
├── services/
│   ├── graph.service.test.ts (partially passing ⚠)
│   └── webhook.service.test.ts (14/22 passing ⚠) **TARGET FOR FIX**
├── utils/
│   ├── graph-error-handler.test.ts (25 tests, passing ✓)
│   ├── retry.util.test.ts (19 tests, passing ✓)
│   ├── graph-api-wrapper.test.ts (17 tests, passing ✓)
│   ├── token-helpers.test.ts (52 tests, passing ✓)
│   └── logger.test.ts (11 tests, passing ✓)
├── workers/
│   └── subscription-renewal.worker.test.ts (18 tests, passing ✓)
└── integration/
    ├── graph-api.integration.test.ts (FAILURES ⚠) **TARGET FOR FIX**
    ├── retry-error-handling.integration.test.ts (16 tests, some failures ⚠)
    ├── graph-rate-limiting.integration.test.ts (16 tests, passing ✓)
    ├── email-webhooks.integration.test.ts (9 tests, passing ✓)
    └── file-webhooks.integration.test.ts (10 tests, passing ✓)
```

#### Mock Configuration Patterns

**Working Pattern (from graph.service.test.ts):**

```typescript
// Use require() for mocks inside test functions, not in beforeEach
jest.mock('@microsoft/microsoft-graph-client');

describe('GraphService', () => {
  let mockGraphClient: jest.Mocked<Client>;

  beforeEach(() => {
    // DO NOT use clearAllMocks() - it clears mockImplementation
    jest.resetModules();
  });

  it('should work', () => {
    // Setup mocks inside each test
    const GraphClient = require('@microsoft/microsoft-graph-client').Client;
    mockGraphClient = {
      api: jest.fn().mockReturnThis(),
      get: jest.fn().mockResolvedValue(/* data */),
    } as any;
    GraphClient.init = jest.fn().mockReturnValue(mockGraphClient);

    // Test code...
  });
});
```

**Problematic Pattern (from webhook.service.test.ts):**

```typescript
// This pattern fails with clearAllMocks()
jest.mock('@microsoft/microsoft-graph-client');

beforeEach(() => {
  jest.clearAllMocks(); // <-- THIS CLEARS mockImplementation

  // This setup gets cleared before test runs
  mockGraphClient = {
    api: jest.fn().mockReturnThis(),
    post: jest.fn().mockResolvedValue(/* ... */),
  } as any;
  (Client.init as jest.Mock).mockReturnValue(mockGraphClient);
});
```

#### Cache Middleware Issue

**Current Implementation (works in unit tests):**

```typescript
// services/gateway/src/middleware/cache.middleware.ts:126
return res.status(200).json(cachedResponse) as any;
```

**Integration Test Error:**

```
TypeError: Cannot read properties of undefined (reading 'then')
  at ServerResponse.res.json (src/middleware/cache.middleware.ts:126:17)
```

**Hypothesis:** Integration tests use different Express response mocking that expects res.json() to return a Promise-like object, while unit tests mock it to return `this`.

**Potential Solutions:**

1. Use Express middleware chaining instead of response override
2. Create cache middleware wrapper that doesn't modify res.json
3. Use different mocking strategy in integration tests
4. Refactor to use Express send() instead of json() for cached responses

### Testing Standards

**Test Coverage Requirements:**

- Overall coverage: ≥ 80% for statements, branches, functions, lines
- Unit tests: 100% for utilities, 95%+ for services
- Integration tests: Cover critical user journeys and API interactions
- Test reliability: 100% pass rate across 5 consecutive runs

**Test Organization:**

- Unit tests: `__tests__/{category}/{file}.test.ts`
- Integration tests: `__tests__/integration/{feature}.integration.test.ts`
- Test utilities: `__tests__/utils/test-helpers.ts`
- Mock factories: `__tests__/mocks/{module}.mock.ts`

**Testing Frameworks:**

- Jest 29+ for unit and integration tests
- Supertest 6.3+ for API endpoint testing
- @testing-library patterns for React components (if applicable)

**Test Naming Convention:**

```typescript
describe('ModuleName', () => {
  describe('functionName', () => {
    it('should [expected behavior] when [condition]', () => {
      // Arrange
      // Act
      // Assert
    });
  });
});
```

**Mock Best Practices:**

1. Use `jest.resetModules()` instead of `clearAllMocks()` when mocking modules
2. Setup mocks inside test functions for stability
3. Create mock factories for reusable mock configurations
4. Use explicit mock implementations over auto-mocking
5. Clean up mocks in afterEach to prevent cross-test contamination

### Dependencies

**Existing from Story 2.5:**

- Jest 29+
- Supertest 6.3+
- @microsoft/microsoft-graph-client@^3.0.0 (mocked)
- Redis client from @legal-platform/database (mocked)

**No new dependencies required** - this is purely test infrastructure refactoring.

### Performance Targets

- **Test Suite Execution**: < 120 seconds total
- **Individual Test Timeout**: ≤ 20 seconds (configurable in jest.config.js)
- **Integration Test Timeout**: ≤ 30 seconds for complex retry scenarios
- **Test Stability**: 100% pass rate across 5 consecutive runs

### Environment Variables

**For Testing:**

```bash
NODE_ENV=test
DEBUG=false  # Set to true for verbose test logging
JEST_TIMEOUT=20000  # Default timeout for tests (20 seconds)
```

### Related Stories

- **Story 2.5**: Microsoft Graph API Integration Foundation (parent story)
- **Story 2.6**: (Next feature story - this doesn't block 2.6)

### Success Criteria

This story is complete when:

1. ✅ All 572 tests pass (0 failures)
2. ✅ Branch coverage ≥ 80%
3. ✅ Test suite completes in < 120 seconds
4. ✅ Tests are stable (100% pass rate across 5 runs)
5. ✅ Documentation updated with test patterns and troubleshooting guide
6. ✅ QA review passes with PASS gate (not CONCERNS or FAIL)

## Change Log

| Date       | Version | Description                                             | Author     |
| ---------- | ------- | ------------------------------------------------------- | ---------- |
| 2025-11-21 | 1.0     | Initial story created from Story 2.5 QA review findings | Quinn (QA) |

## Dev Agent Record

### Agent Model Used

(To be populated by dev agent during implementation)

### Implementation Progress

(To be populated by dev agent during implementation)

### Files Created

(To be populated by dev agent during implementation)

### Files Modified

(To be populated by dev agent during implementation)

## QA Results

(To be populated by QA agent after implementation)
