# Story 1.14: Dashboard Widget Behavior Enhancements

**Epic**: 1 - UI Foundation & Interactive Prototype
**Story**: 1.14
**Status**: ✅ Ready for Review
**Dependencies**: 1.4, 1.5.5, 1.13
**Created**: 2025-11-18
**Last Updated**: 2025-11-18

---

## Story

**As a** law firm user viewing my dashboard
**I want** widgets to intelligently size based on their content and expand smoothly without overlapping
**So that** I can see all relevant information clearly and interact with dynamic content comfortably

---

## Context

The current dashboard widget implementation has several UX issues:

1. **Fixed Sizing**: Widgets use uniform sizes regardless of content needs
2. **Overlap on Expansion**: When widgets expand (e.g., showing more items in a list), they overlap widgets below
3. **Poor Initial Sizing**: Widgets don't adapt initial height to content amount

This creates a frustrating experience where users either see truncated information or expanding widgets that cover other content. We need a dynamic, content-aware grid system.

---

## Acceptance Criteria

### AC1: Content-Aware Initial Sizing

**Given** a dashboard loads with various widgets
**When** each widget renders its initial content
**Then** the widget height MUST be sized to fit its content without unnecessary whitespace
**And** widgets with more content should be taller than widgets with less content
**And** widgets should respect minimum and maximum height constraints

**Examples**:
- "Recent Cases" widget with 3 cases: ~200px height
- "Recent Cases" widget with 10 cases: ~400px height (with scroll if needed)
- "Quick Stats" widget with 4 metrics: ~150px height

### AC2: Smooth Expansion Without Overlap

**Given** a widget has expandable content (e.g., "Show More" button)
**When** the user clicks to expand the content
**Then** the widget MUST animate smoothly to its new height
**And** all widgets below it MUST move down ("push" behavior) to accommodate the expansion
**And** no overlapping of widgets should occur at any point during the animation
**And** the grid layout should reflow seamlessly

**Animation Requirements**:
- Expansion duration: 300ms
- Easing: ease-in-out
- Layout shift should be synchronized with widget expansion

### AC3: Collapse Returns to Original Layout

**Given** a widget is in expanded state
**When** the user collapses it (clicks "Show Less")
**Then** the widget MUST animate back to its original height
**And** widgets below MUST move up to fill the space
**And** the dashboard should return to its pre-expansion layout

---

## Tasks

### Task 1: Update DashboardGrid for Dynamic Layout
- [x] Modify DashboardGrid.tsx to use CSS Grid with `auto-rows`
- [x] Update grid styles for responsive columns (mobile/tablet/desktop)
- [x] Ensure proper grid gap (1.5rem) and minimum widget width (300px)

### Task 2: Implement Widget Expansion Logic in WidgetContainer
- [x] Add expansion state management (useState for isExpanded)
- [x] Implement content height tracking with useRef and useEffect
- [x] Add smooth height transition animation (300ms ease-in-out)
- [x] Handle rapid expand/collapse clicks (debounce/disable during animation)

### Task 3: Add Expandable Content to Widgets
- [x] Implement expansion in SupervisedCasesWidget.tsx (shows 3 cases initially, expands to show all)
- [x] Add expansion to FirmTasksOverviewWidget.tsx with "Show More/Less" functionality
- [x] Add expansion to AssignedTasksWidget.tsx with "Show More/Less" functionality (per-column expansion)
- [x] Core expansion infrastructure in WidgetContainer complete

### Task 4: Implement Accessibility Features
- [x] Add aria-expanded attribute to expansion buttons
- [x] Implement focus management (keep focus on button after expansion)
- [x] Add screen reader announcements for expansion state changes (ARIA live regions)
- [x] Ensure keyboard navigation works correctly during animations
- [x] Add prefers-reduced-motion support to disable animations when needed

### Task 5: Add Performance Optimizations
- [x] Use will-change: height sparingly (only during active animation)
- [x] Implement content-visibility: auto for off-screen widgets
- [x] Ensure 60fps animation performance (CSS transitions)
- [x] Avoid layout thrashing with batched DOM reads/writes (proper state management)

### Task 6: Write Comprehensive Tests
- [x] Unit tests for WidgetContainer expansion/collapse behavior
- [x] Unit tests for SupervisedCasesWidget expansion (8 tests)
- [x] Unit tests for FirmTasksOverviewWidget expansion (8 tests)
- [x] Accessibility tests included (ARIA attributes, focus management, screen reader announcements)
- [x] Performance optimizations verified (CSS transitions, content-visibility)

### Task 7: Validate Against Acceptance Criteria
- [x] AC1: Content-aware initial sizing (CSS Grid auto-rows)
- [x] AC2: Smooth expansion without overlap (300ms ease-in-out, grid reflow)
- [x] AC3: Collapse returns to original layout (tested)
- [x] ARIA accessibility features implemented
- [x] Responsive behavior works (CSS Grid responsive columns)
- [x] Performance optimizations in place (will-change, content-visibility, prefers-reduced-motion)

---

## Technical Implementation Notes

### Architecture Decisions

**Option 1: CSS Grid with auto-rows** (Recommended)
```css
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  grid-auto-rows: auto; /* Let content determine height */
  gap: 1.5rem;
}
```

**Option 2: React Grid Layout Library**
- Use `react-grid-layout` for advanced grid control
- More complex but handles expansion/collapse automatically
- Overkill if CSS Grid solution works

**Recommended**: Start with CSS Grid (Option 1), use library only if needed

### Files to Modify

```
apps/web/src/components/dashboard/
├── DashboardGrid.tsx              # Main grid container logic
├── WidgetContainer.tsx            # Widget wrapper with expansion logic
├── widgets/
│   ├── RecentCasesWidget.tsx      # Add expandable content
│   ├── TaskSummaryWidget.tsx      # Add expandable content
│   ├── UpcomingDeadlinesWidget.tsx # Add expandable content
│   └── EmployeeWorkloadWidget.tsx # Fix existing expansion behavior
└── styles/
    └── dashboard.module.css       # Grid and animation styles
```

### Implementation Steps

1. **Update Grid Container**:
   ```tsx
   // DashboardGrid.tsx
   <div className={styles.dashboardGrid}>
     {widgets.map(widget => (
       <WidgetContainer key={widget.id} widget={widget} />
     ))}
   </div>
   ```

2. **Add Expansion State to WidgetContainer**:
   ```tsx
   const [isExpanded, setIsExpanded] = useState(false);
   const contentRef = useRef<HTMLDivElement>(null);
   const [contentHeight, setContentHeight] = useState<number>(0);
   ```

3. **Implement Smooth Height Transition**:
   ```tsx
   useEffect(() => {
     if (contentRef.current) {
       setContentHeight(isExpanded
         ? contentRef.current.scrollHeight
         : initialHeight);
     }
   }, [isExpanded]);
   ```

4. **CSS for Smooth Animation**:
   ```css
   .widget-container {
     overflow: hidden;
     transition: height 300ms ease-in-out;
   }
   ```

### Edge Cases to Handle

- **Rapid expand/collapse**: Debounce or disable button during animation
- **Multiple widgets expanding**: Ensure all reflow correctly
- **Responsive breakpoints**: Test expansion on mobile/tablet/desktop
- **Accessibility**: Ensure focus management during expansion
- **Print view**: Widgets should show full content when printing

---

## Design Specifications

### Widget Height Guidelines

| Content Type | Initial Height | Max Height | Expansion Behavior |
|--------------|---------------|------------|-------------------|
| Stats/Metrics | Auto (min 120px) | 200px | No expansion |
| Recent Items (3-5) | Auto (min 180px) | 400px | Show more → expand |
| Charts/Graphs | 300px | 500px | Fullscreen option |
| Activity Feed | Auto (min 200px) | 600px | Infinite scroll |

### Spacing & Layout

- Grid gap: `1.5rem` (24px) - both horizontal and vertical
- Minimum widget width: `300px`
- Responsive columns:
  - Desktop (>1200px): 3 columns
  - Tablet (768-1199px): 2 columns
  - Mobile (<768px): 1 column

---

## Testing Requirements

### Unit Tests

```typescript
describe('WidgetContainer', () => {
  it('should render with initial content-based height', () => {});
  it('should expand smoothly when Show More clicked', () => {});
  it('should collapse back to original height', () => {});
  it('should not overlap other widgets during expansion', () => {});
});

describe('DashboardGrid', () => {
  it('should reflow layout when widget expands', () => {});
  it('should maintain grid gap consistency', () => {});
  it('should handle multiple widget expansions', () => {});
});
```

### Visual Regression Tests

- Capture dashboard states:
  - All widgets collapsed (initial state)
  - Single widget expanded
  - Multiple widgets expanded
  - Different content amounts (3 items vs 10 items)

### Manual QA Checklist

- [ ] Widgets size appropriately to initial content
- [ ] Expansion animation is smooth (300ms, no jank)
- [ ] Widgets below push down during expansion
- [ ] No overlapping occurs during transition
- [ ] Collapse returns to original layout
- [ ] Multiple expansions work correctly
- [ ] Responsive behavior works on mobile/tablet/desktop
- [ ] Keyboard navigation works (focus management)
- [ ] Print view shows all content
- [ ] Performance: No lag with 10+ widgets

---

## User Impact

**Severity**: Medium (affects core dashboard experience)
**User Value**: High (significantly improves usability)
**Effort**: Medium (8-12 hours)

### Before

- Fixed-size widgets waste space or truncate content
- Expanding widgets overlap content below
- Users struggle to see all relevant information

### After

- Widgets intelligently size to content
- Smooth expansion with no overlaps
- Professional, polished dashboard experience

---

## Accessibility Considerations

- **ARIA**: Add `aria-expanded` attribute to expansion buttons
- **Focus Management**: Keep focus on "Show Less" button after expansion
- **Screen Readers**: Announce expansion state changes
- **Keyboard**: Ensure Tab navigation works correctly during animation
- **Reduced Motion**: Respect `prefers-reduced-motion` for animations

```css
@media (prefers-reduced-motion: reduce) {
  .widget-container {
    transition: none;
  }
}
```

---

## Performance Considerations

- Use `will-change: height` sparingly (only during animation)
- Avoid layout thrashing by batching DOM reads/writes
- Consider `content-visibility: auto` for off-screen widgets
- Monitor frame rate during expansion (target: 60fps)

---

## Definition of Done

- [ ] Widgets size based on initial content (AC1)
- [ ] Expansion pushes widgets below without overlap (AC2)
- [ ] Collapse returns to original layout (AC3)
- [ ] All edge cases handled (rapid clicks, multiple expansions, etc.)
- [ ] Unit tests implemented and passing
- [ ] Visual regression tests passing
- [ ] Manual QA checklist completed
- [ ] Accessibility audit passed (WCAG 2.1 AA)
- [ ] Performance benchmarks met (60fps animations)
- [ ] Responsive behavior verified on all breakpoints
- [ ] Code review approved
- [ ] Deployed to staging and tested
- [ ] Product owner approval obtained

---

## Related Stories

- **Story 1.4**: Dashboard Mockups for All Roles (original dashboard)
- **Story 1.5.5**: Enhanced Partner Dashboard (operational focus)
- **Story 1.13**: Layout & Spacing Fixes (complementary polish story)
- **Story 1.12**: Reports & Analytics Interface (similar widget patterns)

---

## Future Enhancements

Consider for future stories:
- Widget drag-and-drop reordering
- User-customizable widget sizes
- Widget hide/show preferences
- Dashboard layout templates by role

---

## Rollback Plan

If issues arise after deployment:

1. **Immediate**: Feature flag to restore fixed-height widgets
2. **Within 2 hours**: Git revert if feature flag insufficient
3. **Communication**: Notify users via in-app notification

**Risk Level**: Medium
- UI changes are visible to all users
- Animation bugs could affect UX significantly
- CSS Grid compatibility issues on older browsers

**Mitigation**:
- Thorough testing across browsers
- Feature flag for gradual rollout
- Fallback to simple height transition if issues detected

---

## Browser Compatibility

**Minimum Support**:
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

**CSS Grid `auto-rows`**: Supported in all target browsers
**CSS Transitions**: Widely supported
**`scrollHeight`**: Supported in all browsers

---

## Notes

- This story significantly improves dashboard UX and should be prioritized
- Pairs well with Story 1.13 for a comprehensive dashboard refresh
- Consider user testing with pilot firm before full rollout
- Monitor analytics for widget expansion usage patterns post-launch

---

## Dev Agent Record

### Agent Model Used
- Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- None yet

### Completion Notes
- Tasks auto-generated from story content on 2025-11-18
- Replaced react-grid-layout with CSS Grid (grid-auto-rows) for content-aware sizing
- Removed h-full constraints from WidgetContainer to allow dynamic height
- Added expansion context and hooks for child widgets to control expansion
- Implemented expansion in SupervisedCasesWidget, FirmTasksOverviewWidget, and AssignedTasksWidget
- CSS Grid now handles automatic widget reflow on expansion (no manual calculation needed)
- Added comprehensive accessibility features: aria-expanded, focus management, ARIA live regions
- Performance optimizations: content-visibility, will-change, prefers-reduced-motion
- Wrote 16+ unit tests for expansion/collapse behavior with accessibility validation
- All widgets show first 3 items initially, expand to show all on user interaction
- AssignedTasksWidget uses per-column expansion for granular control

### File List
- apps/web/src/components/dashboard/DashboardGrid.css (CSS Grid styles, performance optimizations)
- apps/web/src/components/dashboard/widgets/SupervisedCasesWidget.tsx (expansion with accessibility)
- apps/web/src/components/dashboard/widgets/FirmTasksOverviewWidget.tsx (priority tasks expansion)
- apps/web/src/components/dashboard/widgets/AssignedTasksWidget.tsx (per-column kanban expansion)
- apps/web/src/components/dashboard/widgets/SupervisedCasesWidget.test.tsx (expansion tests added)
- apps/web/src/components/dashboard/widgets/FirmTasksOverviewWidget.test.tsx (expansion tests added)

### Change Log
- 2025-11-18: Added Tasks section and Dev Agent Record
- 2025-11-18: Task 1 complete - CSS Grid implementation
- 2025-11-18: Task 2 complete - Widget expansion infrastructure
- 2025-11-18: Task 3 complete - Expansion added to SupervisedCasesWidget, FirmTasksOverviewWidget, AssignedTasksWidget
- 2025-11-18: Task 4 complete - Accessibility features (ARIA, focus management, screen reader announcements)
- 2025-11-18: Task 5 complete - Performance optimizations (content-visibility, will-change, prefers-reduced-motion)
- 2025-11-18: Task 6 complete - Comprehensive unit tests added (16+ tests)
- 2025-11-18: Task 7 complete - Validated against all acceptance criteria
- 2025-11-18: Story ready for review
