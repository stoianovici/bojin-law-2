# [OPS-009] Multiple re-login prompts for email/attachments

| Field           | Value      |
| --------------- | ---------- |
| **Status**      | Verifying  |
| **Type**        | Bug        |
| **Priority**    | P1-High    |
| **Created**     | 2025-12-11 |
| **Sessions**    | 3          |
| **Last Active** | 2025-12-12 |

## Description

The app asks users to log in on first access (correct behavior), but also prompts for re-authentication when:

1. Synchronizing email
2. Downloading attachments

Users should only log in once when accessing the app. Subsequent operations (email sync, attachments) should use cached credentials silently.

## Reproduction Steps

1. Log in to the app successfully
2. Navigate to /communications page
3. Click "Sync Email" button
4. Observe: prompted to log in again (should not happen)
5. Download an attachment
6. Observe: prompted to log in again (should not happen)

## Root Cause

**Multiple authentication layers with cache mismatch:**

1. **Two auth systems in use:**
   - Session cookie (`legal-platform-session`) - 24hr expiry, used for app authentication
   - MSAL token cache (`sessionStorage`) - Microsoft Graph API access tokens

2. **Session cookie valid but MSAL cache empty:**
   - User can be authenticated via session cookie alone (no MSAL account cached)
   - `AuthContext.tsx` lines 217-243 show fallback to session cookie when MSAL has no accounts
   - When `getAccessToken()` is called, it returns `null` if no MSAL accounts exist

3. **Backend treats missing MS token as full auth error:**
   - `email.resolvers.ts` line 303: `if (!user || !user.accessToken)` throws `UNAUTHENTICATED`
   - Doesn't distinguish between:
     - Missing session (needs full login)
     - Missing MS Graph token (needs Microsoft reconnect only)

4. **Apollo Client silently loses token:**
   - `apollo-client.ts` lines 88-90: catches token error and returns empty headers
   - Request proceeds without token → backend throws auth error

5. **Key code paths:**
   - `startEmailSync` mutation requires `user.accessToken` (MS Graph token)
   - `emailAttachmentContent` query requires `user.accessToken`
   - `syncEmailAttachments` mutation requires `user.accessToken`

## Fix Applied

**Fix 1: MSAL cache persistence**

- File: `apps/web/src/lib/msal-config.ts`
- Changed `cacheLocation: 'sessionStorage'` to `cacheLocation: 'localStorage'`
- This keeps MSAL tokens across browser sessions, preventing re-login when browser is closed

**Fix 2: Distinct error codes for MS token issues**

- File: `services/gateway/src/graphql/resolvers/email.resolvers.ts`
- Added `MS_TOKEN_REQUIRED` error code for operations that need MS Graph token
- Separates "need full login" (`UNAUTHENTICATED`) from "need Microsoft reconnect" (`MS_TOKEN_REQUIRED`)
- Updated 6 resolvers: `startEmailSync`, `syncEmailAttachments`, `emailAttachmentContent`, `createEmailSubscription`, `sendNewEmail`, `replyToEmail`

**Fix 3: Frontend MS_TOKEN_REQUIRED handling**

- File: `apps/web/src/lib/apollo-client.ts`
- Added error handler to dispatch `ms-token-required` custom event when `MS_TOKEN_REQUIRED` error received
- File: `apps/web/src/app/communications/page.tsx`
- Added listener for `ms-token-required` event
- Shows amber reconnect banner with "Reconectează" button instead of full login redirect
- Banner explains "Sesiunea Microsoft a expirat" and provides one-click reconnect

## Local Dev Environment

```bash
# Full dev environment (Turbo):
pnpm install
pnpm dev

# Individual services:
cd services/gateway && pnpm dev     # GraphQL gateway on :4000
cd services/ai-service && pnpm dev  # AI service on :3002
cd apps/web && pnpm dev             # Next.js frontend on :3000

# Docker for local DB/Redis:
docker-compose -f infrastructure/docker/docker-compose.yml up -d postgres redis
```

Environment files:

- `.env` (root) - Base config
- `services/gateway/.env` - DATABASE_URL, REDIS_URL
- `services/ai-service/.env` - ANTHROPIC_API_KEY
- `apps/web/.env.local` - NEXT*PUBLIC*\* vars

## Session Log

- [2025-12-11] Issue created. Initial triage identified dual auth system (session cookie + MSAL tokens) with cache mismatch as root cause. Backend treats missing MS Graph token as full auth error instead of prompting for Microsoft reconnect.
- [2025-12-11] Session 2 started. Continuing from: New. Implementing fixes.
- [2025-12-11] Session 2 - Fix 1: Changed MSAL `cacheLocation` from `sessionStorage` to `localStorage` for persistent login across browser sessions.
- [2025-12-11] Session 2 - Fix 2: Added `MS_TOKEN_REQUIRED` error code to 6 email resolvers that need MS Graph token (`startEmailSync`, `syncEmailAttachments`, `emailAttachmentContent`, `createEmailSubscription`, `sendNewEmail`, `replyToEmail`).
- [2025-12-11] Session 2 - Fix 3: Added frontend error handling for `MS_TOKEN_REQUIRED` - dispatches custom event from Apollo error link, communications page listens and shows reconnect banner.
- [2025-12-11] Session 2 - Build verified successful. Ready for deployment and testing.
- [2025-12-12] Session 3 started. Continuing from: Fixing. Verifying deployed fixes.
- [2025-12-12] Session 3 - All fixes confirmed deployed in commit `e716eb2`. Code verification:
  - ✅ `msal-config.ts`: `cacheLocation: 'localStorage'` confirmed
  - ✅ `email.resolvers.ts`: `MS_TOKEN_REQUIRED` error code in 6 resolvers confirmed
  - ✅ `apollo-client.ts`: `ms-token-required` custom event dispatch confirmed
  - ✅ `communications/page.tsx`: Event listener and reconnect banner confirmed
- [2025-12-12] Session 3 - Gateway and web app responding in production. Status updated to Verifying.

## Files Involved

**Frontend Auth:**

- `apps/web/src/contexts/AuthContext.tsx` - Main auth context, MSAL initialization, `getAccessToken()` function
- `apps/web/src/lib/msal-config.ts` - **FIXED** - Changed cacheLocation to localStorage
- `apps/web/src/lib/apollo-client.ts` - **FIXED** - Added MS_TOKEN_REQUIRED error handler with custom event dispatch

**Communications Page:**

- `apps/web/src/app/communications/page.tsx` - **FIXED** - Added MS_TOKEN_REQUIRED event listener, reconnect banner UI

**Backend Auth:**

- `services/gateway/src/services/auth.service.ts` - OAuth backend, session management
- `services/gateway/src/middleware/auth.middleware.ts` - JWT/session authentication
- `services/gateway/src/graphql/server.ts` - Extracts `x-ms-access-token` from headers, adds to context

**Email Operations (require MS token):**

- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - **FIXED** - `startEmailSync`, `emailAttachmentContent`, `syncEmailAttachments`, `createEmailSubscription`, `sendNewEmail`, `replyToEmail` resolvers now return `MS_TOKEN_REQUIRED` code
- `services/gateway/src/services/email-sync.service.ts` - Email sync using MS Graph API
- `services/gateway/src/services/email-attachment.service.ts` - Attachment download from MS Graph

**Frontend Email Hooks:**

- `apps/web/src/hooks/useEmailSync.ts` - Email sync mutations
- `apps/web/src/hooks/useBulkCommunication.ts` - Bulk email operations
