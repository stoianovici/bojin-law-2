# OPS-140: AttachmentPreviewPanel Context Integration

**Status**: Closed
**Type**: Feature
**Priority**: P2-Medium
**Complexity**: M (Medium)
**Created**: 2024-12-24
**Closed**: 2024-12-24

## Context

Part of the Context-Aware Document Preview Actions epic. Integrates action toolbar with the inline attachment preview panel in Communications.

## Problem

AttachmentPreviewPanel (side panel for email attachments) has no contextual actions. Users cannot:

- Save attachment as a case document
- Add attachment directly to Mapa
- Mark attachment as irrelevant

They must download and re-upload, or navigate away from the preview.

## Solution

Add action footer to AttachmentPreviewPanel with email-attachment context actions:

- Save to Documents (calls OPS-135 mutation)
- Add to Mapa (after save if needed)
- Download
- Mark as Irrelevant (calls OPS-136 mutation)

## Implementation

### GraphQL Operations

```typescript
// apps/web/src/hooks/useAttachmentActions.ts

const SAVE_ATTACHMENT_AS_DOCUMENT = gql`
  mutation SaveEmailAttachmentAsDocument($emailId: ID!, $attachmentId: ID!, $caseId: ID!) {
    saveEmailAttachmentAsDocument(emailId: $emailId, attachmentId: $attachmentId, caseId: $caseId) {
      id
      fileName
      fileType
      fileSize
    }
  }
`;

const MARK_ATTACHMENT_IRRELEVANT = gql`
  mutation MarkAttachmentIrrelevant($attachmentId: ID!, $irrelevant: Boolean!) {
    markAttachmentIrrelevant(attachmentId: $attachmentId, irrelevant: $irrelevant) {
      id
      irrelevant
    }
  }
`;
```

### Action Footer Component

```tsx
// Within AttachmentPreviewPanel.tsx

function AttachmentActionFooter({
  attachment,
  emailId,
  caseId,
  onSaved,
  onClose,
}: AttachmentActionFooterProps) {
  const actions = usePreviewActions('email-attachment');
  const [saveAttachment, { loading: saving }] = useMutation(SAVE_ATTACHMENT_AS_DOCUMENT);
  const [markIrrelevant, { loading: marking }] = useMutation(MARK_ATTACHMENT_IRRELEVANT);

  const handleAction = async (actionId: string) => {
    switch (actionId) {
      case 'save-to-docs':
        const { data } = await saveAttachment({
          variables: { emailId, attachmentId: attachment.id, caseId },
        });
        toast.success('Atașament salvat în documente');
        onSaved?.(data.saveEmailAttachmentAsDocument);
        break;

      case 'add-to-mapa':
        // If not yet saved, save first then open mapa modal
        // Or open mapa modal if already saved
        break;

      case 'download':
        handleDownload(attachment);
        break;

      case 'mark-irrelevant':
        await markIrrelevant({
          variables: { attachmentId: attachment.id, irrelevant: true },
        });
        toast.success('Atașament marcat ca irelevant');
        onClose?.();
        break;
    }
  };

  return (
    <div className="flex items-center justify-between border-t bg-gray-50 px-3 py-2">
      <div className="flex gap-2">
        <Button size="sm" onClick={() => handleAction('save-to-docs')} disabled={saving}>
          <Save className="mr-1.5 h-4 w-4" />
          Salvează
        </Button>
        <Button size="sm" variant="outline" onClick={() => handleAction('add-to-mapa')}>
          <FolderInput className="mr-1.5 h-4 w-4" />
          Mapă
        </Button>
      </div>
      <div className="flex gap-1">
        <IconButton icon={Download} title="Descarcă" onClick={() => handleAction('download')} />
        <IconButton
          icon={EyeOff}
          title="Marchează irelevant"
          onClick={() => handleAction('mark-irrelevant')}
          disabled={marking}
        />
      </div>
    </div>
  );
}
```

### Panel Layout Update

```tsx
// AttachmentPreviewPanel.tsx - updated structure

return (
  <div className={clsx('flex flex-col border-l bg-white', className)}>
    {/* Header */}
    <div className="flex items-center justify-between border-b px-3 py-2">
      <span className="font-medium">{attachment.fileName}</span>
      <IconButton icon={X} onClick={onClose} />
    </div>

    {/* Preview content */}
    <div className="flex-1 overflow-hidden">{renderPreview()}</div>

    {/* NEW: Action footer */}
    <AttachmentActionFooter
      attachment={attachment}
      emailId={emailId}
      caseId={caseId}
      onSaved={handleAttachmentSaved}
      onClose={onClose}
    />
  </div>
);
```

## Actions for email-attachment Context

| Action ID         | Handler                     | Backend        |
| ----------------- | --------------------------- | -------------- |
| `save-to-docs`    | Call mutation, show success | OPS-135        |
| `add-to-mapa`     | Open AssignToMapaModal      | Uses saved doc |
| `download`        | Trigger download            | Existing       |
| `mark-irrelevant` | Call mutation, close panel  | OPS-136        |

## Done When

- [x] Action footer added to AttachmentPreviewPanel
- [x] GraphQL mutations imported and configured (inline in component)
- [x] Save to Documents creates document and shows success toast
- [x] Mark Irrelevant updates backend and closes panel
- [x] Download uses existing attachment download logic
- [x] Loading states shown during async operations
- [x] Error handling with user-friendly messages
- [x] Panel state updates after successful actions (saved state tracked)
- [ ] Add to Mapa opens modal (deferred - requires additional work)

## Implementation Notes

Simplified the approach from the original spec:

- Mutations are defined inline in AttachmentPreviewPanel.tsx (no separate hook file)
- Action footer is a section in the component, not a separate component
- Uses existing notification store for toasts
- Tracks saved attachments locally to show "Salvat" state
- caseId prop passed from communications/page.tsx

## Files

- `apps/web/src/components/communication/AttachmentPreviewPanel.tsx` - Added action footer with mutations
- `apps/web/src/app/communications/page.tsx` - Passes caseId prop

## Dependencies

- **Blocks**: None
- **Blocked by**: OPS-135 (save mutation), OPS-136 (irrelevant mutation), OPS-137 (toolbar pattern), OPS-138 (role filtering)

## Epic

Context-Aware Document Preview Actions (Phase 3 - Integration)
