# OPS-176: Document Version History Drawer

**Type**: Feature
**Priority**: P2-Medium
**Status**: Verifying
**Epic**: Documents Separation & Review Workflow (OPS-171 to OPS-177)

## Problem

Document versions are tracked in the database (DocumentVersion table) but there's no UI to view version history. Users cannot:

- See how many versions a document has
- View when and by whom versions were created
- Access or download previous versions
- Understand the evolution of a document

## Solution

Create a collapsible drawer component showing version timeline, with version count badge on document cards.

## Implementation

### 1. Create useDocumentVersions hook

```typescript
// hooks/useDocumentVersions.ts
const GET_DOCUMENT_VERSIONS = gql`
  query GetDocumentVersions($documentId: ID!) {
    documentVersions(documentId: $documentId) {
      id
      versionNumber
      createdAt
      createdBy {
        id
        name
        avatar
      }
      changesSummary
      fileSize
    }
  }
`;

export function useDocumentVersions(documentId: string) {
  const { data, loading, error } = useQuery(GET_DOCUMENT_VERSIONS, {
    variables: { documentId },
    skip: !documentId,
  });

  return {
    versions: data?.documentVersions ?? [],
    loading,
    error,
    versionCount: data?.documentVersions?.length ?? 0,
  };
}
```

### 2. Add versions query to GraphQL

```graphql
type DocumentVersion {
  id: ID!
  versionNumber: Int!
  createdAt: DateTime!
  createdBy: User!
  changesSummary: String
  fileSize: Int
  oneDriveVersionId: String
}

type Query {
  documentVersions(documentId: ID!): [DocumentVersion!]!
}
```

### 3. Create DocumentVersionDrawer component

```tsx
// components/documents/DocumentVersionDrawer.tsx
'use client';

import { formatDistanceToNow } from 'date-fns';
import { ro } from 'date-fns/locale';
import { X, Download, Clock, User } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

interface DocumentVersionDrawerProps {
  documentId: string;
  documentName: string;
  isOpen: boolean;
  onClose: () => void;
}

export function DocumentVersionDrawer({
  documentId,
  documentName,
  isOpen,
  onClose,
}: DocumentVersionDrawerProps) {
  const { versions, loading } = useDocumentVersions(documentId);

  return (
    <AnimatePresence>
      {isOpen && (
        <motion.div
          initial={{ x: '100%' }}
          animate={{ x: 0 }}
          exit={{ x: '100%' }}
          transition={{ type: 'spring', damping: 25 }}
          className="fixed right-0 top-0 h-full w-96 bg-white shadow-xl z-50 border-l"
        >
          {/* Header */}
          <div className="flex items-center justify-between p-4 border-b">
            <div>
              <h2 className="font-semibold">Istoric versiuni</h2>
              <p className="text-sm text-gray-500 truncate">{documentName}</p>
            </div>
            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded">
              <X className="h-5 w-5" />
            </button>
          </div>

          {/* Version Timeline */}
          <div className="p-4 overflow-y-auto h-[calc(100%-80px)]">
            {loading ? (
              <VersionsSkeleton />
            ) : (
              <div className="relative">
                {/* Timeline line */}
                <div className="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200" />

                {/* Version entries */}
                <div className="space-y-4">
                  {versions.map((version, index) => (
                    <VersionEntry key={version.id} version={version} isCurrent={index === 0} />
                  ))}
                </div>
              </div>
            )}
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}

function VersionEntry({ version, isCurrent }) {
  return (
    <div className="relative pl-10">
      {/* Timeline dot */}
      <div
        className={clsx(
          'absolute left-2.5 w-3 h-3 rounded-full border-2',
          isCurrent ? 'bg-blue-500 border-blue-500' : 'bg-white border-gray-300'
        )}
      />

      <div
        className={clsx(
          'p-3 rounded-lg border',
          isCurrent ? 'bg-blue-50 border-blue-200' : 'bg-white'
        )}
      >
        <div className="flex items-center justify-between">
          <span className="font-medium">
            Versiunea {version.versionNumber}
            {isCurrent && (
              <span className="ml-2 text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">
                CurentÄƒ
              </span>
            )}
          </span>
          <button className="p-1 hover:bg-gray-100 rounded" title="DescarcÄƒ">
            <Download className="h-4 w-4 text-gray-500" />
          </button>
        </div>

        <div className="mt-2 text-sm text-gray-600 space-y-1">
          <div className="flex items-center gap-2">
            <Clock className="h-3.5 w-3.5" />
            {formatDistanceToNow(new Date(version.createdAt), {
              addSuffix: true,
              locale: ro,
            })}
          </div>
          <div className="flex items-center gap-2">
            <User className="h-3.5 w-3.5" />
            {version.createdBy.name}
          </div>
          {version.changesSummary && (
            <p className="text-gray-500 italic mt-2">"{version.changesSummary}"</p>
          )}
        </div>
      </div>
    </div>
  );
}
```

### 4. Add version count badge to DocumentCard

```tsx
// In DocumentCard.tsx
const { versionCount } = useDocumentVersions(document.id);

// In the card UI
{
  versionCount > 1 && (
    <button
      onClick={(e) => {
        e.stopPropagation();
        openVersionDrawer(document.id);
      }}
      className="flex items-center gap-1 text-xs text-gray-500 hover:text-blue-600"
      title="Vezi istoricul versiunilor"
    >
      <History className="h-3.5 w-3.5" />v{versionCount}
    </button>
  );
}
```

### 5. Add drawer state management

```typescript
// In DocumentsContentPanel or parent component
const [versionDrawerDoc, setVersionDrawerDoc] = useState<{
  id: string;
  name: string;
} | null>(null);

const openVersionDrawer = (docId: string, docName: string) => {
  setVersionDrawerDoc({ id: docId, name: docName });
};

const closeVersionDrawer = () => {
  setVersionDrawerDoc(null);
};
```

### 6. Optimize version count fetching

To avoid N+1 queries, add version count to main document query:

```graphql
type Document {
  # ... existing fields
  versionCount: Int!
}
```

```typescript
// Resolver
versionCount: async (parent) => {
  return prisma.documentVersion.count({
    where: { documentId: parent.id },
  });
};
```

## Files to Modify

- New: `apps/web/src/components/documents/DocumentVersionDrawer.tsx`
- New: `apps/web/src/hooks/useDocumentVersions.ts`
- `apps/web/src/components/documents/DocumentCard.tsx` - add version badge
- `apps/web/src/components/documents/DocumentsContentPanel.tsx` - drawer state
- `services/gateway/src/graphql/schema/document.graphql` - add query + versionCount field
- `services/gateway/src/graphql/resolvers/document.resolvers.ts` - implement resolvers

## Dependencies

None - this issue is fully independent and can be worked on in parallel with the schema changes.

## Acceptance Criteria

- [x] Version count badge (v2, v3, etc.) shown on document cards with multiple versions
- [x] Clicking badge opens version drawer from right side
- [x] Drawer shows timeline with all versions
- [x] Each version shows: number, date (relative), author, optional summary
- [x] Current version highlighted with "CurentÄƒ" badge
- [x] Download button for each version
- [x] Drawer can be closed with X button or clicking outside
- [x] Smooth slide-in/slide-out animation
- [x] Loading skeleton while fetching versions
- [x] No badge shown for documents with only 1 version

## UI Mockup

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Document Grid                               â”‚  Istoric versiuni        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  Contract.docx            â”‚
â”‚  â”‚ ğŸ“„      â”‚ â”‚ ğŸ“„      â”‚ â”‚ ğŸ“„      â”‚        â”‚                           â”‚
â”‚  â”‚ Doc 1   â”‚ â”‚ Doc 2   â”‚ â”‚ Doc 3   â”‚        â”‚  â— Versiunea 3  [CurentÄƒ] â”‚
â”‚  â”‚         â”‚ â”‚    v3 â†â”€â”‚â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â–¶  acum 2 ore             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚    Maria Pop              â”‚
â”‚                                              â”‚    "CorecÈ›ii finale"      â”‚
â”‚                                              â”‚                           â”‚
â”‚                                              â”‚  â—‹ Versiunea 2            â”‚
â”‚                                              â”‚    ieri                   â”‚
â”‚                                              â”‚    Ion Barbu              â”‚
â”‚                                              â”‚                           â”‚
â”‚                                              â”‚  â—‹ Versiunea 1            â”‚
â”‚                                              â”‚    acum 3 zile            â”‚
â”‚                                              â”‚    Maria Pop              â”‚
â”‚                                              â”‚    "Versiune iniÈ›ialÄƒ"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Future Enhancements

- Version comparison/diff view
- Restore previous version
- Version notes/comments
- File size delta between versions
