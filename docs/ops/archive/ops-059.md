# OPS-059: Multi-Case Classification Algorithm

| Field           | Value       |
| --------------- | ----------- |
| **Status**      | Implemented |
| **Type**        | Feature     |
| **Priority**    | P1-High     |
| **Created**     | 2025-12-20  |
| **Sessions**    | 1           |
| **Last Active** | 2025-12-20  |
| **Depends On**  | OPS-058     |

## Description

Update the email classification algorithm to assign emails to **multiple cases** when contacts appear in multiple active cases. This replaces the current single-case assignment model.

## Current Behavior (Problem)

From `services/gateway/src/services/classification-scoring.ts`:

1. **Thread continuity check** (lines 191-204, 405-421):
   - If any email in conversationId is classified → lock to that case
   - Returns immediately with 100% confidence
   - **Bypasses all multi-case logic**

2. **Single case assignment** (lines 224-236):
   - If contact has only one case → auto-assign
   - Works correctly for single-case contacts

3. **Multi-case scoring** (lines 238-244, 484-524):
   - Only runs if contact has multiple cases AND thread continuity didn't fire
   - Returns single winning case or "Uncertain"
   - **Never assigns to multiple cases**

## New Behavior (Solution)

### Changes to Classification Logic

```typescript
// NEW: classifyEmail() returns multiple case assignments
interface ClassificationResult {
  state: EmailClassificationState;
  caseAssignments: CaseAssignment[]; // Array instead of single
  suggestedCases?: CaseScore[];
}

interface CaseAssignment {
  caseId: string;
  confidence: number;
  matchType: ClassificationMatchType;
  isPrimary: boolean;
}
```

### Algorithm Changes

1. **Thread Continuity Enhancement** (lines 191-204):

   ```typescript
   // BEFORE: Return single case
   if (threadCase) {
     return { state: Classified, caseId: threadCase.caseId, confidence: 1.0 };
   }

   // AFTER: Add to assignments, continue checking other cases
   if (threadCase) {
     assignments.push({
       caseId: threadCase.caseId,
       confidence: 1.0,
       matchType: 'THREAD_CONTINUITY',
       isPrimary: true,
     });
     // Continue to find other matching cases for this contact
   }
   ```

2. **Multi-Case Assignment** (new logic):

   ```typescript
   // Find ALL cases for this contact
   const allCases = await findCasesForContact(senderEmail, firmId, userId);

   for (const caseContext of allCases) {
     // Score each case
     const score = await scoreCase(email, caseContext);

     // If score meets threshold, add to assignments
     if (score >= THRESHOLDS.MIN_SCORE) {
       assignments.push({
         caseId: caseContext.caseId,
         confidence: normalizeScore(score),
         matchType: determineMatchType(score),
         isPrimary: assignments.length === 0, // First match is primary
       });
     }
   }
   ```

3. **State Determination**:
   ```typescript
   if (assignments.length === 0) {
     return { state: 'Uncertain', caseAssignments: [], suggestedCases };
   }
   return { state: 'Classified', caseAssignments: assignments };
   ```

## Files to Modify

| File                                                          | Changes                               |
| ------------------------------------------------------------- | ------------------------------------- |
| `services/gateway/src/services/classification-scoring.ts`     | Core algorithm changes                |
| `services/gateway/src/workers/email-categorization.worker.ts` | Handle multi-case results             |
| `services/gateway/src/services/email-to-case.service.ts`      | Create multiple EmailCaseLink records |

## Implementation Steps

1. Update `ClassificationResult` interface to return array of case assignments
2. Modify `classifyEmail()` to collect all matching cases instead of returning first
3. Update thread continuity to add to assignments instead of early return
4. Update worker to create EmailCaseLink records for all assignments
5. Update email-to-case service to use new junction table

## Acceptance Criteria

- [x] Classification returns multiple case assignments when contact has multiple cases
- [x] Thread continuity adds to assignments instead of bypassing
- [x] All matching cases above threshold are included
- [x] Primary case is marked correctly
- [x] Worker creates EmailCaseLink records for all assignments
- [x] Existing single-case behavior preserved for single-case contacts

## Local Verification Status

| Step           | Status     | Date       | Notes             |
| -------------- | ---------- | ---------- | ----------------- |
| Prod data test | ⬜ Pending |            |                   |
| Preflight      | ✅ Passed  | 2025-12-20 | All checks passed |
| Docker test    | ⬜ Pending |            |                   |

**Verified**: Partially (preflight passed, awaiting manual testing)

## Session Log

- [2025-12-20] Issue created as part of multi-case email feature set.
- [2025-12-20] Session 1: Implemented multi-case classification algorithm
  - Updated `ClassificationResult` to include `caseAssignments: CaseAssignment[]` array
  - Modified `classifyEmail()` to collect ALL matching cases instead of returning on first match
  - Thread continuity now adds to assignments instead of early return
  - Court emails now also support multi-case assignment
  - Updated email categorization worker to create EmailCaseLink records for all assignments
  - Updated email-to-case service to create EmailCaseLink records for manual imports
  - All preflight checks passed

## Files Modified

| File                                                          | Changes                                      |
| ------------------------------------------------------------- | -------------------------------------------- |
| `services/gateway/src/services/classification-scoring.ts`     | Core algorithm - multi-case support          |
| `services/gateway/src/workers/email-categorization.worker.ts` | Create EmailCaseLink records for assignments |
| `services/gateway/src/services/email-to-case.service.ts`      | Create EmailCaseLink for manual imports      |

---
