# OPS-123: Thread-Level AI Summary

**Type:** Feature
**Priority:** P2-Medium
**Status:** Open
**Created:** 2025-12-23
**Epic:** Communications UX Overhaul

## Problem

When opening a thread, users must read through all messages to understand:

- What is this conversation about?
- Are there deadlines or commitments?
- What's the current status?

For long threads (5+ messages), this takes significant time.

## Context

- OPS-090 cleans individual messages (removes quotes/signatures)
- OPS-026 implemented thread summary (but for sidebar, not inline)
- Users need quick triage: "Do I need to act on this?"
- Goal: AI-generated summary card at top of thread view

## Solution

Add a collapsible AI summary card at the top of ConversationView:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contract Review â€¢ Dosar: ABC SRL vs DEF SRL                       â”‚
â”‚ 4 mesaje â€¢ 3 ataÈ™amente                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ’¡ Rezumat                                          [Ascunde] â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚ DiscuÈ›ie despre revizuirea contractului de prestÄƒri servicii.â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚ â€¢ Termen: 15 ianuarie 2025                                   â”‚ â”‚
â”‚ â”‚ â€¢ ProblemÄƒ deschisÄƒ: Clauza 4.2 - perioada de garanÈ›ie       â”‚ â”‚
â”‚ â”‚ â€¢ Ultima acÈ›iune: Ion solicitÄƒ specificarea "24 luni"        â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚ AtaÈ™amente cheie: Contract_v2.pdf (ultima versiune)          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€ Ion Popescu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 20 dec, 10:30 â”€â”            â”‚
â”‚  â”‚ VÄƒ rog sÄƒ revizuiÈ›i contractul...                â”‚            â”‚
```

### Key Design Elements

1. **Summary Card**
   - Positioned between header and messages
   - Collapsible (remember preference)
   - Light yellow/blue background for visibility
   - Regenerate button for stale summaries

2. **Summary Content**
   - 1-2 sentence overview
   - Bullet points for key items:
     - Deadlines mentioned
     - Open issues/questions
     - Action items
     - Key attachments
   - Last action/status

3. **Generation Strategy**
   - Generate on first view of thread
   - Cache in database (threadSummary field)
   - Invalidate when new message added
   - Show "Se genereazÄƒ..." while loading

## Implementation

### Backend: Thread Summary Service

```typescript
// services/gateway/src/services/thread-summary.service.ts

const THREAD_SUMMARY_PROMPT = `AnalizeazÄƒ acest thread de email È™i genereazÄƒ un rezumat concis Ã®n limba romÃ¢nÄƒ.

Structura rezumatului:
1. O propoziÈ›ie care descrie subiectul conversaÈ›iei
2. Puncte cheie (maxim 4):
   - Termene menÈ›ionate (cu date specifice)
   - Probleme deschise sau Ã®ntrebÄƒri
   - AcÈ›iuni solicitate
   - Documente importante ataÈ™ate
3. Ultima acÈ›iune sau starea curentÄƒ

RÄƒspunde doar cu rezumatul, fÄƒrÄƒ introducere.`;

export class ThreadSummaryService {
  async generateSummary(threadId: string): Promise<string> {
    // Fetch thread with all messages
    const thread = await prisma.emailThread.findUnique({
      where: { id: threadId },
      include: {
        emails: {
          orderBy: { receivedDateTime: 'asc' },
          select: {
            from: true,
            subject: true,
            bodyContentClean: true,
            bodyContent: true,
            receivedDateTime: true,
            hasAttachments: true,
          },
        },
      },
    });

    // Build conversation context
    const conversationText = thread.emails
      .map((e) => {
        const body = e.bodyContentClean || e.bodyContent;
        return `De la: ${e.from}\nData: ${e.receivedDateTime}\n${body}`;
      })
      .join('\n\n---\n\n');

    // Call Claude
    const response = await anthropic.messages.create({
      model: 'claude-3-5-haiku-20241022',
      max_tokens: 500,
      messages: [
        {
          role: 'user',
          content: `${THREAD_SUMMARY_PROMPT}\n\n---\n\nConversaÈ›ie:\n\n${conversationText}`,
        },
      ],
    });

    const summary = response.content[0].type === 'text' ? response.content[0].text : '';

    // Cache in database
    await prisma.emailThread.update({
      where: { id: threadId },
      data: {
        summary,
        summaryGeneratedAt: new Date(),
      },
    });

    return summary;
  }

  async invalidateSummary(threadId: string): Promise<void> {
    await prisma.emailThread.update({
      where: { id: threadId },
      data: {
        summary: null,
        summaryGeneratedAt: null,
      },
    });
  }
}
```

### Database Schema

```prisma
model EmailThread {
  // ... existing fields

  summary            String?   // AI-generated thread summary
  summaryGeneratedAt DateTime? // When summary was generated
}
```

### GraphQL Schema

```graphql
type EmailThread {
  # ... existing fields
  summary: String
  summaryGeneratedAt: DateTime
}

type Mutation {
  generateThreadSummary(threadId: ID!): String!
  invalidateThreadSummary(threadId: ID!): Boolean!
}
```

### Frontend: ThreadSummaryCard Component

```tsx
// components/communication/ThreadSummaryCard.tsx

interface ThreadSummaryCardProps {
  threadId: string;
  summary: string | null;
  summaryGeneratedAt: Date | null;
  onRegenerate: () => void;
  loading?: boolean;
}

export function ThreadSummaryCard({
  threadId,
  summary,
  summaryGeneratedAt,
  onRegenerate,
  loading,
}: ThreadSummaryCardProps) {
  const [collapsed, setCollapsed] = useLocalStorage(`thread-summary-collapsed`, false);

  if (!summary && !loading) {
    return (
      <button
        onClick={onRegenerate}
        className="w-full p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700 hover:bg-blue-100"
      >
        <Sparkles className="h-4 w-4 inline mr-2" />
        GenereazÄƒ rezumat AI
      </button>
    );
  }

  if (loading) {
    return (
      <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
        <div className="flex items-center gap-2 text-sm text-yellow-700">
          <Loader2 className="h-4 w-4 animate-spin" />
          Se genereazÄƒ rezumatul...
        </div>
      </div>
    );
  }

  return (
    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg overflow-hidden">
      <button
        onClick={() => setCollapsed(!collapsed)}
        className="w-full flex items-center justify-between p-3 hover:bg-blue-100/50"
      >
        <div className="flex items-center gap-2 text-sm font-medium text-blue-800">
          <Lightbulb className="h-4 w-4" />
          Rezumat
        </div>
        {collapsed ? <ChevronDown className="h-4 w-4" /> : <ChevronUp className="h-4 w-4" />}
      </button>

      {!collapsed && (
        <div className="px-4 pb-4">
          <div className="text-sm text-gray-700 whitespace-pre-wrap">{summary}</div>

          <div className="mt-3 flex items-center justify-between text-xs text-gray-500">
            <span>
              Generat {formatDistanceToNow(summaryGeneratedAt, { addSuffix: true, locale: ro })}
            </span>
            <button
              onClick={onRegenerate}
              className="text-blue-600 hover:underline flex items-center gap-1"
            >
              <RefreshCw className="h-3 w-3" />
              RegenereazÄƒ
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
```

### Hook: useThreadSummary

```tsx
// hooks/useThreadSummary.ts

export function useThreadSummary(threadId: string) {
  const [generateSummary, { loading }] = useMutation(GENERATE_THREAD_SUMMARY);

  const handleGenerate = useCallback(async () => {
    await generateSummary({ variables: { threadId } });
  }, [threadId, generateSummary]);

  return {
    generate: handleGenerate,
    loading,
  };
}
```

## Acceptance Criteria

- [ ] Thread summary card displays at top of ConversationView
- [ ] Summary generated on-demand (button click)
- [ ] Summary cached in database (threadSummary field)
- [ ] Loading state while generating
- [ ] Collapsible card (remembers preference)
- [ ] "RegenereazÄƒ" button to refresh stale summaries
- [ ] Summary invalidated when new email added to thread
- [ ] Romanian language output
- [ ] Extracts: deadlines, open issues, action items, key attachments

## Files to Modify

| File                                                          | Change                            |
| ------------------------------------------------------------- | --------------------------------- |
| `packages/database/prisma/schema.prisma`                      | Add summary fields to EmailThread |
| `services/gateway/src/services/thread-summary.service.ts`     | **New**                           |
| `services/gateway/src/graphql/schema/email.graphql`           | Add summary field + mutation      |
| `services/gateway/src/graphql/resolvers/email.resolvers.ts`   | Add summary resolver + mutation   |
| `apps/web/src/components/communication/ThreadSummaryCard.tsx` | **New**                           |
| `apps/web/src/hooks/useThreadSummary.ts`                      | **New**                           |
| `apps/web/src/components/communication/ConversationView.tsx`  | Integrate summary card            |

## Cost Estimate

- Claude 3.5 Haiku: ~$0.25/1M input, ~$1.25/1M output
- Average thread: ~2KB (3-5 messages)
- 50 threads/week = ~100K tokens input, ~25K output
- **Weekly cost: ~$0.05-0.10**

## Dependencies

- OPS-121: ConversationView (integration point)
- OPS-090: bodyContentClean (cleaner input for summary)

## Related Issues

- OPS-026: AI Thread Summary Agent (prior art, sidebar implementation)
