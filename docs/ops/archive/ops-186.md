# OPS-186: Case Communications Tab Shows Unrelated Emails

| Field        | Value      |
| ------------ | ---------- |
| **Status**   | Complete   |
| **Priority** | P1-High    |
| **Type**     | Bug        |
| **Created**  | 2025-12-24 |

## Symptom

In case details for "Negrea c Noventa", the Communications tab shows many emails that have no relation to the case. The count of emails in case details differs significantly from what appears in `/communications` page for the same case.

## Root Cause Analysis

### Data Model Background

The system has **two ways** to link emails to cases:

1. **Legacy `Email.caseId` field** (line 2693 in schema.prisma):
   - Direct nullable foreign key on Email table
   - Set during initial classification or thread assignment
   - Single-case assignment only

2. **New `EmailCaseLink` table** (line 3832 in schema.prisma - OPS-058):
   - Many-to-many relationship supporting multi-case emails
   - Has confidence, matchType, linkedBy, isPrimary metadata
   - Introduced in OPS-058 for multi-case email support

### The Bug

**CommunicationsTab** (case details) uses `useEmailThreads` hook with `caseId` filter which calls:

```typescript
// email-thread.service.ts:244
if (caseId) {
  where.caseId = caseId; // <-- Uses legacy Email.caseId field!
}
```

This queries the **legacy `Email.caseId`** field directly, NOT the `EmailCaseLink` table.

**However**, the `/communications` page uses `useMyEmailsByCase` which fetches threads with their `caseLinks`:

```typescript
// useMyEmailsByCase.ts:57-70
emails {
  caseLinks {
    caseId
    case { id, title, caseNumber }
  }
}
```

This uses the newer `EmailCaseLink` table for grouping.

### Why Wrong Emails Appear

1. During old email classifications (before OPS-058), emails were assigned to cases by setting `Email.caseId` directly
2. Some of these assignments were incorrect or got corrupted
3. When OPS-058 introduced `EmailCaseLink`, new classifications create proper links in that table
4. But the `EmailThreadService.getThreads()` still filters by the old `Email.caseId` field
5. Result: Stale/incorrect `caseId` values cause unrelated emails to appear

### Evidence

Looking at `email-thread.service.ts`:

- Line 244: `where.caseId = caseId;` - filters by legacy field
- No reference to `EmailCaseLink` or `caseLinks` anywhere in the service

Looking at resolver (`email.resolvers.ts`):

- The `emailThreads` query passes `caseId` filter to the service
- Service returns threads filtered by legacy `Email.caseId`

## Fix Options

### Option A: Migrate to EmailCaseLink (Recommended)

Update `EmailThreadService.getThreads()` to filter by `EmailCaseLink` instead:

```typescript
if (caseId) {
  where.caseLinks = {
    some: {
      caseId: caseId,
    },
  };
}
```

And ensure the thread's `case` is resolved from `EmailCaseLink` relationships.

### Option B: Data Cleanup + Dual Check

1. Run a migration to sync `Email.caseId` with primary `EmailCaseLink.caseId`
2. Update service to check both tables

### Option C: CommunicationsTab uses same approach as /communications

Make `CommunicationsTab` use the same thread-caseLink resolution as `/communications` page.

## Verification Steps

1. Query emails for "Negrea c Noventa" case via both methods
2. Compare Email.caseId vs EmailCaseLink.caseId values
3. Identify orphaned/incorrect Email.caseId assignments
4. After fix, verify counts match between pages

## Files Affected

- `services/gateway/src/services/email-thread.service.ts` (line 244 - main fix)
- `apps/web/src/components/case/tabs/CommunicationsTab.tsx` (uses the buggy service)
- `apps/web/src/hooks/useEmailSync.ts` (calls emailThreads query with caseId)

## Session Log

| Time       | Action                                                                     |
| ---------- | -------------------------------------------------------------------------- |
| 2025-12-24 | Issue reported: emails unrelated to case appearing                         |
| 2025-12-24 | Investigation complete: root cause is legacy Email.caseId vs EmailCaseLink |
| 2025-12-24 | Fix implemented: getThreads() now filters by EmailCaseLink.caseId          |
| 2025-12-24 | Fix implemented: assignThreadToCase() now creates EmailCaseLink records    |
| 2025-12-24 | Discovered data corruption: emails incorrectly linked via Actor matchType  |
| 2025-12-24 | Created cleanup script: scripts/cleanup-email-case-links.ts                |
| 2025-12-24 | Executed cleanup: removed 46 incorrect EmailCaseLink records               |
| 2025-12-24 | Noventa case links: 236 → 198, unique conversations: 155 → 141             |
