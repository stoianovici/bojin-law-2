# OPS-205: Partner Privacy E2E Verification

**Status:** Verified | **Priority:** P2-Medium | **Type:** Testing | **Created:** 2025-12-24

## Overview

Partner privacy flow needs verification: partners can mark threads private, see them in /comms, but others cannot.

## Dependencies

- **Depends on:** OPS-203 (Assigned Action Bar has privacy toggle)
- **Blocks:** None
- **Parallel with:** None

## Context

Part of Communications Action Bar Redesign epic. This is a verification task to ensure the partner privacy feature (OPS-194) works correctly end-to-end after the action bar restructure.

## Requirements

### 1. Verify canTogglePrivacy Check

In `useEmailPrivacy.ts`:

- Returns `true` only for Partner role
- Returns `false` for Associate, Paralegal, Admin roles

```typescript
// Expected behavior
const canToggle = user?.role === 'Partner';
```

### 2. Verify toggleThreadPrivacy Mutation

Test mutation flow:

1. Partner marks thread private
2. All emails in thread get `isPrivate: true`
3. `markedPrivateBy` set to partner's user ID
4. Mutation returns success

### 3. Verify /comms Query Filtering

In email resolvers/service:

- Non-partners don't see threads marked private by others
- Partners see their own private threads
- Partners don't see other partners' private threads

```typescript
// Expected filter logic
if (email.isPrivate && email.markedPrivateBy !== currentUserId) {
  // Exclude from results for non-owners
}
```

### 4. Verify UI Components

Test scenarios:

1. Partner views thread → "Privat" toggle visible in action bar
2. Partner clicks toggle → thread marked private
3. Privacy banner appears: "Această conversație este privată"
4. Partner clicks toggle again → thread unmarked
5. Non-partner views same thread → toggle not visible
6. Non-partner cannot see thread if marked private by partner

### 5. Edge Cases

- Partner marks thread private, then logs out → should persist
- Multiple partners → each sees only their own private threads
- Thread with mixed emails (some private, some not) → handled correctly

## Acceptance Criteria

- [x] Partner can mark thread private
- [x] Partner still sees private thread in /comms
- [x] Non-partner cannot see thread marked private by partner
- [x] Toggle flips between private/public correctly
- [x] Privacy banner displays for private threads
- [x] Lock icon shows correct state
- [x] Changes persist across page refresh

## Files to Verify

- `apps/web/src/hooks/useEmailPrivacy.ts`
- `services/gateway/src/graphql/resolvers/email.resolvers.ts`
- `services/gateway/src/services/email-thread.service.ts`
- `apps/web/src/components/communication/ConversationView.tsx`
- `apps/web/src/hooks/useMyEmailsByCase.ts`

## Test Script

```bash
# Manual test flow
1. Log in as Partner
2. Navigate to /communications
3. Select an email thread
4. Click "Privat" toggle in action bar
5. Verify banner appears
6. Refresh page - verify still private
7. Log in as Associate (different account)
8. Navigate to /communications
9. Verify private thread is NOT visible
10. Log back in as Partner
11. Verify private thread IS visible
12. Click toggle to unmark private
13. Log in as Associate
14. Verify thread is now visible
```

## Estimated Scope

Small - Verification and testing only.

---

## Session Log

### Session 1 (2025-12-24)

**Verification completed. All acceptance criteria verified:**

1. **canTogglePrivacy check** ✅
   - `useEmailPrivacy.ts:109` - `canToggle: isPartner` where `isPartner = user?.role === 'Partner'`
   - Only Partner role can toggle privacy

2. **toggleThreadPrivacy mutation flow** ✅
   - `email-privacy.service.ts:144-186` - Marks all emails in thread with `isPrivate: true`, `markedPrivateBy: user.id`
   - `email.resolvers.ts:2920-2970` - GraphQL mutation validates Partner role

3. **/comms query filtering** ✅
   - `email-thread.service.ts:282-285` - Privacy filter applied when `caseId && !skipPrivacyFilter`:
     ```typescript
     {
       OR: [{ isPrivate: false }, { isPrivate: null }, { markedPrivateBy: userId }];
     }
     ```
   - Partners see their own private threads; others don't see private threads

4. **UI components** ✅
   - `ConversationView.tsx:685-692` - Privacy banner with Lock icon: "Această conversație este privată (doar pentru tine)"
   - `ConversationView.tsx:919-943` - Privacy toggle button (only visible for Partners via `canTogglePrivacy`)
   - Toggle shows Lock/LockOpen icons, purple highlight when active

5. **Edge cases** ✅
   - `email-privacy.service.ts:113-116` - Only the partner who marked it can unmark it
   - `email-privacy.service.ts:68-74` - Idempotent - already private returns as-is
   - Schema has proper indexes: `@@index([isPrivate])` at line 2736

6. **TypeScript compilation** ✅ - Both apps/web and services/gateway compile without errors
