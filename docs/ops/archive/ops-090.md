# OPS-090: Email Content Cleaning for Readability

**Type:** Feature
**Priority:** P2-Medium
**Status:** Implemented
**Created:** 2025-12-21
**Completed:** 2025-12-21

## Problem

Email threads displayed in the platform contain significant noise:

- Quoted reply blocks ("On Dec 20, John wrote:..." followed by full previous message)
- Signatures (contact info, legal disclaimers, "Sent from iPhone")
- Forward headers ("---------- Forwarded message ----------")
- Repeated "From:/Sent:/To:/Subject:" blocks

This makes email threads difficult to scan quickly. Users must mentally filter out redundant content to find the actual new information in each message.

## Context

- **Volume**: ~100-200 emails/week (low, AI processing is cost-effective)
- **Original preservation**: Not required—Outlook retains originals
- **Current state**: `bodyContent` stored as-is from Microsoft Graph, displayed verbatim

## Solution

Added a `bodyContentClean` field that stores extracted "new content only" for each email. Display the clean version by default with option to view original.

### Implementation Summary

#### Phase 1: Data Model & Service ✅

1. **Schema change** - Added `bodyContentClean` field to Email model:
   - File: `packages/database/prisma/schema.prisma`
   - Migration: `20251221160000_add_email_body_clean`

2. **Email cleaner service** (`services/gateway/src/services/email-cleaner.service.ts`):
   - Uses Claude 3.5 Haiku for extraction
   - Handles both HTML and plain text inputs
   - Returns plain text (stripped of HTML for clean version)
   - Graceful fallback if extraction fails

3. **Integration with categorization worker**:
   - Modified `email-categorization.worker.ts`
   - Cleans emails during classification processing
   - Non-blocking: failures don't break classification

#### Phase 2: UI Display ✅

4. **MessageView update** (`apps/web/src/components/communication/MessageView.tsx`):
   - Displays `bodyContentClean` when available
   - "Arată originalul" toggle to view full `bodyContent`
   - Falls back to `bodyContent` if clean version is null

5. **GraphQL schema update**:
   - Added `bodyContentClean` to Email type
   - Updated `EMAIL_FRAGMENT` in `useEmailSync.ts`

#### Phase 3: Backfill ✅

6. **Backfill mutation** (`backfillEmailCleanContent`):
   - GraphQL mutation for admin backfill
   - Processes emails without clean content in batches
   - Authorization: Partner/Admin/BusinessOwner only

## Files Modified

| File                                                                       | Change                         |
| -------------------------------------------------------------------------- | ------------------------------ |
| `packages/database/prisma/schema.prisma`                                   | Added `bodyContentClean` field |
| `packages/database/prisma/migrations/20251221160000_add_email_body_clean/` | Migration                      |
| `services/gateway/src/services/email-cleaner.service.ts`                   | New cleaner service            |
| `services/gateway/src/workers/email-categorization.worker.ts`              | Integrated cleaning            |
| `services/gateway/src/graphql/schema/email.graphql`                        | Exposed new field + mutation   |
| `services/gateway/src/graphql/resolvers/email.resolvers.ts`                | Backfill mutation              |
| `packages/shared/types/src/communication.ts`                               | Added `bodyClean` type         |
| `apps/web/src/hooks/useEmailSync.ts`                                       | Updated Email type + fragment  |
| `apps/web/src/components/communication/MessageView.tsx`                    | Display clean + toggle         |
| `apps/web/src/app/communications/page.tsx`                                 | Transform bodyClean            |

## Acceptance Criteria

- [x] New emails synced have `bodyContentClean` populated (via categorization worker)
- [x] Clean content removes signatures, quoted replies, forward headers
- [x] UI displays clean version by default
- [x] "Arată originalul" toggle shows full original content
- [x] Extraction failures don't break email sync (graceful degradation)
- [x] Backfill mutation processes existing emails

## Cost Estimate

- Claude 3.5 Haiku at 200 emails/week, avg 2KB each
- ~400K tokens/week input, ~200K output
- **Weekly cost: ~$0.15-0.30**

## How to Backfill Existing Emails

Run the GraphQL mutation (requires Partner/Admin role):

```graphql
mutation {
  backfillEmailCleanContent(limit: 100)
}
```

The mutation returns the number of emails processed. Run multiple times until it returns 0.

## Notes

- Original content always preserved in `bodyContent` field
- Outlook also retains originals externally
- Cleaning happens during the email categorization worker (after sync)
- New emails will be cleaned when they are classified
