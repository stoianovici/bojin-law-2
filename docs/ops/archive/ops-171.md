# OPS-171: Document Source Type & Review Fields

**Type**: Feature
**Priority**: P1-High
**Status**: Closed
**Epic**: Documents Separation & Review Workflow (OPS-171 to OPS-177)
**Closed**: 2024-12-24

## Problem

No way to distinguish document origin (uploaded vs. from email vs. AI-generated) or track review assignments. This blocks the ability to:

- Separate working documents from email attachments in the UI
- Assign documents to supervisors for review
- Track which attachments have been promoted to working documents

## Solution

Add `sourceType` enum and `reviewerId` to Document model, add `promotedFromAttachment` to CaseDocument join table.

## Implementation

### 1. Add DocumentSourceType enum to Prisma schema

```prisma
enum DocumentSourceType {
  UPLOAD            // Directly uploaded by user
  EMAIL_ATTACHMENT  // Saved from email attachment
  AI_GENERATED      // Created by AI drafting service
  TEMPLATE          // Generated from template
}
```

### 2. Add fields to Document model

```prisma
model Document {
  // ... existing fields

  sourceType    DocumentSourceType @default(UPLOAD)
  reviewerId    String?
  reviewer      User?              @relation("DocumentReviewer", fields: [reviewerId], references: [id])
  submittedAt   DateTime?          // When submitted for review
}
```

### 3. Add field to CaseDocument model

```prisma
model CaseDocument {
  // ... existing fields

  promotedFromAttachment Boolean @default(false)
  originalAttachmentId   String? // Reference to EmailAttachment if promoted
}
```

### 4. Update GraphQL schema

```graphql
enum DocumentSourceType {
  UPLOAD
  EMAIL_ATTACHMENT
  AI_GENERATED
  TEMPLATE
}

type Document {
  # ... existing fields
  sourceType: DocumentSourceType!
  reviewer: User
  submittedAt: DateTime
}

type CaseDocument {
  # ... existing fields
  promotedFromAttachment: Boolean!
}
```

### 5. Create migration

```bash
pnpm prisma migrate dev --name add_document_source_and_review_fields
```

### 6. Backfill existing documents

Create a migration script to set `sourceType = EMAIL_ATTACHMENT` for documents that were saved from email attachments (where linked EmailAttachment exists).

## Files to Modify

- `packages/database/prisma/schema.prisma` - add enum and fields
- `services/gateway/src/graphql/schema/enums.graphql` - add DocumentSourceType
- `services/gateway/src/graphql/schema/document.graphql` - expose new fields
- `services/gateway/src/graphql/resolvers/document.resolvers.ts` - resolve new fields

## Dependencies

None - can start immediately.

## Acceptance Criteria

- [x] DocumentSourceType enum exists in Prisma schema
- [x] Document model has sourceType, reviewerId, submittedAt fields
- [x] CaseDocument has promotedFromAttachment, originalAttachmentId fields
- [x] GraphQL schema exposes new fields
- [x] Migration runs successfully
- [x] Existing email-origin documents backfilled with correct sourceType (128 documents)

## Notes

This is a foundational issue for the Documents Separation epic. OPS-173, OPS-174, OPS-175, and OPS-177 depend on this.
