# OPS-107: SharePoint GraphQL Schema Updates

| Field        | Value                  |
| ------------ | ---------------------- |
| **Status**   | Fixed                  |
| **Type**     | Feature                |
| **Priority** | P1-High                |
| **Created**  | 2025-12-22             |
| **Blocked**  | ~~OPS-105~~ (resolved) |
| **Blocks**   | OPS-108, OPS-109       |

## Description

Update the GraphQL schema to support SharePoint storage and add thumbnail fields for the document grid UI.

## Implementation Summary

### Schema Changes (`document.graphql`)

1. **DocumentStorageType enum** - ONEDRIVE, SHAREPOINT, R2
2. **Document type updates**:
   - `storageType: DocumentStorageType!` - computed from which IDs are present
   - `sharePointItemId: String` - SharePoint item ID
   - `sharePointPath: String` - Full SharePoint path
   - `thumbnailSmall/Medium/Large: String` - Thumbnail URLs for grid view
3. **New query**: `caseDocumentsGrid` with pagination, sorting, filtering
4. **New types**: `DocumentGridConnection`, `DocumentGridEdge`, `PageInfo`
5. **New enums**: `DocumentSortField`, `SortDirection`

### Resolver Changes (`document.resolvers.ts`)

1. `storageType` - computed field resolver based on which storage IDs are present
2. `sharePointItemId/sharePointPath` - passthrough from DB
3. `thumbnailSmall/Medium/Large` - returns null (requires context/access token)
4. `caseDocumentsGrid` - cursor-based pagination with file type filtering and sorting

### Database Changes (`schema.prisma`)

- Added `sharePointItemId` and `sharePointPath` fields to Document model
- Created migration `20251222200000_add_sharepoint_fields`

### Environment Variables

Added to `.env.example`:

- `SHAREPOINT_SITE_ID` - SharePoint site ID (format: hostname,site-guid,web-guid)
- `SHAREPOINT_DRIVE_ID` - SharePoint drive ID

## Files Affected

**Modified:**

- `services/gateway/src/graphql/schema/document.graphql`
- `services/gateway/src/graphql/resolvers/document.resolvers.ts`
- `packages/database/prisma/schema.prisma`
- `.env.example`
- `services/gateway/.env.example`

**Created:**

- `packages/database/prisma/migrations/20251222200000_add_sharepoint_fields/migration.sql`

## Acceptance Criteria

- [x] Document type includes `storageType` field
- [x] Document type includes thumbnail URL fields
- [x] `caseDocumentsGrid` query returns documents with pagination
- [x] SharePoint fields added to Prisma schema
- [x] Migration created and applied

## Local Verification Status

| Step           | Status     | Notes                                        |
| -------------- | ---------- | -------------------------------------------- |
| Prod data test | ⬜ Pending | Schema changes - needs full integration test |
| Preflight      | ⬜ Pending | Pre-existing errors in email.resolvers.ts    |
| Docker test    | ⬜ Pending |                                              |

**Verified**: No (ready for verification)

## Session Log

- [2025-12-22] Issue created as part of SharePoint migration epic.
- [2025-12-22 20:00] Session 1: Implemented all schema changes:
  - Added DocumentStorageType enum with ONEDRIVE, SHAREPOINT, R2 values
  - Added SharePoint fields and thumbnail fields to Document type
  - Added caseDocumentsGrid query with full pagination support
  - Added sorting and file type filtering to grid query
  - Updated document resolvers with storageType computation
  - Added SharePoint fields to Prisma schema
  - Created and applied migration
  - Updated .env.example files with SharePoint configuration
