# OPS-038: Contacts & Metadata in Case Flow

**Status:** Open | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-18

## Overview

Enable setting case contacts and classification metadata upfront in the case creation flow and case details edit.

## Dependencies

- **Depends on:** OPS-035 (data model for referenceNumbers, classificationKeywords)
- **Blocks:** OPS-041
- **Parallel with:** OPS-039, OPS-040

## Context

Part of the Communications Architecture Rethink. Contacts and case metadata must be set upfront to enable accurate email classification.

**Key change:** Case creation = T0. No historical email import. Contacts set at creation determine which future emails are routed to this case.

## Requirements

### 1. New Case Modal - Step 2: Contacts

Add a required step in the case creation flow:

```
┌────────────────────────────────────────────────┐
│  Dosar nou                          Pas 2 / 3  │
├────────────────────────────────────────────────┤
│  Contacte                                      │
│                                                │
│  Client *                                      │
│  ┌──────────────────────────────────────────┐  │
│  │ Ion Popescu                              │  │
│  │ ion.popescu@email.com                    │  │
│  │ +40 721 123 456                          │  │
│  └──────────────────────────────────────────┘  │
│                                 [+ Adaugă]     │
│                                                │
│  Parte adversă (opțional)                      │
│  ┌──────────────────────────────────────────┐  │
│  │ SC Beta SRL                              │  │
│  │ contact@beta.ro, legal@beta.ro           │  │
│  └──────────────────────────────────────────┘  │
│                                 [+ Adaugă]     │
│                                                │
│  Număr dosar instanță (opțional)              │
│  ┌──────────────────────────────────────────┐  │
│  │ 123/45/2025                              │  │
│  └──────────────────────────────────────────┘  │
│  [+ Adaugă număr]                              │
│                                                │
│           [Înapoi]  [Continuă]                 │
└────────────────────────────────────────────────┘
```

**Validation:**

- At least one Client contact required
- Email format validation
- Reference number format validation (optional)

### 2. Case Details - Contacts Section

Enhance existing ActorsManagement to include:

- Reference numbers (array, add/remove)
- Classification keywords (array, add/remove)
- Multiple email addresses per contact

```
┌─────────────────────────────────────────────────────────────────┐
│  Contacte & Clasificare                                         │
├─────────────────────────────────────────────────────────────────┤
│  Contacte                                                       │
│  ─────────────────────────────────────────────────────────────  │
│  │ Ion Popescu (Client)            [Editează] [Șterge]      │  │
│  │ ion.popescu@email.com, ion.p@gmail.com                   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                 [+ Contact]     │
│                                                                 │
│  Numere dosar instanță                                          │
│  ─────────────────────────────────────────────────────────────  │
│  │ 123/45/2025  [×]                                          │  │
│  │ 456/78/2025  [×]                                          │  │
│  [+ Adaugă număr]                                               │
│                                                                 │
│  Cuvinte cheie clasificare                                      │
│  ─────────────────────────────────────────────────────────────  │
│  │ alfa  [×]  │  furnizare  [×]  │  contract  [×]           │  │
│  [+ Adaugă]                                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 3. GraphQL Mutations

```graphql
# Update case metadata
mutation updateCaseMetadata($caseId: ID!, $input: CaseMetadataInput!) {
  updateCaseMetadata(caseId: $caseId, input: $input) {
    id
    referenceNumbers
    classificationKeywords
  }
}

input CaseMetadataInput {
  referenceNumbers: [String!]
  classificationKeywords: [String!]
}
```

### 4. Contact Multiple Emails

Ensure CaseActor supports multiple email addresses:

- Primary email field
- Additional emails in `emailDomains[]` or new `additionalEmails[]` field
- Classification matches any of the emails

## Acceptance Criteria

- [x] New case modal has contacts step (step 2)
- [x] Client contact required to create case
- [x] Reference numbers can be added in case creation
- [x] Case details has Contacts & Classification section
- [x] Reference numbers editable (add/remove)
- [x] Classification keywords editable (add/remove)
- [x] Multiple emails per contact supported
- [x] GraphQL mutations work
- [x] No TypeScript errors

## Files Modified

- `apps/web/src/components/case/CreateCaseModal.tsx` - Added multi-step wizard with ContactsStep
- `apps/web/src/components/case/ActorsManagement.tsx` - Added emailDomains support, Romanian translations
- `apps/web/src/components/case/ContactsStep.tsx` - **NEW** - Contacts step component for case creation
- `apps/web/src/components/case/CaseMetadataEditor.tsx` - **NEW** - Metadata editor for reference numbers/keywords
- `apps/web/src/hooks/useCaseMetadata.ts` - **NEW** - Hook for updateCaseMetadata mutation
- `apps/web/src/hooks/useActorAdd.ts` - Added emailDomains field
- `apps/web/src/hooks/useActorUpdate.ts` - Added emailDomains field
- `services/gateway/src/graphql/schema/case.graphql` - Added emailDomains to CaseActor, CaseMetadataInput, updateCaseMetadata mutation
- `services/gateway/src/graphql/resolvers/case.resolvers.ts` - Added updateCaseMetadata resolver, CaseActor.emailDomains resolver

## Estimated Scope

Medium-Large - Multi-step modal + new UI sections.

---

## Session Log

### Session 1 - 2025-12-18

**Work completed:**

1. **GraphQL Schema Updates:**
   - Added `emailDomains: [String!]!` to CaseActor type
   - Added emailDomains to AddCaseActorInput and UpdateCaseActorInput
   - Created CaseMetadataInput type (referenceNumbers, keywords, subjectPatterns, classificationNotes)
   - Added updateCaseMetadata mutation

2. **Resolver Implementation:**
   - Implemented updateCaseMetadata resolver in case.resolvers.ts
   - Added CaseActor.emailDomains field resolver (ensures always returns array)

3. **Frontend Components:**
   - Created ContactsStep.tsx - Step 2 of case creation wizard with:
     - Contact cards with role badges
     - Email domains management
     - Reference numbers section
   - Created CaseMetadataEditor.tsx - Editable metadata section for case details
   - Created useCaseMetadata.ts hook

4. **CreateCaseModal Updates:**
   - Converted to 2-step wizard with step indicator
   - Step 1: Case details (existing form)
   - Step 2: Contacts & reference numbers (ContactsStep)
   - Validation: requires at least one client with name
   - After case creation: adds contacts and updates metadata

5. **ActorsManagement Updates:**
   - Added emailDomains editing UI
   - Translated all labels to Romanian
   - Updated useActorAdd and useActorUpdate hooks with emailDomains

**Status:** Implementation complete, needs local verification

**Next steps:**

- Run preflight checks
- Test with production data
- Verify case creation flow end-to-end
