# OPS-202: blockSenderFromSync Mutation

**Status:** Resolved | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-24

## Overview

NECLAR emails need a "Privat" button that blocks the sender from future email sync (until user unblocks from settings).

## Dependencies

- **Depends on:** None
- **Blocks:** OPS-204 (NECLAR Action Bar)
- **Parallel with:** OPS-200, OPS-201

## Context

Part of Communications Action Bar Redesign epic. When triaging NECLAR emails, users should be able to mark a sender as "private/personal" which:

1. Blocks future emails from that sender from syncing
2. Marks the current email as ignored
3. Can be reversed from settings

## Requirements

### 1. Schema Update

Option A: Extend PersonalContact model

```prisma
model PersonalContact {
  // existing fields...
  isBlocked    Boolean   @default(false)
  blockedAt    DateTime?
}
```

Option B: Create BlockedSender model (if separation needed)

```prisma
model BlockedSender {
  id        String   @id @default(cuid())
  userId    String
  email     String
  blockedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, email])
}
```

### 2. GraphQL Mutations

```graphql
type Mutation {
  # Block sender and optionally ignore the email
  blockSenderFromSync(emailId: ID!): BlockedSender!

  # Unblock for settings page
  unblockSender(email: String!): Boolean!
}

type BlockedSender {
  id: ID!
  email: String!
  blockedAt: DateTime!
}

type Query {
  # For settings page
  blockedSenders: [BlockedSender!]!
}
```

### 3. Service Implementation

```typescript
class PersonalContactService {
  async blockSenderFromSync(emailId: string, userId: string): Promise<BlockedSender> {
    // 1. Get email to extract sender
    const email = await prisma.email.findUnique({ where: { id: emailId } });
    const senderEmail = extractEmail(email.fromAddress);

    // 2. Create blocked sender record
    const blocked = await prisma.blockedSender.upsert({
      where: { userId_email: { userId, email: senderEmail } },
      create: { userId, email: senderEmail },
      update: { blockedAt: new Date() },
    });

    // 3. Mark email as ignored
    await prisma.email.update({
      where: { id: emailId },
      data: { classificationState: 'IGNORED' },
    });

    return blocked;
  }

  async unblockSender(email: string, userId: string): Promise<boolean> {
    await prisma.blockedSender.delete({
      where: { userId_email: { userId, email } },
    });
    return true;
  }
}
```

### 4. Email Sync Filter

Update email sync service to check blocked list:

```typescript
// In email-sync.service.ts
async shouldSyncEmail(email: MSGraphEmail, userId: string): Promise<boolean> {
  const senderEmail = email.from?.emailAddress?.address;
  if (!senderEmail) return true;

  const isBlocked = await prisma.blockedSender.findUnique({
    where: { userId_email: { userId, email: senderEmail.toLowerCase() } },
  });

  return !isBlocked;
}
```

## Acceptance Criteria

- [ ] Schema migration created
- [ ] `blockSenderFromSync` mutation creates blocked record
- [ ] `blockSenderFromSync` marks email as ignored
- [ ] Email sync skips emails from blocked senders
- [ ] `unblockSender` mutation removes block
- [ ] `blockedSenders` query returns list for settings
- [ ] TypeScript types updated

## Files to Modify

- `packages/database/prisma/schema.prisma`
- `services/gateway/src/graphql/schema/personal-contact.graphql`
- `services/gateway/src/graphql/resolvers/personal-contact.resolvers.ts`
- `services/gateway/src/services/personal-contact.service.ts`
- `services/gateway/src/services/email-sync.service.ts`

## Estimated Scope

Medium - New mutation with sync integration.

---

## Session Log

### Session 1 - 2025-12-24

**Finding**: This functionality was already implemented as part of OPS-190.

**Mapping OPS-202 â†’ OPS-190**:
| OPS-202 Requirement | Existing Implementation |
|---------------------|-------------------------|
| `blockSenderFromSync` mutation | `markSenderAsPersonal(emailId, ignoreEmail)` mutation |
| `unblockSender` mutation | `removePersonalContact(email)` mutation |
| `blockedSenders` query | `personalContacts` query |
| Email sync filtering | `filterOutPersonalContacts()` in email-sync.service.ts |

**Files (already implemented)**:

- `services/gateway/src/services/personal-contact.service.ts` - Service layer
- `services/gateway/src/graphql/schema/personal-contact.graphql` - GraphQL schema
- `services/gateway/src/graphql/resolvers/personal-contact.resolvers.ts` - Resolvers
- `services/gateway/src/services/email-sync.service.ts:453` - Sync filtering

**Status**: Resolved (already complete)
