# OPS-051: Time Grouping Utility for Chronology

**Status:** Verifying | **Priority:** P2-Medium | **Type:** Feature | **Created:** 2025-12-19

## Context

Part of the chronology structure improvement (OPS-051 through OPS-054). This issue creates the utility function to group case events by time period.

## Scope

Create a utility function that groups events into time periods:

- Astăzi (Today)
- Săptămâna aceasta (This Week, excluding today)
- Luna aceasta (This Month, excluding this week)
- Mai vechi (Older)

## Implementation

### File Location

`apps/web/src/lib/timeGrouping.ts` (Note: using lib/ folder, not utils/)

### Interface

```typescript
export type TimePeriod = 'today' | 'thisWeek' | 'thisMonth' | 'older';

export interface TimeGroup<T> {
  period: TimePeriod;
  label: string; // Romanian label
  events: T[];
  count: number;
}

export function groupEventsByTimePeriod<T extends { occurredAt: string }>(
  events: T[]
): TimeGroup<T>[];
```

### Logic

```typescript
// Using date-fns with Romanian locale
import { isToday, isThisWeek, isThisMonth, startOfWeek } from 'date-fns';
import { ro } from 'date-fns/locale';

function getTimePeriod(date: Date): TimePeriod {
  if (isToday(date)) return 'today';
  if (isThisWeek(date, { locale: ro, weekStartsOn: 1 })) return 'thisWeek';
  if (isThisMonth(date)) return 'thisMonth';
  return 'older';
}
```

### Labels

```typescript
const PERIOD_LABELS: Record<TimePeriod, string> = {
  today: 'Astăzi',
  thisWeek: 'Săptămâna aceasta',
  thisMonth: 'Luna aceasta',
  older: 'Mai vechi',
};
```

### Behavior

- Empty groups should be excluded from output
- Events within each group maintain chronological order (most recent first)
- Groups are always returned in order: today → thisWeek → thisMonth → older

## Tests

Created `apps/web/src/lib/timeGrouping.test.ts`:

1. ✅ Groups events correctly into time periods
2. ✅ Excludes empty groups
3. ✅ Maintains chronological order within groups
4. ✅ Handles edge cases (week boundary, month boundary)
5. ✅ Handles empty input array
6. ✅ Count accuracy matches events array length
7. ✅ Romanian labels returned correctly

**Test Results:** 16 tests passing

## Acceptance Criteria

- [x] Utility function created with TypeScript types
- [x] Unit tests passing (16/16)
- [x] Uses date-fns with Romanian locale for week start (Monday)

## Local Verification Status

| Step           | Status     | Date | Notes                               |
| -------------- | ---------- | ---- | ----------------------------------- |
| Prod data test | ⬜ Pending |      | Pure utility, no UI integration yet |
| Preflight      | ⬜ Pending |      |                                     |
| Docker test    | ⬜ Pending |      | Pure utility, no UI integration yet |

**Verified**: No

## Session Log

- [2025-12-19 15:10] Session 1 started
- [2025-12-19 15:12] Created `apps/web/src/lib/timeGrouping.ts` with utility function
- [2025-12-19 15:12] Created `apps/web/src/lib/timeGrouping.test.ts` with 16 comprehensive tests
- [2025-12-19 15:13] All tests passing, TypeScript compiles successfully
- [2025-12-19 15:13] Ready for verification

## Dependencies

- None (can be built independently)

## Blocked By

- Nothing

## Blocks

- OPS-054 (CaseChronology Integration)

## Files Involved

- `apps/web/src/lib/timeGrouping.ts` (created)
- `apps/web/src/lib/timeGrouping.test.ts` (created)
