# OPS-127: Thread Emails Missing Attachments in ConversationView

| Field             | Value      |
| ----------------- | ---------- |
| **Status**        | Resolved   |
| **Type**          | Bug        |
| **Priority**      | P1-High    |
| **Created**       | 2025-12-23 |
| **Resolved Date** | 2025-12-23 |
| **Sessions**      | 2          |
| **Last Active**   | 2025-12-23 |

## Description

When viewing email threads in the ConversationView component on /communications, attachments are not displayed even though emails indicate they have attachments (`hasAttachments: true`). The email content may reference attachments (e.g., "Transmit atasat documentatia solicitata" / "I'm sending the attached documentation") but no attachments appear in the UI.

## Symptom Category

**Category A**: "X Not Appearing in UI" - Data exists but not displayed

## Investigation Summary

| Hypothesis            | Verdict  | Key Finding                                                    |
| --------------------- | -------- | -------------------------------------------------------------- |
| Frontend rendering    | ✅ Clear | ConversationBubble correctly renders attachments when provided |
| GraphQL resolver      | ✅ Clear | Email.attachments resolver works, filters dismissed correctly  |
| Backend thread query  | ❌ Root  | `getThread()` doesn't include attachments in Prisma query      |
| ThreadEmail transform | ❌ Root  | `transformToThreadEmail()` doesn't map attachments field       |
| Type signature issue  | ❌ Root  | `groupEmailsIntoThreads()` type didn't allow attachments       |

## Root Cause

The `EmailThreadService.getThread()` method in `services/gateway/src/services/email-thread.service.ts` had multiple issues preventing attachments from flowing through:

1. **Prisma query was including attachments** but type signature of `groupEmailsIntoThreads()` was `Email[]` which stripped attachment data
2. **ThreadEmailAttachment interface** was missing required fields (`documentId`, `storageUrl`, `filterStatus`)
3. **transformToThreadEmail()** wasn't properly mapping all attachment fields

## Resolution

Updated `services/gateway/src/services/email-thread.service.ts`:

1. **Updated `ThreadEmailAttachment` interface** to include all required fields:

```typescript
export interface ThreadEmailAttachment {
  id: string;
  name: string;
  contentType: string;
  size: number;
  documentId?: string | null;
  storageUrl?: string | null;
  filterStatus?: string | null;
}
```

2. **Updated `groupEmailsIntoThreads()` function signature** to accept emails with attachments:

```typescript
groupEmailsIntoThreads(
  emails: Array<
    Email & {
      attachments?: Array<{
        id: string;
        name: string;
        contentType: string;
        size: number;
        documentId: string | null;
        storageUrl: string | null;
        filterStatus: string | null;
      }>;
    }
  >
): EmailThread[]
```

3. **Updated `transformToThreadEmail()`** to map all attachment fields including `documentId`, `storageUrl`, and `filterStatus`.

4. **CRITICAL FIX: Added attachments include to `getThreads()` method** (line 279):

```typescript
const emails = await this.prisma.email.findMany({
  where: { ... },
  orderBy: { receivedDateTime: 'asc' },
  include: {
    attachments: {
      where: {
        OR: [{ filterStatus: null }, { filterStatus: { not: 'dismissed' } }],
      },
    },
  },
});
```

This was the main bug - `getThread()` (singular) had attachments, but `getThreads()` (plural, used by the list view) did not.

## Local Verification Status

| Step           | Status | Date       | Notes                                           |
| -------------- | ------ | ---------- | ----------------------------------------------- |
| Prod data test | ✅     | 2025-12-23 | Tested "Crowe: acord colaborare" thread - works |
| Preflight      | ✅     | 2025-12-23 | All checks passed (6 passed, 2 warnings)        |
| Docker test    | ✅     | 2025-12-23 | Both web and gateway Docker builds succeeded    |

**Verified**: Yes

## Session Log

- [2025-12-23 19:40] Issue created via /ops-investigate. Category: A (X Not Appearing). Root cause: EmailThreadService.getThread() doesn't include attachments in Prisma query or ThreadEmail transform.
- [2025-12-23 20:00] RESOLVED: Fixed type signatures and attachment field mapping in email-thread.service.ts. Verified with "Crowe: acord colaborare" thread showing both sent and received attachments. Total sessions: 2. Verification: ✅ All passed (prod data, preflight, Docker). Lessons: Type signatures matter - even if Prisma includes data, if the function signature doesn't allow for it, the data gets lost.

## Files Involved

- `services/gateway/src/services/email-thread.service.ts` - Primary fix (type signatures and transform)
- `apps/web/src/components/communication/ConversationView.tsx` - Frontend (already correct)
- `apps/web/src/components/communication/ConversationBubble.tsx` - Frontend (already correct)
- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - GraphQL resolver (already correct)

---
