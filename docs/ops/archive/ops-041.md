# OPS-041: /communications Case-Organized Redesign

**Status:** Verifying | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-18 | **Sessions:** 1 | **Last Active:** 2025-12-18

## Overview

Complete redesign of `/communications` as the user's email workspace, organized by case with separate sections for court emails and uncertain classifications.

## Dependencies

- **Depends on:** OPS-035, OPS-036, OPS-038, OPS-039, OPS-040
- **Blocks:** None
- **Parallel with:** OPS-042

## Context

Part of the Communications Architecture Rethink. This is the main integration issue that brings together all the foundation work.

**Key principles:**

- Shows only current user's emails
- Organized by case (not a flat inbox)
- Action-oriented: reply, forward, compose
- Separate sections for court emails (INSTANȚE) and uncertain (NECLAR)

## Requirements

### 1. Page Layout

```
┌─────────────────────────────────────────────────────────────────────┐
│  Emailurile Mele                                          [Sync ↻] │
├──────────────────┬──────────────────────────────────────────────────┤
│                  │                                                  │
│  DOSARE          │  Thread View (Outlook-style)                     │
│  ─────────────── │  ──────────────────────────────────────────────  │
│  ▼ Popescu v.    │  From: ion.popescu@email.com                     │
│    Ionescu (3)   │  To: me                                          │
│    • Thread 1    │  Subject: Re: Întâlnire vineri                   │
│    • Thread 2    │  ────────────────────────────────────────────    │
│    • Thread 3    │                                                  │
│                  │  Bună ziua,                                      │
│  ▼ SC Alpha v.   │                                                  │
│    SC Beta (1)   │  Confirm prezența la întâlnirea de vineri...     │
│                  │                                                  │
│  ─────────────── │  ──────────────────────────────────────────────  │
│  INSTANȚE (2)    │                        [Răspunde] [Redirecționează]
│  • Citație 123   │                                                  │
│  • Notificare    │                                                  │
│                  │                                                  │
│  ─────────────── │                                                  │
│  NECLAR (1) [!]  │                                                  │
│  • De la Maria   │                                                  │
│                  │                                                  │
└──────────────────┴──────────────────────────────────────────────────┘
```

### 2. Left Sidebar - Case Accordion

```typescript
interface SidebarSection {
  type: 'cases' | 'court' | 'uncertain';
  items: SidebarItem[];
}

interface SidebarItem {
  id: string;
  label: string; // Case title or email subject
  unreadCount: number;
  threads?: ThreadPreview[]; // Expandable
}
```

**Behavior:**

- Cases expanded by default if they have unread emails
- Click case to expand/collapse thread list
- Click thread to view in main panel
- INSTANȚE section: court emails not assigned (COURT_UNASSIGNED)
- NECLAR section: emails needing classification (UNCERTAIN)

### 3. Thread View

Outlook-style conversation view:

- Full email thread with all messages
- Most recent at top or bottom (configurable?)
- HTML email rendering (existing MessageView)
- Action buttons: Răspunde, Redirecționează

### 4. Data Fetching

```graphql
query getMyEmailsByCase {
  myEmailsByCase {
    cases {
      id
      title
      unreadCount
      threads {
        id
        subject
        lastMessageDate
        messageCount
        isUnread
      }
    }
    courtUnassigned {
      id
      subject
      from
      receivedDateTime
      extractedReferences
    }
    uncertain {
      id
      subject
      from
      receivedDateTime
      suggestedCases {
        id
        title
        confidence
      }
    }
  }
}
```

### 5. Empty States

- No cases: "Nu aveți emailuri în dosare active"
- No court emails: Section hidden or "Nicio corespondență de la instanțe"
- No uncertain: Section hidden (good state!)

### 6. Sync Integration

Keep existing sync button and status:

- "Sincronizează email" button
- Last sync timestamp
- Sync in progress indicator

After sync, new emails appear in appropriate sections based on classification.

## Acceptance Criteria

- [x] Left sidebar shows cases with thread counts
- [x] Cases expandable to show threads
- [x] INSTANȚE section shows unassigned court emails
- [x] NECLAR section shows uncertain emails (with badge)
- [x] Thread view shows full conversation
- [x] Reply and Forward buttons work (via existing MessageView)
- [x] AI assist available in reply composer (via existing ComposeInterface)
- [x] Only current user's emails shown (via existing thread filtering)
- [ ] Infinite scroll in thread lists _(Future enhancement)_
- [x] Sync button works
- [ ] Responsive design (mobile-friendly) _(Needs testing)_
- [x] No TypeScript errors

## Files to Modify

- `apps/web/src/app/communications/page.tsx` - complete rewrite
- New: `apps/web/src/components/communication/CaseSidebar.tsx`
- New: `apps/web/src/components/communication/CaseAccordion.tsx`
- New: `apps/web/src/hooks/useMyEmailsByCase.ts`
- Reuse: `apps/web/src/components/communication/MessageView.tsx`
- Reuse: `apps/web/src/components/communication/ComposeInterface.tsx`

## Estimated Scope

Large - Complete page redesign.

---

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

## Session Log

### Session 1 - 2025-12-18

**Work Completed:**

1. **Created `useMyEmailsByCase` hook** (`apps/web/src/hooks/useMyEmailsByCase.ts`):
   - Combines three existing queries: `emailThreads`, `unassignedCourtEmails`, `uncertainEmails`
   - Groups email threads by case ID
   - Returns structured data: `cases`, `unassignedCase`, `courtUnassigned`, `uncertain`
   - Includes counts for INSTANȚE and NECLAR sections

2. **Created `CaseSidebar` component** (`apps/web/src/components/communication/CaseSidebar.tsx`):
   - Three sections: DOSARE (cases), INSTANȚE (court), NECLAR (uncertain)
   - Case accordion with expandable thread lists
   - Cases auto-expand if they have unread emails
   - Thread items show subject, sender, date, unread/attachment indicators
   - Court email items show extracted reference numbers
   - Uncertain email items show number of suggested cases

3. **Rewrote `/communications` page** (`apps/web/src/app/communications/page.tsx`):
   - Two-column layout (sidebar + content)
   - Integrated `CaseSidebar` for navigation
   - Thread selection loads full thread in `MessageView`
   - Court email selection shows email details with reference numbers and suggested cases
   - NECLAR selection opens `ClassificationModal` (from OPS-042)
   - Kept existing sync functionality and Outlook link
   - Integrated with existing `ComposeInterface` for replies

4. **Integrated ClassificationModal from OPS-042**:
   - Opens when clicking uncertain email in NECLAR section
   - Refetches data after classification

**Files Created:**

- `apps/web/src/hooks/useMyEmailsByCase.ts`
- `apps/web/src/components/communication/CaseSidebar.tsx`

**Files Modified:**

- `apps/web/src/app/communications/page.tsx` (complete rewrite)

**Tests:**

- ✅ Gateway TypeScript compiles with no errors
- ✅ Web app TypeScript compiles with no errors
- ⬜ Local verification pending

**Architecture Notes:**

- Used existing queries instead of creating a new backend `myEmailsByCase` query
- Reused existing `MessageView` component for thread display
- Reused existing `ComposeInterface` for email composition
- Integrated OPS-042 `ClassificationModal` for NECLAR queue handling
