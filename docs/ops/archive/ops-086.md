# OPS-086: Frontend Tool Response Handling

**Status:** Implemented | **Priority:** P1-High | **Type:** Feature
**Created:** 2025-12-21 | **Depends on:** OPS-084

## Summary

Update the frontend to handle the new tool-based response format from the AI assistant. The UI structure (pill, chat, messages) stays the same - only the data handling changes.

## Background

Current frontend expects:

```typescript
interface AIResponse {
  intent: string;
  message: string;
  pendingAction?: { type: string; preview: object };
}
```

New format from Sonnet tool calling:

```typescript
interface AIResponse {
  message: string;
  pendingAction?: {
    toolName: string;
    parameters: Record<string, unknown>;
    preview: string;
  };
  suggestedFollowUps?: string[];
}
```

## Requirements

### Updated GraphQL Types

```graphql
# Already mostly compatible, minor updates needed

type AssistantMessage {
  id: ID!
  role: AssistantRole!
  content: String!
  timestamp: DateTime!
  pendingAction: PendingAction # Updated type
}

type PendingAction {
  toolName: String! # Was: type
  parameters: JSON! # Was: preview (object)
  preview: String! # Human-readable summary (new)
}

type SendMessageResponse {
  message: AssistantMessage!
  suggestedFollowUps: [String!] # New field
}
```

### Store Updates

```typescript
// apps/web/src/stores/assistant.store.ts

interface AssistantState {
  // ... existing fields stay the same

  // Update pending action type
  pendingAction: {
    toolName: string;
    parameters: Record<string, unknown>;
    preview: string;
  } | null;

  // Add suggested follow-ups
  suggestedFollowUps: string[];
}
```

### UI Updates

```typescript
// apps/web/src/components/assistant/ActionConfirmCard.tsx

// Update to use new preview format
function ActionConfirmCard({ action }: { action: PendingAction }) {
  return (
    <div className="rounded-lg border bg-amber-50 p-4">
      <div className="text-sm font-medium text-amber-800">
        Confirmă acțiunea
      </div>

      {/* Preview is now a formatted string, not an object */}
      <div className="mt-2 whitespace-pre-wrap text-sm text-amber-700">
        {action.preview}
      </div>

      <div className="mt-4 flex gap-2">
        <Button onClick={onConfirm}>Confirmă</Button>
        <Button variant="outline" onClick={onReject}>Anulează</Button>
      </div>
    </div>
  );
}
```

```typescript
// apps/web/src/components/assistant/SuggestedFollowUps.tsx (new)

function SuggestedFollowUps({
  suggestions,
  onSelect
}: {
  suggestions: string[];
  onSelect: (text: string) => void;
}) {
  if (!suggestions.length) return null;

  return (
    <div className="flex flex-wrap gap-2 p-2">
      {suggestions.map((suggestion, i) => (
        <button
          key={i}
          onClick={() => onSelect(suggestion)}
          className="rounded-full bg-blue-100 px-3 py-1 text-sm text-blue-700 hover:bg-blue-200"
        >
          {suggestion}
        </button>
      ))}
    </div>
  );
}
```

### Hook Updates

```typescript
// apps/web/src/hooks/useAssistant.ts

// Mostly stays the same, just handle new response shape

const sendMessage = async (content: string) => {
  // ... existing logic

  const result = await sendMessageMutation({
    variables: { conversationId, content, context },
  });

  // Handle suggested follow-ups (new)
  if (result.data?.sendAssistantMessage.suggestedFollowUps) {
    setSuggestedFollowUps(result.data.sendAssistantMessage.suggestedFollowUps);
  }
};
```

## Changes Summary

| Component         | Change                                                  |
| ----------------- | ------------------------------------------------------- |
| GraphQL types     | `PendingAction.type` → `toolName`, add `preview` string |
| Store             | Update `pendingAction` type, add `suggestedFollowUps`   |
| ActionConfirmCard | Display preview as string instead of object             |
| AssistantChat     | Add SuggestedFollowUps component                        |
| useAssistant hook | Handle `suggestedFollowUps` in response                 |

## Acceptance Criteria

- [ ] Action confirmation shows formatted preview text
- [ ] Suggested follow-ups appear after responses
- [ ] Clicking suggestion fills input
- [ ] Existing UI (pill, open/close, messages) unchanged
- [ ] TypeScript types match new backend response

## Files to Modify

- `services/gateway/src/graphql/schema/ai-assistant.graphql`
- `apps/web/src/stores/assistant.store.ts`
- `apps/web/src/hooks/useAssistant.ts`
- `apps/web/src/components/assistant/ActionConfirmCard.tsx`
- `apps/web/src/components/assistant/SuggestedFollowUps.tsx` (new)
- `apps/web/src/components/assistant/AssistantChat.tsx`

## Session Log

- [2025-12-21] Issue created
- [2025-12-21] Session 1: Implemented frontend tool response handling:
  - Updated `ai-assistant.service.ts` to store preview info in actionPayload
  - Updated `AIMessage.proposedAction` resolver to use stored preview info
  - Added `buildEntityPreview()` function to extract relevant fields for UI display
  - Added all new tool names to `getActionDisplayText()` and `getConfirmationPrompt()`
  - Added helper functions for Romanian date formatting and translations
  - Frontend already had `suggestedFollowUps` support (from OPS-071)
  - TypeScript compilation passes. Status changed to Implemented.
