# OPS-239: Case Health Scoring Processor

**Type**: Feature
**Priority**: P2-Medium
**Status**: Completed
**Epic**: AI Batch Processing & Ops Dashboard

## Problem

Partners have no visibility into which cases need attention. Problems discovered too late when deadlines are missed or clients complain.

## Solution

Create `CaseHealthProcessor` that scores each active case nightly and surfaces concerns.

### Health Score Algorithm

Score 0-100 based on weighted factors:

| Factor              | Weight | Scoring                                          |
| ------------------- | ------ | ------------------------------------------------ |
| Days since activity | 25%    | 100 if <7d, 50 if <14d, 0 if >30d                |
| Unanswered emails   | 25%    | 100 if 0, 50 if 1-2, 0 if >3                     |
| Overdue tasks       | 25%    | 100 if 0, 50 if 1, 0 if >2                       |
| Upcoming deadlines  | 25%    | 100 if none <7d, 50 if prepared, 0 if unprepared |

### AI-Generated Insights

Claude analyzes the case data and generates:

- Top 3 concerns (if any)
- Suggested next actions
- Risk assessment

### Data Model

```prisma
model CaseHealthScore {
  id            String   @id @default(uuid())
  caseId        String
  firmId        String

  score         Int      // 0-100

  // Factor breakdown
  activityScore     Int
  emailScore        Int
  taskScore         Int
  deadlineScore     Int

  // AI-generated
  concerns      String[] // Array of concern strings
  suggestions   String[] // Array of suggested actions
  riskLevel     String   // 'low', 'medium', 'high', 'critical'

  // Metadata
  calculatedAt  DateTime @default(now())

  case          Case     @relation(fields: [caseId], references: [id])

  @@index([firmId, calculatedAt])
  @@index([caseId])
}

// Also add to existing Case model:
model Case {
  // ... existing fields ...
  healthScores  CaseHealthScore[]
}
```

### Dashboard Integration

Partner dashboard shows:

- Cases sorted by health score (worst first)
- Color coding: green (80+), yellow (50-79), red (<50)
- Expandable concerns and suggestions

## Acceptance Criteria

- [x] `CaseHealthProcessor` implements `BatchProcessor`
- [x] Health score algorithm with 4 weighted factors
- [x] AI generates concerns and suggestions in Romanian
- [x] Scores stored with timestamp
- [x] Only active cases processed (not Closed/Archived)
- [x] GraphQL query for case health scores
- [ ] Partner dashboard can display health scores (UI work in separate issue)

## Files to Modify

- `services/gateway/src/batch/processors/case-health.processor.ts` (new)
- `packages/database/prisma/schema.prisma` (CaseHealthScore model)
- `services/gateway/src/graphql/schema/case.graphql` (add healthScore field)
- `services/gateway/src/graphql/resolvers/case.resolvers.ts` (add resolver)

## Dependencies

- OPS-236 (Batch Job Runner Framework)

## Parallel Work

Can be done in parallel with OPS-237, OPS-238, OPS-240.
