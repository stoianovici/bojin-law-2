# OPS-035: Data Model - Classification State & Case Metadata

**Status:** Verifying | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-18 | **Sessions:** 1 | **Last Active:** 2025-12-18

## Overview

Foundation issue for the Communications Rethink. Extends the data model to support:

- Email classification state machine
- Case metadata for classification (reference numbers, keywords)

## Dependencies

- **Depends on:** None (foundation)
- **Blocks:** OPS-038, OPS-039, OPS-040, OPS-041, OPS-042
- **Parallel with:** OPS-036, OPS-037

## Context

Part of the Communications Architecture Rethink. See ideation session for full context.

**Supersedes:** Parts of OPS-027 (schema work) - this extends that foundation.

## Requirements

### 1. Email Classification State

Add state machine for email classification:

```prisma
enum EmailClassificationState {
  PENDING           // Just synced, not yet processed
  CLASSIFIED        // Assigned to case (auto or manual)
  UNCERTAIN         // In NECLAR queue (needs user review)
  COURT_UNASSIGNED  // In INSTANȚE folder (court email, no case match)
  IGNORED           // Marked as not relevant
}

model Email {
  // ... existing fields

  classificationState       EmailClassificationState @default(PENDING)
  classificationConfidence  Float?                   // 0.0 - 1.0
  classifiedAt              DateTime?
  classifiedBy              String?                  // "auto" or userId
}
```

### 2. Case Classification Metadata

Extend Case model for classification hints:

```prisma
model Case {
  // ... existing fields

  referenceNumbers        String[]  // Court case numbers: ["123/45/2025", "456/78/2025"]
  classificationKeywords  String[]  // Terms indicating this case: ["alfa", "furnizare"]
}
```

### 3. Migration

- Add new fields with defaults
- Existing emails: set `classificationState = CLASSIFIED` if `caseId` is set, else `PENDING`
- Existing cases: `referenceNumbers = []`, `classificationKeywords = []`

## Acceptance Criteria

- [x] Prisma schema updated with new enum and fields
- [x] Migration created and tested locally
- [x] Existing data migrated correctly
- [x] GraphQL schema exposes new fields
- [x] No breaking changes to existing queries/mutations

## Files to Modify

- `packages/database/prisma/schema.prisma`
- `services/gateway/src/graphql/schema/email.graphql`
- `services/gateway/src/graphql/schema/case.graphql`
- `services/gateway/src/graphql/resolvers/email.resolver.ts`
- `services/gateway/src/graphql/resolvers/case.resolver.ts`

## Estimated Scope

Small - Schema changes + migration only.

---

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

## Session Log

### Session 1 - 2025-12-18

**Work Completed:**

1. **Analyzed existing schema** - Found that Case already has classification metadata fields from OPS-027:
   - `keywords`, `referenceNumbers`, `subjectPatterns`, `classificationNotes`

2. **Added EmailClassificationState enum** to Prisma schema:
   - `Pending`, `Classified`, `Uncertain`, `CourtUnassigned`, `Ignored`

3. **Added classification fields to Email model**:
   - `classificationState` (enum, default Pending)
   - `classificationConfidence` (Float?)
   - `classifiedAt` (DateTime?)
   - `classifiedBy` (String? - "auto" or userId)

4. **Created migration** with data backfill:
   - Existing emails with caseId → `Classified` state
   - Existing ignored emails → `Ignored` state
   - All others → `Pending` state

5. **Updated GraphQL schema** (email.graphql):
   - Added `EmailClassificationState` enum
   - Added 4 new fields to `Email` type

6. **Updated GraphQL resolvers** (email.resolvers.ts):
   - Added field resolvers for classification fields

**Tests:**

- ✅ TypeScript type check passed
- ✅ Build passed
- ⬜ Local verification pending

**Files Modified:**

- `packages/database/prisma/schema.prisma`
- `packages/database/prisma/migrations/20251218120000_add_email_classification_state/migration.sql`
- `services/gateway/src/graphql/schema/email.graphql`
- `services/gateway/src/graphql/resolvers/email.resolvers.ts`

**Note:** Case classification metadata fields already existed from OPS-027, so no changes needed for Case model.
