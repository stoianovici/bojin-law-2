# OPS-136: Mark Attachment as Irrelevant Mutation

**Status**: Closed
**Type**: Feature
**Priority**: P2-Medium
**Complexity**: S (Small)
**Created**: 2024-12-24
**Closed**: 2024-12-24

## Context

Part of the Context-Aware Document Preview Actions epic. Provides backend support for marking email attachments as irrelevant (signatures, logos, etc.).

## Problem

Users need to mark email attachments as irrelevant to declutter the attachment list. Many emails contain signature images, logos, or other non-useful attachments that should be filterable.

This is different from the existing "dismissed" flag - irrelevant is for attachments that are genuinely not useful for the case.

## Solution

1. Add database field `EmailAttachment.irrelevant` (boolean, default false)
2. Create GraphQL mutation to toggle the flag
3. Update queries to optionally filter irrelevant attachments

## Implementation

### Database Migration

Migration: `20251224100000_add_attachment_irrelevant`

```sql
ALTER TABLE "email_attachments" ADD COLUMN "irrelevant" BOOLEAN NOT NULL DEFAULT false;
```

### GraphQL Schema

Added to `services/gateway/src/graphql/schema/email.graphql`:

```graphql
type EmailAttachment {
  # ... existing fields
  irrelevant: Boolean!
}

extend type Mutation {
  markAttachmentIrrelevant(attachmentId: ID!, irrelevant: Boolean!): EmailAttachment!
}
```

### Resolver

Implemented in `services/gateway/src/graphql/resolvers/email.resolvers.ts`:

- Verifies user authentication
- Checks firm membership for access
- Verifies case access if attachment is linked to a case
- Updates the irrelevant flag

### Filtering

Updated `Email.attachments` resolver to filter out irrelevant attachments by default (same behavior as dismissed attachments).

## Done When

- [x] Database migration created for `irrelevant` field
- [x] Migration tested locally
- [x] GraphQL mutation defined in `email.graphql`
- [x] Resolver implemented in `email.resolvers.ts`
- [x] EmailAttachment type includes `irrelevant` field
- [x] Existing attachment queries filter irrelevant by default
- [x] Authorization enforced (user has access to email's firm/case)

## Files

- `packages/database/prisma/schema.prisma` - Added `irrelevant` field
- `packages/database/prisma/migrations/20251224100000_add_attachment_irrelevant/migration.sql`
- `services/gateway/src/graphql/schema/email.graphql` - Added mutation and field
- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - Implemented resolver

## Dependencies

- **Blocks**: OPS-140, OPS-141
- **Blocked by**: None

## Epic

Context-Aware Document Preview Actions (Phase 1 - Foundation)
