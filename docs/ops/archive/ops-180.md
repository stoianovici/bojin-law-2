# OPS-180: SharePoint Document Download Method

**Type**: Feature
**Priority**: P1-High
**Status**: Complete
**Epic**: Frictionless SharePoint-First Document Editing

## Problem

SharePointService can upload documents and get URLs, but cannot download document content. We need this to:

1. Update R2 backup after Word edits
2. Create proper DocumentVersion records with content

## Solution

Add `downloadDocument(itemId)` method that returns Buffer of file content using the `@microsoft.graph.downloadUrl` from item metadata.

## Implementation

### New Method in SharePointService

```typescript
/**
 * Download document content from SharePoint
 *
 * @param accessToken - User's access token
 * @param itemId - SharePoint item ID
 * @returns Buffer containing file content
 */
async downloadDocument(accessToken: string, itemId: string): Promise<Buffer> {
  this.ensureConfigured();

  return retryWithBackoff(
    async () => {
      try {
        const client = createGraphClient(accessToken);
        const itemEndpoint = graphEndpoints.sharepoint.driveItem(itemId);

        // Get the download URL
        const item = await client.api(itemEndpoint).get();
        const downloadUrl = item['@microsoft.graph.downloadUrl'];

        if (!downloadUrl) {
          throw new Error('No download URL available for document');
        }

        // Fetch the content
        const response = await fetch(downloadUrl);

        if (!response.ok) {
          throw new Error(`Download failed: ${response.status} ${response.statusText}`);
        }

        const arrayBuffer = await response.arrayBuffer();
        return Buffer.from(arrayBuffer);
      } catch (error: any) {
        const parsedError = parseGraphError(error);
        logGraphError(parsedError);
        throw parsedError;
      }
    },
    {},
    'sharepoint-download-document'
  );
}
```

### Considerations

- Large files: The download URL is pre-authenticated and handles streaming
- Memory: For very large files (>100MB), consider streaming to disk
- Current max upload is 100MB, so same limit applies to download

## Files to Modify

- `services/gateway/src/services/sharepoint.service.ts`

## Done When

- [x] `downloadDocument()` method added to SharePointService
- [x] Returns `Buffer` of file content
- [x] Handles errors gracefully (404, network issues)
- [x] Works for all supported file types

## Dependencies

- None (foundation issue)

## Parallel With

- OPS-178: SharePoint Edit Session Schema
- OPS-179: SharePoint Change Detection Methods
