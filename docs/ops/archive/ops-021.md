# OPS-021: Ensure Dev/Production Parity

**Type:** Infrastructure
**Priority:** P2-Medium
**Status:** Resolved
**Created:** 2025-12-14
**Resolved:** 2025-12-14

## Problem

Local development environment had drifted from production:

- Dev Dockerfile used Node 20, production used Node 22
- CI workflows used Node 20, production used Node 22
- No automated way to detect this drift

## Root Cause

Node version was updated in production Dockerfiles but not in development Dockerfile or CI workflows. No validation existed to catch this.

## Solution

### 1. Fixed Node Version Mismatch

Updated to Node 22 across all environments:

- `infrastructure/docker/Dockerfile.dev` - Node 20 → 22
- `.github/workflows/pr-validation.yml` - Node 20 → 22
- `.github/workflows/test.yml` - Node 20 → 22
- `.github/workflows/deploy-selective.yml` - Node 20 → 22
- `.github/workflows/docs-generation.yml` - Node 20 → 22

### 2. Created Parity Check Script

New `scripts/check-parity.sh` validates:

- Node.js version consistency across Dockerfiles and CI
- pnpm version alignment
- Docker Compose file validity
- Dockerfile structure
- Environment variable configuration

### 3. Added npm Scripts

```bash
pnpm check-parity     # Run parity check
pnpm preflight:full   # Parity + full preflight
```

### 4. Updated Documentation

`docs/ops/deployment-flows.md` now documents:

- Parity check usage
- Known intentional differences (migrations, auth skip)
- Updated script reference table

## Files Changed

| File                                     | Change                             |
| ---------------------------------------- | ---------------------------------- |
| `infrastructure/docker/Dockerfile.dev`   | Node 20 → 22                       |
| `.github/workflows/pr-validation.yml`    | Node 20 → 22                       |
| `.github/workflows/test.yml`             | Node 20 → 22                       |
| `.github/workflows/deploy-selective.yml` | Node 20 → 22                       |
| `.github/workflows/docs-generation.yml`  | Node 20 → 22                       |
| `scripts/check-parity.sh`                | Created                            |
| `package.json`                           | Added check-parity, preflight:full |
| `docs/ops/deployment-flows.md`           | Updated with parity docs           |

## Verification

```bash
$ pnpm check-parity
[parity] === Node.js Version Parity ===
[parity] ✓ All Node.js versions match (22)
[parity] === pnpm Version Parity ===
[parity] ✓ pnpm major version matches (10.x)
[parity] === Docker Compose Files ===
[parity] ✓ docker-compose.yml has valid structure
[parity] ✓ docker-compose.prod.yml has valid structure
[parity] === Production Dockerfile Syntax ===
[parity] ✓ All Dockerfiles have valid structure
[parity] === Parity Check Summary ===
[parity] ✓ Passed: 9
[parity] ✓ Dev/production parity verified!
```

## Prevention

Run `pnpm preflight:full` before important deployments to catch parity issues early.
