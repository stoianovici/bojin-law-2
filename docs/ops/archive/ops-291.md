# OPS-291: Update Email Sync to Fetch All Folders

**Type**: Service | **Priority**: P1-High | **Complexity**: M
**Status**: Closed
**Blocked by**: OPS-288, OPS-289
**Epic**: Sync All Outlook Folders

## Problem

Current sync only fetches from `/me/mailFolders/Inbox/messages` and `/me/mailFolders/SentItems/messages`. User-created folders are not synced, causing email count to be limited (e.g., 254 emails when user has more in custom folders).

## Approach

1. Change sync to use `/me/messages` (all folders at once)
2. Add `parentFolderId` to Graph API select fields
3. Fetch folder list once at sync start, build ID→name map
4. Store `parentFolderId` and `parentFolderName` with each email
5. Determine `folderType` from folder name for backwards compatibility:
   - "Inbox" → 'inbox'
   - "Sent Items" → 'sent'
   - Others → null

## Done When

- [x] Sync fetches from `/me/messages` instead of folder-specific endpoints
- [x] Folder ID and name stored for each email
- [x] Personal contacts filter still works
- [x] Existing functionality preserved (case assignment, threading)
- [x] All user folders synced

## Files

- `services/gateway/src/services/email-sync.service.ts`

## Technical Notes

Graph API `/me/messages` includes `parentFolderId` field. We need to:

1. Add it to `EMAIL_SELECT_FIELDS`
2. Fetch folders once to build lookup map
3. Transform messages with folder info

Current sync loop:

```typescript
const foldersToSync: Array<'inbox' | 'sent'> = ['inbox', 'sent'];
for (const folderType of foldersToSync) { ... }
```

New approach:

```typescript
// Fetch all folders first
const folders = await this.fetchMailFolders(client);
const folderMap = new Map(folders.map(f => [f.id, f.displayName]));

// Fetch all messages (no folder loop)
const response = await client.api('/me/messages')...
```

## Session Log

- 2025-12-27: Issue created as part of Outlook Folders epic
- 2025-12-27: Implementation complete:
  - Added `parentFolderId` to EMAIL_SELECT_FIELDS
  - Updated SyncedEmail type with `parentFolderId` and `parentFolderName`
  - Added `buildFolderMap()` to create folder ID→name lookup (handles nested folders)
  - Added `fetchAllEmailsPage()` to fetch from `/me/messages`
  - Added `transformMessagesWithFolders()` to transform messages with folder info
  - Added `filterOutPersonalContactsAllFolders()` for personal contacts filtering
  - Added `deriveFolderType()` for backwards compatibility
  - Updated `storeEmails()` and `upsertEmails()` to persist folder fields
  - TypeScript compilation passes
