# OPS-221: ActorTypeConfig GraphQL & Service

**Type**: Feature | **Priority**: P2-Medium | **Complexity**: M

## Problem

Need API layer for querying and creating custom actor types. Frontend needs unified list of built-in + custom types.

## Solution

Create GraphQL schema and resolvers following case-type.resolvers.ts pattern. Queries merge built-in enum roles with custom ActorTypeConfig records. Partner-only mutations for create/update/deactivate.

## GraphQL Schema

```graphql
type ActorType {
  id: String! # "builtin-CLIENT" or UUID
  code: String! # "CLIENT" or "MANDATAR_SOCIETATE"
  name: String! # "Client" or "Mandatar Societate"
  isBuiltIn: Boolean! # true for enum roles
  isActive: Boolean!
  sortOrder: Int!
}

input CreateActorTypeInput {
  name: String! # 2-100 characters
  code: String! # 2-50 chars, alphanumeric + underscores
  sortOrder: Int # Optional, defaults to 50
}

input UpdateActorTypeInput {
  name: String
  sortOrder: Int
  isActive: Boolean
}

type Query {
  actorTypes(includeInactive: Boolean): [ActorType!]!
  actorType(id: UUID!): ActorType
}

type Mutation {
  createActorType(input: CreateActorTypeInput!): ActorType!
  updateActorType(id: UUID!, input: UpdateActorTypeInput!): ActorType!
  deactivateActorType(id: UUID!): ActorType!
}
```

## Built-in Actor Types

Return these as virtual records with `isBuiltIn: true`:

```typescript
const BUILTIN_ACTOR_TYPES = [
  { code: 'Client', name: 'Client', sortOrder: 1 },
  { code: 'OpposingParty', name: 'Parte Adversă', sortOrder: 10 },
  { code: 'OpposingCounsel', name: 'Avocat Adversar', sortOrder: 11 },
  { code: 'Witness', name: 'Martor', sortOrder: 20 },
  { code: 'Expert', name: 'Expert', sortOrder: 21 },
  { code: 'Court', name: 'Instanță', sortOrder: 22 },
  { code: 'Prosecutor', name: 'Procuror', sortOrder: 23 },
  { code: 'Intervenient', name: 'Intervenient', sortOrder: 30 },
  { code: 'Mandatar', name: 'Mandatar', sortOrder: 5 },
  { code: 'LegalRepresentative', name: 'Reprezentant Legal', sortOrder: 6 },
  { code: 'Bailiff', name: 'Executor Judecătoresc', sortOrder: 24 },
  { code: 'Notary', name: 'Notar', sortOrder: 25 },
  { code: 'Other', name: 'Altele', sortOrder: 100 },
];
```

## Implementation

1. Create actor-type.graphql with types, queries, mutations
2. Create actor-type.resolvers.ts following case-type pattern
3. Merge built-in roles (from BUILTIN_ACTOR_TYPES) with custom ActorTypeConfig records
4. Partner-only mutations with requirePartner() guard
5. Code uniqueness validation per firm
6. Register in server.ts and schema/index.ts

## Done When

- [x] actor-type.graphql created with types, queries, mutations
- [x] actor-type.resolvers.ts with Partner-only mutation guards
- [x] Built-in roles returned with `isBuiltIn: true` flag
- [x] Custom types merged into query results, sorted by sortOrder
- [x] Registered in server.ts and schema/index.ts
- [x] Code uniqueness validation per firm
- [x] Cannot update/deactivate built-in types

## Files to Modify

- `services/gateway/src/graphql/schema/actor-type.graphql` - New file
- `services/gateway/src/graphql/resolvers/actor-type.resolvers.ts` - New file
- `services/gateway/src/graphql/schema/index.ts` - Register schema
- `services/gateway/src/graphql/server.ts` - Register resolvers

## Dependencies

- OPS-220 (ActorTypeConfig model must exist)

## Resolution

**Completed 2025-12-25**

Implemented as specified:

1. Created `actor-type.graphql` with `ActorType` and `ActorTypeConfig` types
2. Created `actor-type.resolvers.ts` with Partner-only mutation guards
3. Merged built-in CaseActorRole enum values with custom ActorTypeConfig records
4. All 13 built-in roles returned with `isBuiltIn: true` flag
5. Code uniqueness validation prevents conflicts with built-in or existing codes
6. Cannot update/deactivate built-in types (returns FORBIDDEN error)

Also fixed missing schema fields from OPS-187, OPS-195, OPS-220 (not properly applied):

- Added `ActorTypeConfig` model to schema.prisma
- Added `PersonalContact` model to schema.prisma
- Added `isPrivate`, `markedPrivateAt`, `markedPrivateBy` fields to Email
- Added `needsConfirmation`, `isConfirmed`, `confirmedAt`, `confirmedBy` to EmailCaseLink
- Added `CONFIRMED`, `MANUAL_REASSIGN` to ClassificationAction enum
- Added `customRoleCode` field to CaseActor

## Epic

Court Case Number + Dynamic Actor Types (OPS-218 to OPS-223)
