# OPS-141: MessageView Preview Actions

**Status**: Closed
**Type**: Feature
**Priority**: P3-Low
**Complexity**: S (Small)
**Created**: 2024-12-24
**Closed**: 2024-12-24

## Context

Part of the Context-Aware Document Preview Actions epic. Integration for MessageView component's fallback modal preview path.

## Problem

MessageView.tsx has a fallback modal path for attachment preview (when used standalone outside ConversationView). This path should have the same context actions as AttachmentPreviewPanel for consistency.

## Solution Implemented

1. Confirmed DocumentPreviewModal IS used as fallback in MessageView.tsx
2. Added `usePreviewActions` hook for 'email-attachment' context
3. Added action handler for save-to-documents, mark-irrelevant, and add-to-mapa actions
4. Passed context, actions, userRole, and onAction props to DocumentPreviewModal

## Implementation Details

### Changes to MessageView.tsx

1. **New imports**:
   - `usePreviewActions` hook from `@/hooks/usePreviewActions`
   - `UserRole` type from `@legal-platform/types`
   - Notification store for action feedback

2. **New GraphQL mutations**:
   - `SAVE_ATTACHMENT_AS_DOCUMENT` - saves attachment to case documents
   - `MARK_ATTACHMENT_IRRELEVANT` - marks attachment as irrelevant

3. **Message component props extended**:
   - `caseId?: string` - required for save-to-documents action
   - `userRole?: UserRole` - for role-based action filtering

4. **New handler `handlePreviewAction`**:
   - Handles 'save-to-documents' - saves attachment to case documents folder
   - Handles 'mark-irrelevant' - marks attachment as irrelevant and closes modal
   - Handles 'add-to-mapa' - placeholder for future mapa integration

5. **Modal updated with action props**:
   ```tsx
   <DocumentPreviewModal
     isOpen={!!previewDocument}
     onClose={() => setPreviewDocument(null)}
     document={previewDocument}
     onRequestPreviewUrl={handleRequestPreviewUrl}
     context={caseId ? 'email-attachment' : undefined}
     actions={previewActions}
     userRole={userRole}
     onAction={handlePreviewAction}
   />
   ```

## Done

- [x] Code review confirmed modal usage pattern in MessageView
- [x] Context and actions integrated (same as OPS-140)
- [x] Decision documented in code comments

## Files Modified

- `apps/web/src/components/communication/MessageView.tsx`

## Dependencies

- **Blocks**: None
- **Blocked by**:
  - ~~OPS-135 (save mutation)~~ ✅ Resolved
  - ~~OPS-136 (irrelevant mutation)~~ ✅ Closed
  - ~~OPS-137 (toolbar)~~ ✅ Closed
  - ~~OPS-138 (role filtering)~~ ✅ Closed

## Epic

Context-Aware Document Preview Actions (Phase 3 - Integration) - COMPLETED
