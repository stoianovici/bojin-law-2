# OPS-108: Document Upload to SharePoint

| Field        | Value                                    |
| ------------ | ---------------------------------------- |
| **Status**   | Fixing                                   |
| **Type**     | Feature                                  |
| **Priority** | P1-High                                  |
| **Created**  | 2025-12-22                               |
| **Sessions** | 2                                        |
| **Blocked**  | OPS-105 ✅, OPS-106 ✅, OPS-107 ✅       |
| **Blocks**   | OPS-110 (migration needs upload working) |

## Description

Update the document upload flow to store new documents in SharePoint instead of personal OneDrive. This is the critical path for fixing the preview permission issue.

## Current Flow (OneDrive)

```
User uploads → oneDriveService.uploadDocument() → /me/drive/items/
                                                → stores oneDriveId in DB
```

## New Flow (SharePoint)

```
User uploads → sharePointService.uploadDocument() → /sites/{siteId}/drive/items/
                                                  → stores sharePointItemId in DB
                                                  → sets storageType = SHAREPOINT
```

## Implementation

### Update Upload Mutation

```typescript
// document.resolvers.ts - uploadDocumentToCase mutation

// 1. Get case number for folder path
const caseObj = await prisma.case.findUnique({ where: { id: caseId } });
const folderPath = `Cases/${caseObj.caseNumber}`;

// 2. Ensure case folder exists in SharePoint
await sharePointService.ensureCaseFolder(accessToken, caseObj.caseNumber);

// 3. Upload to SharePoint
const spItem = await sharePointService.uploadDocument(
  accessToken,
  folderPath,
  fileName,
  fileBuffer
);

// 4. Create database record
const document = await prisma.document.create({
  data: {
    fileName,
    fileType: mimeType,
    fileSize,
    storageType: 'SHAREPOINT',
    sharePointItemId: spItem.id,
    sharePointPath: spItem.webUrl,
    // Don't set oneDriveId/oneDrivePath for new uploads
    caseId,
    uploadedById: userId,
    firmId,
  },
});
```

### Folder Structure in SharePoint

```
/Cases/
  /123-2024/
    /contract.pdf
    /amendment.docx
  /124-2024/
    /petition.pdf
```

## Files Affected

**Modified:**

- `services/gateway/src/graphql/resolvers/document.resolvers.ts` - upload mutation
- `packages/database/prisma/schema.prisma` - add storageType, sharePointItemId, sharePointPath

## Database Schema Changes

```prisma
model Document {
  // Existing fields...

  // Storage type
  storageType       String    @default("ONEDRIVE") // ONEDRIVE, SHAREPOINT, R2

  // SharePoint fields
  sharePointItemId  String?
  sharePointPath    String?

  // Keep OneDrive fields for migration period
  oneDriveId        String?
  oneDrivePath      String?
  oneDriveUserId    String?
}
```

## Acceptance Criteria

1. New document uploads go to SharePoint site
2. Case folder is created automatically if doesn't exist
3. Database stores `sharePointItemId` and `storageType = SHAREPOINT`
4. Old OneDrive uploads continue to work (backward compatible)
5. Upload mutation returns document with correct storage type

## Local Verification Status

| Step           | Status     | Notes                                               |
| -------------- | ---------- | --------------------------------------------------- |
| Prod data test | ✅ Passed  | Uploaded test file, shows "SharePoint" storage type |
| Preflight      | ⬜ Pending | Need to run pnpm preflight:full                     |
| Docker test    | ⬜ Pending |                                                     |

**Verified**: Partial - Step 1 complete

## Session Log

- [2025-12-22] Issue created as part of SharePoint migration epic.
- [2025-12-22] Session 2 started. Dependencies OPS-105/106/107 are complete. SharePoint service and schema ready.
- [2025-12-22] Implemented `uploadDocumentToSharePoint` mutation:
  - Added GraphQL schema in `document.graphql`
  - Added resolver in `document.resolvers.ts`
  - Uses existing `sharePointService.uploadDocument()` from OPS-106
  - Stores `sharePointItemId` and `sharePointPath` in database
  - TypeScript compiles (only pre-existing errors in email.resolvers.ts)
- [2025-12-22] Updated frontend to use SharePoint:
  - Modified `useDocumentUpload.ts` to use `uploadDocumentToSharePoint` mutation
  - Updated response interface with SharePoint fields
- [2025-12-22] ✅ Local verification (Step 1) passed:
  - Uploaded test file via UI
  - Document shows "SharePoint" storage type in list view
  - Screenshot saved: `.playwright-mcp/sharepoint-upload-success.png`
