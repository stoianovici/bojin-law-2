# OPS-116: Event Emission Infrastructure

## Summary

Emit `UserActivityEvent` records from all relevant mutations (emails, documents, tasks, calendar) to power the AI context system and notifications.

## Problem

Currently, there's no centralized way to track "what happened" for a user. Each system operates independently:

- Email sync happens silently
- Document uploads don't trigger notifications
- Task assignments don't record events
- No way to query "what's new since yesterday"

## Solution

Add event emission hooks to all relevant mutations, creating `UserActivityEvent` records that can be:

1. Queried for "what's new" features
2. Processed by notification engine
3. Used to invalidate context caches

## Architecture

```
Mutation (email sync, doc upload, etc.)
    │
    ├── Execute business logic
    │
    └── Emit UserActivityEvent
            │
            ├── Write to DB
            │
            └── Publish to event bus (optional, for real-time)
                    │
                    ├── Notification Engine (OPS-120)
                    └── Context Invalidation
```

## Implementation Plan

### 1. Event Emitter Service

```typescript
// services/gateway/src/services/activity-event.service.ts

export class ActivityEventService {
  /**
   * Emit an activity event for a user
   */
  async emit(event: EmitEventInput): Promise<UserActivityEvent> {
    const importance = this.calculateImportance(event);

    return prisma.userActivityEvent.create({
      data: {
        userId: event.userId,
        firmId: event.firmId,
        eventType: event.eventType,
        entityType: event.entityType,
        entityId: event.entityId,
        entityTitle: event.entityTitle,
        metadata: event.metadata,
        importance,
        occurredAt: event.occurredAt ?? new Date(),
      },
    });
  }

  /**
   * Emit events for multiple users (e.g., shared document)
   */
  async emitForUsers(userIds: string[], event: Omit<EmitEventInput, 'userId'>): Promise<void> {
    await prisma.userActivityEvent.createMany({
      data: userIds.map((userId) => ({
        userId,
        ...event,
        importance: this.calculateImportance(event),
        occurredAt: event.occurredAt ?? new Date(),
      })),
    });
  }

  /**
   * Mark events as notified
   */
  async markNotified(eventIds: string[]): Promise<void> {
    await prisma.userActivityEvent.updateMany({
      where: { id: { in: eventIds } },
      data: { notified: true },
    });
  }

  /**
   * Mark events as seen
   */
  async markSeen(userId: string, beforeDate: Date): Promise<void> {
    await prisma.userActivityEvent.updateMany({
      where: { userId, occurredAt: { lte: beforeDate }, seenAt: null },
      data: { seenAt: new Date() },
    });
  }

  /**
   * Get unnotified events for a user
   */
  async getUnnotified(
    userId: string,
    options?: {
      minImportance?: EventImportance;
      limit?: number;
    }
  ): Promise<UserActivityEvent[]> {
    return prisma.userActivityEvent.findMany({
      where: {
        userId,
        notified: false,
        importance: options?.minImportance
          ? { in: this.importanceAtOrAbove(options.minImportance) }
          : undefined,
      },
      orderBy: [{ importance: 'desc' }, { occurredAt: 'desc' }],
      take: options?.limit ?? 50,
    });
  }

  private calculateImportance(event: Partial<EmitEventInput>): EventImportance {
    // Court emails are always urgent
    if (event.eventType === 'EMAIL_FROM_COURT') return 'URGENT';

    // Overdue tasks are high importance
    if (event.eventType === 'TASK_OVERDUE') return 'HIGH';

    // Today's deadlines are high
    if (event.eventType === 'TASK_DUE_TODAY') return 'HIGH';
    if (event.eventType === 'CASE_HEARING_TODAY') return 'URGENT';

    return 'NORMAL';
  }
}

export const activityEventService = new ActivityEventService();
```

### 2. Email Sync Integration

```typescript
// In email-sync.service.ts, after saving new email:

await activityEventService.emit({
  userId: email.userId,
  firmId: email.firmId,
  eventType: this.isCourtEmail(email) ? 'EMAIL_FROM_COURT' : 'EMAIL_RECEIVED',
  entityType: 'EMAIL',
  entityId: email.id,
  entityTitle: email.subject,
  metadata: {
    from: email.from,
    caseIds: email.caseLinks?.map((l) => l.caseId),
  },
});
```

### 3. Document Upload Integration

```typescript
// In document.service.ts, after upload:

await activityEventService.emit({
  userId: context.userId,
  firmId: context.firmId,
  eventType: 'DOCUMENT_UPLOADED',
  entityType: 'DOCUMENT',
  entityId: document.id,
  entityTitle: document.fileName,
  metadata: {
    caseId: document.caseId,
    fileType: document.mimeType,
  },
});
```

### 4. Task Mutations Integration

```typescript
// In task.service.ts

// On task assignment:
await activityEventService.emit({
  userId: task.assignedToId,
  firmId: task.firmId,
  eventType: 'TASK_ASSIGNED',
  entityType: 'TASK',
  entityId: task.id,
  entityTitle: task.title,
  metadata: {
    assignedBy: context.userId,
    caseId: task.caseId,
    dueDate: task.dueDate,
  },
});

// On task completion:
await activityEventService.emit({
  userId: task.assignedToId,
  firmId: task.firmId,
  eventType: 'TASK_COMPLETED',
  entityType: 'TASK',
  entityId: task.id,
  entityTitle: task.title,
});
```

### 5. Scheduled Events (Background Job)

```typescript
// jobs/deadline-events.job.ts
// Runs daily at 6:00 AM

export async function emitDeadlineEvents(): Promise<void> {
  const today = startOfDay(new Date());
  const tomorrow = addDays(today, 1);

  // Tasks due today
  const tasksDueToday = await prisma.task.findMany({
    where: {
      dueDate: { gte: today, lt: tomorrow },
      status: { not: 'Completed' },
    },
  });

  for (const task of tasksDueToday) {
    await activityEventService.emit({
      userId: task.assignedToId,
      firmId: task.firmId,
      eventType: 'TASK_DUE_TODAY',
      entityType: 'TASK',
      entityId: task.id,
      entityTitle: task.title,
    });
  }

  // Overdue tasks (not already marked)
  const overdueTasks = await prisma.task.findMany({
    where: {
      dueDate: { lt: today },
      status: { not: 'Completed' },
    },
  });

  // ... similar for calendar events, case hearings
}
```

## Files to Create/Modify

### New Files

- `services/gateway/src/services/activity-event.service.ts`
- `services/gateway/src/jobs/deadline-events.job.ts`

### Modified Files

- `services/gateway/src/services/email-sync.service.ts`
- `services/gateway/src/services/document.service.ts`
- `services/gateway/src/services/task.service.ts`
- `services/gateway/src/services/calendar.service.ts`
- `services/gateway/src/index.ts` (register cron job)

## Dependencies

- OPS-115: AI Context Files - Data Model (schema must exist)

## Enables

- OPS-117: User Daily Context Service (needs events to compute)
- OPS-120: Notification Engine (processes events)

## Parallelization

Can be worked on in parallel with OPS-117 and OPS-118 after OPS-115 is complete. Each integration point (email, document, task) can be done independently.

## Success Metrics

- [ ] Events emitted for all email syncs
- [ ] Events emitted for document uploads
- [ ] Events emitted for task assignments/completions
- [ ] Daily deadline events generated
- [ ] Events queryable by user and time range

---

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

---

## Session Log

### 2024-12-23 - Session 2: Implementation Complete

- Resuming work, OPS-115 dependency is satisfied (schema in place)
- Created ActivityEventService with emit/query methods
- Integrated event emission into email-sync.service.ts (EMAIL_RECEIVED, EMAIL_FROM_COURT)
- Integrated event emission into task.service.ts (TASK_ASSIGNED, TASK_COMPLETED)
- Integrated event emission into document.resolvers.ts (DOCUMENT_UPLOADED)
- Created deadline-events.worker.ts for scheduled events (TASK_DUE_TODAY, TASK_OVERDUE, CASE_HEARING_TODAY)
- Registered worker in index.ts
- Preflight checks pass ✅

### 2024-12-23 - Session 1: Issue Created

- Created from `/ops-ideate` session exploring AI context optimization
- Part of AI Context Files epic (OPS-115 → OPS-120)
