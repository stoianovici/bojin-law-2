# [OPS-001] Communications page not loading emails

| Field           | Value       |
| --------------- | ----------- |
| **Status**      | Verifying   |
| **Type**        | Bug         |
| **Priority**    | P0-Critical |
| **Created**     | 2025-12-08  |
| **Sessions**    | 9           |
| **Last Active** | 2025-12-10  |

## Description

The /communications page at https://legal-platform-web.onrender.com/communications is not loading actual emails. Console shows Apollo client working, MSAL auth succeeding, and MS access token being included for StartEmailSync - but no emails are displayed.

## Reproduction Steps

1. Navigate to https://legal-platform-web.onrender.com/communications
2. Observe that no emails are loaded
3. Console shows StartEmailSync being called but no email data returned

## Root Cause

**PRIMARY:** Email resolvers are NOT registered in the Apollo GraphQL server. The `emailResolvers` are defined in `services/gateway/src/graphql/resolvers/email.resolvers.ts` but are NOT imported or merged into `services/gateway/src/graphql/server.ts`. This causes all email-related GraphQL queries (emailThreads, emailThread, etc.) to fail silently.

**SECONDARY:** The GraphQL context does not include the MS access token. Even if resolvers were registered, `startEmailSync` would fail because the resolver expects `user.accessToken` but the context only provides `{id, firmId, role, email}`.

**TERTIARY (Session 6):** Redis connection failing - Gateway was connecting to `127.0.0.1:6379` instead of the Render Redis instance (`red-d4dk9fgdl3ps73d3d7i0:6379`). The `ioredis` library requires the URL as the first constructor argument, but the code was passing it as a config property. Additionally, the Dockerfile uses pre-built `dist/` from git rather than compiling TypeScript at build time, so TypeScript source fixes weren't being deployed.

## Fix Applied

**Fix 1: Register emailResolvers in GraphQL server**

- File: `services/gateway/src/graphql/server.ts`
- Added import: `import { emailResolvers } from './resolvers/email.resolvers';`
- Merged `emailResolvers.Query` into Query resolvers
- Merged `emailResolvers.Mutation` into Mutation resolvers
- Added `emailResolvers.Subscription` to Subscription resolvers
- Added type resolvers: `Email`, `EmailThread`, `EmailAttachment`

**Fix 2: Pass MS access token through GraphQL context**

- File: `apps/web/src/lib/apollo-client.ts` - Added auth link to include `x-ms-access-token` header
- File: `apps/web/src/contexts/AuthContext.tsx` - Register token getter with Apollo client
- File: `apps/web/src/app/api/graphql/route.ts` - Forward `x-ms-access-token` header to gateway
- File: `services/gateway/src/graphql/server.ts` - Extract token from header and add to context
- File: `services/gateway/src/graphql/resolvers/case.resolvers.ts` - Updated Context type to include `accessToken`

**Fix 3: Redis URL connection (Session 6)**

- File: `packages/database/src/redis.ts` - Changed ioredis constructor to pass URL as first argument:

  ```typescript
  // BEFORE (incorrect):
  _redis = new Redis({ url: redisUrl, ...redisConfig });

  // AFTER (correct):
  _redis = redisUrl ? new Redis(redisUrl, redisConfig) : new Redis(redisConfig);
  ```

- File: `packages/database/dist/redis.js` - Rebuilt compiled JS to include the fix (Dockerfile uses pre-built dist from git)
- Commits: `3b0a670` (source fix), `9b0c19c` (rebuilt dist)

## Session Log

- [2025-12-08] Issue created. Initial triage identified two critical bugs: (1) emailResolvers not merged into GraphQL server schema, (2) MS access token not passed through context.
- [2025-12-08] Session 2 started. Implemented both fixes: registered emailResolvers in server.ts and set up MS access token pass-through from client to gateway.
- [2025-12-08] Session 3 started. Continuing from: Fixing. Beginning verification of deployed fix.
- [2025-12-08] Session 3 - Found root cause: when user authenticated via session cookie only (no MSAL accounts cached), getAccessToken() returned null. Fixed by: (1) Enhanced getAccessToken to check for any MSAL accounts in browser, (2) Added hasMsalAccount and reconnectMicrosoft to AuthContext, (3) Updated EmailThreadList to show "Connect Microsoft" prompt when MSAL not available.
- [2025-12-08] Session 4 started. Problem persisting after previous fix. Re-investigating.
- [2025-12-08] Session 4 - Found root cause: `hasMsalAccount` was computed once at render time via `hasMsalAccount()` call, not as reactive state. When MSAL init completes with no accounts, the UI still showed "Sync" button because hasMsalAccount was evaluated before MSAL finished initializing. Fixed by: (1) Added `hasMsalAccountState` state variable, (2) Added `updateHasMsalAccount()` function called after MSAL init, (3) Changed context value to use state instead of computed function call.
- [2025-12-08] Session 4 - Second issue found: The `/communications` page was a different component that didn't use `hasMsalAccount`. Updated to show "Conectează Microsoft" button when no MSAL account.
- [2025-12-08] Session 4 - Third issue found: MSAL `loginRequest` scopes did not include `Mail.Read`. User authenticated but had no permission to read emails. Added `Mail.Read` and `Mail.ReadBasic` to scopes.
- [2025-12-09] Session 5 started. Continuing from: Investigating. All fixes deployed and live since ~17:30 UTC yesterday. Verifying fix.
- [2025-12-09] Session 5 - Found root cause: The page was showing "Conectează Microsoft" banner even when emails exist in database. The MSAL token is only needed for SYNC operations, not for viewing already-synced emails. Additionally, clicking connect triggered full OAuth flow causing "Need admin approval" error.
- [2025-12-09] Session 5 - Fixes applied: (1) Simplified communications page to always show sync button, only show connect prompt when no emails exist, (2) Added `prompt: 'select_account'` to MSAL config to avoid consent prompt, (3) Updated `reconnectMicrosoft()` to try SSO first before falling back to redirect.
- [2025-12-09] Session 6 started. Continuing from: Investigating. User reported emails still not syncing despite fixes.
- [2025-12-09] Session 6 - Root cause found: Redis connection error `ECONNREFUSED 127.0.0.1:6379`. The `REDIS_URL` environment variable was set correctly to `redis://red-d4dk9fgdl3ps73d3d7i0:6379` but ioredis wasn't receiving it. Investigation revealed the URL was being passed as a config property instead of as the first constructor argument (ioredis API requirement).
- [2025-12-09] Session 6 - Fix 1: Changed `packages/database/src/redis.ts` to pass URL as first arg: `new Redis(redisUrl, redisConfig)`.
- [2025-12-09] Session 6 - Fix 2: Discovered Dockerfile uses pre-built `dist/` from git. TypeScript fixes weren't being compiled at build time. Rebuilt `packages/database/dist/redis.js` locally and committed.
- [2025-12-09] Session 6 - Deployed commit `9b0c19c`. Gateway now live with Redis URL fix. Awaiting verification that emails sync correctly.
- [2025-12-10] Session 7 started. Continuing from: Verifying. Redis URL fix deployed, verifying email sync functionality.
- [2025-12-10] Session 7 - New root cause found: `TypeError: _this.provider is not a function`. The MS Graph SDK v3 `Client.init()` expects `authProvider` as a callback function `(done) => done(null, token)`, but code was passing a `TokenAuthenticationProvider` class instance.
- [2025-12-10] Session 7 - Fix 1: Changed `graph.service.ts` to use callback pattern: `authProvider: (done) => { done(null, accessToken); }` instead of class instance. Deployed commit `f95121b`.
- [2025-12-10] Session 7 - New error after authProvider fix: `BadRequest: Change tracking is not supported against 'microsoft.graph.message'`. Delta sync (`/me/messages/delta`) is not supported for all mailbox types.
- [2025-12-10] Session 7 - Fix 2: Changed `email-sync.service.ts` to use regular `/me/messages` endpoint instead of delta sync. Deployed commit `b09725e`.
- [2025-12-10] Session 7 - New error: First page fetched 50 messages successfully, but pagination failed with `Resource not found for segment 'v1.0'`. The `nextLink` URL includes `/v1.0` but the client already adds it via `defaultVersion`.
- [2025-12-10] Session 7 - Fix 3: Strip `/v1.0` or `/beta` prefix from `nextLink` path before calling `client.api()`. Deployed commit `fd645fe`.
- [2025-12-10] Session 8 started. Continuing from: Verifying. All pagination fixes deployed, verifying email sync works end-to-end.
- [2025-12-10] Session 8 - New error found: "Cannot return null for non-nullable field Email.conversationId". Emails synced successfully (50 emails) but display failed.
- [2025-12-10] Session 8 - Root cause: Some MS Graph emails have null conversationId (system messages, connector messages). GraphQL schema defined `conversationId: String!` (non-nullable).
- [2025-12-10] Session 8 - Fix 1: Made conversationId nullable in GraphQL schema, added resolver fallback, skip null conversationIds in thread grouping. Deployed commit `e7a748f`.
- [2025-12-10] Session 8 - New error: `RangeError: Invalid time value` when formatting dates in ThreadList component.
- [2025-12-10] Session 8 - Root cause: Date objects serialized to localStorage as ISO strings. When restored, the store's sort function called `.getTime()` on strings instead of Date objects.
- [2025-12-10] Session 8 - Fix 2: Made ThreadList validate dates before formatting, updated store's sort function to handle both Date objects and ISO strings. Deployed commit `d02bd9f`.
- [2025-12-10] Session 9 started. Continuing from: Verifying. All Session 8 fixes deployed, verifying email display works end-to-end.
- [2025-12-10] Session 9 - RangeError still occurring in production. Set up local dev environment to test fixes.
- [2025-12-10] Session 9 - Root cause found: Field name mismatch in communications/page.tsx. Code set `sentAt` but `CommunicationMessage` type expects `sentDate`. This caused `message.sentDate` to be undefined in MessageView.tsx.
- [2025-12-10] Session 9 - Fix 1: Changed `sentAt` to `sentDate` in page transformation, added date fallback. Deployed commit `f5f9541`.
- [2025-12-10] Session 9 - Additional issue: Email body showing raw HTML instead of rendered content. Thread list preview also showing HTML tags.
- [2025-12-10] Session 9 - Fix 2: MessageView now renders HTML emails in sandboxed iframe with auto-resize. ThreadList strips HTML tags from preview. Deployed commit `dd4cb87`.

## Files Involved

- `services/gateway/src/graphql/server.ts` - **FIXED** - Added emailResolvers import/merge + token extraction
- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - **FIXED (Session 8)** - Added conversationId resolver fallback
- `services/gateway/src/graphql/schema/email.graphql` - **FIXED (Session 8)** - Made conversationId nullable
- `services/gateway/src/services/email-thread.service.ts` - **FIXED (Session 8)** - Skip emails without conversationId in threading
- `apps/web/src/components/communication/ThreadList.tsx` - **FIXED (Session 9)** - Validate dates, strip HTML from preview
- `apps/web/src/stores/communication.store.ts` - **FIXED (Session 8)** - Handle Date objects and ISO strings in sort
- `services/gateway/src/graphql/resolvers/case.resolvers.ts` - **FIXED** - Added accessToken to Context type
- `apps/web/src/lib/apollo-client.ts` - **FIXED v16** - Added auth link for MS token, version bump
- `apps/web/src/lib/msal-config.ts` - **FIXED** - Added Mail.Read scope to loginRequest
- `apps/web/src/contexts/AuthContext.tsx` - **FIXED v3** - Made hasMsalAccount reactive state instead of computed function
- `apps/web/src/app/api/graphql/route.ts` - **FIXED** - Forward x-ms-access-token header
- `apps/web/src/hooks/useEmailSync.ts` - Frontend email hooks/queries
- `apps/web/src/components/email/EmailThreadList.tsx` - **FIXED** - Added "Connect Microsoft" prompt when MSAL not available
- `apps/web/src/app/communications/page.tsx` - **FIXED (Session 9)** - Fixed sentAt→sentDate field mismatch, added date fallback
- `apps/web/src/components/communication/MessageView.tsx` - **FIXED (Session 9)** - Render HTML in sandboxed iframe, validate dates
- `packages/database/src/redis.ts` - **FIXED (Session 6)** - Pass REDIS_URL as first constructor arg to ioredis
- `packages/database/dist/redis.js` - **FIXED (Session 6)** - Rebuilt compiled JS (Dockerfile uses pre-built dist)
- `services/gateway/src/services/graph.service.ts` - **FIXED (Session 7)** - Use callback pattern for authProvider
- `services/gateway/src/services/email-sync.service.ts` - **FIXED (Session 7)** - Use regular messages endpoint instead of delta sync
