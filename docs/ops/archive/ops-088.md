# OPS-088: Cmd+K Command Palette with cmdk Library

| Field           | Value      |
| --------------- | ---------- |
| **Status**      | Open       |
| **Type**        | Feature    |
| **Priority**    | P2-Medium  |
| **Created**     | 2025-12-21 |
| **Sessions**    | 2          |
| **Last Active** | 2025-12-21 |

## Description

Implement a unified command palette using the `cmdk` library (used by Vercel, Linear, Raycast) that combines quick navigation, commands, and live search results in one cohesive interface triggered by Cmd+K.

### Current State

The codebase has **two separate implementations** that don't work together:

1. **GlobalSearchBar** (`apps/web/src/components/search/GlobalSearchBar.tsx`)
   - Has Cmd+K keyboard shortcut
   - Shows recent searches dropdown
   - Does NOT show live search results as you type
   - Navigates to `/search?q=...` page on Enter

2. **CommandPalette** (`apps/web/src/components/layout/CommandPalette.tsx`)
   - Modal with 7 hardcoded commands
   - Has internal keyboard navigation (arrows, Enter, Escape)
   - NO keyboard shortcut to open it (the Cmd+K handler is missing)
   - State in `navigation.store.ts` but never triggered

3. **SearchResults** (`apps/web/src/components/search/SearchResults.tsx`)
   - Full search page with filters
   - `useSearch` hook with GraphQL queries
   - Supports Cases, Documents, Clients

### Desired Outcome

A single command palette that:

- Opens with Cmd+K (or Ctrl+K on Windows)
- Shows quick commands (navigation, actions)
- Shows live search results as user types (debounced)
- Results are clickable and navigate to the item
- Groups results by type (Cases, Documents, Clients)
- Keyboard navigable (arrow keys, Enter to select, Escape to close)
- Accessible (ARIA, focus management)

## Implementation Plan

### Phase 1: Install and Setup cmdk

1. Install `cmdk` package
2. Create base `CommandMenu` component with Radix Dialog wrapper
3. Wire up Cmd+K keyboard shortcut globally
4. Replace/remove existing CommandPalette and GlobalSearchBar

### Phase 2: Static Commands

1. Add navigation commands (Dashboard, Cases, Documents, Tasks)
2. Add action commands (Create Case, Create Document, Add Task)
3. Style with Tailwind to match existing design system
4. Romanian labels for UI text

### Phase 3: Live Search Integration

1. Integrate `useSearch` hook with debounced input
2. Display search results grouped by type
3. Show loading state while searching
4. Limit to 5 results per category with "See all" link
5. Highlight search terms in results

### Phase 4: Polish

1. Recent searches section
2. Empty state messaging
3. Keyboard shortcut hints in footer
4. Accessibility testing
5. E2E tests

## Technical Notes

### cmdk Library Benefits

- Battle-tested (Vercel, Linear, Raycast use it)
- Built-in keyboard navigation
- Composable Command.Group, Command.Item components
- Accessible by default
- Supports mixing static commands and dynamic search

### Files to Create/Modify

**New Files:**

- `apps/web/src/components/command/CommandMenu.tsx` - Main component
- `apps/web/src/components/command/CommandMenu.test.tsx` - Tests
- `apps/web/src/components/command/index.ts` - Exports

**Files to Modify:**

- `apps/web/package.json` - Add cmdk dependency
- `apps/web/src/components/layout/MainLayout.tsx` - Add CommandMenu, remove old
- `apps/web/src/components/layout/TopBar.tsx` - Update Cmd+K hint, remove GlobalSearchBar

**Files to Remove:**

- `apps/web/src/components/layout/CommandPalette.tsx`
- `apps/web/src/components/layout/CommandPalette.test.tsx`
- `apps/web/src/components/search/GlobalSearchBar.tsx`
- `apps/web/src/components/search/GlobalSearchBar.test.tsx`

### Conventions to Follow

- Use `'use client'` directive
- Use `clsx` for conditional classes
- Romanian UI labels (e.g., "Căutare", "Dosare", "Documente")
- Use existing color scheme (blue for cases, green for docs, purple for clients)
- Co-locate tests with component
- Add `displayName` to component

## Acceptance Criteria

- [ ] Cmd+K opens command palette from anywhere in the app
- [ ] Static navigation commands work (Dashboard, Cases, Documents, Tasks)
- [ ] Typing shows live search results with debounce
- [ ] Results are grouped by type with icons
- [ ] Clicking a result navigates to that item
- [ ] Keyboard navigation works (up/down arrows, Enter, Escape)
- [ ] Recent searches are shown when palette opens
- [ ] Loading state shown while searching
- [ ] "No results" state is clear
- [ ] Accessible (screen reader, focus management)
- [ ] All tests pass
- [ ] Romanian UI text

## Environment Strategy

| Mode                   | Command                        | Use When                |
| ---------------------- | ------------------------------ | ----------------------- |
| Local dev (default)    | `pnpm dev`                     | Feature development     |
| Production data        | `source .env.prod && pnpm dev` | Testing with real data  |
| Production-like Docker | `pnpm preview`                 | Pre-deploy verification |
| Full parity check      | `pnpm preflight:full`          | Before any deployment   |

**Recommended for this issue**: Local dev for building, production data for testing search results

## Local Verification Status

| Step           | Status    | Date       | Notes                                         |
| -------------- | --------- | ---------- | --------------------------------------------- |
| Prod data test | ✅ Passed | 2025-12-21 | Tested with Playwright MCP - navigation works |
| Preflight      | ✅ Passed | 2025-12-21 | 6 passed, 2 warnings (non-blocking)           |
| Docker test    | ✅ Passed | 2025-12-21 | Both web and gateway Docker builds succeeded  |

**Verified**: Yes

> ⚠️ Issue cannot be closed until all three steps are ✅

## Session Log

- [2025-12-21] Issue created from /ops-ideate session. Explored 4 angles, selected cmdk library approach (Angle 3) for its battle-tested reliability and built-in accessibility. Initial triage identified current dual-implementation problem (GlobalSearchBar + CommandPalette not integrated).
- [2025-12-21] Session 2 started. Continuing from: Open (ready to implement)
- [2025-12-21] Session 2: Implemented CommandMenu component with cmdk library. Added all navigation commands (Dashboard, Cases, Documents, Tasks, Communications, Time tracking, Reports) and action commands (New case, New document, New task, Settings). Integrated useSearch hook with debounced input. Updated MainLayout and TopBar. All 15 unit tests passing. Verified with Playwright MCP - Cmd+K opens palette, keyboard navigation works, command selection navigates correctly.

## References

- cmdk library: https://cmdk.paco.me/
- Current GlobalSearchBar: `apps/web/src/components/search/GlobalSearchBar.tsx`
- Current CommandPalette: `apps/web/src/components/layout/CommandPalette.tsx`
- useSearch hook: `apps/web/src/hooks/useSearch.ts`
- SearchResults component: `apps/web/src/components/search/SearchResults.tsx`
