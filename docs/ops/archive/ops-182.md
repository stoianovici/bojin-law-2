# OPS-182: Lazy Version Sync on Document Access

**Type**: Feature
**Priority**: P1-High
**Status**: Complete
**Epic**: Frictionless SharePoint-First Document Editing

## Problem

After editing in Word, user must manually trigger sync. Versions aren't created automatically. The app doesn't pick up changes made in Word.

## Solution

Create `syncFromSharePointIfChanged()` service method that:

1. Compares current SharePoint state with stored baseline
2. If changed: downloads content, creates DocumentVersion, updates R2 backup

Integrate checks at key access points:

- On `closeWordSession` - always check before releasing lock
- On `documentPreviewUrl` query - check before returning preview
- New `syncDocumentFromSharePoint` mutation for explicit sync

## Implementation

### New Service Method

```typescript
/**
 * Check if document changed in SharePoint and sync if needed
 * Creates new DocumentVersion if changes detected
 */
async syncFromSharePointIfChanged(
  documentId: string,
  accessToken: string,
  userId: string
): Promise<{ synced: boolean; newVersion?: number }> {
  const document = await prisma.document.findUnique({
    where: { id: documentId },
    select: {
      id: true,
      sharePointItemId: true,
      sharePointLastModified: true,
      storagePath: true,
      fileName: true,
    },
  });

  if (!document?.sharePointItemId) {
    return { synced: false };
  }

  // Check for changes
  const { changed, currentMetadata } = await sharePointService.checkForChanges(
    accessToken,
    document.sharePointItemId,
    document.sharePointLastModified?.toISOString() || ''
  );

  if (!changed || !currentMetadata) {
    return { synced: false };
  }

  // Download updated content from SharePoint
  const content = await sharePointService.downloadDocument(
    accessToken,
    document.sharePointItemId
  );

  // Update R2 backup
  await r2StorageService.uploadDocument(document.storagePath, content);

  // Get latest version number
  const latestVersion = await prisma.documentVersion.findFirst({
    where: { documentId },
    orderBy: { versionNumber: 'desc' },
  });

  // Create new version
  const newVersion = await prisma.documentVersion.create({
    data: {
      documentId,
      versionNumber: (latestVersion?.versionNumber || 0) + 1,
      createdById: userId,
      changesSummary: 'Editat în Microsoft Word',
    },
  });

  // Update document with new SharePoint timestamp
  await prisma.document.update({
    where: { id: documentId },
    data: {
      sharePointLastModified: new Date(currentMetadata.lastModifiedDateTime),
      sharePointETag: currentMetadata.eTag,
      updatedAt: new Date(),
    },
  });

  // Clean up edit session
  await prisma.documentEditSession.deleteMany({
    where: { documentId },
  });

  logger.info('Document synced from SharePoint', {
    documentId,
    newVersionNumber: newVersion.versionNumber,
  });

  return { synced: true, newVersion: newVersion.versionNumber };
}
```

### Integration Points

1. **closeWordSession mutation**:

```typescript
async closeWordSession(documentId: string, lockToken: string, accessToken: string, userId: string) {
  // Sync before releasing lock
  const syncResult = await this.syncFromSharePointIfChanged(documentId, accessToken, userId);

  // Release lock
  await this.releaseDocumentLock(documentId, userId);

  return {
    updated: syncResult.synced,
    newVersionNumber: syncResult.newVersion,
  };
}
```

2. **documentPreviewUrl query** (in resolver):

```typescript
// Before returning preview URL, check for changes
await wordIntegrationService.syncFromSharePointIfChanged(documentId, accessToken, userId);
// Then return preview URL as normal
```

3. **New mutation** for explicit sync:

```graphql
extend type Mutation {
  syncDocumentFromSharePoint(documentId: UUID!): SyncResult!
}
```

## Files to Modify

- `services/gateway/src/services/word-integration.service.ts`
- `services/gateway/src/graphql/resolvers/document.resolvers.ts`
- `services/gateway/src/graphql/resolvers/word-integration.resolvers.ts`
- `services/gateway/src/graphql/schema/document.graphql`

## Done When

- [x] `syncFromSharePointIfChanged()` method created
- [x] Called on `closeWordSession` before lock release
- [ ] Called before preview URL generation (lazy sync) - deferred to OPS-183
- [x] New version created when changes detected
- [x] R2 backup updated with new content
- [x] `DocumentVersion.changesSummary` set to Romanian text
- [x] Edit session cleaned up after sync
- [x] New `syncDocumentFromSharePoint` mutation available

## Dependencies

- OPS-178: SharePoint Edit Session Schema ✅
- OPS-179: SharePoint Change Detection Methods ✅
- OPS-180: SharePoint Document Download Method ✅

## Blocked By

- OPS-178, OPS-179, OPS-180 (all complete)

## Parallel With

- OPS-181: SharePoint-First openInWord Flow ✅

## Implementation Notes (2024-12-24)

### Service Methods Added

**`WordIntegrationService.syncFromSharePointIfChanged()`** (word-integration.service.ts:463-561):

- Checks if document has `sharePointItemId` (skips if not)
- Compares `sharePointLastModified` with current SharePoint timestamp
- If changed:
  - Downloads content from SharePoint
  - Updates R2 backup
  - Creates new `DocumentVersion` with `changesSummary: 'Editat în Microsoft Word'`
  - Updates document's `sharePointLastModified`
  - Cleans up `DocumentEditSession`

**`WordIntegrationService.closeWordSession()`** (word-integration.service.ts:573-607):

- Verifies lock token ownership
- Calls `syncFromSharePointIfChanged()` before releasing lock
- Releases the document lock
- Returns sync result

### GraphQL Changes

**Schema** (word-integration.graphql):

- Added `SharePointSyncResult` type
- Added `syncDocumentFromSharePoint(documentId: UUID!): SharePointSyncResult!` mutation

**Resolvers** (word-integration.resolvers.ts):

- `closeWordSession` - Syncs from SharePoint before releasing lock
- `syncDocumentFromSharePoint` - Explicit sync mutation for manual trigger

### Notes

- Preview URL lazy sync deferred to OPS-183 (Frontend Auto-Sync Integration)
- The `createdBy` field on DocumentVersion expects a relation connect, not direct ID (linter fixed this)
