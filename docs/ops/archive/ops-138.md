# OPS-138: Role-Based Action Filtering System

**Status**: Closed
**Type**: Feature
**Priority**: P2-Medium
**Complexity**: S (Small)
**Created**: 2024-12-24

## Context

Part of the Context-Aware Document Preview Actions epic. Ensures certain actions are only visible to users with appropriate roles.

## Problem

Certain actions should only be visible to specific roles:

- **Delete** action → Partners only
- **Link to other case** → Partners and Associates
- **Rename** → Partners and Associates

Need a system to filter actions based on current user's role before rendering.

## Solution

Create a hook `usePreviewActions` that:

1. Gets actions for a context (or accepts custom actions)
2. Filters by current user's role
3. Returns filtered action list ready for rendering

## Implementation

### Hook Implementation

```typescript
// apps/web/src/hooks/usePreviewActions.ts

import { useAuth } from '@/hooks/useAuth';
import {
  PreviewAction,
  PreviewContext,
  DEFAULT_PREVIEW_ACTIONS,
} from '@legal-platform/shared/types';

/**
 * Filter actions based on user role
 */
function filterActionsByRole(actions: PreviewAction[], userRole: UserRole): PreviewAction[] {
  return actions.filter((action) => {
    // If no roles specified, action is available to all
    if (!action.roles || action.roles.length === 0) {
      return true;
    }
    // Check if user's role is in allowed roles
    return action.roles.includes(userRole);
  });
}

/**
 * Hook to get filtered preview actions for a context
 *
 * @param context - Preview context type
 * @param customActions - Optional custom actions (overrides defaults)
 * @returns Filtered actions based on user role
 */
export function usePreviewActions(
  context?: PreviewContext,
  customActions?: PreviewAction[]
): PreviewAction[] {
  const { user } = useAuth();

  return useMemo(() => {
    // Determine base actions
    const baseActions = customActions ?? (context ? DEFAULT_PREVIEW_ACTIONS[context] : []);

    // If no user (shouldn't happen), return empty
    if (!user?.role) {
      return [];
    }

    // Filter by role
    return filterActionsByRole(baseActions, user.role);
  }, [context, customActions, user?.role]);
}
```

### Role Requirements Matrix

| Action ID          | Label                 | Required Roles     |
| ------------------ | --------------------- | ------------------ |
| `add-to-mapa`      | Adaugă în mapă        | All                |
| `download`         | Descarcă              | All                |
| `save-to-docs`     | Salvează în documente | All                |
| `mark-irrelevant`  | Marchează irelevant   | All                |
| `rename`           | Redenumește           | Partner, Associate |
| `move`             | Mută în folder        | Partner, Associate |
| `link`             | Leagă de alt dosar    | Partner, Associate |
| `delete`           | Șterge                | Partner            |
| `replace`          | Înlocuiește           | Partner, Associate |
| `remove-from-slot` | Elimină din slot      | Partner, Associate |

### Usage Example

```tsx
// In DocumentsContentPanel.tsx

function DocumentsContentPanel({ caseId }) {
  const actions = usePreviewActions('case-documents');

  const handleAction = useCallback((actionId: string, doc: PreviewableDocument) => {
    switch (actionId) {
      case 'add-to-mapa':
        setMapaAssignDoc(doc);
        break;
      case 'download':
        handleDownload(doc);
        break;
      // ... other handlers
    }
  }, []);

  return <DocumentPreviewModal document={selectedDoc} actions={actions} onAction={handleAction} />;
}
```

## Done When

- [x] New hook created: `apps/web/src/hooks/usePreviewActions.ts`
- [x] `filterActionsByRole()` correctly filters based on role array
- [x] Hook integrates with existing `useAuth()` hook
- [x] Returns empty array if user not authenticated
- [x] Supports both context-based and custom actions
- [x] Role requirements documented in OPS-134 type definitions
- [x] Exported from hooks index if one exists (not needed - direct imports work)

## Files

- `apps/web/src/hooks/usePreviewActions.ts` (new)

## Dependencies

- **Blocks**: OPS-139, OPS-140, OPS-141
- **Blocked by**: OPS-134 (types)

## Epic

Context-Aware Document Preview Actions (Phase 2 - UI Components)
