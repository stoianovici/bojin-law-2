# OPS-115: AI Context Files - Data Model

## Summary

Create the foundational data model for AI context files: user activity events, user daily context, and case briefings. This enables faster AI responses and proactive notifications.

## Problem

The AI assistant currently:

1. Has minimal upfront context (~200 tokens)
2. Must call 2-4 tools to answer basic questions (1-2s latency each)
3. Cannot track "what's new" since last interaction
4. Cannot send proactive notifications (no state to track)

## Solution

Event-sourced user state + pre-computed context files:

- **UserActivityEvent**: Track all relevant events (emails, documents, tasks)
- **UserDailyContext**: Derived state for quick AI access
- **CaseBriefing**: Per-case summaries for case-context conversations

## Schema Design

### UserActivityEvent

Tracks all events relevant to a user for notifications and "what's new" queries.

```prisma
model UserActivityEvent {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  firmId      String
  firm        Firm     @relation(fields: [firmId], references: [id])

  // Event details
  eventType   ActivityEventType
  entityType  EntityType
  entityId    String
  entityTitle String?              // Denormalized for quick display

  // Metadata
  metadata    Json?                // Event-specific data
  importance  EventImportance      @default(NORMAL)

  // State tracking
  notified    Boolean  @default(false)
  seenAt      DateTime?

  // Timestamps
  occurredAt  DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([userId, notified, occurredAt])
  @@index([userId, eventType, occurredAt])
  @@index([firmId, occurredAt])
}

enum ActivityEventType {
  // Email events
  EMAIL_RECEIVED
  EMAIL_CLASSIFIED
  EMAIL_FROM_COURT          // High importance

  // Document events
  DOCUMENT_UPLOADED
  DOCUMENT_SHARED

  // Task events
  TASK_ASSIGNED
  TASK_DUE_TODAY
  TASK_OVERDUE
  TASK_COMPLETED

  // Case events
  CASE_DEADLINE_APPROACHING
  CASE_HEARING_TODAY
  CASE_STATUS_CHANGED

  // Calendar events
  CALENDAR_EVENT_TODAY
  CALENDAR_EVENT_REMINDER
}

enum EntityType {
  EMAIL
  DOCUMENT
  TASK
  CASE
  CALENDAR_EVENT
}

enum EventImportance {
  LOW
  NORMAL
  HIGH
  URGENT
}
```

### UserDailyContext

Pre-computed daily snapshot for fast AI access.

```prisma
model UserDailyContext {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  firmId      String

  // Computed state (JSON for flexibility)
  contextData Json                 // See ContextData type below

  // Tracking
  lastComputedAt    DateTime
  lastBriefingAt    DateTime?      // When user last got morning briefing
  lastSeenEventId   String?        // Watermark for "what's new"

  // Cache control
  validUntil        DateTime       // Soft expiry

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([validUntil])
}
```

**ContextData TypeScript interface:**

```typescript
interface UserContextData {
  // Summary counts
  newEmailsCount: number;
  newDocumentsCount: number;
  pendingTasksCount: number;
  overdueTasksCount: number;

  // Today's schedule
  todayEvents: {
    id: string;
    type: 'hearing' | 'meeting' | 'deadline' | 'task';
    title: string;
    time?: string;
    caseId?: string;
    caseName?: string;
  }[];

  // Urgent items
  urgentItems: {
    type: 'overdue_task' | 'court_email' | 'deadline_today';
    title: string;
    entityId: string;
    caseId?: string;
    daysOverdue?: number;
  }[];

  // Recent activity (last 24h)
  recentActivity: {
    type: ActivityEventType;
    title: string;
    entityId: string;
    occurredAt: string;
  }[];

  // Active cases summary
  activeCases: {
    id: string;
    name: string;
    nextDeadline?: string;
    unreadEmails: number;
    recentActivity: boolean;
  }[];
}
```

### CaseBriefing

Per-case context for case-specific conversations.

```prisma
model CaseBriefing {
  id          String   @id @default(cuid())
  caseId      String   @unique
  case        Case     @relation(fields: [caseId], references: [id])
  firmId      String

  // Computed briefing (markdown/text for direct injection)
  briefingText    String   @db.Text
  briefingData    Json              // Structured data

  // Tracking
  lastComputedAt  DateTime
  validUntil      DateTime          // Soft expiry

  // Invalidation tracking
  lastEmailAt     DateTime?
  lastDocumentAt  DateTime?
  lastTaskAt      DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([caseId])
  @@index([validUntil])
}
```

**BriefingData TypeScript interface:**

```typescript
interface CaseBriefingData {
  // Basic info
  caseNumber: string;
  title: string;
  status: string;
  court?: string;

  // Parties
  parties: {
    role: string;
    name: string;
    isClient: boolean;
  }[];

  // Timeline
  nextDeadline?: {
    date: string;
    description: string;
  };
  recentEvents: {
    date: string;
    type: string;
    description: string;
  }[];

  // Counts
  documentCount: number;
  emailCount: number;
  unreadEmailCount: number;
  pendingTaskCount: number;
}
```

## Implementation Plan

1. Add Prisma schema changes
2. Create migration
3. Add TypeScript types to `@legal-platform/shared`
4. Create basic CRUD operations in services

## Files to Create/Modify

### New Files

- `packages/database/prisma/migrations/XXX_ai_context_files/migration.sql`
- `packages/shared/src/types/ai-context.types.ts`

### Modified Files

- `packages/database/prisma/schema.prisma`

## Dependencies

- None (foundational)

## Enables

- OPS-116: Event Emission Infrastructure
- OPS-117: User Daily Context Service
- OPS-118: Case Briefing Service

## Success Metrics

- [x] Schema deployed without issues
- [x] Types exported from shared package
- [ ] No impact on existing functionality (needs local verification)

---

## Local Verification Status

| Step           | Status     | Date       | Notes           |
| -------------- | ---------- | ---------- | --------------- |
| Prod data test | ⬜ Pending |            |                 |
| Preflight      | ✅ Passed  | 2024-12-23 | All checks pass |
| Docker test    | ⬜ Pending |            |                 |

**Verified**: No (pending local verification)

---

## Session Log

### 2024-12-23 - Session 1: Implementation Complete

- Added Prisma models: `UserActivityEvent`, `UserDailyContext`, `CaseBriefing`
- Added enums: `ActivityEventType`, `ActivityEntityType`, `EventImportance`
- Created migration: `20251223210000_add_ai_context_files`
- Added TypeScript types to `@legal-platform/types`:
  - `packages/shared/types/src/ai-context.ts`
- Renamed `EntityType` → `ActivityEntityType` to avoid conflict with existing `EntityType` in `task-collaboration.ts`
- Preflight passes (6 passed, 2 warnings - existing test and lint issues)
- **Status**: Implementation complete, pending local verification

### 2024-12-23 - Issue Created

- Created from `/ops-ideate` session exploring AI context optimization
- Part of AI Context Files epic (OPS-115 → OPS-120)
