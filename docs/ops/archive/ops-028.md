# OPS-028: Classification Metadata UI

**Status:** Verifying
**Priority:** P1-High
**Type:** Feature (Frontend)
**Created:** 2025-12-16
**Blocked By:** OPS-027
**Blocks:** OPS-030
**Can Parallel With:** OPS-029

---

## Problem Statement

Users need interfaces to:

1. Configure firm-level court/authority email addresses
2. Add classification metadata when creating cases
3. Edit classification metadata for existing cases

This UI captures the data that the AI classification service (OPS-029) will use.

---

## Scope

### 1. Firm Settings: Global Email Sources

New settings page section for managing court/authority addresses:

**Location:** Settings â†’ Firm Settings (new tab or section)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Surse Email Globale                                    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  InstanÈ›e È™i AutoritÄƒÈ›i                                 â”‚
â”‚  Emailurile de la aceste adrese vor fi clasificate      â”‚
â”‚  pe baza numÄƒrului de dosar din conÈ›inut.               â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ›ï¸ InstanÈ›e                                     â”‚    â”‚
â”‚  â”‚   Domenii: just.ro, tribunalul-bucuresti.ro    â”‚ âœï¸ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ ğŸ“‹ ANAF                                         â”‚    â”‚
â”‚  â”‚   Domenii: anaf.ro                             â”‚ âœï¸ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ ğŸ  OCPI/Cadastru                               â”‚    â”‚
â”‚  â”‚   Domenii: ancpi.ro                            â”‚ âœï¸ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â”‚  [+ AdaugÄƒ sursÄƒ]                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**

- Add/edit/delete global email sources
- Category selection (Court, Notary, Authority, etc.)
- Multiple domains per source
- Specific addresses option

### 2. Case Creation Wizard Enhancement

Add optional step after basic case info:

```
Pas 3 din 4: Configurare Clasificare Email (OpÈ›ional)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cuvinte cheie                                          â”‚
â”‚  Termeni specifici acestui dosar pentru potrivire AI    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ + AdaugÄƒ cuvÃ¢nt cheie                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â”‚  Numere de referinÈ›Äƒ                                    â”‚
â”‚  Numere de dosar instanÈ›Äƒ, contracte, etc.              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ + AdaugÄƒ referinÈ›Äƒ                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  ğŸ’¡ Format dosar instanÈ›Äƒ: 1234/3/2024                  â”‚
â”‚                                                         â”‚
â”‚  Note pentru AI (opÈ›ional)                              â”‚
â”‚  Context suplimentar pentru clasificarea automatÄƒ       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                 â”‚    â”‚
â”‚  â”‚                                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â”‚  [Omite] [ContinuÄƒ]                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**

- Skippable step (classification metadata is optional)
- Tag-style input for keywords and reference numbers
- Court file number format hint
- Free text area for classification notes

### 3. Case Settings Panel

Add classification section to existing case settings:

**Location:** Case Details â†’ Settings tab (or gear icon)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Clasificare Email                                      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Cuvinte cheie                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ apartament â”‚ floreasca â”‚ contract â”‚ + AdaugÄƒ   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â”‚  Numere de referinÈ›Äƒ                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 1234/3/2024 â”‚ + AdaugÄƒ                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â”‚  Note pentru AI                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ DisputÄƒ privind livrarea apartamentului...      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â”‚  [SalveazÄƒ modificÄƒrile]                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Acceptance Criteria

- [ ] Firm settings page has Global Email Sources section
- [ ] Can add/edit/delete global sources with categories
- [ ] Case creation wizard has optional classification step
- [ ] Can skip classification step without errors
- [ ] Case settings shows classification metadata panel
- [ ] Can edit classification metadata for existing cases
- [ ] All UI text in Romanian
- [ ] Responsive design (works on smaller screens)

---

## GraphQL Operations Needed

```graphql
# Firm settings
query GetGlobalEmailSources: [GlobalEmailSource!]!
mutation CreateGlobalEmailSource(input: CreateGlobalEmailSourceInput!): GlobalEmailSource!
mutation UpdateGlobalEmailSource(id: ID!, input: UpdateGlobalEmailSourceInput!): GlobalEmailSource!
mutation DeleteGlobalEmailSource(id: ID!): Boolean!

# Case classification metadata
mutation UpdateCaseClassificationMetadata(
  caseId: ID!
  keywords: [String!]
  referenceNumbers: [String!]
  subjectPatterns: [String!]
  classificationNotes: String
): Case!
```

---

## Files to Create/Modify

### New Files

- `apps/web/src/components/settings/GlobalEmailSourcesPanel.tsx`
- `apps/web/src/components/case/ClassificationMetadataStep.tsx`
- `apps/web/src/components/case/ClassificationSettingsPanel.tsx`
- `apps/web/src/hooks/useGlobalEmailSources.ts`
- `services/gateway/src/graphql/schema/global-email-sources.graphql`
- `services/gateway/src/graphql/resolvers/global-email-sources.resolvers.ts`

### Modified Files

- `apps/web/src/components/case/CreateCaseModal.tsx` (add step)
- `apps/web/src/components/case/CaseSettings.tsx` (add panel)
- `apps/web/src/components/settings/SettingsPage.tsx` (add section)

---

## Design Notes

- Use existing UI patterns from the codebase
- Tag inputs similar to email address input in EmailImportWizard
- Collapsible sections for complex forms
- Validation: court file format, no duplicate keywords

---

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | â¬œ Pending |      |       |
| Preflight      | â¬œ Pending |      |       |
| Docker test    | â¬œ Pending |      |       |

**Verified**: No

---

## Session Log

### Session 1 (2025-12-16)

**Status**: In Progress

**Work Completed:**

1. **GraphQL Schema** (`services/gateway/src/graphql/schema/global-email-sources.graphql`):
   - `GlobalEmailSourceCategory` enum (Court, Notary, Bailiff, Authority, Other)
   - `GlobalEmailSource` type with all fields
   - CRUD operations: `globalEmailSources` query, `createGlobalEmailSource`, `updateGlobalEmailSource`, `deleteGlobalEmailSource` mutations
   - `updateCaseClassification` mutation for case metadata

2. **Backend Resolvers** (`services/gateway/src/graphql/resolvers/global-email-sources.resolvers.ts`):
   - Full CRUD implementation for GlobalEmailSource
   - Authorization checks (Partner/BusinessOwner only for mutations)
   - Validation for domains, emails, names
   - updateCaseClassification resolver with case access checks
   - Registered in server.ts

3. **Frontend Hook** (`apps/web/src/hooks/useGlobalEmailSources.ts`):
   - `useGlobalEmailSources()` - CRUD operations for global sources
   - `useCaseClassification()` - update case classification metadata
   - Category labels and icons for Romanian UI

4. **UI Components**:
   - `GlobalEmailSourcesPanel.tsx` - Firm settings panel for managing email sources
   - `ClassificationMetadataStep.tsx` - Optional wizard step for case creation
   - `ClassificationSettingsPanel.tsx` - Case settings panel for editing metadata

5. **Firm Settings Page** (`apps/web/src/app/settings/firm/page.tsx`):
   - New route `/settings/firm` for firm-level settings
   - Added navigation item in Sidebar.tsx

6. **Schema Updates**:
   - Added `keywords`, `referenceNumbers`, `subjectPatterns`, `classificationNotes` to Case type in GraphQL

**Not Implemented (Out of Scope):**

- Integration with CreateCaseModal (requires more complex multi-step refactor)
- Integration with CommunicationsTab (deferred to OPS-030)

**Files Created:**

- `services/gateway/src/graphql/schema/global-email-sources.graphql`
- `services/gateway/src/graphql/resolvers/global-email-sources.resolvers.ts`
- `apps/web/src/hooks/useGlobalEmailSources.ts`
- `apps/web/src/components/settings/GlobalEmailSourcesPanel.tsx`
- `apps/web/src/components/case/ClassificationMetadataStep.tsx`
- `apps/web/src/components/case/ClassificationSettingsPanel.tsx`
- `apps/web/src/app/settings/firm/page.tsx`

**Files Modified:**

- `services/gateway/src/graphql/server.ts` (added resolvers)
- `services/gateway/src/graphql/schema/case.graphql` (added classification fields)
- `services/gateway/src/graphql/schema/index.ts` (added schema loading for new files)
- `apps/web/src/components/layout/Sidebar.tsx` (added firm settings nav)

**Bug Fixed:**

- Schema loading issue: `global-email-sources.graphql` and `email-classification.graphql` were not being loaded in `schema/index.ts`
- Error was: `Query.globalEmailSources defined in resolvers, but not in schema`
- Fixed by adding schema imports and including them in the merged schema array

**Current State:**

- Dev server running successfully on localhost:3000
- GraphQL endpoint responding on localhost:4000
- Ready for manual testing

**Next Steps:**

- Test GlobalEmailSourcesPanel at `/settings/firm`
- Test ClassificationSettingsPanel on case pages
- Run preflight checks
- Test with production data
