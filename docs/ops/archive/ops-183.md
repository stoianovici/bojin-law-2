# OPS-183: Frontend Auto-Sync Integration

**Type**: Feature
**Priority**: P2-Medium
**Status**: Open
**Epic**: Frictionless SharePoint-First Document Editing

## Problem

Frontend doesn't know to refresh version badge or show sync status after Word editing. Users have no visibility into whether their Word edits were picked up by the app.

## Solution

Update `useDocumentPreview` hook to handle sync results from preview URL query. Show subtle toast when new version detected. Update version count badge without full reload.

## Implementation

### Updated useDocumentPreview Hook

```typescript
// In useDocumentPreview.ts

const GET_DOCUMENT_PREVIEW = gql`
  query GetDocumentPreview($documentId: ID!) {
    documentPreviewUrl(documentId: $documentId) {
      url
      source
      expiresAt
      syncResult {
        # NEW
        synced
        newVersionNumber
      }
    }
  }
`;

export function useDocumentPreview() {
  const { addToast } = useToast();

  const openPreview = async (documentId: string) => {
    const { data } = await fetchPreview({ variables: { documentId } });

    // Show sync notification if new version was created
    if (data?.documentPreviewUrl?.syncResult?.synced) {
      addToast({
        type: 'success',
        message: `Versiunea ${data.documentPreviewUrl.syncResult.newVersionNumber} sincronizată din Word`,
        duration: 3000,
      });

      // Trigger version badge update
      refetchDocumentVersions?.();
    }

    // ... rest of preview logic
  };
}
```

### DocumentCard Version Badge Update

```typescript
// In DocumentCard.tsx

// Subscribe to version updates or use refetch after sync
const { versionCount, refetch: refetchVersions } = useDocumentVersionCount(documentId);

// Expose refetch through context for sync integration
```

### GraphQL Schema Addition

```graphql
type PreviewUrlResponse {
  url: String!
  source: PreviewSource!
  expiresAt: DateTime
  syncResult: SyncResult # NEW - included when sync happened
}

type SyncResult {
  synced: Boolean!
  newVersionNumber: Int
}
```

## Files to Modify

- `apps/web/src/hooks/useDocumentPreview.ts`
- `apps/web/src/components/documents/DocumentCard.tsx`
- `services/gateway/src/graphql/schema/document.graphql`

## Done When

- [x] Preview hook handles sync result from query
- [x] Toast shown on new version detection (Romanian text)
- [x] Version badge updates after sync without page reload
- [x] Loading state shown during sync check (network-only fetch policy)
- [x] No toast if no sync happened (quiet success)

## Dependencies

- OPS-182: Lazy Version Sync on Document Access

## Blocked By

- OPS-182

## Implementation Notes (2024-12-24)

### GraphQL Schema Changes

**`document.graphql`**:

- Added `PreviewSyncResult` type with `synced: Boolean!` and `newVersionNumber: Int`
- Extended `PreviewUrlResponse` with `syncResult: PreviewSyncResult` field

### Backend Changes

**`document.resolvers.ts`**:

- `documentPreviewUrl` resolver now calls `wordIntegrationService.syncFromSharePointIfChanged()` before returning preview URL
- Sync is opportunistic (errors are logged but don't fail the preview)
- All return paths include `syncResult` field (null if no sync occurred)

### Frontend Changes

**`useDocumentPreview.ts`**:

- Updated query to include `syncResult { synced newVersionNumber }`
- Added `lastSyncResult` state and return value
- When sync occurs, shows toast notification: "Document sincronizat - Versiunea X a fost sincronizată din Word"
- Added optional `onVersionSynced` callback to notify parent components

**`DocumentsContentPanel.tsx`**:

- Extracts `refetch` from `useDocumentGrid` hook
- Passes `onVersionSynced` callback to `useDocumentPreview`
- When a new version is synced, triggers grid refetch to update version badges

### User Experience

1. User opens document preview after editing in Word
2. Backend detects SharePoint changes and syncs new version
3. Toast notification appears confirming sync (Romanian)
4. Document grid refreshes, showing updated version count on DocumentCard
