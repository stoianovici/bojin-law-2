# OPS-257: Extend CaseBriefing Schema for Rich Context

**Type**: Feature | **Priority**: P2-Medium | **Complexity**: S
**Status**: Completed
**Parallel**: Yes (with OPS-258, OPS-259, OPS-260)

## Problem

Current `CaseBriefing` stores only ~400-600 tokens of basic metadata (case info, parties, next deadline, recent events). Need to store comprehensive context (~2000-4000 tokens) including document summaries, email summaries, client context, and structured data for instant AI access.

## Solution

Extend the existing `CaseBriefing` model with new JSON fields for rich context sections. This enables the batch processor to store comprehensive pre-compiled context.

## Implementation

### Schema Changes

```prisma
model CaseBriefing {
  // ... existing fields ...

  // Rich context sections (OPS-257)
  documentSummaries     Json?  @map("document_summaries")     // Top document summaries
  emailThreadSummaries  Json?  @map("email_thread_summaries") // Recent thread summaries with action items
  upcomingDeadlines     Json?  @map("upcoming_deadlines")     // Next 10 deadlines structured
  contactContext        Json?  @map("contact_context")        // Case contacts with last communication
  clientContext         Json?  @map("client_context")         // Client profile, portfolio, relationship
  caseHealthIndicators  Json?  @map("case_health_indicators") // Risk flags, staleness warnings
  contextVersion        Int    @default(1) @map("context_version") // Schema version for migrations
}
```

### TypeScript Types

```typescript
interface RichCaseContext {
  // Existing
  briefingText: string;
  briefingData: CaseBriefingData;

  // New sections
  documentSummaries: DocumentSummary[];
  emailThreadSummaries: EmailThreadSummary[];
  upcomingDeadlines: UpcomingDeadline[];
  contactContext: ContactContext;
  clientContext: ClientContext;
  caseHealthIndicators: HealthIndicator[];
  contextVersion: number;
}

interface DocumentSummary {
  id: string;
  title: string;
  type: string;
  summary: string;
  updatedAt: string;
}

interface EmailThreadSummary {
  threadId: string;
  subject: string;
  participants: string[];
  summary: string;
  actionItems: string[];
  lastMessageAt: string;
  isUrgent: boolean;
}

interface ClientContext {
  id: string;
  name: string;
  type: 'individual' | 'company';
  relationshipStartDate: string;
  activeCaseCount: number;
  closedCaseCount: number;
  primaryContacts: { name: string; email: string; role: string }[];
  notes?: string;
}
```

## Done When

- [x] Schema extended with new JSON fields
- [x] Migration runs cleanly (all new fields nullable)
- [x] TypeScript types exported for new structure
- [x] Existing briefing generation still works unchanged
- [x] `contextVersion` defaults to 1 for new records

## Files

- `packages/database/prisma/schema.prisma` - Schema extended
- `packages/database/prisma/migrations/20251226100000_rich_case_context/` - Migration applied
- `packages/shared/types/src/ai-context.ts` - TypeScript types added

## Dependencies

None - can start immediately.

## Blockers For

- OPS-261: Case Context Batch Processor
