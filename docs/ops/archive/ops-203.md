# OPS-203: Restructure Assigned Email Action Bar

**Status:** Resolved | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-24

## Overview

Assigned email action bar opens Outlook instead of AI draft compose. Missing Forward and Notify buttons.

## Dependencies

- **Depends on:** OPS-201 (+ button moved to header)
- **Blocks:** OPS-205 (Privacy Verification)
- **Parallel with:** OPS-204

## Context

Part of Communications Action Bar Redesign epic. For emails already assigned to a case, users should use in-app AI-powered compose rather than external Outlook.

## Requirements

### 1. Current vs Target Layout

**Current:**

```
[+ Nou]  [Răspunde → Outlook]  [Privat]  [Marchează ca procesat]
```

**Target:**

```
[Răspunde]  [Forward]  [Notify]  [Privat (partners)]
```

### 2. "Răspunde" → ComposeInterface

Change from Outlook redirect to opening ComposeInterface:

```typescript
// In communication.store.ts
interface CommunicationState {
  // ... existing
  openCompose: (mode: 'new' | 'reply' | 'forward', threadId?: string) => void;
}

// Implementation
openCompose: (mode, threadId) => {
  set({
    isComposeOpen: true,
    composeMode: mode,
    composeThreadId: threadId || null,
  });
};
```

Button handler:

```tsx
const handleReply = () => {
  openCompose('reply', thread.id);
};
```

### 3. Add "Forward" Button

Open ComposeInterface in forward mode:

```tsx
<button onClick={() => openCompose('forward', thread.id)}>
  <Forward className="h-4 w-4" />
  Forward
</button>
```

ComposeInterface already has forward mode support (line 459).

### 4. Add "Notify" Button

Restore NotifyStakeholdersModal:

```tsx
const [showNotifyModal, setShowNotifyModal] = useState(false);

<button onClick={() => setShowNotifyModal(true)}>
  <Users className="h-4 w-4" />
  Notify
</button>;

{
  showNotifyModal && (
    <NotifyStakeholdersModal thread={thread} onClose={() => setShowNotifyModal(false)} />
  );
}
```

### 5. Remove "Marchează ca procesat"

Delete the button and its handler.

### 6. Keep "Privat" Toggle

Keep existing privacy toggle for partners (canTogglePrivacy check).

## Acceptance Criteria

- [x] "Răspunde" opens ComposeInterface with AI draft panel
- [x] "Forward" opens ComposeInterface in forward mode
- [x] "Notify" opens NotifyStakeholdersModal
- [x] "Marchează ca procesat" removed
- [x] "Privat" toggle works for partners
- [x] "+ Nou" not in action bar (moved to header per OPS-201)

## Files to Modify

- `apps/web/src/stores/communication.store.ts` - add openCompose action
- `apps/web/src/components/communication/ConversationView.tsx` - restructure action bar
- `apps/web/src/components/communication/ComposeInterface.tsx` - verify forward mode

## Estimated Scope

Medium - Action bar restructure with store changes.

---

## Session Log

### 2025-12-24

**Done:**

- Imported `openCompose` from communication.store.ts (already exists)
- Updated `handleReply` to call `openCompose('reply', thread.id)` instead of `openOutlookReply()`
- Added `handleForward` calling `openCompose('forward', thread.id)`
- Added `showNotifyModal` state and NotifyStakeholdersModal component
- Imported `Forward`, `Users` icons and `NotifyStakeholdersModal` component
- Restructured normal mode action bar: [Răspunde] [Forward] [Notify] [Privat]
- Removed ExternalLink icon from Răspunde button (no longer opening Outlook)
- Removed "Marchează ca procesat" button and `handleMarkAsProcessed` function
- Added NotifyStakeholdersModal render at component end
- Type check passes

**Changes:**

- `apps/web/src/components/communication/ConversationView.tsx`:
  - Lines 18-31: Added Forward, Users to lucide imports
  - Line 38: Imported NotifyStakeholdersModal
  - Line 227: Added openCompose to store destructure
  - Line 272: Added showNotifyModal state
  - Lines 309-321: Updated handleReply, added handleForward
  - Line 508: Removed handleMarkAsProcessed
  - Lines 875-958: Restructured normal mode action bar
  - Lines 1035-1038: Added NotifyStakeholdersModal render

**Result:** Complete - All acceptance criteria met
