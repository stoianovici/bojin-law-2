# OPS-014: Role-based menu visibility refinement

| Field           | Value      |
| --------------- | ---------- |
| **Status**      | Resolved   |
| **Type**        | Bug        |
| **Priority**    | P2-Medium  |
| **Created**     | 2025-12-13 |
| **Sessions**    | 3          |
| **Last Active** | 2025-12-13 |

## Description

Current implementation of role-based menu visibility has two issues:

1. **"Acces restrictionat" message appears** instead of hiding menu items - when users navigate directly to restricted URLs, they see a restriction page rather than the section being invisible in the menu
2. **Some sections visible that shouldn't be** - possible misalignment between menu configuration and business requirements

### Required Role Permissions

**Partners**: Full access to everything

**Associates** should NOT see:

- Analytics
- Inteligență Platformă (Platform Intelligence)
- Reports (Rapoarte)
- AI Personalizare

**Paralegals** should NOT see (same as Associates):

- Analytics
- Inteligență Platformă (Platform Intelligence)
- Reports (Rapoarte)
- AI Personalizare

### Additional Investigation Needed

How case details, documents, and communications are managed per role - ensure consistency.

## Current State (from triage)

### Sidebar Navigation (`apps/web/src/components/layout/Sidebar.tsx`)

Menu filtering logic at lines 183-186:

```typescript
const visibleItems = navigationItems.filter((item) => item.roles.includes(currentRole));
```

Current navigation items configuration (lines 57-146):

| Menu Item             | Current Roles Allowed         | Should Be           |
| --------------------- | ----------------------------- | ------------------- |
| Dashboard             | Partner, Associate, Paralegal | Same ✓              |
| Analytics             | Partner, BusinessOwner        | Partner only ✓      |
| Inteligență Platformă | Partner, BusinessOwner        | Partner only ✓      |
| Cazuri                | Partner, Paralegal            | Same ✓              |
| My Cases              | Associate                     | Same ✓              |
| Documente             | Partner, Associate, Paralegal | Same ✓              |
| Sarcini               | Partner, Associate, Paralegal | Same ✓              |
| Comunicări            | Partner, Associate, Paralegal | Same ✓              |
| Pontaj                | Partner, Associate, Paralegal | Same ✓              |
| Rapoarte              | Partner                       | Partner only ✓      |
| AI Personalizare      | Partner, Associate, Paralegal | **Partner only** ❌ |

### "Acces restrictionat" Locations

1. **Analytics page** (`apps/web/src/app/analytics/page.tsx:45`)
   - Shows AccessDenied component with "Acces restrictionat" for non-Partner/non-BusinessOwner

2. **Platform Intelligence** (`apps/web/src/app/analytics/platform-intelligence/page.tsx:111`)
   - Same pattern

### Case/Documents/Communications Access

From investigation, current permission structure:

| Feature                       | Partner | Associate | Paralegal | BusinessOwner |
| ----------------------------- | ------- | --------- | --------- | ------------- |
| Case Details                  | Full    | Full      | Full      | Full          |
| Case Value/Financials         | Visible | Hidden    | Hidden    | Visible       |
| Documents                     | Full    | Full      | Full      | Full          |
| Communications - Normal       | Full    | Full      | Full      | Full          |
| Communications - AttorneyOnly | Visible | Visible   | Hidden    | Hidden        |
| Communications - PartnerOnly  | Visible | Hidden    | Hidden    | Hidden        |

## Reproduction Steps

1. Log in as Associate or Paralegal user
2. Check sidebar menu - verify which sections are visible
3. Navigate directly to `/analytics` - should not show "Acces restrictionat", should redirect or 404
4. Check if AI Personalizare is visible in menu (shouldn't be for Associate/Paralegal)

## Root Cause

1. **AI Personalizare misconfiguration**: Currently allows `['Partner', 'Associate', 'Paralegal']` but should be Partner only
2. **Page-level access control shows message**: Instead of redirecting, pages show "Acces restrictionat" which confirms the restricted section exists

## Fix Required

1. Update `navigationItems` in Sidebar.tsx:
   - Change `ai-personalization` roles from `['Partner', 'Associate', 'Paralegal']` to `['Partner']`

2. Update page-level access control to redirect instead of showing restriction message:
   - `/analytics` - redirect to dashboard for unauthorized users
   - `/analytics/platform-intelligence` - same
   - `/reports` - same
   - `/settings/personalization` - same

## Local Dev Environment

```bash
# Root directory - run all services
pnpm dev

# Web app only
cd apps/web && pnpm dev

# Environment files needed:
# - .env (root) or copy from .env.example
# - apps/web/.env.local (copy from apps/web/.env.example)
# - services/gateway/.env (if running gateway)
```

## Session Log

- [2025-12-13] Session 3 - **RESOLVED**:
  - Root cause: Sidebar used `currentRole` from navigation store (localStorage, defaults to Partner) instead of authenticated user's actual role
  - Fixed Sidebar.tsx to use `useAuth().user.role` for menu filtering
  - Fixed AuthContext.tsx to fall back to session cookie when MSAL provisioning fails
  - Tested with Paralegal (bianca.iaici) - restricted menu items now hidden correctly
  - Analytics, Platform Intelligence, Reports, AI Personalizare all properly hidden for non-Partners

- [2025-12-13] Session 2 - Implementation complete:
  - Fixed AI Personalizare roles in Sidebar.tsx (now Partner only)
  - Updated /analytics page to redirect to dashboard instead of showing "Acces restrictionat"
  - Updated /analytics/platform-intelligence to redirect instead of showing "Acces restrictionat"
  - Added role check to /settings/personalization page with redirect for non-Partners
  - All changes compile without errors
  - Fixed database package build issue (stale tsbuildinfo cache)
  - Dev server running on port 3000
  - **Next**: Verify with role switcher, then deploy

- [2025-12-13] Issue created. Initial triage completed:
  - Found Sidebar.tsx role filtering logic
  - Identified AI Personalizare as incorrectly configured (all roles instead of Partner only)
  - Found "Acces restrictionat" page components that should redirect instead
  - Documented case/documents/communications role-based access patterns

## Files Involved

- `apps/web/src/components/layout/Sidebar.tsx` - Main navigation, role filtering
- `apps/web/src/app/analytics/page.tsx` - Analytics page with AccessDenied
- `apps/web/src/app/analytics/platform-intelligence/page.tsx` - Platform Intelligence AccessDenied
- `apps/web/src/app/reports/page.tsx` - Reports page
- `apps/web/src/app/settings/personalization/page.tsx` - AI Personalization page
- `apps/web/src/stores/navigation.store.ts` - Navigation state, currentRole
- `apps/web/src/hooks/useAuthorization.ts` - Role-based auth hook
- `apps/web/src/contexts/FinancialAccessContext.tsx` - Financial access control
- `apps/web/src/hooks/useCommunicationPrivacy.ts` - Communication privacy levels

---
