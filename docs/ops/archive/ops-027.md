# OPS-027: Classification Schema & Data Model

**Status:** Verifying
**Priority:** P1-High
**Type:** Feature (Foundation)
**Created:** 2025-12-16
**Last Active:** 2025-12-16
**Sessions:** 1
**Blocked By:** None
**Blocks:** OPS-028, OPS-029

---

## Problem Statement

The platform needs to support AI-based email classification for clients with multiple cases. Before building the classification logic or UI, we need the data model to support:

1. Case-level classification hints (keywords, reference numbers)
2. Firm-level global email sources (courts, authorities)
3. Enhanced CaseActor email tracking

---

## Scope

### 1. Case Model Enhancements

Add new fields to the Case model:

```prisma
model Case {
  // ... existing fields ...

  // Classification metadata
  keywords            String[]    // User-defined terms for matching
  referenceNumbers    String[]    // Court file numbers, contract refs
  subjectPatterns     String[]    // Email subject patterns (glob-style)
  classificationNotes String?     // Free text guidance for AI
}
```

### 2. Global Email Sources Table

New table for firm-level shared addresses (courts, authorities):

```prisma
model GlobalEmailSource {
  id          String   @id @default(cuid())
  firmId      String
  firm        Firm     @relation(fields: [firmId], references: [id])

  category    GlobalEmailSourceCategory  // court, notary, authority, etc.
  name        String                     // "Tribunalul Bucuresti"
  domains     String[]                   // ["just.ro", "tribunalul-bucuresti.ro"]
  addresses   String[]                   // Specific email addresses

  // How to classify emails from this source
  classificationHint  String?            // "Match by reference number"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([firmId])
}

enum GlobalEmailSourceCategory {
  Court
  Notary
  Bailiff
  Authority
  Other
}
```

### 3. CaseActor Enhancement

Add email domains tracking:

```prisma
model CaseActor {
  // ... existing fields ...

  emailDomains  String[]  // ["cabinet-avocat.ro", "lawfirm.com"]
}
```

### 4. Database Migration

- Create migration for all schema changes
- Ensure backwards compatibility (all new fields nullable or have defaults)
- Add indexes for efficient querying

---

## Acceptance Criteria

- [x] Case model has new classification fields
- [x] GlobalEmailSource table exists with firm relationship
- [x] CaseActor has emailDomains field
- [x] Migration runs successfully on existing data
- [x] Prisma client regenerated with new types
- [x] No breaking changes to existing functionality (verified: app loads, existing features work)

---

## Technical Notes

### Reference Number Format

Romanian court file numbers follow pattern: `XXXX/Y/YYYY`

- XXXX = case number
- Y = court section
- YYYY = year

Consider storing both raw input and normalized form for flexible matching.

### Global Sources Seed Data

Consider providing default court domains for Romanian firms:

- `@just.ro` (general justice system)
- Common tribunal domains

---

## Files to Modify

- `packages/database/prisma/schema.prisma`
- `packages/database/prisma/migrations/` (new migration)

---

## Local Verification Status

| Step           | Status     | Date       | Notes                               |
| -------------- | ---------- | ---------- | ----------------------------------- |
| Prod data test | ✅ Passed  | 2025-12-16 | App loads, schema migration applied |
| Preflight      | ⬜ Pending |            |                                     |
| Docker test    | ⬜ Pending |            |                                     |

**Verified**: No (awaiting preflight + docker)

---

## Session Log

### Session 1 (2025-12-16)

**Work Completed:**

1. Added classification fields to Case model:
   - `keywords` (String[]): User-defined terms for matching
   - `referenceNumbers` (String[]): Court file numbers, contract refs
   - `subjectPatterns` (String[]): Email subject patterns
   - `classificationNotes` (String?): Free text guidance for AI

2. Created `GlobalEmailSource` model for firm-level shared addresses:
   - `category`: Court, Notary, Bailiff, Authority, Other
   - `name`: Display name (e.g., "Tribunalul București")
   - `domains`: Email domains (e.g., ["just.ro"])
   - `emails`: Specific email addresses
   - `classificationHint`: AI guidance text

3. Added `emailDomains` field to `CaseActor` model

4. Created and applied migration `20251216120000_add_email_classification_schema`

5. Regenerated Prisma client with new types

**Files Modified:**

- `packages/database/prisma/schema.prisma`
- `packages/database/prisma/migrations/20251216120000_add_email_classification_schema/migration.sql`

**Next Steps:**

- Run local verification
- Note: This is a schema-only change, no UI or backend code to test at runtime. Verification primarily ensures migration works and doesn't break existing functionality.
