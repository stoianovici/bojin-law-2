# OPS-065: Conversation Service

**Status:** Implemented | **Priority:** P0-Critical | **Type:** Feature
**Created:** 2025-12-20 | **Depends on:** OPS-063, OPS-064 | **Blocks:** OPS-066

## Summary

Create the service layer for managing AI conversation state, including CRUD operations for conversations and messages with firm isolation.

## Background

The conversation service is the data layer for the AI assistant. It handles:

- Creating and retrieving conversations
- Adding messages to conversations
- Managing conversation lifecycle (active → completed/expired)
- Enforcing firm isolation security

## Requirements

### Service Interface

```typescript
// services/gateway/src/services/conversation.service.ts

import { prisma } from '@legal-platform/database';
import {
  AIConversation,
  AIMessage,
  ConversationStatus,
  AIMessageRole,
  AIActionStatus,
} from '@prisma/client';

// ============================================================================
// Types
// ============================================================================

interface UserContext {
  userId: string;
  firmId: string;
}

interface CreateMessageInput {
  role: AIMessageRole;
  content: string;
  intent?: string;
  confidence?: number;
  actionType?: string;
  actionPayload?: Record<string, unknown>;
  actionStatus?: AIActionStatus;
  tokensUsed?: number;
  modelUsed?: string;
  latencyMs?: number;
}

interface ConversationWithMessages extends AIConversation {
  messages: AIMessage[];
}

// ============================================================================
// Service
// ============================================================================

export class ConversationService {
  /**
   * Get or create an active conversation for the user.
   * Returns existing active conversation if one exists for the context.
   */
  async getOrCreateConversation(userContext: UserContext, caseId?: string): Promise<AIConversation>;

  /**
   * Get a conversation by ID with firm isolation.
   */
  async getConversation(id: string, firmId: string): Promise<ConversationWithMessages | null>;

  /**
   * Add a message to a conversation.
   */
  async addMessage(
    conversationId: string,
    message: CreateMessageInput,
    firmId: string
  ): Promise<AIMessage>;

  /**
   * Update conversation status.
   */
  async updateStatus(
    id: string,
    status: ConversationStatus,
    firmId: string
  ): Promise<AIConversation>;

  /**
   * Update message action status (when action is confirmed/executed).
   */
  async updateMessageActionStatus(
    messageId: string,
    status: AIActionStatus,
    firmId: string
  ): Promise<AIMessage>;

  /**
   * Close a conversation.
   */
  async closeConversation(id: string, firmId: string): Promise<AIConversation>;

  /**
   * Get conversation history for a user.
   */
  async getHistory(
    userContext: UserContext,
    limit: number,
    caseId?: string
  ): Promise<AIConversation[]>;

  /**
   * Expire stale conversations (for cleanup job).
   * Conversations older than 24 hours are marked as Expired.
   */
  async expireStaleConversations(): Promise<number>;
}

// Export singleton instance
export const conversationService = new ConversationService();
```

### Key Implementation Details

1. **Firm Isolation**: All queries must include firmId filter
2. **Active Conversation**: Only one active conversation per user per case context
3. **Message Ordering**: Messages returned in chronological order
4. **Cascade Delete**: Messages deleted when conversation deleted
5. **Expiration**: Conversations auto-expire after 24 hours of inactivity

## Acceptance Criteria

- [x] ConversationService class implemented with all methods
- [x] Firm isolation enforced on all operations
- [x] Message ordering correct (oldest first)
- [x] Singleton instance exported
- [x] Unit tests for all methods (29 tests passing)
- [x] TypeScript types properly defined

## Files to Create

- `services/gateway/src/services/conversation.service.ts`
- `services/gateway/src/services/conversation.service.test.ts`

## Testing

```typescript
describe('ConversationService', () => {
  it('creates new conversation if none active');
  it('returns existing active conversation');
  it('enforces firm isolation on getConversation');
  it('adds messages in correct order');
  it('updates conversation status');
  it('closes conversation and sets closedAt');
  it('expires stale conversations');
});
```

## Session Log

- [2025-12-20T15:00] Session 1 started. Status: Open
- [2025-12-20T15:05] Created ConversationService class with all methods:
  - `getOrCreateConversation` - Returns existing or creates new active conversation
  - `getConversation` - Gets conversation by ID with firm isolation
  - `addMessage` - Adds message to conversation
  - `updateStatus` - Updates conversation lifecycle status
  - `updateMessageActionStatus` - Updates action state (Proposed→Confirmed→Executed)
  - `closeConversation` - Sets status to Completed with closedAt timestamp
  - `getHistory` - Gets user's conversation history with optional case filter
  - `expireStaleConversations` - Batch expire conversations older than 24h
  - `getActiveConversationCount` - Utility for rate limiting
  - `getConversationWithCase` - Includes case details for display
- [2025-12-20T15:10] TypeScript compilation verified: 0 errors
- [2025-12-20T15:15] Created comprehensive test suite with 29 unit tests
- [2025-12-20T15:18] All tests passing: 29/29 ✓

#### Local Verification Status

| Step           | Status     | Notes                               |
| -------------- | ---------- | ----------------------------------- |
| Prod data test | ⬜ Pending | Awaiting integration with resolvers |
| Preflight      | ⬜ Pending | Need to run full preflight          |
| Docker test    | ⬜ Pending |                                     |

**Verified**: Partial (code + tests verified, awaiting integration)
