# OPS-128: Email Attachment Sync Not Fetching from Microsoft Graph

| Field           | Value            |
| --------------- | ---------------- |
| **Status**      | Verifying        |
| **Type**        | Bug/Architecture |
| **Priority**    | P1-High          |
| **Created**     | 2025-12-23       |
| **Sessions**    | 1                |
| **Last Active** | 2025-12-23 12:00 |

---

## Description

95% of emails with `hasAttachments=true` have no stored attachment records in the database. The email sync process correctly marks emails as having attachments but is NOT downloading/storing the actual attachment data from Microsoft Graph API.

**Evidence:**

```sql
-- Database statistics
SELECT
  COUNT(*) FILTER (WHERE "hasAttachments" = true) as emails_with_flag,
  COUNT(*) FILTER (WHERE "hasAttachments" = true AND id IN (
    SELECT DISTINCT "emailId" FROM "EmailAttachment"
  )) as emails_with_stored_attachments
FROM "Email";

-- Results: 514 emails have hasAttachments=true, only 27 have actual stored attachments (~5%)
```

---

## Symptom Category

**Category C**: Fails Everywhere - This is by design, not an error. Attachments are intentionally NOT fetched during email sync.

---

## Investigation Summary

| Hypothesis                           | Verdict | Key Finding                                                                                              |
| ------------------------------------ | ------- | -------------------------------------------------------------------------------------------------------- |
| Email sync fetches attachments       | ❌      | `syncUserEmails` only fetches metadata including `hasAttachments` flag, NOT attachment content           |
| Attachment fetch is a background job | ❌      | No worker/background job exists for automatic attachment fetching                                        |
| Attachment fetch is on-demand        | ✅      | Attachments only fetched when: 1) User clicks sync button, 2) Thread assigned to case, 3) Email imported |
| Graph API integration working        | ✅      | Graph API calls are correct, the code works when triggered                                               |

---

## Root Cause

**Architectural Design Decision**: Attachments are intentionally lazy-loaded, not synced automatically.

### Current Flow:

1. **Email Sync** (`email-sync.service.ts:128-234`):
   - Syncs email metadata from Graph API
   - Sets `hasAttachments: true` flag on Email record
   - **Does NOT download attachment content**

2. **Attachment Triggers** (only 3 paths):
   - **Manual sync button**: User clicks "Sync Attachments" in MessageView → calls `syncEmailAttachments` mutation
   - **Thread assignment**: `assignThreadToCase` resolver (lines 1039-1072) → syncs attachments for all emails in thread
   - **Bulk import**: `email-to-case.service.ts` (lines 368-410) → syncs if `importAttachments: true` AND `accessToken` available

3. **Missing Automatic Path**:
   - No background worker automatically syncs attachments when emails arrive
   - Email categorization worker does NOT trigger attachment sync
   - Webhook handler queues email processing but never processes the queue

### Evidence from Code:

**Email sync only fetches metadata** (`email-sync.service.ts:71-88`):

```typescript
const EMAIL_SELECT_FIELDS = [
  'id',
  'conversationId',
  'internetMessageId',
  'subject',
  'bodyPreview',
  'body',
  'from',
  'toRecipients',
  'ccRecipients',
  'bccRecipients',
  'receivedDateTime',
  'sentDateTime',
  'hasAttachments', // Only the boolean flag!
  'importance',
  'isRead',
  'internetMessageHeaders',
].join(',');
```

**Attachment sync is triggered only on-demand** (`email-attachment.service.ts:238-245`):

```typescript
if (!email || !email.hasAttachments) {
  logger.info('syncAllAttachments: No email or no attachments flag', {...});
  return result;  // Returns empty result, never called automatically
}
```

---

## Recommended Fix

### Option A: Auto-sync on case assignment (Recommended)

Add attachment sync to email categorization when email gets assigned to a case:

1. Modify email categorization worker (`email-categorization.worker.ts`)
2. After `updateMany` assigns caseId, trigger `syncAllAttachments` for emails with `hasAttachments: true`
3. Requires: User's access token (may need to store refresh token or use app-only token)

### Option B: Background worker for attachment sync

Create a new worker that:

1. Queries emails with `hasAttachments=true` AND no EmailAttachment records
2. Syncs attachments in batches
3. Requires: Service account or stored refresh tokens

### Option C: Sync on email view (lazy-load)

Modify UI to:

1. Check if email has `hasAttachments=true` but no EmailAttachment records
2. Auto-trigger sync when user opens email detail
3. Simpler but delays attachment availability

### Recommended: Option A

Most aligned with existing flow - sync attachments when email is categorized to a case, as that's when attachments become useful.

---

## Fix Applied

**Implementation**: Modified `Email.attachments` resolver to auto-sync attachments when:

1. Email has `hasAttachments=true` flag
2. Email is assigned to a case (`caseId` is set)
3. No `EmailAttachment` records exist yet
4. User has valid `accessToken` in context

**File**: `services/gateway/src/graphql/resolvers/email.resolvers.ts` (lines 2472-2510)

**Behavior**:

- When frontend requests attachments for a case-assigned email, the resolver checks if attachments need syncing
- If sync is needed, it triggers `syncAllAttachments` using the user's token
- Errors are logged but don't fail the request (graceful degradation)
- After sync, attachments are returned from the database

**Why this works**:

- Automatically syncs attachments when user views email data
- No background worker token issues (uses user's live token)
- Lazy-loading pattern - only syncs when attachments are actually requested
- Works for both new classifications and existing unsynced emails

---

## Environment Strategy

| Mode                   | Command                        | Use When                     |
| ---------------------- | ------------------------------ | ---------------------------- |
| Local dev (default)    | `pnpm dev`                     | Feature development          |
| Production data        | `source .env.prod && pnpm dev` | Bug investigation, real data |
| Production-like Docker | `pnpm preview`                 | Pre-deploy verification      |
| Full parity check      | `pnpm preflight:full`          | Before any deployment        |

**Recommended for this issue**: Production data (for verification with real emails)

---

## Local Verification Status

| Step           | Status     | Date       | Notes                  |
| -------------- | ---------- | ---------- | ---------------------- |
| Prod data test | ⬜ Pending |            |                        |
| Preflight      | ✅ Passed  | 2025-12-23 | Quick preflight passed |
| Docker test    | ⬜ Pending |            |                        |

**Verified**: No

> ⚠️ Issue cannot be closed until all three steps are ✅

---

## Session Log

- [2025-12-23 12:00] Issue created via /ops-investigate. Category: C (Fails Everywhere by Design). Root cause: Architectural decision - attachments are lazy-loaded, not auto-synced.
- [2025-12-23 12:15] Implemented Option A (modified): Auto-sync in `Email.attachments` resolver when viewing case-assigned emails. Preflight passed.

---

## Files Involved

**Email Sync (metadata only)**:

- `services/gateway/src/services/email-sync.service.ts` - Lines 71-88 (fields), 128-234 (sync method)

**Attachment Sync (on-demand)**:

- `services/gateway/src/services/email-attachment.service.ts` - Lines 212-611 (syncAllAttachments)

**Trigger Points**:

- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - Lines 1039-1072 (assignThreadToCase)
- `services/gateway/src/services/email-to-case.service.ts` - Lines 368-410 (bulk import)

**Missing Auto-Trigger**:

- `services/gateway/src/workers/email-categorization.worker.ts` - No attachment sync after categorization

---
