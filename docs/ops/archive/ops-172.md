# OPS-172: Document Status Enum Extension

**Type**: Feature
**Priority**: P1-High
**Status**: Complete
**Epic**: Documents Separation & Review Workflow (OPS-171 to OPS-177)

## Problem

Current `DocumentStatus` enum only has basic states (`DRAFT`, `PENDING`, `FINAL`, `ARCHIVED`). The review workflow requires additional states to track:

- When a document is submitted for supervisor review
- When a supervisor requests changes

## Solution

Extend `DocumentStatus` enum with `IN_REVIEW` and `CHANGES_REQUESTED` states.

## Implementation

### 1. Update DocumentStatus enum in Prisma schema

```prisma
enum DocumentStatus {
  DRAFT              // Working copy, editable
  IN_REVIEW          // Submitted for supervisor review
  CHANGES_REQUESTED  // Supervisor requested modifications
  PENDING            // Legacy - awaiting processing
  FINAL              // Approved, locked
  ARCHIVED           // Historical, not active
}
```

### 2. Create migration

```bash
pnpm prisma migrate dev --name extend_document_status_enum
```

### 3. Update GraphQL enum

```graphql
enum DocumentStatus {
  DRAFT
  IN_REVIEW
  CHANGES_REQUESTED
  PENDING
  FINAL
  ARCHIVED
}
```

### 4. Add status transition validation

Create helper function to validate allowed transitions:

```typescript
const ALLOWED_TRANSITIONS: Record<DocumentStatus, DocumentStatus[]> = {
  DRAFT: ['IN_REVIEW', 'ARCHIVED'],
  IN_REVIEW: ['CHANGES_REQUESTED', 'FINAL', 'DRAFT'], // DRAFT if withdrawn
  CHANGES_REQUESTED: ['DRAFT', 'IN_REVIEW', 'ARCHIVED'],
  PENDING: ['DRAFT', 'FINAL', 'ARCHIVED'],
  FINAL: ['ARCHIVED'],
  ARCHIVED: ['DRAFT'], // Can restore to draft
};

function validateStatusTransition(from: DocumentStatus, to: DocumentStatus): boolean {
  return ALLOWED_TRANSITIONS[from]?.includes(to) ?? false;
}
```

## Files to Modify

- `packages/database/prisma/schema.prisma` - extend enum
- `services/gateway/src/graphql/schema/enums.graphql` - update enum
- `services/gateway/src/services/document.service.ts` - add transition validation (if exists)

## Dependencies

None - can run in parallel with OPS-171.

## Acceptance Criteria

- [x] DocumentStatus enum includes IN_REVIEW and CHANGES_REQUESTED
- [x] Migration runs successfully without data loss
- [x] GraphQL enum updated
- [x] Status transition validation helper created
- [x] Existing documents unaffected (remain in their current status)

## Notes

This is a foundational issue. The review workflow (OPS-177) depends on these status values existing.

## Status Flow Diagram

```
                    ┌──────────────────────────────────┐
                    │                                  │
                    ▼                                  │
┌─────────┐    ┌───────────┐    ┌───────────────────┐  │
│  DRAFT  │───▶│ IN_REVIEW │───▶│ CHANGES_REQUESTED │──┘
└────┬────┘    └─────┬─────┘    └───────────────────┘
     │               │
     │               ▼
     │         ┌───────────┐    ┌───────────┐
     │         │   FINAL   │───▶│ ARCHIVED  │
     │         └───────────┘    └───────────┘
     │                                ▲
     └────────────────────────────────┘
```
