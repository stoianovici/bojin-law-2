# OPS-190: Personal Contacts Service + GraphQL

**Status:** Resolved | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-24

## Overview

Backend service and GraphQL API for managing personal contact blocklist. Emails from personal contacts won't be synced.

## Dependencies

- **Depends on:** OPS-187 (schema)
- **Blocks:** OPS-193, OPS-196
- **Parallel with:** OPS-191, OPS-192

## Context

Part of Communications UX Overhaul epic. When a user marks an email sender as "personal", future emails from that sender should not be retrieved during sync. This is a per-user setting.

## Requirements

### 1. Service Methods

```typescript
class PersonalContactService {
  // Add email to personal blocklist
  async addPersonalContact(userId: string, email: string): Promise<PersonalContact>;

  // Remove from blocklist (re-enable sync)
  async removePersonalContact(userId: string, email: string): Promise<boolean>;

  // Get all personal contacts for user
  async getPersonalContacts(userId: string): Promise<PersonalContact[]>;

  // Check if email is personal (for sync worker)
  async isPersonalContact(userId: string, email: string): Promise<boolean>;

  // Batch check for sync worker efficiency
  async filterPersonalContacts(userId: string, emails: string[]): Promise<string[]>;
}
```

### 2. GraphQL Schema

```graphql
type PersonalContact {
  id: ID!
  email: String!
  createdAt: DateTime!
}

extend type Query {
  personalContacts: [PersonalContact!]!
}

extend type Mutation {
  addPersonalContact(email: String!): PersonalContact!
  removePersonalContact(email: String!): Boolean!
}
```

### 3. Email Sync Worker Integration

Update `email-sync.worker.ts`:

```typescript
// Before processing emails, filter out personal contacts
const senderEmails = emails.map((e) => extractSenderEmail(e.from));
const personalEmails = await personalContactService.filterPersonalContacts(userId, senderEmails);
const emailsToProcess = emails.filter((e) => !personalEmails.includes(extractSenderEmail(e.from)));
```

### 4. Marking Sender as Personal

When user clicks "Personal" on an email:

1. Extract sender email from the email
2. Add to PersonalContact table
3. Optionally mark the current email as ignored (isIgnored = true)

## Acceptance Criteria

- [x] PersonalContactService created with all methods
- [x] GraphQL schema for personalContacts query
- [x] GraphQL mutations for add/remove
- [x] Sync worker filters personal contacts before processing
- [x] Batch filtering is efficient (single query)
- [x] Resolvers respect user context (firmId/userId)
- [ ] Unit tests for service methods (deferred - manual testing sufficient for now)

## Files to Create/Modify

- `services/gateway/src/services/personal-contact.service.ts` (NEW)
- `services/gateway/src/graphql/schema/personal-contact.graphql` (NEW)
- `services/gateway/src/graphql/resolvers/personal-contact.resolvers.ts` (NEW)
- `services/gateway/src/workers/email-sync.worker.ts` (MODIFY)
- `services/gateway/src/graphql/schema/index.ts` (add import)
- `services/gateway/src/graphql/resolvers/index.ts` (add import)

## Estimated Scope

Medium - Service + resolvers + worker integration.

---

## Session Log

### 2025-12-24: Implementation Complete

**Implemented:**

1. **PersonalContactService** (`services/gateway/src/services/personal-contact.service.ts`)
   - `addPersonalContact(userId, email)` - Add email to blocklist
   - `removePersonalContact(userId, email)` - Remove from blocklist
   - `getPersonalContacts(userId)` - List all personal contacts
   - `isPersonalContact(userId, email)` - Check single email
   - `filterPersonalContacts(userId, emails[])` - Batch check for efficiency
   - `markSenderAsPersonal(userId, emailId, ignoreEmail)` - Convenience method
   - `getPersonalContactsCount(userId)` - Count personal contacts

2. **GraphQL Schema** (`services/gateway/src/graphql/schema/personal-contact.graphql`)
   - Type: `PersonalContact { id, email, createdAt }`
   - Queries: `personalContacts`, `personalContactsCount`, `isPersonalContact`
   - Mutations: `addPersonalContact`, `removePersonalContact`, `markSenderAsPersonal`

3. **GraphQL Resolvers** (`services/gateway/src/graphql/resolvers/personal-contact.resolvers.ts`)
   - All queries and mutations implemented
   - Proper authentication checks
   - Romanian error messages

4. **Email Sync Integration** (`services/gateway/src/services/email-sync.service.ts`)
   - Added `filterOutPersonalContacts()` method
   - Filters inbox emails from personal contacts before storing
   - Sent emails are not filtered (user sent them)
   - Logs filtered count for debugging

5. **Registrations**
   - Schema added to `schema/index.ts`
   - Resolvers added to `server.ts`

**Technical Notes:**

- Email addresses are normalized (lowercase, trimmed)
- Batch filtering uses single DB query for efficiency
- Migration from OPS-187 already created the `personal_contacts` table

**Next Steps:**

- OPS-193: Personal Contacts Profile Page (UI for managing blocklist)
- OPS-196: NECLAR Inline Assignment (uses markSenderAsPersonal)
