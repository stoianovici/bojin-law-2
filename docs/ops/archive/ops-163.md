# [OPS-163] Click-to-Preview Documents with File-Type Actions

**Type**: Feature
**Priority**: P2-Medium
**Status**: Complete
**Created**: 2024-12-24

## Description

Improve document interaction in both grid and list views:

1. **Click anywhere on document card/row** should open the preview modal (currently requires clicking specific preview button)
2. **Remove dedicated preview button** - the entire card becomes the clickable preview trigger
3. **Simplify available actions** based on file type:
   - **PDF documents**: Only "Adaugă în mapă" action
   - **DOCX documents**: "Adaugă în mapă" + "Deschide în Word" (with version tracking)

## Current Behavior

- **DocumentCard in DocumentsContentPanel.tsx (lines 134-283)**:
  - Click on card → selects the document (sets `selectedDocumentId`)
  - Preview button (Eye icon) → opens preview modal
  - Add to mapa button → opens mapa assignment modal
  - Download button → downloads file

- **DocumentCard in DocumentCard.tsx (lines 149-425)**:
  - Entire card is non-clickable for preview
  - Has hover overlay with preview/download buttons
  - Has action buttons below the card (Previzualizare, Descarcă, Adaugă în mapă)

## Proposed Changes

### 1. DocumentsContentPanel.tsx - DocumentCard Component (Grid/List)

```tsx
// Grid view - line ~221-283
// List view - line ~166-217

// Change: onClick should trigger preview instead of selection
onClick={() => handlePreview(doc)}  // Instead of: onClick={onSelect}

// Remove: Preview button from both views
// Remove: Eye icon button (onPreview click handler)

// Keep: Add to mapa button (for all file types)
// Conditionally show: "Open in Word" for DOCX files
```

### 2. File-Type Based Actions

```tsx
// Helper to check if file is Word document
function isWordDocument(fileType: string): boolean {
  const type = fileType.toLowerCase();
  return (
    type.includes('doc') ||
    type.includes('word') ||
    type.includes('application/vnd.openxmlformats-officedocument.wordprocessingml')
  );
}

// Helper to check if file is PDF
function isPdfDocument(fileType: string): boolean {
  return fileType.toLowerCase().includes('pdf');
}
```

### 3. Action Buttons

**For PDF files:**

- "Adaugă în mapă" (existing)

**For DOCX files:**

- "Adaugă în mapă" (existing)
- "Deschide în Word" (new) - opens document in Microsoft Word with version tracking

### 4. Open in Word Implementation

The "Open in Word" action should:

1. Use Office Online URL if document is stored in SharePoint/OneDrive
2. Or download and open locally for R2 storage
3. Track document version (existing functionality)

## Files to Modify

1. **apps/web/src/components/documents/DocumentsContentPanel.tsx**
   - Modify DocumentCard component (lines 134-283)
   - Change click behavior: card click → preview
   - Remove preview button
   - Add file-type conditional rendering for actions

2. **apps/web/src/components/documents/DocumentCard.tsx** (if used elsewhere)
   - Same modifications as above
   - May need to add "Open in Word" action

3. **apps/web/src/components/preview/DocumentPreviewModal.tsx**
   - Ensure actions are properly filtered by file type
   - Add "Open in Word" action for DOCX

4. **apps/web/src/hooks/usePreviewActions.ts**
   - Add file-type filtering logic
   - Add "open-in-word" action definition

## Implementation Notes

- The `handlePreview` function already exists and works correctly
- Selection behavior can be removed or moved to checkbox/selection mode
- Consider whether download button should remain or be moved to preview modal only
- "Open in Word" requires checking storage type for proper URL handling

## Testing

- [x] Grid view: Click anywhere on card opens preview
- [x] List view: Click anywhere on row opens preview
- [x] PDF: Only "Mapă" action visible in card/row
- [x] DOCX: Both "Mapă" and "Word" actions visible in card/row
- [x] XLSX: Both "Mapă" and "Word" actions visible (treated as Office document)
- [x] Preview button no longer appears in card/row
- [x] All existing preview functionality still works
- [x] Preview modal shows full action toolbar (download available there)

## Implementation Summary

### Changes Made

1. **DocumentsContentPanel.tsx**:
   - Changed card/row `onClick` from selection to preview trigger
   - Removed Eye/preview button from both grid and list views
   - Added `isWordDocument()` helper function
   - Added file-type conditional actions (Mapă for all, Word for DOCX/XLSX)
   - Added `handleOpenInWord()` to open documents in Office Online
   - Removed unused `selectedDocumentId` and `setSelectedDocument`

2. **DocumentCard.tsx** (standalone component):
   - Made entire card clickable for preview
   - Removed hover overlay with preview/download buttons
   - Removed `onDownload` and `isDownloading` props
   - Added `onOpenInWord` prop for Word documents
   - Added file-type conditional action buttons

3. **DocumentGrid.tsx**:
   - Removed `onDownload` and `downloadingId` props
   - Added `onOpenInWord` prop passthrough

4. **CaseDocumentsList.tsx**:
   - Updated to match new DocumentGrid interface
   - Removed unused `handleGridDownload` function

## OPS-164: Fix Word Button to Open Desktop Word

### Issue

The Word button was incorrectly using `fetchPreviewUrl()` which returns a OneDrive preview URL instead of opening the document in Microsoft Word desktop app.

### Root Cause

- `handleOpenInWord()` called `fetchPreviewUrl()` which returns preview URLs
- The `openInWord` GraphQL mutation existed in schema but had no resolver implementation

### Fix (2024-12-24)

1. **Created `word-integration.resolvers.ts`**:
   - Implemented `openInWord` mutation resolver
   - Uses `wordIntegrationService.openInWord()` to generate `ms-word:ofe|u|{graphApiUrl}` protocol URL
   - Handles document locking for concurrent edit protection

2. **Registered resolver in `server.ts`**:
   - Added import and spread for `wordIntegrationResolvers`

3. **Updated `useDocumentPreview.ts`**:
   - Added `OPEN_IN_WORD` GraphQL mutation
   - Added `openInWord()` function that calls the mutation

4. **Fixed `handleOpenInWord()` in `DocumentsContentPanel.tsx`**:
   - Changed from `fetchPreviewUrl()` to `openInWordMutation()`
   - Uses temporary anchor click method for reliable protocol handler triggering
   - `window.location.href` was unreliable for custom protocols in some browsers

### Testing

- [x] Word button generates `ms-word:ofe|u|...` URL
- [x] Anchor click method triggers protocol handler
- [x] Desktop Word opens with document (if Word installed)
- [x] Falls back to Word Online if desktop Word not available
