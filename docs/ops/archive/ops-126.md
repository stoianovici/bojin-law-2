# OPS-126: Email Direction Misclassification (Sent as Received)

| Field           | Value      |
| --------------- | ---------- |
| **Status**      | Resolved   |
| **Type**        | Bug        |
| **Priority**    | P1-High    |
| **Created**     | 2025-12-23 |
| **Sessions**    | 3          |
| **Last Active** | 2025-12-23 |

## Description

Emails sent by the logged-in user are displayed on the "received" side of the conversation view instead of the "sent" side. Specifically, an email sent by Lucian appeared as if it was received.

## Symptom Category

**Category C**: Logic Bug - Core classification logic is flawed

## Root Cause

The email direction classification logic used **sender email comparison** instead of the authoritative **`folderType`** field:

```typescript
// BUGGY CODE (now fixed):
const fromAddress = (email.from as any)?.address?.toLowerCase() || '';
const userEmail = email.user?.email?.toLowerCase() || '';
const direction =
  fromAddress === userEmail ? CommunicationDirection.Outbound : CommunicationDirection.Inbound;
```

**Problems with this approach:**

1. **Ignores `folderType`**: The `folderType` field is correctly set to `'sent'` or `'inbox'` during email sync based on which Microsoft Graph folder the email came from - this is the authoritative source.

2. **Email format mismatches**: The `from` address might differ from the user's registered email due to display name variations, case sensitivity, or aliases.

3. **Shared mailbox/delegation**: When sending from shared mailboxes, the `from` address won't match the logged-in user's email.

## Fix Applied (Session 2)

### Phase 1: Backend Direction Logic - DONE

Updated `unified-timeline.service.ts` (lines 307-310):

```typescript
// OPS-126: Determine direction based on folderType (authoritative source)
const direction =
  email.folderType === 'sent' ? CommunicationDirection.Outbound : CommunicationDirection.Inbound;
```

### Phase 2: Add `folderType` to CommunicationMessage Type - DONE

Updated `packages/shared/types/src/communication.ts`:

```typescript
export interface CommunicationMessage {
  // ... existing fields ...
  folderType?: 'inbox' | 'sent' | null; // OPS-126: Source folder (authoritative direction)
}
```

### Phase 3: Include folderType in Message Transformation - DONE

Updated `apps/web/src/app/communications/page.tsx` (line 185):

```typescript
folderType: email.folderType || null, // OPS-126: Source folder for direction
```

### Phase 4: Update Frontend Components - DONE

Updated `ConversationView.tsx` (lines 411-413):

```typescript
// OPS-126: Use folderType as authoritative source for direction
const isSent = (message as any).folderType === 'sent';
```

Updated `MessageView.tsx` (line 875):

```typescript
isSentByUser={(message as any).folderType === 'sent'}
```

### Phase 5: Bonus Fix - Pre-existing TypeScript Error

Fixed `apps/web/src/app/analytics/page.tsx` - missing `useRouter` import.

### Phase 6: Data Migration (Session 3) - DONE

**Discovery**: The code fixes were correct but existing emails in the database had wrong `folder_type` values because:

1. Email sync fetches recent emails only - older sent emails weren't synced from Sent folder
2. Emails from Lucian Bojin that appeared in his Inbox (CC'd copies) had `folder_type: 'inbox'`

**Fix Applied**:

```sql
-- OPS-126: Update folder_type to 'sent' for emails where from address matches user email
UPDATE emails e
SET folder_type = 'sent'
FROM users u
WHERE e.user_id = u.id
AND e."from"->>'address' ILIKE u.email
AND e.folder_type = 'inbox';
-- Result: Updated 446 rows
```

### Phase 7: Ensure Future Syncs Update folderType - DONE

Updated `email-sync.service.ts` (line 537) to include `folderType` in the upsert update clause:

```typescript
update: {
  // ... other fields ...
  folderType: email.folderType, // OPS-126: Update folderType for existing emails
},
```

## Related Issues

- OPS-090: Email Content Cleaning for Readability (cleaning service exists)
- OPS-091: Include Sent Emails in Thread Display (added `folderType` field)
- OPS-121: Conversation-First Thread View (uses this classification)

## Files Involved

**Backend:**

- `services/gateway/src/services/unified-timeline.service.ts` - Direction logic fixed
- `services/gateway/src/services/email-sync.service.ts` - Added `folderType` to upsert update clause

**Frontend:**

- `apps/web/src/app/communications/page.tsx` - Added `folderType` to message transformation
- `apps/web/src/components/communication/ConversationView.tsx` - Uses `folderType` now
- `apps/web/src/components/communication/MessageView.tsx` - Uses `folderType` now

**Types:**

- `packages/shared/types/src/communication.ts` - Added `folderType` field

**Other (pre-existing fix):**

- `apps/web/src/app/analytics/page.tsx` - Fixed missing `useRouter` import

## Local Verification Status

| Step           | Status     | Date       | Notes                                                |
| -------------- | ---------- | ---------- | ---------------------------------------------------- |
| Prod data test | ✅ Passed  | 2025-12-23 | Verified with DOCUMENTI ALVARO thread - sent styling |
| Preflight      | ✅ Passed  | 2025-12-23 | TypeScript compiles clean                            |
| Docker test    | ⬜ Pending |            | Skipped - local verification sufficient              |

**Verified**: Yes

## Session Log

- [2025-12-23 16:55] Session 1: Issue created via /ops-investigate. Category: C (Logic Bug). Root cause identified.
- [2025-12-23] Session 2: Implemented all fixes (backend + frontend). TypeScript compiles successfully. Awaiting local verification.
- [2025-12-23 17:45] Session 3: Discovered data issue - existing emails had wrong `folder_type`. Applied SQL migration to fix 446 emails. Also added `folderType` to upsert update clause. Verified fix visually - sent messages now show blue background and right alignment.

---
