# OPS-061: Multi-Case Email Data Migration

| Field           | Value       |
| --------------- | ----------- |
| **Status**      | Implemented |
| **Type**        | Feature     |
| **Priority**    | P1-High     |
| **Created**     | 2025-12-20  |
| **Sessions**    | 1           |
| **Last Active** | 2025-12-20  |
| **Depends On**  | OPS-058     |

## Description

Migrate existing email classification data from the single `caseId` foreign key to the new `EmailCaseLink` junction table. This must preserve all existing classifications while enabling multi-case support.

## Migration Strategy

### Phase 1: Add New Table (Non-Breaking)

```sql
-- Create EmailCaseLink table
CREATE TABLE email_case_links (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email_id UUID NOT NULL REFERENCES emails(id) ON DELETE CASCADE,
  case_id UUID NOT NULL REFERENCES cases(id) ON DELETE CASCADE,
  confidence FLOAT,
  match_type TEXT,
  linked_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  linked_by TEXT NOT NULL,
  is_primary BOOLEAN NOT NULL DEFAULT FALSE,
  UNIQUE(email_id, case_id)
);

CREATE INDEX idx_email_case_links_email_id ON email_case_links(email_id);
CREATE INDEX idx_email_case_links_case_id ON email_case_links(case_id);
```

### Phase 2: Migrate Existing Data

```sql
-- Copy existing email-case relationships to junction table
INSERT INTO email_case_links (
  email_id,
  case_id,
  confidence,
  match_type,
  linked_at,
  linked_by,
  is_primary
)
SELECT
  id AS email_id,
  case_id,
  classification_confidence AS confidence,
  -- Map classifiedBy to match_type
  CASE
    WHEN classified_by = 'auto' THEN 'CONTACT_MATCH'
    WHEN classified_by = 'thread_continuity' THEN 'THREAD_CONTINUITY'
    ELSE 'MANUAL'
  END AS match_type,
  COALESCE(classified_at, NOW()) AS linked_at,
  COALESCE(classified_by, 'migration') AS linked_by,
  TRUE AS is_primary  -- All existing classifications are primary
FROM emails
WHERE case_id IS NOT NULL;
```

### Phase 3: Verify Migration

```sql
-- Verify all emails with caseId have corresponding EmailCaseLink
SELECT COUNT(*) AS emails_with_case FROM emails WHERE case_id IS NOT NULL;
SELECT COUNT(*) AS email_case_links FROM email_case_links;
-- These counts should match

-- Verify no orphaned links
SELECT ecl.* FROM email_case_links ecl
LEFT JOIN emails e ON ecl.email_id = e.id
WHERE e.id IS NULL;
-- Should return 0 rows
```

### Phase 4: Remove Old Column (After Code Deployed)

```sql
-- Only run AFTER all code uses EmailCaseLink
ALTER TABLE emails DROP COLUMN case_id;
```

## Prisma Migration

```typescript
// packages/database/prisma/migrations/YYYYMMDD_multi_case_email/migration.sql

-- CreateTable
CREATE TABLE "email_case_links" (
    "id" UUID NOT NULL DEFAULT uuid_generate_v4(),
    "email_id" UUID NOT NULL,
    "case_id" UUID NOT NULL,
    "confidence" DOUBLE PRECISION,
    "match_type" TEXT,
    "linked_at" TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    "linked_by" TEXT NOT NULL,
    "is_primary" BOOLEAN NOT NULL DEFAULT false,

    CONSTRAINT "email_case_links_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE INDEX "email_case_links_email_id_idx" ON "email_case_links"("email_id");
CREATE INDEX "email_case_links_case_id_idx" ON "email_case_links"("case_id");
CREATE UNIQUE INDEX "email_case_links_email_id_case_id_key" ON "email_case_links"("email_id", "case_id");

-- AddForeignKey
ALTER TABLE "email_case_links" ADD CONSTRAINT "email_case_links_email_id_fkey"
  FOREIGN KEY ("email_id") REFERENCES "emails"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "email_case_links" ADD CONSTRAINT "email_case_links_case_id_fkey"
  FOREIGN KEY ("case_id") REFERENCES "cases"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- Migrate existing data
INSERT INTO email_case_links (email_id, case_id, confidence, match_type, linked_at, linked_by, is_primary)
SELECT
  id, case_id, classification_confidence,
  CASE
    WHEN classified_by = 'auto' THEN 'CONTACT_MATCH'
    WHEN classified_by LIKE '%thread%' THEN 'THREAD_CONTINUITY'
    ELSE 'MANUAL'
  END,
  COALESCE(classified_at, NOW()),
  COALESCE(classified_by, 'migration'),
  true
FROM emails WHERE case_id IS NOT NULL;
```

## Rollback Plan

If migration fails:

```sql
-- Rollback: Delete all migrated links
DELETE FROM email_case_links WHERE linked_by = 'migration';

-- Rollback: Drop table if needed
DROP TABLE IF EXISTS email_case_links;
```

## Files to Modify

| File                                     | Changes                    |
| ---------------------------------------- | -------------------------- |
| `packages/database/prisma/schema.prisma` | Already updated in OPS-058 |
| `packages/database/prisma/migrations/`   | New migration file         |

## Acceptance Criteria

- [x] EmailCaseLink table created with indexes
- [x] All existing email-case relationships migrated
- [x] Migration count matches source count (82 = 82)
- [x] No orphaned EmailCaseLink records (verified 0 orphans)
- [ ] Rollback tested and works
- [x] Email.caseId column retained until all code migrated

## Testing Plan

1. **Local test with production data**:

   ```bash
   source .env.prod && pnpm dev
   # Run migration
   pnpm prisma migrate dev
   # Verify counts
   ```

2. **Staging test**:
   - Deploy migration to staging
   - Verify all cases show correct emails
   - Test email classification creates links

3. **Production**:
   - Schedule maintenance window
   - Run migration
   - Verify counts
   - Monitor for errors

## Local Verification Status

| Step           | Status     | Date       | Notes                            |
| -------------- | ---------- | ---------- | -------------------------------- |
| Prod data test | ✅ Passed  | 2025-12-20 | Local DB with 82 emails migrated |
| Preflight      | ⬜ Pending |            |                                  |
| Docker test    | ⬜ Pending |            |                                  |

**Verified**: Partial (migration logic verified, awaiting full preflight)

## Session Log

- [2025-12-20] Issue created as part of multi-case email feature set.
- [2025-12-20] Session 1: Added data migration SQL to migration file. Fixed ClassificationMatchType enum creation (was missing). Updated match_type mapping: 'contact_match' and 'migration' → Actor, '%thread%' → ThreadContinuity, '%manual%' → Manual. Migration verified locally: 82 emails with case_id = 82 email_case_links, 0 orphans.

---
