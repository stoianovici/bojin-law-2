# OPS-121: Conversation-First Thread View

**Type:** Feature
**Priority:** P1-High
**Status:** Verified
**Created:** 2025-12-23
**Epic:** Communications UX Overhaul
**Sessions:** 2
**Last Active:** 2025-12-23

## Problem

The current MessageView displays email threads as expandable/collapsible cards. Even with OPS-090's clean content (removing signatures and quoted text), users must:

- Click to expand individual messages
- Mentally reconstruct the conversation flow
- Lose the "back-and-forth" visual rhythm

This makes it hard to quickly scan a conversation and understand the dialogue.

## Context

- OPS-090 implemented `bodyContentClean` - individual messages are clean
- OPS-091 added sent email display with visual distinction
- Current pattern: N separate cards with expand/collapse
- Target: Chat-style flowing conversation view (like Outlook/Gmail conversation view)

## Solution

Create a new `ConversationView` component that displays threads as a chat-style conversation:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contract Review â€¢ Dosar: ABC SRL vs DEF SRL                  â”‚
â”‚ 4 mesaje â€¢ Ion Popescu, Maria Ionescu, Dvs.                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€ Ion Popescu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 20 dec, 10:30 â”€â”        â”‚
â”‚  â”‚ VÄƒ rog sÄƒ revizuiÈ›i contractul ataÈ™at.          â”‚        â”‚
â”‚  â”‚ Termenul este 15 ianuarie.                       â”‚        â”‚
â”‚  â”‚                                    ðŸ“Ž Contract.pdfâ”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                              â”‚
â”‚        â”Œâ”€ Maria Ionescu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 20 dec, 14:22 â”€â”        â”‚
â”‚        â”‚ Am verificat. Clauza 3.1 necesitÄƒ          â”‚        â”‚
â”‚        â”‚ modificÄƒri.                                 â”‚        â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                              â”‚
â”‚                 â”Œâ”€ Dvs. â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 20 dec, 16:45 â”€â”     â”‚
â”‚                 â”‚ Am fÄƒcut modificÄƒrile.                â”‚     â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€ Ion Popescu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 21 dec, 09:15 â”€â”        â”‚
â”‚  â”‚ O observaÈ›ie la clauza 4.2...                    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ RÄƒspunde...                                [Send] â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Design Elements

1. **Chat-style bubbles with alternating indent**
   - Received messages: left-aligned
   - Sent messages (Dvs.): right-aligned or deeper indent + blue tint
   - Creates visual "ping-pong" for scannable back-and-forth

2. **All messages visible by default**
   - No expand/collapse needed
   - Uses `bodyContentClean` for compact display
   - Continuous scroll for long threads

3. **Inline attachment chips**
   - Small attachment badge at bottom-right of bubble
   - Click triggers attachment preview panel (OPS-122)
   - Shows file icon + name

4. **Collapsed quotes indicator**
   - When message contains quoted text that was cleaned:

   ```
   â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”
   â”‚ 2 mesaje anterioare citate   [AratÄƒ] â”‚
   â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜
   ```

5. **Inline reply box**
   - Always visible at bottom
   - Opens ComposeInterface on focus

## Implementation

### New Components

```
apps/web/src/components/communication/
â”œâ”€â”€ ConversationView.tsx       # Main container
â”œâ”€â”€ ConversationBubble.tsx     # Individual message bubble
â”œâ”€â”€ ConversationHeader.tsx     # Thread subject, participants, case
â””â”€â”€ QuotedTextIndicator.tsx    # Collapsed quotes toggle
```

### ConversationView.tsx Structure

```tsx
interface ConversationViewProps {
  thread: CommunicationThread;
  onReply: () => void;
  onAttachmentClick: (attachment: Attachment) => void;
  userEmail: string;
}

export function ConversationView({
  thread,
  onReply,
  onAttachmentClick,
  userEmail,
}: ConversationViewProps) {
  // Sort messages chronologically (oldest first for conversation flow)
  const sortedMessages = [...thread.messages].sort(
    (a, b) => new Date(a.sentDate).getTime() - new Date(b.sentDate).getTime()
  );

  return (
    <div className="flex flex-col h-full">
      <ConversationHeader thread={thread} />

      <div className="flex-1 overflow-y-auto p-4 space-y-3">
        {sortedMessages.map((message) => (
          <ConversationBubble
            key={message.id}
            message={message}
            isSent={message.senderEmail?.toLowerCase() === userEmail.toLowerCase()}
            onAttachmentClick={onAttachmentClick}
          />
        ))}
      </div>

      <div className="border-t p-4">
        <button onClick={onReply} className="...">
          RÄƒspunde...
        </button>
      </div>
    </div>
  );
}
```

### ConversationBubble.tsx Structure

```tsx
interface ConversationBubbleProps {
  message: CommunicationMessage;
  isSent: boolean;
  onAttachmentClick: (attachment: Attachment) => void;
}

export function ConversationBubble({
  message,
  isSent,
  onAttachmentClick,
}: ConversationBubbleProps) {
  // Use clean content if available, fall back to body
  const content = message.bodyClean || message.body;

  return (
    <div className={clsx('max-w-[75%]', isSent ? 'ml-auto' : 'mr-auto')}>
      {/* Sender name + time */}
      <div className="flex items-center gap-2 text-xs text-gray-500 mb-1">
        <span className="font-medium">{isSent ? 'Dvs.' : message.senderName}</span>
        <span>{formatDate(message.sentDate)}</span>
      </div>

      {/* Message bubble */}
      <div
        className={clsx(
          'rounded-lg p-3',
          isSent ? 'bg-blue-50 border border-blue-200' : 'bg-white border border-gray-200 shadow-sm'
        )}
      >
        <div className="text-sm whitespace-pre-wrap">{content}</div>

        {/* Attachments */}
        {message.attachments?.length > 0 && (
          <div className="mt-2 flex flex-wrap gap-1">
            {message.attachments.map((att) => (
              <button
                key={att.id}
                onClick={() => onAttachmentClick(att)}
                className="inline-flex items-center gap-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded"
              >
                <Paperclip className="h-3 w-3" />
                {att.name}
              </button>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
```

## Acceptance Criteria

- [x] ConversationView component displays messages in chat-style bubbles
- [x] Sent messages (user's own) are visually distinct (right-aligned, blue tint)
- [x] All messages visible without clicking (no expand/collapse)
- [x] Uses `bodyContentClean` when available
- [x] Attachment chips visible inline, clickable
- [x] Messages sorted chronologically (oldest â†’ newest)
- [x] Thread header shows subject, case, participants
- [x] Reply button at bottom triggers compose
- [x] Smooth scrolling, auto-scroll to latest message
- [x] Toggle option to switch between ConversationView and classic MessageView

## Files to Modify

| File                                              | Change                                      |
| ------------------------------------------------- | ------------------------------------------- |
| `components/communication/ConversationView.tsx`   | **New**                                     |
| `components/communication/ConversationBubble.tsx` | **New**                                     |
| `components/communication/ConversationHeader.tsx` | **New**                                     |
| `app/communications/page.tsx`                     | Add view toggle, integrate ConversationView |
| `stores/communication.store.ts`                   | Add viewMode: 'conversation' \| 'cards'     |

## Dependencies

- OPS-090 (bodyContentClean) - âœ… Implemented
- OPS-091 (sent email display) - âœ… Implemented

## Related Issues

- OPS-122: Inline Attachment Preview Panel (attachments click handler)
- OPS-123: Thread-Level AI Summary (header enhancement)
- OPS-124: Three-Pane Communications Layout (page layout)

## Session Log

### Session 1 (2025-12-23)

- Created `ConversationBubble.tsx` - chat-style message bubble component with:
  - Left/right alignment for received/sent messages
  - Blue styling for sent messages
  - Clean content display with `bodyClean` fallback
  - Inline attachment chips with download support
  - Relative date formatting (today, yesterday, day name, date)
- Created `ConversationHeader.tsx` - compact thread header with:
  - Subject line
  - Case badge (amber for unassigned)
  - Participants list
  - Message counts (total + sent)
- Created `ConversationView.tsx` - main container with:
  - Chronological message display (oldest â†’ newest)
  - Auto-scroll to latest message
  - Unassigned email banner with assign/ignore actions
  - Reply button at bottom
  - Attach preview modal integration
  - Mark as processed action
  - Notify stakeholders integration
- Updated `communication.store.ts` - added:
  - `threadViewMode: 'conversation' | 'cards'`
  - `setThreadViewMode()` action
  - Persistence to localStorage
- Updated `communications/page.tsx`:
  - Added view toggle in header (Conversation / Cards)
  - Conditional render of `ConversationView` or `MessageView`
- Build passes, ready for local verification

#### Local Verification Status

| Step           | Status | Date       | Notes                          |
| -------------- | ------ | ---------- | ------------------------------ |
| Prod data test | âœ…     | 2025-12-23 | Tested with real email threads |
| Preflight      | âœ…     | 2025-12-23 | Build passes                   |
| Docker test    | â¬œ     | -          | Awaiting user verification     |

**Verified**: Yes (with bug fix)

### Verification Notes (2025-12-23)

**Bug Found & Fixed:**

- **Issue**: ConversationBubble displayed raw HTML/CSS code instead of readable text
- **Root cause**: `bodyClean` field is null for most emails, component falls back to raw `body` which contains HTML
- **Fix**: Added `stripHtmlForDisplay()` function in `ConversationBubble.tsx` that:
  - Uses DOMParser to properly parse HTML
  - Removes style/script elements
  - Extracts text content
  - Cleans up excessive whitespace
- **Location**: `apps/web/src/components/communication/ConversationBubble.tsx` lines 25-58, 97-103

**Working Features:**

- Chat-style message bubbles âœ…
- Sent/received visual distinction âœ…
- Chronological ordering âœ…
- Attachment chips with download âœ…
- Reply button âœ…
- View toggle (ConversaÈ›ie/Carduri) âœ…
