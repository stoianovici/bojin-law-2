# OPS-078: Error Handling & Fallbacks

**Status:** Implemented | **Priority:** P2-Medium | **Type:** Feature
**Created:** 2025-12-20 | **Depends on:** OPS-071, OPS-072, OPS-073, OPS-074, OPS-075, OPS-076

## Summary

Implement comprehensive error handling, fallback responses, and graceful degradation for the AI assistant.

## Background

The assistant needs to handle:

- Low confidence intent detection
- AI service failures
- Rate limiting
- Invalid user input
- Network errors
- Context loss recovery

## Requirements

### Error Categories

| Category       | Example            | User Message                              |
| -------------- | ------------------ | ----------------------------------------- |
| Low Confidence | Intent < 0.5       | "Nu am înțeles exact. Ați vrut să...?"    |
| Service Error  | AI timeout         | "A apărut o eroare. Încercați din nou."   |
| Rate Limit     | Too many requests  | "Prea multe cereri. Așteptați un moment." |
| Not Found      | Case doesn't exist | "Nu am găsit dosarul specificat."         |
| Permission     | No access          | "Nu aveți acces la această resursă."      |
| Network        | Connection failed  | "Verificați conexiunea la internet."      |

### Implementation

```typescript
// services/gateway/src/services/ai-orchestrator.service.ts

// ============================================================================
// Error Handling
// ============================================================================

class AssistantError extends Error {
  constructor(
    public code: string,
    public userMessage: string,
    public recoverable: boolean = true
  ) {
    super(userMessage);
  }
}

const ERROR_MESSAGES = {
  LOW_CONFIDENCE: 'Nu am înțeles exact ce doriți. Puteți reformula?',
  SERVICE_ERROR: 'A apărut o eroare temporară. Încercați din nou.',
  RATE_LIMIT: 'Prea multe cereri. Vă rugăm așteptați câteva secunde.',
  NOT_FOUND: 'Nu am găsit informația cerută.',
  NO_PERMISSION: 'Nu aveți permisiunea necesară pentru această acțiune.',
  NETWORK_ERROR: 'Verificați conexiunea la internet.',
  CONTEXT_LOST: 'Am pierdut contextul conversației. Să reluăm?',
};

// In processMessage:
async processMessage(...): Promise<OrchestratorResult> {
  try {
    // 1. Detect intent
    const { intent, confidence, params } = await this.detectIntent(message, context, history);

    // 2. Handle low confidence
    if (confidence < 0.5) {
      return this.handleLowConfidence(message, intent, confidence, params);
    }

    // 3. Route and execute
    const result = await this.routeIntent(intent, params, context, userContext);

    // 4. Generate response
    return await this.generateResponse(intent, result, context);

  } catch (error) {
    return this.handleError(error);
  }
}

private handleLowConfidence(
  message: string,
  intent: AssistantIntent,
  confidence: number,
  params: Record<string, unknown>
): OrchestratorResult {
  // Generate clarification options
  const suggestions = this.generateClarificationOptions(intent, params);

  return {
    intent: AssistantIntent.AskClarification,
    confidence,
    response: `Nu sunt sigur că am înțeles corect. Ați vrut să:\n${suggestions.map((s, i) => `${i + 1}. ${s}`).join('\n')}\n\nSau altceva?`,
    suggestedFollowUps: suggestions,
  };
}

private handleError(error: unknown): OrchestratorResult {
  console.error('Assistant error:', error);

  if (error instanceof AssistantError) {
    return {
      intent: AssistantIntent.GeneralChat,
      confidence: 1,
      response: error.userMessage,
      suggestedFollowUps: error.recoverable
        ? ['Încercați din nou', 'Ajutor']
        : [],
    };
  }

  // AI service errors
  if (error instanceof Error) {
    if (error.message.includes('rate limit') || error.message.includes('429')) {
      return {
        intent: AssistantIntent.GeneralChat,
        confidence: 1,
        response: ERROR_MESSAGES.RATE_LIMIT,
        suggestedFollowUps: [],
      };
    }

    if (error.message.includes('timeout') || error.message.includes('ECONNREFUSED')) {
      return {
        intent: AssistantIntent.GeneralChat,
        confidence: 1,
        response: ERROR_MESSAGES.SERVICE_ERROR,
        suggestedFollowUps: ['Încercați din nou'],
      };
    }
  }

  // Generic fallback
  return {
    intent: AssistantIntent.GeneralChat,
    confidence: 1,
    response: ERROR_MESSAGES.SERVICE_ERROR,
    suggestedFollowUps: ['Încercați din nou', 'Contactați suportul'],
  };
}

private generateClarificationOptions(
  intent: AssistantIntent,
  params: Record<string, unknown>
): string[] {
  switch (intent) {
    case AssistantIntent.CreateTask:
      return [
        'Creați o sarcină nouă',
        'Vedeți sarcinile existente',
        'Modificați o sarcină',
      ];
    case AssistantIntent.SearchEmails:
      return [
        'Căutați un email',
        'Vedeți emailurile recente',
        'Redactați un email',
      ];
    // ... other intents
    default:
      return [
        'Creați o sarcină',
        'Căutați în dosar',
        'Vedeți emailurile',
      ];
  }
}
```

### Frontend Error Display

```tsx
// In AssistantChat.tsx

{
  error && (
    <div className="mx-4 mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
      <p className="text-sm text-red-700">{error}</p>
      <button
        onClick={() => setError(null)}
        className="mt-2 text-xs text-red-600 hover:text-red-800"
      >
        Închide
      </button>
    </div>
  );
}
```

### Retry Logic

```typescript
// In useAssistant.ts

const sendMessage = useCallback(async (content: string, retryCount = 0) => {
  try {
    // ... send logic
  } catch (error) {
    if (retryCount < 2 && isRetryableError(error)) {
      await delay(1000 * (retryCount + 1)); // Exponential backoff
      return sendMessage(content, retryCount + 1);
    }
    throw error;
  }
}, []);

const isRetryableError = (error: unknown): boolean => {
  if (error instanceof Error) {
    return (
      error.message.includes('timeout') ||
      error.message.includes('network') ||
      error.message.includes('503')
    );
  }
  return false;
};
```

## Acceptance Criteria

- [x] Error categories defined with Romanian messages
- [x] Low confidence handling with clarification options
- [x] Service error fallbacks implemented
- [x] Rate limiting handled gracefully
- [x] Retry logic with exponential backoff
- [x] Frontend error display component
- [ ] Context recovery mechanism (deferred - requires additional design)
- [x] Logging for debugging
- [x] Unit tests for error scenarios

## Files to Modify

- `services/gateway/src/services/ai-orchestrator.service.ts`
- `apps/web/src/hooks/useAssistant.ts`
- `apps/web/src/components/assistant/AssistantChat.tsx`
- `apps/web/src/stores/assistant.store.ts`

#### Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

## Session Log

- [2025-12-20] Session 1 started. Beginning implementation of error handling.
- [2025-12-20] Added AssistantError class, AssistantErrorCode enum, and ERROR_MESSAGES constants with Romanian messages.
- [2025-12-20] Implemented handleLowConfidence() with generateClarificationOptions() for intent-specific suggestions.
- [2025-12-20] Implemented handleError() with pattern matching for rate limits, network, permission, and service errors.
- [2025-12-20] Added retry logic with exponential backoff to useAssistant.ts (MAX_RETRIES=2, BASE_DELAY=1000ms).
- [2025-12-20] Added error dismiss functionality to AssistantChat.tsx with clearError button.
- [2025-12-20] Created unit tests for error handling in ai-orchestrator.service.test.ts (21 tests, all passing).
- [2025-12-20] TypeScript compilation verified for both gateway and web packages.
- [2025-12-20] Session 1 completed. Status: Implemented, ready for verification.
