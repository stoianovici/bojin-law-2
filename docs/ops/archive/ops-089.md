# OPS-089: /documents Section with Case Navigation and Folder Structure

**Type:** Feature
**Priority:** P1-High
**Status:** Open
**Created:** 2025-12-21

## Problem

Users cannot navigate documents per case in a dedicated workspace. Currently:

- Documents are only accessible within individual case detail pages
- No global document browsing across cases
- No persistent folder hierarchy ("mape") - documents are flat within cases
- No large preview experience for document review

## Goal

Create a `/documents` section that:

1. Mirrors `/communications` architecture - case sidebar with content panel
2. Supports **folder hierarchy** ("mape") within each case
3. Provides **large document previews** for assessment
4. Persists folder structure in database

## Solution

### Architecture: Mirror /communications Pattern

Two-column layout matching existing `/communications` page:

- **Left Sidebar**: Case accordion with nested folder tree per case
- **Right Panel**: Document list + large preview area (leverages OPS-087 preview components)

### Data Model: DocumentFolder

New database model for persistent folder hierarchy:

```prisma
model DocumentFolder {
  id        String   @id @default(cuid())
  name      String
  caseId    String
  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    DocumentFolder? @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  DocumentFolder[] @relation("FolderHierarchy")
  documents CaseDocument[]
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  firmId    String
  firm      Firm     @relation(fields: [firmId], references: [id])

  @@index([caseId])
  @@index([parentId])
  @@index([firmId])
}

// Update existing CaseDocument model
model CaseDocument {
  // ...existing fields...
  folderId  String?
  folder    DocumentFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@index([folderId])
}
```

### Folder Features

- Nested folders without depth limit
- Drag-drop reordering within folder
- Move documents between folders
- Create/rename/delete folders
- Default root folder per case (implicit, no record needed)

## Implementation

### Phase 1: Database Schema & Migration

- [x] Add `DocumentFolder` model to Prisma schema
- [x] Add `folderId` field to `CaseDocument` model
- [x] Create migration `add_document_folders`
- [x] Add folder relations to Case model

### Phase 2: GraphQL Schema & Resolvers

- [x] Create `document-folder.graphql` schema

  ```graphql
  type DocumentFolder {
    id: ID!
    name: String!
    caseId: ID!
    parentId: ID
    parent: DocumentFolder
    children: [DocumentFolder!]!
    documents: [CaseDocument!]!
    order: Int!
    createdAt: DateTime!
  }

  input CreateFolderInput {
    name: String!
    caseId: ID!
    parentId: ID
  }

  input UpdateFolderInput {
    name: String
    parentId: ID
    order: Int
  }

  input MoveDocumentInput {
    documentId: ID!
    caseId: ID!
    folderId: ID
  }

  extend type Query {
    caseFolders(caseId: ID!): [DocumentFolder!]!
    folderContents(folderId: ID!): DocumentFolder!
  }

  extend type Mutation {
    createFolder(input: CreateFolderInput!): DocumentFolder!
    updateFolder(id: ID!, input: UpdateFolderInput!): DocumentFolder!
    deleteFolder(id: ID!): Boolean!
    moveDocumentToFolder(input: MoveDocumentInput!): CaseDocument!
  }
  ```

- [x] Create `document-folder.resolvers.ts`
- [x] Create `document-folder.service.ts`
- [x] Update `CaseDocument` type to include `folder` field

### Phase 3: Frontend Hooks & State

- [x] Create `useDocumentFolders(caseId)` hook
  - Fetches folder tree for a case
  - Returns nested folder structure
- [x] Create `useFolderActions()` hook
  - `createFolder(name, caseId, parentId?)`
  - `renameFolder(id, name)`
  - `deleteFolder(id)`
  - `moveDocument(docId, caseId, folderId)`
  - `reorderFolder(id, newOrder)`
- [x] Create `useDocumentsStore` (Zustand)
  - Selected case, folder, document state
  - Folder tree cache per case

### Phase 4: /documents Page & Components

- [x] Create `/apps/web/src/app/documents/page.tsx`
  - Two-column layout (mirror CommunicationsPage structure)
  - Left: DocumentsSidebar component
  - Right: DocumentsContentPanel component
- [x] Create `DocumentsSidebar.tsx`
  - Case accordion (reuse pattern from CaseSidebar)
  - Folder tree per case (nested, expandable)
  - Document counts per folder
  - "Dosar nou" button per case
- [x] Create `DocumentsContentPanel.tsx`
  - Breadcrumb navigation (Case > Folder > Subfolder)
  - Document grid/list view toggle
  - Document cards with preview trigger
  - Upload button (within current folder)
- [x] Create `FolderTreeItem.tsx` (integrated into DocumentsSidebar)
  - Expand/collapse
  - Folder icon + name
  - Right-click context menu (Rename, Delete, New subfolder)
  - Document count badge

### Phase 5: Folder Management UI

- [x] Create `CreateFolderModal.tsx`
  - Folder name input
  - Parent folder selection (optional)
- [x] Create `RenameFolderModal.tsx`
- [x] Create `DeleteFolderDialog.tsx`
  - Option: Move documents to parent or delete all
- [x] Add folder dropdown menu actions (three-dot menu)
  - Create subfolder
  - Rename folder
  - Delete folder

### Phase 6: Document Organization

- [x] Drag-drop documents between folders
- [ ] Drag-drop documents between cases (creates link)
- [ ] Move document modal (for non-drag users)
- [ ] Bulk select and move documents

### Phase 7: Preview Integration (depends on OPS-087)

- [x] Integrate `DocumentPreviewModal` from OPS-087
- [ ] Split view option: list + preview side-by-side
- [ ] Collapsible document list for full-width preview
- [ ] Keyboard navigation (arrows + Enter to preview)

### Phase 8: Navigation Integration

- [x] Add "Documente" to main navigation menu (already exists)
- [ ] Add quick link from case overview to /documents?case=X
- [x] URL routing: `/documents?case={caseId}&folder={folderId}`
- [x] Persist last viewed case/folder in localStorage

## Files Affected

**New:**

- `apps/web/src/app/documents/page.tsx`
- `apps/web/src/components/documents/DocumentsSidebar.tsx`
- `apps/web/src/components/documents/DocumentsContentPanel.tsx`
- `apps/web/src/components/documents/FolderTreeItem.tsx`
- `apps/web/src/components/documents/CreateFolderModal.tsx`
- `apps/web/src/components/documents/RenameFolderModal.tsx`
- `apps/web/src/components/documents/DeleteFolderDialog.tsx`
- `apps/web/src/hooks/useDocumentFolders.ts`
- `apps/web/src/hooks/useFolderActions.ts`
- `apps/web/src/stores/documents.store.ts`
- `services/gateway/src/graphql/schema/document-folder.graphql`
- `services/gateway/src/graphql/resolvers/document-folder.resolvers.ts`
- `services/gateway/src/services/document-folder.service.ts`
- `packages/database/prisma/migrations/XXXXXX_add_document_folders/`

**Modified:**

- `packages/database/prisma/schema.prisma` - Add DocumentFolder model
- `services/gateway/src/graphql/schema/index.ts` - Include folder schema
- `services/gateway/src/graphql/server.ts` - Add folder resolvers
- `services/gateway/src/graphql/schema/document.graphql` - Add folder to CaseDocument
- `apps/web/src/components/layout/MainLayout.tsx` - Add navigation item
- `apps/web/src/components/case/CaseDocumentsList.tsx` - Add "Open in /documents" link

## Acceptance Criteria

1. `/documents` page shows case-organized document navigation in left sidebar
2. Each case expands to show its folder tree
3. Users can create folders within cases (unlimited nesting)
4. Users can rename and delete folders
5. Documents can be moved between folders via drag-drop or modal
6. Folder structure persists in database (survives page refresh)
7. Right panel shows documents in selected folder with large preview capability
8. Romanian UI labels: "Documente", "Dosar nou", "Mută", "Redenumește", "Șterge"
9. URL reflects current case/folder selection for sharing
10. Empty folders show placeholder with create document prompt

## UI Text (Romanian)

- Page title: "Documente"
- New folder: "Dosar nou"
- Rename: "Redenumește"
- Delete: "Șterge"
- Move: "Mută"
- Root folder: "Fișiere principale" (or implicit, no label)
- Empty folder: "Acest dosar este gol"
- Folder name placeholder: "Nume dosar"

## Dependencies

- **OPS-087** (Document Preview) - For large preview functionality in right panel

## Notes

- "Mape" in Romanian context = folders/directories for case organization
- Consider default folder templates per case type in future iteration
- Folder permissions not needed initially (inherits from case access)
- Documents remain client-owned, folders are case-specific organization

## Session Log

### 2025-12-21 Session 2 - Backend Implementation

**Completed Phase 1: Database Schema & Migration**

- Added `DocumentFolder` model to Prisma schema with self-referencing hierarchy
- Added `folderId` field to `CaseDocument` model
- Added `documentFolders` relations to `Case` and `Firm` models
- Created migration `20251221150000_add_document_folders`

**Completed Phase 2: GraphQL Schema & Resolvers**

- Created `document-folder.graphql` with:
  - `DocumentFolder` type with nested children support
  - `FolderTree` type for sidebar display
  - Queries: `caseFolderTree`, `caseFolders`, `folderContents`, `folder`
  - Mutations: `createFolder`, `updateFolder`, `deleteFolder`, `moveDocumentToFolder`, `bulkMoveDocumentsToFolder`, `reorderFolders`
- Created `document-folder.service.ts` with full business logic
- Created `document-folder.resolvers.ts`
- Registered resolvers in `server.ts`
- All type checks pass, preflight:quick passes

**Files Created:**

- `packages/database/prisma/migrations/20251221150000_add_document_folders/migration.sql`
- `services/gateway/src/graphql/schema/document-folder.graphql`
- `services/gateway/src/services/document-folder.service.ts`
- `services/gateway/src/graphql/resolvers/document-folder.resolvers.ts`

**Files Modified:**

- `packages/database/prisma/schema.prisma`
- `services/gateway/src/graphql/schema/index.ts`
- `services/gateway/src/graphql/server.ts`

**Next Steps:**

- Phase 3: Create frontend hooks (`useDocumentFolders`, `useFolderActions`, `useDocumentsStore`)
- Phase 4: Create `/documents` page with two-column layout

### 2025-12-21 Session 2 (continued) - Frontend Implementation

**Completed Phase 3: Frontend Hooks & State**

- Created `useDocumentFolders.ts` with hooks:
  - `useCaseFolderTree(caseId)` - Fetch nested folder tree
  - `useCaseFolders(caseId)` - Flat list for dropdowns
  - `useFolderContents(folderId)` - Folder with documents
- Created `useFolderActions.ts` with mutations:
  - `createFolder`, `renameFolder`, `moveFolder`, `deleteFolder`
  - `moveDocumentToFolder`, `bulkMoveDocuments`, `reorderFolders`
- Created `document-folders.store.ts` (Zustand) with:
  - Selected case/folder/document state
  - View mode (grid/list), sort preferences
  - Sidebar expansion state (persisted)

**Completed Phase 4: /documents Page & Components**

- Created `/app/documents/page.tsx`:
  - Two-column layout mirroring /communications
  - AI assistant context integration
  - Auto-select first case
- Created `DocumentsSidebar.tsx`:
  - Case accordion with folder trees
  - Create folder button (prompt-based)
  - Document count badges
  - Folder expand/collapse state
- Created `DocumentsContentPanel.tsx`:
  - Breadcrumb navigation
  - Grid and list view toggle
  - Document cards with preview button
  - Empty state with upload CTA

**Navigation**: Already exists in sidebar at `/documents`

**Files Created:**

- `apps/web/src/hooks/useDocumentFolders.ts`
- `apps/web/src/hooks/useFolderActions.ts`
- `apps/web/src/stores/document-folders.store.ts`
- `apps/web/src/app/documents/page.tsx`
- `apps/web/src/components/documents/DocumentsSidebar.tsx`
- `apps/web/src/components/documents/DocumentsContentPanel.tsx`

**Status**: Phases 1-4 complete, preflight passes

**Remaining Phases:**

- Phase 5: Folder Management UI (modals for create/rename)
- Phase 6: Document Organization (drag-drop)
- Phase 7: Preview Integration (OPS-087)
- Phase 8: Navigation Integration (URL routing)

### 2025-12-21 Session 3 - Phase 5: Folder Management UI

**Completed Phase 5: Folder Management UI**

- Created `CreateFolderModal.tsx`:
  - Form with folder name input
  - Parent folder dropdown selection (with indented tree)
  - Error handling and loading states
  - Romanian UI labels
- Created `RenameFolderModal.tsx`:
  - Pre-filled with current folder name
  - Change detection (only saves if name changed)
  - Error handling and loading states
- Created `DeleteFolderDialog.tsx`:
  - Confirmation dialog using Radix AlertDialog
  - Document count warning when folder has documents
  - Radio options: "Move to parent" or "Delete documents"
  - Romanian UI labels
- Updated `DocumentsSidebar.tsx`:
  - Replaced prompt() with CreateFolderModal
  - Added dropdown menu (three-dot) for folder actions
  - Actions: Create subfolder, Rename, Delete
  - Dropdown uses existing ui/dropdown-menu component
- Updated `DocumentsContentPanel.tsx`:
  - Replaced prompt() with CreateFolderModal
  - Empty state "Dosar nou" button now opens modal

**Files Created:**

- `apps/web/src/components/documents/CreateFolderModal.tsx`
- `apps/web/src/components/documents/RenameFolderModal.tsx`
- `apps/web/src/components/documents/DeleteFolderDialog.tsx`

**Files Modified:**

- `apps/web/src/components/documents/DocumentsSidebar.tsx`
- `apps/web/src/components/documents/DocumentsContentPanel.tsx`

**Status**: Phases 1-5 complete, preflight passes

**Remaining Phases:**

- Phase 6: Document Organization (drag-drop)
- Phase 7: Preview Integration (OPS-087)
- Phase 8: Navigation Integration (URL routing)

### 2025-12-21 Session 4 - Phase 6: Drag-Drop Implementation

**Completed Phase 6 (partial): Document Drag-Drop**

- Added draggable support to `DocumentCard` component (both grid and list views)
- Added drop targets to `FolderItem` component in sidebar
- Added drop target to "Toate documentele" root folder row
- Visual feedback during drag (opacity, ring highlight)
- Visual feedback on drop targets (blue ring on drag over)
- Added `id` field to `CaseDocumentWithContext` GraphQL type for folder operations
- Updated `mapCaseDocument` in folder service to include ID
- Updated frontend hook and TypeScript types

**Files Modified:**

- `apps/web/src/components/documents/DocumentsContentPanel.tsx` - Added drag handlers
- `apps/web/src/components/documents/DocumentsSidebar.tsx` - Added drop handlers
- `apps/web/src/hooks/useDocumentFolders.ts` - Added `id` field to query and types
- `services/gateway/src/graphql/schema/document.graphql` - Added `id` to CaseDocumentWithContext
- `services/gateway/src/services/document-folder.service.ts` - Map ID in response

**Status**: Phases 1-6 complete, preflight passes

**Remaining Phases:**

- Phase 6 (remaining): Drag-drop documents between cases, move document modal, bulk select
- Phase 7: Preview Integration (OPS-087)
- Phase 8: Navigation Integration (URL routing)

### 2025-12-21 Session 5 - Preview Integration & URL Routing

**Completed Phase 7 (partial): Preview Integration**

- Integrated `DocumentPreviewModal` from OPS-087 into DocumentsContentPanel
- Added `useDocumentPreview` hook for managing preview state
- Updated DocumentCard components to open preview on click
- Added `downloadUrl` field to GraphQL fragment and TypeScript types
- Preview works for PDFs (native browser) and Office docs (Office Online embed)

**Completed Phase 8: Navigation Integration**

- Added URL routing: `/documents?case={caseId}&folder={folderId}`
- URL updates when case/folder selection changes
- URL params take precedence on load (for sharing links)
- Falls back to localStorage persisted state if no URL params
- Wrapped page in Suspense for Next.js useSearchParams compatibility
- Added localStorage persistence for `selectedCaseId` and `selectedFolderId`

**Files Modified:**

- `apps/web/src/components/documents/DocumentsContentPanel.tsx` - Preview modal integration
- `apps/web/src/hooks/useDocumentFolders.ts` - Added downloadUrl to fragment and type
- `apps/web/src/app/documents/page.tsx` - URL routing with useSearchParams
- `apps/web/src/stores/document-folders.store.ts` - Persist case/folder selection

**Remaining:**

- Phase 6 (remaining): Cross-case drag-drop, move modal, bulk operations
- Phase 7 (remaining): Split view, keyboard navigation
- Phase 8: Add quick link from case overview to /documents

### 2025-12-21 - Issue Created

- Completed ideation exploring 4 approaches:
  1. Mirror /communications architecture (chosen)
  2. Flat case selection with folder tabs
  3. Enhanced Documents tab in case details
  4. Hybrid /documents + enhanced case tab
- Chose Angle 1 for UX consistency with /communications
- Key insight: DocumentFolder model is essential for persistent folder hierarchy
- Folder structure is case-specific, documents remain client-owned
