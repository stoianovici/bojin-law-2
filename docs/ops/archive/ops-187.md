# OPS-187: Schema - PersonalContact + Email Privacy Fields

**Status:** Resolved | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-24

## Overview

Add data model foundation for personal contact blocklist and partner email privacy features.

## Dependencies

- **Depends on:** None
- **Blocks:** OPS-190, OPS-191, OPS-195
- **Parallel with:** OPS-188, OPS-189

## Context

Part of Communications UX Overhaul epic. Users need to mark contacts as "personal" (emails from them won't sync), and partners need to mark individual emails as private (hidden from case details but visible in their /communications).

## Requirements

### 1. PersonalContact Model

```prisma
model PersonalContact {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  email     String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, email])
  @@index([userId])
  @@map("personal_contacts")
}
```

### 2. Email Privacy Fields

Add to existing Email model:

```prisma
model Email {
  // ... existing fields ...

  // Partner privacy (OPS-187)
  isPrivate        Boolean   @default(false) @map("is_private")
  markedPrivateBy  String?   @map("marked_private_by")
  markedPrivateAt  DateTime? @map("marked_private_at") @db.Timestamptz
}
```

### 3. User Relation

Add to User model:

```prisma
model User {
  // ... existing relations ...
  personalContacts PersonalContact[]
}
```

## Acceptance Criteria

- [x] PersonalContact model exists in schema
- [x] Email privacy fields added (isPrivate, markedPrivateBy, markedPrivateAt)
- [x] User.personalContacts relation added
- [x] Migration created and runs successfully
- [x] Prisma client regenerated
- [x] No TypeScript errors in gateway

## Files to Modify

- `packages/database/prisma/schema.prisma`
- `packages/database/prisma/migrations/[timestamp]_personal_contacts_privacy.sql`

## Estimated Scope

Small - Schema changes only.

---

## Session Log

### Session 1 (2025-12-24)

**Completed:**

1. Added `PersonalContact` model to schema (lines 2740-2752):
   - `id`, `userId`, `email`, `createdAt` fields
   - Unique constraint on `[userId, email]`
   - Index on `userId`
   - Foreign key to `users` with `CASCADE` delete

2. Added email privacy fields to `Email` model (lines 2689-2692):
   - `isPrivate: Boolean @default(false)`
   - `markedPrivateBy: String?`
   - `markedPrivateAt: DateTime?`
   - Added index on `isPrivate`

3. Added `personalContacts PersonalContact[]` relation to `User` model (line 260)

4. Created migration `20251224220000_personal_contacts_privacy/migration.sql`

5. Applied migration and regenerated Prisma client

6. Verified gateway TypeScript compilation - no errors

**Files Modified:**

- `packages/database/prisma/schema.prisma`
- `packages/database/prisma/migrations/20251224220000_personal_contacts_privacy/migration.sql`

**Note:** TypeScript errors in `SplitAssignmentButton.tsx` are from OPS-188 (parallel issue), not related to this schema change.
