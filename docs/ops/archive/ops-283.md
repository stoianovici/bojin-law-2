# OPS-283: Task Notifications Draft Mode

**Type**: Feature
**Priority**: P1-High
**Status**: Closed
**Blocked By**: None (OPS-280 complete)

## Problem

Task reminder and overdue notification emails (`sendTaskReminderEmail`, `sendOverdueNotification`) bypass the main email flow and should also create drafts instead of sending directly.

## Solution

1. Update `sendEmailWithRetry()` helper to use `graphService.sendMail()` (already does, just needs to handle draft response)
2. Update `sendTaskReminderEmail()` - handle draft ID response
3. Update `sendOverdueNotification()` - same pattern
4. Update `sendDependencyUnblockedEmail()` - same pattern
5. Optionally create SentEmailDraft records (source=TASK_REMINDER, OVERDUE_NOTIFICATION, DEPENDENCY_UNBLOCKED)

## Done When

- [x] Task reminders create Outlook drafts instead of sending
- [x] Overdue notifications create Outlook drafts
- [x] Dependency unblocked emails create Outlook drafts
- [x] All notification methods work with draft mode toggle

## Implementation Summary

All task notification functions now respect `EMAIL_SEND_MODE` environment variable:

- **`sendEmailWithRetry()`** (`email.service.ts:193-243`) - Uses `GraphService.sendMail()` which checks `graphConfig.emailSendMode`:
  - `'draft'`: Creates message in Drafts folder via `POST /me/messages`, returns `{ draftId }`
  - `'send'`: Sends immediately via `POST /me/sendMail`

- **Functions Updated**:
  - `sendTaskReminderEmail()` - Task deadline reminders
  - `sendOverdueNotification()` - Overdue task alerts
  - `sendDependencyUnblockedEmail()` - Task unblocked notifications
  - `sendDailyDigestEmail()` - Daily digest emails
  - `sendReviewFeedbackEmail()` - Document review feedback

- **Result Interface**:
  ```typescript
  export interface EmailSendResult {
    success: boolean;
    draftId?: string;
    isDraftMode: boolean;
  }
  ```

## Files

- `services/gateway/src/services/email.service.ts` - All notification functions
- `services/gateway/src/services/graph.service.ts` - `sendMail()` with draft mode toggle
- `services/gateway/src/config/graph.config.ts` - `EMAIL_SEND_MODE` config

## Part Of

Universal Draft Mode Epic (OPS-279 to OPS-284)

## Notes

These are system-generated emails but user requested they also go to drafts. User will need to manually send task reminders from Outlook, which adds friction but ensures nothing goes out without review.

SentEmailDraft records for tracking could be added as a follow-up if audit trail is needed.
