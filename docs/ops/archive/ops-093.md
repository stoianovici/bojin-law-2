# OPS-093: AI-Created Events/Tasks Not Appearing in Calendar

| Field           | Value            |
| --------------- | ---------------- |
| **Status**      | Fixed            |
| **Type**        | Bug              |
| **Priority**    | P1-High          |
| **Created**     | 2025-12-22       |
| **Sessions**    | 1                |
| **Last Active** | 2025-12-22 11:00 |

## Description

Events/tasks created through AI chat were not appearing in the /tasks calendar view. Two issues:

1. Calendar events were being sent to Microsoft Outlook (mock), not saved in the app
2. Apollo cache wasn't invalidated after AI actions, causing stale data

## Symptom Category

**Category A**: "X not appearing in UI" - Data exists but not displayed

## Investigation Summary

| Hypothesis     | Verdict       | Key Finding                                           |
| -------------- | ------------- | ----------------------------------------------------- |
| Frontend fetch | ✅ Clear      | Tasks page correctly fetches with `cache-and-network` |
| Apollo cache   | ❌ Root cause | `confirmAction` mutation missing `refetchQueries`     |
| Backend        | ✅ Clear      | Task created successfully in DB                       |

## Root Cause

The `confirmAction` GraphQL mutation in `useAssistant.ts` had no `refetchQueries` configuration. When the AI assistant created a task:

1. AI tool `create_task` executed successfully
2. Task was persisted to database
3. `confirmAction` mutation returned success message
4. **Apollo cache was NOT invalidated** - no queries refetched
5. Tasks page displayed stale cached data
6. Manual refresh triggered new network request, showing the task

## Fix Applied

### Fix 1: Cache eviction on AI action confirmation

Added `cache.evict()` to invalidate task cache when AI actions are confirmed in `apps/web/src/hooks/useAssistant.ts`:

```typescript
const [confirmActionMutation] = useMutation<ConfirmActionData>(CONFIRM_ACTION, {
  update: (cache, { data }) => {
    if (data?.confirmAction.success) {
      cache.evict({ fieldName: 'tasks' });
      cache.evict({ fieldName: 'myTasks' });
      cache.evict({ fieldName: 'tasksByCase' });
      cache.evict({ fieldName: 'cases' });
      cache.evict({ fieldName: 'caseTimeline' });
      cache.gc();
    }
  },
});
```

This approach is better than `refetchQueries` because:

- `refetchQueries` only works on active/mounted queries
- If user creates task from case page, there's no active `GetTasks` query
- `cache.evict()` invalidates the cache entry, so fresh data is fetched on navigation

### Fix 2: Fixed tasks page sync logic

Fixed sync logic in `apps/web/src/app/tasks/page.tsx` that prevented proper data refresh:

```typescript
// Before: Only synced when tasks.length > 0 (could keep stale data)
if (apiTasks.length > 0) {
  setTasks(apiTasks);
}

// After: Always sync when not loading
if (!tasksLoading) {
  setTasks(apiTasks);
}
```

### Fix 3: Calendar events now create Tasks

Modified `executeCreateCalendarEvent` in `services/gateway/src/services/ai-assistant.service.ts` to create a Task with type "Meeting" instead of calling the mock Microsoft Outlook API:

```typescript
// Before: Created mock Outlook event (not persisted in app)
const result = await calendarService.createCalendarEvent({...});

// After: Creates a Task with type Meeting/BusinessTrip/CourtDate
const task = await taskService.createTask({
  title,
  caseId,
  assignedTo: context.userId,
  dueDate: startDateTime,
  type: taskType, // 'Meeting', 'BusinessTrip', or 'CourtDate'
  ...
}, context.userId);
```

This ensures all calendar-related items (meetings, business trips, court dates) appear in the unified /tasks calendar view.

## Files Involved

- `apps/web/src/hooks/useAssistant.ts` - Cache eviction on confirmAction
- `apps/web/src/app/tasks/page.tsx` - Fixed sync logic
- `services/gateway/src/services/ai-assistant.service.ts` - Calendar events create Tasks

## Local Verification Status

| Step           | Status     | Date | Notes                          |
| -------------- | ---------- | ---- | ------------------------------ |
| Prod data test | ⬜ Pending |      | Requires AI chat task creation |
| Preflight      | ⬜ Pending |      |                                |
| Docker test    | ⬜ Pending |      |                                |

**Verified**: No

> ⚠️ Issue cannot be closed until all three steps are ✅

## Session Log

- [2025-12-22 10:45] Issue created via /ops-investigate. Category: A. Root cause: Missing refetchQueries on confirmAction mutation. Fix applied.

---
