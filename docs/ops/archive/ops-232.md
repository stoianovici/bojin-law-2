# OPS-232: AI Usage & Batch Job Data Models

**Type**: Feature
**Priority**: P1-High
**Status**: Completed
**Epic**: AI Batch Processing & Ops Dashboard

## Problem

No data structure exists to track AI API calls, costs, or batch job executions. Can't measure or control AI spend.

## Solution

Add Prisma models for:

- `AIUsageLog` - Every AI call with tokens, cost, feature, user, entity
- `AIBatchJobRun` - Batch job execution history with status, timing, metrics

### Data Models

```prisma
model AIUsageLog {
  id            String   @id @default(uuid())

  // What was called
  feature       String   // 'assistant_chat', 'search_index', 'morning_briefing', etc.
  model         String   // 'claude-3-haiku-20240307', 'claude-sonnet-4-20250514', etc.

  // Token counts
  inputTokens   Int
  outputTokens  Int

  // Cost calculation (EUR for Romanian firm)
  costEur       Decimal  @db.Decimal(10, 6)

  // Context
  userId        String?  // null for batch jobs
  firmId        String
  entityType    String?  // 'document', 'case', 'email', etc.
  entityId      String?

  // Timing
  durationMs    Int
  createdAt     DateTime @default(now())

  // For batch jobs (intentionally not a FK for flexibility - jobs may be deleted)
  batchJobId    String?

  @@index([firmId, createdAt])
  @@index([feature, createdAt])
  @@index([batchJobId])
}

model AIBatchJobRun {
  id            String   @id @default(uuid())
  firmId        String
  feature       String

  status        String   // 'running', 'completed', 'failed', 'partial'

  startedAt     DateTime
  completedAt   DateTime?

  itemsProcessed  Int    @default(0)
  itemsFailed     Int    @default(0)
  totalTokens     Int    @default(0)
  totalCostEur    Decimal @db.Decimal(10, 6) @default(0)

  errorMessage  String?

  @@index([firmId, feature, startedAt])
}
```

## Acceptance Criteria

- [x] Prisma schema updated with both models
- [x] Migration created and applied
- [x] Indexes on `(firmId, createdAt)`, `(feature, createdAt)`, `(batchJobId)`

## Files to Modify

- `packages/database/prisma/schema.prisma`
- `packages/database/prisma/migrations/YYYYMMDD_ai_usage_models/`

## Dependencies

None - this is a foundation issue.

## Parallel Work

Can be done in parallel with OPS-233, OPS-234.
