# OPS-175: Promote Attachment to Working Document

**Type**: Feature
**Priority**: P2-Medium
**Status**: Verifying
**Epic**: Documents Separation & Review Workflow (OPS-171 to OPS-177)

## Problem

Email attachments are currently static - they can be saved to a case but cannot enter the editing and versioning workflow. When a firm needs to modify an attachment (e.g., annotate a contract, fill in a form), they must:

1. Download the attachment
2. Edit locally
3. Upload as a new document
4. Lose the connection to the original email

## Solution

Add "Editează ca document de lucru" (Edit as Working Document) action that creates an editable copy linked to the original attachment, enabling version tracking.

## Implementation Progress

### Completed

1. **SharePointService.copyFile method** - Added method to copy files within SharePoint to support the promotion workflow.

2. **GraphQL Schema** - Added `promoteAttachmentToDocument` mutation:

   ```graphql
   input PromoteAttachmentInput {
     caseDocumentId: UUID!
     targetFolderId: UUID
   }

   type PromoteAttachmentResult {
     success: Boolean!
     document: Document
     caseDocument: CaseDocumentWithContext
     error: String
   }

   mutation {
     promoteAttachmentToDocument(input: PromoteAttachmentInput!): PromoteAttachmentResult!
   }
   ```

3. **Resolver** - Implemented full promotion logic:
   - Validates attachment is email type
   - Checks for existing promotion
   - Copies file in SharePoint to working folder
   - Creates new Document with DRAFT status
   - Links to case with promotedFromAttachment=true
   - Creates initial DocumentVersion
   - Updates original attachment metadata with promotedToDocumentId

4. **SaveAttachmentAsDocumentResult** - Extended to return `caseDocumentId` for promotion workflow.

5. **Preview Actions** - Added `promote-to-working` action to `email-attachment` context.

6. **DocumentPreviewModal** - Added FileEdit icon to ICON_MAP.

7. **MessageView** - Added `promote-to-working` action handler for fallback modal.

8. **AttachmentPreviewPanel** - Added promote button with handlePromoteToWorking handler.

9. **EmailAttachment GraphQL Schema** - Added `isPromoted` and `promotedDocumentId` fields.

10. **Email Resolvers** - Added resolvers for isPromoted/promotedDocumentId fields.

11. **Frontend Queries** - Updated EMAIL_FRAGMENT to fetch isPromoted/promotedDocumentId.

12. **"Editat" Badge** - Added visual indicator to promoted attachments in MessageView and AttachmentPreviewPanel.

## Files Modified

- `services/gateway/src/services/sharepoint.service.ts` - copyFile method
- `services/gateway/src/graphql/schema/document.graphql` - mutation + types
- `services/gateway/src/graphql/schema/email.graphql` - SaveAttachmentAsDocumentResult.caseDocumentId, isPromoted, promotedDocumentId fields
- `services/gateway/src/graphql/resolvers/document.resolvers.ts` - promoteAttachmentToDocument resolver
- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - return caseDocumentId, isPromoted, promotedDocumentId resolvers
- `packages/shared/types/src/document-preview-actions.ts` - promote-to-working action
- `apps/web/src/hooks/useEmailSync.ts` - updated EmailAttachment interface and EMAIL_FRAGMENT
- `apps/web/src/hooks/useThreadAttachments.ts` - added isPromoted, promotedDocumentId to ThreadAttachment
- `apps/web/src/components/preview/DocumentPreviewModal.tsx` - FileEdit icon
- `apps/web/src/components/communication/MessageView.tsx` - promote action handler, "Editat" badge
- `apps/web/src/components/communication/AttachmentPreviewPanel.tsx` - promote button + handler, "Editat" badge in header

## Next Steps

1. ~~Test the promotion flow end-to-end~~ - Ready for verification
2. ~~Add "Editat" badge to original attachments after promotion~~ - Complete
3. Consider adding visual indicator in working documents for promoted items (future enhancement)

## Acceptance Criteria

- [x] "Editează ca document de lucru" button visible for email attachments
- [x] Button not visible for already-promoted attachments
- [x] Clicking creates new Document with DRAFT status
- [x] File copied to SharePoint working folder
- [x] New document linked to case with promotedFromAttachment=true
- [x] Original attachment shows "Editat" badge after promotion
- [x] Initial version created with appropriate summary
- [x] Success toast notification shown
- [x] New document appears in "Documente de lucru" tab (via promotedFromAttachment filter)

## Data Flow

```
┌─────────────────┐     promote     ┌─────────────────┐
│ EmailAttachment │───────────────▶│    Document     │
│ (Corespondență) │                │  (DRAFT status) │
└────────┬────────┘                └────────┬────────┘
         │                                  │
         │ originalAttachmentId             │ versions
         │                                  │
         ▼                                  ▼
┌─────────────────┐                ┌─────────────────┐
│  CaseDocument   │                │ DocumentVersion │
│ (promoted=true) │                │   (v1 initial)  │
└─────────────────┘                └─────────────────┘
```

## Notes

- The original attachment remains in Corespondență for reference
- The promoted document maintains a link to its origin via metadata
- Users can view the connection but cannot "unpromote" (would lose edits)
