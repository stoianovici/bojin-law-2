# [OPS-008] Communications section comprehensive overhaul

| Field           | Value      |
| --------------- | ---------- |
| **Status**      | Fixing     |
| **Type**        | Feature    |
| **Priority**    | P1-High    |
| **Created**     | 2025-12-11 |
| **Sessions**    | 6          |
| **Last Active** | 2025-12-11 |

## Description

The communications section needs a comprehensive overhaul to address multiple issues and complete missing functionality. This is a rollup issue covering high and medium priority fixes for the `/communications` page and related components.

**High Priority Items:**

1. Complete email send functionality - ComposeInterface shows "(Mockup)" button, no actual send logic
2. Replace all `alert()` calls with proper toast notifications
3. Add attachment upload capability to compose/reply
4. Fix thread participant population (currently `participants: []` placeholder)
5. Track extracted item conversions centrally to show accurate counts
6. **Attachments not loading** - attachment previews not displaying in message view
7. **"Assign to case" button** - for emails not yet assigned to a case
8. **"Ignore" button** - mark emails as not case-related (hide from main view)
9. **Thread readability** - expand/collapse threads, newest email on top
10. **Hide own sent emails** - don't display user's own sent messages in inbox view

**Medium Priority Items:** 11. Fix attachment field name mismatches (`filename` vs `name`, `fileSize` vs `size`) 12. Implement "view failed recipients" for bulk messaging 13. Add draft auto-save and persistence 14. Better template integration with compose modal 15. Fix path resolution issues (revert `@` alias when Turbopack fixed)

**UX Polish:** 16. Ensure all async operations show proper loading feedback 17. Add error boundaries around communication components 18. Search highlighting to show why emails matched filter

## Reproduction Steps

1. Navigate to /communications page
2. Try to send an email - observe "(Mockup)" button
3. Move communication to case - see browser alert instead of toast
4. Check bulk messaging failures - can't see which recipients failed
5. Check extracted items count - may not reflect actual converted status

## Root Cause

**Multiple incomplete implementations across the communications section:**

1. **ComposeInterface.tsx** - Send button wired with TODO, shows "(Mockup)"
2. **MessageView.tsx** - Uses `alert()` for notifications
3. **communications/page.tsx** - `participants: []` hardcoded
4. **communication.store.ts** - No tracking for converted extracted items
5. **BulkProgressIndicator.tsx** - TODO comment for failed recipients view
6. **Multiple components** - Path alias issues with `@` imports

## Fix Applied

TBD - see Session Log for progress

## Local Dev Environment

```bash
# Full dev environment:
pnpm dev

# Individual services:
cd services/gateway && pnpm dev     # GraphQL gateway on :4000
cd services/ai-service && pnpm dev  # AI service on :3002
cd apps/web && pnpm dev             # Next.js frontend on :3000

# Docker services (for DB, Redis):
docker-compose -f infrastructure/docker/docker-compose.yml up -d postgres redis
```

Environment files:

- `apps/web/.env.local` - Frontend config
- `services/gateway/.env` - Gateway config (DATABASE_URL, REDIS_URL)
- `services/ai-service/.env` - AI service config (ANTHROPIC_API_KEY)

## Session Log

- [2025-12-11] Issue created. Initial triage identified 15+ items across high/medium priority categories. Key gaps: email send not implemented (mockup only), UX issues (alert() instead of toast), missing attachment uploads, incomplete data tracking for extracted items.
- [2025-12-11] Session 1 - User added 5 additional items: attachment previews not loading, "assign to case" button, "ignore" button, thread readability (expand/collapse, newest on top), hide own sent emails. Total: 18 items organized into 6 planned sessions.
- [2025-12-11] Session 2 started. Continuing from: New. Focus: Thread UX & Email Filtering.
- [2025-12-11] Session 2 - Investigation findings:
  1. Expand/collapse already implemented in MessageView.tsx - no changes needed
  2. Messages display oldest first, need to reverse for newest-on-top option
  3. No `isSent` field - must compare `from.address` with user email
  4. Found attachment field mismatch: MessageView uses `filename`/`fileSize` but schema has `name`/`size`
- [2025-12-11] Session 2 - Implemented fixes:
  1. **MessageView.tsx**: Added `messageOrder` state with toggle button ("Noi → Vechi" / "Vechi → Noi")
  2. **MessageView.tsx**: Fixed attachment field names (`name`/`size` instead of `filename`/`fileSize`)
  3. **MessageView.tsx**: Made attachments clickable links with download URLs
  4. **communication.store.ts**: Added `emailViewMode` ('all'|'received'|'sent') and `userEmail` state
  5. **communication.store.ts**: Updated `getFilteredThreads` to filter by sent/received based on user email
  6. **FilterBar.tsx**: Added tabbed UI for "Primite" / "Trimise" / "Toate" email view modes
  7. **communications/page.tsx**: Set user email from auth context for sent/received filtering
- [2025-12-11] Session 2 - Build verified successful. All changes compile without errors.
- [2025-12-11] Session 3 started. Continuing from: Fixing. Focus: Attachment previews not loading (#6).
- [2025-12-11] Session 3 - Root cause identified: Email sync stores `hasAttachments: true` but does NOT create `EmailAttachment` records. GraphQL resolver queries `EmailAttachment` table → returns empty array.
- [2025-12-11] Session 3 - Fix 1: Added `downloadUrl` to GraphQL attachment fragment in `useEmailSync.ts`
- [2025-12-11] Session 3 - Fix 2: Added `hasAttachments` field pass-through in communications page transformation
- [2025-12-11] Session 3 - Fix 3: Implemented "Încarcă atașamentele" button in MessageView when `hasAttachments && !attachments.length`.
- [2025-12-11] Session 3 - Fix 4: Fixed React Hooks order violation (useCallback was after early return)
- [2025-12-11] Session 3 - Fix 5: Added MSAL authentication check - shows "Conectează Microsoft" when not authenticated
- [2025-12-11] Session 3 - Fix 6: Fixed MS Graph API error - removed `@odata.type` from $select query
- [2025-12-11] Session 3 - Fix 7: Made R2 storage optional - saves metadata only if R2 not configured
- [2025-12-11] Session 3 - **Architecture Decision: MS Graph Direct Download**
  - New approach: Don't store files at all - fetch directly from MS Graph on demand
  - Added `AttachmentContent` GraphQL type and `emailAttachmentContent` query
  - Added `getAttachmentContentFromGraph` method in attachment service
  - Frontend fetches base64 content, converts to blob, triggers browser download
  - Benefits: No storage costs, works everywhere, always up-to-date
- [2025-12-11] Session 3 - Build verified successful. Attachment system fully functional without cloud storage.
- [2025-12-11] Session 4 started. Continuing from: Fixing. Focus: Case Assignment & Ignore buttons (#7, #8).
- [2025-12-11] Session 4 - Implemented #7 "Assign to case" button:
  - Added "Atribuie la dosar" button in MessageView when thread has no caseId
  - Created modal with case dropdown (uses `useMyCases` hook)
  - Wired to existing `assignThreadToCase` GraphQL mutation
  - Updates local state after assignment
- [2025-12-11] Session 4 - Implemented #8 "Ignore" button:
  - Added `isIgnored` and `ignoredAt` fields to Email model in Prisma schema
  - Added `@@index([isIgnored])` for query performance
  - Added `ignoreEmailThread` and `unignoreEmailThread` GraphQL mutations
  - Updated `EmailThreadService.getThreads()` to filter out ignored emails by default
  - Added "Ignoră" button in MessageView UI (removes thread from view)
- [2025-12-11] Session 4 - Build verified successful. Items 7 and 8 complete.
- [2025-12-11] Session 5 - Implemented #1 email send functionality (sendNewEmail, replyToEmail mutations) and #13 draft auto-save persistence (zustand + localStorage).
- [2025-12-11] Session 6 started. Continuing from: Fixing. Focus: Toast notifications (#2) and thread participants (#4).
- [2025-12-11] Session 6 - Implemented #2 Toast Notifications:
  - Added `useNotificationStore` to MessageView.tsx and ExtractedItemsSidebar.tsx
  - Replaced `alert('Comunicare mutată în dosar')` with toast notification
  - Replaced `alert('Task creat cu succes!')` with toast notification
- [2025-12-11] Session 6 - Implemented #4 Thread Participants:
  - Updated communications/page.tsx to populate `participants` from email data
  - Extracts unique participants from `from`, `toRecipients`, and `ccRecipients` of all emails
  - Added `conversationId` field to `CommunicationThread` type in packages/shared/types
  - Added type definitions for `AssignThreadToCaseResult` and `IgnoreEmailThreadResult` in MessageView.tsx
  - Fixed TypeScript errors in MessageView.tsx related to mutation typing

## Files Involved

**High Priority - Send Functionality:**

- `apps/web/src/components/communication/ComposeInterface.tsx` - Send button shows "(Mockup)", needs actual implementation
- `apps/web/src/hooks/useEmailDraft.ts` - Has sendDraft mutation but not wired in UI

**High Priority - UX Issues:**

- `apps/web/src/components/communication/MessageView.tsx` - **FIXED (Session 6)** - Added attachment sync button, replaced `alert()` with toast notifications
- `apps/web/src/app/communications/page.tsx` - **FIXED (Session 6)** - Added `hasAttachments` pass-through, populated `participants` from email data

**High Priority - Attachment Uploads:**

- `apps/web/src/components/communication/ComposeInterface.tsx` - No file upload input
- `services/gateway/src/graphql/schema/email.graphql` - May need attachment upload mutation

**Medium Priority - Data Tracking:**

- `apps/web/src/stores/communication.store.ts` - Needs converted items tracking
- `apps/web/src/components/communication/BulkProgressIndicator.tsx` - TODO on line 226 for failed recipients

**Medium Priority - Field Mismatches:**

- `apps/web/src/components/communication/MessageView.tsx` - **FIXED (Session 2)** - Field names corrected

**GraphQL Hooks:**

- `apps/web/src/hooks/useEmailSync.ts` - **FIXED (Session 3)** - Added `downloadUrl` to attachment fragment

**Attachment System (Session 3 - MS Graph Direct Download):**

- `services/gateway/src/graphql/schema/email.graphql` - Added `AttachmentContent` type and `emailAttachmentContent` query
- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - Added `emailAttachmentContent` resolver
- `services/gateway/src/services/email-attachment.service.ts` - Fixed API errors, made R2 optional, added direct download method
- `apps/web/src/components/communication/MessageView.tsx` - Added download handler with blob conversion

**Case Assignment & Ignore (Session 4):**

- `apps/web/src/components/communication/MessageView.tsx` - **FIXED** - Added assign-to-case modal and ignore button
- `services/gateway/src/graphql/schema/email.graphql` - **FIXED** - Added `ignoreEmailThread`, `unignoreEmailThread` mutations
- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - **FIXED** - Implemented ignore/unignore resolvers
- `services/gateway/src/services/email-thread.service.ts` - **FIXED** - Filter out ignored emails by default
- `packages/database/prisma/schema.prisma` - **FIXED** - Added `isIgnored`, `ignoredAt` fields to Email model

**Toast Notifications & Types (Session 6):**

- `apps/web/src/components/communication/MessageView.tsx` - **FIXED** - Added toast notifications, type definitions for mutations
- `apps/web/src/components/communication/ExtractedItemsSidebar.tsx` - **FIXED** - Added toast notification for task creation
- `packages/shared/types/src/communication.ts` - **FIXED** - Added `conversationId` field to CommunicationThread type

**Path Resolution (9+ files):**

- ThreadList.tsx, MessageView.tsx, ComposeInterface.tsx, FilterBar.tsx, ExtractedItemsSidebar.tsx, etc.
