# OPS-258: Document Summary Aggregation Service

**Type**: Feature | **Priority**: P2-Medium | **Complexity**: M
**Status**: Completed
**Parallel**: Yes (with OPS-257, OPS-259, OPS-260)

## Problem

No way to get a quick summary of key documents for a case. AI assistant can't reference document contents without reading each one at request time, adding latency and token cost.

## Solution

Create `document-summary.service.ts` that aggregates document summaries for a case, prioritizing recent and important documents. Uses existing summaries where available, generates new ones via Haiku for efficiency.

## Implementation

### Service Interface

```typescript
interface DocumentSummaryService {
  /**
   * Get aggregated document summaries for a case
   * Returns top 10 most relevant documents with summaries
   * Target: ~500 tokens total
   */
  getForCase(caseId: string, firmId: string): Promise<DocumentSummary[]>;

  /**
   * Generate summary for a single document (if not cached)
   */
  generateSummary(documentId: string): Promise<string>;
}
```

### Document Ranking Logic

Priority scoring for document selection:

1. **Recency**: Documents updated in last 30 days score higher
2. **Type importance**: Contracts, court filings > general correspondence
3. **Size**: Larger documents (more content) get slight boost
4. **Status**: FINAL/APPROVED > DRAFT

```typescript
function rankDocuments(docs: Document[]): Document[] {
  return docs
    .map((doc) => ({
      ...doc,
      score: calculateScore(doc),
    }))
    .sort((a, b) => b.score - a.score)
    .slice(0, 10);
}

function calculateScore(doc: Document): number {
  let score = 0;

  // Recency (0-40 points)
  const daysSinceUpdate = daysBetween(doc.updatedAt, new Date());
  score += Math.max(0, 40 - daysSinceUpdate);

  // Type importance (0-30 points)
  const typeScores = {
    CONTRACT: 30,
    COURT_FILING: 30,
    LEGAL_BRIEF: 25,
    CORRESPONDENCE: 15,
    INVOICE: 10,
    OTHER: 5,
  };
  score += typeScores[doc.type] || 5;

  // Status (0-20 points)
  if (doc.status === 'FINAL' || doc.status === 'APPROVED') score += 20;
  else if (doc.status === 'IN_REVIEW') score += 10;

  return score;
}
```

### Summary Generation

For documents without existing summaries:

```typescript
async generateSummary(documentId: string): Promise<string> {
  const doc = await prisma.document.findUnique({...});

  // Check for existing summary
  if (doc.aiSummary && doc.summaryUpdatedAt > doc.updatedAt) {
    return doc.aiSummary;
  }

  // Generate via Haiku (cost efficient)
  const content = await this.extractContent(doc);
  const summary = await aiClient.complete(
    `Summarize this legal document in 2-3 sentences (Romanian):\n\n${content}`,
    { feature: 'document_summary', firmId: doc.firmId },
    { model: 'claude-haiku-4-5-20250514', maxTokens: 150 }
  );

  // Cache the summary
  await prisma.document.update({
    where: { id: documentId },
    data: { aiSummary: summary, summaryUpdatedAt: new Date() }
  });

  return summary;
}
```

## Done When

- [x] Service queries and ranks documents by importance
- [x] Uses cached summaries when available
- [x] Generates new summaries via Haiku when needed
- [x] Returns structured array (~500 tokens max)
- [x] Unit tests for ranking logic (13 tests passing)
- [x] Handles cases with no documents gracefully

## Files

- `services/gateway/src/services/document-summary.service.ts` - New service
- `services/gateway/src/services/document-summary.service.test.ts` - Unit tests

## Token Budget

| Component                             | Tokens |
| ------------------------------------- | ------ |
| Per document (title + type + summary) | ~50    |
| 10 documents max                      | ~500   |

## Dependencies

None - can start immediately.

## Blockers For

- OPS-261: Case Context Batch Processor
