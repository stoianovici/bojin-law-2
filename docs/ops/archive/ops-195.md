# OPS-195: Multi-Case Confirmation Flow

**Status:** Resolved | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-24

## Overview

When a sender has multiple active cases, require user confirmation before allowing reply. Email lands in most probable case but must be confirmed.

## Dependencies

- **Depends on:** OPS-187 (schema), OPS-188 (SplitAssignmentButton)
- **Blocks:** None
- **Parallel with:** OPS-193, OPS-194, OPS-196

## Context

Part of Communications UX Overhaul epic. Currently, multi-case senders get auto-assigned to the highest-scoring case. This can lead to misclassification. Instead, we should require the user to confirm or reassign before they can reply.

## Requirements

### 1. Classification Result Flag

Update classification scoring to flag multi-case scenarios:

```typescript
interface ClassificationResult {
  // ... existing fields ...
  needsConfirmation: boolean; // True when sender has 2+ cases
  confirmedAt?: Date;
  confirmedBy?: string;
}
```

### 2. Email State

Add to Email or EmailCaseLink:

```typescript
// On EmailCaseLink
isConfirmed: boolean; // Default false for multi-case
confirmedAt: DateTime?
confirmedBy: String? // userId
```

### 3. UI for Unconfirmed Emails

When viewing an email that `needsConfirmation && !isConfirmed`:

```
┌─────────────────────────────────────────────────────────┐
│  [Confirmă: Popescu v. Ionescu]   [Mută la: SC Alpha]   │
│         (primary)                    (secondary)        │
│                                                         │
│  [Răspunde] ← grayed out / disabled                     │
└─────────────────────────────────────────────────────────┘
```

### 4. Confirmation Flow

1. User clicks "Confirmă" → confirms current case assignment
2. User clicks "Mută la" → shows dropdown with other suggestions
3. After confirm/move → `Răspunde` button enables

### 5. Backend Mutation

```graphql
mutation confirmEmailAssignment($emailId: ID!, $caseId: ID!) {
  confirmEmailAssignment(emailId: $emailId, caseId: $caseId) {
    email {
      id
      caseId
    }
    caseLink {
      isConfirmed
      confirmedAt
      confirmedBy
    }
  }
}
```

### 6. Visual Indicators

In sidebar, show unconfirmed emails with subtle indicator:

- Perhaps a small "?" badge
- Or different background shade

## Acceptance Criteria

- [x] Classification marks multi-case emails as `needsConfirmation`
- [x] Schema updated with confirmation fields
- [x] Confirm/Move buttons shown for unconfirmed emails
- [x] Răspunde disabled until confirmed
- [x] Confirmation mutation works
- [x] After confirm, normal email view restored
- [ ] Sidebar shows indicator for unconfirmed emails (stretch goal)

## Files Modified

- `packages/database/prisma/schema.prisma` - Added EmailCaseLink confirmation fields
- `packages/database/prisma/migrations/20251224230000_multi_case_confirmation/` - Migration
- `packages/database/prisma/migrations/20251224231000_classification_action_enum/` - Enum values
- `services/gateway/src/services/classification-scoring.ts` - Added needsConfirmation flag
- `services/gateway/src/workers/email-categorization.worker.ts` - Sets confirmation fields
- `services/gateway/src/graphql/schema/email.graphql` - EmailCaseLink fields + mutation
- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - confirmEmailAssignment resolver
- `apps/web/src/components/communication/ConversationView.tsx` - Confirmation UI + disabled Reply

## Estimated Scope

Medium - Backend flag + UI conditional rendering.

---

## Session Log

### 2025-12-24

**Implemented core multi-case confirmation flow:**

1. **Schema**: Added `needsConfirmation`, `isConfirmed`, `confirmedAt`, `confirmedBy` to EmailCaseLink
2. **Classification**: Updated `classifyEmail()` to set `needsConfirmation: true` when sender has 2+ candidate cases (except for thread continuity matches)
3. **Worker**: Updated email categorization worker to persist confirmation flags
4. **GraphQL**: Added `confirmEmailAssignment` mutation with full result type
5. **Resolver**: Implemented confirmation logic with reassignment support
6. **UI**: Added confirmation banner in ConversationView with case buttons, disabled Reply button when unconfirmed

**Remaining (stretch goal):**

- Sidebar visual indicator requires updating `useMyEmailsByCase` hook to fetch confirmation state per thread - deferred for future iteration
