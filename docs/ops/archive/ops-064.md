# OPS-064: AI Assistant GraphQL Schema

**Status:** Implemented | **Priority:** P0-Critical | **Type:** Feature
**Created:** 2025-12-20 | **Depends on:** OPS-063 | **Blocks:** OPS-065, OPS-068

## Summary

Define the GraphQL schema for the interactive AI assistant API, including conversation management, message sending, and action confirmations.

## Background

The assistant needs a complete GraphQL API for:

- Starting/resuming conversations
- Sending messages and receiving responses
- Confirming or rejecting proposed actions
- Querying conversation history

## Requirements

### GraphQL Schema

```graphql
# ai-assistant.graphql

# ============================================================================
# Enums
# ============================================================================

enum ConversationStatus {
  Active
  AwaitingConfirmation
  Completed
  Expired
}

enum AIMessageRole {
  User
  Assistant
  System
}

enum AIActionStatus {
  Proposed
  Confirmed
  Executed
  Rejected
  Failed
}

enum AssistantIntent {
  # Task & Calendar
  CreateTask
  UpdateTask
  QueryTasks
  ScheduleEvent

  # Case Information
  CaseQuery
  CaseSummary

  # Communication
  SearchEmails
  SummarizeThread
  DraftEmail

  # Document Operations
  FindDocument
  SummarizeDocument
  GenerateDocument

  # Proactive
  MorningBriefing
  DeadlineAlert

  # General
  AskClarification
  GeneralChat
}

# ============================================================================
# Types
# ============================================================================

type AIConversation {
  id: ID!
  caseId: ID
  case: Case
  status: ConversationStatus!
  context: JSON
  messages: [AIMessage!]!
  messageCount: Int!
  createdAt: DateTime!
  updatedAt: DateTime!
  closedAt: DateTime
}

type AIMessage {
  id: ID!
  role: AIMessageRole!
  content: String!
  intent: AssistantIntent
  confidence: Float
  proposedAction: ProposedAction
  tokensUsed: Int
  modelUsed: String
  latencyMs: Int
  createdAt: DateTime!
}

type ProposedAction {
  type: String!
  displayText: String!
  payload: JSON!
  status: AIActionStatus!
  requiresConfirmation: Boolean!
  confirmationPrompt: String
  entityPreview: JSON
}

type AssistantResponse {
  message: AIMessage!
  conversation: AIConversation!
  suggestedFollowUps: [String!]!
}

type ActionResult {
  success: Boolean!
  message: String!
  entityId: ID
  entityType: String
  navigationUrl: String
  error: String
}

# ============================================================================
# Inputs
# ============================================================================

input SendMessageInput {
  conversationId: ID
  content: String!
  caseId: ID
  context: AssistantContextInput
}

input AssistantContextInput {
  currentScreen: String
  currentCaseId: ID
  currentDocumentId: ID
  selectedEmailId: ID
  selectedText: String
}

input ConfirmActionInput {
  messageId: ID!
  confirmed: Boolean!
  modifications: JSON
}

# ============================================================================
# Queries
# ============================================================================

extend type Query {
  """
  Get active conversation for current context
  """
  activeConversation(caseId: ID): AIConversation

  """
  Get conversation by ID
  """
  conversation(id: ID!): AIConversation

  """
  Get recent conversation history
  """
  conversationHistory(limit: Int = 10, caseId: ID): [AIConversation!]!
}

# ============================================================================
# Mutations
# ============================================================================

extend type Mutation {
  """
  Send a message to the AI assistant
  """
  sendAssistantMessage(input: SendMessageInput!): AssistantResponse!

  """
  Confirm or reject a proposed action
  """
  confirmAction(input: ConfirmActionInput!): ActionResult!

  """
  Close/end a conversation
  """
  closeConversation(id: ID!): AIConversation!
}
```

## Acceptance Criteria

- [x] Schema file created with all types, inputs, queries, mutations
- [x] Enums match Prisma schema
- [x] Schema imports added to index.ts
- [x] No GraphQL validation errors
- [x] Types align with frontend needs

## Files Created

- `services/gateway/src/graphql/schema/ai-assistant.graphql` ✓

## Files Modified

- `services/gateway/src/graphql/schema/index.ts` (import added at line 136, included at line 182) ✓

## Session Log

- [2025-12-20 Session 1] Verified all acceptance criteria met:
  - Schema file exists with 281 lines covering all types, enums, inputs, queries, mutations
  - Enums (`ConversationStatus`, `AIMessageRole`, `AIActionStatus`) match Prisma schema exactly
  - `AssistantIntent` is correctly GraphQL-only (runtime classification, not stored)
  - Schema already imported in index.ts
  - TypeScript compilation passes with no errors
