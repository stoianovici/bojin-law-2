# [OPS-013] New logins don't show up in user management

| Field           | Value      |
| --------------- | ---------- |
| **Status**      | Resolved   |
| **Type**        | Bug        |
| **Priority**    | P1-High    |
| **Created**     | 2025-12-13 |
| **Resolved**    | 2025-12-13 |
| **Sessions**    | 3          |
| **Last Active** | 2025-12-13 |

## Description

Multiple people logged in to the application yesterday but their profiles don't show up in the "Pending Users" page at `/admin/users/pending`. The page only shows old test data (users from November 2024), not actual new registrations from the live system.

## Reproduction Steps

1. Have a new user log in via Azure AD for the first time
2. Navigate to `/admin/users/pending` as a Partner
3. **Expected:** The new user appears in the pending users list
4. **Actual:** Only hardcoded mock data is shown; new users never appear

## Root Cause

**PRIMARY:** New users are created with `status: 'Active'` instead of `status: 'Pending'` in the provisioning endpoint (`apps/web/src/app/api/auth/provision/route.ts`, line 104). The Prisma schema defaults to `Pending`, but the provision code explicitly overrides this to `Active`.

**SECONDARY:** The pending users API endpoint (`apps/web/src/app/api/users/pending/route.ts`) returns hardcoded mock data, not actual database queries. Even if users were created with `Pending` status, the API wouldn't return them.

**TERTIARY:** The user activation endpoint (`apps/web/src/app/api/users/[userId]/activate/route.ts`) also returns mock data without performing actual database updates.

## Fix Applied

1. **`/api/users/pending/route.ts`** - Replaced mock data with actual database query
   - Queries Prisma for users with `status: 'Pending'` in the same firm
   - Requires Partner role to access
   - Returns proper auth errors

2. **`/api/users/[userId]/activate/route.ts`** - Replaced mock response with actual database update
   - Updates user status from `Pending` to `Active`
   - Assigns firm and role
   - Creates `UserAuditLog` entry for the activation
   - Requires Partner role to activate

3. **`/api/auth/provision/route.ts`** - Changed new user status logic
   - First user in a firm is auto-activated as Partner (unchanged)
   - Subsequent users are created with `status: 'Pending'` instead of `'Active'`
   - Pending users get 403 error with message to contact firm Partner

## Local Dev Environment

```bash
# Start database and services
cd infrastructure/docker && docker-compose up -d

# Start web app
cd apps/web && npm run dev  # Runs on port 3000

# Environment files:
# - apps/web/.env.local (Azure AD credentials, GraphQL endpoint)
# - .env (DATABASE_URL, etc.)
```

## Session Log

- [2025-12-13 08:40] Issue created. Initial triage: Root cause identified - three-part problem:
  1. User provisioning creates users with status='Active' instead of 'Pending'
  2. /api/users/pending returns hardcoded mock data, not database queries
  3. /api/users/[userId]/activate returns mock data, no actual database update
     The full user management workflow (pending → activate → active) was never wired to the database.
- [2025-12-13] Session 2 started. Implementing database-backed user management workflow.
- [2025-12-13] Session 2: Implemented all three fixes:
  1. `/api/users/pending/route.ts` - Now queries database for Pending users in same firm
  2. `/api/users/[userId]/activate/route.ts` - Now updates database, assigns firm/role, creates audit log
  3. `/api/auth/provision/route.ts` - New users created as Pending (except first user = Partner + Active)
- [2025-12-13] Session 3: Investigated build failures, fixed and deployed.
  - Initial deploy failed - Docker build was not creating JS files in database dist/
  - Root cause: `pnpm exec tsc` doesn't emit files when `composite: true`
  - Fix: Changed to `pnpm exec tsc --build --force` in Dockerfiles
  - Commit 2752bcc deployed successfully
  - Smoke test passed (web app, gateway responding)
  - `/api/users/pending` returns 401 (correct - requires auth, not mock data)
  - User management workflow is now database-backed and functional

## Files Involved

- `apps/web/src/app/api/auth/provision/route.ts` - User creation (now creates as Pending)
- `apps/web/src/app/api/users/pending/route.ts` - Queries database for pending users
- `apps/web/src/app/api/users/[userId]/activate/route.ts` - Updates database, creates audit log
- `apps/web/src/app/admin/users/pending/page.tsx` - Pending users UI
- `apps/web/src/lib/services/userManagementApi.ts` - API client functions
- `packages/database/prisma/schema.prisma` - User model with UserStatus enum
- `infrastructure/docker/Dockerfile.web` - Fixed tsc --build flag
- `infrastructure/docker/Dockerfile.gateway` - Fixed tsc --build flag
