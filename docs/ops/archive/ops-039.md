# OPS-039: Enhanced Multi-Case Classification Algorithm

**Status:** Verifying | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-18 | **Sessions:** 1 | **Last Active:** 2025-12-18

## Overview

Build a bulletproof algorithm for classifying emails when a contact has multiple active cases.

## Dependencies

- **Depends on:** OPS-035 (data model), builds on OPS-027-029 (existing classification)
- **Blocks:** OPS-041, OPS-042
- **Parallel with:** OPS-038, OPS-040

## Context

Part of the Communications Architecture Rethink. When a client (e.g., Maria Popescu) has multiple active cases, incoming emails must be routed to the correct case with high confidence.

**Existing work:** OPS-027-029 implemented basic classification. This issue enhances the algorithm for the multi-case scenario.

## Requirements

### 1. Classification Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    EMAIL CLASSIFICATION FLOW                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ Email received  │
                    └────────┬────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ Is from court/  │───Yes──▶ COURT FLOW (OPS-040)
                    │ authority?      │
                    └────────┬────────┘
                             No
                              │
                              ▼
                    ┌─────────────────┐
                    │ Thread exists?  │───Yes──▶ Same case as thread
                    │ (conversationId)│         (100% confidence)
                    └────────┬────────┘
                             No
                              │
                              ▼
                    ┌─────────────────┐
                    │ Match sender to │
                    │ case contacts   │
                    └────────┬────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
         0 matches      1 match         2+ matches
              │               │               │
              ▼               ▼               ▼
        → UNCERTAIN     Assign to      MULTI-CASE SCORING
        (unknown        that case      (see below)
         contact)       (high conf)
```

### 2. Multi-Case Scoring Algorithm

When a contact has multiple cases, score each case:

```typescript
interface ClassificationScore {
  caseId: string;
  score: number;
  signals: Signal[];
}

interface Signal {
  type:
    | 'THREAD_CONTINUITY'
    | 'REFERENCE_NUMBER'
    | 'KEYWORD_SUBJECT'
    | 'KEYWORD_BODY'
    | 'RECENT_ACTIVITY'
    | 'SEMANTIC';
  weight: number;
  matched: string; // what matched
}

// Scoring weights
const WEIGHTS = {
  THREAD_CONTINUITY: 100, // Same conversationId - deterministic
  REFERENCE_NUMBER: 50, // Case reference in subject/body
  KEYWORD_SUBJECT: 30, // Case keyword in subject
  KEYWORD_BODY: 20, // Case keyword in body (more noise)
  RECENT_ACTIVITY: 20, // Email within 7 days of last case activity
  SEMANTIC: 15, // AI semantic similarity (fallback)
};

// Decision thresholds
const THRESHOLDS = {
  MIN_SCORE: 70, // Minimum to auto-assign
  MIN_GAP: 20, // Minimum lead over second place
};
```

### 3. Classification Decision

```typescript
function classifyEmail(email: Email, candidateCases: Case[]): ClassificationResult {
  // 1. Check thread continuity first (deterministic)
  const existingThread = findExistingThread(email.conversationId);
  if (existingThread) {
    return {
      caseId: existingThread.caseId,
      state: 'CLASSIFIED',
      confidence: 1.0,
      matchType: 'THREAD_CONTINUITY',
    };
  }

  // 2. Score each candidate case
  const scores = candidateCases.map((c) => scoreCase(email, c));
  scores.sort((a, b) => b.score - a.score);

  const top = scores[0];
  const second = scores[1];
  const gap = second ? top.score - second.score : top.score;

  // 3. Decision
  if (top.score >= THRESHOLDS.MIN_SCORE && gap >= THRESHOLDS.MIN_GAP) {
    return {
      caseId: top.caseId,
      state: 'CLASSIFIED',
      confidence: top.score / 100,
      matchType: top.signals[0].type,
    };
  }

  // 4. Uncertain - needs user review
  return {
    caseId: null,
    state: 'UNCERTAIN',
    confidence: top.score / 100,
    suggestedCases: scores.slice(0, 3),
    reason: gap < THRESHOLDS.MIN_GAP ? 'AMBIGUOUS' : 'LOW_CONFIDENCE',
  };
}
```

### 4. Reference Number Extraction

```typescript
// Common Romanian court reference patterns
const REFERENCE_PATTERNS = [
  /(\d+)\/(\d+)\/(\d{4})/, // 123/45/2025
  /dosar(?:\s+nr\.?)?\s*(\d+\/\d+\/\d{4})/i,
  /nr\.\s*(\d+\/\d+\/\d{4})/i,
];

function extractReferenceNumbers(text: string): string[] {
  const matches: string[] = [];
  for (const pattern of REFERENCE_PATTERNS) {
    const match = text.match(pattern);
    if (match) matches.push(match[1] || match[0]);
  }
  return [...new Set(matches)];
}
```

### 5. Service Implementation

Enhance existing `email-classification.service.ts`:

```typescript
class EmailClassificationService {
  async classifyNewEmail(email: Email): Promise<ClassificationResult> {
    // 1. Check if from court/authority
    if (await this.isFromInstitution(email)) {
      return this.classifyCourtEmail(email); // Delegates to OPS-040
    }

    // 2. Find contact's cases
    const contactCases = await this.findCasesForContact(email.from);

    if (contactCases.length === 0) {
      return { state: 'UNCERTAIN', reason: 'UNKNOWN_CONTACT' };
    }

    if (contactCases.length === 1) {
      return {
        caseId: contactCases[0].id,
        state: 'CLASSIFIED',
        confidence: 0.9,
      };
    }

    // 3. Multi-case scoring
    return this.scoreAndClassify(email, contactCases);
  }
}
```

## Acceptance Criteria

- [x] Thread continuity always wins (same conversation = same case)
- [x] Single-case contacts auto-assign with high confidence
- [x] Multi-case contacts scored with weighted signals
- [x] Reference number extraction works for Romanian formats
- [x] Keyword matching (subject weighted higher than body)
- [x] Recent activity considered
- [x] Uncertain emails marked with `UNCERTAIN` state
- [x] Suggested cases provided for uncertain emails
- [ ] Classification logged for audit trail _(Future: OPS-031 handles this)_
- [x] Unit tests for scoring algorithm
- [x] No TypeScript errors

## Files to Modify

- `services/gateway/src/services/email-classification.service.ts` - enhance
- `services/gateway/src/workers/email-categorization.worker.ts` - use new algorithm
- New: `services/gateway/src/services/classification-scoring.ts`
- Tests: `services/gateway/src/services/classification-scoring.test.ts`

## Estimated Scope

Medium-Large - Algorithm implementation + testing.

---

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

## Session Log

### Session 1 - 2025-12-18

**Work Completed:**

1. **Created `classification-scoring.ts` service** with the enhanced multi-case classification algorithm:
   - `ClassificationScoringService` class with `classifyEmail()` method
   - Thread continuity check (same conversationId = same case, 100% confidence)
   - Contact-to-case lookup supporting actors and client emails
   - Multi-case scoring algorithm with weighted signals

2. **Implemented weighted scoring signals**:
   - `THREAD_CONTINUITY`: 100 points (deterministic)
   - `REFERENCE_NUMBER`: 50 points (case reference in subject/body)
   - `KEYWORD_SUBJECT`: 30 points (case keyword in subject)
   - `KEYWORD_BODY`: 20 points (case keyword in body)
   - `RECENT_ACTIVITY`: 20 points (within 7 days of last case activity)
   - `CONTACT_MATCH`: 10 points (base score for contact association)

3. **Implemented reference number extraction** for Romanian formats:
   - Standard court file: `123/45/2025`
   - "Dosar nr." format
   - Contract references: `CTR-2025-001`
   - Generic references: `REF-12345`

4. **Decision thresholds**:
   - `MIN_SCORE`: 70 (minimum to auto-assign)
   - `MIN_GAP`: 20 (minimum lead over second place)
   - `SINGLE_CASE_CONFIDENCE`: 0.9 (for single-case contacts)

5. **Updated `email-categorization.worker.ts`**:
   - Now uses `classificationScoringService.classifyEmail()` instead of old heuristics
   - Queries emails by `classificationState: Pending` (uses OPS-035 data model)
   - Updates classification metadata on emails (state, confidence, classifiedAt, classifiedBy)
   - Removed old `categorizeByHeuristics()` function

6. **Created comprehensive unit tests** (19 tests, all passing):
   - Reference number extraction tests
   - Weight and threshold validation
   - Thread continuity matching
   - Single-case and multi-case classification
   - Uncertainty handling

**Files Created:**

- `services/gateway/src/services/classification-scoring.ts`
- `services/gateway/src/services/classification-scoring.test.ts`
- `services/gateway/__mocks__/utils/logger.ts`

**Files Modified:**

- `services/gateway/src/workers/email-categorization.worker.ts`
- `services/gateway/__mocks__/@legal-platform/database.ts` (added email model to mock)

**Tests:**

- ✅ TypeScript compiles with no errors
- ✅ All 19 unit tests pass
- ⚠️ Pre-existing test failures in TaskDetailModal.test.tsx (unrelated)

**Next Steps:**

- Local verification with production data
- Run `pnpm preflight:full`
- Test in Docker preview environment
