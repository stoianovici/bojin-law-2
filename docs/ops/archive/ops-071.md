# OPS-071: AssistantPill Components

**Status:** Implemented | **Priority:** P1-High | **Type:** Feature
**Created:** 2025-12-20 | **Depends on:** OPS-070 | **Blocks:** OPS-072, OPS-073, OPS-074, OPS-075, OPS-076
**Sessions:** 1 | **Last Active:** 2025-12-20

## Summary

Create the React components for the interactive AI assistant pill, replacing the existing SuggestionWidget.

## Background

The AssistantPill provides:

1. **Collapsed state**: Floating pill with sparkle icon and unread badge
2. **Expanded state**: Chat interface with message history and input
3. **Action confirmation**: Preview cards with confirm/reject buttons
4. **Accessibility**: Keyboard navigation, focus management

## Requirements

### Component Structure

```
apps/web/src/components/assistant/
├── AssistantPill.tsx        # Main floating container
├── AssistantChat.tsx        # Message list + input wrapper
├── MessageBubble.tsx        # Individual message styling
├── ActionConfirmCard.tsx    # Action preview with buttons
├── AssistantInput.tsx       # Text input with send
└── index.ts                 # Exports
```

### AssistantPill.tsx

```tsx
'use client';

import React, { useRef, useEffect } from 'react';
import { clsx } from 'clsx';
import { SparklesIcon, XMarkIcon } from '@heroicons/react/24/outline';
import { useAssistant } from '@/hooks/useAssistant';
import { AssistantChat } from './AssistantChat';

export function AssistantPill() {
  const { isOpen, isExpanded, toggleOpen, unreadCount, isLoading } = useAssistant();

  const pillRef = useRef<HTMLDivElement>(null);
  const closeButtonRef = useRef<HTMLButtonElement>(null);

  // Focus management
  useEffect(() => {
    if (isOpen && closeButtonRef.current) {
      closeButtonRef.current.focus();
    }
  }, [isOpen]);

  // Keyboard handling
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && isOpen) {
        toggleOpen();
      }
    };
    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [isOpen, toggleOpen]);

  // Click outside to close
  useEffect(() => {
    const handleClickOutside = (e: MouseEvent) => {
      if (isOpen && pillRef.current && !pillRef.current.contains(e.target as Node)) {
        toggleOpen();
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [isOpen, toggleOpen]);

  return (
    <div
      ref={pillRef}
      className={clsx(
        'fixed bottom-6 right-6 z-50 transition-all duration-300',
        isOpen ? 'w-96' : 'w-auto'
      )}
    >
      {!isOpen ? (
        // Collapsed: Floating pill button
        <button
          onClick={toggleOpen}
          className={clsx(
            'flex items-center gap-2 px-4 py-3 rounded-full shadow-lg',
            'bg-primary text-primary-foreground',
            'hover:bg-primary/90 transition-all duration-200 hover:scale-105',
            isLoading && 'animate-pulse'
          )}
          aria-label="Deschide asistentul AI"
        >
          <SparklesIcon className="h-5 w-5" />
          <span className="font-medium">Asistent AI</span>
          {unreadCount > 0 && (
            <span className="flex items-center justify-center h-5 w-5 rounded-full bg-red-500 text-xs font-bold">
              {unreadCount}
            </span>
          )}
        </button>
      ) : (
        // Expanded: Chat interface
        <div className="bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
          {/* Header */}
          <div className="flex items-center justify-between px-4 py-3 bg-primary text-primary-foreground">
            <div className="flex items-center gap-2">
              <SparklesIcon className="h-5 w-5" />
              <span className="font-semibold">Asistent AI</span>
            </div>
            <button
              ref={closeButtonRef}
              onClick={toggleOpen}
              className="p-1 rounded-full hover:bg-white/20 transition-colors"
              aria-label="Închide asistentul"
            >
              <XMarkIcon className="h-5 w-5" />
            </button>
          </div>

          {/* Chat content */}
          <AssistantChat />
        </div>
      )}
    </div>
  );
}

AssistantPill.displayName = 'AssistantPill';
```

### MessageBubble.tsx

```tsx
'use client';

import React from 'react';
import { clsx } from 'clsx';
import { UserIcon, SparklesIcon } from '@heroicons/react/24/outline';

interface MessageBubbleProps {
  role: 'User' | 'Assistant';
  content: string;
  createdAt: string;
}

export function MessageBubble({ role, content, createdAt }: MessageBubbleProps) {
  const isUser = role === 'User';

  return (
    <div className={clsx('flex gap-2 mb-4', isUser ? 'flex-row-reverse' : 'flex-row')}>
      {/* Avatar */}
      <div
        className={clsx(
          'flex-shrink-0 h-8 w-8 rounded-full flex items-center justify-center',
          isUser ? 'bg-gray-200' : 'bg-primary/10'
        )}
      >
        {isUser ? (
          <UserIcon className="h-4 w-4 text-gray-600" />
        ) : (
          <SparklesIcon className="h-4 w-4 text-primary" />
        )}
      </div>

      {/* Message */}
      <div
        className={clsx(
          'max-w-[80%] rounded-2xl px-4 py-2',
          isUser
            ? 'bg-primary text-primary-foreground rounded-br-sm'
            : 'bg-gray-100 text-gray-900 rounded-bl-sm'
        )}
      >
        <p className="text-sm whitespace-pre-wrap">{content}</p>
        <p
          className={clsx('text-xs mt-1', isUser ? 'text-primary-foreground/70' : 'text-gray-500')}
        >
          {new Date(createdAt).toLocaleTimeString('ro-RO', {
            hour: '2-digit',
            minute: '2-digit',
          })}
        </p>
      </div>
    </div>
  );
}
```

### AssistantChat.tsx

```tsx
'use client';

import React, { useRef, useEffect } from 'react';
import { useAssistant } from '@/hooks/useAssistant';
import { MessageBubble } from './MessageBubble';
import { ActionConfirmCard } from './ActionConfirmCard';
import { AssistantInput } from './AssistantInput';

export function AssistantChat() {
  const {
    messages,
    pendingAction,
    isLoading,
    error,
    suggestedFollowUps,
    sendMessage,
    confirmAction,
  } = useAssistant();

  const messagesEndRef = useRef<HTMLDivElement>(null);

  // Auto-scroll to bottom on new messages
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  return (
    <div className="flex flex-col h-96">
      {/* Messages area */}
      <div className="flex-1 overflow-y-auto p-4">
        {messages.length === 0 ? (
          <div className="text-center text-gray-500 py-8">
            <p>Bună! Cu ce vă pot ajuta?</p>
            <p className="text-sm mt-2">
              Puteți să-mi cereți să creez sarcini, să caut documente, sau să rezum emailuri.
            </p>
          </div>
        ) : (
          messages.map((message) => (
            <MessageBubble
              key={message.id}
              role={message.role}
              content={message.content}
              createdAt={message.createdAt}
            />
          ))
        )}

        {/* Pending action confirmation */}
        {pendingAction && (
          <ActionConfirmCard
            action={pendingAction}
            onConfirm={() => confirmAction(true)}
            onReject={() => confirmAction(false)}
            isLoading={isLoading}
          />
        )}

        {/* Loading indicator */}
        {isLoading && !pendingAction && (
          <div className="flex items-center gap-2 text-gray-500 text-sm">
            <div className="animate-spin h-4 w-4 border-2 border-primary border-t-transparent rounded-full" />
            <span>Se procesează...</span>
          </div>
        )}

        {/* Error display */}
        {error && (
          <div className="mx-0 mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p className="text-sm text-red-700">{error}</p>
          </div>
        )}

        <div ref={messagesEndRef} />
      </div>

      {/* Suggested follow-ups */}
      {suggestedFollowUps.length > 0 && (
        <div className="px-4 pb-2 flex flex-wrap gap-2">
          {suggestedFollowUps.map((suggestion, index) => (
            <button
              key={index}
              onClick={() => sendMessage(suggestion)}
              className="text-xs px-3 py-1 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors"
            >
              {suggestion}
            </button>
          ))}
        </div>
      )}

      {/* Input area */}
      <AssistantInput onSend={sendMessage} isLoading={isLoading} />
    </div>
  );
}
```

### AssistantInput.tsx

```tsx
'use client';

import React, { useState, useRef, useEffect } from 'react';
import { PaperAirplaneIcon } from '@heroicons/react/24/solid';
import { clsx } from 'clsx';

interface AssistantInputProps {
  onSend: (message: string) => void;
  isLoading: boolean;
}

export function AssistantInput({ onSend, isLoading }: AssistantInputProps) {
  const [input, setInput] = useState('');
  const inputRef = useRef<HTMLTextAreaElement>(null);

  // Auto-focus on mount
  useEffect(() => {
    inputRef.current?.focus();
  }, []);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (input.trim() && !isLoading) {
      onSend(input.trim());
      setInput('');
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit(e);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="border-t border-gray-200 p-4">
      <div className="flex items-end gap-2">
        <textarea
          ref={inputRef}
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder="Scrieți un mesaj..."
          rows={1}
          className={clsx(
            'flex-1 resize-none rounded-lg border border-gray-300 px-3 py-2',
            'focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent',
            'placeholder:text-gray-400 text-sm',
            'max-h-32'
          )}
          aria-label="Mesaj pentru asistent"
          disabled={isLoading}
        />
        <button
          type="submit"
          disabled={!input.trim() || isLoading}
          className={clsx(
            'p-2 rounded-lg transition-colors',
            input.trim() && !isLoading
              ? 'bg-primary text-primary-foreground hover:bg-primary/90'
              : 'bg-gray-100 text-gray-400 cursor-not-allowed'
          )}
          aria-label="Trimite mesaj"
        >
          <PaperAirplaneIcon className="h-5 w-5" />
        </button>
      </div>
    </form>
  );
}
```

### ActionConfirmCard.tsx

> **Note:** The `Card` component uses `header`, `children` (body), and `footer` props.
> It does NOT export separate `CardContent`/`CardHeader`/`CardFooter` subcomponents.

```tsx
'use client';

import React from 'react';
import { CheckIcon, XMarkIcon } from '@heroicons/react/24/outline';
import { Card } from '@legal-platform/ui';

interface ActionConfirmCardProps {
  action: {
    type: string;
    displayText: string;
    confirmationPrompt?: string;
    entityPreview?: Record<string, unknown>;
  };
  onConfirm: () => void;
  onReject: () => void;
  isLoading: boolean;
}

export function ActionConfirmCard({
  action,
  onConfirm,
  onReject,
  isLoading,
}: ActionConfirmCardProps) {
  return (
    <Card
      className="mb-4 border-primary/20 bg-primary/5"
      footer={
        <div className="flex gap-2">
          <button
            onClick={onReject}
            disabled={isLoading}
            className="flex-1 flex items-center justify-center gap-1 px-3 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 transition-colors disabled:opacity-50"
          >
            <XMarkIcon className="h-4 w-4" />
            <span>Anulează</span>
          </button>
          <button
            onClick={onConfirm}
            disabled={isLoading}
            className="flex-1 flex items-center justify-center gap-1 px-3 py-2 rounded-lg bg-primary text-primary-foreground hover:bg-primary/90 transition-colors disabled:opacity-50"
          >
            <CheckIcon className="h-4 w-4" />
            <span>Confirmă</span>
          </button>
        </div>
      }
    >
      {/* Body content (children prop) */}
      <p className="text-sm font-medium text-gray-900 mb-2">
        {action.confirmationPrompt || 'Confirmați această acțiune?'}
      </p>

      {/* Entity preview */}
      {action.entityPreview && (
        <div className="bg-white rounded-lg p-3 text-sm space-y-1">
          {Object.entries(action.entityPreview).map(([key, value]) => (
            <div key={key} className="flex justify-between">
              <span className="text-gray-500">{key}:</span>
              <span className="font-medium">{String(value)}</span>
            </div>
          ))}
        </div>
      )}
    </Card>
  );
}
```

## Acceptance Criteria

- [x] AssistantPill component with collapsed/expanded states
- [x] AssistantChat with message list and input
- [x] MessageBubble with user/assistant styling
- [x] ActionConfirmCard with preview and buttons
- [x] AssistantInput with send functionality
- [x] Keyboard navigation (Escape to close)
- [x] Focus management when opening
- [x] Click outside to close
- [x] Loading states and error display
- [x] Romanian UI text
- [x] Responsive design
- [x] Accessibility (ARIA labels, focus indicators)
- [ ] Remove/deprecate old SuggestionWidget (deferred to OPS-076)

## Files to Create

- `apps/web/src/components/assistant/AssistantPill.tsx`
- `apps/web/src/components/assistant/AssistantChat.tsx`
- `apps/web/src/components/assistant/MessageBubble.tsx`
- `apps/web/src/components/assistant/ActionConfirmCard.tsx`
- `apps/web/src/components/assistant/AssistantInput.tsx`
- `apps/web/src/components/assistant/index.ts`
- `apps/web/src/components/assistant/AssistantPill.test.tsx`

## Files to Modify

- `apps/web/src/app/layout.tsx` (add AssistantPill to layout)

## SuggestionWidget Deprecation

The existing `SuggestionWidget` (`apps/web/src/components/suggestions/SuggestionWidget.tsx`)
is replaced by the AssistantPill. Deprecation steps:

1. **Hide SuggestionWidget** - Comment out or remove from layout during this issue
2. **Migrate proactive suggestions** - OPS-076 handles this via `BriefingHandler`
3. **Remove SuggestionWidget** - After OPS-076 is complete, delete the component entirely

Do NOT reference `suggestionService` in new code - use `BriefingHandler.getProactiveMessages()` instead.

## Session Log

### Session 1 (2025-12-20)

**Work Completed:**

1. Discovered OPS-070 (useAssistant hook) was already implemented
2. Created all AssistantPill components:
   - `AssistantPill.tsx` - Main floating container with collapsed/expanded states
   - `AssistantChat.tsx` - Message list with loading, error, and suggested follow-ups
   - `MessageBubble.tsx` - Individual message with user/assistant styling
   - `ActionConfirmCard.tsx` - Action preview with confirm/reject buttons
   - `AssistantInput.tsx` - Text input with send button
   - `index.ts` - Exports for all components

3. Added AssistantPill to ConditionalLayout.tsx (renders for authenticated users)

4. Key implementation notes:
   - Used Radix UI icons (`@radix-ui/react-icons`) instead of Heroicons
   - Created custom SparklesIcon SVG component (matching existing pattern)
   - All UI text in Romanian
   - Accessibility: ARIA labels, keyboard navigation (Escape to close), focus management
   - Click outside to close

5. All preflight checks passed (TypeScript, Docker build, production build)

**Files Created:**

- `apps/web/src/components/assistant/AssistantPill.tsx`
- `apps/web/src/components/assistant/AssistantChat.tsx`
- `apps/web/src/components/assistant/MessageBubble.tsx`
- `apps/web/src/components/assistant/ActionConfirmCard.tsx`
- `apps/web/src/components/assistant/AssistantInput.tsx`
- `apps/web/src/components/assistant/index.ts`

**Files Modified:**

- `apps/web/src/components/layout/ConditionalLayout.tsx` (added AssistantPill import and render)

#### Local Verification Status

| Step           | Status     | Notes                           |
| -------------- | ---------- | ------------------------------- |
| Prod data test | ⬜ Pending |                                 |
| Preflight      | ✅ Passed  | All 6 checks passed, 2 warnings |
| Docker test    | ⬜ Pending |                                 |

**Verified**: Partial (preflight passed, awaiting UI verification)
