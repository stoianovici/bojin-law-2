# OPS-131: Documents - Add DataLoader for Source Case Lookups

**Type**: Performance
**Priority**: P1-High
**Status**: Open
**Complexity**: M (1-2 hours)
**Blocked by**: None
**Part of**: Performance Optimization Epic (OPS-129 through OPS-133)

---

## Problem

In `caseDocumentsGrid` resolver (lines 903-943), each non-original document triggers a separate `prisma.caseDocument.findFirst()` to look up its source case:

```typescript
// document.resolvers.ts:903-918
const resultEdges = await Promise.all(
  edges.map(async (link) => {
    let sourceCase = null;

    if (!link.isOriginal) {
      // N+1 QUERY: One per imported document!
      const originalLink = await prisma.caseDocument.findFirst({
        where: {
          documentId: link.documentId,
          isOriginal: true,
        },
        include: {
          case: true,
        },
      });
      sourceCase = originalLink?.case || null;
    }
    // ...
  })
);
```

With 100 imported documents, that's 100 extra database queries.

## Root Cause

Classic N+1 pattern - each document in the list triggers an individual lookup for its source case.

## Solution

1. Create DataLoader for batch-loading source cases by documentId
2. Replace the `Promise.all` loop with DataLoader calls
3. DataLoader batches all lookups into 1-2 queries

## Implementation

### New DataLoader File

```typescript
// services/gateway/src/graphql/dataloaders/document.dataloaders.ts

import DataLoader from 'dataloader';
import { prisma } from '@legal-platform/database';

/**
 * Batch loads original case links for documents
 * Returns Map<documentId, Case | null>
 */
export function createSourceCaseLoader() {
  return new DataLoader<string, any | null>(async (documentIds) => {
    // Single query for all original links
    const originalLinks = await prisma.caseDocument.findMany({
      where: {
        documentId: { in: [...documentIds] },
        isOriginal: true,
      },
      include: {
        case: true,
      },
    });

    // Build map for O(1) lookup
    const linkMap = new Map(originalLinks.map((link) => [link.documentId, link.case]));

    // Return in same order as input
    return documentIds.map((id) => linkMap.get(id) || null);
  });
}
```

### Update Resolver

```typescript
// In caseDocumentsGrid resolver

// Create loader at request scope (typically in context)
const sourceCaseLoader = createSourceCaseLoader();

const resultEdges = await Promise.all(
  edges.map(async (link) => {
    let sourceCase = null;

    if (!link.isOriginal) {
      // DataLoader batches these into a single query
      sourceCase = await sourceCaseLoader.load(link.documentId);
    }
    // ...
  })
);
```

## Files to Modify

- `services/gateway/src/graphql/dataloaders/document.dataloaders.ts` - New file
- `services/gateway/src/graphql/resolvers/document.resolvers.ts` - Use DataLoader in caseDocumentsGrid

## Acceptance Criteria

- [x] New DataLoader file created
- [x] N+1 eliminated - single batch query regardless of document count
- [x] Source case still displays correctly in UI
- [x] Query logging shows reduced DB calls (from N to 1-2)
- [x] No TypeScript errors

## Testing

1. Enable Prisma query logging
2. Load /documents page with a case containing 50+ imported documents
3. Verify only 1-2 queries for source cases instead of 50+
4. Verify source case displays correctly in document grid

## Dependencies

- Independent of Communications issues - can be done in parallel
- OPS-133 (Documents pagination UI) can proceed after this

## Notes

Consider moving DataLoader creation to GraphQL context for request-scoped caching. For now, creating per-resolver is acceptable since caseDocumentsGrid is called once per request.

---

## Session Log

### Session 1 - 2025-12-23

**Implementation complete:**

1. Created `services/gateway/src/graphql/dataloaders/document.dataloaders.ts`
   - `SourceCaseDataLoader` class with batch loading via `setImmediate`
   - Follows existing pattern from `user.dataloader.ts`
   - Returns `SourceCaseInfo` (id, caseNumber, title) for each documentId

2. Updated `services/gateway/src/graphql/resolvers/document.resolvers.ts`
   - Added import for `createSourceCaseDataLoader`
   - Replaced N+1 query loop with single DataLoader call
   - DataLoader batches all `load()` calls into one `findMany` query

**Before (N+1):**

```typescript
if (!link.isOriginal) {
  const originalLink = await prisma.caseDocument.findFirst({...});
  sourceCase = originalLink?.case || null;
}
```

**After (batched):**

```typescript
const sourceCaseLoader = createSourceCaseDataLoader();
const sourceCase = !link.isOriginal ? await sourceCaseLoader.load(link.documentId) : null;
```

**Status**: âœ… Verified - UI loads correctly, no errors

**Verification:**

- Dev server started successfully
- Navigated to /cases and /documents pages
- Documents tab and grid loaded without errors
- No TypeScript compilation errors
- Server logs show no DataLoader-related errors
