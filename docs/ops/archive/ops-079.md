# OPS-079: Integration Tests

**Status:** Completed | **Priority:** P2-Medium | **Type:** Testing
**Created:** 2025-12-20 | **Depends on:** OPS-078 | **Completed:** 2025-12-20

## Summary

Create comprehensive integration tests for the AI assistant end-to-end flow.

## Background

Integration tests should cover:

- Full message flow from frontend to AI service
- Action confirmation and execution
- Error handling and recovery
- Multi-turn conversations
- Context switching

## Requirements

### Test Scenarios

```typescript
// services/gateway/src/services/__tests__/ai-assistant.integration.test.ts

describe('AI Assistant Integration', () => {
  describe('Message Flow', () => {
    it('sends message and receives response', async () => {
      // 1. Create test user context
      // 2. Send message via GraphQL
      // 3. Verify response structure
      // 4. Check conversation persisted
    });

    it('maintains conversation context across messages', async () => {
      // 1. Send first message about a case
      // 2. Send follow-up without case reference
      // 3. Verify context maintained
    });

    it('handles intent detection with low confidence', async () => {
      // 1. Send ambiguous message
      // 2. Verify clarification response
      // 3. Verify suggested follow-ups
    });
  });

  describe('Action Confirmation', () => {
    it('proposes action and awaits confirmation', async () => {
      // 1. Send task creation message
      // 2. Verify action proposed with preview
      // 3. Conversation status = AwaitingConfirmation
    });

    it('executes action on confirmation', async () => {
      // 1. Setup pending action
      // 2. Confirm action
      // 3. Verify task created
      // 4. Verify success message
    });

    it('cancels action on rejection', async () => {
      // 1. Setup pending action
      // 2. Reject action
      // 3. Verify task NOT created
      // 4. Verify cancellation message
    });
  });

  describe('Intent Handlers', () => {
    describe('Task Handler', () => {
      it('creates task from natural language', async () => {
        const response = await sendMessage('Creează o sarcină pentru mâine să pregătesc dosarul');
        expect(response.message.intent).toBe('CreateTask');
        expect(response.message.proposedAction).toBeDefined();
      });

      it('queries tasks for time range', async () => {
        const response = await sendMessage('Ce am de făcut săptămâna asta?');
        expect(response.message.intent).toBe('QueryTasks');
        expect(response.message.content).toContain('sarcini');
      });
    });

    describe('Case Query Handler', () => {
      it('returns case status', async () => {
        const response = await sendMessage('Care e statusul dosarului Ionescu?');
        expect(response.message.intent).toBe('CaseQuery');
      });

      it('generates case summary', async () => {
        const response = await sendMessage('Fă-mi un rezumat al dosarului');
        expect(response.message.content).toContain('Rezumat');
      });
    });

    describe('Email Handler', () => {
      it('searches emails', async () => {
        const response = await sendMessage('Caută emailurile de la instanță');
        expect(response.message.intent).toBe('SearchEmails');
      });

      it('drafts email response', async () => {
        const response = await sendMessage('Scrie un răspuns formal');
        expect(response.message.proposedAction?.type).toBe('DraftEmail');
      });
    });

    describe('Document Handler', () => {
      it('finds documents', async () => {
        const response = await sendMessage('Găsește contractul de reprezentare');
        expect(response.message.intent).toBe('FindDocument');
      });
    });
  });

  describe('Error Handling', () => {
    it('recovers from AI service timeout', async () => {
      // Mock AI service to timeout
      // Verify fallback message
    });

    it('handles rate limiting gracefully', async () => {
      // Send many messages quickly
      // Verify rate limit message
    });

    it('handles missing case gracefully', async () => {
      const response = await sendMessage('Statusul dosarului XYZ123');
      expect(response.message.content).toContain('Nu am găsit');
    });
  });

  describe('Multi-turn Conversation', () => {
    it('maintains context across turns', async () => {
      // Turn 1: Ask about case
      await sendMessage('Arată-mi dosarul Ionescu');

      // Turn 2: Ask follow-up (should use case context)
      const response = await sendMessage('Ce documente are?');
      expect(response.message.intent).toBe('ListDocuments');
    });

    it('clears context when requested', async () => {
      await sendMessage('Conversație nouă');
      // Verify context cleared
    });
  });
});
```

### Test Utilities

```typescript
// services/gateway/src/test-utils/assistant.helpers.ts

export async function sendAssistantMessage(content: string, context?: AssistantContext) {
  // Execute GraphQL mutation
  // Return typed response
}

export async function confirmAssistantAction(messageId: string, confirmed: boolean) {
  // Execute confirm mutation
  // Return result
}

export function createTestConversation(
  userId: string,
  firmId: string,
  messages?: Partial<AIMessage>[]
) {
  // Create conversation with messages in test DB
}
```

### Frontend Integration Tests

```typescript
// apps/web/src/components/assistant/__tests__/AssistantPill.integration.test.tsx

describe('AssistantPill Integration', () => {
  it('opens and shows initial state', async () => {
    render(<AssistantPill />);

    fireEvent.click(screen.getByRole('button', { name: /asistent/i }));

    expect(screen.getByText('Asistent AI')).toBeInTheDocument();
    expect(screen.getByPlaceholderText(/scrieți/i)).toBeInTheDocument();
  });

  it('sends message and displays response', async () => {
    render(<AssistantPill />);

    // Open
    fireEvent.click(screen.getByRole('button', { name: /asistent/i }));

    // Type and send
    const input = screen.getByPlaceholderText(/scrieți/i);
    fireEvent.change(input, { target: { value: 'Bună ziua' } });
    fireEvent.click(screen.getByRole('button', { name: /trimite/i }));

    // Wait for response
    await waitFor(() => {
      expect(screen.getByText(/Bună!/i)).toBeInTheDocument();
    });
  });

  it('shows action confirmation card', async () => {
    // Mock response with action
    server.use(
      graphql.mutation('SendAssistantMessage', (req, res, ctx) => {
        return res(ctx.data({
          sendAssistantMessage: {
            message: {
              id: '1',
              role: 'Assistant',
              content: 'Am pregătit sarcina',
              proposedAction: {
                type: 'CreateTask',
                displayText: 'Creează sarcină',
                requiresConfirmation: true,
              },
            },
          },
        }));
      })
    );

    // ... test action card appears
  });
});
```

## Acceptance Criteria

- [x] Backend integration tests for all intent handlers
- [x] Action confirmation flow tested
- [x] Error handling scenarios covered
- [x] Multi-turn conversation tested
- [x] Frontend integration tests
- [x] Test utilities created
- [x] All tests pass in CI

## Files Created

- `services/gateway/src/services/__tests__/ai-assistant.integration.test.ts` - 26 tests covering all scenarios
- `services/gateway/src/test-utils/assistant.helpers.ts` - Test utilities and factories
- `apps/web/src/components/assistant/__tests__/AssistantPill.test.tsx` - 6 component tests

## Session Log

- [2025-12-20] Session 1 started
  - Analyzed existing test infrastructure - found significant coverage already exists:
    - OPS-066: `ai-orchestrator.service.test.ts` (error handling, low confidence)
    - OPS-065: `conversation.service.test.ts` (CRUD, firm isolation)
    - OPS-067: `action-executor.service.test.ts` (action execution)
    - OPS-070: `useAssistant.test.tsx` (React hook tests)
    - OPS-069: `assistant.store.test.ts` (Zustand store)
    - OPS-080: `assistant.spec.ts` (Playwright E2E)
  - Created backend integration test file with 26 tests:
    - Full message flow (3 tests)
    - Action confirmation flow (3 tests)
    - Intent handler integration (7 tests)
    - Error handling (4 tests)
    - Multi-turn conversations (3 tests)
    - Low confidence handling (2 tests)
    - Conversation persistence (4 tests)
  - Created test utilities helper with factories and assertion helpers
  - Created component tests for AssistantPill (6 tests)
  - All tests pass: 26 backend + 6 frontend = 32 new tests
- [2025-12-20] Issue completed
