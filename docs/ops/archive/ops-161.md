# OPS-161: Enhance clients-top-clients with revenue

| Field        | Value                                      |
| ------------ | ------------------------------------------ |
| **Status**   | Complete                                   |
| **Type**     | Feature                                    |
| **Priority** | P3-Low                                     |
| **Created**  | 2025-12-24                                 |
| **Epic**     | Reports Data Accuracy (OPS-156 to OPS-161) |

## Problem

The `clients-top-clients` report (Clienți Principali) currently uses `queryClients()` which returns clients sorted by case count. But the description says "Cei mai importanți clienți după **venituri** și activitate" - should include revenue.

## Current Behavior

Returns:

```typescript
{ label: 'Client A', value: 5, metadata: { clientId, activeCases: 3 } }
```

Where `value` is total case count.

## Desired Behavior

Returns:

```typescript
{
  label: 'Client A',
  value: 15000,  // revenue in RON
  metadata: {
    clientId,
    caseCount: 5,
    activeCases: 3,
    billableHours: 75
  }
}
```

Sorted by revenue (primary metric).

## Solution

1. Enhance `queryClients()` or add `getTopClientsByRevenue()` that:
   - Joins with time entries to calculate revenue per client
   - Sums `hours * hourlyRate` for billable entries
   - Sorts by revenue descending
   - Returns revenue as primary value, case count in metadata
2. Route `clients-top-clients` to enhanced method

## Files

- `services/gateway/src/services/report-data.service.ts`
- `services/gateway/src/graphql/resolvers/reports.resolvers.ts`

## Done When

- [x] Report shows clients with revenue amounts (formatted as currency)
- [x] Sorted by revenue by default
- [x] Case count and billable hours shown in tooltip/metadata
- [x] Bar chart displays revenue per client

## Implementation

Added `getTopClientsByRevenue(dateRange)` method to `report-data.service.ts`:

- Queries billable time entries within date range
- Joins to cases → clients to get client info
- Calculates revenue as `hours × hourlyRate` per client
- Returns top 20 clients sorted by revenue descending
- Includes metadata: `caseCount`, `activeCases`, `billableHours`

Updated `reports.resolvers.ts` to route `clients-top-clients` report to the new method.
