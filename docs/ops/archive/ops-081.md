# OPS-081: AI Assistant Architecture - Switch to Direct Sonnet with Tools

**Status:** Open | **Priority:** P0-Critical | **Type:** Architecture
**Created:** 2025-12-21 | **Blocks:** OPS-082 through OPS-086

## Summary

Replace the two-stage Claude Haiku intent-detection pipeline with a single Claude Sonnet conversation using native tool calling. This fixes the fundamental architectural flaw where we "dumb down" the AI by constraining it to pattern-matching instead of leveraging its natural language understanding.

## Problem Statement

The current architecture:

```
User Message → Haiku (Intent Detection) → Intent Handler → Haiku (NL Command) → Action
                     ↓                          ↓
              Rigid prompts with          Second rigid prompt
              limited examples            loses context
```

**Why this fails:**

1. **Two-stage context loss** - Information extracted in stage 1 doesn't fully transfer to stage 2
2. **Rigid example-based prompts** - Only recognizes patterns explicitly listed in prompts
3. **Romanian complexity ignored** - Complex sentences like "adauga un task de finalizat pana vinerea viitoare - Fa contractul de comodat TT solaria" don't match simple examples
4. **Date parsing incomplete** - "vinerea viitoare" isn't explicitly documented as a pattern
5. **Wasted capability** - Haiku can understand Romanian naturally, but we constrain it to keyword matching

## Solution

Single-stage architecture with Claude Sonnet and native tool calling:

```
User Message → Sonnet (with tools + context) → Tool Calls → Execute → Response
                         ↓
              Understands Romanian naturally
              Has full conversation context
              Decides which tools to call
```

**Benefits:**

1. **Natural understanding** - Sonnet understands Romanian fluently without explicit examples
2. **Single context** - No information loss between stages
3. **Tool calling** - Structured output via native tool use, not regex/prompt extraction
4. **Simpler code** - Remove NL command service, intent detection prompts, handler routing

## Scope

This epic covers:

| Issue   | Title                           | Scope                                                   |
| ------- | ------------------------------- | ------------------------------------------------------- |
| OPS-082 | Define Claude Tool Schemas      | Tool definitions for all assistant actions              |
| OPS-083 | Legal Assistant System Prompt   | Context, capabilities, Romanian language                |
| OPS-084 | Direct Sonnet Conversation      | Replace orchestrator with tool-calling (delete old)     |
| OPS-085 | Tool Execution Layer            | Replace intent handlers with tool executor (delete old) |
| OPS-086 | Frontend Tool Response Handling | Handle tool calls/results in UI                         |

Legacy code cleanup is done inline - each issue deletes what it replaces.

## Architecture Comparison

### Before (Current)

```typescript
// ai-orchestrator.service.ts - 400+ lines of intent detection
const INTENT_DETECTION_PROMPT = `...
  Exemple:
  - "creează o sarcină" → CreateTask
  - "adaugă task" → CreateTask
  ...`;

// Intent handler routing
switch (intent) {
  case 'CreateTask':
    return taskHandler.handle(params);
  // ...
}

// natural-language-command.service.ts - Another 300+ lines
const INTENT_DETECTION_SYSTEM_PROMPT = `...
  For dates, interpret Romanian date expressions:
  - "mâine" = tomorrow
  - "vineri" = this/next Friday
  ...`;
```

### After (Proposed)

```typescript
// ai-assistant.service.ts - Much simpler
const tools = [
  {
    name: 'create_task',
    description: 'Create a new task in a case',
    input_schema: {
      type: 'object',
      properties: {
        title: { type: 'string', description: 'Task title' },
        dueDate: { type: 'string', description: 'Due date (ISO 8601)' },
        caseId: { type: 'string', description: 'Case ID' },
        priority: { enum: ['Low', 'Medium', 'High', 'Urgent'] },
      },
      required: ['title'],
    },
  },
  // ... other tools
];

const response = await anthropic.messages.create({
  model: 'claude-sonnet-4-20250514',
  system: LEGAL_ASSISTANT_SYSTEM_PROMPT,
  messages: conversationHistory,
  tools,
});

// Claude naturally understands "adauga un task de finalizat pana vinerea viitoare"
// and calls create_task with { title: "Fa contractul...", dueDate: "2025-12-27" }
```

## Success Criteria

- [ ] User can say "adauga un task de finalizat pana vinerea viitoare - Fa contractul de comodat TT solaria" and get correct task creation
- [ ] Complex Romanian sentences work without explicit examples
- [ ] Date expressions like "vinerea viitoare", "luna viitoare", "peste 3 zile" work naturally
- [ ] Multi-part commands (action + deadline + description) parse correctly
- [ ] Response latency acceptable (< 3s for simple commands)
- [ ] Cost increase from Haiku→Sonnet is justified by reliability improvement

## Migration Strategy

1. **Parallel implementation** - Build new service alongside existing
2. **Direct replacement** - Each issue deletes what it replaces in the same PR
3. **No feature flag** - Clean switch, simpler than maintaining two paths

## Session Log

- [2025-12-21] Issue created after analysis of Romanian prompt parsing failures
