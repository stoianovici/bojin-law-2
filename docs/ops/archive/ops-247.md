# OPS-247: Per-User AI Usage Dashboard

**Type**: Feature
**Priority**: P2-Medium
**Status**: Completed
**Epic**: AI Batch Processing & Ops Dashboard

## Problem

The current AI Ops dashboard shows aggregate user costs in a table (OPS-244), but Partners can't drill down into individual user usage patterns. Need visibility into:

- Which features each user uses most
- Daily usage trends per user
- Recent activity log for auditing

## Solution

Add a per-user detail page accessible by clicking on a user in the costs breakdown table.

### User List Enhancement

Update `UserUsageTable` in `/admin/ai-ops/costs` to make rows clickable, navigating to `/admin/ai-ops/users/[userId]`.

### User Detail Page

**Route**: `/admin/ai-ops/users/[userId]`

**Layout**:

```
┌─────────────────────────────────────────────────────────────┐
│  ← Înapoi                                [Ultimele 30 zile] │
│                                                             │
│  Maria Popescu                                              │
│  avocat@bojin.law                                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   €28.45    │  │   245K      │  │     89      │         │
│  │  Cost Total │  │   Tokeni    │  │  Apeluri AI │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  TREND ZILNIC                                               │
│  [Line chart - daily cost over selected period]             │
│                                                             │
│  UTILIZARE PE FUNCȚIONALITATE                               │
│  [Horizontal bar chart - % by feature]                      │
│                                                             │
│  ACTIVITATE RECENTĂ                                         │
│  [Table - last 50 AI calls with timestamp, feature, tokens] │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### GraphQL Schema Additions

```graphql
extend type Query {
  # User-specific usage data
  aiUserUsage(userId: ID!, dateRange: DateRangeInput!): AIUserUsage! @auth(requires: PARTNER)

  # User activity log with pagination
  aiUserActivity(userId: ID!, limit: Int = 50, offset: Int = 0): [AIUsageLogEntry!]!
    @auth(requires: PARTNER)
}

type AIUserUsage {
  user: User!
  totalCost: Float!
  totalTokens: Int!
  totalCalls: Int!
  dailyCosts: [DailyCost!]!
  costsByFeature: [FeatureCost!]!
}

type AIUsageLogEntry {
  id: ID!
  feature: String!
  featureName: String!
  inputTokens: Int!
  outputTokens: Int!
  costEur: Float!
  durationMs: Int!
  createdAt: DateTime!
  entityType: String
  entityId: String
}
```

### Service Layer

Add to `AIUsageService`:

```typescript
async getUserUsage(
  firmId: string,
  userId: string,
  dateRange: DateRange
): Promise<AIUserUsage> {
  const [totals, dailyCosts, costsByFeature] = await Promise.all([
    this.getUserTotals(firmId, userId, dateRange),
    this.getUserDailyCosts(firmId, userId, dateRange),
    this.getUserCostsByFeature(firmId, userId, dateRange),
  ]);

  return { ...totals, dailyCosts, costsByFeature };
}

async getUserActivity(
  firmId: string,
  userId: string,
  limit: number,
  offset: number
): Promise<AIUsageLogEntry[]> {
  return prisma.aIUsageLog.findMany({
    where: { firmId, userId },
    orderBy: { createdAt: 'desc' },
    take: limit,
    skip: offset,
  });
}
```

### Privacy Note

Activity log shows:

- Timestamp
- Feature used
- Token count
- Cost
- Entity type/ID (e.g., "case", "case-123")

Does NOT show:

- Actual conversation content
- Prompts or responses
- Document contents

This is metrics-only monitoring, not content surveillance.

## Acceptance Criteria

- [x] User rows in costs table are clickable
- [x] User detail page shows stats, charts, and activity
- [x] Daily cost trend chart for user
- [x] Feature breakdown chart for user
- [x] Activity log with pagination (last 50, load more)
- [x] Back button returns to costs page
- [x] Date range selector affects all data
- [x] Partner-only access enforced
- [x] Romanian UI labels

## Files to Create

- `apps/web/src/app/admin/ai-ops/users/[userId]/page.tsx` - User detail page
- `apps/web/src/components/admin/UserActivityTable.tsx` - Activity log table
- `apps/web/src/hooks/useUserAIUsage.ts` - GraphQL hooks

## Files to Modify

- `apps/web/src/components/admin/UserUsageTable.tsx` - Make rows clickable
- `services/gateway/src/graphql/schema/ai-ops.graphql` - Add new types and queries
- `services/gateway/src/graphql/resolvers/ai-ops.resolvers.ts` - Add resolvers
- `services/gateway/src/services/ai-usage.service.ts` - Add user-specific methods

## Dependencies

- OPS-244 (Cost Breakdown page - completed)
- OPS-241 (GraphQL schema - completed)

## Complexity

**Small-Medium** - Reuses existing patterns from OPS-244, just filtered by userId.
