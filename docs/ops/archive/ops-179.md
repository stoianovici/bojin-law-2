# OPS-179: SharePoint Change Detection Methods

**Type**: Feature
**Priority**: P1-High
**Status**: Complete
**Epic**: Frictionless SharePoint-First Document Editing

## Problem

No method to efficiently check if a SharePoint document has been modified since we last saw it. Without this, we cannot implement lazy version detection when users return from Word.

## Solution

Add `checkForChanges(itemId, knownLastModified)` method to SharePointService that compares timestamps. Use eTag as faster alternative when available.

## Implementation

### New Method in SharePointService

```typescript
/**
 * Check if a SharePoint document has been modified since a known timestamp
 *
 * @param accessToken - User's access token
 * @param itemId - SharePoint item ID
 * @param knownLastModified - ISO timestamp of last known modification
 * @returns Whether document changed and current metadata
 */
async checkForChanges(
  accessToken: string,
  itemId: string,
  knownLastModified: string
): Promise<{ changed: boolean; currentMetadata: SharePointItem | null }> {
  try {
    const metadata = await this.getFileMetadata(accessToken, itemId);
    const changed = metadata.lastModifiedDateTime !== knownLastModified;
    return { changed, currentMetadata: metadata };
  } catch (error: any) {
    // Handle 404 - document was deleted
    if (error.statusCode === 404) {
      return { changed: true, currentMetadata: null };
    }
    throw error;
  }
}

/**
 * Check if document changed using eTag (faster, no metadata fetch)
 */
async checkForChangesByETag(
  accessToken: string,
  itemId: string,
  knownETag: string
): Promise<{ changed: boolean; currentETag: string | null }> {
  // Uses If-None-Match header for efficient check
  // Returns 304 Not Modified if unchanged
}
```

## Files to Modify

- `services/gateway/src/services/sharepoint.service.ts`

## Done When

- [x] `checkForChanges()` method added to SharePointService
- [x] Returns `{ changed: boolean, currentMetadata: SharePointItem | null }`
- [x] Handles 404 (document deleted) gracefully
- [x] Optional: `checkForChangesByETag()` for faster checks

## Dependencies

- None (foundation issue)

## Parallel With

- OPS-178: SharePoint Edit Session Schema
- OPS-180: SharePoint Document Download Method

## Implementation Notes (2024-12-24)

Added two methods to `SharePointService`:

1. **`checkForChanges()`** - Compares `lastModifiedDateTime` timestamps
   - Uses existing `getFileMetadata()` under the hood
   - Compares timestamps as epoch milliseconds to avoid string comparison issues
   - Returns `ChangeDetectionResult` interface with `changed`, `currentMetadata`, and optional `currentETag`

2. **`checkForChangesByETag()`** - Faster check using only eTag
   - Uses `select('id,eTag')` to minimize data transfer
   - Good for frequent polling scenarios
   - Returns `{ changed, currentETag }`

Both methods handle 404 gracefully (document deleted = changed: true, null metadata).
