# OPS-132: Communications - Add Load More / Infinite Scroll

**Type**: UI
**Priority**: P2-Medium
**Status**: Closed
**Complexity**: M (1-2 hours)
**Blocked by**: OPS-129
**Part of**: Performance Optimization Epic (OPS-129 through OPS-133)

---

## Problem

With limit=50 (from OPS-129), users need a way to load more threads. Currently no "load more" or infinite scroll exists - users are limited to the first 50 threads.

## Solution

1. Add `fetchMore` to the Apollo query
2. Add "Load more" button at bottom of thread list (simpler than infinite scroll)
3. Track hasMore state based on returned count

## Implementation

### Update Hook

```typescript
// apps/web/src/hooks/useMyEmailsByCase.ts

export function useMyEmailsByCase(options?: { limit?: number }) {
  const { limit = 50 } = options || {};
  const [hasMore, setHasMore] = useState(true);

  const {
    data: threadsData,
    loading: threadsLoading,
    error: threadsError,
    refetch: refetchThreads,
    fetchMore,
  } = useQuery<...>(GET_EMAIL_THREADS_BY_CASE, {
    variables: { limit, offset: 0 },
    fetchPolicy: 'cache-and-network',
    onCompleted: (data) => {
      // If we got fewer than requested, no more to load
      if (data.emailThreads.length < limit) {
        setHasMore(false);
      }
    },
  });

  const loadMore = useCallback(async () => {
    if (!hasMore || threadsLoading) return;

    const currentCount = threadsData?.emailThreads.length || 0;

    const result = await fetchMore({
      variables: { offset: currentCount },
      updateQuery: (prev, { fetchMoreResult }) => {
        if (!fetchMoreResult) return prev;

        // Check if we got fewer than limit
        if (fetchMoreResult.emailThreads.length < limit) {
          setHasMore(false);
        }

        return {
          ...prev,
          emailThreads: [
            ...prev.emailThreads,
            ...fetchMoreResult.emailThreads,
          ],
        };
      },
    });
  }, [hasMore, threadsLoading, threadsData, fetchMore, limit]);

  return {
    data: organizedData,
    loading: threadsLoading || courtLoading || uncertainLoading,
    error: threadsError || courtError || uncertainError,
    refetch,
    loadMore,
    hasMore,
  };
}
```

### Update Sidebar

```typescript
// apps/web/src/components/communication/CaseSidebar.tsx

interface CaseSidebarProps {
  // ... existing props
  hasMoreThreads?: boolean;
  onLoadMore?: () => void;
  loadingMore?: boolean;
}

// At bottom of thread list
{hasMoreThreads && (
  <div className="p-4 border-t">
    <button
      onClick={onLoadMore}
      disabled={loadingMore}
      className="w-full py-2 text-sm text-blue-600 hover:text-blue-700 disabled:opacity-50"
    >
      {loadingMore ? 'Se încarcă...' : 'Încarcă mai multe conversații'}
    </button>
  </div>
)}
```

## Files to Modify

- `apps/web/src/hooks/useMyEmailsByCase.ts`
  - Add fetchMore to query
  - Add loadMore callback
  - Track hasMore state
  - Export loadMore and hasMore

- `apps/web/src/components/communication/CaseSidebar.tsx`
  - Add load more button at bottom
  - Handle loading state

- `apps/web/src/app/communications/page.tsx`
  - Pass loadMore and hasMore to CaseSidebar

## Acceptance Criteria

- [x] "Load more" button appears when more threads exist
- [x] Clicking loads next batch (50 more) and appends to list
- [x] Button disappears when all threads loaded
- [x] No duplicate threads in list
- [x] Loading state shows while fetching
- [x] Works with case-organized grouping

## Testing

1. Have a firm with 100+ email threads
2. Load /communications - should show ~50 threads
3. Click "Load more" - should add 50 more
4. If < 100 more exist, button should disappear after loading all
5. Verify threads appear in correct cases

## Dependencies

- **Blocked by OPS-129**: Need limit=50 first, otherwise button would never appear
- Can run in parallel with OPS-133 (Documents pagination)

---

## Session Log

### 2025-12-23 - Verification & Closure

**Status**: Confirmed implementation already complete

The Load More UI was already fully implemented:

1. **`useMyEmailsByCase.ts`**:
   - `hasMore` state tracking (line 235)
   - `loadingMore` state tracking (line 236)
   - `fetchMore` from Apollo query (line 244)
   - `loadMore` callback with proper offset handling (lines 365-392)
   - All values exported in return (lines 494-497)

2. **`CaseSidebar.tsx`**:
   - Props interface updated with `hasMoreThreads`, `onLoadMore`, `loadingMore` (lines 58-61)
   - "Load more" button at bottom of thread list (lines 492-503)
   - Romanian text: "Încarcă mai multe conversații" / "Se încarcă..."

3. **`communications/page.tsx`**:
   - Destructures `loadMore`, `hasMore`, `loadingMore` from hook (lines 153-155)
   - Passes to CaseSidebar (lines 519-522)

**Verification**: TypeScript compilation passes with no errors.
