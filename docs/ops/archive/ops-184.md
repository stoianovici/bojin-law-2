# OPS-184: OneDrive to SharePoint Lazy Migration

**Type**: Feature
**Priority**: P3-Low
**Status**: Complete
**Epic**: Frictionless SharePoint-First Document Editing

## Problem

Existing documents with only `oneDriveId` (no `sharePointItemId`) still use the slow OneDrive copy path when opening in Word. These legacy documents don't benefit from the SharePoint-first improvements.

## Solution

When closing a Word session for a legacy OneDrive document, copy it to SharePoint and update the document record. Next edit will use the fast SharePoint path. No batch migration needed - documents migrate gradually through normal use.

## Implementation (Completed)

### 1. OneDrive Download Method

Added `downloadDocument` to `OneDriveService`:

- Downloads file content as Buffer using the pre-authenticated download URL
- Handles errors gracefully with proper logging

### 2. Migration Method

Added `migrateOneDriveToSharePoint` to `WordIntegrationService`:

- Checks if document is OneDrive-only (no sharePointItemId)
- Downloads content from OneDrive
- Uploads to SharePoint in the case folder structure
- Updates document record with SharePoint IDs
- Best-effort: logs errors but doesn't fail the session close

### 3. Enhanced closeWordSession

Updated `closeWordSession` to trigger migration:

- Runs after SharePoint sync (OPS-182)
- Calls `migrateOneDriveToSharePoint` for legacy documents
- Returns `migrated: boolean` in the result

### 4. GraphQL Schema Update

Added `migrated: Boolean` field to `WordSyncResult` type.

## Files Modified

- `services/gateway/src/services/onedrive.service.ts` - Added `downloadDocument` method
- `services/gateway/src/services/word-integration.service.ts` - Added migration logic to `closeWordSession`
- `services/gateway/src/graphql/schema/word-integration.graphql` - Added `migrated` field
- `services/gateway/src/graphql/resolvers/word-integration.resolvers.ts` - Return `migrated` field

## Done When

- [x] On `closeWordSession` for OneDrive docs, copy to SharePoint
- [x] Update `sharePointItemId` and `sharePointPath` on success
- [x] Log migration events for monitoring
- [x] Graceful fallback if migration fails (document still works)
- [x] Next edit uses SharePoint-first path

## Dependencies

- OPS-181: SharePoint-First openInWord Flow ✅

## Notes

This is optional and low priority. Documents will continue to work via OneDrive - this just provides a path to gradually move everything to SharePoint for consistency and speed.

Alternative: Could run a batch migration job, but lazy migration is safer and requires no downtime.

## Known Limitation: Orphaned Legacy Documents

Some legacy documents have `oneDriveId` pointing to another user's OneDrive (e.g., `oana.mititelu`) but `oneDriveUserId` is null. These cannot be accessed or migrated because:

1. Graph API `/me/drive/items/{id}` returns `itemNotFound` (file is in another user's drive)
2. Without `oneDriveUserId`, we can't construct the correct path `/users/{userId}/drive/items/{id}`
3. R2 fallback also fails - these documents were uploaded before R2 storage was implemented

**Error Handling Added:**

- When `openInWord` fails for an orphaned legacy document, a Romanian error message is shown:
  > "Acest document a fost încărcat anterior de alt utilizator și nu mai este accesibil. Documentul trebuie reîncărcat pentru a putea fi editat în Word."
- These documents need to be manually re-uploaded to be editable in Word
- Document preview also fails for these files (expected behavior)

**Affected Files:**

- `services/gateway/src/services/word-integration.service.ts` - Error handling at lines 163-180
