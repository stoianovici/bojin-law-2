# OPS-135: Save Email Attachment to Documents Mutation

**Status**: Resolved
**Type**: Feature
**Priority**: P2-Medium
**Complexity**: M (Medium)
**Created**: 2024-12-24

## Context

Part of the Context-Aware Document Preview Actions epic. Provides backend support for the "Save to Documents" action in email attachment preview.

## Problem

Email attachments in preview panel need a "Save to Documents" action that:

- Creates a Document record from the email attachment
- Links it to the case
- Stores file in SharePoint
- Marks attachment as "saved" to prevent duplicates

Currently, users must download the attachment and re-upload it manually.

## Solution

Add GraphQL mutation `saveEmailAttachmentAsDocument` that:

1. Fetches attachment content from MS Graph
2. Uploads to SharePoint using existing document service
3. Creates Document and CaseDocument records
4. Updates EmailAttachment with documentId reference

## Implementation

### GraphQL Schema

```graphql
# services/gateway/src/graphql/schema/email.graphql

extend type Mutation {
  """
  Save an email attachment as a case document.
  Creates Document record, uploads to SharePoint, links to case.
  """
  saveEmailAttachmentAsDocument(
    emailId: ID!
    attachmentId: ID!
    caseId: ID!
    folderId: ID # Optional - place in specific folder
  ): Document!
}

extend type EmailAttachment {
  """
  If attachment was saved as document, reference to that document.
  """
  savedAsDocument: Document
}
```

### Resolver Logic

```typescript
// services/gateway/src/graphql/resolvers/email.resolvers.ts

saveEmailAttachmentAsDocument: async (_, { emailId, attachmentId, caseId, folderId }, context) => {
  // 1. Verify user has access to case
  // 2. Fetch attachment metadata from DB
  // 3. Check if already saved (attachment.documentId)
  // 4. Fetch attachment content from MS Graph
  // 5. Upload to SharePoint via document service
  // 6. Create Document record
  // 7. Create CaseDocument link
  // 8. Update EmailAttachment.documentId
  // 9. Return created Document
};
```

### Database Changes

May need to add field to EmailAttachment:

```prisma
model EmailAttachment {
  // ... existing fields
  documentId String?  // Reference to saved Document
  document   Document? @relation(fields: [documentId], references: [id])
}
```

## Done When

- [x] GraphQL mutation defined in `email.graphql`
- [x] Resolver implemented with proper error handling
- [x] Reuses existing SharePoint upload logic
- [x] Authorization enforced (user assigned to case OR partner)
- [x] Duplicate saves prevented (check attachment.documentId)
- [x] EmailAttachment.savedAsDocument field resolver works
- [x] Returns created Document with full context

## Files

- `services/gateway/src/graphql/schema/email.graphql`
- `services/gateway/src/graphql/resolvers/email.resolvers.ts`
- `services/gateway/src/services/email-attachment.service.ts`
- `packages/database/prisma/schema.prisma` (if documentId field needed)

## Dependencies

- **Blocks**: OPS-140, OPS-141
- **Blocked by**: None

## Epic

Context-Aware Document Preview Actions (Phase 1 - Foundation)
