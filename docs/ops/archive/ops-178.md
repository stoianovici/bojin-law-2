# OPS-178: SharePoint Edit Session Schema

**Type**: Feature
**Priority**: P1-High
**Status**: Complete
**Epic**: Frictionless SharePoint-First Document Editing

## Problem

No way to track the SharePoint state (`lastModifiedDateTime`) when a user starts editing a document. We need this baseline to detect changes when they return from Word.

Currently, when a user opens a document in Word and edits it, we have no record of what the document looked like before editing began. This makes automatic version detection impossible.

## Solution

1. Add `sharePointLastModified` and `sharePointETag` fields to the Document model to track the last known SharePoint state
2. Create `DocumentEditSession` model to track active editing sessions with their baseline state

## Implementation

### Schema Changes

```prisma
model Document {
  // Existing fields...

  // NEW: Track last known SharePoint state for version detection
  sharePointLastModified  DateTime?
  sharePointETag          String?
}

model DocumentEditSession {
  id                      String   @id @default(uuid())
  documentId              String   @unique
  userId                  String
  startedAt               DateTime @default(now())
  sharePointLastModified  DateTime?
  sharePointETag          String?
  lockToken               String

  document                Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user                    User     @relation(fields: [userId], references: [id])

  @@index([userId])
}
```

## Files to Modify

- `packages/database/prisma/schema.prisma`
- New migration: `20251224_sharepoint_edit_session`

## Done When

- [x] `Document.sharePointLastModified` field added
- [x] `Document.sharePointETag` field added
- [x] `DocumentEditSession` model created with baseline tracking
- [x] Migration runs successfully on local
- [x] Types regenerated

## Session Log

- [2025-12-24] Added `sharePointLastModified` and `sharePointETag` fields to Document model
- [2025-12-24] Created `DocumentEditSession` model with:
  - `documentId` (unique - one session per document)
  - `userId` with relation to User
  - `startedAt` timestamp
  - `sharePointLastModified` and `sharePointETag` for baseline tracking
  - `lockToken` for session identification
- [2025-12-24] Added `editSession` relation to Document model
- [2025-12-24] Added `documentEditSessions` relation to User model
- [2025-12-24] Created migration `20251224200000_add_sharepoint_edit_session`
- [2025-12-24] Database synced via `prisma db push`, Prisma client regenerated
- [2025-12-24] TypeScript compilation verified - no errors

## Dependencies

- None (foundation issue)

## Parallel With

- OPS-179: SharePoint Change Detection Methods
- OPS-180: SharePoint Document Download Method
