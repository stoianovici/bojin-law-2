# OPS-158: Fix financial-realization-rate calculation

| Field        | Value                                      |
| ------------ | ------------------------------------------ |
| **Status**   | Resolved                                   |
| **Type**     | Bug                                        |
| **Priority** | P2-Medium                                  |
| **Created**  | 2025-12-24                                 |
| **Resolved** | 2025-12-24                                 |
| **Epic**     | Reports Data Accuracy (OPS-156 to OPS-161) |

## Problem

The `financial-realization-rate` report uses generic `queryFinancialData()` which aggregates revenue by client. But "Rata de Realizare" (Realization Rate) should be a **single percentage** showing billable hours / total hours worked.

The report has `chartType: 'gauge'` which expects a single value, not a list of clients.

## Root Cause

No specialized method exists for this calculation. It falls through to the default case which uses `queryFinancialData()`.

## Solution

1. Add `getRealizationRate()` method that:
   - Sums all billable hours in the date range
   - Sums all total hours in the date range
   - Calculates percentage: (billable / total) \* 100
   - Returns single data point suitable for gauge chart
2. Route `financial-realization-rate` to this method

## Example Output

```typescript
{
  data: [{
    label: 'Rata de Realizare',
    value: 78.5,  // percentage
    color: '#10b981',
    metadata: { billableHours: 157, totalHours: 200 }
  }],
  summary: {
    totalValue: 78.5,
    averageValue: 78.5,
    trendDirection: 'up'
  }
}
```

## Files

- `services/gateway/src/services/report-data.service.ts`
- `services/gateway/src/graphql/resolvers/reports.resolvers.ts`

## Done When

- [x] Report shows single percentage value (e.g., "78.5%")
- [x] Gauge chart displays the realization rate correctly
- [x] Metadata includes billable and total hours for transparency

## Solution Implemented

Added `getRealizationRate()` method to `report-data.service.ts` that:

1. Sums all time entries' hours (billable and non-billable) within the date range
2. Calculates percentage: `(billableHours / totalHours) * 100`
3. Returns a single data point with:
   - `label`: "Rata de Realizare"
   - `value`: The percentage (rounded to 1 decimal)
   - `color`: Dynamic based on rate (green >= 70%, amber 50-70%, red < 50%)
   - `metadata`: Contains `billableHours` and `totalHours` for transparency

Routed `financial-realization-rate` template to this specialized method in the resolver switch statement.
