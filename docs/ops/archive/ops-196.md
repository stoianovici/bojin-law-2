# OPS-196: NECLAR Inline Assignment

**Status:** Resolved | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-24

## Overview

Replace ClassificationModal with inline assignment in the email view. NECLAR emails open in ConversationView with SplitAssignmentButton.

## Dependencies

- **Depends on:** OPS-188 (SplitAssignmentButton), OPS-190 (personal contacts)
- **Blocks:** OPS-197, OPS-198
- **Parallel with:** OPS-193, OPS-194, OPS-195

## Context

Part of Communications UX Overhaul epic. Currently, clicking a NECLAR email opens a modal. The new flow shows the email in the standard ConversationView but with assignment buttons instead of reply buttons.

## Requirements

### 1. NECLAR Email Selection

When user clicks a NECLAR email in sidebar:

- Load email in ConversationView (same as classified emails)
- Show assignment action bar instead of normal action bar

### 2. Assignment Action Bar

```
┌─────────────────────────────────────────────────────────┐
│  ┌──────────────────────────────────┬────────────────┐  │
│  │  Adaugă: Popescu v. Ionescu      │  SC Alpha      │  │
│  │         [CYAN/YELLOW/MAGENTA]    │   [color]      │  │
│  └──────────────────────────────────┴────────────────┘  │
│                                                         │
│  [Personal]  ← Mark sender as personal                  │
└─────────────────────────────────────────────────────────┘
```

### 3. Assignment Flow

1. User views NECLAR email with suggestions
2. Click primary suggestion → `assignEmailToCase` mutation
3. Click secondary → dropdown with all suggestions
4. Click "Personal" → `addPersonalContact` mutation + optionally ignore email
5. After assignment → transition to normal action bar with "Răspunde"

### 4. Mutation for Assignment

```graphql
mutation assignUncertainEmail($emailId: ID!, $caseId: ID!) {
  assignUncertainEmail(emailId: $emailId, caseId: $caseId) {
    email {
      id
      caseId
      classificationState
    }
  }
}
```

### 5. State Transition

```
NECLAR email selected:
  - Show email content
  - Show SplitAssignmentButton + Personal button
  - Hide Răspunde

After assignment:
  - Update classificationState to CLASSIFIED
  - Transition action bar to show Răspunde
  - Move email from NECLAR to case section in sidebar
```

### 6. Animation

Smooth transition when action bar changes from assignment to reply mode.

## Acceptance Criteria

- [x] NECLAR email opens in ConversationView
- [x] SplitAssignmentButton shown with suggestions
- [x] Confidence colors applied correctly
- [x] "Personal" button marks sender and removes email from view
- [x] After assignment, "Răspunde" button appears (via neclarAssigned state)
- [x] Email moves from NECLAR to case section in sidebar (via onNeclarAssigned callback)
- [x] Smooth transition between states (AnimatePresence)
- [x] No modal involved

## Files to Modify

- `apps/web/src/app/communications/page.tsx`
- `apps/web/src/components/communication/ConversationView.tsx`
- `apps/web/src/components/communication/ConversationHeader.tsx`
- `apps/web/src/hooks/useMyEmailsByCase.ts` (refetch after assignment)

## Estimated Scope

Medium - State management + conditional UI.

---

## Session Log

### 2025-12-24: Implementation Complete

**Changes Made:**

1. **`apps/web/src/app/communications/page.tsx`**
   - Added `NeclarEmailData` type for storing NECLAR email info
   - Replaced `classificationEmailId` state with `neclarEmailData` state
   - Updated `handleSelectUncertainEmail` to set view state to `uncertain-email` mode and pass data to ConversationView
   - Removed ClassificationModal usage (replaced with inline assignment)
   - Pass `neclarMode`, `neclarData`, and `onNeclarAssigned` props to ConversationView

2. **`apps/web/src/components/communication/ConversationView.tsx`**
   - Added `ConversationViewProps` interface with `neclarMode`, `neclarData`, `onNeclarAssigned`
   - Added GraphQL mutations: `CLASSIFY_UNCERTAIN_EMAIL`, `MARK_SENDER_AS_PERSONAL`
   - Added handlers: `handleNeclarAssign`, `handleNeclarIgnore`, `handleMarkSenderAsPersonal`
   - Added state: `neclarAssigned` for transition tracking
   - Updated action bar to use `AnimatePresence` for smooth transitions
   - NECLAR mode shows: SplitAssignmentButton + Personal button + Ignore button
   - Normal mode (after assignment): standard Nou/Răspunde/Privacy buttons

**Flow:**

1. User clicks NECLAR email in sidebar
2. Email opens in ConversationView with amber action bar
3. SplitAssignmentButton shows top 2 suggested cases
4. User can: assign to case, mark sender as personal, or ignore
5. After action: callback triggers refetch and UI transitions to normal mode
