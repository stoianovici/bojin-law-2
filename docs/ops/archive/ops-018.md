# OPS-018: AI Service Deployment Failure & Render Duplicate Services

| Field        | Value                                             |
| ------------ | ------------------------------------------------- |
| **ID**       | OPS-018                                           |
| **Title**    | AI Service Deployment Failure & Render Duplicates |
| **Type**     | Bug / Infrastructure                              |
| **Priority** | P1-High                                           |
| **Status**   | Resolved                                          |
| **Created**  | 2025-12-13                                        |

---

## Problem Summary

Two related issues discovered:

1. **AI Service failing to deploy** - Build succeeds but service crashes on startup (`nonZeroExit: 1`)
2. **Duplicate services being created** - Render blueprints with `autoSync: true` were recreating all services on every git push

---

## Issue 1: AI Service Deployment Failure

### Symptoms

- AI service deploy status: `update_failed`
- Build succeeds, but runtime fails with `nonZeroExit: 1`
- Service worked locally but not on Render

### Root Cause Analysis

Initial hypothesis was Prisma binary targets missing for Linux. Added:

```prisma
binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
```

This did NOT fix the issue. The actual problem was **Render's Node runtime** not properly handling Prisma client in a pnpm workspace.

### Solution

Switched AI service from **Node runtime** to **Docker runtime**:

1. Created `infrastructure/docker/Dockerfile.ai-service` (based on working gateway Dockerfile)
2. Updated `render.yaml` to use Docker runtime
3. Deleted old service and recreated with Docker via Render API

**Key Dockerfile features:**

- Uses `node:22-alpine` with OpenSSL installed
- Properly copies Prisma client to correct pnpm path
- Multi-stage build for smaller image

### Service Recreation Commands

```bash
# Delete old service
curl -X DELETE -H "Authorization: Bearer $RENDER_API_KEY" \
  "https://api.render.com/v1/services/OLD_SERVICE_ID"

# Create new service with Docker
curl -X POST -H "Authorization: Bearer $RENDER_API_KEY" \
  -H "Content-Type: application/json" \
  "https://api.render.com/v1/services" \
  -d '{
    "type": "web_service",
    "name": "legal-platform-ai-service",
    "ownerId": "tea-d4dir3vdiees73cklbs0",
    "repo": "https://github.com/stoianovici/bojin-law-2.git",
    "branch": "main",
    "autoDeploy": "no",
    "serviceDetails": {
      "env": "docker",
      "envSpecificDetails": {
        "dockerfilePath": "./infrastructure/docker/Dockerfile.ai-service",
        "dockerContext": "."
      },
      "plan": "starter",
      "region": "oregon",
      "healthCheckPath": "/api/ai/health",
      "envVars": [...]
    }
  }'
```

---

## Issue 2: Duplicate Services from Blueprint AutoSync

### Symptoms

- Every git push created 4 new services with `-khh4` suffix
- Duplicate databases and Redis instances also created
- Wasted resources and confusion

### Root Cause

Two Render blueprints had `autoSync: true`:

- `exs-d4djii2dbo4c73dsnca0` - "legal platform"
- `exs-d4k7tr8gjchc73a0hbr0` - "legacy import"

Every time `render.yaml` changed, Render would sync and create duplicate resources.

### Solution

Disabled autoSync on both blueprints:

```bash
# Disable autoSync
curl -X PATCH -H "Authorization: Bearer $RENDER_API_KEY" \
  -H "Content-Type: application/json" \
  "https://api.render.com/v1/blueprints/BLUEPRINT_ID" \
  -d '{"autoSync": false}'
```

### Cleanup Commands

```bash
# Delete duplicate services
curl -X DELETE -H "Authorization: Bearer $RENDER_API_KEY" \
  "https://api.render.com/v1/services/SERVICE_ID"

# Delete duplicate databases
curl -X DELETE -H "Authorization: Bearer $RENDER_API_KEY" \
  "https://api.render.com/v1/postgres/DATABASE_ID"

# Delete duplicate Redis
curl -X DELETE -H "Authorization: Bearer $RENDER_API_KEY" \
  "https://api.render.com/v1/redis/REDIS_ID"
```

---

## Current Render Infrastructure

### Services (4 total)

| Service                   | ID                         | Runtime |
| ------------------------- | -------------------------- | ------- |
| legal-platform-web        | `srv-d4dk9fodl3ps73d3d7ig` | Docker  |
| legal-platform-gateway    | `srv-d4pkv8q4i8rc73fq3mvg` | Docker  |
| legal-platform-ai-service | `srv-d4uor5be5dus73a0hs3g` | Docker  |
| bojin-legacy-import       | `srv-d4k84gogjchc73a0lqo0` | Node    |

### Database (1)

- `legal-platform-db` (`dpg-d4q61v6r433s73agrcc0-a`)

### Redis (1)

- `legal-platform-redis-new` (`red-d4u2jg9r0fns739ht570`)

### Blueprints (autoSync DISABLED)

- `legal platform` (`exs-d4djii2dbo4c73dsnca0`) - autoSync=false
- `legacy import` (`exs-d4k7tr8gjchc73a0hbr0`) - autoSync=false

---

## Prevention Measures

1. **render.yaml header updated** with strong warning not to re-import as blueprint
2. **All service IDs documented** in render.yaml and RENDER_API.md
3. **Blueprint autoSync disabled** - must stay disabled
4. **All services have autoDeploy=no** - manual deploys only via `pnpm deploy:production`

---

## Files Modified

- `packages/database/prisma/schema.prisma` - Added Linux binary targets
- `services/ai-service/src/index.ts` - Added diagnostic logging
- `infrastructure/docker/Dockerfile.ai-service` - NEW: Docker build for AI service
- `render.yaml` - Updated AI service to Docker, added warnings
- `infrastructure/RENDER_API.md` - Updated service IDs table

---

## Commits

1. `b57a0b7` - fix(database): add Linux binary targets for Prisma
2. `1e9f4dd` - fix(ai-service): add diagnostic logging for startup debugging
3. `3b5d268` - fix(ai-service): switch to Docker runtime for Render deployment
4. `7f6f7c4` - docs: add strong warnings against creating duplicate Render services
5. `934c7b7` - fix(ai-service): update Dockerfile to port 10000 with diagnostics
6. `485a89a` - fix(ai-service): move @prisma/client to production dependencies (FINAL FIX)

---

## Resolution

### Additional Root Cause Found

After switching to Docker, builds succeeded but container still crashed with `nonZeroExit: 1`.

**Root cause**: `@prisma/client` was in `devDependencies` in `services/ai-service/package.json`. During Docker production build, `pnpm install --prod` skips devDependencies, so `@prisma/client` was not installed.

### Final Fix

1. Moved `@prisma/client` from `devDependencies` to `dependencies` in ai-service package.json
2. Updated Dockerfile PORT to 10000 (Render's expected port)
3. Added ANTHROPIC_API_KEY env var to Render service
4. Fixed REDIS_URL to point to correct Redis instance

### Environment Variables Required

The AI service needs these env vars on Render:

- `DATABASE_URL` - PostgreSQL connection string
- `REDIS_URL` - Redis connection string (internal: `redis://red-{id}:6379`)
- `ANTHROPIC_API_KEY` - Anthropic API key for Claude
- `ANTHROPIC_MODEL` - Model to use (optional)
- `PORT` - 10000 (Render default)
- `NODE_ENV` - production

### Verification

```bash
# Health check passes
curl https://legal-platform-ai-service.onrender.com/api/ai/health
# Returns: {"status":"healthy",...}
```

---

## Completed Steps

- [x] Verify AI service Docker build completes successfully
- [x] Verify AI service health check passes
- [x] Test AI service endpoints work correctly
- [x] Monitor for any new duplicate services (autoSync disabled)

---

## Useful Commands for Future Sessions

### Check all services

```bash
curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
  "https://api.render.com/v1/services?ownerId=tea-d4dir3vdiees73cklbs0&limit=20"
```

### Check deploy status

```bash
curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
  "https://api.render.com/v1/services/SERVICE_ID/deploys?limit=1"
```

### Check blueprints (ensure autoSync=false)

```bash
curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
  "https://api.render.com/v1/blueprints?ownerId=tea-d4dir3vdiees73cklbs0"
```

### Trigger manual deploy

```bash
curl -X POST -H "Authorization: Bearer $RENDER_API_KEY" \
  "https://api.render.com/v1/services/SERVICE_ID/deploys"
```
