# [OPS-043] Re-classify emails when contacts added to case

| Field           | Value      |
| --------------- | ---------- |
| **Status**      | Resolved   |
| **Type**        | Feature    |
| **Priority**    | P2-Medium  |
| **Created**     | 2025-12-19 |
| **Sessions**    | 2          |
| **Last Active** | 2025-12-19 |

## Description

When contacts are added to a case, re-evaluate emails from that contact that were auto-classified to other cases. This handles the scenario where a contact initially had one case (emails auto-assigned with 90% confidence), then a second case is added for the same contact - existing emails should be reconsidered and potentially moved to NECLAR for user review.

**User Story:**

- Client "TT Solaria" has case A (UAT) with contacts set
- All emails from TT Solaria are auto-classified to case A
- User creates case B (ABC Development) for same client
- User adds TT Solaria contacts to case B
- **Expected:** Emails that were auto-classified to case A should be re-evaluated
- **Actual:** Nothing happens, emails stay in case A, case B doesn't appear in /communications

## Root Cause

In `classification-scoring.ts` line 225-236, when `candidateCases.length === 1`, emails are auto-assigned with 90% confidence. When a second case is added later, there's no trigger to re-evaluate these emails.

The existing `addCaseActor` mutation (line 1038-1092 in case.resolvers.ts) only assigns emails with `Pending` or `Uncertain` state - it doesn't touch emails already `Classified`.

## Proposed Solution

When a contact is added to a case via `addCaseActor`:

1. Find emails from that contact that were auto-classified (not manually assigned) to OTHER cases
2. Re-evaluate using the multi-case scoring algorithm
3. If the new case scores higher or the scores are ambiguous:
   - Change email state to `Uncertain`
   - Email appears in NECLAR queue for user to decide
4. If original case still clearly wins, leave as-is

**Key distinction:** Only re-evaluate emails that were:

- Auto-classified (`classifiedBy: 'contact_match'` or `'auto'`)
- NOT manually assigned by user
- From the contact being added

## Environment Strategy

| Mode                   | Command                        | Use When                              |
| ---------------------- | ------------------------------ | ------------------------------------- |
| Local dev (default)    | `pnpm dev`                     | Feature development                   |
| Production data        | `source .env.prod && pnpm dev` | Testing with real multi-case contacts |
| Production-like Docker | `pnpm preview`                 | Pre-deploy verification               |

**Recommended for this issue**: Local dev, then production data for testing real TT Solaria scenario

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

> Issue cannot be closed until all three steps pass

## Conventions to Follow

- Use section dividers (`// ====`) to organize code
- Use `UserContext` pattern for authenticated operations
- Include `firmId` in all queries
- Export singleton service instances
- Log actions with EmailClassificationLog for audit trail

## Files Involved

**Primary:**

- `services/gateway/src/graphql/resolvers/case.resolvers.ts` - `addCaseActor` mutation (line 994)
- `services/gateway/src/services/classification-scoring.ts` - scoring algorithm

**Supporting:**

- `services/gateway/src/graphql/resolvers/classification-review.resolvers.ts` - `moveEmailToCase` pattern
- `services/gateway/src/services/case-activity.service.ts` - activity logging

## Session Log

- [2025-12-19 09:40] Issue created. Initial triage: Found existing auto-assignment logic in `addCaseActor` (line 1038-1092) that only handles Pending/Uncertain emails. Need to extend to re-evaluate Classified emails from same contact.
- [2025-12-19] Session 2: Implemented re-classification logic in `addCaseActor`:
  - Added import for `classificationScoringService` and types
  - Extended `addCaseActor` to find auto-classified emails from the contact in OTHER cases
  - Re-runs scoring algorithm for found emails
  - If ambiguous (result is Uncertain or different case wins with low confidence), moves email to Uncertain state
  - Adds audit log entry via `EmailClassificationLog` with `action: Unassigned`, `matchType: Actor`
  - TypeScript compiles successfully. Ready for local verification.
