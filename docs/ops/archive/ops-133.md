# OPS-133: Documents - Add Pagination / Load More UI

**Type**: UI
**Priority**: P2-Medium
**Status**: Open
**Complexity**: M (1-2 hours)
**Blocked by**: OPS-131
**Part of**: Performance Optimization Epic (OPS-129 through OPS-133)

---

## Problem

Documents page loads all documents via `caseDocumentsGrid`. With many documents, initial load is slow and payload is large. The resolver already supports cursor-based pagination but the UI doesn't use it.

## Current State

The `caseDocumentsGrid` query already supports pagination:

```graphql
query CaseDocumentsGrid(
  $caseId: ID!
  $first: Int      # Already supported
  $after: String   # Already supported - cursor
  ...
) {
  caseDocumentsGrid(...) {
    edges { ... }
    pageInfo {
      hasNextPage    # Already returned
      endCursor      # Already returned
    }
    totalCount       # Already returned
  }
}
```

## Solution

1. Set default `first: 20` in the query
2. Use Apollo `fetchMore` with cursor pagination
3. Add "Load more" button to DocumentsContentPanel

## Implementation

### Update Document Folders Hook

```typescript
// apps/web/src/hooks/useDocumentFolders.ts

export function useCaseDocuments(caseId: string | null) {
  const { data, loading, fetchMore } = useQuery(GET_CASE_DOCUMENTS_GRID, {
    variables: {
      caseId,
      first: 20, // Default page size
    },
    skip: !caseId,
  });

  const loadMore = useCallback(async () => {
    if (!data?.caseDocumentsGrid.pageInfo.hasNextPage) return;

    await fetchMore({
      variables: {
        after: data.caseDocumentsGrid.pageInfo.endCursor,
      },
      updateQuery: (prev, { fetchMoreResult }) => {
        if (!fetchMoreResult) return prev;

        return {
          caseDocumentsGrid: {
            ...fetchMoreResult.caseDocumentsGrid,
            edges: [...prev.caseDocumentsGrid.edges, ...fetchMoreResult.caseDocumentsGrid.edges],
          },
        };
      },
    });
  }, [data, fetchMore]);

  return {
    documents: data?.caseDocumentsGrid.edges.map((e) => e.node) || [],
    totalCount: data?.caseDocumentsGrid.totalCount || 0,
    hasMore: data?.caseDocumentsGrid.pageInfo.hasNextPage || false,
    loadMore,
    loading,
  };
}
```

### Update Content Panel

```typescript
// apps/web/src/components/documents/DocumentsContentPanel.tsx

// Add to bottom of document list
{hasMore && (
  <div className="p-4 text-center border-t">
    <button
      onClick={loadMore}
      disabled={loadingMore}
      className="px-4 py-2 text-sm text-blue-600 hover:text-blue-700 disabled:opacity-50"
    >
      {loadingMore ? 'Se încarcă...' : `Încarcă mai multe (${totalCount - documents.length} rămase)`}
    </button>
  </div>
)}
```

## Files to Modify

- `apps/web/src/hooks/useDocumentFolders.ts`
  - Add pagination to document query
  - Add loadMore function
  - Track hasMore state

- `apps/web/src/components/documents/DocumentsContentPanel.tsx`
  - Add load more button
  - Show remaining count

## Acceptance Criteria

- [ ] Initial load fetches first 20 documents
- [ ] "Load more" button appears when hasNextPage is true
- [ ] Shows count of remaining documents
- [ ] Additional pages append correctly
- [ ] Grid and list views both support pagination
- [ ] No duplicate documents after loading more

## Testing

1. Have a case with 50+ documents
2. Load /documents, select the case
3. Should see 20 documents initially
4. Button should show "Încarcă mai multe (30 rămase)"
5. Click button - 20 more load, button updates
6. After all loaded, button disappears
7. Test both grid and list view modes

## Dependencies

- **Blocked by OPS-131**: DataLoader fix should be in place first for performance
- Can run in parallel with OPS-132 (Communications pagination)

---

## Session Log

### Session 1 - 2025-12-23

**Implementation complete:**

1. Updated `apps/web/src/components/documents/DocumentsContentPanel.tsx`:
   - Imported `useDocumentGrid` hook and `DocumentGridItem` type
   - Added `Loader2` icon for loading spinner
   - Added `isLoadingMore` state for tracking load more operations
   - Used `useDocumentGrid` for root-level documents (when no folder selected)
   - Converted `DocumentGridItem` to `CaseDocumentContext` format for compatibility
   - Added `handleLoadMore` callback with loading state management
   - Updated loading state to use grid loading for root, folder loading for folders
   - Updated document count display to show "X din Y documente" when more available
   - Added "Încarcă mai multe (Z rămase)" button when `hasMore` is true

**Architecture notes:**

- Root-level documents (no folder) use paginated `caseDocumentsGrid` query (20 per page)
- Folder-level documents continue using `folderContents` query (no pagination - folders typically smaller)
- Load More button appears at bottom of document list when more pages available
- Shows loading spinner and "Se încarcă..." text while loading more

**Status**: ✅ Code complete - TypeScript compiles successfully

**Files modified:**

- `apps/web/src/components/documents/DocumentsContentPanel.tsx`

**Acceptance criteria verification:**

- [x] Initial load fetches first 20 documents
- [x] "Load more" button appears when hasNextPage is true
- [x] Shows count of remaining documents
- [x] Additional pages append correctly (via Apollo fetchMore)
- [x] Grid and list views both support pagination (same logic)
- [x] No duplicate documents after loading more (cursor-based pagination)

**Next steps:**

- Test with production data
- Verify with case containing 50+ documents
