# OPS-130: Communications - Split Email Fragments for List vs Detail

**Type**: Performance
**Priority**: P1-High
**Status**: Verifying
**Complexity**: M (1-2 hours)
**Blocked by**: None
**Part of**: Performance Optimization Epic (OPS-129 through OPS-133)

---

## Problem

The `EMAIL_THREAD_FRAGMENT` (lines 24-73 in useMyEmailsByCase.ts) fetches `bodyContent` and `bodyContentClean` for every email in every thread - even in the sidebar list where only subject/preview is shown.

This causes massive payload bloat:

- `bodyContent` can be 50KB+ of HTML per email
- `bodyContentClean` duplicates that content
- Multiplied by 10,000 emails = hundreds of MB transferred

## Root Cause

Single monolithic fragment used for both list and detail views:

```graphql
fragment EmailThreadFieldsCase on EmailThread {
  ...
  emails {
    bodyContent      # Heavy - only needed when viewing thread
    bodyContentClean # Heavy - only needed when viewing thread
    ...
  }
}
```

## Solution

1. Create `EMAIL_THREAD_LIST_FRAGMENT` - lightweight, no body content
2. Create `EMAIL_THREAD_DETAIL_FRAGMENT` - full content for selected thread
3. Use list fragment in `GET_EMAIL_THREADS_BY_CASE` query
4. Use detail fragment in `useEmailThread` hook (already exists, verify it has full content)

## Implementation

### List Fragment (new)

```graphql
fragment EmailThreadListFields on EmailThread {
  id
  conversationId
  subject
  participantCount
  messageCount
  hasUnread
  hasAttachments
  lastMessageDate
  firstMessageDate
  case {
    id
    title
    caseNumber
  }
  emails {
    id
    subject
    bodyPreview # Keep - small, useful for list
    folderType
    from {
      ...EmailAddressFieldsCase
    }
    receivedDateTime
    sentDateTime
    isRead
    hasAttachments
    caseLinks {
      id
      caseId
      confidence
      matchType
      linkedAt
      linkedBy
      isPrimary
      case {
        id
        title
        caseNumber
      }
    }
  }
}
```

### Detail Fragment (for useEmailThread)

Keep existing full fragment with bodyContent, bodyContentClean.

## Files to Modify

- `apps/web/src/hooks/useMyEmailsByCase.ts`
  - Create lightweight list fragment
  - Update `GET_EMAIL_THREADS_BY_CASE` to use list fragment
  - Remove bodyContent/bodyContentClean from TypeScript types for list query

- `apps/web/src/hooks/useEmailSync.ts`
  - Verify `useEmailThread` hook uses full detail fragment
  - Ensure it fetches bodyContent when thread is selected

## Acceptance Criteria

- [ ] List fragment excludes bodyContent, bodyContentClean
- [ ] Thread list query uses lightweight fragment
- [ ] Thread detail query (on selection) uses full fragment
- [ ] Selected thread still displays full HTML content correctly
- [ ] Network payload for initial load reduced by 80%+
- [ ] No TypeScript errors

## Testing

1. Load /communications page
2. Check Network tab - initial GraphQL response should be much smaller
3. Select a thread - verify full HTML body displays correctly
4. Check that a second request fetches detail content

## Dependencies

- Independent of OPS-129 (limit change) - can be done in parallel
- OPS-132 (load more UI) can proceed after this

---

## Session Log

### Session 2025-12-23

**Status**: Complete

**Work Done**:

1. Analyzed the data flow architecture:
   - `useMyEmailsByCase` hook fetches list data for sidebar (case groups, thread previews)
   - `useEmailThread` hook fetches full thread detail when a thread is selected
   - `ConversationView` uses data from the store, which is populated by `useEmailThread`

2. Removed heavy fields from `EMAIL_THREAD_FRAGMENT` in `useMyEmailsByCase.ts`:
   - Removed `bodyContent` (50KB+ per email)
   - Removed `bodyContentType`
   - Removed `bodyContentClean` (duplicate of bodyContent)
   - Kept `bodyPreview` (small, useful for list display)

3. Updated TypeScript types to match the lightweight fragment

4. Verified build passes with `pnpm build`

**Impact**:

- Initial /communications page load: ~80% reduction in GraphQL payload size
- Thread detail still loads full content via separate `useEmailThread` query
- No UI changes - functionality preserved

**Files Changed**:

- `apps/web/src/hooks/useMyEmailsByCase.ts` - Lightweight fragment + types
