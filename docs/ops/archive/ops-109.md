# OPS-109: Document Preview/Download from SharePoint

| Field        | Value                     |
| ------------ | ------------------------- |
| **Status**   | Open                      |
| **Type**     | Feature                   |
| **Priority** | P1-High                   |
| **Created**  | 2025-12-22                |
| **Blocked**  | OPS-105, OPS-106, OPS-107 |
| **Blocks**   | None                      |

## Description

Update document preview and download resolvers to handle SharePoint-stored documents. This is what actually fixes the "non-uploader can't preview" bug.

## Current Flow (Broken)

```
Associate requests preview → uses Associate's token
                          → calls /me/drive/items/{id} (Partner's OneDrive)
                          → 403 Forbidden (can't access other user's drive)
                          → "Preview unavailable"
```

## New Flow (SharePoint)

```
Associate requests preview → uses Associate's token
                          → calls /sites/{siteId}/drive/items/{id}
                          → 200 OK (Associate is site member)
                          → Preview works!
```

## Implementation

### Update Preview URL Resolver

```typescript
// document.resolvers.ts - documentPreviewUrl field resolver

Document: {
  documentPreviewUrl: async (document, args, context) => {
    const accessToken = context.user.accessToken;

    // Route based on storage type
    if (document.storageType === 'SHAREPOINT' && document.sharePointItemId) {
      // New SharePoint path
      const previewInfo = await sharePointService.getPreviewUrl(
        accessToken,
        document.sharePointItemId
      );
      return previewInfo;
    }

    if (document.storageType === 'ONEDRIVE' && document.oneDriveId) {
      // Legacy OneDrive path (still works for uploader)
      const previewInfo = await oneDriveService.getPreviewUrl(
        accessToken,
        document.oneDriveId,
        document.fileType,
        document.oneDriveUserId
      );
      return previewInfo;
    }

    // R2 fallback
    if (document.storagePath) {
      return r2Service.getPresignedUrl(document.storagePath);
    }

    return null;
  };
}
```

### Update Download URL Resolver

```typescript
// Similar routing logic for download URLs
getDocumentDownloadUrl: async (_, { documentId }, context) => {
  const document = await prisma.document.findUnique({ where: { id: documentId } });

  if (document.storageType === 'SHAREPOINT') {
    return sharePointService.getDownloadUrl(context.user.accessToken, document.sharePointItemId);
  }

  // Legacy OneDrive/R2 fallback...
};
```

### Update Thumbnail Resolvers

```typescript
Document: {
  thumbnailLarge: async (document, _, context) => {
    if (document.storageType === 'SHAREPOINT' && document.sharePointItemId) {
      const thumbnails = await sharePointService.getThumbnails(
        context.user.accessToken,
        document.sharePointItemId
      );
      return thumbnails?.large?.url;
    }
    // OneDrive fallback...
  };
}
```

## Files Affected

**Modified:**

- `services/gateway/src/graphql/resolvers/document.resolvers.ts`

## Acceptance Criteria

1. SharePoint documents preview for ALL firm users (not just uploader)
2. SharePoint documents download for all firm users
3. Thumbnails work for SharePoint documents
4. Legacy OneDrive documents still work for their uploaders
5. R2 fallback still works

## Testing

1. Upload new document (goes to SharePoint)
2. Preview as uploader - works
3. Preview as different user - works (THE FIX!)
4. Preview old OneDrive document as uploader - still works
5. Download SharePoint document - works

## Root Cause Analysis (OPS-Investigate 2025-12-23)

### Symptom

Document preview shows "Previzualizare indisponibilă" (Preview unavailable) for SharePoint-stored `.txt` file.

### Root Cause Found

**Mismatch between frontend and backend previewable file types:**

1. **Frontend** (`DocumentPreviewModal.tsx:60`) includes `text/plain` in `BROWSER_NATIVE_TYPES`
2. **SharePoint service** (`sharepoint.service.ts:327-330`) only handles:
   - PDF (`application/pdf`)
   - Office docs (Word, Excel, PowerPoint)
   - Images (JPEG, PNG, GIF, WebP)
3. **Text files are not handled** - the `getPreviewUrl()` method returns `null` at line 329

### Code Evidence

```typescript
// sharepoint.service.ts lines 327-330
if (!isPdf && !isOffice && !isImage) {
  logger.debug('Preview not supported for file type', { mimeType, itemId });
  return null; // <-- text/plain hits this!
}
```

The file `test-sharepoint-upload.txt` has MIME type `text/plain` which is NOT in `isPdf`, `isOffice`, or `isImage` categories.

### Fix Required

Add text file handling to `sharePointService.getPreviewUrl()`:

```typescript
const textTypes = ['text/plain', 'text/csv', 'text/html'];
const isText = textTypes.includes(mimeType);

if (!isPdf && !isOffice && !isImage && !isText) {
  logger.debug('Preview not supported for file type', { mimeType, itemId });
  return null;
}

// For text files, return download URL (browser will display directly)
if (isText) {
  const downloadUrl = await this.getDownloadUrl(accessToken, itemId);
  return {
    url: downloadUrl,
    source: 'text',
    expiresAt: new Date(Date.now() + SHAREPOINT_CONFIG.PREVIEW_URL_TTL).toISOString(),
  };
}
```

## Local Verification Status

| Step           | Status     | Notes                                              |
| -------------- | ---------- | -------------------------------------------------- |
| Prod data test | ⬜ Pending | Need to test with documents uploaded to SharePoint |
| Preflight      | ⬜ Pending | Pre-existing errors in email.resolvers.ts          |
| Docker test    | ⬜ Pending |                                                    |

**Verified**: No (root cause found, fix required)

## Session Log

- [2025-12-22] Issue created as part of SharePoint migration epic.
- [2025-12-22 21:00] Session 2: Implemented SharePoint routing for preview/download/thumbnails:
  - Updated `documentPreviewUrl` query to check SharePoint first, fallback to OneDrive then R2
  - Updated `getDocumentDownloadUrl` mutation to check SharePoint first, fallback to OneDrive
  - Updated `getDocumentThumbnail` query to check SharePoint first, fallback to OneDrive
  - All methods use `sharePointService` singleton for SharePoint documents
  - TypeScript compiles without new errors (pre-existing errors in email.resolvers.ts)
  - Ready for verification with SharePoint-uploaded documents
- [2025-12-23 11:00] Session 3 (OPS-Investigate):
  - Used Playwright MCP to verify symptom: "Previzualizare indisponibilă" for `.txt` file
  - Spawned 3 parallel investigation agents (frontend, API, SharePoint service)
  - **Root cause identified**: `text/plain` not handled in `sharePointService.getPreviewUrl()`
  - Frontend considers text/plain previewable, but SharePoint service returns null
  - Fix: Add text file handling to SharePoint service (similar to image handling)
- [2025-12-23 19:00] Session 4 (OPS-Investigate):
  - User reports "again, previews don't load for documents" on localhost
  - Server not running, could not use Playwright MCP to verify symptoms
  - **Code verification**: Text file handling WAS implemented (sharepoint.service.ts:399-407)
  - Spawned 3 parallel investigation agents (frontend, API, SharePoint service)
  - All code paths verified as correct - proper fallback chain exists
  - **Remaining hypotheses**:
    1. MS Access Token not being passed to context (most likely)
    2. Documents don't have sharePointItemId (still in OneDrive/R2)
    3. SharePoint API returning errors (logged but falling back)
  - Gateway env vars verified: SHAREPOINT_SITE_ID and SHAREPOINT_DRIVE_ID are set
  - Need live debugging to determine exact failure point
