# OPS-060: GraphQL Multi-Case Email Support

| Field           | Value       |
| --------------- | ----------- |
| **Status**      | Implemented |
| **Type**        | Feature     |
| **Priority**    | P1-High     |
| **Created**     | 2025-12-20  |
| **Sessions**    | 1           |
| **Last Active** | 2025-12-20  |
| **Depends On**  | OPS-058     |

## Description

Update GraphQL schema and resolvers to support the new multi-case email model. Emails will now be linked to cases via `EmailCaseLink` junction table instead of direct `caseId` foreign key.

## Implementation Summary

### Schema Changes

**email.graphql:**

- Added `ClassificationMatchType` enum (Actor, ReferenceNumber, Keyword, Semantic, GlobalSource, Manual, ThreadContinuity)
- Added `EmailCaseLink` type with metadata (confidence, matchType, linkedAt, linkedBy, isPrimary)
- Updated `Email` type with:
  - `caseLinks: [EmailCaseLink!]!` - all case links with metadata
  - `cases: [Case!]!` - convenience field for all linked cases
  - `primaryCase: Case` - the primary case assignment
  - `case: Case` - deprecated, kept for backwards compatibility
- Added mutations:
  - `linkEmailToCase(emailId, caseId, isPrimary): EmailCaseLink!`
  - `unlinkEmailFromCase(emailId, caseId): Boolean!`

**case.graphql:**

- Added `emailLinks: [EmailCaseLink!]!` - all email links with metadata
- Updated `communications: [Email!]!` - now fetches via EmailCaseLink

### Resolver Implementation

**email.resolvers.ts:**

- `Email.caseLinks` - fetches via EmailCaseLink junction table
- `Email.cases` - convenience resolver mapping links to cases
- `Email.primaryCase` - finds isPrimary=true link, with fallbacks
- `Email.case` - backwards compatible, same as primaryCase
- `EmailCaseLink` type resolvers for nested fields
- `linkEmailToCase` mutation with:
  - Authorization checks (email + case access)
  - Duplicate prevention
  - Primary flag management
  - Classification state updates
  - Timeline sync
- `unlinkEmailFromCase` mutation with:
  - Authorization checks
  - Primary promotion when unlinking primary
  - Classification state cleanup when no links remain

**case.resolvers.ts:**

- `Case.emailLinks` - fetches via junction table with email include
- `Case.communications` - combines junction table + legacy caseId for migration compatibility

## Files Modified

| File                                                        | Changes                                                |
| ----------------------------------------------------------- | ------------------------------------------------------ |
| `services/gateway/src/graphql/schema/email.graphql`         | EmailCaseLink type, Email multi-case fields, mutations |
| `services/gateway/src/graphql/schema/case.graphql`          | emailLinks field, communications field                 |
| `services/gateway/src/graphql/resolvers/email.resolvers.ts` | Multi-case resolvers, link/unlink mutations            |
| `services/gateway/src/graphql/resolvers/case.resolvers.ts`  | emailLinks + communications resolvers                  |

## Acceptance Criteria

- [x] EmailCaseLink type added to GraphQL schema
- [x] Email.caseLinks, Email.cases, Email.primaryCase fields work
- [x] Case.communications fetches via EmailCaseLink
- [x] Case.emailLinks returns link metadata
- [x] Backwards compatibility: Email.case still works (deprecated)
- [x] New mutations: linkEmailToCase, unlinkEmailFromCase
- [x] TypeScript compilation passes

## Local Verification Status

| Step           | Status     | Date | Notes                          |
| -------------- | ---------- | ---- | ------------------------------ |
| Prod data test | ⬜ Pending |      | Schema only, need runtime test |
| Preflight      | ⬜ Pending |      | Need full preflight run        |
| Docker test    | ⬜ Pending |      |                                |

**Verified**: No (pending full verification)

## Session Log

- [2025-12-20] Issue created as part of multi-case email feature set.
- [2025-12-20] Session 1: Implemented GraphQL schema and resolvers for multi-case support.
  - Added EmailCaseLink type and ClassificationMatchType enum
  - Updated Email type with caseLinks, cases, primaryCase fields
  - Updated Case type with emailLinks and communications fields
  - Implemented all type resolvers with backwards compatibility
  - Added linkEmailToCase and unlinkEmailFromCase mutations
  - TypeScript compilation verified for gateway and web

---
