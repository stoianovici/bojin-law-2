# OPS-069: Assistant Store (Zustand)

**Status:** Implemented | **Priority:** P1-High | **Type:** Feature
**Created:** 2025-12-20 | **Depends on:** OPS-068 | **Blocks:** OPS-070
**Sessions:** 1 | **Last Active:** 2025-12-20

## Summary

Create a Zustand store for managing the AI assistant UI state, including conversation state, messages, and pending actions.

## Background

The assistant needs client-side state management for:

- Open/expanded UI state
- Current conversation and messages
- Pending action confirmations
- Loading and error states
- Context (current case, screen)

## Requirements

### Store Implementation

```typescript
// apps/web/src/stores/assistant.store.ts

import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';

// ============================================================================
// Types
// ============================================================================

interface AIMessage {
  id: string;
  role: 'User' | 'Assistant' | 'System';
  content: string;
  intent?: string;
  confidence?: number;
  proposedAction?: ProposedAction;
  createdAt: string;
}

interface ProposedAction {
  type: string;
  displayText: string;
  payload: Record<string, unknown>;
  status: 'Proposed' | 'Confirmed' | 'Executed' | 'Rejected' | 'Failed';
  requiresConfirmation: boolean;
  confirmationPrompt?: string;
  entityPreview?: Record<string, unknown>;
}

interface AssistantContext {
  currentScreen?: string;
  currentCaseId?: string;
  currentDocumentId?: string;
  selectedEmailId?: string;
}

interface AssistantState {
  // UI State
  isOpen: boolean;
  isExpanded: boolean;
  isLoading: boolean;
  error: string | null;

  // Conversation State
  conversationId: string | null;
  messages: AIMessage[];
  pendingAction: ProposedAction | null;

  // Context
  context: AssistantContext;

  // Computed
  hasUnreadMessages: boolean;
  unreadCount: number;

  // Actions
  toggleOpen: () => void;
  toggleExpanded: () => void;
  setLoading: (loading: boolean) => void;
  setError: (error: string | null) => void;

  // Conversation Actions
  setConversation: (id: string, messages: AIMessage[]) => void;
  addMessage: (message: AIMessage) => void;
  setPendingAction: (action: ProposedAction | null) => void;
  clearConversation: () => void;
  markMessagesRead: () => void;

  // Context Actions
  setContext: (context: Partial<AssistantContext>) => void;
  clearContext: () => void;
}

// ============================================================================
// Store
// ============================================================================

export const useAssistantStore = create<AssistantState>()(
  persist(
    (set, get) => ({
      // Initial State
      isOpen: false,
      isExpanded: false,
      isLoading: false,
      error: null,

      conversationId: null,
      messages: [],
      pendingAction: null,

      context: {},

      hasUnreadMessages: false,
      unreadCount: 0,

      // UI Actions
      toggleOpen: () =>
        set((state) => ({
          isOpen: !state.isOpen,
          isExpanded: !state.isOpen ? true : state.isExpanded,
          hasUnreadMessages: !state.isOpen ? false : state.hasUnreadMessages,
          unreadCount: !state.isOpen ? 0 : state.unreadCount,
        })),

      toggleExpanded: () =>
        set((state) => ({
          isExpanded: !state.isExpanded,
        })),

      setLoading: (loading) => set({ isLoading: loading }),

      setError: (error) => set({ error }),

      // Conversation Actions
      setConversation: (id, messages) =>
        set({
          conversationId: id,
          messages,
          pendingAction: null,
        }),

      addMessage: (message) =>
        set((state) => {
          const isAssistantMessage = message.role === 'Assistant';
          const pendingAction = message.proposedAction?.requiresConfirmation
            ? message.proposedAction
            : null;

          return {
            messages: [...state.messages, message],
            pendingAction,
            hasUnreadMessages: !state.isOpen && isAssistantMessage,
            unreadCount:
              !state.isOpen && isAssistantMessage ? state.unreadCount + 1 : state.unreadCount,
          };
        }),

      setPendingAction: (action) => set({ pendingAction: action }),

      clearConversation: () =>
        set({
          conversationId: null,
          messages: [],
          pendingAction: null,
        }),

      markMessagesRead: () =>
        set({
          hasUnreadMessages: false,
          unreadCount: 0,
        }),

      // Context Actions
      setContext: (context) =>
        set((state) => ({
          context: { ...state.context, ...context },
        })),

      clearContext: () => set({ context: {} }),
    }),
    {
      name: 'assistant-storage',
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        // Only persist UI preferences, not conversation state
        isExpanded: state.isExpanded,
      }),
    }
  )
);

// ============================================================================
// Selectors
// ============================================================================

export const useIsAssistantOpen = () => useAssistantStore((state) => state.isOpen);
export const useAssistantMessages = () => useAssistantStore((state) => state.messages);
export const usePendingAction = () => useAssistantStore((state) => state.pendingAction);
export const useAssistantContext = () => useAssistantStore((state) => state.context);
export const useUnreadCount = () => useAssistantStore((state) => state.unreadCount);
```

## Acceptance Criteria

- [x] Zustand store created with all state and actions
- [x] Persistence for UI preferences only (not conversation)
- [x] Selectors exported for common access patterns
- [x] Unread message tracking works correctly
- [x] Context updates don't clear conversation
- [x] Unit tests for all actions and state transitions

## Files to Create

- `apps/web/src/stores/assistant.store.ts`
- `apps/web/src/stores/assistant.store.test.ts`

## Testing

```typescript
describe('useAssistantStore', () => {
  it('toggles open state');
  it('adds messages and tracks unread');
  it('clears unread when opened');
  it('sets pending action from message');
  it('persists only UI preferences');
  it('updates context without clearing conversation');
});
```

## Session Log

### Session 1 (2025-12-20)

**Work Completed:**

1. Created `apps/web/src/stores/assistant.store.ts` with:
   - All state: isOpen, isExpanded, isLoading, error, conversationId, messages, pendingAction, context, hasUnreadMessages, unreadCount
   - All UI actions: toggleOpen, toggleExpanded, setLoading, setError
   - All conversation actions: setConversation, addMessage, setPendingAction, clearConversation, markMessagesRead
   - All context actions: setContext, clearContext
   - Persistence for UI preferences only (isExpanded) using Zustand persist middleware
   - Type exports: MessageRole, ActionStatus, ProposedAction, AIMessage, AssistantContext

2. Created `apps/web/src/stores/assistant.store.test.ts` with:
   - 38 unit tests covering all state, actions, and selectors
   - Tests for localStorage persistence behavior
   - Tests for unread message tracking
   - Tests for pending action from messages

3. Exported selectors:
   - useIsAssistantOpen, useAssistantMessages, usePendingAction
   - useAssistantContext, useUnreadCount, useHasUnreadMessages
   - useAssistantLoading, useAssistantError, useConversationId

**Test Results:**

- All 38 tests passing

**Files Created:**

- `apps/web/src/stores/assistant.store.ts`
- `apps/web/src/stores/assistant.store.test.ts`

#### Local Verification Status

| Step           | Status     | Notes                     |
| -------------- | ---------- | ------------------------- |
| Prod data test | ⬜ Pending | N/A - frontend-only store |
| Preflight      | ⬜ Pending | Unit tests pass (38/38)   |
| Docker test    | ⬜ Pending |                           |

**Verified**: Partial (unit tests pass, awaiting preflight)
