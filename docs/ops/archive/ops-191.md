# OPS-191: Email Privacy Service + GraphQL

**Status:** Resolved | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-24

## Overview

Backend service for partner-only email privacy feature. Partners can mark emails as private, hiding them from case details while keeping them visible in their /communications.

## Dependencies

- **Depends on:** OPS-187 (schema)
- **Blocks:** OPS-194
- **Parallel with:** OPS-190, OPS-192

## Context

Part of Communications UX Overhaul epic. Partners sometimes receive personal emails mixed with case correspondence. They should be able to hide specific emails from case details (so other team members don't see them) while still keeping access in their own communications view.

## Requirements

### 1. Service Methods

```typescript
class EmailPrivacyService {
  // Mark single email as private (Partner only)
  async markAsPrivate(emailId: string, userId: string): Promise<Email>;

  // Unmark email as private
  async unmarkAsPrivate(emailId: string, userId: string): Promise<Email>;

  // Mark entire thread as private
  async markThreadAsPrivate(conversationId: string, userId: string): Promise<Email[]>;

  // Unmark entire thread
  async unmarkThreadAsPrivate(conversationId: string, userId: string): Promise<Email[]>;
}
```

### 2. Authorization

Only users with `UserRole.Partner` can mark emails as private:

```typescript
private validatePartnerRole(role: UserRole): void {
  if (role !== UserRole.Partner) {
    throw new Error('Only partners can mark emails as private');
  }
}
```

### 3. GraphQL Schema

```graphql
extend type Email {
  isPrivate: Boolean!
  markedPrivateBy: ID
  markedPrivateAt: DateTime
}

extend type Mutation {
  markEmailPrivate(emailId: ID!): Email!
  unmarkEmailPrivate(emailId: ID!): Email!
  markThreadPrivate(conversationId: String!): [Email!]!
  unmarkThreadPrivate(conversationId: String!): [Email!]!
}
```

### 4. Query Filtering

Update existing email queries to filter private emails in case context:

```typescript
// In case communications resolver
const emails = await prisma.email.findMany({
  where: {
    caseId: caseId,
    // Filter out private emails unless viewer is the one who marked them
    OR: [{ isPrivate: false }, { markedPrivateBy: currentUserId }],
  },
});
```

## Acceptance Criteria

- [x] EmailPrivacyService created with all methods
- [x] Partner role validation enforced
- [x] GraphQL mutations work
- [x] Case details queries filter private emails
- [x] Private emails still visible to owner in /communications
- [x] Thread privacy affects all emails in conversation
- [x] Timestamp and userId recorded on marking

## Files to Create/Modify

- `services/gateway/src/services/email-privacy.service.ts` (NEW)
- `services/gateway/src/graphql/schema/email.graphql` (EXTEND)
- `services/gateway/src/graphql/resolvers/email.resolvers.ts` (EXTEND)

## Estimated Scope

Medium - Service + authorization + query filtering.

---

## Session Log

### 2025-12-24 - Implementation Complete

**Completed:**

1. Created `EmailPrivacyService` (`services/gateway/src/services/email-privacy.service.ts`)
   - `markAsPrivate()` - mark single email as private (Partner only)
   - `unmarkAsPrivate()` - restore email visibility (only the marking partner can unmark)
   - `markThreadAsPrivate()` - mark all emails in a conversation
   - `unmarkThreadAsPrivate()` - restore thread visibility
   - `buildPrivacyFilter()` - helper for query filtering
   - `canViewEmail()` - access check helper

2. Extended GraphQL schema (`email.graphql`)
   - Added `isPrivate`, `markedPrivateBy`, `markedPrivateAt` fields to Email type
   - Added 4 mutations: `markEmailPrivate`, `unmarkEmailPrivate`, `markThreadPrivate`, `unmarkThreadPrivate`

3. Implemented resolvers (`email.resolvers.ts`)
   - All 4 mutations with Partner role authorization
   - Type resolvers for privacy fields

4. Updated email thread service (`email-thread.service.ts`)
   - Added `skipPrivacyFilter` option to `ThreadFilters`
   - Privacy filter applied when viewing case emails (caseId provided)
   - Filter excludes private emails unless the viewer is the one who marked them
   - No filter applied in /communications (user's own emails are always visible)

**Files Created/Modified:**

- `services/gateway/src/services/email-privacy.service.ts` (NEW)
- `services/gateway/src/graphql/schema/email.graphql` (EXTENDED)
- `services/gateway/src/graphql/resolvers/email.resolvers.ts` (EXTENDED)
- `services/gateway/src/services/email-thread.service.ts` (MODIFIED)
