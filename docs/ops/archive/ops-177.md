# OPS-177: Review Workflow Actions

**Type**: Feature
**Priority**: P2-Medium
**Status**: Verifying
**Epic**: Documents Separation & Review Workflow (OPS-171 to OPS-177)

## Session Notes (2024-12-24)

### Completed Implementation

1. **GraphQL Schema** (`document.graphql`)
   - Added `SubmitForReviewInput`, `ReviewDecisionInput` inputs
   - Added `ReviewDecision` enum (APPROVE, REQUEST_CHANGES)
   - Added `ReviewResult` and `Supervisor` types
   - Added `submitForReview`, `reviewDocument`, `withdrawFromReview` mutations
   - Added `supervisors` query for reviewer picker

2. **Resolvers** (`document.resolvers.ts`)
   - `submitForReview` - validates document status, reviewer role, updates status to IN_REVIEW
   - `reviewDocument` - validates reviewer, requires comment for changes, updates status
   - `withdrawFromReview` - allows author to pull back submission
   - `supervisors` - returns Partners/Associates for picker

3. **Frontend Components**
   - `SubmitForReviewModal.tsx` - supervisor picker with message field
   - `ReviewActionsModal.tsx` - approve/request changes with comment
   - `useSupervisors.ts` hook - fetches supervisor list

4. **Integration**
   - Added review actions to `document-preview-actions.ts`
   - Added icons to DocumentPreviewModal icon map
   - Integrated modals into DocumentsContentPanel

### Files Modified/Created

- `services/gateway/src/graphql/schema/document.graphql`
- `services/gateway/src/graphql/resolvers/document.resolvers.ts`
- `packages/shared/types/src/document-preview-actions.ts`
- `apps/web/src/components/preview/DocumentPreviewModal.tsx`
- `apps/web/src/components/documents/DocumentsContentPanel.tsx`
- **New**: `apps/web/src/components/documents/SubmitForReviewModal.tsx`
- **New**: `apps/web/src/components/documents/ReviewActionsModal.tsx`
- **New**: `apps/web/src/hooks/useSupervisors.ts`

### Verification Needed

- Test submit for review flow with real document
- Test approve/request changes flow
- Test withdraw from review
- Verify status transitions work correctly
- Check notification toasts appear

---

## Problem

There's no way to submit documents for supervisor review or for supervisors to approve/reject them. The review workflow exists conceptually but lacks the mutations and UI to execute it.

## Solution

Add submit, approve, and request-changes mutations with corresponding UI components for both submitters and reviewers.

## Implementation

### 1. Add GraphQL mutations

```graphql
input SubmitForReviewInput {
  documentId: ID!
  reviewerId: ID!
  message: String # Optional note to reviewer
}

input ReviewDecisionInput {
  documentId: ID!
  decision: ReviewDecision!
  comment: String # Required for CHANGES_REQUESTED
}

enum ReviewDecision {
  APPROVE
  REQUEST_CHANGES
}

type ReviewResult {
  success: Boolean!
  document: Document
  error: String
}

type Mutation {
  submitForReview(input: SubmitForReviewInput!): ReviewResult!
  reviewDocument(input: ReviewDecisionInput!): ReviewResult!
  withdrawFromReview(documentId: ID!): ReviewResult!
}
```

### 2. Implement submitForReview resolver

```typescript
submitForReview: async (_, { input }, { user }) => {
  const { documentId, reviewerId, message } = input;

  // Validate document exists and is in DRAFT or CHANGES_REQUESTED status
  const document = await prisma.document.findUnique({
    where: { id: documentId },
  });

  if (!document) {
    return { success: false, error: 'Document not found' };
  }

  if (!['DRAFT', 'CHANGES_REQUESTED'].includes(document.status)) {
    return { success: false, error: 'Document cannot be submitted for review' };
  }

  // Validate reviewer is a supervisor
  const reviewer = await prisma.user.findUnique({
    where: { id: reviewerId },
  });

  if (!['PARTNER', 'SENIOR_ASSOCIATE'].includes(reviewer?.role)) {
    return { success: false, error: 'Reviewer must be a supervisor' };
  }

  // Update document
  const updated = await prisma.document.update({
    where: { id: documentId },
    data: {
      status: 'IN_REVIEW',
      reviewerId,
      submittedAt: new Date(),
      metadata: {
        ...document.metadata,
        reviewSubmissionMessage: message,
        submittedBy: user.id,
      },
    },
  });

  // Create audit log
  await prisma.documentAuditLog.create({
    data: {
      documentId,
      action: 'SUBMITTED_FOR_REVIEW',
      userId: user.id,
      details: { reviewerId, message },
    },
  });

  // TODO: Send notification to reviewer

  return { success: true, document: updated };
};
```

### 3. Implement reviewDocument resolver

```typescript
reviewDocument: async (_, { input }, { user }) => {
  const { documentId, decision, comment } = input;

  const document = await prisma.document.findUnique({
    where: { id: documentId },
  });

  if (!document) {
    return { success: false, error: 'Document not found' };
  }

  if (document.status !== 'IN_REVIEW') {
    return { success: false, error: 'Document is not in review' };
  }

  if (document.reviewerId !== user.id) {
    return { success: false, error: 'You are not the assigned reviewer' };
  }

  if (decision === 'REQUEST_CHANGES' && !comment) {
    return { success: false, error: 'Comment required when requesting changes' };
  }

  const newStatus = decision === 'APPROVE' ? 'FINAL' : 'CHANGES_REQUESTED';

  const updated = await prisma.document.update({
    where: { id: documentId },
    data: {
      status: newStatus,
      reviewerId: decision === 'APPROVE' ? null : document.reviewerId,
      metadata: {
        ...document.metadata,
        lastReviewDecision: decision,
        lastReviewComment: comment,
        lastReviewedAt: new Date().toISOString(),
        lastReviewedBy: user.id,
      },
    },
  });

  // Create audit log
  await prisma.documentAuditLog.create({
    data: {
      documentId,
      action: decision === 'APPROVE' ? 'APPROVED' : 'CHANGES_REQUESTED',
      userId: user.id,
      details: { comment },
    },
  });

  // TODO: Send notification to document owner

  return { success: true, document: updated };
};
```

### 4. Create SubmitForReviewModal component

```tsx
// components/documents/SubmitForReviewModal.tsx
'use client';

export function SubmitForReviewModal({ documentId, isOpen, onClose }) {
  const [reviewerId, setReviewerId] = useState('');
  const [message, setMessage] = useState('');
  const { supervisors, loading: loadingSupervisors } = useSupervisors();
  const [submitForReview, { loading }] = useMutation(SUBMIT_FOR_REVIEW);

  const handleSubmit = async () => {
    const result = await submitForReview({
      variables: {
        input: { documentId, reviewerId, message },
      },
    });

    if (result.data?.submitForReview.success) {
      toast.success('Document trimis pentru revizuire');
      onClose();
    } else {
      toast.error(result.data?.submitForReview.error);
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Trimite pentru revizuire</DialogTitle>
          <DialogDescription>
            Selectează un supervizor care să revizuiască documentul
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div>
            <Label>Supervizor</Label>
            <Select value={reviewerId} onValueChange={setReviewerId}>
              <SelectTrigger>
                <SelectValue placeholder="Selectează supervizor" />
              </SelectTrigger>
              <SelectContent>
                {supervisors.map((supervisor) => (
                  <SelectItem key={supervisor.id} value={supervisor.id}>
                    <div className="flex items-center gap-2">
                      <Avatar className="h-6 w-6">
                        <AvatarImage src={supervisor.avatar} />
                        <AvatarFallback>{supervisor.initials}</AvatarFallback>
                      </Avatar>
                      {supervisor.name}
                    </div>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          <div>
            <Label>Mesaj (opțional)</Label>
            <Textarea
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              placeholder="Adaugă un mesaj pentru supervizor..."
              rows={3}
            />
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>
            Anulează
          </Button>
          <Button onClick={handleSubmit} disabled={!reviewerId || loading}>
            {loading ? <Loader2 className="h-4 w-4 animate-spin" /> : null}
            Trimite
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

### 5. Create ReviewActionsModal component

```tsx
// components/documents/ReviewActionsModal.tsx
'use client';

export function ReviewActionsModal({ document, isOpen, onClose }) {
  const [decision, setDecision] = useState<'APPROVE' | 'REQUEST_CHANGES' | null>(null);
  const [comment, setComment] = useState('');
  const [reviewDocument, { loading }] = useMutation(REVIEW_DOCUMENT);

  const handleReview = async () => {
    if (!decision) return;

    const result = await reviewDocument({
      variables: {
        input: { documentId: document.id, decision, comment },
      },
    });

    if (result.data?.reviewDocument.success) {
      toast.success(decision === 'APPROVE' ? 'Document aprobat' : 'Modificări solicitate');
      onClose();
    } else {
      toast.error(result.data?.reviewDocument.error);
    }
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Revizuire document</DialogTitle>
          <DialogDescription>{document.fileName}</DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* Submission info */}
          {document.metadata?.reviewSubmissionMessage && (
            <div className="bg-gray-50 p-3 rounded-lg">
              <p className="text-sm text-gray-600">Mesaj de la {document.metadata.submittedBy}:</p>
              <p className="text-sm mt-1">"{document.metadata.reviewSubmissionMessage}"</p>
            </div>
          )}

          {/* Decision buttons */}
          <div className="flex gap-3">
            <Button
              variant={decision === 'APPROVE' ? 'default' : 'outline'}
              className="flex-1"
              onClick={() => setDecision('APPROVE')}
            >
              <Check className="h-4 w-4 mr-2" />
              Aprobă
            </Button>
            <Button
              variant={decision === 'REQUEST_CHANGES' ? 'destructive' : 'outline'}
              className="flex-1"
              onClick={() => setDecision('REQUEST_CHANGES')}
            >
              <MessageSquare className="h-4 w-4 mr-2" />
              Solicită modificări
            </Button>
          </div>

          {/* Comment field (required for changes) */}
          {decision === 'REQUEST_CHANGES' && (
            <div>
              <Label>Comentariu *</Label>
              <Textarea
                value={comment}
                onChange={(e) => setComment(e.target.value)}
                placeholder="Descrie modificările necesare..."
                rows={4}
              />
            </div>
          )}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>
            Anulează
          </Button>
          <Button
            onClick={handleReview}
            disabled={!decision || (decision === 'REQUEST_CHANGES' && !comment) || loading}
          >
            {loading ? <Loader2 className="h-4 w-4 animate-spin" /> : null}
            Confirmă
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

### 6. Add "Trimite la revizuire" to document preview

```tsx
// In DocumentPreviewModal.tsx action toolbar
{
  document.status === 'DRAFT' && (
    <Button onClick={() => setShowSubmitModal(true)}>
      <Send className="h-4 w-4 mr-2" />
      Trimite la revizuire
    </Button>
  );
}

{
  document.status === 'CHANGES_REQUESTED' && (
    <div className="bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
      <p className="text-sm font-medium text-yellow-800">Modificări solicitate</p>
      <p className="text-sm text-yellow-700 mt-1">{document.metadata?.lastReviewComment}</p>
      <Button size="sm" className="mt-2" onClick={() => setShowSubmitModal(true)}>
        Retrimite pentru revizuire
      </Button>
    </div>
  );
}
```

### 7. Create useSupervisors hook

```typescript
// hooks/useSupervisors.ts
const GET_SUPERVISORS = gql`
  query GetSupervisors {
    supervisors {
      id
      name
      email
      avatar
      role
    }
  }
`;

export function useSupervisors() {
  const { data, loading } = useQuery(GET_SUPERVISORS);
  return {
    supervisors: data?.supervisors ?? [],
    loading,
  };
}
```

## Files to Modify

- `services/gateway/src/graphql/schema/document.graphql` - mutations
- `services/gateway/src/graphql/resolvers/document.resolvers.ts` - resolvers
- New: `apps/web/src/components/documents/SubmitForReviewModal.tsx`
- New: `apps/web/src/components/documents/ReviewActionsModal.tsx`
- New: `apps/web/src/hooks/useSupervisors.ts`
- `apps/web/src/components/preview/DocumentPreviewModal.tsx` - add submit button
- `apps/web/src/components/documents/ReviewQueueItem.tsx` - add review actions

## Dependencies

- OPS-171 (reviewerId field)
- OPS-172 (IN_REVIEW, CHANGES_REQUESTED statuses)
- OPS-174 (supervisor queue to trigger review modal)

## Acceptance Criteria

- [ ] "Trimite la revizuire" button on DRAFT documents
- [ ] Supervisor picker modal with firm supervisors
- [ ] Optional message field when submitting
- [ ] Supervisors see "Aprobă" and "Solicită modificări" buttons
- [ ] Comment required when requesting changes
- [ ] Document status updates correctly after actions
- [ ] CHANGES_REQUESTED documents show reviewer feedback
- [ ] "Retrimite" button for resubmission after changes
- [ ] Audit log entries created for all actions
- [ ] Toast notifications for success/error states

## Workflow Diagram

```
┌──────────────────────────────────────────────────────────────────┐
│                         DOCUMENT AUTHOR                          │
└──────────────────────────────────────────────────────────────────┘
        │
        │ Click "Trimite la revizuire"
        ▼
┌──────────────────────────────────────────────────────────────────┐
│  SubmitForReviewModal                                            │
│  - Select supervisor                                             │
│  - Optional message                                              │
│  - Submit                                                        │
└──────────────────────────────────────────────────────────────────┘
        │
        │ Document status → IN_REVIEW
        ▼
┌──────────────────────────────────────────────────────────────────┐
│                          SUPERVISOR                              │
│  Sees document in "De revizuit" tab                              │
└──────────────────────────────────────────────────────────────────┘
        │
        │ Click "Revizuiește"
        ▼
┌──────────────────────────────────────────────────────────────────┐
│  ReviewActionsModal                                              │
│  - Aprobă → status = FINAL                                       │
│  - Solicită modificări → status = CHANGES_REQUESTED              │
└──────────────────────────────────────────────────────────────────┘
        │
        │ If CHANGES_REQUESTED
        ▼
┌──────────────────────────────────────────────────────────────────┐
│  DOCUMENT AUTHOR                                                 │
│  - Sees feedback in preview                                      │
│  - Makes changes                                                 │
│  - "Retrimite pentru revizuire"                                  │
└──────────────────────────────────────────────────────────────────┘
```

## Future Enhancements

- Email notifications for review requests
- In-app notification badges
- Review history timeline
- Bulk review actions
- Review delegation (reassign to another supervisor)
