# OPS-099: Mapa Data Model

**Type:** Feature
**Priority:** P1-High
**Status:** Fixed
**Created:** 2024-12-22
**Completed:** 2024-12-22

## Summary

Create the Prisma data model for "Mape" (document binders/dossiers) - a structured way to organize case documents with explicit slots for expected documents and table of contents functionality.

## Background

Lawyers need to prepare "mape" (binders) for court submissions. Each mapa has:

- A defined list of expected documents (slots)
- Visual indication of what's present vs missing
- A specific order for printing/submission

This is distinct from simple folders - it's a checklist-based dossier system.

## Data Model

```prisma
// ============================================================================
// Mapa (Document Binder/Dossier)
// ============================================================================

model Mapa {
  id          String      @id @default(cuid())
  caseId      String
  case        Case        @relation(fields: [caseId], references: [id], onDelete: Cascade)
  name        String      // e.g., "Mapa pentru Tribunal"
  description String?

  // Template reference (optional - for pre-defined structures)
  templateId  String?
  template    MapaTemplate? @relation(fields: [templateId], references: [id])

  // Metadata
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  createdById String
  createdBy   User        @relation(fields: [createdById], references: [id])

  // Relations
  slots       MapaSlot[]

  // Indexes
  @@index([caseId])
  @@index([templateId])
}

model MapaSlot {
  id          String      @id @default(cuid())
  mapaId      String
  mapa        Mapa        @relation(fields: [mapaId], references: [id], onDelete: Cascade)

  // Slot definition
  name        String      // e.g., "Cerere de chemare în judecată"
  description String?     // Optional guidance text
  category    String?     // e.g., "Acte procedurale", "Dovezi"
  required    Boolean     @default(true)
  order       Int         // Position in TOC

  // Assigned document (null = slot is empty/missing)
  caseDocumentId  String?
  caseDocument    CaseDocument? @relation(fields: [caseDocumentId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  assignedAt  DateTime?   // When document was assigned
  assignedById String?
  assignedBy  User?       @relation("SlotAssigner", fields: [assignedById], references: [id])

  // Indexes
  @@index([mapaId])
  @@index([caseDocumentId])
  @@unique([mapaId, order]) // Ensure unique ordering within mapa
}

// ============================================================================
// Mapa Templates (Firm-level reusable structures)
// ============================================================================

model MapaTemplate {
  id          String      @id @default(cuid())
  firmId      String
  firm        Firm        @relation(fields: [firmId], references: [id], onDelete: Cascade)

  name        String      // e.g., "Mapa Standard Civila"
  description String?
  caseType    String?     // Optional: associate with case types

  // Template slot definitions (JSON for flexibility)
  // Array of: { name, description?, category?, required, order }
  slotDefinitions Json

  // Metadata
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  createdById String
  createdBy   User        @relation(fields: [createdById], references: [id])

  // Relations
  mape        Mapa[]      // Mape created from this template

  // Indexes
  @@index([firmId])
  @@index([caseType])
}
```

## Required Schema Changes

1. Add `Mapa` model
2. Add `MapaSlot` model
3. Add `MapaTemplate` model
4. Add relation from `Case` to `Mapa[]`
5. Add relation from `CaseDocument` to `MapaSlot[]`
6. Add relation from `User` to created mape and slot assignments
7. Add relation from `Firm` to `MapaTemplate[]`

## Migration Notes

- No data migration needed (new feature)
- Consider adding sample templates post-migration for testing

## Acceptance Criteria

- [x] Prisma schema includes all three models
- [x] Migration runs successfully
- [x] Relations are correctly defined with appropriate cascade behavior
- [x] Indexes are in place for common queries

## Dependencies

- None (foundational)

## Blocks

- OPS-100: Mapa Service Layer
- OPS-101: Mapa GraphQL Schema

## Notes

- `MapaSlot.caseDocumentId` references `CaseDocument` (not `Document`) because documents are case-specific
- Template `slotDefinitions` uses JSON for flexibility - avoids additional join table
- `onDelete: SetNull` for slot→document means deleting a document empties the slot rather than deleting the slot

## Session Log

- [2024-12-22] Session 1: Implemented Mapa data model
  - Added `Mapa`, `MapaSlot`, `MapaTemplate` models to Prisma schema
  - Added reverse relations to `Case`, `User`, `Firm`, `CaseDocument`
  - Created migration `20251222100000_add_mapa_models`
  - Applied migration successfully
  - Verified all three tables are accessible via Prisma client

## Local Verification Status

| Step           | Status     | Date | Notes                          |
| -------------- | ---------- | ---- | ------------------------------ |
| Prod data test | ⬜ Pending |      | Data model only, no UI to test |
| Preflight      | ⬜ Pending |      | Need to run pnpm preflight     |
| Docker test    | ⬜ Pending |      | Data model only, no UI to test |

**Verified**: No (data model change, verification deferred to dependent issues)
