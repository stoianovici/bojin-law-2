# OPS-058: Multi-Case Email Data Model

| Field           | Value                     |
| --------------- | ------------------------- |
| **Status**      | Implemented               |
| **Type**        | Feature                   |
| **Priority**    | P0-Critical               |
| **Created**     | 2025-12-20                |
| **Sessions**    | 2                         |
| **Last Active** | 2025-12-20                |
| **Blocks**      | OPS-059, OPS-060, OPS-061 |

## Description

Enable emails to be linked to multiple cases simultaneously. Currently, the Email model has a single `caseId` field, which means an email can only belong to one case. This causes issues when:

1. A contact (e.g., john@example.com) is associated with multiple cases for the same client
2. Thread continuity locks all replies to the first case that received an email
3. New cases with shared contacts never receive emails from existing threads

## Root Cause (from /ops-investigate)

**Symptom:** Emails and documents not being sorted for a new case that shares client/contacts with an existing case.

**Investigation Category:** A - "X Not Appearing"

### Investigation Summary

| Hypothesis                     | Verdict | Key Finding                                                                     |
| ------------------------------ | ------- | ------------------------------------------------------------------------------- |
| Thread Continuity Override     | ❌      | `classification-scoring.ts:191-204` - Thread continuity bypasses multi-case     |
| Single caseId Constraint       | ❌      | `schema.prisma:2543` - Email can only belong to ONE case                        |
| Contact Scoring Too Low        | ⚠️      | Contact match = 10 pts, threshold = 70, can't distinguish without other signals |
| No Re-classification on Create | ⚠️      | Case creation doesn't trigger re-evaluation of classified emails                |

### The Failing Flow

```
1. Case A created for Client X (contact: john@example.com)
2. Email arrives from john@example.com → classified to Case A
3. Case B created for Client X (same contact: john@example.com)
4. New email arrives on SAME thread (same conversationId)
   → Thread continuity finds prior email in Case A
   → Returns Case A with 100% confidence
   → Multi-case scoring NEVER executes
   → Email assigned to Case A, Case B gets nothing
```

## Solution: Multi-Case Email Model

Replace single `caseId` foreign key with a junction table `EmailCaseLink` that allows many-to-many relationships.

### Schema Changes

```prisma
// NEW: Junction table for email-case relationships
model EmailCaseLink {
  id        String   @id @default(uuid())
  emailId   String   @map("email_id")
  caseId    String   @map("case_id")

  // Classification metadata (per-case)
  confidence     Float?
  matchType      ClassificationMatchType?
  linkedAt       DateTime @default(now()) @map("linked_at") @db.Timestamptz
  linkedBy       String   @map("linked_by") // "auto" or userId
  isPrimary      Boolean  @default(false) @map("is_primary") // Original classification

  // Relations
  email     Email    @relation(fields: [emailId], references: [id], onDelete: Cascade)
  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@unique([emailId, caseId])
  @@index([emailId])
  @@index([caseId])
  @@map("email_case_links")
}

// MODIFY: Email model
model Email {
  // ... existing fields ...

  // REMOVE: caseId String? @map("case_id")
  // ADD: Multi-case relationship
  caseLinks EmailCaseLink[]

  // Keep classification state (Pending, Classified, Uncertain, etc.)
  classificationState EmailClassificationState @default(Pending)
}

// MODIFY: Case model
model Case {
  // ... existing fields ...

  // ADD: Email links
  emailLinks EmailCaseLink[]
}
```

### Key Design Decisions

1. **isPrimary flag**: Tracks which case was the "original" classification target
2. **Per-case confidence**: Each link has its own confidence score
3. **Cascade delete**: Removing email or case cleans up links automatically
4. **Unique constraint**: Prevents duplicate email-case pairs

## Implementation Steps

1. Create Prisma migration for EmailCaseLink model
2. Update Email model to remove caseId, add caseLinks relation
3. Update Case model to add emailLinks relation
4. Run migration (empty table initially)

## Files to Modify

- `packages/database/prisma/schema.prisma` - Add EmailCaseLink model
- `packages/database/prisma/migrations/` - New migration file

## Acceptance Criteria

- [x] EmailCaseLink model exists in Prisma schema
- [x] Email.caseLinks relation added (Email.caseId kept for backward compatibility until OPS-061)
- [x] Case.emailLinks relation added
- [x] Migration created (20251220130000_add_email_case_links)
- [ ] Existing email data preserved (migration handled in OPS-061)

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

## Session Log

- [2025-12-20] Issue created via /ops-investigate. Root cause: thread continuity + single caseId constraint.
- [2025-12-20] Session 2: Implemented data model changes:
  - Added `ThreadContinuity` to `ClassificationMatchType` enum
  - Created `EmailCaseLink` junction table with confidence, matchType, isPrimary fields
  - Added `Email.caseLinks` relation (kept `Email.caseId` for backward compatibility)
  - Added `Case.emailLinks` relation
  - Created migration `20251220130000_add_email_case_links`
  - Prisma client generated successfully
  - Gateway and web packages compile without errors

---
