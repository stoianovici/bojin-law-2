# OPS-042: Classification Modal (NECLAR Queue)

**Status:** Verifying | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-18 | **Sessions:** 1 | **Last Active:** 2025-12-18

## Overview

Build the user-facing classification modal for resolving uncertain email assignments.

## Dependencies

- **Depends on:** OPS-035, OPS-039
- **Blocks:** None
- **Parallel with:** OPS-041

## Context

Part of the Communications Architecture Rethink. When the classification algorithm is uncertain (multi-case contact with ambiguous signals), the email lands in the NECLAR queue. Users resolve these on-demand via a modal.

**Key principle:** User-initiated, not forced. The modal is accessible when the user chooses to address uncertain emails.

## Requirements

### 1. Modal Trigger

From `/communications` page:

- Click on an item in the NECLAR section
- Or click the NECLAR badge/count

### 2. Modal Design

```
┌────────────────────────────────────────────────────────────────┐
│  Clasifică emailul                                        [×]  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ De la: maria.popescu@email.com                           │  │
│  │ Subiect: Documente solicitate                            │  │
│  │ Data: 18 dec 2025, 10:32                                 │  │
│  │                                                          │  │
│  │ Bună ziua,                                               │  │
│  │ Vă trimit documentele solicitate pentru dosarul...       │  │
│  │ [Vezi tot emailul ▼]                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  Maria Popescu are 2 dosare active:                            │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ○ Popescu v. Ionescu                           70% potrivire│
│  │   Indicii: "documente" apare în cuvinte cheie              │
│  │   Ultima activitate: 15 dec 2025                           │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ○ Popescu - Succesiune                         45% potrivire│
│  │   Fără indicii clare                                       │
│  │   Ultima activitate: 2 dec 2025                            │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ○ Alt dosar...                                             │
│  │   Caută sau creează un dosar nou                           │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ○ Ignoră                                                   │
│  │   Emailul nu e relevant pentru niciun dosar                │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│                              [Anulează]  [Confirmă]            │
└────────────────────────────────────────────────────────────────┘
```

### 3. Modal Features

**Email Preview:**

- Sender, subject, date
- First few lines of body
- Expandable to see full email

**Case Options:**

- Suggested cases with confidence percentage
- Signal explanations ("documente" apare în cuvinte cheie)
- Last activity date for context
- Radio button selection

**Other Options:**

- "Alt dosar" - search/select any case
- "Ignoră" - mark as not relevant (IGNORED state)

### 4. Classification Action

```graphql
mutation classifyUncertainEmail($emailId: ID!, $action: ClassificationAction!) {
  classifyUncertainEmail(emailId: $emailId, action: $action) {
    email {
      id
      caseId
      classificationState
    }
  }
}

input ClassificationAction {
  type: ClassificationActionType! # ASSIGN_TO_CASE | IGNORE
  caseId: ID # Required if type is ASSIGN_TO_CASE
}
```

### 5. After Classification

- Email moves from NECLAR to appropriate case section
- Or disappears if ignored
- Toast confirmation: "Email clasificat în Popescu v. Ionescu"

### 6. Batch Classification (Optional Enhancement)

If multiple emails from same sender are uncertain:

- Option to "Aplică pentru toate emailurile de la acest expeditor"
- Classify all at once

## Acceptance Criteria

- [x] Modal opens when clicking NECLAR item
- [x] Email preview shows sender, subject, date, body excerpt
- [x] Suggested cases shown with confidence scores
- [x] Signal explanations displayed
- [x] Case search/select for "Alt dosar"
- [x] Ignore option available
- [x] Confirm assigns email to selected case
- [x] Email state updated correctly
- [ ] Email moves to correct section after classification _(Depends on OPS-041 UI)_
- [x] Toast confirmation shown
- [x] No TypeScript errors

## Files to Modify

- New: `apps/web/src/components/communication/ClassificationModal.tsx`
- New: `apps/web/src/hooks/useClassifyEmail.ts`
- `services/gateway/src/graphql/schema/email-classification.graphql`
- `services/gateway/src/graphql/resolvers/email-classification.resolver.ts`
- Integrate into `apps/web/src/app/communications/page.tsx` (OPS-041)

## Estimated Scope

Medium - Modal component + mutation.

---

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

## Session Log

### Session 1 - 2025-12-18

**Work Completed:**

1. **Added GraphQL schema for NECLAR classification** (email.graphql):
   - `ClassificationSignal` type for explaining why a case was suggested
   - `UncertainEmailCase` type with score, signals, and lastActivityAt
   - `UncertainEmail` type for NECLAR queue items
   - `ClassificationActionType` enum (ASSIGN_TO_CASE, IGNORE)
   - `ClassificationActionInput` input type
   - `ClassifyUncertainEmailResult` result type
   - `uncertainEmails` query for listing NECLAR items
   - `uncertainEmailsCount` query
   - `uncertainEmail(id)` query for modal details
   - `classifyUncertainEmail` mutation

2. **Implemented resolver in email.resolvers.ts**:
   - Added `getSuggestedCasesForEmail()` helper function
   - Scores cases based on keywords, reference numbers, recent activity
   - `uncertainEmails` query resolver
   - `uncertainEmailsCount` query resolver
   - `uncertainEmail` query resolver
   - `classifyUncertainEmail` mutation resolver (handles both ASSIGN_TO_CASE and IGNORE)
   - Creates EmailClassificationLog entry for audit trail
   - Syncs to CommunicationEntry for unified timeline

3. **Created ClassificationModal.tsx component**:
   - Email preview with expandable body content
   - Suggested cases with confidence scores and signal badges
   - "Alt dosar" option with case search
   - "Ignoră" option for marking as not relevant
   - Romanian UI text
   - Loading and error states
   - Toast notifications on success/error

4. **Created useClassifyEmail.ts hook**:
   - `useUncertainEmails()` - fetch NECLAR queue
   - `useUncertainEmailsCount()` - get count
   - `useUncertainEmail(id)` - fetch single email for modal
   - `useClassifyUncertainEmail()` - mutation hook with classifyToCase and markAsIgnored
   - `useClassificationModal(id)` - combined hook for modal

**Tests:**

- ✅ Gateway TypeScript compiles with no errors
- ✅ Web app TypeScript compiles with no errors
- ⬜ Local verification pending

**Files Created:**

- `apps/web/src/components/communication/ClassificationModal.tsx`
- `apps/web/src/hooks/useClassifyEmail.ts`

**Files Modified:**

- `services/gateway/src/graphql/schema/email.graphql`
- `services/gateway/src/graphql/resolvers/email.resolvers.ts`

**Note:** Integration into /communications page pending OPS-041 (case-organized redesign).
