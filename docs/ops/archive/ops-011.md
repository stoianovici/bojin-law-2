# [OPS-011] Refocus /communications on received emails only

| Field           | Value      |
| --------------- | ---------- |
| **Status**      | Resolved   |
| **Type**        | Feature    |
| **Priority**    | P1-High    |
| **Created**     | 2025-12-12 |
| **Sessions**    | 5          |
| **Last Active** | 2025-12-12 |

## Description

The /communications section should focus exclusively on processing received emails. Sent items will be handled via Outlook directly. The goal is to streamline the workflow for:

1. **Quick replies** - AI-generated responses to received emails
2. **Extraction of actionable elements** - deadlines, tasks, commitments, questions
3. **Composing update messages** - notifying relevant actors based on received info

**Current architecture note:** The system already syncs inbox-only from Microsoft Graph API (`/me/mailFolders/Inbox`), so the backend is naturally aligned with this goal. The main work is UI simplification and feature enhancement.

## Planned Work

**Phase 1: UI Simplification** ✅ COMPLETED (Session 2)

- [x] Remove "Trimise" (Sent) tab from FilterBar
- [x] Simplify emailViewMode to `'all' | 'received'` (remove 'sent')
- [x] Filter user's own messages in MessageView
- [x] Replace "Mesaj nou" with "Open in Outlook" button

**Phase 2: AI Extraction Integration** ✅ COMPLETED (Session 3)

- [x] Investigate existing AI extraction (implemented in OPS-005, OPS-006)
- [x] Verify ExtractedItemsPanel integration with communications page
- [x] Document current state - fully integrated, minor type gap noted
- [ ] Test extraction E2E in production (requires synced emails assigned to a case)

**Phase 3: Communication Tools** ✅ COMPLETED (Session 3)

- [x] "Notify stakeholders" button - `NotifyStakeholdersModal` component, appears when thread assigned to case
- [x] Thread summary/TL;DR - `ThreadSummaryPanel` integrated into /communications
- [x] Daily email digest - `MorningBriefing` component already in all dashboards (OPS-006)
- [x] Follow-up tracking - Part of proactive AI suggestions system (`FollowUp` type)

## Root Cause

N/A - Feature enhancement, not a bug fix. However, a bug was discovered in Session 5: GraphQL resolvers in `communication-intelligence.resolvers.ts` expected `prisma` to be in the context, but the actual GraphQL context only provides `user` object.

## Fix Applied

**Session 5 Fix (ExtractedItemsPanel error):**

- Changed `communication-intelligence.resolvers.ts` to import `prisma` directly from `@legal-platform/database`
- Updated Context interface from `{ prisma, userId, firmId }` to `{ user?: { id, firmId, role, email } }`
- Updated all resolvers to get firmId from `context.user?.firmId`
- Commit: `f9ca082`

## Local Dev Environment

```bash
# Full dev environment:
pnpm dev

# Individual services:
cd services/gateway && pnpm dev     # GraphQL gateway on :4000
cd services/ai-service && pnpm dev  # AI service on :3002
cd apps/web && pnpm dev             # Next.js frontend on :3000
```

## Investigation Findings (Session 1)

**Why sent emails appear in "Primite" (Received) view:**

1. **Sync is inbox-only** - `email-sync.service.ts` uses `/me/mailFolders/Inbox/messages` endpoint
2. **But Exchange stores sent replies in Inbox** - When you reply to an email, Microsoft Exchange stores a copy of your reply in the Inbox folder as part of conversation threading (common with "Conversation View" enabled)
3. **Thread-level filtering** - Current "Primite" filter shows threads that have at least one message NOT from user, but displays ALL messages in the thread including user's sent replies
4. **Webhook subscription** - Uses `/me/messages` (all messages) but only queues sync which still uses inbox endpoint

**Data flow confirmed:**

```
MS Graph /me/mailFolders/Inbox/messages
    ↓ (includes user's replies due to Exchange behavior)
Prisma Email table (no folder tracking)
    ↓
Thread grouping by conversationId
    ↓
"Primite" filter: threads.some(msg => msg.sender !== user) ✓
    ↓
Thread display: ALL messages shown (including user's replies) ✗
```

**Decision: Option A - Filter out user's messages from thread view**

For the /communications page focused on processing received messages:

- Only display messages NOT from the current user in MessageView
- Full conversation threads will be viewable in Case Details
- This keeps the view clean for fast processing of incoming messages

## Session Log

- [2025-12-12 22:30] Issue created. Initial triage: Backend already syncs inbox-only from MS Graph, so architecture aligns with received-mail-only goal. Key work areas: (1) Remove sent tab and simplify UI, (2) Enhance quick reply features, (3) Improve extraction workflow, (4) Add communication tools.
- [2025-12-12 23:00] Investigation: Why sent emails appear in "Primite". Root cause: Exchange stores sent replies in Inbox as part of conversation threading. The sync is correct (inbox-only), but inbox contains user's replies. Decision: Filter out user's messages at display level in MessageView (Option A).
- [2025-12-12] Session 2 started. Continuing from: New. Implementing Phase 0 (filter user's messages) and Phase 1 (remove Sent tab).
- [2025-12-12] Session 2 - **Phase 0 completed**: Added user message filtering to MessageView. Messages where sender matches user email are hidden. Shows "X răspunsuri proprii ascunse" indicator.
- [2025-12-12] Session 2 - **Phase 1 completed**:
  1. FilterBar: Replaced "Primite/Trimise/Toate" tabs with "De procesat/Toate" tabs (based on showProcessed state)
  2. communication.store.ts: Simplified EmailViewMode type to `'all' | 'received'` (removed 'sent')
  3. communications/page.tsx: Replaced "Mesaj nou" button with "Outlook" link to open Outlook Web compose
- [2025-12-12] Session 2 - Build verified successful. All Phase 0+1 changes compile without errors.
- [2025-12-12] Session 2 - Committed `9c19202`, pushed to origin/main.
- [2025-12-12] Session 2 - Updated roadmap: Removed quick reply templates. Phase 2 now focuses on investigating existing AI extraction (from OPS-005/006). Phase 3 is Communication Tools.
- [2025-12-12] Session 3 started. Continuing from: Fixing. Investigating AI extraction implementation per user note.
- [2025-12-12] Session 3 - Investigation findings:
  1. **Two UI components exist**: `ExtractedItemsPanel` (GraphQL-connected, production) and `ExtractedItemsSidebar` (mock data, legacy)
  2. **Communications page uses the correct one**: `ExtractedItemsPanel` is imported and used at line 298
  3. **Backend is complete**: GraphQL resolvers, AI service, and background worker all functional
  4. **Integration is complete**: Panel fetches via `usePendingExtractedItems(caseId)` GraphQL hook
  5. **Minor type gap**: `packages/shared/types/src/communication.ts` ExtractedItems only has 3 types, backend has 4 (includes questions)
  6. **Legacy sidebar is unused**: Only appears in tests and Storybook stories, not in any page component
- [2025-12-12] Session 3 - Phase 3 progress:
  1. **ThreadSummaryPanel integrated**: Added to /communications right sidebar, shows thread analysis when thread is selected
  2. **MorningBriefing verified**: Already integrated in all dashboards (OPS-006)
  3. **Follow-up tracking verified**: Part of proactive AI suggestions (`FollowUp` type in proactive-suggestions.graphql)
  4. **Notify stakeholders**: NOT yet implemented - only Phase 3 item remaining
- [2025-12-12] Session 3 - Build verified successful. Committed `8ed5b1f`, pushed to origin/main.
- [2025-12-12] Session 3 - Phase 3 complete: Implemented `NotifyStakeholdersModal` - "Notifică părțile" button in MessageView actions.
- [2025-12-12] Session 3 - All phases complete (0+1, 2, 3). Status: Verifying.
- [2025-12-12] Session 4 started. ExtractedItemsPanel failing with "Cannot read properties of undefined (reading 'extractedDeadline')".
- [2025-12-12] Session 4 - Root cause: GraphQL resolvers not including relations (email, case, convertedTask). Added `include` statements. Deployed.
- [2025-12-12] Session 5 started. Continuing from: Verifying. Testing extracted items fix.
- [2025-12-12] Session 5 - Error persisted. Found real root cause: `communication-intelligence.resolvers.ts` expected `prisma` in GraphQL context, but context only provides `user` object. The resolver was trying to access `context.prisma.extractedDeadline` but `context.prisma` was undefined.
- [2025-12-12] Session 5 - Fix: Changed resolver to import `prisma` directly from `@legal-platform/database` instead of expecting it in context. Updated Context interface to match actual structure. Committed `f9ca082`.
- [2025-12-12] Session 5 - Deployed and verified. All extracted items queries (deadlines, commitments, actionItems, questions) now return data correctly. **RESOLVED**.

## Files Involved

**Frontend - Main Page:**

- `apps/web/src/app/communications/page.tsx` - **FIXED (Session 2+3)** - Replaced "Mesaj nou" with Outlook link, added ThreadSummaryPanel
- `apps/web/src/components/communication/NotifyStakeholdersModal.tsx` - **NEW (Session 3)** - Notify stakeholders modal
- `apps/web/src/components/communication/MessageView.tsx` - **FIXED (Session 3)** - Added "Notifică părțile" button

**Frontend - Components Modified:**

- `apps/web/src/components/communication/FilterBar.tsx` - **FIXED (Session 2)** - Replaced sent/received tabs with processing status tabs
- `apps/web/src/components/communication/MessageView.tsx` - **FIXED (Session 2)** - Filters out user's own messages, shows hidden count

**Frontend - State Management:**

- `apps/web/src/stores/communication.store.ts` - **FIXED (Session 2)** - Simplified EmailViewMode to 'all'|'received'

**Frontend - To Investigate (Phase 2):**

- `apps/web/src/components/communication/ExtractedItemsPanel.tsx` - AI extraction panel (verify integration)
- `apps/web/src/hooks/useExtractedItems.ts` - GraphQL hooks for extraction

**Backend - Gateway:**

- `services/gateway/src/services/email-sync.service.ts` - Syncs `/me/mailFolders/Inbox` only
- `services/gateway/src/graphql/resolvers/email-drafting.resolvers.ts` - AI draft generation
- `services/gateway/src/graphql/resolvers/communication-intelligence.resolvers.ts` - **FIXED (Session 5)** - Changed to import prisma directly

**AI Service (No changes needed):**

- `services/ai-service/src/services/email-drafting.service.ts` - Reply generation
- `services/ai-service/src/services/communication-intelligence.service.ts` - Extraction
