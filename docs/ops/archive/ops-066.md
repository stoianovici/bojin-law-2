# OPS-066: AI Orchestrator Service

**Status:** Implemented | **Priority:** P1-High | **Type:** Feature
**Created:** 2025-12-20 | **Depends on:** OPS-063, OPS-065, OPS-077 | **Blocks:** OPS-067, OPS-072, OPS-073, OPS-074, OPS-075, OPS-076

> **Note (OPS-077):** This service integrates with the existing `NaturalLanguageCommandService`
> (`services/gateway/src/services/natural-language-command.service.ts`) for initial intent parsing.
> The orchestrator routes parsed intents to specialized handlers.

## Summary

Create the central orchestrator service that processes user messages, detects intents, routes to handlers, and formats responses.

## Background

The orchestrator is the brain of the AI assistant. It:

1. Receives user messages with context
2. Detects intent using Claude (Haiku for speed)
3. Routes to the appropriate intent handler
4. Generates natural language responses
5. Builds proposed actions for confirmation

## Requirements

### Service Interface

```typescript
// services/gateway/src/services/ai-orchestrator.service.ts

// ============================================================================
// Types
// ============================================================================

enum AssistantIntent {
  // Task & Calendar
  CreateTask = 'CreateTask',
  UpdateTask = 'UpdateTask',
  QueryTasks = 'QueryTasks',
  ScheduleEvent = 'ScheduleEvent',

  // Case Information
  CaseQuery = 'CaseQuery',
  CaseSummary = 'CaseSummary',

  // Communication
  SearchEmails = 'SearchEmails',
  SummarizeThread = 'SummarizeThread',
  DraftEmail = 'DraftEmail',

  // Document Operations
  FindDocument = 'FindDocument',
  SummarizeDocument = 'SummarizeDocument',
  GenerateDocument = 'GenerateDocument',

  // Proactive
  MorningBriefing = 'MorningBriefing',
  DeadlineAlert = 'DeadlineAlert',

  // General
  AskClarification = 'AskClarification',
  GeneralChat = 'GeneralChat',
}

interface AssistantContext {
  currentScreen?: string;
  currentCaseId?: string;
  currentDocumentId?: string;
  selectedEmailId?: string;
  selectedText?: string;
}

interface UserContext {
  userId: string;
  firmId: string;
  role: string;
  email: string;
}

interface ProposedAction {
  type: string;
  displayText: string;
  payload: Record<string, unknown>;
  requiresConfirmation: boolean;
  confirmationPrompt?: string;
  entityPreview?: Record<string, unknown>;
}

interface OrchestratorResult {
  intent: AssistantIntent;
  confidence: number;
  response: string;
  proposedAction?: ProposedAction;
  suggestedFollowUps: string[];
}

// ============================================================================
// Service
// ============================================================================

export class AIOrchestratorService {
  /**
   * Main entry point - process a user message.
   */
  async processMessage(
    message: string,
    context: AssistantContext,
    conversationHistory: AIMessage[],
    userContext: UserContext
  ): Promise<OrchestratorResult>;

  /**
   * Detect intent from user message.
   * Uses Claude Haiku for speed and cost efficiency.
   */
  private async detectIntent(
    message: string,
    context: AssistantContext,
    history: AIMessage[]
  ): Promise<{
    intent: AssistantIntent;
    confidence: number;
    params: Record<string, unknown>;
  }>;

  /**
   * Route to the appropriate intent handler.
   */
  private async routeIntent(
    intent: AssistantIntent,
    params: Record<string, unknown>,
    context: AssistantContext,
    userContext: UserContext
  ): Promise<{
    result: unknown;
    proposedAction?: ProposedAction;
  }>;

  /**
   * Generate natural language response.
   * Uses Claude Sonnet for quality responses.
   */
  private async generateResponse(
    intent: AssistantIntent,
    result: unknown,
    context: AssistantContext,
    language: 'ro' | 'en'
  ): Promise<string>;

  /**
   * Select model based on task complexity.
   */
  private selectModel(intent: AssistantIntent): 'haiku' | 'sonnet' | 'opus';

  /**
   * Get suggested follow-up questions.
   */
  private getSuggestedFollowUps(intent: AssistantIntent, result: unknown): string[];
}

export const aiOrchestratorService = new AIOrchestratorService();
```

### Intent Detection Prompt

```typescript
const INTENT_DETECTION_PROMPT = `
Ești un asistent juridic. Analizează mesajul utilizatorului și detectează intenția.

Mesaj: "{message}"
Context: {context}
Istoric: {history}

Răspunde cu JSON:
{
  "intent": "CreateTask" | "QueryTasks" | "CaseQuery" | "SearchEmails" | "FindDocument" | "GeneralChat" | ...,
  "confidence": 0.0-1.0,
  "params": {
    // Parametri extrași din mesaj
  }
}

Intenții disponibile:
- CreateTask: creare sarcină nouă
- QueryTasks: întrebare despre sarcini existente
- CaseQuery: întrebare despre detalii dosar
- SearchEmails: căutare emailuri
- DraftEmail: redactare email
- FindDocument: căutare document
- GeneralChat: conversație generală
`;
```

### Model Routing

| Intent                       | Model  | Rationale                      |
| ---------------------------- | ------ | ------------------------------ |
| Intent Detection             | Haiku  | Fast, cheap, structured output |
| CreateTask, ScheduleEvent    | Haiku  | Simple extraction              |
| CaseQuery, CaseSummary       | Sonnet | Context understanding          |
| DraftEmail, GenerateDocument | Sonnet | Quality generation             |
| Complex legal analysis       | Opus   | Maximum capability             |

## Acceptance Criteria

- [x] AIOrchestratorService class implemented
- [x] Intent detection with confidence scoring
- [x] Handler routing based on intent
- [x] Natural language response generation
- [x] Model selection based on complexity
- [x] Suggested follow-ups generated
- [x] Integration with AI service client
- [ ] Unit tests for orchestration flow (deferred)

## Files to Create

- `services/gateway/src/services/ai-orchestrator.service.ts`
- `services/gateway/src/services/ai-orchestrator.service.test.ts`

## Files to Modify

- `services/gateway/src/services/ai.service.ts` (add multi-turn support if needed)

## Session Log

- [2025-12-20T16:00] Session 1 started. Status: Open
- [2025-12-20T16:10] Reviewed existing service patterns: aiService, NaturalLanguageCommandService, caseSummaryService
- [2025-12-20T16:30] Created ai-orchestrator.service.ts with:
  - Full type definitions (AssistantIntent enum, contexts, ProposedAction, OrchestratorResult)
  - Intent detection using Claude Haiku with Romanian prompts
  - Handler routing for all 16 intent types
  - Response generation with template responses and AI-powered responses
  - Model selection based on intent complexity
  - Suggested follow-ups for each intent
- [2025-12-20T16:45] Implemented intent handlers:
  - CreateTask: Proposes task creation with confirmation
  - QueryTasks: Uses TaskService.getTasksByAssignee
  - CaseQuery/CaseSummary: Uses caseSummaryService
  - SearchEmails: Direct Prisma query for email search
  - DraftEmail: Uses emailDraftingService
  - FindDocument: Uses searchService with HYBRID mode
  - GenerateDocument: Uses documentGenerationService
  - MorningBriefing: Uses morningBriefingService
  - DeadlineAlert: Direct Prisma query for upcoming tasks
  - GeneralChat: AI-generated responses
- [2025-12-20T17:00] Updated ai-assistant.resolvers.ts to use real aiOrchestratorService instead of stub
- [2025-12-20T17:10] TypeScript compilation passed
- [2025-12-20T17:15] Preflight checks passed (6 ✓, 2 ⚠ non-blocking warnings)

#### Local Verification Status

| Step           | Status    | Notes                                      |
| -------------- | --------- | ------------------------------------------ |
| Prod data test | ⬜ N/A    | Backend service, no direct UI to test      |
| Preflight      | ✅ Passed | TypeScript compiles, Docker builds succeed |
| Docker test    | ✅ Passed | Gateway Docker build completed             |

**Verified**: Yes (backend service compiles and builds correctly)
