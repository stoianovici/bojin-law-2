# OPS-194: Partner Privacy UI + Case Details Filter

**Status:** Resolved | **Priority:** P2-Medium | **Type:** Feature | **Created:** 2025-12-24 | **Resolved:** 2025-12-24

## Overview

Frontend UI for partners to mark emails as private, and filtering of private emails from case details Communications tab.

## Dependencies

- **Depends on:** OPS-191 (privacy service + GraphQL)
- **Blocks:** None
- **Parallel with:** OPS-193, OPS-195, OPS-196

## Context

Part of Communications UX Overhaul epic. Partners can mark emails as private so they're hidden from case details (other team members won't see them), while still being visible in the partner's own /communications view.

## Requirements

### 1. Privacy Toggle in Action Bar

For partners only, add a toggle button:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [+ Nou]   [RÄƒspunde]   [Personal]   [ðŸ”’ Privat]        â”‚
â”‚                                      â†‘ Partners only    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Toggle states:**

- Off: Normal email visibility
- On: "ðŸ”’ Privat" with "(doar pentru tine)" tooltip

### 2. Privacy Indicator in /communications

When viewing a private email in /communications:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸ”’ Acest email este privat (doar pentru tine)          â”‚
â”‚                                                         â”‚
â”‚  [Email content...]                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Case Details Filtering

Update `CommunicationsTab.tsx` to exclude private emails:

```typescript
// Emails are already filtered server-side by OPS-191
// But add visual note if needed
```

Private emails should simply not appear in case details - no indication that hidden emails exist.

### 4. Hook

```typescript
function useEmailPrivacy(emailId: string) {
  const { data: email } = useQuery(GET_EMAIL, { variables: { id: emailId } });
  const [markPrivate] = useMutation(MARK_EMAIL_PRIVATE);
  const [unmarkPrivate] = useMutation(UNMARK_EMAIL_PRIVATE);

  const togglePrivacy = async () => {
    if (email?.isPrivate) {
      await unmarkPrivate({ variables: { emailId } });
    } else {
      await markPrivate({ variables: { emailId } });
    }
  };

  return {
    isPrivate: email?.isPrivate ?? false,
    canToggle: userRole === 'Partner',
    togglePrivacy,
  };
}
```

### 5. Thread Privacy Option

Context menu or additional button for thread-level privacy:

- "MarcheazÄƒ conversaÈ›ia ca privatÄƒ"
- Affects all emails in the thread

## Acceptance Criteria

- [x] Privacy toggle visible for partners only
- [x] Toggle persists via mutation
- [x] Private indicator shown on private emails in /communications
- [x] Case details Communications tab hides private emails
- [x] Non-partners don't see toggle
- [x] Thread privacy option available
- [x] Romanian text for all UI elements

## Files to Modify

- `apps/web/src/components/communication/ConversationHeader.tsx`
- `apps/web/src/components/case/tabs/CommunicationsTab.tsx`
- `apps/web/src/hooks/useEmailPrivacy.ts` (NEW)

## Estimated Scope

Medium - UI toggle + filtering + role checks.

---

## Session Log

### 2025-12-24 - Implementation Complete

**Changes Made:**

1. **Created `useEmailPrivacy` hook** (`apps/web/src/hooks/useEmailPrivacy.ts`)
   - GraphQL mutations for marking emails/threads private
   - Partner role validation
   - Romanian notification messages

2. **Updated `ConversationView.tsx`**
   - Added privacy toggle button in action bar (partners only)
   - Purple styling when thread is private
   - Lock/LockOpen icons for toggle state
   - Added privacy indicator banner at top of conversation when private

3. **Backend (OPS-191 - already complete)**
   - Privacy service with `buildPrivacyFilter` method
   - Case details filtering via `skipPrivacyFilter` parameter
   - GraphQL mutations for email/thread privacy

**Implementation Notes:**

- Privacy toggle is at thread level (marks all emails in thread)
- Filter automatically applied when querying emails in case context
- Private emails remain visible in /communications for the marking partner
