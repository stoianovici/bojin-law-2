# [OPS-007] AI email drafts ignore user language preference

| Field           | Value      |
| --------------- | ---------- |
| **Status**      | Fixing     |
| **Type**        | Bug        |
| **Priority**    | P2-Medium  |
| **Created**     | 2025-12-11 |
| **Sessions**    | 2          |
| **Last Active** | 2025-12-11 |

## Description

AI-generated email draft replies are not respecting the user's language preference. The system stores user language preferences (`language: 'ro' | 'en'` in `UserPreferences`), but this preference is NOT passed through the data flow when generating email drafts, resulting in drafts potentially being generated in the wrong language.

## Reproduction Steps

1. Ensure user has language preference set (default is `'ro'` for Romanian)
2. Navigate to /communications page
3. Select an email thread
4. Click to generate an AI draft response
5. Observe the generated draft may be in English instead of Romanian

## Root Cause

**Data flow gap - User language preferences are defined but never passed to AI service:**

1. **User preferences stored correctly:** `UserPreferences.language = 'ro' | 'en'` is defined in schema and defaults to `'ro'`
2. **AI Service expects preferences:** `email-drafting.service.ts` line 404 checks `params.userPreferences?.languagePreference` to set language
3. **Missing link - GraphQL resolver:** `email-drafting.resolvers.ts` does NOT retrieve user preferences from database
4. **Missing link - API route:** `email-drafting.routes.ts` does NOT include `userPreferences` in validation schema
5. **Missing link - Frontend:** `useEmailDraft.ts` mutation only accepts `emailId`, `tone`, `recipientType` - no language parameter

**Data flow:**

```
User (preferences.language = 'ro')
  ↓
GraphQL: generateEmailDraft(emailId, tone, recipientType)
  ↓ ❌ No user preferences fetched
Gateway Resolver → AI Service
  ↓ params.userPreferences = undefined
Prompt: "Use {language}" → defaults without preference
  ↓
Draft generated (may be wrong language)
```

## Fix Applied

**Simple Prompt Fix in AI Service**

- File: `services/ai-service/src/services/email-drafting.service.ts`
- Changed the system prompt rule #7 from:
  ```
  7. Use {language} language primarily
  ```
  To:
  ```
  7. IMPORTANT: Reply in the SAME LANGUAGE as the original email. If the original email is in Romanian, reply in Romanian. If it's in English, reply in English.
  ```

**Why This Works:**

- Claude already receives the full `originalEmail` content (subject + body)
- Claude is excellent at language detection - better than any regex-based approach
- This is the natural behavior humans follow when replying to emails
- No additional code needed in resolvers or route handlers

## Local Dev Environment

```bash
# Full dev environment:
pnpm dev

# Individual services:
cd services/gateway && pnpm dev     # GraphQL gateway on :4000
cd services/ai-service && pnpm dev  # AI service on :3002
cd apps/web && pnpm dev             # Next.js frontend on :3000
```

## Session Log

- [2025-12-11] Issue created. Initial triage identified complete data flow gap: user language preferences (`language: 'ro' | 'en'`) are defined in DB schema, expected by AI service, but never retrieved or passed through GraphQL resolver to AI service.
- [2025-12-11] Session 2 started. User clarified requirement: AI drafts should match the language of the original email/thread, not just user preferences.
- [2025-12-11] Session 2 - Initial approach: Implemented language detection in resolver. User suggested simpler solution: let Claude detect the language since it already receives the email content.
- [2025-12-11] Session 2 - Simplified fix: Changed AI prompt to instruct Claude to reply in the same language as the original email. Removed unnecessary language detection code.
- [2025-12-11] Session 2 - Ready for deployment and testing.

## Files Involved

**Modified:**

- `services/ai-service/src/services/email-drafting.service.ts` - **FIXED** - Updated prompt rule #7 to instruct Claude to match original email language
