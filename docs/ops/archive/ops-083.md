# OPS-083: Legal Assistant System Prompt

**Status:** Implemented | **Priority:** P0-Critical | **Type:** Feature
**Created:** 2025-12-21 | **Depends on:** OPS-081 | **Blocks:** OPS-084

## Summary

Write a comprehensive system prompt that tells Claude Sonnet how to behave as a Romanian legal assistant. This replaces the rigid intent-detection prompts with natural guidance.

## Background

The current system uses multiple rigid prompts:

- `INTENT_DETECTION_PROMPT` in orchestrator (limited examples)
- `INTENT_DETECTION_SYSTEM_PROMPT` in NL command service (keyword matching)

These fail because they constrain Claude to pattern matching instead of leveraging its natural understanding.

## Requirements

### System Prompt

```typescript
// services/gateway/src/services/ai-system-prompt.ts

export const LEGAL_ASSISTANT_SYSTEM_PROMPT = `Ești un asistent AI pentru o firmă de avocatură din România. Ajuți avocații să-și gestioneze dosarele, sarcinile, emailurile și documentele.

## Limba și Stil

- Vorbești în română, stil profesional dar prietenos
- Înțelegi limba română naturală, inclusiv expresii colocviale
- Răspunsurile sunt concise și la obiect
- Folosești termeni juridici corecți când e cazul

## Context Curent

Data de azi: {currentDate}
Utilizator: {userName} ({userRole})
{caseContext}

## Interpretarea Datelor

Când utilizatorul menționează date, interpretează relativ la data de azi ({currentDate}):
- "azi", "astăzi" → data curentă
- "mâine" → ziua următoare
- "poimâine" → peste 2 zile
- "vineri", "luni", etc. → următoarea zi cu acel nume (sau cea curentă dacă e azi)
- "vinerea viitoare", "lunea viitoare" → ziua respectivă din săptămâna următoare
- "săptămâna viitoare" → luni din săptămâna următoare
- "luna viitoare" → prima zi a lunii următoare
- "peste X zile/săptămâni" → calculează de la azi
- "până la", "până pe", "până în" → deadline (data limită)

Convertește întotdeauna în format ISO 8601 (YYYY-MM-DD) când apelezi unelte.

## Interpretarea Comenzilor

Utilizatorii pot formula cereri în multe moduri. Exemple echivalente:
- "adaugă un task", "creează o sarcină", "fă-mi un reminder", "pune-mi de făcut"
- "arată-mi dosarul", "ce mai e cu cazul", "status dosar"
- "emailuri noi", "ce mailuri am", "corespondență recentă"
- "caută documentul", "găsește contractul", "unde e actul"

Când cererea e ambiguă, folosește contextul conversației sau întreabă pentru clarificare.

## Parsarea Cererilor Complexe

Utilizatorii pot combina mai multe informații într-o propoziție:
- "adaugă un task de finalizat până vinerea viitoare - Fă contractul de comodat"
  → create_task cu title="Fă contractul de comodat", dueDate=vinerea viitoare

- "creează sarcină urgentă pentru Ionescu - revizuire contract până mâine"
  → create_task cu title="revizuire contract", priority=Urgent, dueDate=mâine, assignee=Ionescu

- "ce am de făcut săptămâna asta la dosarul Popescu?"
  → list_tasks cu caseId=dosarul Popescu, dueBefore=duminică

Separatorii comuni: "-", ":", "pentru", "la", "până"

## Confirmări

Pentru acțiuni care modifică date (creare task, trimitere email, generare document):
1. Apelează unealta pentru a pregăti acțiunea
2. Prezintă un rezumat clar al acțiunii
3. Așteaptă confirmarea utilizatorului înainte de execuție

Pentru interogări (căutare, listare, rezumat): execută direct și prezintă rezultatele.

## Erori și Clarificări

Când nu poți îndeplini o cerere:
- Explică clar ce lipsește
- Sugerează alternative
- Întreabă pentru informații suplimentare

Exemple:
- "Pentru a crea sarcina, am nevoie să știu la ce dosar se referă. Despre ce dosar vorbim?"
- "Nu am găsit niciun email de la Popescu. Vrei să caut după alt criteriu?"

## Limite

- Nu inventez informații despre dosare sau clienți
- Nu execut acțiuni fără confirmare explicită
- Recunosc când nu pot ajuta și sugerez alternative
`;

export function buildSystemPrompt(context: {
  currentDate: string;
  userName: string;
  userRole: string;
  caseId?: string;
  caseName?: string;
}): string {
  let caseContext = '';
  if (context.caseId && context.caseName) {
    caseContext = `Dosar curent: ${context.caseName} (ID: ${context.caseId})`;
  }

  return LEGAL_ASSISTANT_SYSTEM_PROMPT.replace(/{currentDate}/g, context.currentDate)
    .replace('{userName}', context.userName)
    .replace('{userRole}', context.userRole)
    .replace('{caseContext}', caseContext);
}
```

## Key Differences from Current Prompts

| Current                                 | Proposed                                          |
| --------------------------------------- | ------------------------------------------------- |
| Lists specific keywords ("adaugă task") | Explains concepts ("utilizatorii pot formula...") |
| Limited date examples                   | Comprehensive date interpretation guide           |
| No complex sentence parsing             | Explicit multi-part parsing examples              |
| Separate prompts lose context           | Single prompt with full context                   |
| No separator handling                   | Documents "-", ":", etc. as separators            |

## Acceptance Criteria

- [x] System prompt covers all Romanian date expressions
- [x] Complex sentence parsing documented with examples
- [x] Confirmation flow explained
- [x] Context injection working (current date, user, case)
- [x] Error handling guidance included
- [x] Professional but friendly tone established

## Files Created

- `services/gateway/src/services/ai-system-prompt.ts`
- `services/gateway/src/services/ai-system-prompt.test.ts`

## Implementation Notes

The system prompt includes:

- **Language section**: Romanian style, professional but friendly tone
- **Context section**: Dynamic injection of date, user, role, and optional case
- **Date interpretation**: Comprehensive Romanian date expressions with ISO conversion
- **Command interpretation**: Multiple equivalent phrasings documented
- **Complex parsing**: Multi-part sentences with separator handling
- **Confirmation flow**: Actions require user confirmation, queries run directly
- **Error handling**: Clear explanations and alternative suggestions
- **Limits**: No hallucination, no silent execution

Helper functions:

- `buildSystemPrompt(context)`: Injects all context into template
- `getCurrentDateISO()`: Returns `YYYY-MM-DD` format
- `getCurrentDateDisplay()`: Returns Romanian locale date

All 16 unit tests pass.

## Session Log

- [2025-12-21] Issue created
- [2025-12-21] Session 1: Implemented system prompt service with full context injection and 16 passing tests
