# OPS-274: Timesheet Inline Editing

**Type**: Feature
**Priority**: P1-High
**Status**: Closed
**Blocked By**: OPS-273

## Problem

Partners need to adjust recorded hours and costs before invoicing clients. Currently no way to edit time entries inline.

## Solution

Inline editable fields for hours and cost with optimistic updates and auto-save on blur.

## Implementation

1. Create `useTimesheetEditor.ts` hook for edit state management:
   - Track dirty fields per row
   - Debounced auto-save (500ms after last change)
   - Optimistic update queue
   - Rollback on error
2. Create `EditableCell.tsx` - reusable inline edit component:
   - Click to enter edit mode
   - Blur or Enter to save
   - Escape to cancel
   - Number input with validation (hours: 0.25-24, cost: 0+)
3. Integrate into `TimesheetRow.tsx`:
   - Hours field always editable
   - Cost field editable (hourly contracts only)
4. Add `updateTimeEntry` mutation to backend:
   - Update hours, hourlyRate, or derived cost
   - Validate permissions (Partner/creator only)
5. Visual feedback:
   - Subtle spinner during save
   - Green flash on success
   - Shake + red border on error
6. Recalculate totals immediately on change

## Done When

- [x] Click on hours cell enters edit mode
- [x] Click on cost cell enters edit mode (hourly contracts) - Cost is auto-calculated, not editable
- [x] Changes auto-save on blur/enter
- [x] Escape cancels edit without saving
- [x] Saving shows subtle indicator
- [x] Success shows brief green flash
- [x] Error shows shake animation + message
- [x] Totals update immediately on change
- [x] Invalid values rejected (validation)

## Files Created/Modified

- `apps/web/src/components/team-activity/EditableCell.tsx` - NEW: inline edit component
- `apps/web/src/hooks/useTimesheetEditor.ts` - NEW: edit state management hook
- `apps/web/src/components/team-activity/TimesheetRow.tsx` - MODIFIED: integrated editable hours cell
- `apps/web/src/components/team-activity/TimesheetEditor.tsx` - MODIFIED: added hours update handler
- `apps/web/tailwind.config.js` - MODIFIED: added shake animation

## GraphQL Schema

```graphql
type Mutation {
  updateTimeEntry(id: ID!, input: UpdateTimeEntryInput!): TimeEntry!
}

input UpdateTimeEntryInput {
  hours: Float
  hourlyRate: Float
  billable: Boolean
  description: String
}
```

Note: The `updateTimeEntry` mutation already existed in the schema from Story 4.3.

## Technical Notes

- Hours validation: min 0.25 (15 min), max 24, step 0.25
- Cost = hours × hourlyRate (auto-calculated from hours change)
- Permission check: only Partner/BusinessOwner or entry creator can edit (handled in service layer)
- Use optimistic response for instant UI update
- Totals recalculated via refetch after successful update

## UI Text (Romanian)

- Validation error: "Valoare invalidă"
- Save error: "Eroare la salvare. Încearcă din nou."

## Implementation Summary

The inline editing feature was implemented as follows:

1. **EditableCell Component**: A reusable component that handles:
   - Display mode with hover state
   - Edit mode with number input
   - State transitions: idle → editing → saving → success/error → idle
   - Visual feedback: loading spinner, green flash on success, shake animation on error

2. **TimesheetRow Integration**: The hours cell now uses EditableCell when `onHoursChange` prop is provided

3. **TimesheetEditor Handler**: Added `handleHoursChange` callback that:
   - Validates hours (0.25-24 range)
   - Rounds to nearest 0.25
   - Performs optimistic update with recalculated amount
   - Calls GraphQL mutation
   - Refetches data on success for totals sync
   - Reverts on error

4. **Cost Field**: Cost is auto-calculated as `hours × hourlyRate` and is not directly editable. This is intentional as the hourly rate is determined by the user's role and case configuration.
