# OPS-025: Email and Document Permanent Deletion

**Status:** Resolved
**Priority:** P1-High
**Type:** Feature
**Created:** 2025-12-15
**Resolved:** 2025-12-15

---

## Problem Statement

Users needed the ability to permanently delete emails and documents from the database to "start clean" with imports. The existing `bulkClearCaseData` mutation only **unlinked** emails (set `caseId` to null) but didn't actually delete them from the database.

### Root Cause Analysis

Investigation revealed:

- **Documents**: Had working permanent delete (`permanentlyDeleteDocument`) - Partners only
- **Emails**: NO permanent delete existed - only "ignore" which kept records in DB
- `bulkClearCaseData`: Only unlinked emails, didn't delete them

---

## Solution Implemented

### Backend (Gateway)

**File:** `services/gateway/src/graphql/resolvers/email.resolvers.ts`

1. **`permanentlyDeleteEmail(emailId)`** - Delete single email + attachments
   - Partners/BusinessOwners only
   - Deletes EmailAttachments first, then Email record
   - Returns `{ success, attachmentsDeleted }`

2. **`bulkDeleteCaseEmails(caseId)`** - Delete all emails for a case
   - Partners/BusinessOwners only
   - Returns `{ emailsDeleted, attachmentsDeleted, success }`

3. **Updated `bulkClearCaseData(caseId)`** - Now DELETES emails instead of unlinking
   - Changed from `email.updateMany({ caseId: null })` to `email.deleteMany()`
   - Returns `{ emailsDeleted, caseDocumentsDeleted, documentsDeleted, attachmentReferencesCleared, success }`

**File:** `services/gateway/src/graphql/schema/email.graphql`

- Added `DeleteEmailResult` type
- Added `BulkDeleteEmailsResult` type
- Updated `BulkClearCaseDataResult` to use `emailsDeleted` instead of `emailsCleared`

### Frontend (Web)

**File:** `apps/web/src/hooks/useEmailSync.ts`

- Added `useDeleteEmail()` hook
- Added `useBulkDeleteCaseEmails()` hook

**File:** `apps/web/src/components/email/EmailThreadView.tsx`

- Added red "Șterge" (Delete) button in thread header
- Confirmation dialog in Romanian
- Restricted to Partner/BusinessOwner roles

---

## Commits

| Commit    | Description                                                    |
| --------- | -------------------------------------------------------------- |
| `41fb00b` | feat(gateway): add email permanent delete mutations            |
| `5afe394` | feat(web): add email delete button for Partners/BusinessOwners |

---

## Usage

### Clear All Data for a Case (GraphQL)

```graphql
mutation {
  bulkClearCaseData(caseId: "YOUR_CASE_ID") {
    emailsDeleted
    caseDocumentsDeleted
    documentsDeleted
    attachmentReferencesCleared
    success
  }
}
```

### Delete Single Email Thread (UI)

1. Open email thread view
2. Click red "Șterge" button (visible to Partners only)
3. Confirm in dialog

---

## Testing Notes

- Authorization: Only Partner and BusinessOwner roles can delete
- Cascade: EmailAttachments are deleted with their parent Email
- No migration required - only added mutations, no schema changes

---

## Related Issues

- OPS-024: Email Import - Attachments Not Importing (cleanup needed after fixing)
