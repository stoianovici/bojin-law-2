# OPS-200: Debug SplitAssignmentButton Visibility

**Status:** Resolved | **Priority:** P1-High | **Type:** Bug | **Created:** 2025-12-24

## Overview

The SplitAssignmentButton (80/20 split for NECLAR email assignment) is not visible. The GraphQL query fetches `suggestedCases` correctly, but the data isn't reaching the component.

## Dependencies

- **Depends on:** None
- **Blocks:** OPS-204 (NECLAR Action Bar)
- **Parallel with:** OPS-201, OPS-202

## Context

Part of Communications Action Bar Redesign epic. The SplitAssignmentButton component exists and works in Storybook, but doesn't render in the actual NECLAR email view.

## Requirements

### 1. Trace Data Flow

Add console logging to trace:

1. `useMyEmailsByCase` → check `uncertain` array has `suggestedCases`
2. `page.tsx` → check `handleSelectUncertainEmail` sets `neclarEmailData`
3. `ConversationView` → check `neclarData` prop received, `neclarSuggestions` computed

### 2. Verify Props

- `neclarMode` prop is `true` when viewing uncertain emails
- `neclarData` contains `suggestedCases` array
- `primaryCase` exists before rendering SplitAssignmentButton

### 3. Fix Root Cause

Based on investigation, fix the data flow issue.

## Acceptance Criteria

- [ ] Root cause identified and documented
- [ ] SplitAssignmentButton renders with confidence colors for NECLAR emails
- [ ] 80/20 split visible with primary/secondary case suggestions
- [ ] Dropdown shows all suggestions when clicking secondary

## Files to Modify

- `apps/web/src/app/communications/page.tsx`
- `apps/web/src/components/communication/ConversationView.tsx`
- `apps/web/src/hooks/useMyEmailsByCase.ts`

## Estimated Scope

Small - Debugging and fixing data flow.

---

## Session Log

### Session 1 - 2024-12-24

**Root Cause Identified:**

The uncertain email data didn't include `conversationId`, causing thread loading to fail:

1. `handleSelectUncertainEmail` set `viewState.threadId = uncertainEmail.id` (email ID)
2. `useEmailThread(viewState.threadId)` tried to fetch by conversation ID but received email ID
3. Thread didn't load → `selectedThread` was null → `ConversationView` never rendered
4. Therefore, `SplitAssignmentButton` never appeared

**Fix Applied:**

1. **GraphQL Schema** (`email.graphql`): Added `conversationId: String` to `UncertainEmail` type
2. **Resolver** (`email.resolvers.ts`): Added `conversationId` to select and return
3. **Frontend Hook** (`useMyEmailsByCase.ts`): Added `conversationId` to query and type
4. **Page** (`page.tsx`): Updated `handleSelectUncertainEmail` to use `conversationId` for thread ID

**Files Modified:**

- `services/gateway/src/graphql/schema/email.graphql`
- `services/gateway/src/graphql/resolvers/email.resolvers.ts`
- `apps/web/src/hooks/useMyEmailsByCase.ts`
- `apps/web/src/app/communications/page.tsx`

**Verification:**

- Type-check passes for all packages
