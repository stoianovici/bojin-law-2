# OPS-160: Implement documents-template-usage

| Field        | Value                                      |
| ------------ | ------------------------------------------ |
| **Status**   | Complete                                   |
| **Type**     | Feature                                    |
| **Priority** | P2-Medium                                  |
| **Created**  | 2025-12-24                                 |
| **Epic**     | Reports Data Accuracy (OPS-156 to OPS-161) |

## Problem

The `documents-template-usage` report (Utilizare Șabloane) currently routes to generic `queryDocuments()` which groups by document status. This is wrong - "Utilizare Șabloane" should show **which document templates are used most frequently**.

## Investigation Needed

Check if template usage is tracked in the database:

1. `template_library` table - stores available templates
2. `TaskTemplateUsage` - tracks task template usage
3. Document metadata - may include `templateId` or similar field

If no template tracking exists, may need to:

- Track via document metadata field
- Return placeholder message indicating feature needs data

## Solution

1. Add `getTemplateUsage()` method that:
   - Queries template usage records (TBD based on investigation)
   - Groups by template name
   - Returns usage counts sorted by frequency
2. Route `documents-template-usage` to this method

## Example Output

```typescript
{
  data: [
    { label: 'Contract de Muncă', value: 45, color: '#3b82f6' },
    { label: 'Procură Generală', value: 32, color: '#10b981' },
    { label: 'Cerere de Chemare în Judecată', value: 28, color: '#f59e0b' },
    { label: 'Notificare', value: 15, color: '#ef4444' },
  ],
  summary: {
    totalValue: 120,
    averageValue: 30,
    trendDirection: 'up'
  }
}
```

## Files

- `packages/database/prisma/schema.prisma` (investigate template tracking)
- `services/gateway/src/services/report-data.service.ts`
- `services/gateway/src/graphql/resolvers/reports.resolvers.ts`

## Done When

- [x] Template usage data source identified
- [x] Report shows template names with usage counts
- [x] Bar chart displays most-used templates
- [x] Graceful handling if no template data exists

## Implementation Summary

**Template Types Tracked:**

1. **CommunicationTemplate** - Uses `usageCount` field directly
2. **TaskTemplate** - Counts via `TaskTemplateUsage` join table
3. **MapaTemplate** - Counts Mapa instances created from each template

**Changes Made:**

1. Added `getTemplateUsage()` method to `ReportDataService` (`services/gateway/src/services/report-data.service.ts`)
2. Routed `documents-template-usage` to the new method in resolver (`services/gateway/src/graphql/resolvers/reports.resolvers.ts`)
3. Updated description and `requiresDateRange: false` in both gateway and web template files

**Graceful Handling:**
When no templates have been used yet, displays "Nu există date" with a helpful message in metadata.
