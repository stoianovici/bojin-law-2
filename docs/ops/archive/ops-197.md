# OPS-197: Document Rule - Assigned Emails Only

**Status:** Resolved | **Priority:** P2-Medium | **Type:** Feature | **Created:** 2025-12-24

## Overview

Prevent saving email attachments as case documents until the email is assigned to a case.

## Dependencies

- **Depends on:** OPS-196 (inline assignment working)
- **Blocks:** None
- **Parallel with:** OPS-198

## Context

Part of Communications UX Overhaul epic. Attachments from unassigned (NECLAR) emails should not become case documents because there's no case to attach them to. Users must first assign the email to a case.

## Requirements

### 1. Backend Validation

Update document save logic to check email assignment:

```typescript
async saveEmailAttachmentAsDocument(
  attachmentId: string,
  userContext: UserContext
): Promise<Document> {
  const attachment = await this.getAttachment(attachmentId);
  const email = await this.getEmail(attachment.emailId);

  // Block if email not assigned to a case
  if (!email.caseId || email.classificationState === 'Uncertain') {
    throw new Error('EMAIL_NOT_ASSIGNED');
  }

  // Proceed with saving
  return this.createDocumentFromAttachment(attachment, email.caseId);
}
```

### 2. Frontend Blocking

In `AttachmentPreviewPanel.tsx`, disable "Save to Documents" for NECLAR emails:

```tsx
const canSaveToDocuments = email.caseId && email.classificationState !== 'Uncertain';

<Button
  disabled={!canSaveToDocuments}
  title={
    !canSaveToDocuments
      ? 'Atribuiți emailul unui dosar pentru a salva atașamentele'
      : 'Salvează în documente'
  }
>
  Salvează în documente
</Button>;
```

### 3. Error Message

If somehow the mutation is called anyway:

- Romanian: "Emailul trebuie atribuit unui dosar înainte de a salva atașamentele."
- Toast notification with error styling

### 4. After Assignment

Once email is assigned (via OPS-196 flow), the "Save to Documents" action should automatically become available.

## Acceptance Criteria

- [x] Backend rejects attachment save for unassigned emails
- [x] Frontend disables button for NECLAR emails
- [x] Tooltip explains why button is disabled
- [x] Clear error message if somehow attempted
- [x] Works correctly after email is assigned
- [x] Romanian text for all messages

## Files Modified

- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - Added validation in `saveEmailAttachmentAsDocument` resolver
- `apps/web/src/components/communication/AttachmentPreviewPanel.tsx` - Added `isEmailAssigned` prop, disabled state styling, tooltip
- `apps/web/src/app/communications/page.tsx` - Pass `isEmailAssigned` prop based on view mode

## Estimated Scope

Small - Validation logic + UI disable state.

---

## Session Log

### 2025-12-24 - Implementation Complete

**Changes Made:**

1. **Backend Validation** (email.resolvers.ts:2569-2578)
   - Added check for `email.classificationState === 'Uncertain'`
   - Throws GraphQL error with code `EMAIL_NOT_ASSIGNED` and Romanian message

2. **Frontend Component** (AttachmentPreviewPanel.tsx)
   - Added `isEmailAssigned` prop to interface
   - Created `canSaveToDocuments` computed value combining caseId and assignment status
   - Created `disabledTooltip` message for disabled state
   - Updated "Save" and "Edit" buttons with:
     - Disabled state when email not assigned
     - Gray styling for disabled buttons
     - Tooltip explaining why action is blocked
   - Enhanced error handling to detect `EMAIL_NOT_ASSIGNED` error code

3. **Communications Page** (page.tsx:695)
   - Added `isEmailAssigned` prop based on:
     - Not in `uncertain-email` mode (NECLAR queue)
     - AND has a valid `caseId`

**Result:**

- NECLAR emails show disabled save/promote buttons with tooltip: "Atribuiți emailul unui dosar pentru a salva atașamentele"
- After email is assigned to a case, buttons become active
- Backend provides fallback validation with appropriate error message
