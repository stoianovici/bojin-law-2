# OPS-063: AI Conversation Data Model

**Status:** Implemented | **Priority:** P0-Critical | **Type:** Feature
**Created:** 2025-12-20 | **Blocks:** OPS-064, OPS-065, OPS-066, OPS-067, OPS-068, OPS-069, OPS-070, OPS-071

## Summary

Create the database schema for storing multi-turn AI assistant conversations, including messages, context, and action confirmations.

## Background

The current SuggestionWidget is display-only. To enable an interactive AI assistant, we need:

1. Conversation sessions that persist across page navigation
2. Message history for multi-turn context
3. Action state tracking (proposed → confirmed → executed)
4. Firm isolation for multi-tenant security

## Requirements

### Prisma Schema

```prisma
// ============================================================================
// AI Assistant Conversation Models
// ============================================================================

enum ConversationStatus {
  Active
  AwaitingConfirmation
  Completed
  Expired
}

enum AIMessageRole {
  User
  Assistant
  System
}

enum AIActionStatus {
  Proposed
  Confirmed
  Executed
  Rejected
  Failed
}

model AIConversation {
  id        String   @id @default(uuid()) @db.Uuid
  firmId    String   @map("firm_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  caseId    String?  @map("case_id") @db.Uuid
  status    ConversationStatus @default(Active)
  context   Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  closedAt  DateTime? @map("closed_at")

  // Relations
  firm     Firm  @relation(fields: [firmId], references: [id], onDelete: Cascade)
  user     User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  case     Case? @relation(fields: [caseId], references: [id], onDelete: SetNull)
  messages AIMessage[]

  @@index([firmId])
  @@index([userId, status])
  @@index([caseId])
  @@map("ai_conversations")
}

model AIMessage {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid
  role           AIMessageRole
  content        String   @db.Text
  intent         String?  @db.VarChar(100)
  confidence     Float?
  actionType     String?  @map("action_type") @db.VarChar(100)
  actionPayload  Json?    @map("action_payload")
  actionStatus   AIActionStatus? @map("action_status")
  tokensUsed     Int?     @map("tokens_used")
  modelUsed      String?  @map("model_used") @db.VarChar(50)
  latencyMs      Int?     @map("latency_ms")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  conversation AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("ai_messages")
}
```

### Model Relations

Add to existing models:

```prisma
// In User model:
aiConversations AIConversation[]

// In Firm model:
aiConversations AIConversation[]

// In Case model:
aiConversations AIConversation[]
```

## Acceptance Criteria

- [x] Prisma schema includes AIConversation and AIMessage models
- [x] Enums defined: ConversationStatus, AIMessageRole, AIActionStatus
- [x] Relations to User, Firm, Case with proper cascade rules
- [x] Indexes for efficient querying
- [x] Migration file created and tested locally
- [x] `pnpm db:generate` succeeds
- [ ] Local database updated with new tables (pending deploy)

## Files to Modify

- `packages/database/prisma/schema.prisma`

## Files to Create

- `packages/database/prisma/migrations/YYYYMMDDHHMMSS_add_ai_conversations/migration.sql`

## Testing

- Verify tables created in local database
- Verify indexes exist
- Test foreign key constraints

## Session Log

- [2025-12-20T14:00] Session 1 started. Status: Open
- [2025-12-20T14:05] Added enums: ConversationStatus, AIMessageRole, AIActionStatus
- [2025-12-20T14:10] Added AIConversation and AIMessage models to schema
- [2025-12-20T14:12] Added relations to User, Firm, Case models
- [2025-12-20T14:15] Generated Prisma client successfully
- [2025-12-20T14:18] Created migration file: 20251220140000_add_ai_conversations
- [2025-12-20T14:20] TypeScript compilation verified: gateway ✓, web ✓
- [2025-12-20T14:25] Preflight checks passed: 6/6 ✓ (2 non-blocking warnings)

#### Local Verification Status

| Step           | Status     | Notes                                |
| -------------- | ---------- | ------------------------------------ |
| Prod data test | ⬜ Pending | Awaiting migration on local DB       |
| Preflight      | ✅ Passed  | 6 passed, 2 warnings (non-blocking)  |
| Docker test    | ✅ Passed  | Web + Gateway Docker builds verified |

**Verified**: Partial (code verified, DB migration pending)
