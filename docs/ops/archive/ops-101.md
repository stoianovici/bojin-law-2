# OPS-101: Mapa GraphQL Schema & Resolvers

**Type:** Feature
**Priority:** P1-High
**Status:** Fixed
**Created:** 2024-12-22
**Completed:** 2024-12-22

## Summary

Define the GraphQL schema and resolvers for Mapa operations, enabling frontend access to mapa functionality.

## Dependencies

- **Requires:** OPS-099 (Mapa Data Model) ✅
- **Parallel with:** OPS-100 (Mapa Service Layer) ✅

## Implementation Summary

### Files Created

1. **`services/gateway/src/graphql/schema/mapa.graphql`**
   - Full GraphQL schema with types: `Mapa`, `MapaSlot`, `MapaCompletionStatus`, `MapaTemplate`, `SlotDefinition`
   - Input types for all CRUD operations
   - Queries: `mapa`, `caseMape`, `mapaTemplates`, `mapaTemplate`
   - Mutations for mapa CRUD, slot management, document assignment, and templates

2. **`services/gateway/src/graphql/resolvers/mapa.resolvers.ts`**
   - Query resolvers for fetching mape and templates
   - Mutation resolvers for all operations
   - Type resolvers for nested relations (`case`, `template`, `slots`, `completionStatus`, `createdBy`)

### Files Modified

1. **`services/gateway/src/graphql/schema/index.ts`**
   - Added `mapaSchema` to schema loader

2. **`services/gateway/src/graphql/server.ts`**
   - Imported `mapaResolvers`
   - Added Query, Mutation, and Type resolvers to merged resolvers

## GraphQL Schema

```graphql
# Types
type Mapa
type MapaSlot
type MapaCompletionStatus
type MapaTemplate
type SlotDefinition

# Queries
mapa(id: UUID!): Mapa
caseMape(caseId: UUID!): [Mapa!]!
mapaTemplates: [MapaTemplate!]!
mapaTemplate(id: UUID!): MapaTemplate

# Mutations
createMapa(input: CreateMapaInput!): Mapa!
createMapaFromTemplate(templateId: UUID!, caseId: UUID!): Mapa!
updateMapa(id: UUID!, input: UpdateMapaInput!): Mapa!
deleteMapa(id: UUID!): Boolean!
addMapaSlot(mapaId: UUID!, input: CreateSlotInput!): MapaSlot!
addMapaSlots(mapaId: UUID!, inputs: [CreateSlotInput!]!): [MapaSlot!]!
updateMapaSlot(slotId: UUID!, input: UpdateSlotInput!): MapaSlot!
deleteMapaSlot(slotId: UUID!): Boolean!
reorderMapaSlots(input: ReorderSlotsInput!): [MapaSlot!]!
assignDocumentToSlot(slotId: UUID!, caseDocumentId: UUID!): MapaSlot!
unassignDocumentFromSlot(slotId: UUID!): MapaSlot!
bulkAssignDocuments(assignments: [AssignDocumentInput!]!): [MapaSlot!]!
createMapaTemplate(input: CreateTemplateInput!): MapaTemplate!
updateMapaTemplate(id: UUID!, input: UpdateTemplateInput!): MapaTemplate!
deleteMapaTemplate(id: UUID!): Boolean!
```

## Acceptance Criteria

- [x] GraphQL schema defined in `mapa.graphql`
- [x] All resolvers implemented
- [x] Type resolvers for nested relations
- [x] Authorization checks in resolvers (via service layer)
- [x] Schema registered in gateway config
- [x] TypeScript compiles without mapa-related errors

## Session Log

- [2024-12-22] Session 1: Implemented GraphQL schema and resolvers
  - Found OPS-100 service layer already implemented
  - Created `mapa.graphql` schema with full type definitions
  - Created `mapa.resolvers.ts` with Query, Mutation, and Type resolvers
  - Registered schema in `schema/index.ts`
  - Registered resolvers in `server.ts`
  - TypeScript check passed (no mapa-related errors)

## Local Verification Status

| Step           | Status     | Date | Notes                                |
| -------------- | ---------- | ---- | ------------------------------------ |
| Prod data test | ⬜ Pending |      | GraphQL only, needs UI to fully test |
| Preflight      | ⬜ Pending |      | Need to run pnpm preflight           |
| Docker test    | ⬜ Pending |      | GraphQL only, needs UI to fully test |

**Verified**: No (GraphQL layer complete, verification deferred to OPS-102 UI)
