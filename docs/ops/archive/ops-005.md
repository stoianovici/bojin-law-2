# [OPS-005] AI extraction and drafting not working in communications

| Field           | Value       |
| --------------- | ----------- |
| **Status**      | Fixing      |
| **Type**        | Bug         |
| **Priority**    | P0-Critical |
| **Created**     | 2025-12-10  |
| **Sessions**    | 2           |
| **Last Active** | 2025-12-10  |

## Description

In the /communications page, the AI extraction and AI drafting features are not working. Users cannot extract deadlines, commitments, action items, or questions from emails, nor can they generate AI-drafted responses.

## Reproduction Steps

1. Navigate to /communications page
2. Select an email thread
3. Observe that the "Extracted Items" sidebar shows no items or errors
4. Observe that the "AI Draft Response" panel shows placeholder text "Funcționalitatea de draft AI va fi implementată în versiunile viitoare."

## Root Cause

**AI EXTRACTION ISSUES:**

1. **ExtractedItemsSidebar** uses local state-based mock data instead of GraphQL API
2. **ExtractedItemsPanel** (GraphQL-powered) exists but is NOT integrated into the communications page
3. Background worker (`communication-intelligence.worker.ts`) runs on 60-second intervals but may not be running in production
4. No "analysis in progress" indicator - users don't know if extraction is happening

**AI DRAFTING ISSUES:**

1. **AIDraftResponsePanel is a complete STUB** - only shows placeholder text
2. The component has TODO comments: "Replace with actual AI draft service call"
3. Tone selector UI works but doesn't trigger any actual GraphQL mutations
4. "Folosește draft" button has no functionality
5. Backend resolvers exist (`email-drafting.resolvers.ts`) but are never called by frontend

**INFRASTRUCTURE:**

1. AI Service URL hardcoded to `localhost:3002` - may not be configured in production
2. No error handling for unavailable AI service

## Fix Applied

**Fix 1: Replace ExtractedItemsSidebar with ExtractedItemsPanel**

- File: `apps/web/src/app/communications/page.tsx`
- Replaced mock `ExtractedItemsSidebar` component with working `ExtractedItemsPanel`
- `ExtractedItemsPanel` uses GraphQL hooks (`usePendingExtractedItems`) to fetch real extracted items from database
- Panel now receives `caseId` from selected thread for filtering
- Shows placeholder when no thread/case selected

**Fix 2: Implement AIDraftResponsePanel with GraphQL**

- File: `apps/web/src/components/communication/AIDraftResponsePanel.tsx`
- Replaced stub with full implementation using `useGenerateDraft` hook
- Added tone selection (Formal, Professional, Brief) with auto-regenerate
- Added "Generează draft" button that calls `generateEmailDraft` GraphQL mutation
- Added "Folosește draft" to open compose with generated content
- Added "Copiază" button to copy draft to clipboard
- Added "Regenerează" button to regenerate draft
- Shows confidence indicator from AI response
- Handles loading and error states properly

## Local Dev Environment

To run locally:

```bash
# Terminal 1: Start gateway (GraphQL API)
cd services/gateway && npm run dev

# Terminal 2: Start AI service (extraction/drafting)
cd services/ai-service && npm run dev

# Terminal 3: Start web app
cd apps/web && npm run dev

# Or use turbo from root:
npm run dev
```

Environment files:

- `.env` - Root environment
- `services/gateway/.env` - Gateway config (DATABASE_URL, REDIS_URL, AI_SERVICE_URL)
- `services/ai-service/.env` - AI service config (ANTHROPIC_API_KEY)
- `apps/web/.env.local` - Next.js frontend config

## Session Log

- [2025-12-10] Issue created. Initial triage found two main problems:
  1. **Extraction**: ExtractedItemsSidebar uses mock data; ExtractedItemsPanel (GraphQL) exists but not integrated
  2. **Drafting**: AIDraftResponsePanel is a stub with TODO placeholder - backend exists but frontend never calls it
- [2025-12-10] Session 2 started. Continuing from: New. Beginning implementation of fixes.
- [2025-12-10] Session 2 - Fix 1: Replaced `ExtractedItemsSidebar` with `ExtractedItemsPanel` in communications page. The panel now fetches real extracted items via GraphQL.
- [2025-12-10] Session 2 - Fix 2: Rewrote `AIDraftResponsePanel` to use `useGenerateDraft` hook. Full functionality: tone selection, generate, copy, use draft, regenerate.
- [2025-12-10] Session 2 - Build verified successful. Ready for deployment and production testing.

## Files Involved

**Frontend Components:**

- `apps/web/src/app/communications/page.tsx` - **FIXED** - Now uses ExtractedItemsPanel, passes caseId from selected thread
- `apps/web/src/components/communication/AIDraftResponsePanel.tsx` - **FIXED** - Full GraphQL implementation with useGenerateDraft
- `apps/web/src/components/communication/ExtractedItemsSidebar.tsx` - Local state mock data (no longer used)
- `apps/web/src/components/communication/ExtractedItemsPanel.tsx` - GraphQL-powered panel (now integrated)

**Hooks:**

- `apps/web/src/hooks/useExtractedItems.ts` - GraphQL hooks for extraction (working)

**Backend Resolvers:**

- `services/gateway/src/graphql/resolvers/communication-intelligence.resolvers.ts` - Extraction queries/mutations
- `services/gateway/src/graphql/resolvers/email-drafting.resolvers.ts` - Draft generation/refinement

**Backend Services:**

- `services/ai-service/src/services/communication-intelligence.service.ts` - Claude AI extraction
- `services/gateway/src/workers/communication-intelligence.worker.ts` - Background extraction worker
