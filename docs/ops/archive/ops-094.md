# OPS-094: AI Assistant Wrong Date and Time for Calendar Events

| Field           | Value            |
| --------------- | ---------------- |
| **Status**      | Fixed            |
| **Type**        | Bug              |
| **Priority**    | P1-High          |
| **Created**     | 2025-12-22       |
| **Sessions**    | 1                |
| **Last Active** | 2025-12-22 11:15 |

## Description

When creating a calendar event via the AI assistant, both date and time are incorrect:

- User requested: "voi avea o întâlnire cu TT Solaria joi la 10" (meeting Thursday at 10)
- AI confirmed: "joi (26 decembrie 2025) la 10:00"
- Actual result: Event created for **Friday** Dec 26 at **01:00**

Two distinct bugs:

1. **Wrong date**: December 26, 2025 is a Friday, not Thursday. The next Thursday from Dec 22 is December 25.
2. **Wrong time**: 10:00 became 01:00

## Symptom Category

**Category C**: Fails everywhere - Core logic bugs in date interpretation and timezone handling

## Investigation Summary

| Hypothesis                    | Verdict | Key Finding                                            |
| ----------------------------- | ------- | ------------------------------------------------------ |
| Claude date calculation error | ❌      | System prompt lacks weekday name for anchoring         |
| Timezone handling bug         | ❌      | Hardcoded +02:00 offset, DST not considered            |
| No server-side validation     | ⚠️      | No validation that returned date matches requested day |

## Root Causes

### Root Cause 1: Missing Weekday in System Prompt

**File**: `services/gateway/src/services/ai-system-prompt.ts:160-162`

```typescript
export function getCurrentDateISO(): string {
  return new Date().toISOString().split('T')[0];
}
```

The current date is passed to Claude as just `"2025-12-22"` without the weekday name. Claude must calculate the weekday from the ISO date, and made an error (said Dec 26 is Thursday when it's Friday).

**The system prompt** at line 36:

```
Data de azi: {currentDate}
```

Should be:

```
Data de azi: {currentDate} ({weekday})
```

### Root Cause 2: Hardcoded Timezone Offset

**File**: `services/gateway/src/services/ai-assistant.service.ts:1736-1741`

```typescript
if (startTime.includes('T') && !startTime.includes('+') && !startTime.endsWith('Z')) {
  // ISO format without timezone - treat as local Romania time (UTC+2/+3)
  // Append Romania timezone offset
  startDateTime = new Date(startTime + '+02:00'); // ❌ Hardcoded!
}
```

This appends a hardcoded `+02:00` offset. While Romania is currently in winter time (UTC+2), the comment acknowledges it should be `+02:00` OR `+03:00` depending on DST.

However, the real issue is likely that Claude is generating an incorrect time string in the first place, or there's a double-conversion happening.

### Root Cause 3: No Day-of-Week Validation

The backend blindly accepts whatever date Claude returns without validating that "joi" (Thursday) actually results in a Thursday date.

**File**: `services/gateway/src/services/ai-assistant.service.ts:867` (for tasks)

```typescript
dueDate: input.dueDate ? new Date(input.dueDate as string) : new Date(),
```

**File**: `services/gateway/src/services/ai-assistant.service.ts:1743` (for events)

```typescript
startDateTime = new Date(startTime);
```

No validation that the requested day-of-week matches the returned date.

## Recommended Fixes

### Fix 1: Include Weekday in System Prompt

```typescript
export function getCurrentDateISO(): string {
  const now = new Date();
  const weekdays = ['duminică', 'luni', 'marți', 'miercuri', 'joi', 'vineri', 'sâmbătă'];
  const isoDate = now.toISOString().split('T')[0];
  const weekday = weekdays[now.getDay()];
  return `${isoDate} (${weekday})`; // "2025-12-22 (duminică)"
}
```

Update system prompt to explicitly state the weekday so Claude can anchor date calculations.

### Fix 2: Use Proper Timezone Handling

Replace hardcoded offset with proper timezone library:

```typescript
// Option A: Use Intl.DateTimeFormat
const formatter = new Intl.DateTimeFormat('en-CA', {
  timeZone: 'Europe/Bucharest',
  year: 'numeric',
  month: '2-digit',
  day: '2-digit',
  hour: '2-digit',
  minute: '2-digit',
  hour12: false,
});

// Option B: Parse with explicit timezone awareness
// The naive string "2025-12-26T10:00:00" should be interpreted as Bucharest time
// Create date assuming the input is already in Bucharest time
```

### Fix 3: Add Day-of-Week Validation (Optional Enhancement)

If the user's message contains a day name like "joi", validate that the returned date is actually a Thursday:

```typescript
function validateDayOfWeek(requestedDay: string, date: Date): boolean {
  const dayMap: Record<string, number> = {
    duminică: 0,
    luni: 1,
    marți: 2,
    miercuri: 3,
    joi: 4,
    vineri: 5,
    sâmbătă: 6,
  };
  const expectedDay = dayMap[requestedDay.toLowerCase()];
  return expectedDay === undefined || date.getDay() === expectedDay;
}
```

## Environment Strategy

| Mode                   | Command                        | Use When                     |
| ---------------------- | ------------------------------ | ---------------------------- |
| Local dev (default)    | `pnpm dev`                     | Feature development          |
| Production data        | `source .env.prod && pnpm dev` | Bug investigation, real data |
| Production-like Docker | `pnpm preview`                 | Pre-deploy verification      |
| Full parity check      | `pnpm preflight:full`          | Before any deployment        |

**Recommended for this issue**: Local dev (logic bug, doesn't need prod data)

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

> ⚠️ Issue cannot be closed until all three steps are ✅

## Session Log

- [2025-12-22 11:15] Issue created via /ops-investigate. Category: C. Root causes: (1) Missing weekday in system prompt (2) Hardcoded timezone offset (3) No day-of-week validation
- [2025-12-22 11:25] Fixes applied:
  1. `getCurrentDateISO()` now returns `"2025-12-22 (luni)"` with weekday name
  2. Added `getTimezoneOffset()` helper that handles DST correctly
  3. Replaced hardcoded `+02:00` with dynamic Bucharest offset calculation
  4. Added explicit time interpretation section to system prompt ("la 10" = 10:00, not 01:00)

## Files Involved

- `services/gateway/src/services/ai-system-prompt.ts` - getCurrentDateISO function (MODIFIED)
- `services/gateway/src/services/ai-assistant.service.ts` - executeCreateCalendarEvent, timezone handling (MODIFIED)

## Screenshots

User conversation showing the bug:

- AI confirmed "joi (26 decembrie 2025)" but Dec 26 is Friday
- Time displayed as 01:00 instead of requested 10:00

---
