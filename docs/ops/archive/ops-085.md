# OPS-085: Tool Execution Layer

**Status:** Implemented | **Priority:** P1-High | **Type:** Feature
**Created:** 2025-12-21 | **Depends on:** OPS-084

## Summary

Create a tool executor that maps Claude tool calls to existing service methods. This replaces the intent handlers with a simpler dispatch layer.

## Background

Current intent handlers (`task.handler.ts`, `case.handler.ts`, etc.) contain:

1. Parameter validation
2. Natural language parsing (redundant with new architecture)
3. Service calls
4. Response formatting

The new architecture only needs #3 and #4 - Claude handles #1 and #2 via tool schemas.

## Requirements

### Tool Executor Service

```typescript
// services/gateway/src/services/tool-executor.service.ts

import { AIToolName } from './ai-tools.schema';
import { TaskService } from './task.service';
import { CaseService } from './case.service';
import { EmailService } from './email.service';
import { DocumentService } from './document.service';
import { MorningBriefingService } from './morning-briefing.service';

interface ExecutionContext {
  userId: string;
  firmId: string;
  caseId?: string;
}

interface PreviewResult {
  description: string;
  summary: string;
}

interface ExecutionResult {
  success: boolean;
  data?: unknown;
  successMessage: string;
  error?: string;
  suggestedFollowUps?: string[];
}

export class ToolExecutor {
  private taskService: TaskService;
  private caseService: CaseService;
  private emailService: EmailService;
  private documentService: DocumentService;
  private briefingService: MorningBriefingService;

  constructor() {
    this.taskService = TaskService.getInstance();
    this.caseService = CaseService.getInstance();
    this.emailService = EmailService.getInstance();
    this.documentService = DocumentService.getInstance();
    this.briefingService = MorningBriefingService.getInstance();
  }

  async preview(
    toolName: AIToolName,
    params: Record<string, unknown>,
    context: ExecutionContext
  ): Promise<PreviewResult> {
    switch (toolName) {
      case 'create_task':
        return this.previewCreateTask(params);
      case 'draft_email_reply':
        return this.previewEmailDraft(params, context);
      case 'generate_document':
        return this.previewGenerateDocument(params);
      case 'create_calendar_event':
        return this.previewCalendarEvent(params);
      default:
        return {
          description: 'Ac»õiune pregƒÉtitƒÉ',
          summary: JSON.stringify(params, null, 2),
        };
    }
  }

  async execute(
    toolName: AIToolName,
    params: Record<string, unknown>,
    context: ExecutionContext
  ): Promise<ExecutionResult> {
    try {
      switch (toolName) {
        // Task tools
        case 'create_task':
          return this.executeCreateTask(params, context);
        case 'list_tasks':
          return this.executeListTasks(params, context);
        case 'update_task':
          return this.executeUpdateTask(params, context);

        // Case tools
        case 'get_case_summary':
          return this.executeGetCaseSummary(params, context);
        case 'search_cases':
          return this.executeSearchCases(params, context);
        case 'get_case_deadlines':
          return this.executeGetCaseDeadlines(params, context);

        // Email tools
        case 'search_emails':
          return this.executeSearchEmails(params, context);
        case 'draft_email_reply':
          return this.executeDraftEmailReply(params, context);

        // Document tools
        case 'search_documents':
          return this.executeSearchDocuments(params, context);
        case 'generate_document':
          return this.executeGenerateDocument(params, context);

        // Calendar tools
        case 'get_calendar':
          return this.executeGetCalendar(params, context);
        case 'create_calendar_event':
          return this.executeCreateCalendarEvent(params, context);

        // Briefing tools
        case 'get_morning_briefing':
          return this.executeGetMorningBriefing(context);

        default:
          return {
            success: false,
            successMessage: '',
            error: `UnealtƒÉ necunoscutƒÉ: ${toolName}`,
          };
      }
    } catch (error) {
      return {
        success: false,
        successMessage: '',
        error: error instanceof Error ? error.message : 'Eroare necunoscutƒÉ',
      };
    }
  }

  // ============================================================
  // TASK IMPLEMENTATIONS
  // ============================================================

  private previewCreateTask(params: Record<string, unknown>): PreviewResult {
    const title = params.title as string;
    const dueDate = params.dueDate as string | undefined;
    const priority = params.priority as string | undefined;

    let summary = `üìù SarcinƒÉ nouƒÉ: "${title}"`;
    if (dueDate) summary += `\nüìÖ Termen: ${this.formatDate(dueDate)}`;
    if (priority) summary += `\n‚ö° Prioritate: ${priority}`;

    return {
      description: 'Voi crea aceastƒÉ sarcinƒÉ:',
      summary,
    };
  }

  private async executeCreateTask(
    params: Record<string, unknown>,
    context: ExecutionContext
  ): Promise<ExecutionResult> {
    const task = await this.taskService.create({
      title: params.title as string,
      description: params.description as string | undefined,
      dueDate: params.dueDate ? new Date(params.dueDate as string) : undefined,
      priority: (params.priority as string) || 'Medium',
      caseId: (params.caseId as string) || context.caseId,
      assigneeId: (params.assigneeId as string) || context.userId,
      createdById: context.userId,
      firmId: context.firmId,
    });

    return {
      success: true,
      data: task,
      successMessage: `‚úÖ Am creat sarcina "${task.title}"${task.dueDate ? ` cu termen ${this.formatDate(task.dueDate.toISOString())}` : ''}.`,
      suggestedFollowUps: ['Vezi toate sarcinile mele', 'AdaugƒÉ √ÆncƒÉ o sarcinƒÉ'],
    };
  }

  private async executeListTasks(
    params: Record<string, unknown>,
    context: ExecutionContext
  ): Promise<ExecutionResult> {
    const tasks = await this.taskService.list({
      firmId: context.firmId,
      caseId: params.caseId as string | undefined,
      assigneeId: params.assigneeId as string | undefined,
      status: params.status as string | undefined,
      dueBefore: params.dueBefore ? new Date(params.dueBefore as string) : undefined,
    });

    if (tasks.length === 0) {
      return {
        success: true,
        data: [],
        successMessage: 'Nu am gƒÉsit sarcini cu aceste criterii.',
        suggestedFollowUps: ['CreeazƒÉ o sarcinƒÉ nouƒÉ'],
      };
    }

    const summary = tasks
      .slice(0, 5)
      .map(
        (t) => `‚Ä¢ ${t.title}${t.dueDate ? ` (${this.formatDate(t.dueDate.toISOString())})` : ''}`
      )
      .join('\n');

    return {
      success: true,
      data: tasks,
      successMessage: `üìã Am gƒÉsit ${tasks.length} sarcini:\n\n${summary}${tasks.length > 5 ? `\n\n...»ôi √ÆncƒÉ ${tasks.length - 5}` : ''}`,
    };
  }

  // ... similar implementations for other tools ...

  // ============================================================
  // HELPERS
  // ============================================================

  private formatDate(isoDate: string): string {
    const date = new Date(isoDate);
    return date.toLocaleDateString('ro-RO', {
      weekday: 'long',
      day: 'numeric',
      month: 'long',
      year: 'numeric',
    });
  }
}
```

## Key Differences from Intent Handlers

| Current Handler           | New Executor               |
| ------------------------- | -------------------------- |
| 100-200 lines per handler | 20-30 lines per tool       |
| NL parsing logic          | No parsing (Claude did it) |
| Custom validation         | Schema-based validation    |
| Complex routing           | Simple switch/case         |
| Duplicated service calls  | Direct service methods     |

## Files to Create

- `services/gateway/src/services/tool-executor.service.ts`

## Acceptance Criteria

- [ ] All tools from OPS-082 have execute implementations
- [ ] Preview methods for mutation tools
- [ ] Romanian success/error messages
- [ ] Suggested follow-ups for better UX
- [ ] Proper error handling with user-friendly messages
- [ ] Uses existing services (no logic duplication)

## Session Log

- [2025-12-21] Issue created
- [2025-12-21] Session 1: Analyzed requirements - tool execution already implemented in `ai-assistant.service.ts` as part of OPS-084. All tools have execute implementations with Romanian messages, error handling, and suggested follow-ups. Status changed to Implemented.
