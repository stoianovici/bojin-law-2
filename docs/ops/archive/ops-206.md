# OPS-206: Merge NECLAR + Unassigned Emails with Inline Assignment

**Status:** Verifying | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-24

## Overview

Merge the current NECLAR (uncertain) and non-court unassigned emails into a single NECLAR section. Replace "FÄƒrÄƒ sugestii de dosar" text with an inline "Atribuie la dosar" drop-up picker for UX consistency.

## Dependencies

- **Depends on:** OPS-200-205 (Action Bar Redesign complete)
- **Blocks:** None
- **Parallel with:** None

## Context

Current state has two overlapping concepts:

- **INSTANÈšE**: Court emails with extracted references
- **NECLAR**: Uncertain emails with suggested cases

In practice, both need human classification. The UI already shows "FÄƒrÄƒ sugestii de dosar" for NECLAR emails without suggestions, which dissolves the distinction.

## Requirements

### 1. Unified NECLAR Section

Merge into single sidebar section containing:

- Current uncertain emails (`classificationState = 'UNCERTAIN'`)
- Non-court unassigned emails (no case, not from court domains)

Keep **INSTANÈšE** separate for court emails (will have drawer interaction - future issue).

Sort by: **receivedDateTime DESC** (newest first)

### 2. Backend: Unified Query

```graphql
query GetUnclassifiedEmails($limit: Int, $offset: Int) {
  unclassifiedEmails(limit: $limit, offset: $offset) {
    id
    conversationId
    subject
    from {
      name
      address
    }
    receivedDateTime
    bodyPreview
    suggestedCases {
      id
      caseNumber
      title
      score
    }
  }
  unclassifiedEmailsCount
}
```

Logic:

- `classificationState IN ('UNCERTAIN', 'UNCLASSIFIED')` OR `caseId IS NULL`
- Exclude court emails (institutionCategory != null)
- Exclude ignored emails

### 3. Inline Case Assignment Drop-up

When no suggestions exist, show drop-up picker instead of "FÄƒrÄƒ sugestii de dosar":

**With suggestions:**

```
[SplitAssignmentButton (80/20)]  [RÄƒspunde]  [Privat]
```

**Without suggestions:**

```
[Atribuie la dosar â–²]  [RÄƒspunde]  [Privat]
```

### 4. CasePickerDropup Component

```tsx
interface CasePickerDropupProps {
  onSelect: (caseId: string) => void;
  loading?: boolean;
  disabled?: boolean;
}
```

Features:

- Drop-up menu (opens upward from action bar)
- Shows all user's cases
- Search/filter input if > 10 cases
- Case format: `{caseNumber} - {title}`
- Click to assign immediately
- Close on outside click or Escape

Visual design:

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ğŸ” CautÄƒ dosar...               â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ 123/2024 - Popescu v. Ionescu   â”‚
                    â”‚ 456/2024 - SC Alpha SRL         â”‚
                    â”‚ 789/2024 - Contract ABC         â”‚
                    â”‚ ...                             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Atribuie la dosar â–²]  [RÄƒspunde]  [Privat]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. Update ConversationView

In NECLAR action bar:

```tsx
{primaryCase ? (
  <SplitAssignmentButton ... />
) : (
  <CasePickerDropup onSelect={handleNeclarAssign} />
)}
```

### 6. Remove INSTANÈšE from Sidebar (for now)

Court emails will get their own drawer interaction in a future issue. For now, keep them in the existing INSTANÈšE section but deprioritize.

## Acceptance Criteria

- [ ] Single NECLAR section in sidebar (merged uncertain + unassigned non-court)
- [ ] Emails sorted by date (newest first)
- [ ] With suggestions: SplitAssignmentButton shows as before
- [ ] Without suggestions: CasePickerDropup in same position
- [ ] Drop-up shows all user's cases
- [ ] Search filter works for large case lists
- [ ] Click assigns immediately (no modal)
- [ ] Outside click closes drop-up
- [ ] Escape key closes drop-up

## Files to Modify

**Backend:**

- `services/gateway/src/graphql/schema/email.graphql` - add `unclassifiedEmails` query
- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - implement query
- `services/gateway/src/services/email-classification.service.ts` - unclassified logic

**Frontend:**

- `apps/web/src/hooks/useMyEmailsByCase.ts` - use new unified query
- `apps/web/src/components/communication/CasePickerDropup.tsx` - NEW component
- `apps/web/src/components/communication/ConversationView.tsx` - conditional render
- `apps/web/src/components/communication/CaseSidebar.tsx` - merge sections

## Estimated Scope

Medium - New component + query refactor + sidebar merge.

---

## Session Log

### Session 1 - 2024-12-24

**Completed:**

1. Created `CasePickerDropup` component (`apps/web/src/components/communication/CasePickerDropup.tsx`)
   - Drop-up menu for selecting a case when no AI suggestions exist
   - Search filter for 10+ cases
   - Shows case number, title, and client name
   - Loading and disabled states
   - Close on outside click or Escape

2. Updated `ConversationView` to use `CasePickerDropup` when no suggestions
   - Conditional rendering: SplitAssignmentButton when suggestions exist, CasePickerDropup otherwise
   - Both components call the same `handleNeclarAssign` callback

3. Merged sidebar sections in `CaseSidebar`
   - Removed unassigned threads from DOSARE section
   - Added new `UnassignedThreadItem` component with sender-first display
   - Merged NECLAR section now shows uncertain emails + unassigned threads
   - Updated count to reflect merged items

4. Added `onSelectUnassignedThread` callback
   - New prop in CaseSidebar for handling unassigned thread clicks in NECLAR section
   - Page handler sets up NECLAR mode with empty suggestions (triggers CasePickerDropup)
   - Uses `uncertain-email` view mode for consistent NECLAR action bar

**Key Changes:**

- Backend: No changes needed - frontend merges existing data sources
- The existing `uncertainEmails` + `emailThreads` queries provide all needed data
- Frontend merges at display time in CaseSidebar

**Acceptance Criteria Status:**

- [x] Single NECLAR section in sidebar (merged uncertain + unassigned non-court)
- [x] Emails sorted by date (newest first) - existing sort preserved
- [x] With suggestions: SplitAssignmentButton shows as before
- [x] Without suggestions: CasePickerDropup in same position
- [x] Drop-up shows all user's cases
- [x] Search filter works for large case lists (10+ cases)
- [x] Click assigns immediately (no modal)
- [x] Outside click closes drop-up
- [x] Escape key closes drop-up

**Ready for testing.**
