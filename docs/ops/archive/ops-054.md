# OPS-054: CaseChronology Integration

**Status:** Implemented | **Priority:** P2-Medium | **Type:** Feature | **Created:** 2025-12-19 | **Sessions:** 1

## Context

Part of the chronology structure improvement (OPS-051 through OPS-054). This issue integrates all the pieces into the existing CaseChronology component.

## Scope

Refactor `CaseChronology` to use:

- Tab bar from OPS-053
- Time sections from OPS-052
- Time grouping utility from OPS-051

## Dependencies

- **OPS-051**: Time Grouping Utility
- **OPS-052**: TimeSection Component
- **OPS-053**: Tab Bar & Event Filtering

## Implementation

### Updated Component Structure

```
CaseChronology
├── Header (title + total count)
├── ChronologyTabBar (from OPS-053)
└── TimeGroupedContent
    ├── TimeSection "Astăzi" (from OPS-052)
    │   └── EventItem (existing, extracted)
    ├── TimeSection "Săptămâna aceasta"
    │   └── EventItem
    ├── TimeSection "Luna aceasta"
    │   └── EventItem
    └── TimeSection "Mai vechi"
        └── EventItem + LoadMore button
```

### State Management

```typescript
// In CaseChronology.tsx
const [activeTab, setActiveTab] = useState<ChronologyTab>('all');

// Filter events by tab
const filteredEvents = useMemo(() => filterEventsByTab(events, activeTab), [events, activeTab]);

// Group by time period
const groupedEvents = useMemo(() => groupEventsByTimePeriod(filteredEvents), [filteredEvents]);

// Calculate counts for tab badges
const tabCounts = useMemo(() => countEventsByTab(events), [events]);
```

### Default Expand States

```typescript
const DEFAULT_EXPANDED: Record<TimePeriod, boolean> = {
  today: true,
  thisWeek: true,
  thisMonth: false,
  older: false,
};
```

### Extract EventItem

Extract the existing event rendering into a separate `EventItem` component for reuse:

```typescript
interface EventItemProps {
  event: CaseEvent;
}

function EventItem({ event }: EventItemProps) {
  const Icon = EVENT_ICONS[event.eventType] || Calendar;
  const iconColor = EVENT_COLORS[event.eventType] || 'text-gray-400';

  return (
    <div className="px-5 py-3 flex items-start gap-3 hover:bg-gray-50">
      {/* existing event rendering */}
    </div>
  );
}
```

### Load More Behavior

The "Încarcă mai multe" button should:

1. Only appear in the "Mai vechi" section (or at bottom if no older section)
2. Load additional events into the existing data
3. New events get grouped into appropriate time sections

### Full Refactored Component

```tsx
export function CaseChronology({ caseId, className }: CaseChronologyProps) {
  const { events, loading, loadMore, hasMore, totalCount } = useCaseEvents(caseId);
  const [activeTab, setActiveTab] = useState<ChronologyTab>('all');

  const filteredEvents = useMemo(() => filterEventsByTab(events, activeTab), [events, activeTab]);

  const groupedEvents = useMemo(() => groupEventsByTimePeriod(filteredEvents), [filteredEvents]);

  const tabCounts = useMemo(() => countEventsByTab(events), [events]);

  const isEmpty = !loading && events.length === 0;

  return (
    <div className={clsx('bg-white rounded-lg border border-gray-200', className)}>
      {/* Header */}
      <div className="px-5 py-4 border-b border-gray-200 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <Calendar className="h-5 w-5 text-green-500" />
          <h3 className="font-semibold text-gray-900">Cronologie</h3>
        </div>
        {totalCount > 0 && <span className="text-xs text-gray-500">{totalCount} evenimente</span>}
      </div>

      {/* Tab Bar */}
      <ChronologyTabBar activeTab={activeTab} counts={tabCounts} onTabChange={setActiveTab} />

      {/* Content */}
      {loading && events.length === 0 ? (
        <ChronologySkeleton />
      ) : isEmpty ? (
        <EmptyState />
      ) : filteredEvents.length === 0 ? (
        <EmptyTabState tab={activeTab} />
      ) : (
        <>
          {groupedEvents.map((group) => (
            <TimeSection
              key={group.period}
              label={group.label}
              count={group.count}
              defaultExpanded={DEFAULT_EXPANDED[group.period]}
            >
              {group.events.map((event) => (
                <EventItem key={event.id} event={event} />
              ))}
            </TimeSection>
          ))}

          {hasMore && (
            <div className="px-5 py-3 border-t border-gray-100">
              <button onClick={loadMore} disabled={loading} className="...">
                {loading ? 'Se încarcă...' : 'Încarcă mai multe'}
              </button>
            </div>
          )}
        </>
      )}
    </div>
  );
}
```

### Empty Tab State

Add a component for when a specific tab has no events:

```typescript
function EmptyTabState({ tab }: { tab: ChronologyTab }) {
  const messages: Record<ChronologyTab, string> = {
    all: 'Nu există evenimente înregistrate',
    documents: 'Nu există documente în cronologie',
    communications: 'Nu există comunicări în cronologie',
    tasks: 'Nu există sarcini în cronologie',
  };

  return (
    <div className="px-5 py-8 text-center">
      <p className="text-sm text-gray-500">{messages[tab]}</p>
    </div>
  );
}
```

## Testing

1. Tab switching filters events correctly
2. Time sections group events properly
3. Expand/collapse works for each section
4. Load more adds events to correct sections
5. Empty states show for empty tabs
6. Tab counts update correctly

## Acceptance Criteria

- [x] Tabs switch between event categories
- [x] Time sections group events within each tab
- [x] Collapsible sections work (today/thisWeek expanded, others collapsed)
- [x] Load more still functions
- [x] Empty states for empty tabs
- [ ] No regressions in existing functionality (needs UI verification)
- [x] Smooth transitions between tabs

## Files Modified

- `apps/web/src/components/case/CaseChronology.tsx` - Major refactor

## Files Created (by dependencies)

- `apps/web/src/lib/timeGrouping.ts` (OPS-051)
- `apps/web/src/components/case/TimeSection.tsx` (OPS-052)
- `apps/web/src/components/case/ChronologyTabBar.tsx` (OPS-053)
- `apps/web/src/components/case/chronologyTabs.ts` (OPS-053)

---

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

## Session Log

- [2025-12-19] Session 1 started. All dependencies ready (OPS-051, OPS-052, OPS-053). Beginning integration.
- [2025-12-19] Refactored CaseChronology.tsx to integrate:
  - Added imports for ChronologyTabBar, TimeSection, chronologyTabs, timeGrouping
  - Added tab state management with useState/useMemo
  - Added DEFAULT_EXPANDED constant for section collapse defaults
  - Added EmptyTabState component for empty filtered results
  - Extracted EventItem as a separate component
  - Refactored render to use ChronologyTabBar and TimeSection components
- [2025-12-19] TypeScript compilation passes, time grouping tests pass (16/16)
