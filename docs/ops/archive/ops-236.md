# OPS-236: Batch Job Runner Framework

**Type**: Feature
**Priority**: P1-High
**Status**: Completed
**Epic**: AI Batch Processing & Ops Dashboard

## Problem

No infrastructure for running nightly AI batch jobs with logging, error handling, and retry logic.

## Solution

Create pluggable batch framework with processor interface and orchestrator.

### Processor Interface

```typescript
interface BatchProcessorResult {
  itemsProcessed: number;
  itemsFailed: number;
  totalTokens: number;
  totalCost: number;
  errors?: string[];
}

interface BatchProcessor {
  name: string;
  feature: string; // matches AIFeatureConfig.feature

  /**
   * Process items for a firm
   * @param firmId - Firm to process
   * @param batchJobId - ID for logging AI calls
   * @param onProgress - Callback for progress updates
   */
  process(
    firmId: string,
    batchJobId: string,
    onProgress?: (processed: number, total: number) => void
  ): Promise<BatchProcessorResult>;
}
```

### Batch Runner

```typescript
class BatchRunner {
  private processors: Map<string, BatchProcessor> = new Map();

  registerProcessor(processor: BatchProcessor): void;

  /**
   * Run a specific processor for a firm
   */
  async runProcessor(firmId: string, feature: string): Promise<AIBatchJobRun>;

  /**
   * Run all enabled processors for a firm
   */
  async runAllForFirm(firmId: string): Promise<AIBatchJobRun[]>;

  /**
   * Start cron scheduler for all firms
   */
  startScheduler(): void;

  /**
   * Stop cron scheduler
   */
  stopScheduler(): void;
}
```

### Job Lifecycle

1. Check if feature enabled via `AIFeatureConfigService`
2. Create `AIBatchJobRun` with status='running'
3. Call processor's `process()` method
4. Update job with results (items, tokens, cost, status)
5. Handle errors gracefully (partial success OK)

### Cron Integration

```typescript
import cron from 'node-cron';

// Read schedules from AIFeatureConfig
const configs = await featureConfigService.getAllFeatures(firmId);
for (const config of configs) {
  if (config.enabled && config.schedule) {
    cron.schedule(config.schedule, () => {
      batchRunner.runProcessor(firmId, config.feature);
    });
  }
}
```

## Acceptance Criteria

- [x] `BatchProcessor` interface defined
- [x] `BatchRunner` orchestrates execution
- [x] Job status tracked in database (running/completed/failed/partial/skipped)
- [x] Error handling with partial success support
- [x] Cron schedule reads from feature config
- [x] Manual trigger via `runProcessor()` method
- [x] Progress callback for long-running jobs
- [x] Integration test with mock processor (14 tests)

## Files to Modify

- `services/gateway/src/batch/batch-processor.interface.ts` (new)
- `services/gateway/src/batch/batch-runner.service.ts` (new)
- `services/gateway/src/batch/index.ts` (new)

## Dependencies

- OPS-233 (AI Client for logging)
- OPS-234 (Feature config for enabled check and schedules)

## Parallel Work

Can be done in parallel with OPS-235.
