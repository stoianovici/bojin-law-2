# [OPS-010] Emails synced but not displayed (1049 emails)

| Field           | Value       |
| --------------- | ----------- |
| **Status**      | Resolved    |
| **Type**        | Bug         |
| **Priority**    | P0-Critical |
| **Created**     | 2025-12-12  |
| **Sessions**    | 3           |
| **Last Active** | 2025-12-12  |

## Description

The /communications page shows "1049 emailuri sincronizate" in Render production, but no emails are displayed in the UI. User reports emails appeared in localhost before deployment, but now they don't appear locally either. This appears to be a regression from previous OPS-001 fixes.

## Reproduction Steps

1. Navigate to /communications page (localhost or production)
2. Observe that the sync indicator shows "1049 emailuri sincronizate"
3. Observe that no email threads are displayed in the ThreadList
4. Check browser console and network tab for errors

## Root Cause

**CONFIRMED: Two issues combined**

**Issue 1: Missing database column (PRIMARY)**

1. OPS-008 Session 4 added `isIgnored` and `ignoredAt` fields to Prisma schema
2. The database migration was created but column didn't exist in production database
3. When Prisma queried emails, it expected the `is_ignored` column but it was missing
4. All email queries failed silently, returning 0 threads

**Issue 2: emailViewMode filter (SECONDARY)**

1. `communication.store.ts` line 111: `emailViewMode` defaulted to `'received'`
2. The filter state is persisted in localStorage under key `communication-filters`
3. Even after changing default to 'all', existing users had old 'received' value persisted

## Fix Applied

**Fix 1: Change default emailViewMode to 'all'**

- File: `apps/web/src/stores/communication.store.ts`
- Changed line 111 from `emailViewMode: 'received'` to `emailViewMode: 'all'`
- New users will see all emails by default

**Fix 2: Added debug logging**

- File: `apps/web/src/stores/communication.store.ts`
- Added console.log statements in `getFilteredThreads()` to diagnose filtering issues
- Shows: initial thread count, userEmail, emailViewMode, and threads after each filter step

**Fix 3: Debug logging in communications page**

- File: `apps/web/src/app/communications/page.tsx`
- Added logging for apiThreads count to verify data arrives from API

**Fix 4: Database migration for isIgnored fields (Session 3)**

- File: `services/gateway/src/index.ts`
- Added one-time migration endpoint `/admin/run-migration-is-ignored`
- Fixed Prisma `$executeRawUnsafe()` to run each SQL statement separately (can't batch multiple statements)
- Migration adds: `is_ignored BOOLEAN DEFAULT false`, `ignored_at TIMESTAMPTZ`, and index

**User Action Required (for existing users):**

- Users with persisted localStorage must either:
  1. Click "Toate" tab in FilterBar to show all emails, OR
  2. Clear localStorage: `localStorage.removeItem('communication-filters')` then refresh

## Local Dev Environment

```bash
# Full dev environment:
pnpm dev

# Individual services:
cd services/gateway && pnpm dev     # GraphQL gateway on :4000
cd services/ai-service && pnpm dev  # AI service on :3002
cd apps/web && pnpm dev             # Next.js frontend on :3000

# Environment files exist at:
# - .env (root)
# - apps/web/.env.local
# - services/gateway/.env
# - services/ai-service/.env
# - packages/database/.env
```

## Session Log

- [2025-12-12] Issue created. Related to OPS-001 (9 sessions of email sync fixes). Initial triage identified 4 potential root causes: (1) emailViewMode filter with default 'received' mode, (2) conversationId fallback changes, (3) data transformation issues, (4) isIgnored filter. Primary suspect is the emailViewMode filter in communication.store.ts which defaults to 'received' and may be filtering out all threads if userEmail is not properly set or if localStorage has a persisted filter state.
- [2025-12-12] Session 2 started. Continuing from: New. Beginning investigation of filter logic and thread display.
- [2025-12-12] Session 2 - Root cause confirmed: emailViewMode defaults to 'received' which filters out threads where all messages have senderEmail matching user's email. Additionally, the filter state is persisted in localStorage, so clearing localStorage may be required.
- [2025-12-12] Session 2 - Fix: Changed default emailViewMode from 'received' to 'all' in communication.store.ts. Added debug logging to help diagnose future issues.
- [2025-12-12] Session 2 - Build verified successful. Ready for deployment.
- [2025-12-12] Session 2 - Committed and pushed `bfb5736`. Manual deployment required (RENDER_DEPLOY_HOOK_PRODUCTION not set).
- [2025-12-12] Session 3 started. Continuing from: Fixing. VSCode crashed during previous session.
- [2025-12-12] Session 3 - Discovered primary root cause: `isIgnored` column missing from production database. Prisma schema has the field but DB column doesn't exist, causing all email queries to fail silently.
- [2025-12-12] Session 3 - Fix: Split migration endpoint into separate SQL statements (Prisma can't batch multiple statements in `$executeRawUnsafe()`). Committed `556d67d`.
- [2025-12-12] Session 3 - Deployed gateway via Render API, ran migration endpoint successfully.
- [2025-12-12] Session 3 - **RESOLVED**. Emails now display correctly in /communications page after: (1) running isIgnored migration, (2) clearing localStorage filter.

## Files Involved

**Modified:**

- `apps/web/src/stores/communication.store.ts` - **FIXED** - Changed default emailViewMode to 'all', added debug logging
- `apps/web/src/app/communications/page.tsx` - **FIXED** - Added debug logging for apiThreads
- `services/gateway/src/index.ts` - **FIXED** - Added migration endpoint, fixed Prisma statement batching

**Frontend - Display Components:**

- `apps/web/src/components/communication/ThreadList.tsx` - Thread display
- `apps/web/src/components/communication/FilterBar.tsx` - Email view mode tabs (contains "Toate" tab)

**Backend - Data Retrieval:**

- `services/gateway/src/services/email-thread.service.ts` - Thread grouping (uses isIgnored field)
- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - GraphQL queries with debug logging
