# OPS-016: Redesign Communications Tab in Case Details

| Field           | Value            |
| --------------- | ---------------- |
| **Status**      | Closed           |
| **Type**        | Feature          |
| **Priority**    | P1-High          |
| **Created**     | 2025-12-13       |
| **Sessions**    | 2                |
| **Last Active** | 2025-12-13 15:30 |

## Description

The communications tab in case details (`/cases/[caseId]`) needs a complete overhaul to bring feature parity with the main `/communications` page. Currently it's a basic thread list with a modal that shows raw HTML as text.

### Current Problems

1. **Poor email rendering** - HTML emails display as raw code instead of formatted content
2. **Missing core functionality** - No reply, forward, attachments, or AI features
3. **Limited UI** - Simple modal popup instead of integrated view
4. **No internal notes** - Can't add case notes with privacy controls
5. **Basic filtering** - Only "processed" filter, no channel/date/direction filtering

## Proposed Solution

Replace the current `CommunicationsTab` with the `UnifiedTimeline` component system, which provides:

### Features to Include

| Feature                  | Component                  | Priority    |
| ------------------------ | -------------------------- | ----------- |
| Unified timeline view    | `UnifiedTimeline.tsx`      | Must have   |
| Proper HTML rendering    | `TimelineEntryCard.tsx`    | Must have   |
| Internal notes composer  | `InternalNoteComposer.tsx` | Must have   |
| Advanced filtering       | `TimelineFilterBar.tsx`    | Must have   |
| Reply/Forward actions    | `ComposeInterface.tsx`     | Should have |
| AI extracted items panel | `ExtractedItemsPanel.tsx`  | Should have |
| Attachments handling     | From `MessageView.tsx`     | Should have |

### Architecture

```
CommunicationsTab (redesigned)
├── TimelineFilterBar.tsx       # Channel, date, direction filters
├── InternalNoteComposer.tsx    # Add notes with privacy
├── UnifiedTimeline.tsx         # Main timeline view
│   └── TimelineEntryCard.tsx   # Individual entry rendering
└── ExtractedItemsPanel.tsx     # AI-extracted items sidebar (optional)
```

## Implementation Plan

### Phase 1: Core Timeline Integration

1. Replace `CommunicationsTab` content with `UnifiedTimeline`
2. Add `TimelineFilterBar` for filtering
3. Ensure `TimelineEntryCard` properly renders HTML emails
4. Wire up `useCaseTimeline(caseId)` hook

### Phase 2: Note Composition

5. Add `InternalNoteComposer` at top of timeline
6. Implement privacy level controls
7. Test note creation and display

### Phase 3: Actions & AI (Optional Enhancement)

8. Add reply/forward buttons to timeline entries
9. Integrate `ComposeInterface` modal
10. Add `ExtractedItemsPanel` as collapsible sidebar

## Files Involved

### To Modify

- `apps/web/src/components/case/tabs/CommunicationsTab.tsx` - Complete rewrite

### To Reuse (already exist)

- `apps/web/src/components/communication/UnifiedTimeline.tsx`
- `apps/web/src/components/communication/TimelineEntryCard.tsx`
- `apps/web/src/components/communication/TimelineFilterBar.tsx`
- `apps/web/src/components/communication/InternalNoteComposer.tsx`
- `apps/web/src/components/communication/ComposeInterface.tsx`
- `apps/web/src/components/communication/ExtractedItemsPanel.tsx`

### Hooks to Use

- `useCaseTimeline(caseId, filter)` - Fetch timeline data
- `useCreateInternalNote(caseId)` - Create notes
- `useChannelMetadata()` - Channel colors/labels
- `usePrivacyMetadata()` - Privacy level visuals

## Local Dev Environment

```bash
cd apps/web && npm run dev
# Access at http://localhost:3000/cases/[caseId]
# Click "Comunicații" tab to test
```

## Session Log

- [2025-12-13 14:15] Issue created. Initial triage completed. Identified that `CommunicationsTab.tsx` uses plain text rendering while `/communications` page has full HTML support via `UnifiedTimeline` components. Recommended replacing current implementation with existing timeline components.
- [2025-12-13 15:30] Session 2 started. Continuing from: New. Read current CommunicationsTab (275 lines with modal) and UnifiedTimeline (219 lines with built-in filters/composer). UnifiedTimeline already includes showFilters and showComposer props - replacement is straightforward.
- [2025-12-13 15:35] Replaced CommunicationsTab implementation (275 → 51 lines). Component now uses UnifiedTimeline with showFilters and showComposer enabled. Type check passed. Dev server already running on port 3000.
- [2025-12-13 15:45] Found root cause of GraphQL error: `communicationHubResolvers` was never imported/registered in `server.ts`. Added the import and merged Query, Mutation, and type resolvers (TimelineEntry, CommunicationTemplate, BulkCommunication, CommunicationExport).
- [2025-12-13 15:50] Fixed enum mismatch between GraphQL schema and Prisma (EMAIL→Email, INBOUND→Inbound, etc.)
- [2025-12-13 15:55] Added email→CommunicationEntry sync when assigning emails to cases via `assignEmailToCase` and `assignThreadToCase` mutations.
- [2025-12-13 16:00] Fixed null body field in mapToTimelineEntry - added body and htmlBody to returned object.
- [2025-12-13 16:05] Fixed HTML rendering in TimelineEntryCard - now renders htmlBody with dangerouslySetInnerHTML even in collapsed state.
- [2025-12-13 16:10] Translated entire Communications section to Romanian.
- [2025-12-13 16:15] **Issue closed.** All acceptance criteria met.

## Acceptance Criteria

- [x] HTML emails render properly (no raw code visible)
- [x] Can add internal notes with privacy levels
- [x] Can filter by channel, date range, direction
- [x] Timeline shows all communication types (email, notes, calls, etc.)
- [x] Infinite scroll works for large histories
- [ ] Reply/Forward actions available on email entries (buttons present, full compose TBD)

---
