# OPS-062: UI Multi-Case Email Display

| Field           | Value                     |
| --------------- | ------------------------- |
| **Status**      | Verifying                 |
| **Type**        | Feature                   |
| **Priority**    | P2-Medium                 |
| **Created**     | 2025-12-20                |
| **Sessions**    | 1                         |
| **Last Active** | 2025-12-20                |
| **Depends On**  | OPS-059, OPS-060, OPS-061 |

## Description

Update the frontend to display emails that belong to multiple cases. This includes showing case badges, handling emails appearing in multiple case views, and providing UI for linking/unlinking emails from cases.

## Current UI (Problem)

- `/communications` shows emails grouped by single case
- Case detail Communications tab shows emails where `email.caseId === case.id`
- No indication that an email might also appear in other cases
- No way to manually link an email to additional cases

## New UI (Solution)

### 1. Multi-Case Badge on Emails

When an email is linked to multiple cases, show a badge indicating this:

```tsx
// components/email/EmailListItem.tsx
const EmailListItem = ({ email }) => {
  const caseCount = email.caseLinks?.length ?? 0;

  return (
    <div className="email-item">
      <EmailHeader email={email} />
      {caseCount > 1 && (
        <Badge variant="outline" className="ml-2">
          +{caseCount - 1} cazuri
        </Badge>
      )}
      {/* ... rest of email */}
    </div>
  );
};
```

### 2. Case Links Popover

Clicking the badge shows which cases the email is linked to:

```tsx
// components/email/CaseLinksPopover.tsx
const CaseLinksPopover = ({ email }) => {
  return (
    <Popover>
      <PopoverTrigger>
        <Badge>+{email.caseLinks.length - 1} cazuri</Badge>
      </PopoverTrigger>
      <PopoverContent>
        <div className="space-y-2">
          {email.caseLinks.map((link) => (
            <div key={link.id} className="flex items-center justify-between">
              <Link href={`/cases/${link.case.id}`}>{link.case.title}</Link>
              {link.isPrimary && <Badge variant="secondary">Principal</Badge>}
              {!link.isPrimary && (
                <Button
                  size="sm"
                  variant="ghost"
                  onClick={() => unlinkFromCase(email.id, link.caseId)}
                >
                  <X className="h-4 w-4" />
                </Button>
              )}
            </div>
          ))}
        </div>
      </PopoverContent>
    </Popover>
  );
};
```

### 3. "Link to Case" Action

Add action to link email to additional cases:

```tsx
// components/email/EmailActions.tsx
const EmailActions = ({ email }) => {
  const [showLinkModal, setShowLinkModal] = useState(false);

  return (
    <>
      <DropdownMenu>
        <DropdownMenuItem onClick={() => setShowLinkModal(true)}>
          <Link2 className="mr-2 h-4 w-4" />
          Adaugă la alt dosar
        </DropdownMenuItem>
      </DropdownMenu>

      <LinkEmailToCaseModal
        email={email}
        open={showLinkModal}
        onClose={() => setShowLinkModal(false)}
      />
    </>
  );
};
```

### 4. Link Email to Case Modal

```tsx
// components/email/LinkEmailToCaseModal.tsx
const LinkEmailToCaseModal = ({ email, open, onClose }) => {
  const [selectedCase, setSelectedCase] = useState(null);
  const [linkEmail] = useMutation(LINK_EMAIL_TO_CASE);

  // Get contact's other cases (not already linked)
  const { data } = useQuery(GET_CONTACT_CASES, {
    variables: { email: email.senderEmail },
  });

  const availableCases = data?.contactCases?.filter(
    (c) => !email.caseLinks.some((link) => link.caseId === c.id)
  );

  const handleLink = async () => {
    await linkEmail({
      variables: { emailId: email.id, caseId: selectedCase },
    });
    onClose();
  };

  return (
    <Dialog open={open} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Adaugă email la dosar</DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          <p className="text-sm text-muted-foreground">
            Selectează un dosar pentru a adăuga acest email. Emailul va apărea în ambele dosare.
          </p>

          <Select value={selectedCase} onValueChange={setSelectedCase}>
            <SelectTrigger>
              <SelectValue placeholder="Selectează dosar" />
            </SelectTrigger>
            <SelectContent>
              {availableCases?.map((c) => (
                <SelectItem key={c.id} value={c.id}>
                  {c.title} ({c.client.name})
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose}>
            Anulează
          </Button>
          <Button onClick={handleLink} disabled={!selectedCase}>
            Adaugă
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};
```

### 5. Update GraphQL Queries

```graphql
# queries/email.graphql

fragment EmailFields on Email {
  id
  subject
  senderEmail
  receivedDateTime
  # ... existing fields

  # NEW: Multi-case support
  caseLinks {
    id
    caseId
    isPrimary
    confidence
    case {
      id
      title
      caseNumber
    }
  }
}

mutation LinkEmailToCase($emailId: ID!, $caseId: ID!) {
  linkEmailToCase(input: { emailId: $emailId, caseId: $caseId }) {
    id
    email {
      ...EmailFields
    }
  }
}

mutation UnlinkEmailFromCase($emailId: ID!, $caseId: ID!) {
  unlinkEmailFromCase(input: { emailId: $emailId, caseId: $caseId })
}
```

## Files to Modify

| File                                                     | Changes                         |
| -------------------------------------------------------- | ------------------------------- |
| `apps/web/src/components/email/EmailListItem.tsx`        | Add case count badge            |
| `apps/web/src/components/email/CaseLinksPopover.tsx`     | NEW: Case links dropdown        |
| `apps/web/src/components/email/EmailActions.tsx`         | Add "Link to case" action       |
| `apps/web/src/components/email/LinkEmailToCaseModal.tsx` | NEW: Case selection modal       |
| `apps/web/src/graphql/queries/email.graphql`             | Update fragments, add mutations |
| `apps/web/src/app/cases/[id]/communications/`            | Update to use caseLinks         |

## Acceptance Criteria

- [ ] Emails show badge when linked to multiple cases
- [ ] Badge click shows popover with all linked cases
- [ ] Primary case marked in popover
- [ ] "Link to case" action in email dropdown
- [ ] Modal shows contact's other active cases
- [ ] Successfully link email to additional case
- [ ] Successfully unlink email from non-primary case
- [ ] Cannot unlink from primary case (protection)

## UI Copy (Romanian)

| Element            | Text                                                                                   |
| ------------------ | -------------------------------------------------------------------------------------- |
| Badge              | `+{n} cazuri`                                                                          |
| Popover title      | `Dosare asociate`                                                                      |
| Primary badge      | `Principal`                                                                            |
| Link action        | `Adaugă la alt dosar`                                                                  |
| Modal title        | `Adaugă email la dosar`                                                                |
| Modal description  | `Selectează un dosar pentru a adăuga acest email. Emailul va apărea în ambele dosare.` |
| Select placeholder | `Selectează dosar`                                                                     |
| Cancel button      | `Anulează`                                                                             |
| Confirm button     | `Adaugă`                                                                               |

## Files Modified

| File                                                             | Changes                                       |
| ---------------------------------------------------------------- | --------------------------------------------- |
| `apps/web/src/hooks/useEmailSync.ts`                             | Added caseLinks to fragment, link/unlink hook |
| `apps/web/src/hooks/useMyEmailsByCase.ts`                        | Added caseLinks aggregation for threads       |
| `apps/web/src/components/communication/CaseSidebar.tsx`          | Added multi-case badge to ThreadItem          |
| `apps/web/src/components/communication/CaseLinksPopover.tsx`     | NEW: Case links popover component             |
| `apps/web/src/components/communication/LinkEmailToCaseModal.tsx` | NEW: Modal for linking to cases               |

## Local Verification Status

| Step           | Status     | Date       | Notes                                        |
| -------------- | ---------- | ---------- | -------------------------------------------- |
| Prod data test | ⬜ Pending |            |                                              |
| Preflight      | ✅ Pass    | 2025-12-20 | All checks passed, 2 warnings (pre-existing) |
| Docker test    | ⬜ Pending |            |                                              |

**Verified**: No

## Session Log

- [2025-12-20] Issue created as part of multi-case email feature set.
- [2025-12-20] Session 1: Implemented multi-case UI display
  - Added `caseLinks` field to Email GraphQL fragment in `useEmailSync.ts`
  - Added `EmailCaseLink` type and `useEmailCaseLinks()` hook for link/unlink operations
  - Updated `useMyEmailsByCase` to aggregate case links across thread emails
  - Added multi-case badge to `ThreadItem` in `CaseSidebar` (shows `+N` when email in multiple cases)
  - Created `CaseLinksPopover` component for displaying all linked cases with unlink option
  - Created `LinkEmailToCaseModal` component for adding emails to additional cases
  - Preflight passed (TypeScript, production build, Docker builds all successful)

---
