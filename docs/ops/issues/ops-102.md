# OPS-102: Mapa UI Components

**Type:** Feature
**Priority:** P1-High
**Status:** Fixed
**Created:** 2024-12-22

## Summary

Build the frontend components for viewing, creating, and managing Mape within case details.

## Dependencies

- **Requires:** OPS-100 (Mapa Service Layer) ✅
- **Requires:** OPS-101 (Mapa GraphQL Schema) ✅

## Component Architecture

```
apps/web/src/
├── components/
│   └── mapa/
│       ├── MapaList.tsx           # List of mape for a case
│       ├── MapaCard.tsx           # Summary card with completion status
│       ├── MapaDetail.tsx         # Full mapa view with slots
│       ├── MapaSlotList.tsx       # Ordered list of slots
│       ├── MapaSlotItem.tsx       # Individual slot (filled/empty)
│       ├── MapaCreateModal.tsx    # Create new mapa (blank or from template)
│       ├── MapaSlotEditor.tsx     # Add/edit slot
│       ├── DocumentAssignModal.tsx # Pick document for slot
│       └── MapaTemplateSelector.tsx # Template picker
├── hooks/
│   └── useMapa.ts                 # GraphQL operations for mapa
└── app/
    └── cases/
        └── [id]/
            └── mape/              # Mape tab/section
                └── page.tsx
```

## Component Specifications

### 1. MapaList

Displays all mape for a case with summary cards.

```tsx
interface MapaListProps {
  caseId: string;
}

// Features:
// - Grid of MapaCard components
// - "Crează mapă" button → MapaCreateModal
// - Empty state: "Nu există mape pentru acest dosar"
// - Sort by: createdAt, name, completion
```

### 2. MapaCard

Summary card showing mapa status at a glance.

```tsx
interface MapaCardProps {
  mapa: Mapa;
  onClick: () => void;
}

// Visual elements:
// - Name and description
// - Completion progress bar (filled/total slots)
// - Badge: "Complet" (green) or "X documente lipsă" (amber)
// - Template origin indicator (if from template)
// - Created date and author
```

### 3. MapaDetail

Full view of a mapa with all slots.

```tsx
interface MapaDetailProps {
  mapaId: string;
}

// Sections:
// - Header: Name, description, completion status
// - Actions: Edit, Delete, Print (→ OPS-103)
// - Slot list (MapaSlotList)
// - Add slot button
```

### 4. MapaSlotItem

Individual slot row showing status and assigned document.

```tsx
interface MapaSlotItemProps {
  slot: MapaSlot;
  onAssign: () => void;
  onUnassign: () => void;
  onEdit: () => void;
  onDelete: () => void;
  isDragging?: boolean;
}

// Visual states:
// 1. Empty required slot:
//    - Red/amber indicator
//    - Slot name
//    - "Lipsă" badge
//    - "Adaugă document" button
//
// 2. Empty optional slot:
//    - Gray indicator
//    - Slot name
//    - "Opțional" badge
//    - "Adaugă document" button
//
// 3. Filled slot:
//    - Green checkmark
//    - Slot name
//    - Document info (name, type, date)
//    - Preview thumbnail (if available)
//    - "Schimbă" / "Elimină" actions
//
// Drag handle for reordering
```

### 5. DocumentAssignModal

Modal to select a document for a slot.

```tsx
interface DocumentAssignModalProps {
  isOpen: boolean;
  onClose: () => void;
  caseId: string;
  slotId: string;
  slotName: string;
  onAssign: (caseDocumentId: string) => void;
}

// Features:
// - Search/filter case documents
// - Show documents not already in mapa slots (optional filter)
// - Document preview on hover
// - Category grouping
```

### 6. MapaCreateModal

Modal for creating a new mapa.

```tsx
interface MapaCreateModalProps {
  isOpen: boolean;
  onClose: () => void;
  caseId: string;
  onCreated: (mapa: Mapa) => void;
}

// Options:
// 1. Create blank mapa (name + optional description)
// 2. Create from template (template selector + name override)
//
// Template selector shows:
// - Template name
// - Number of slots
// - Slot preview (expandable)
```

## Hook: useMapa

```typescript
// apps/web/src/hooks/useMapa.ts

export function useMapa(mapaId?: string) {
  // Queries
  const {
    data: mapa,
    loading,
    refetch,
  } = useQuery(GET_MAPA, {
    variables: { id: mapaId },
    skip: !mapaId,
  });

  // Mutations
  const [createMapa] = useMutation(CREATE_MAPA);
  const [createFromTemplate] = useMutation(CREATE_MAPA_FROM_TEMPLATE);
  const [updateMapa] = useMutation(UPDATE_MAPA);
  const [deleteMapa] = useMutation(DELETE_MAPA);
  const [assignDocument] = useMutation(ASSIGN_DOCUMENT);
  const [unassignDocument] = useMutation(UNASSIGN_DOCUMENT);
  const [addSlot] = useMutation(ADD_SLOT);
  const [updateSlot] = useMutation(UPDATE_SLOT);
  const [deleteSlot] = useMutation(DELETE_SLOT);
  const [reorderSlots] = useMutation(REORDER_SLOTS);

  return {
    mapa,
    loading,
    refetch,
    createMapa,
    createFromTemplate,
    updateMapa,
    deleteMapa,
    assignDocument,
    unassignDocument,
    addSlot,
    updateSlot,
    deleteSlot,
    reorderSlots,
  };
}

export function useCaseMape(caseId: string) {
  const { data, loading, refetch } = useQuery(GET_CASE_MAPE, {
    variables: { caseId },
    skip: !caseId,
  });

  return {
    mape: data?.caseMape ?? [],
    loading,
    refetch,
  };
}

export function useMapaTemplates() {
  const { data, loading } = useQuery(GET_MAPA_TEMPLATES);

  return {
    templates: data?.mapaTemplates ?? [],
    loading,
  };
}
```

## UI/UX Guidelines

### Romanian Labels

```typescript
const labels = {
  mapa: 'Mapă',
  mape: 'Mape',
  createMapa: 'Crează mapă',
  createFromTemplate: 'Crează din șablon',
  createBlank: 'Mapă goală',
  addSlot: 'Adaugă poziție',
  addDocument: 'Adaugă document',
  removeDocument: 'Elimină document',
  changeDocument: 'Schimbă document',
  required: 'Obligatoriu',
  optional: 'Opțional',
  missing: 'Lipsă',
  complete: 'Complet',
  incomplete: 'Incomplet',
  documentsPresent: 'documente prezente',
  documentsMissing: 'documente lipsă',
  noMape: 'Nu există mape pentru acest dosar',
  printMapa: 'Tipărește mapa',
  deleteMapa: 'Șterge mapa',
  confirmDelete: 'Ești sigur că vrei să ștergi această mapă?',
  slotName: 'Denumire poziție',
  slotDescription: 'Descriere',
  slotCategory: 'Categorie',
  selectDocument: 'Selectează document',
  searchDocuments: 'Caută documente...',
};
```

### Visual Design

1. **Completion indicator**: Progress bar with percentage
2. **Slot status icons**:
   - ✅ Green checkmark: Document assigned
   - ⚠️ Amber warning: Required but missing
   - ○ Gray circle: Optional and empty
3. **Drag-and-drop**: Use `@dnd-kit` for slot reordering
4. **Document preview**: Thumbnail + name + type icon

## Acceptance Criteria

- [ ] MapaList shows all mape for a case
- [ ] MapaCard displays completion status
- [ ] MapaDetail shows all slots with status
- [ ] Can create blank mapa
- [ ] Can create mapa from template
- [ ] Can add/edit/delete slots
- [ ] Can assign/unassign documents to slots
- [ ] Can reorder slots via drag-and-drop
- [ ] All labels in Romanian
- [ ] Responsive design (mobile-friendly)
- [ ] Loading and error states

## Files to Create

- `apps/web/src/components/mapa/*.tsx` (all components)
- `apps/web/src/hooks/useMapa.ts`
- `apps/web/src/app/cases/[id]/mape/page.tsx`

## Integration Points

- Add "Mape" tab to case detail page navigation
- Link from case overview "Documente" section
