# OPS-228: Fix Search - Graceful Fallback to Full-Text

**Type**: Bug | **Priority**: P0-Critical | **Status**: Resolved

## Problem

Search returns no results because HYBRID mode fails when `VOYAGE_API_KEY` is not set. The `Promise.all` in `hybridSearch()` fails entirely when semantic search throws an error, even though full-text search would work perfectly.

**Error**: `VOYAGE_API_KEY environment variable is not set`

**Impact**: Search is completely broken in any environment without Voyage AI API key.

## Root Cause

In `search.service.ts:727`, `hybridSearch()` uses `Promise.all()`:

```typescript
const [fullTextResults, semanticResults] = await Promise.all([
  this.fullTextSearch(query, firmId, filters, limit * 2, 0),
  this.semanticSearch(query, firmId, filters, limit * 2, 0), // <- throws if no API key
]);
```

When `semanticSearch()` throws, the entire Promise.all rejects.

## Solution

Replace `Promise.all` with `Promise.allSettled` to gracefully handle semantic search failures:

```typescript
const [fullTextResult, semanticResult] = await Promise.allSettled([
  this.fullTextSearch(query, firmId, filters, limit * 2, 0),
  this.semanticSearch(query, firmId, filters, limit * 2, 0),
]);

const fullTextResults = fullTextResult.status === 'fulfilled' ? fullTextResult.value : [];
const semanticResults = semanticResult.status === 'fulfilled' ? semanticResult.value : [];

// Log warning if semantic failed
if (semanticResult.status === 'rejected') {
  console.warn(
    '[Search Service] Semantic search unavailable, using full-text only:',
    semanticResult.reason?.message
  );
}
```

## Done When

- [x] Search works when `VOYAGE_API_KEY` is not set
- [x] Full-text results return correctly
- [x] Warning logged when semantic search unavailable
- [x] No breaking changes to API response format

## Files

- `services/gateway/src/services/search.service.ts` - Modify `hybridSearch()` method (~line 727)

## Testing

```bash
# Remove VOYAGE_API_KEY from .env, restart gateway
# Open app, Cmd+K, search for "Imobiliare"
# Should return client result
```

## Notes

This is a quick fix to unblock search. Full semantic search removal is tracked in OPS-229.
