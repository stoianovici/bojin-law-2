# OPS-244: Cost Breakdown & Charts Page

**Type**: Feature
**Priority**: P2-Medium
**Status**: Completed
**Epic**: AI Batch Processing & Ops Dashboard

## Problem

No detailed view of where AI costs are going. Can't identify which features or users consume most resources.

## Solution

Create `/admin/ai-ops/costs` page with detailed breakdowns and visualizations.

### Page Layout

```
┌─────────────────────────────────────────────────────────────┐
│  Detalii Costuri                    [Ultimele 30 zile ▼]   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  COST PE FUNCȚIONALITATE                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ████████████████████████████░░░░░░  Asistent Chat  │   │
│  │  €28.45 (60.1%)                                      │   │
│  │                                                      │   │
│  │  ████████░░░░░░░░░░░░░░░░░░░░░░░░░░  Index Căutare  │   │
│  │  €5.82 (12.3%)                                       │   │
│  │                                                      │   │
│  │  ██████░░░░░░░░░░░░░░░░░░░░░░░░░░░░  Briefing-uri   │   │
│  │  €4.21 (8.9%)                                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  COST PE UTILIZATOR                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Utilizator        Conversații  Tokeni    Cost      │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │  Maria Popescu          89      245K     €7.82      │   │
│  │  Ion Ionescu            67      189K     €6.04      │   │
│  │  Admin                  45      156K     €4.98      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [Exportă CSV]                                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Components

1. **Date Range Selector**
   - Preset options: 7 zile, 30 zile, 90 zile, An curent
   - Custom date picker

2. **Feature Breakdown Chart**
   - Horizontal bar chart with percentages
   - Click to drill down into feature

3. **User Usage Table**
   - Sortable columns
   - Token counts and costs
   - Note: No chat content logged, only metrics

4. **Export Function**
   - CSV export with all data
   - Include date range in filename

## Acceptance Criteria

- [x] Feature breakdown with horizontal bar chart
- [x] Percentages and absolute values shown
- [x] User breakdown table with sortable columns
- [x] Date range selector with presets
- [x] CSV export functional
- [x] Loading states while fetching
- [x] Empty state if no data

## Files Created

- `apps/web/src/app/admin/ai-ops/costs/page.tsx` - Main costs page
- `apps/web/src/components/admin/FeatureBreakdownChart.tsx` - Recharts horizontal bar chart
- `apps/web/src/components/admin/UserUsageTable.tsx` - Sortable user cost table
- `apps/web/src/components/admin/DateRangeSelector.tsx` - Date range selector with presets
- `apps/web/src/hooks/useAICosts.ts` - GraphQL hooks for cost data

## Implementation Notes

### Hook: useAICosts

- Queries: `aiCostsByFeature`, `aiCostsByUser`, `aiUsageOverview`, `aiDailyCosts`
- Uses Apollo Client with cache-and-network policy
- Combined hook for page-level data fetching

### FeatureBreakdownChart

- Uses Recharts BarChart with vertical layout
- Color-coded bars with custom tooltip
- Legend with cost and percentage

### UserUsageTable

- Sortable by userName, cost, tokens, calls
- Footer row with totals
- Privacy note about only logging metrics

### DateRangeSelector

- Presets: 7 days, 30 days, 90 days, This year
- Custom date picker with popover
- Uses Radix UI Select and Popover

### CSV Export

- BOM prefix for Excel UTF-8 compatibility
- Includes both feature and user sections
- Filename includes date range

## Dependencies

- OPS-241 (GraphQL schema) - ✅ Complete
- OPS-242 (Admin layout) - ✅ Complete

## Parallel Work

Can be done in parallel with OPS-243, OPS-245, OPS-246.
