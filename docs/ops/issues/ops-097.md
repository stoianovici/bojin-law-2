# OPS-097: AI Task Creation with Editable Duration Card

## Summary

When creating tasks via AI assistant, display an editable confirmation card with a required duration field. User cannot confirm task creation without specifying estimated hours.

## Background

Currently, AI task creation shows a read-only preview card with Confirm/Reject buttons. To enable workload visualization (OPS-098), we need duration data for all tasks.

Instead of AI asking "how long?" in a separate message (slow, tedious), we show an interactive card where the user must fill in the duration before confirming.

## Requirements

### Acceptance Criteria

1. AI create_task action includes `editableFields` with required `estimatedHours`
2. ActionConfirmCard renders editable fields with validation
3. Confirm button disabled until all required fields are filled
4. Quick duration chips: 1h, 2h, 4h, 8h for fast selection
5. AI provides type-based suggestion (e.g., "~4 ore pentru cercetare")
6. Modifications passed to `confirmAction` mutation and merged into task

### User Flow

```
User: "Creează o sarcină de cercetare pentru dosarul Popescu"
     ↓
AI Response with editable card:
┌────────────────────────────────────────────┐
│ Confirmați crearea sarcinii?               │
│                                            │
│ Titlu: Cercetare jurisprudență             │
│ Dosar: Popescu v. SRL                      │
│ Tip: Cercetare                             │
│ Data: 27 Dec 2025                          │
│                                            │
│ ┌────────────────────────────────────────┐ │
│ │ ⏱ Durată estimată *                    │ │
│ │                                        │ │
│ │ [1h] [2h] [4h] [8h]                    │ │
│ │                                        │ │
│ │ sau: [____] ore                        │ │
│ │                                        │ │
│ │ Sugestie: ~4 ore (cercetare)           │ │
│ └────────────────────────────────────────┘ │
│                                            │
│  [Anulează]        [Confirmă] (disabled)   │
└────────────────────────────────────────────┘
     ↓
User clicks "4h" chip or enters value
     ↓
Confirmă button enables, user clicks
     ↓
Task created with estimatedHours: 4
```

## Implementation

### Type Changes

```typescript
// stores/assistant.store.ts
interface EditableField {
  key: string; // e.g., "estimatedHours"
  label: string; // e.g., "Durată estimată"
  type: 'number' | 'text' | 'select';
  required: boolean;
  placeholder?: string;
  suggestion?: string;
  defaultValue?: unknown;
  quickOptions?: { value: number | string; label: string }[];
}

interface ProposedAction {
  // ... existing fields
  editableFields?: EditableField[];
}
```

### Files to Modify

1. **stores/assistant.store.ts** - Add EditableField type to ProposedAction
2. **components/assistant/ActionConfirmCard.tsx** - Render editable fields with validation
3. **hooks/useAssistant.ts** - Pass modifications object to confirmAction
4. **services/gateway/src/services/ai-tools.schema.ts** - Add editableFields to create_task response
5. **services/gateway/src/services/action-executor.service.ts** - Merge modifications into task payload
6. **services/gateway/src/graphql/schema/ai.graphql** - Add EditableField GraphQL type

### AI Tool Schema

```typescript
// When AI creates task without user-provided duration
{
  type: "create_task",
  displayText: "Creez sarcină de cercetare...",
  payload: { title, caseId, type, dueDate, ... },
  entityPreview: { Titlu: "...", Dosar: "...", ... },
  editableFields: [{
    key: "estimatedHours",
    label: "Durată estimată",
    type: "number",
    required: true,
    placeholder: "ore",
    suggestion: "~4 ore pentru sarcini de cercetare",
    quickOptions: [
      { value: 1, label: "1h" },
      { value: 2, label: "2h" },
      { value: 4, label: "4h" },
      { value: 8, label: "8h" }
    ]
  }],
  requiresConfirmation: true
}
```

### Duration Suggestions by Type

| Task Type         | Suggested Duration |
| ----------------- | ------------------ |
| Research          | ~4 ore             |
| DocumentCreation  | ~2 ore             |
| DocumentRetrieval | ~1 oră             |
| CourtDate         | durata ședinței    |
| Meeting           | ~1 oră             |
| BusinessTrip      | durata deplasării  |

## Priority

P1-High (enables OPS-098)

## Related Issues

- OPS-095: Task Date/Time Simplification
- OPS-096: Task Card Display Redesign
- OPS-098: Duration-Based Calendar Card Spanning (depends on this)

---

## Session Log

### Session 1 (2025-12-22)

**Status**: Implementation Complete - Ready for Verification

**Work Done**:

1. Added `EditableField` and `QuickOption` types to `assistant.store.ts`
2. Updated GraphQL schema (`ai-assistant.graphql`) with `EditableField` and `QuickOption` types
3. Updated `useAssistant.ts` GraphQL fragment to fetch editableFields
4. Completely rewrote `ActionConfirmCard.tsx` to:
   - Render editable fields with quick option chips (1h, 2h, 4h, 8h)
   - Show manual input with number input field
   - Display AI suggestions for duration
   - Disable Confirm button until required fields are filled
   - Pass modifications to onConfirm callback
5. Updated `AssistantChat.tsx` to pass modifications from ActionConfirmCard to confirmAction
6. Updated AI assistant resolver (`ai-assistant.resolvers.ts`) to:
   - Add `getEditableFields()` function that returns editableFields for create_task
   - Include duration suggestions based on task type
7. Updated `confirmAction` mutation to pass modifications to AI service
8. Updated `ai-assistant.service.ts`:
   - Modified `confirmAction()` to accept and merge modifications
   - Modified `executeCreateTask()` to extract and use estimatedHours from input

**Files Modified**:

- `apps/web/src/stores/assistant.store.ts`
- `apps/web/src/components/assistant/ActionConfirmCard.tsx`
- `apps/web/src/components/assistant/AssistantChat.tsx`
- `apps/web/src/hooks/useAssistant.ts`
- `services/gateway/src/graphql/schema/ai-assistant.graphql`
- `services/gateway/src/graphql/resolvers/ai-assistant.resolvers.ts`
- `services/gateway/src/services/ai-assistant.service.ts`

**Verification Status**:

- [ ] Local test with production data
- [ ] Preflight check
- [ ] Docker preview test
