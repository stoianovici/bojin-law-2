# OPS-038: Contacts & Metadata in Case Flow

**Status:** Open | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-18

## Overview

Enable setting case contacts and classification metadata upfront in the case creation flow and case details edit.

## Dependencies

- **Depends on:** OPS-035 (data model for referenceNumbers, classificationKeywords)
- **Blocks:** OPS-041
- **Parallel with:** OPS-039, OPS-040

## Context

Part of the Communications Architecture Rethink. Contacts and case metadata must be set upfront to enable accurate email classification.

**Key change:** Case creation = T0. No historical email import. Contacts set at creation determine which future emails are routed to this case.

## Requirements

### 1. New Case Modal - Step 2: Contacts

Add a required step in the case creation flow:

```
┌────────────────────────────────────────────────┐
│  Dosar nou                          Pas 2 / 3  │
├────────────────────────────────────────────────┤
│  Contacte                                      │
│                                                │
│  Client *                                      │
│  ┌──────────────────────────────────────────┐  │
│  │ Ion Popescu                              │  │
│  │ ion.popescu@email.com                    │  │
│  │ +40 721 123 456                          │  │
│  └──────────────────────────────────────────┘  │
│                                 [+ Adaugă]     │
│                                                │
│  Parte adversă (opțional)                      │
│  ┌──────────────────────────────────────────┐  │
│  │ SC Beta SRL                              │  │
│  │ contact@beta.ro, legal@beta.ro           │  │
│  └──────────────────────────────────────────┘  │
│                                 [+ Adaugă]     │
│                                                │
│  Număr dosar instanță (opțional)              │
│  ┌──────────────────────────────────────────┐  │
│  │ 123/45/2025                              │  │
│  └──────────────────────────────────────────┘  │
│  [+ Adaugă număr]                              │
│                                                │
│           [Înapoi]  [Continuă]                 │
└────────────────────────────────────────────────┘
```

**Validation:**

- At least one Client contact required
- Email format validation
- Reference number format validation (optional)

### 2. Case Details - Contacts Section

Enhance existing ActorsManagement to include:

- Reference numbers (array, add/remove)
- Classification keywords (array, add/remove)
- Multiple email addresses per contact

```
┌─────────────────────────────────────────────────────────────────┐
│  Contacte & Clasificare                                         │
├─────────────────────────────────────────────────────────────────┤
│  Contacte                                                       │
│  ─────────────────────────────────────────────────────────────  │
│  │ Ion Popescu (Client)            [Editează] [Șterge]      │  │
│  │ ion.popescu@email.com, ion.p@gmail.com                   │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                 [+ Contact]     │
│                                                                 │
│  Numere dosar instanță                                          │
│  ─────────────────────────────────────────────────────────────  │
│  │ 123/45/2025  [×]                                          │  │
│  │ 456/78/2025  [×]                                          │  │
│  [+ Adaugă număr]                                               │
│                                                                 │
│  Cuvinte cheie clasificare                                      │
│  ─────────────────────────────────────────────────────────────  │
│  │ alfa  [×]  │  furnizare  [×]  │  contract  [×]           │  │
│  [+ Adaugă]                                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 3. GraphQL Mutations

```graphql
# Update case metadata
mutation updateCaseMetadata($caseId: ID!, $input: CaseMetadataInput!) {
  updateCaseMetadata(caseId: $caseId, input: $input) {
    id
    referenceNumbers
    classificationKeywords
  }
}

input CaseMetadataInput {
  referenceNumbers: [String!]
  classificationKeywords: [String!]
}
```

### 4. Contact Multiple Emails

Ensure CaseActor supports multiple email addresses:

- Primary email field
- Additional emails in `emailDomains[]` or new `additionalEmails[]` field
- Classification matches any of the emails

## Acceptance Criteria

- [ ] New case modal has contacts step (step 2)
- [ ] Client contact required to create case
- [ ] Reference numbers can be added in case creation
- [ ] Case details has Contacts & Classification section
- [ ] Reference numbers editable (add/remove)
- [ ] Classification keywords editable (add/remove)
- [ ] Multiple emails per contact supported
- [ ] GraphQL mutations work
- [ ] No TypeScript errors

## Files to Modify

- `apps/web/src/components/case/CreateCaseModal.tsx` - add step 2
- `apps/web/src/components/case/ActorsManagement.tsx` - enhance
- `packages/database/prisma/schema.prisma` - if CaseActor needs additionalEmails
- `services/gateway/src/graphql/schema/case.graphql`
- `services/gateway/src/graphql/resolvers/case.resolver.ts`
- New: `apps/web/src/components/case/CaseMetadataEditor.tsx`

## Estimated Scope

Medium-Large - Multi-step modal + new UI sections.

---

## Session Log

_(Add session notes here as work progresses)_
