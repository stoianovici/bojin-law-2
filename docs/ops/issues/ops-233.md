# OPS-233: AI Call Wrapper with Usage Logging

**Type**: Feature
**Priority**: P1-High
**Status**: Completed
**Epic**: AI Batch Processing & Ops Dashboard

## Problem

AI calls are scattered across services with no central logging. Can't track costs or enforce limits.

## Solution

Create `AIClient` wrapper class that:

- Wraps all Anthropic API calls
- Calculates token costs based on model
- Logs every call to `AIUsageLog`
- Checks feature enabled status before calling
- Respects budget limits (returns error if exceeded)
- Updates Redis running totals for real-time dashboard

Replace direct Anthropic SDK usage with this wrapper.

### Cost Calculation

```typescript
// Costs in EUR per 1M tokens (converted from USD at ~0.92 rate)
const MODEL_COSTS = {
  'claude-3-haiku-20240307': { input: 0.23, output: 1.15 },
  'claude-sonnet-4-20250514': { input: 2.76, output: 13.8 },
  'claude-opus-4-20250514': { input: 13.8, output: 69.0 },
};

function calculateCostEur(model: string, inputTokens: number, outputTokens: number): number {
  const costs = MODEL_COSTS[model];
  return (inputTokens * costs.input + outputTokens * costs.output) / 1_000_000;
}
```

### Interface

```typescript
interface AICallOptions {
  feature: string; // 'assistant_chat', 'search_index', etc.
  userId?: string; // null for batch jobs
  firmId: string;
  entityType?: string; // 'document', 'case', etc.
  entityId?: string;
  batchJobId?: string;
}

class AIClient {
  async chat(
    messages: Message[],
    options: AICallOptions,
    modelOptions?: { model?: string; maxTokens?: number }
  ): Promise<AIResponse>;
}
```

## Acceptance Criteria

- [x] `AIClient` class with `chat()` method
- [x] Automatic token counting and cost calculation
- [x] Usage logged to database after each call
- [ ] Feature flag check before execution (deferred to OPS-234)
- [ ] Budget limit check before execution (deferred to future PR)
- [x] AI Assistant service migrated to use wrapper
- [x] Unit tests for cost calculation

## Files to Modify

- `services/gateway/src/services/ai-client.service.ts` (new)
- `services/gateway/src/services/ai-orchestrator.service.ts` (update imports)
- `services/gateway/src/services/email-classification.service.ts` (update imports)
- `services/gateway/src/services/case-summary.service.ts` (update imports)
- `services/gateway/src/services/email-thread.service.ts` (update imports)

## Dependencies

- OPS-232 (for AIUsageLog model) - can mock initially

## Parallel Work

Can be done in parallel with OPS-232, OPS-234.
