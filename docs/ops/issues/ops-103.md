# OPS-103: Mapa Print/Export Functionality

**Type:** Feature
**Priority:** P2-Medium
**Status:** Fixed
**Created:** 2024-12-22
**Sessions:** 1
**Last Active:** 2024-12-22

## Session Log

- [2024-12-22] Session 1 started. Implementing print/export functionality for mape.
- [2024-12-22] Created MapaPrintView.tsx component with cover page, TOC, and missing document placeholders
- [2024-12-22] Created usePrintMapa.ts hook with print window generation and styling
- [2024-12-22] Added print dropdown to MapaDetail header with 3 print options
- [2024-12-22] Updated MapaList and case page to pass case info for print headers
- [2024-12-22] All TypeScript compilation passes

#### Local Verification Status

| Step           | Status     | Date | Notes                       |
| -------------- | ---------- | ---- | --------------------------- |
| Prod data test | ⬜ Pending |      | Needs manual verification   |
| Preflight      | ⬜ Pending |      | Needs to run pnpm preflight |
| Docker test    | ⬜ Pending |      | Needs pnpm preview test     |

**Verified**: No (pending local verification)

## Summary

Implement print and export functionality for Mape, including automatic table of contents generation and document compilation.

## Dependencies

- **Requires:** OPS-099 (Mapa Data Model)
- **Requires:** OPS-100 (Mapa Service Layer)
- **Requires:** OPS-102 (Mapa UI Components) - partial, for integration

## Features

### 1. Table of Contents Generation

Automatically generate a formatted TOC for the mapa showing:

- Slot number (roman numerals or sequential)
- Document name (from slot definition)
- Status indicator (present/missing)
- Page number (if generating combined PDF)

### 2. Print Options

```typescript
interface PrintOptions {
  includeTableOfContents: boolean; // Default: true
  includeMissingPlaceholders: boolean; // Show "LIPSĂ" page for missing docs
  pageNumbering: 'continuous' | 'per-document' | 'none';
  headerFooter: boolean; // Include case name, mapa name, date
  format: 'a4' | 'letter';
}
```

### 3. Export Formats

1. **Print-ready HTML** (Primary)
   - Browser-based printing
   - CSS print styles with page breaks
   - Immediate, no server processing

2. **ZIP Download** (Secondary)
   - TOC as PDF/HTML
   - All documents in original format
   - Folder structure preserved

3. **Merged PDF** (Future/Optional)
   - Server-side PDF merging
   - Requires pdf-lib or similar
   - Higher complexity

## Implementation

### A. Print-Ready HTML Component

```tsx
// apps/web/src/components/mapa/MapaPrintView.tsx

interface MapaPrintViewProps {
  mapa: MapaWithSlots;
  options: PrintOptions;
}

export function MapaPrintView({ mapa, options }: MapaPrintViewProps) {
  return (
    <div className="print-container">
      {/* Cover Page */}
      <section className="print-page cover-page">
        <h1>{mapa.name}</h1>
        <p>
          Dosar: {mapa.case.caseNumber} - {mapa.case.title}
        </p>
        <p>Data: {format(new Date(), 'dd MMMM yyyy', { locale: ro })}</p>
      </section>

      {/* Table of Contents */}
      {options.includeTableOfContents && (
        <section className="print-page toc-page">
          <h2>Cuprins</h2>
          <table className="toc-table">
            <thead>
              <tr>
                <th>Nr.</th>
                <th>Document</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {mapa.slots.map((slot, index) => (
                <tr key={slot.id} className={slot.document ? '' : 'missing'}>
                  <td>{toRomanNumeral(index + 1)}</td>
                  <td>{slot.name}</td>
                  <td>{slot.document ? '✓ Prezent' : slot.required ? '✗ Lipsă' : '— Opțional'}</td>
                </tr>
              ))}
            </tbody>
          </table>
          <div className="toc-summary">
            <p>Total poziții: {mapa.slots.length}</p>
            <p>Documente prezente: {mapa.completionStatus.filledSlots}</p>
            <p>
              Documente lipsă:{' '}
              {mapa.completionStatus.totalSlots - mapa.completionStatus.filledSlots}
            </p>
          </div>
        </section>
      )}

      {/* Document placeholders for missing items */}
      {options.includeMissingPlaceholders &&
        mapa.slots
          .filter((s) => !s.document && s.required)
          .map((slot) => (
            <section key={slot.id} className="print-page missing-page">
              <div className="missing-placeholder">
                <h3>{slot.name}</h3>
                <p className="missing-label">DOCUMENT LIPSĂ</p>
                {slot.description && <p>{slot.description}</p>}
              </div>
            </section>
          ))}
    </div>
  );
}
```

### B. Print CSS Styles

```css
/* apps/web/src/styles/print.css */

@media print {
  .print-container {
    font-family: 'Times New Roman', serif;
    font-size: 12pt;
    line-height: 1.5;
  }

  .print-page {
    page-break-after: always;
    min-height: 100vh;
    padding: 2cm;
  }

  .cover-page {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
  }

  .cover-page h1 {
    font-size: 24pt;
    margin-bottom: 2cm;
  }

  .toc-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1cm;
  }

  .toc-table th,
  .toc-table td {
    border-bottom: 1px solid #ccc;
    padding: 0.5em;
    text-align: left;
  }

  .toc-table tr.missing {
    color: #999;
  }

  .missing-page {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .missing-placeholder {
    border: 2px dashed #ccc;
    padding: 2cm;
    text-align: center;
  }

  .missing-label {
    font-size: 18pt;
    color: #c00;
    font-weight: bold;
  }

  /* Hide non-printable elements */
  .no-print {
    display: none !important;
  }
}
```

### C. Print Action Handler

```typescript
// apps/web/src/components/mapa/usePrintMapa.ts

export function usePrintMapa() {
  const printMapa = useCallback(async (
    mapa: MapaWithSlots,
    options: PrintOptions
  ) => {
    // Create print window
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      toast.error('Nu s-a putut deschide fereastra de tipărire');
      return;
    }

    // Generate print HTML
    const printHtml = renderToString(
      <MapaPrintView mapa={mapa} options={options} />
    );

    // Write to print window
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <title>${mapa.name} - Tipărire</title>
          <style>${printStyles}</style>
        </head>
        <body>
          ${printHtml}
        </body>
      </html>
    `);

    printWindow.document.close();
    printWindow.print();
  }, []);

  return { printMapa };
}
```

### D. ZIP Export (Backend)

```typescript
// services/gateway/src/services/mapa-export.service.ts

import archiver from 'archiver';

class MapaExportService {
  async exportAsZip(mapaId: string, userContext: UserContext): Promise<Buffer> {
    const mapa = await mapaService.getMapaWithSlots(mapaId, userContext);

    const archive = archiver('zip', { zlib: { level: 9 } });
    const chunks: Buffer[] = [];

    archive.on('data', (chunk) => chunks.push(chunk));

    // Add TOC
    const tocHtml = this.generateTocHtml(mapa);
    archive.append(tocHtml, { name: 'cuprins.html' });

    // Add documents
    for (const slot of mapa.slots) {
      if (slot.document) {
        const docContent = await this.getDocumentContent(slot.document);
        const filename = `${String(slot.order + 1).padStart(2, '0')}-${slot.name}/${slot.document.fileName}`;
        archive.append(docContent, { name: filename });
      }
    }

    await archive.finalize();

    return Buffer.concat(chunks);
  }

  private generateTocHtml(mapa: MapaWithSlots): string {
    // Generate HTML table of contents
    return `<!DOCTYPE html>
      <html>
        <head><title>Cuprins - ${mapa.name}</title></head>
        <body>
          <h1>${mapa.name}</h1>
          <h2>Cuprins</h2>
          <ol type="I">
            ${mapa.slots
              .map(
                (slot) => `
              <li>
                ${slot.name}
                ${
                  slot.document
                    ? `<span style="color:green">✓</span>`
                    : `<span style="color:red">Lipsă</span>`
                }
              </li>
            `
              )
              .join('')}
          </ol>
        </body>
      </html>`;
  }
}
```

### E. GraphQL Extension

```graphql
# Add to mapa.graphql

input PrintMapaInput {
  mapaId: ID!
  includeTableOfContents: Boolean = true
  includeMissingPlaceholders: Boolean = false
  format: PrintFormat = A4
}

enum PrintFormat {
  A4
  LETTER
}

extend type Query {
  # Get print-ready HTML for mapa
  mapaPrintHtml(input: PrintMapaInput!): String!
}

extend type Mutation {
  # Generate ZIP export (returns download URL)
  exportMapaAsZip(mapaId: ID!): String!
}
```

## UI Integration

### Print Button in MapaDetail

```tsx
// In MapaDetail.tsx

<DropdownMenu>
  <DropdownMenuTrigger asChild>
    <Button variant="outline">
      <PrinterIcon className="w-4 h-4 mr-2" />
      Tipărește
    </Button>
  </DropdownMenuTrigger>
  <DropdownMenuContent>
    <DropdownMenuItem onClick={() => printMapa(mapa, { includeTableOfContents: true })}>
      Cu cuprins
    </DropdownMenuItem>
    <DropdownMenuItem onClick={() => printMapa(mapa, { includeMissingPlaceholders: true })}>
      Cu poziții lipsă
    </DropdownMenuItem>
    <DropdownMenuSeparator />
    <DropdownMenuItem onClick={() => exportZip(mapa.id)}>
      <DownloadIcon className="w-4 h-4 mr-2" />
      Descarcă ZIP
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

## Acceptance Criteria

- [x] Print button in mapa detail view
- [x] TOC generation with slot status
- [x] Print preview shows correctly formatted pages
- [x] Browser print dialog works
- [ ] ZIP export with TOC + documents (future: Phase 2)
- [x] Missing document placeholders (optional)
- [x] Romanian formatting throughout
- [x] Print styles for A4 paper

## Files Created/Modified

- `apps/web/src/components/mapa/MapaPrintView.tsx` ✅ Created
- `apps/web/src/components/mapa/usePrintMapa.ts` ✅ Created (includes inline print styles)
- `apps/web/src/components/mapa/MapaDetail.tsx` ✅ Modified (added print dropdown)
- `apps/web/src/components/mapa/MapaList.tsx` ✅ Modified (pass case info)
- `apps/web/src/components/mapa/index.ts` ✅ Modified (new exports)
- `apps/web/src/app/cases/[caseId]/page.tsx` ✅ Modified (pass case info to MapaList)

## Implementation Notes (Session 1)

### Print Options Available

1. **Cu cuprins** (With TOC) - Full mapa with cover page and table of contents
2. **Cu poziții lipsă** (With missing placeholders) - Adds placeholder pages for missing required documents
3. **Doar cuprins** (TOC only) - Same as option 1 for now

### Print Features

- **Cover Page**: Shows mapa name, case info, generation date, and completion stats
- **Table of Contents**: Lists all slots with Roman numerals, document names, categories, and status (Prezent/Lipsă/Opțional)
- **Missing Placeholders**: Generates "DOCUMENT LIPSĂ" pages for required empty slots
- **Romanian UI**: All labels in Romanian (Cuprins, Completare, Poziții, etc.)
- **A4 Format**: Print styles optimized for A4 paper
- **Auto-print**: Opens print window and automatically triggers browser print dialog

### Future Enhancements (Phase 2)

- Server-side ZIP export with TOC + documents
- PDF merge for combined document
- Page numbering across documents
- Custom cover page templates
- Digital signature integration
