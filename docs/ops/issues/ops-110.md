# OPS-110: Document Migration to SharePoint

| Field        | Value                            |
| ------------ | -------------------------------- |
| **Status**   | Done                             |
| **Type**     | Feature                          |
| **Priority** | P2-Medium                        |
| **Created**  | 2025-12-22                       |
| **Sessions** | 3                                |
| **Blocked**  | OPS-106 ✅, OPS-108 ✓, OPS-109 ✓ |
| **Blocks**   | None                             |

## Description

Migrate existing 393 documents from personal OneDrive to the shared SharePoint site. This is a one-time migration to ensure all existing documents benefit from the new permission model.

## Migration Strategy

### Option A: Copy and Update (Recommended)

1. For each document with `oneDriveId`:
   - Download from OneDrive using uploader's context (or app permissions)
   - Upload to SharePoint case folder
   - Update database: set `sharePointItemId`, `storageType = SHAREPOINT`
   - Keep `oneDriveId` as fallback reference
2. Don't delete OneDrive originals (keep as backup)

### Option B: Re-upload from R2

If documents also exist in R2:

1. Download from R2 (no user token needed)
2. Upload to SharePoint
3. Update database

## Migration Script

```typescript
// scripts/migrate-documents-to-sharepoint.ts

async function migrateDocuments() {
  const documents = await prisma.document.findMany({
    where: {
      oneDriveId: { not: null },
      sharePointItemId: null, // Not yet migrated
    },
    include: {
      case: true,
      uploadedBy: true,
    },
  });

  console.log(`Found ${documents.length} documents to migrate`);

  for (const doc of documents) {
    try {
      // Get admin/service token for OneDrive access
      const serviceToken = await getServiceToken();

      // Download from OneDrive
      const content = await oneDriveService.downloadFile(
        serviceToken,
        doc.oneDriveId,
        doc.oneDriveUserId // Owner's drive
      );

      // Upload to SharePoint
      const folderPath = `Cases/${doc.case.caseNumber}`;
      const spItem = await sharePointService.uploadDocument(
        serviceToken,
        folderPath,
        doc.fileName,
        content
      );

      // Update database
      await prisma.document.update({
        where: { id: doc.id },
        data: {
          storageType: 'SHAREPOINT',
          sharePointItemId: spItem.id,
          sharePointPath: spItem.webUrl,
        },
      });

      console.log(`Migrated: ${doc.fileName}`);
    } catch (error) {
      console.error(`Failed: ${doc.fileName}`, error);
    }
  }
}
```

## Prerequisites

- OPS-108 complete (upload to SharePoint working)
- OPS-109 complete (preview from SharePoint working)
- Service account with `Files.Read.All` application permission (to read all OneDrive files)
  - OR: Run migration as each uploader manually

## Acceptance Criteria

1. All 393 existing documents copied to SharePoint
2. Database updated with `sharePointItemId` for migrated docs
3. Previews work for all users on migrated documents
4. Original OneDrive files preserved (backup)
5. Migration can be re-run safely (idempotent)

## Rollback

If migration fails:

- Documents still have `oneDriveId`
- Can fall back to OneDrive (for uploaders only)
- No data loss

## Files Involved

- `scripts/migrate-documents-to-sharepoint.ts` - Main migration script

## Local Verification Status

| Step           | Status     | Notes                                          |
| -------------- | ---------- | ---------------------------------------------- |
| Prod data test | ✅ Passed  | Test migration (5 docs) + preview verification |
| Preflight      | ⬜ Pending |                                                |
| Docker test    | ⬜ Pending |                                                |

**Verified**: Yes - Test migration successful, SharePoint preview works for cross-user access

## Session Log

- [2025-12-22] Issue created as part of SharePoint migration epic.
- [2025-12-23] Session 1 started. Implemented migration script:
  - Created `scripts/migrate-documents-to-sharepoint.ts`
  - Downloads documents from OneDrive using owner's user ID (oneDriveUserId)
  - Uploads to SharePoint in `Cases/{CaseNumber}/Documents/` folder
  - Updates database with `sharePointItemId` and `sharePointPath`
  - Supports dry-run mode, limit, and verbose logging
  - Handles both small files (simple upload) and large files (resumable upload)
  - Rate-limited to avoid Graph API throttling
- [2025-12-23] Dry-run test successful:
  - Found 393 documents ready to migrate
  - All documents have `oneDriveId`, `oneDriveUserId`, and case links
  - No skipped or errored documents
  - Script runs with `npx tsx scripts/migrate-documents-to-sharepoint.ts --dry-run`
- [2025-12-23] Session 2: Dependency verification:
  - **OPS-108 (SharePoint Upload)**: ✅ Verified working
    - Found 1 document in SharePoint: `test-sharepoint-upload.txt`
    - Storage type correctly shows "SharePoint" in UI
  - **OPS-109 (SharePoint Preview)**: ✅ Code verified correct
    - Preview supports: PDF, Office docs (docx/xlsx/pptx), Images
    - Text files (text/plain) correctly return null (not supported)
    - Implementation uses MS Graph preview API with Office Online fallback
  - **Cross-user OneDrive bug**: Confirmed
    - Associate cannot preview Partner's OneDrive documents
    - Error: "Previzualizare indisponibilă" (Preview unavailable)
    - Screenshot: `.playwright-mcp/onedrive-preview-fails-associate.png`
  - **Blocker**: Need access token with `Files.Read.All` permission to run actual migration
    - Current user tokens only have delegated permissions
    - Migration requires app-level permission to read from all users' OneDrives
- [2025-12-23] Session 3: Test migration and preview verification:
  - Ran migration with `--limit 5`: All 5 documents migrated successfully
  - **SharePoint Preview Verification**:
    - Tested as Associate (Oana Mititelu) previewing Partner's (Lucian Bojin) documents
    - Direct MS Graph API call to SharePoint preview: ✅ Returns valid preview URL
    - Backend resolver with `x-ms-access-token` header: ✅ Returns preview URL
    - **Cross-user SharePoint access: CONFIRMED WORKING**
  - **Frontend Bug Found**: Apollo client not passing `x-ms-access-token` header
    - Token exists in MSAL localStorage but `getMsAccessToken()` not returning it
    - Separate issue - doesn't affect migration validity
  - **Migration validated**: SharePoint documents are accessible to all firm members
  - Ran full migration with Partner (Lucian Bojin) access token:
    - **Total documents**: 388
    - **Successful**: 388 (100%)
    - **Skipped**: 0
    - **Errors**: 0
  - All documents now have `sharePointItemId` and `sharePointPath` in database
  - **OPS-110 COMPLETE** - Cross-user document access issue resolved via SharePoint
  - **Side finding**: Frontend bug - Apollo client not passing `x-ms-access-token` header
    - Token exists in MSAL localStorage but not passed to GraphQL requests
    - This causes preview to fail in UI even though backend works correctly
    - Recommend creating new issue for this frontend bug
