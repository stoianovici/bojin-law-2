# OPS-042: Classification Modal (NECLAR Queue)

**Status:** Open | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-18

## Overview

Build the user-facing classification modal for resolving uncertain email assignments.

## Dependencies

- **Depends on:** OPS-035, OPS-039
- **Blocks:** None
- **Parallel with:** OPS-041

## Context

Part of the Communications Architecture Rethink. When the classification algorithm is uncertain (multi-case contact with ambiguous signals), the email lands in the NECLAR queue. Users resolve these on-demand via a modal.

**Key principle:** User-initiated, not forced. The modal is accessible when the user chooses to address uncertain emails.

## Requirements

### 1. Modal Trigger

From `/communications` page:

- Click on an item in the NECLAR section
- Or click the NECLAR badge/count

### 2. Modal Design

```
┌────────────────────────────────────────────────────────────────┐
│  Clasifică emailul                                        [×]  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ De la: maria.popescu@email.com                           │  │
│  │ Subiect: Documente solicitate                            │  │
│  │ Data: 18 dec 2025, 10:32                                 │  │
│  │                                                          │  │
│  │ Bună ziua,                                               │  │
│  │ Vă trimit documentele solicitate pentru dosarul...       │  │
│  │ [Vezi tot emailul ▼]                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  Maria Popescu are 2 dosare active:                            │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ○ Popescu v. Ionescu                           70% potrivire│
│  │   Indicii: "documente" apare în cuvinte cheie              │
│  │   Ultima activitate: 15 dec 2025                           │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ○ Popescu - Succesiune                         45% potrivire│
│  │   Fără indicii clare                                       │
│  │   Ultima activitate: 2 dec 2025                            │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ○ Alt dosar...                                             │
│  │   Caută sau creează un dosar nou                           │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ○ Ignoră                                                   │
│  │   Emailul nu e relevant pentru niciun dosar                │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                │
│                              [Anulează]  [Confirmă]            │
└────────────────────────────────────────────────────────────────┘
```

### 3. Modal Features

**Email Preview:**

- Sender, subject, date
- First few lines of body
- Expandable to see full email

**Case Options:**

- Suggested cases with confidence percentage
- Signal explanations ("documente" apare în cuvinte cheie)
- Last activity date for context
- Radio button selection

**Other Options:**

- "Alt dosar" - search/select any case
- "Ignoră" - mark as not relevant (IGNORED state)

### 4. Classification Action

```graphql
mutation classifyUncertainEmail($emailId: ID!, $action: ClassificationAction!) {
  classifyUncertainEmail(emailId: $emailId, action: $action) {
    email {
      id
      caseId
      classificationState
    }
  }
}

input ClassificationAction {
  type: ClassificationActionType! # ASSIGN_TO_CASE | IGNORE
  caseId: ID # Required if type is ASSIGN_TO_CASE
}
```

### 5. After Classification

- Email moves from NECLAR to appropriate case section
- Or disappears if ignored
- Toast confirmation: "Email clasificat în Popescu v. Ionescu"

### 6. Batch Classification (Optional Enhancement)

If multiple emails from same sender are uncertain:

- Option to "Aplică pentru toate emailurile de la acest expeditor"
- Classify all at once

## Acceptance Criteria

- [ ] Modal opens when clicking NECLAR item
- [ ] Email preview shows sender, subject, date, body excerpt
- [ ] Suggested cases shown with confidence scores
- [ ] Signal explanations displayed
- [ ] Case search/select for "Alt dosar"
- [ ] Ignore option available
- [ ] Confirm assigns email to selected case
- [ ] Email state updated correctly
- [ ] Email moves to correct section after classification
- [ ] Toast confirmation shown
- [ ] No TypeScript errors

## Files to Modify

- New: `apps/web/src/components/communication/ClassificationModal.tsx`
- New: `apps/web/src/hooks/useClassifyEmail.ts`
- `services/gateway/src/graphql/schema/email-classification.graphql`
- `services/gateway/src/graphql/resolvers/email-classification.resolver.ts`
- Integrate into `apps/web/src/app/communications/page.tsx` (OPS-041)

## Estimated Scope

Medium - Modal component + mutation.

---

## Session Log

_(Add session notes here as work progresses)_
