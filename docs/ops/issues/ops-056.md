# OPS-056: Email Events Not Syncing to Chronology

**Status:** Fixing | **Priority:** P0-Critical | **Type:** Bug
**Created:** 2025-12-19 | **Sessions:** 1 | **Last Active:** 2025-12-19
**Related:** OPS-054 (CaseChronology Integration), OPS-049 (Unified Chronology)

## Summary

Comunicări tab in chronology shows 0 events even though the case has emails. Two issues identified:

1. **Missing classification filter** - Sync was querying all emails with `caseId` but not filtering by `classificationState` (should only sync `Classified` emails)
2. **Auto-sync timing** - Auto-sync only triggered when `totalCount === 0`, so if documents synced first, email sync never ran

## Symptom

- Case has emails visible in Communications tab
- Chronology shows "172 evenimente" (all documents)
- Comunicări tab shows no count badge (0 events)
- Clicking Comunicări tab shows "Nu există comunicări în cronologie"

## Root Cause Analysis

**Investigation confirmed:**

- Email model DOES have `caseId` field (nullable, set when email is classified)
- EmailClassification table is NOT needed - emails have direct `caseId` after classification
- The sync query was missing `classificationState: Classified` filter
- Auto-sync only ran when count was 0, so emails never synced after docs

**Two-part fix:**

1. Filter by `classificationState: Classified` in sync query
2. Change auto-sync to always run once per page load (idempotent)

## Acceptance Criteria

- [x] Email events (EmailReceived, EmailSent, EmailCourt) appear in chronology
- [x] Filter to only sync `Classified` emails (not Pending, Uncertain, etc.)
- [x] Both inbound and outbound emails are properly categorized
- [x] Court emails are identified and marked as EmailCourt
- [x] Sync is idempotent (can run multiple times safely)
- [x] Auto-sync runs on every page load (not just when empty)
- [ ] Comunicări tab shows correct count (needs verification)

## Implementation

### Changes Made

**1. `services/gateway/src/services/case-event.service.ts`**

- Added filter: `classificationState: EmailClassificationState.Classified`
- Added user relation to get user email for direction detection
- Added court domain detection via GlobalEmailSource lookup
- Direction logic: compare `from` address with `user.email`
- Event types: EmailReceived (inbound), EmailSent (outbound), EmailCourt (from court domain)

**2. `apps/web/src/hooks/useCaseEvents.ts`**

- Changed auto-sync from `totalCount === 0` to always run once per mount
- Sync is idempotent (skips existing events), so safe to run multiple times

### Key Logic

```typescript
// Direction detection
const fromAddress = from?.address?.toLowerCase() || '';
const userEmail = email.user?.email?.toLowerCase() || '';

// Court detection via GlobalEmailSource domains
const isFromCourt = courtDomains.some(
  (d) => fromAddress === d || fromDomain === d || fromDomain.endsWith('.' + d)
);

// Event type assignment
if (isFromCourt) {
  eventType = CaseEventType.EmailCourt;
} else if (fromAddress === userEmail) {
  eventType = CaseEventType.EmailSent;
} else {
  eventType = CaseEventType.EmailReceived;
}
```

## Files Modified

- `services/gateway/src/services/case-event.service.ts` - Fixed email sync query with classification filter and direction detection
- `apps/web/src/hooks/useCaseEvents.ts` - Changed auto-sync to always run once

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

## Session Log

- [2025-12-19] Issue created via /ops-investigate. Root cause: sync queries Email.caseId which doesn't exist - emails linked via EmailClassification
- [2025-12-19T10:30] Session 1 started. Investigation found Email model DOES have caseId field, but missing classificationState filter. Also found auto-sync only runs when totalCount === 0.
- [2025-12-19T10:45] Implemented fix:
  1. Added classificationState filter to only sync Classified emails
  2. Added direction detection (compare from vs user email)
  3. Added court email detection via GlobalEmailSource domains
  4. Changed auto-sync to run once per mount (not just when empty)
- [2025-12-19T10:50] TypeScript checks pass for both gateway and web app

---
