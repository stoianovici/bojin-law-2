# OPS-022: Email-to-Case Timeline Integration with Contact Auto-Discovery

| Field           | Value            |
| --------------- | ---------------- |
| **Status**      | In Progress      |
| **Type**        | Feature          |
| **Priority**    | P1-High          |
| **Created**     | 2025-12-14       |
| **Sessions**    | 2                |
| **Last Active** | 2025-12-14 11:00 |

---

## Description

When creating a new case and adding contact emails, the system should:

1. **Retrieve and process emails** into a comprehensive timeline
2. **Import email attachments** as documents into the case's docs panel with AI analysis
3. **Auto-discover contacts** from email participants and allow role assignment (Client, Opposing Party, Opposing Counsel, Witness, Expert)

This feature connects the existing email sync, document management, and CaseActor systems to provide a streamlined case creation experience.

---

## Requirements

### 1. Email Retrieval & Timeline Processing

- When adding contact emails to a case, fetch all email threads involving those contacts
- Process emails into the existing `CaseTimeline` / `UnifiedTimeline` component
- Group emails by conversation thread
- Extract key intelligence using existing AI services:
  - Deadlines (`ExtractedDeadline`)
  - Commitments (`ExtractedCommitment`)
  - Action items (`ExtractedActionItem`)
  - Questions (`ExtractedQuestion`)
  - Risk indicators (`RiskIndicator`)

### 2. Document Import from Attachments

- Automatically import email attachments as `Document` records
- Link documents to case via `CaseDocument` join table
- Trigger AI document processing:
  - Generate embeddings (`DocumentEmbedding`)
  - Extract patterns (`DocumentPattern`)
  - Run intelligence analysis
- Display in existing Documents tab with source indicator (from email)

### 3. Contact Auto-Discovery & Role Assignment

- Parse email threads for unique participants (From, To, CC)
- Present discovered contacts in UI for role assignment
- Role options (using existing `ActorRole` enum):
  - Client
  - OpposingParty
  - OpposingCounsel
  - Witness
  - Expert
- Create `CaseActor` records for assigned contacts
- Deduplicate contacts by email address

---

## Technical Analysis

### Existing Infrastructure to Leverage

**Database Models (Ready):**

- `Email` - Already has `caseId` field for linking
- `EmailAttachment` - Tracks attachments with storage URLs
- `CaseActor` - Supports all required roles
- `CaseDocument` - Many-to-many case-document linking
- `CaseActivityEntry` - For timeline events
- AI extraction models all exist

**Services (Ready):**

- `EmailSyncService` - Can fetch emails by contact address
- `EmailThreadService` - Groups emails into threads
- `EmailAttachmentService` - Handles attachment download/storage
- `CaseActivityService` - Creates timeline entries
- Document upload/processing pipeline exists

**Components (Ready):**

- `CaseTimeline.tsx` / `UnifiedTimeline` - Timeline display
- `ActorsManagement.tsx` - Contact CRUD UI
- `CaseDocumentsList.tsx` - Document display
- `CreateCaseModal.tsx` - Case creation flow

### What Needs to Be Built

1. **Email-to-Case Linker Service**
   - Query emails by participant email addresses
   - Bulk-link emails to case
   - Process attachments into documents
   - Extract contacts from email headers

2. **Contact Discovery Component**
   - Display discovered contacts from emails
   - Role assignment dropdown per contact
   - Bulk create CaseActors

3. **Case Creation Enhancement**
   - Add "Import from Email" step/option
   - Email address input for contact lookup
   - Progress indicator for email/document import

4. **Timeline Integration**
   - Ensure linked emails appear in case timeline
   - Add "email imported" activity entries
   - Show attachment links in email timeline items

---

## Implementation Plan

### Phase 1: Backend Services

1. Create `EmailToCaseService` in `services/gateway/src/services/`
   - `linkEmailsByContact(caseId, emailAddresses[], firmId)` - Find and link emails
   - `extractContacts(emails[])` - Parse unique participants
   - `importAttachmentsAsDocuments(caseId, emails[])` - Process attachments

2. Add GraphQL mutations/queries:
   - `linkEmailsToCase(caseId, emailAddresses)` - Main import mutation
   - `discoverContactsFromEmails(emailAddresses)` - Preview contacts

### Phase 2: Frontend Components

1. Create `EmailImportWizard.tsx` component
   - Step 1: Enter contact email addresses
   - Step 2: Review discovered emails (count, date range)
   - Step 3: Assign roles to discovered contacts
   - Step 4: Confirm and import

2. Integrate with case creation flow
   - Add "ImportÄƒ din Email" button to CreateCaseModal or case detail
   - Show import progress with status updates

### Phase 3: Timeline & Documents Integration

1. Enhance timeline to highlight imported emails
2. Add source indicator ("Din email") to imported documents
3. Trigger AI processing on imported attachments

---

## Local Dev Environment

```bash
# Start all services
cd /Users/mio/Desktop/dev/Bojin-law\ 2
pnpm dev

# Services:
# - Frontend: http://localhost:3000
# - Gateway: http://localhost:4000/graphql
# - Check .env files in apps/web and services/gateway for config
```

---

## Conventions to Follow

From `docs/project-conventions.md`:

- **Romanian UI text** - All user-facing labels in Romanian
- **Section dividers** - Use `// ====` to organize code sections
- **Service singleton pattern** - Export singleton instances
- **UserContext pattern** - Include userId, role, firmId in service methods
- **firmId filtering** - All queries must be tenant-isolated
- **Audit logging** - Create CaseAuditLog entries for modifications
- **clsx for classes** - Use clsx, not template literals
- **'use client'** - Required for client components

---

## Session Log

- [2025-12-14 09:00] Issue created. Initial triage complete. Comprehensive codebase analysis performed. All required infrastructure exists (Email, Document, CaseActor, Timeline models and services). Feature requires connecting existing systems with new wizard UI and backend service.
- [2025-12-14 11:00] Session 2 started. Beginning implementation Phase 1: Backend services.
- [2025-12-14 11:45] Phases 1-3 complete. Created:
  - Backend: `email-to-case.service.ts` (preview + execute import)
  - GraphQL: `email-import.graphql` schema, `email-import.resolvers.ts`
  - Frontend: `useEmailImport.ts` hook (wizard state management)
  - UI: `EmailImportWizard.tsx` (4-step wizard modal)
  - Integration: Added wizard button to `CommunicationsTab.tsx`
  - All files compile without errors. Ready for local testing.
- [2025-12-14 12:00] Session 2 ended. Full implementation complete. State: All code compiles, feature integrated into CommunicationsTab. Next: Local testing with `pnpm dev`, then deployment.

---

## Files Involved

### To Modify

- `apps/web/src/components/case/CreateCaseModal.tsx` - Add import option
- `apps/web/src/components/case/tabs/CommunicationsTab.tsx` - Timeline integration
- `services/gateway/src/graphql/resolvers/case.resolvers.ts` - Add mutations
- `services/gateway/src/graphql/schema/case.graphql` - Add types

### To Create

- `services/gateway/src/services/email-to-case.service.ts` - Core service
- `apps/web/src/components/case/EmailImportWizard.tsx` - Import wizard UI
- `apps/web/src/hooks/useEmailImport.ts` - Frontend hook

### Reference (Existing)

- `packages/database/prisma/schema.prisma` - Data models
- `services/gateway/src/services/email-sync.service.ts` - Email fetching
- `services/gateway/src/services/email-attachment.service.ts` - Attachment handling
- `apps/web/src/components/case/ActorsManagement.tsx` - Contact UI reference
- `apps/web/src/components/case/CaseTimeline.tsx` - Timeline component

---
