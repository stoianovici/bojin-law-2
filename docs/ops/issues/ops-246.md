# OPS-246: Budget Controls & Alerts Page

**Type**: Feature
**Priority**: P2-Medium
**Status**: Completed
**Epic**: AI Batch Processing & Ops Dashboard

## Problem

No way to set spending limits or receive alerts when thresholds exceeded. Risk of unexpected AI costs.

## Solution

Create `/admin/ai-ops/budget` page with budget configuration and alert settings.

### Page Layout

```
┌─────────────────────────────────────────────────────────────┐
│  Buget & Alerte                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  BUGET LUNAR                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Limită buget:  [€100.00    ]                       │   │
│  │                                                      │   │
│  │  Cheltuială curentă: €47.32 (47.3%)                 │   │
│  │  ████████████████████████░░░░░░░░░░░░░░░░░░ 47%     │   │
│  │                                                      │   │
│  │  Estimare sfârșit lună: €58.90                      │   │
│  │  ████████████████████████████░░░░░░░░░░░░░░ 59%     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  PRAGURI ALERTE                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [✓] Alertă email la 75% din buget                  │   │
│  │  [✓] Alertă email la 90% din buget                  │   │
│  │  [✓] Pauză automată funcții non-esențiale la 100%   │   │
│  │  [ ] Webhook Slack pentru toate alertele            │   │
│  │      URL: [____________________________________]    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  LIMITE PE FUNCȚIONALITATE                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Asistent AI Chat:     [€50/lună ] (curent: €28.45) │   │
│  │  Index Căutare:        [€15/lună ] (curent: €5.82)  │   │
│  │  Briefing-uri:         [€10/lună ] (curent: €4.21)  │   │
│  │  Clasificare Email:    [€10/lună ] (curent: €3.89)  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [Salvează Setări]                                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Budget Gauge Component

```tsx
function BudgetGauge({ spent, limit, projected }: BudgetGaugeProps) {
  const percentSpent = (spent / limit) * 100;
  const percentProjected = (projected / limit) * 100;

  return (
    <div className="space-y-4">
      {/* Current spend */}
      <div>
        <div className="flex justify-between text-sm mb-1">
          <span>Cheltuială curentă</span>
          <span>
            €{spent.toFixed(2)} ({percentSpent.toFixed(1)}%)
          </span>
        </div>
        <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
          <div
            className={clsx(
              'h-full rounded-full',
              percentSpent > 90
                ? 'bg-red-500'
                : percentSpent > 75
                  ? 'bg-yellow-500'
                  : 'bg-green-500'
            )}
            style={{ width: `${Math.min(percentSpent, 100)}%` }}
          />
        </div>
      </div>

      {/* Projected */}
      <div>
        <div className="flex justify-between text-sm mb-1">
          <span>Estimare sfârșit lună</span>
          <span>€{projected.toFixed(2)}</span>
        </div>
        <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
          <div
            className={clsx(
              'h-full rounded-full',
              percentProjected > 100
                ? 'bg-red-500'
                : percentProjected > 90
                  ? 'bg-yellow-500'
                  : 'bg-blue-500'
            )}
            style={{ width: `${Math.min(percentProjected, 100)}%` }}
          />
        </div>
      </div>
    </div>
  );
}
```

### Alert System Backend

```typescript
// ai-budget-alerts.service.ts
class AIBudgetAlertsService {
  async checkThresholds(firmId: string, newCost: number): Promise<void> {
    const settings = await this.getBudgetSettings(firmId);
    const currentSpend = await aiUsageService.getCurrentMonthSpend(firmId);
    const percent = (currentSpend / settings.monthlyBudgetEur) * 100;

    // Check thresholds
    if (percent >= 75 && settings.alertAt75 && !this.alreadyAlerted(firmId, 75)) {
      await this.sendAlert(firmId, 75, currentSpend, settings.monthlyBudgetEur);
    }
    if (percent >= 90 && settings.alertAt90 && !this.alreadyAlerted(firmId, 90)) {
      await this.sendAlert(firmId, 90, currentSpend, settings.monthlyBudgetEur);
    }
    if (percent >= 100 && settings.autoPauseAt100) {
      await this.pauseNonEssentialFeatures(firmId);
    }
  }

  private async sendAlert(
    firmId: string,
    threshold: number,
    spent: number,
    limit: number
  ): Promise<void> {
    const firm = await prisma.firm.findUnique({ where: { id: firmId } });
    const partners = await prisma.user.findMany({
      where: { firmId, role: 'Partner' },
    });

    for (const partner of partners) {
      await emailService.send({
        to: partner.email,
        subject: `[Legal Platform] Alertă buget AI - ${threshold}%`,
        body: `Bugetul AI a atins ${threshold}% (€${spent.toFixed(2)} din €${limit.toFixed(2)}).`,
      });
    }
  }

  private async pauseNonEssentialFeatures(firmId: string): Promise<void> {
    const nonEssential = ['thread_summaries', 'case_health'];
    for (const feature of nonEssential) {
      await featureConfigService.updateFeatureConfig(firmId, feature, { enabled: false });
    }
  }
}
```

## Acceptance Criteria

- [x] Monthly budget limit input with validation
- [x] Budget gauge showing current spend and projection
- [x] Alert threshold checkboxes (75%, 90%, 100%)
- [x] Auto-pause toggle for non-essential features
- [x] Per-feature budget limits
- [x] Settings saved via GraphQL mutation
- [x] Alert emails sent when thresholds crossed (logging only - email service integration TODO)
- [x] Visual warning when approaching/exceeding budget

## Files to Modify

- `apps/web/src/app/admin/ai-ops/budget/page.tsx` (new)
- `apps/web/src/components/admin/BudgetGauge.tsx` (new)
- `apps/web/src/components/admin/AlertSettings.tsx` (new)
- `apps/web/src/components/admin/FeatureBudgetList.tsx` (new)
- `services/gateway/src/services/ai-budget-alerts.service.ts` (new)

## Dependencies

- OPS-241 (GraphQL schema)
- OPS-242 (Admin layout)
- OPS-233 (AI Client to trigger threshold checks)

## Parallel Work

Can be done in parallel with OPS-243, OPS-244, OPS-245.
