# OPS-238: Morning Briefings Processor (Pre-compute)

**Type**: Feature
**Priority**: P1-High
**Status**: Completed
**Epic**: AI Batch Processing & Ops Dashboard

## Problem

Morning briefings generate on-demand causing slow load times (2-5 seconds). Users wait for AI on every app open.

## Solution

Create `MorningBriefingsProcessor` that pre-generates briefings at 5 AM for instant loading.

### How It Works

1. Run at 5 AM daily (after other processors complete)
2. For each active user in the firm:
   - Gather today's tasks and deadlines
   - Find unread important emails
   - Identify cases needing attention
   - Compile recent activity
3. Generate narrative briefing with Claude
4. Store in `morning_briefings` table (uses existing model)
5. Frontend fetches pre-computed briefing (instant)

### Existing Data Model

The `MorningBriefing` model already exists in the schema. The processor will populate these fields:

```prisma
model MorningBriefing {
  id               String    @id @default(uuid())
  firmId           String    @map("firm_id")
  userId           String    @map("user_id")
  briefingDate     DateTime  @map("briefing_date") @db.Date

  // Pre-computed sections (existing structure)
  prioritizedTasks Json      @map("prioritized_tasks") // Array of { taskId, priority, reason }
  keyDeadlines     Json      @map("key_deadlines")     // Array of upcoming deadlines
  riskAlerts       Json      @map("risk_alerts")       // Array of risk indicators
  suggestions      Json                                 // Array of AI suggestions for the day
  summary          String    @db.Text                   // AI-generated summary paragraph

  // View tracking
  isViewed         Boolean   @default(false) @map("is_viewed")
  viewedAt         DateTime? @map("viewed_at") @db.Timestamptz

  // Metadata
  generatedAt      DateTime  @default(now()) @map("generated_at") @db.Timestamptz
  tokensUsed       Int       @map("tokens_used")

  @@unique([userId, briefingDate])
  @@index([firmId])
  @@index([userId])
  @@index([briefingDate])
}
```

### Data Structures (for processor implementation)

```typescript
// Structure for prioritizedTasks field
interface PrioritizedTask {
  taskId: string;
  title: string;
  caseTitle: string;
  dueAt: string;
  priority: 'high' | 'medium' | 'low';
  reason: string; // AI-generated reason for priority
}

// Structure for keyDeadlines field
interface KeyDeadline {
  type: 'task' | 'court_date' | 'filing';
  title: string;
  caseId: string;
  caseTitle: string;
  dueAt: string;
  daysUntil: number;
}

// Structure for riskAlerts field
interface RiskAlert {
  type: 'overdue' | 'approaching_deadline' | 'unanswered_email' | 'stale_case';
  severity: 'high' | 'medium';
  title: string;
  caseId?: string;
  caseTitle?: string;
  description: string;
}

// Structure for suggestions field
interface AISuggestion {
  type: 'follow_up' | 'review' | 'prepare' | 'delegate';
  title: string;
  description: string;
  caseId?: string;
  priority: 'high' | 'medium' | 'low';
}
```

### Frontend Update

```typescript
// useMorningBriefing.ts
export function useMorningBriefing() {
  const { data, loading } = useQuery(GET_MORNING_BRIEFING, {
    variables: { briefingDate: formatDate(new Date()) }, // matches existing field name
  });

  // If no pre-computed briefing, fall back to on-demand generation (rare)
  // This handles cases where: user wasn't active in last 7 days, or batch job failed
  const [generateBriefing, { loading: generating }] = useMutation(GENERATE_BRIEFING_ON_DEMAND);

  useEffect(() => {
    if (!data?.morningBriefing && !loading) {
      generateBriefing();
    }
  }, [data, loading]);

  return {
    briefing: data?.morningBriefing,
    loading: loading || generating,
  };
}
```

## Acceptance Criteria

- [x] `MorningBriefingsProcessor` implements `BatchProcessor`
- [x] Pre-generated briefings stored with `briefingDate` key
- [x] Briefing populates all existing fields: `prioritizedTasks`, `keyDeadlines`, `riskAlerts`, `suggestions`, `summary`
- [x] Frontend updated to fetch pre-computed briefing
- [x] Fallback to on-demand if no pre-computed exists
- [x] Only process users who logged in within last 7 days
- [x] `summary` field generated in Romanian

## Files to Modify

- `services/gateway/src/batch/processors/morning-briefings.processor.ts` (new)
- `services/gateway/src/graphql/schema/briefing.graphql` (add generateBriefingOnDemand mutation)
- `services/gateway/src/graphql/resolvers/briefing.resolvers.ts` (add on-demand generation resolver)
- `apps/web/src/hooks/useMorningBriefing.ts` (update to use pre-computed with fallback)

**Note:** The `MorningBriefing` model already exists in the schema - no migration needed.

## Dependencies

- OPS-236 (Batch Job Runner Framework)

## Parallel Work

Can be done in parallel with OPS-237, OPS-239, OPS-240.
