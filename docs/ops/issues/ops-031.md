# OPS-031: Classification Review & Correction

**Status:** Complete
**Priority:** P2-Medium
**Type:** Feature (UX Polish)
**Created:** 2025-12-16
**Blocked By:** OPS-030 (resolved)
**Blocks:** OPS-032 (UI integration)

---

## Problem Statement

Even with AI classification, mistakes will happen. Users need:

1. A queue to review emails that couldn't be auto-classified
2. Easy way to move emails between cases after import
3. Audit trail of classification decisions and corrections

This issue completes the classification workflow with post-import tools.

---

## Scope

### 1. Classification Review Queue

New section in Communications or Dashboard: "De clasificat"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  De clasificat                                     (23) â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  FiltreazÄƒ: [Toate â–¾] [Client â–¾] [Motiv â–¾]             â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                         â”‚
â”‚  â–¡ "Re: Documentele solicitate"            Azi 14:32   â”‚
â”‚    De la: client@company.ro                             â”‚
â”‚    Conflict: 2 dosare posibile                          â”‚
â”‚    â”œâ”€â”€ Litigiu Contract (67%)                          â”‚
â”‚    â””â”€â”€ ConsultanÈ›Äƒ Fuziune (61%)                       â”‚
â”‚    [Atribuie la... â–¾]                                   â”‚
â”‚                                                         â”‚
â”‚  â–¡ "CitaÈ›ie termen 15.01.2025"             Ieri 09:15  â”‚
â”‚    De la: registratura@tribunal.ro                      â”‚
â”‚    Motiv: Email instanÈ›Äƒ, numÄƒr dosar negÄƒsit          â”‚
â”‚    ReferinÈ›Äƒ detectatÄƒ: 5678/3/2024                     â”‚
â”‚    [Atribuie la... â–¾] [AdaugÄƒ referinÈ›Äƒ la dosar]      â”‚
â”‚                                                         â”‚
â”‚  â–¡ "FW: Meeting notes"                     12 Dec      â”‚
â”‚    De la: unknown@external.ro                           â”‚
â”‚    Motiv: Contact necunoscut, fÄƒrÄƒ potrivire           â”‚
â”‚    [Atribuie la... â–¾] [IgnorÄƒ]                         â”‚
â”‚                                                         â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  â–¡ SelecteazÄƒ toate                                     â”‚
â”‚  [Atribuie selectate la...] [IgnorÄƒ selectate]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Features:**

- Filter by client, classification reason, date
- Bulk actions for multiple emails
- Quick-assign dropdown with recent cases
- "Add reference to case" action for court emails

### 2. Email Reassignment

In email detail view (within a case):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Email: "Re: Contract modificat"                        â”‚
â”‚  De la: avocat@cabinet.ro                               â”‚
â”‚  Data: 15 Dec 2024                                      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Dosar curent: Litigiu Contract 2023                   â”‚
â”‚                                                         â”‚
â”‚  [MutÄƒ la alt dosar â–¾]                                 â”‚
â”‚    â”œâ”€â”€ ConsultanÈ›Äƒ Fuziune (acelaÈ™i client)            â”‚
â”‚    â”œâ”€â”€ Recuperare CreanÈ›Äƒ (acelaÈ™i client)             â”‚
â”‚    â”œâ”€â”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚    â”œâ”€â”€ CautÄƒ dosar...                                  â”‚
â”‚    â””â”€â”€ EliminÄƒ din dosar (marcheazÄƒ ignorat)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Move confirmation dialog:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MutÄƒ email la alt dosar                               â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Email: "Re: Contract modificat"                        â”‚
â”‚  De la: Litigiu Contract 2023                          â”‚
â”‚  La: ConsultanÈ›Äƒ Fuziune                               â”‚
â”‚                                                         â”‚
â”‚  Motiv mutare (opÈ›ional):                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Emailul se referÄƒ la fuziune, nu la litigiu    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                         â”‚
â”‚  â–¡ MutÄƒ È™i ataÈ™amentele asociate                       â”‚
â”‚  â–¡ AdaugÄƒ expeditorul ca actor Ã®n noul dosar           â”‚
â”‚                                                         â”‚
â”‚  [AnuleazÄƒ] [MutÄƒ email]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Audit Trail

Track all classification decisions:

```prisma
model EmailClassificationLog {
  id              String   @id @default(cuid())
  emailId         String
  email           Email    @relation(fields: [emailId], references: [id])

  action          ClassificationAction  // ASSIGNED, MOVED, IGNORED

  fromCaseId      String?
  fromCase        Case?    @relation("FromCase", fields: [fromCaseId], references: [id])
  toCaseId        String?
  toCase          Case?    @relation("ToCase", fields: [toCaseId], references: [id])

  // Classification context
  wasAutomatic    Boolean              // AI assigned vs human
  confidence      Float?               // If AI assigned
  matchType       String?              // actor, reference, keyword, semantic

  // Human correction
  correctionReason String?

  // Audit
  performedBy     String
  user            User     @relation(fields: [performedBy], references: [id])
  performedAt     DateTime @default(now())

  @@index([emailId])
  @@index([toCaseId])
  @@index([performedAt])
}

enum ClassificationAction {
  ASSIGNED        // Initial assignment (import)
  MOVED           // Moved between cases
  IGNORED         // Marked as not case-related
  UNASSIGNED      // Removed from case without reassigning
}
```

**View in case activity:**

```
Activitate Dosar:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“§ 15 Dec 14:32 - Email mutat din "Litigiu Contract"
   "Re: Contract modificat" de la avocat@cabinet.ro
   Motiv: Emailul se referÄƒ la fuziune
   De cÄƒtre: Maria Avocat
```

### 4. Classification Insights (Optional Enhancement)

Dashboard widget showing classification health:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Clasificare Emailuri - Ultima sÄƒptÄƒmÃ¢nÄƒ               â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Clasificate automat:        847  (89%)                â”‚
â”‚  Revizuite manual:            78  (8%)                 â”‚
â”‚  Mutate dupÄƒ import:          12  (1%)                 â”‚
â”‚  Ãn aÈ™teptare:                23  (2%)                 â”‚
â”‚                                                         â”‚
â”‚  AcurateÈ›e AI: 94% (bazat pe corecÈ›ii)                 â”‚
â”‚                                                         â”‚
â”‚  Sugestii:                                              â”‚
â”‚  â€¢ AdÄƒugaÈ›i "5678/3/2024" la Dosar Ionescu (3 emailuri)â”‚
â”‚  â€¢ Contact nou frecvent: expert@evaluare.ro            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Acceptance Criteria

**Backend & Components (OPS-031 scope):**

- [x] Prisma schema: EmailClassificationLog, PendingClassification models
- [x] GraphQL schema: Full CRUD for queue, reassignment, audit
- [x] Resolvers: All query/mutation implementations
- [x] Frontend hook: useClassificationReview with typed operations
- [x] ClassificationQueue component with filters, assign, dismiss
- [x] EmailReassignDialog component with case search, options
- [x] TypeScript compilation passes

**UI Integration (deferred to OPS-032):**

- [ ] Review queue rendered in /communications
- [ ] Sidebar badge showing pending count
- [ ] Move action in email detail views

---

## GraphQL Operations

```graphql
# Review queue
query GetClassificationQueue(
  clientId: ID
  reason: ClassificationReason
  limit: Int
  offset: Int
): ClassificationQueueResult!

type ClassificationQueueResult {
  items: [UnclassifiedEmail!]!
  total: Int!
}

type UnclassifiedEmail {
  email: Email!
  reason: ClassificationReason!
  suggestedCases: [CaseSuggestion!]!
  detectedReferences: [String!]
}

enum ClassificationReason {
  MULTI_CASE_CONFLICT
  LOW_CONFIDENCE
  NO_MATCHING_CASE
  COURT_NO_REFERENCE
  UNKNOWN_CONTACT
}

# Reassignment
mutation MoveEmailToCase(
  emailId: ID!
  toCaseId: ID!
  reason: String
  moveAttachments: Boolean
  addSenderAsActor: Boolean
): MoveEmailResult!

mutation IgnoreEmail(emailId: ID!): Boolean!

mutation BulkAssignEmails(
  emailIds: [ID!]!
  caseId: ID!
): BulkAssignResult!

# Audit
query GetEmailClassificationHistory(
  emailId: ID!
): [EmailClassificationLog!]!

query GetCaseClassificationActivity(
  caseId: ID!
  limit: Int
): [EmailClassificationLog!]!
```

---

## Files to Create/Modify

### New Files

- `apps/web/src/components/communication/ClassificationQueue.tsx`
- `apps/web/src/components/communication/EmailReassignDialog.tsx`
- `apps/web/src/hooks/useClassificationQueue.ts`
- `services/gateway/src/graphql/schema/classification-review.graphql`
- `services/gateway/src/graphql/resolvers/classification-review.resolvers.ts`
- `services/gateway/src/services/email-classification-audit.service.ts`

### Modified Files

- `packages/database/prisma/schema.prisma` (add EmailClassificationLog)
- `apps/web/src/components/communication/EmailDetail.tsx` (add move action)
- `apps/web/src/components/layout/Sidebar.tsx` (add queue link if items pending)
- `services/gateway/src/services/email-to-case.service.ts` (log actions)

---

## Edge Cases

1. **Move email with replies** - Option to move entire thread
2. **Move to closed case** - Warning, require confirmation
3. **Circular moves** - Track in audit, no special handling needed
4. **Bulk move 100+ emails** - Progress indicator, background job
5. **Delete case with moved emails** - Audit log preserved

---

## Session Log

### Session 1 (2025-12-16)

- [16:00] Session 1 started. OPS-030 verified - blocker removed
- [16:45] Prisma schema: Added EmailClassificationLog, PendingClassification models with enums
- [16:50] GraphQL schema: Created classification-review.graphql with full CRUD operations
- [17:00] Resolvers: Built classification-review.resolvers.ts with queue, move, assign operations
- [17:15] Frontend hook: Created useClassificationReview.ts with typed queries/mutations
- [17:25] Components: Created ClassificationQueue.tsx and EmailReassignDialog.tsx
- [17:30] TypeScript compilation successful
- [17:35] **Marked complete** - UI integration deferred to OPS-032

**Files Created:**

- `packages/database/prisma/schema.prisma` - EmailClassificationLog, PendingClassification, enums
- `services/gateway/src/graphql/schema/classification-review.graphql` - Full GraphQL schema
- `services/gateway/src/graphql/resolvers/classification-review.resolvers.ts` - All resolvers
- `apps/web/src/hooks/useClassificationReview.ts` - Hooks with typed queries/mutations
- `apps/web/src/components/communication/ClassificationQueue.tsx` - Queue UI component
- `apps/web/src/components/communication/EmailReassignDialog.tsx` - Move dialog component
