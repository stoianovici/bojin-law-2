# OPS-114: Permanent Document Thumbnails

## Summary

Store document thumbnails permanently in R2 instead of relying on expiring Microsoft Graph API URLs. This eliminates the 1-hour TTL issue and provides faster grid loading via CDN.

## Problem

Current thumbnail system has limitations:

1. **Expiring URLs**: Microsoft Graph thumbnail URLs expire after ~1 hour
2. **Auth required**: Each thumbnail fetch needs user access token
3. **No R2 thumbnails**: Documents stored in R2 (email attachments) only get thumbnails if they're images
4. **Grid latency**: Multiple Graph API calls slow down document grid loading

## Solution

Generate thumbnails once (using Microsoft's API for SharePoint/OneDrive docs) and store permanently in R2 with direct CDN access.

## Architecture

```
On Document Upload:
  1. Upload document to SharePoint/OneDrive/R2
  2. Queue background job for thumbnail generation
  3. Background worker:
     a. If SharePoint/OneDrive → Fetch thumbnail from Graph API
     b. If R2 Image → Generate with Sharp
     c. If R2 PDF → (Phase 2) Generate with pdf2pic
  4. Download/generate thumbnail image
  5. Upload to R2: thumbnails/{documentId}/{size}.jpg
  6. Update Document record with permanent URLs

On Grid Load:
  - Return permanent R2 URLs (no auth, no expiry)
  - Fallback to file-type icon if not yet generated
```

## Implementation Plan

### Phase 1: Core Infrastructure

1. **Database Schema**
   - Add to Document model:
     ```prisma
     thumbnailSmallUrl   String?   // R2 permanent URL
     thumbnailMediumUrl  String?   // R2 permanent URL
     thumbnailLargeUrl   String?   // R2 permanent URL
     thumbnailStatus     ThumbnailStatus @default(PENDING)
     thumbnailError      String?
     ```
   - Enum: `PENDING`, `PROCESSING`, `COMPLETED`, `FAILED`, `NOT_SUPPORTED`

2. **Thumbnail Storage Service**
   - `uploadThumbnail(documentId, size, buffer)` → R2 URL
   - `getThumbnailUrl(documentId, size)` → URL or null
   - Path pattern: `thumbnails/{documentId}/small.jpg`

3. **Background Job**
   - Use existing BullMQ infrastructure
   - Job: `generateDocumentThumbnail`
   - Retry with backoff on failure
   - Mark as `NOT_SUPPORTED` for unsupported types

4. **Upload Hook**
   - After successful document upload, queue thumbnail job
   - Don't block upload on thumbnail generation

### Phase 2: Migration & R2 PDFs

5. **Migration Script**
   - Process existing documents in batches
   - Prioritize recently accessed documents
   - Run as background task, not blocking

6. **PDF Thumbnail Generation** (Optional)
   - Add `pdf2pic` or `pdfjs-dist` dependency
   - Generate first-page thumbnail for R2 PDFs
   - Requires: poppler-utils in Docker image

### Phase 3: Optimization

7. **CDN Headers**
   - Set long cache-control on R2 thumbnails
   - Consider R2 public bucket for thumbnails

8. **Cleanup**
   - Remove old Redis thumbnail cache logic
   - Remove on-demand Graph API thumbnail calls

## File Changes

### New Files

- `services/gateway/src/services/thumbnail-storage.service.ts`
- `services/gateway/src/jobs/generate-thumbnail.job.ts`
- `packages/database/prisma/migrations/XXX_add_thumbnail_urls/`

### Modified Files

- `packages/database/prisma/schema.prisma` - Document model
- `services/gateway/src/services/thumbnail.service.ts` - Orchestration
- `services/gateway/src/graphql/resolvers/document.resolvers.ts` - Return permanent URLs
- `apps/web/src/hooks/useDocumentGrid.ts` - Use new URL fields

## Thumbnail Sizes

| Size   | Dimensions | Use Case                     |
| ------ | ---------- | ---------------------------- |
| Small  | 48×48      | List views, compact UI       |
| Medium | 200×200    | Grid cards                   |
| Large  | 800×800    | Hover preview, expanded view |

## Supported File Types

| Type                          | Phase 1          | Phase 2    |
| ----------------------------- | ---------------- | ---------- |
| Images (JPEG, PNG, GIF, WebP) | ✅ Sharp         | ✅         |
| SharePoint/OneDrive PDFs      | ✅ Graph API     | ✅         |
| SharePoint/OneDrive Office    | ✅ Graph API     | ✅         |
| R2 PDFs                       | ❌ Icon fallback | ✅ pdf2pic |
| R2 Office docs                | ❌ Icon fallback | ❌         |

## Success Metrics

- [ ] Document grid loads without Graph API calls for thumbnails
- [ ] Thumbnails persist beyond 1-hour Microsoft TTL
- [ ] 90%+ of documents have thumbnails within 5 minutes of upload
- [ ] Grid load time reduced by 50%+

## Risks & Mitigations

| Risk                         | Mitigation                                    |
| ---------------------------- | --------------------------------------------- |
| R2 storage cost              | ~15KB per document (3 sizes) - negligible     |
| Migration takes too long     | Process in background, prioritize recent docs |
| Microsoft API rate limits    | Batch processing with delays                  |
| PDF generation CPU intensive | Phase 2, optional, use worker queue           |

## Testing

- [ ] Unit: Thumbnail storage service
- [ ] Unit: Background job processing
- [ ] Integration: Upload → thumbnail generated → grid displays
- [ ] E2E: Document grid shows thumbnails after upload

## References

- OPS-111: Document Grid UI with Thumbnails (current implementation)
- OPS-109: Document Preview from SharePoint
- Ideation session: "load docs preview in thumbnail"

---

## Session Log

### 2024-12-23 - Issue Created

- Created from `/ops-ideate` exploration of "load docs preview in thumbnail"
- Evaluated 4 approaches:
  - A: Self-hosted PDF rendering (heavy)
  - B: Hybrid Microsoft + local (medium)
  - C: Store permanent thumbnails (selected) ✅
  - D: Lazy on-demand generation (complex)
- Option C chosen for best balance of effort vs. impact
