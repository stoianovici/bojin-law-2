# OPS-106: SharePoint Service Layer

| Field        | Value                     |
| ------------ | ------------------------- |
| **Status**   | Fixed                     |
| **Type**     | Feature                   |
| **Priority** | P1-High                   |
| **Created**  | 2025-12-22                |
| **Blocked**  | None (OPS-105 complete)   |
| **Blocks**   | OPS-108, OPS-109, OPS-110 |

## Description

Create a new SharePoint service that handles document operations using the firm's SharePoint site instead of personal OneDrive. This service will be the backend foundation for all document storage operations.

## Implementation

### New File: `services/gateway/src/services/sharepoint.service.ts`

```typescript
class SharePointService {
  // Upload document to SharePoint
  async uploadDocument(
    accessToken: string,
    caseNumber: string,
    fileName: string,
    content: Buffer
  ): Promise<SharePointItem>;

  // Get preview URL for document
  async getPreviewUrl(accessToken: string, itemId: string): Promise<PreviewInfo>;

  // Get download URL for document
  async getDownloadUrl(accessToken: string, itemId: string): Promise<string>;

  // Get thumbnail URLs (small, medium, large)
  async getThumbnails(accessToken: string, itemId: string): Promise<ThumbnailSet>;

  // Create case folder if not exists
  async ensureCaseFolder(accessToken: string, caseNumber: string): Promise<string>;

  // List documents in case folder
  async listCaseDocuments(accessToken: string, caseNumber: string): Promise<SharePointItem[]>;

  // Delete document
  async deleteDocument(accessToken: string, itemId: string): Promise<void>;

  // Move document between folders
  async moveDocument(
    accessToken: string,
    itemId: string,
    destinationPath: string
  ): Promise<SharePointItem>;
}
```

### Graph Endpoints to Add (`graph.config.ts`)

```typescript
sharepoint: {
  siteRoot: () => `/sites/${SHAREPOINT_SITE_ID}`,
  siteDrive: () => `/sites/${SHAREPOINT_SITE_ID}/drive`,
  siteDriveRoot: () => `/sites/${SHAREPOINT_SITE_ID}/drive/root`,
  siteDriveItem: (itemId: string) => `/sites/${SHAREPOINT_SITE_ID}/drive/items/${itemId}`,
  siteDriveItemContent: (itemId: string) => `/sites/${SHAREPOINT_SITE_ID}/drive/items/${itemId}/content`,
  siteDriveItemPreview: (itemId: string) => `/sites/${SHAREPOINT_SITE_ID}/drive/items/${itemId}/preview`,
  siteDriveItemThumbnails: (itemId: string) => `/sites/${SHAREPOINT_SITE_ID}/drive/items/${itemId}/thumbnails`,
  siteDriveItemByPath: (path: string) => `/sites/${SHAREPOINT_SITE_ID}/drive/root:/${path}`,
  siteDriveChildren: (itemId: string) => `/sites/${SHAREPOINT_SITE_ID}/drive/items/${itemId}/children`,
}
```

## Files Affected

**New:**

- `services/gateway/src/services/sharepoint.service.ts`

**Modified:**

- `services/gateway/src/config/graph.config.ts` - add SharePoint endpoints
- `services/gateway/src/config/env.ts` - add SHAREPOINT_SITE_ID, SHAREPOINT_DRIVE_ID

## Acceptance Criteria

1. SharePoint service can upload files to case folders
2. Service can generate preview URLs for documents
3. Service can generate download URLs
4. Service can retrieve thumbnails (small, medium, large)
5. Service creates case folders on-demand
6. All methods use site-based endpoints (not /me/drive)

## Parallelization

Can be developed in parallel with:

- OPS-107 (GraphQL schema) - different files
- OPS-111 (UI components) - can mock backend

## Session Log

- [2025-12-22] Issue created as part of SharePoint migration epic.
- [2025-12-22] Session 1: Implemented SharePoint service layer.
  - Added SharePoint endpoints to `graph.config.ts`
  - Added Sites.ReadWrite.All scope for delegated permissions
  - Created `sharepoint.service.ts` with all methods:
    - `ensureCaseFolder()` - Creates /Cases/{CaseNumber}/Documents/ structure
    - `uploadDocument()` - Simple and resumable upload support
    - `getPreviewUrl()` - PDF, Office, and image preview URLs
    - `getDownloadUrl()` - Direct download links
    - `getThumbnails()` - Small, medium, large thumbnails
    - `listCaseDocuments()` - List documents in case folder
    - `deleteDocument()` - Delete document
    - `moveDocument()` - Move between folders
    - `getFileMetadata()` - Get item metadata
  - Service compiles without errors
