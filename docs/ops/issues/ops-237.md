# OPS-237: Search Index Processor (Nightly)

**Type**: Feature
**Priority**: P1-High
**Status**: Completed
**Epic**: AI Batch Processing & Ops Dashboard

## Problem

Search fails for partial queries like "act constit. tt solaria" because PostgreSQL full-text requires exact word matches. Users expect web-like search behavior.

## Solution

Create `SearchIndexProcessor` that uses Claude to generate rich search terms for each document/case.

### How It Works

1. Query documents/cases modified since last successful run
2. For each entity, send to Claude (Haiku) with extraction prompt
3. Store generated terms in `search_terms` field
4. Update search queries to include enriched terms

### Claude Prompt

```
Analizează acest document și generează termeni de căutare în română.

Titlu: {title}
Descriere: {description}
Nume fișier: {fileName}

Returnează un JSON cu:
- abbreviations: abrevieri comune (ex: "act constit" pentru "act constitutiv")
- alternates: variante de scriere, greșeli frecvente
- entities: companii, persoane, instituții menționate
- tags: categorii semantice (tip document, domeniu juridic)

Exemplu output:
{
  "abbreviations": ["act constit", "ac", "const"],
  "alternates": ["constitutiv", "constitutiva"],
  "entities": ["TT Solaria SRL", "Solaria"],
  "tags": ["constituire societate", "SRL", "act fondare"]
}
```

### Schema Update

```prisma
model Document {
  // ... existing fields
  searchTerms   String?   // Space-separated terms for tsvector
  searchTermsUpdatedAt DateTime?
}

model Case {
  // ... existing fields
  searchTerms   String?
  searchTermsUpdatedAt DateTime?
}
```

### Updated Search Query

```sql
SELECT ...
FROM documents d
WHERE to_tsvector('simple',
  COALESCE(d.file_name, '') || ' ' ||
  COALESCE(d.search_terms, '') || ' ' ||  -- NEW: AI-generated terms
  COALESCE(d.metadata->>'description', '')
) @@ plainto_tsquery('simple', $query)
```

## Acceptance Criteria

- [x] `SearchIndexProcessor` implements `BatchProcessor`
- [x] Claude prompt generates useful search terms in Romanian
- [x] `search_terms` field added to documents and cases
- [x] Incremental processing (only new/modified since last run)
- [x] Search service updated to include `search_terms` in tsvector
- [ ] Test: "act constit. tt solaria" finds "Act Constitutiv TT Solaria SRL.docx" (requires running processor on real data)
- [ ] Test: "popescu ion" finds "Ion Popescu" in case contacts (requires running processor on real data)

## Files to Modify

- `services/gateway/src/batch/processors/search-index.processor.ts` (new)
- `services/gateway/src/services/search.service.ts` (update queries)
- `packages/database/prisma/schema.prisma` (add searchTerms fields)

## Dependencies

- OPS-236 (Batch Job Runner Framework)

## Parallel Work

Can be done in parallel with OPS-238, OPS-239, OPS-240.
