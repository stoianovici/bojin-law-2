# OPS-301: useGroupedBriefFeed Hook

**Type**: Feature
**Priority**: P1-High
**Platform**: Mobile
**Status**: Completed
**Complexity**: M (Medium)
**Created**: 2025-12-27

## Problem

The current `useBriefFeed` hook returns a flat list of activity items. Users must scroll through everything to find what matters. The feed doesn't surface priority items or organize by relevance.

## Solution

Create a hook that takes BriefFeed items and groups them into meaningful sections based on urgency, ownership, and recency.

## Sections

| Key       | Romanian Label      | Contents                                                 | Default State |
| --------- | ------------------- | -------------------------------------------------------- | ------------- |
| `urgent`  | "Urgente"           | Deadlines within 48h, high-priority items, overdue tasks | **Expanded**  |
| `myCases` | "Dosarele mele"     | Items from cases where user is lead or assigned          | **Expanded**  |
| `team`    | "Activitate echipă" | Items from other team members                            | Collapsed     |
| `archive` | "Mai vechi"         | Items older than 24 hours                                | Collapsed     |

## Implementation

### Interface

```typescript
interface BriefSection {
  key: string;
  title: string; // Romanian label
  items: BriefItem[];
  count: number;
  defaultExpanded: boolean;
}

interface GroupedBriefFeed {
  sections: BriefSection[];
  totalCount: number;
  loading: boolean;
  error?: ApolloError;
  refetch: () => Promise<void>;
}

function useGroupedBriefFeed(options?: { limit?: number }): GroupedBriefFeed;
```

### Grouping Logic

```typescript
function groupItems(items: BriefItem[], userId: string): BriefSection[] {
  const now = new Date();
  const yesterday = subHours(now, 24);
  const in48Hours = addHours(now, 48);

  // Urgent: deadlines within 48h or overdue
  const urgent = items.filter(
    (item) =>
      item.deadline &&
      (isBefore(new Date(item.deadline), in48Hours) || isBefore(new Date(item.deadline), now))
  );

  // My cases: user is actor or assignee
  const myCases = items.filter((item) => item.actorId === userId || item.assigneeId === userId);

  // Team: not my activity, recent
  const team = items.filter(
    (item) => item.actorId !== userId && isAfter(new Date(item.occurredAt), yesterday)
  );

  // Archive: older than 24h
  const archive = items.filter((item) => isBefore(new Date(item.occurredAt), yesterday));

  return [
    { key: 'urgent', title: 'Urgente', items: urgent, count: urgent.length, defaultExpanded: true },
    {
      key: 'myCases',
      title: 'Dosarele mele',
      items: myCases,
      count: myCases.length,
      defaultExpanded: true,
    },
    {
      key: 'team',
      title: 'Activitate echipă',
      items: team,
      count: team.length,
      defaultExpanded: false,
    },
    {
      key: 'archive',
      title: 'Mai vechi',
      items: archive,
      count: archive.length,
      defaultExpanded: false,
    },
  ].filter((section) => section.count > 0); // Hide empty sections
}
```

### Deduplication Strategy

Items may qualify for multiple sections (e.g., urgent + myCases). Strategy:

- Each item appears in **highest priority section only**
- Priority order: urgent > myCases > team > archive
- Use Set to track already-categorized item IDs

## Files

- `apps/web/src/hooks/useGroupedBriefFeed.ts` (new)

## Dependencies

- `useBriefFeed` - existing hook for raw data
- `useSession` - for current user ID
- `date-fns` - for date comparisons

## Blocked By

- None (Phase 1 - can start immediately)

## Blocks

- OPS-302: FeedSection Component
- OPS-304: MobileHome Sectioned Feed Integration

## Done Criteria

- [x] Hook returns `GroupedBriefFeed` interface
- [x] Groups items into 4 sections with correct logic
- [x] Empty sections are excluded from output
- [x] No duplicate items across sections
- [x] "Urgente" and "Dosarele mele" have `defaultExpanded: true`
- [x] Memoized grouping for performance
- [x] Passes through loading/error/refetch from underlying hook
- [x] Unit tests for grouping logic

## Session Log

### Session 2025-12-27

**Status**: Pending → Completed

**Done**:

- Created `useGroupedBriefFeed.ts` hook with grouping logic
- Items grouped into 4 sections: Urgente, Dosarele mele, Activitate echipă, Mai vechi
- Implemented deduplication (items appear in highest priority section only)
- Priority order: urgent > myCases > team > archive
- Empty sections automatically excluded
- Memoized for performance
- Passes through loading/error/refetch from underlying `useBriefFeed`
- Created comprehensive test suite (21 tests, all passing)

**Key Implementation Notes**:

- `isUrgent`: DEADLINE_SET items created within last 48 hours (since BriefItem doesn't have a separate deadline date field)
- `isMyCases`: Items where actorId matches current user
- `isRecent`: Items within last 24 hours (used for team activity)
- Uses `useAuth` to get current user ID

**Files Created**:

- `apps/web/src/hooks/useGroupedBriefFeed.ts`
- `apps/web/src/hooks/useGroupedBriefFeed.test.ts`
