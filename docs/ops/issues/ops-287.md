# OPS-287: Timesheet Manual Total with Discount Export

| Field        | Value      |
| ------------ | ---------- |
| **Status**   | Verifying  |
| **Type**     | Feature    |
| **Priority** | P2-Medium  |
| **Created**  | 2025-12-27 |

## Goal

Allow Partners to manually input a custom total amount in the timesheet. When the manual total differs from the calculated total, the difference appears as a discount line on the PDF/clipboard export.

## User Story

As a Partner reviewing a timesheet for invoicing, I want to enter a custom total amount (e.g., to give a client a discount or round the invoice) so that the export shows the original calculated amount with a discount line.

## Example

**Calculated total**: 5,250.00 RON (15 hours × 350 RON/hour)
**Partner enters**: 5,000.00 RON
**Export shows**:

```
Ore lucrate:                    15.00 ore
Subtotal:                    5,250.00 RON
Discount:                     -250.00 RON
─────────────────────────────────────────
TOTAL:                       5,000.00 RON
```

## Implementation

### 1. UI: Manual Total Input in TimesheetTotals

**File**: `apps/web/src/components/team-activity/TimesheetTotals.tsx`

Add editable total field for Partners:

- Show calculated total as default
- Allow clicking to edit (like hours editing)
- Show discount badge when manual < calculated
- Reset button to clear manual override

### 2. State: Track Manual Override

**File**: `apps/web/src/components/team-activity/TimesheetEditor.tsx`

Add state for manual total:

```typescript
const [manualTotal, setManualTotal] = useState<number | null>(null);

const discount = manualTotal !== null ? totals.totalBillableCost - manualTotal : 0;
```

### 3. Export: Include Discount Line

**File**: `apps/web/src/utils/timesheet-pdf.ts`

Update PDF generation to include discount:

```typescript
if (discount > 0) {
  // Add subtotal line
  doc.text(`Subtotal: ${formatCurrency(subtotal)} RON`);
  // Add discount line
  doc.text(`Discount: -${formatCurrency(discount)} RON`);
}
// Final total
doc.text(`TOTAL: ${formatCurrency(finalTotal)} RON`);
```

**File**: `apps/web/src/utils/timesheet-clipboard.ts`

Update clipboard format similarly.

### 4. Props Threading

Pass discount info through component chain:

- TimesheetEditor → TimesheetHeader (for export)
- TimesheetEditor → TimesheetTotals (for input)

## Verification

- [ ] Partner can click on total to edit
- [ ] Manual total less than calculated shows discount
- [ ] Manual total greater than calculated shows "Surplus" (or reject?)
- [ ] PDF export includes discount line when applicable
- [ ] Clipboard export includes discount line
- [ ] Reset button clears manual override
- [ ] Non-Partners cannot edit total (read-only)

## Design Decisions

1. **Discount only, no surcharge**: If manual > calculated, show warning and don't allow (prevents billing errors)
2. **Session-only**: Manual override not persisted to database (per-export adjustment)
3. **Billable only**: Discount applies to billable total, not full total

## Session Log

| Date       | Summary                                                                           |
| ---------- | --------------------------------------------------------------------------------- |
| 2025-12-27 | Initial feature specification                                                     |
| 2025-12-27 | Implemented: manual total state, editable input, discount in PDF/clipboard export |
