# OPS-285: Dual Database Infrastructure with CLI Switching

**Type**: Infra | **Priority**: P2-Medium | **Status**: Ready

## Problem

Developers can only have one local database state. Switching between production data (debugging) and seed data (testing) requires reimporting or reseeding, losing the previous state and taking several minutes.

## Solution

Create two databases in the same PostgreSQL container with CLI commands to switch:

1. **Init script** creates `legal_platform_prod` and `legal_platform_seed` on container startup
2. **Switch script** updates `DATABASE_URL` in env files
3. **NPM scripts** provide `pnpm db:use:prod` and `pnpm db:use:seed`
4. **Setup integration** seeds the seed DB by default, adds prod import option

## Implementation

### 1. Database Initialization Script

Create `infrastructure/docker/init-scripts/03-init-dual-databases.sql`:

```sql
-- Create seed database (primary development)
CREATE DATABASE legal_platform_seed;
\c legal_platform_seed
CREATE EXTENSION IF NOT EXISTS vector;

-- Create prod database (for production data import)
CREATE DATABASE legal_platform_prod;
\c legal_platform_prod
CREATE EXTENSION IF NOT EXISTS vector;

-- Keep legal_platform_dev as alias for backwards compatibility
-- (already created by existing init scripts)
```

### 2. Switch Script

Create `scripts/switch-db.sh`:

```bash
#!/bin/bash
# Usage: ./scripts/switch-db.sh [prod|seed]

DB_NAME=$1
if [[ "$DB_NAME" != "prod" && "$DB_NAME" != "seed" ]]; then
  echo "Usage: pnpm db:use:prod OR pnpm db:use:seed"
  exit 1
fi

TARGET_DB="legal_platform_$DB_NAME"

# Update .env.local
sed -i '' "s|legal_platform_[a-z]*|$TARGET_DB|g" .env.local 2>/dev/null || true

# Update services/gateway/.env
sed -i '' "s|legal_platform_[a-z]*|$TARGET_DB|g" services/gateway/.env 2>/dev/null || true

# Update apps/web/.env.local (if it has DATABASE_URL)
sed -i '' "s|legal_platform_[a-z]*|$TARGET_DB|g" apps/web/.env.local 2>/dev/null || true

echo "✅ Switched to database: $TARGET_DB"
echo "   Restart your dev server to apply changes."
```

### 3. NPM Scripts

Add to root `package.json`:

```json
{
  "scripts": {
    "db:use:prod": "./scripts/switch-db.sh prod",
    "db:use:seed": "./scripts/switch-db.sh seed",
    "db:import:prod": "./scripts/switch-db.sh prod && pnpm db:restore"
  }
}
```

### 4. Setup Script Integration

Update `scripts/setup-local-dev.sh` to:

- Default to `legal_platform_seed` database
- Run seed data into seed database
- Add option to import prod backup into prod database

## Database Naming

```
legal_platform_seed  ← default for dev, contains seed data
legal_platform_prod  ← for production data import
legal_platform_dev   ← existing, kept for backwards compatibility
```

## Done When

- [x] Both databases created on fresh `docker compose up`
- [x] `pnpm db:use:seed` switches to seed database (updates .env files)
- [x] `pnpm db:use:prod` switches to prod database
- [x] Current database shown in terminal output after switch
- [x] `pnpm setup` populates seed DB with seed data
- [x] Production import handled in setup script (prompts user)
- [x] Existing `legal_platform_dev` remains functional (backwards compat)

## Files

- `infrastructure/docker/init-scripts/03-init-dual-databases.sql` - **new**
- `scripts/switch-db.sh` - **new**
- `package.json` - **modify**
- `scripts/setup-local-dev.sh` - **modify**

## Technical Notes

**Rejected alternatives**:

- Separate Docker volumes: Requires container restart (~5s)
- Two PostgreSQL containers: 2x memory usage (~400MB extra)
- PostgreSQL schemas: Prisma migration complications with schema parameter

## Session Log

- 2024-12-27: Issue created from /ops-ideate exploration
- 2024-12-27: Implemented dual database infrastructure
  - Created `03-init-dual-databases.sql` init script
  - Created `scripts/switch-db.sh` for database switching
  - Added npm scripts: `db:use:seed`, `db:use:prod`, `db:use:dev`, `db:which`
  - Updated `setup-local-dev.sh` to apply migrations to all DBs, seed the seed DB, and optionally import prod data
  - Tested switching between databases - works correctly
