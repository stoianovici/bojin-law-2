# OPS-199: Production Data Reset - Full Wipe & Fresh Start

**Status:** Ready | **Priority:** P1-High | **Type:** Migration | **Created:** 2025-12-24

## Overview

Complete production data reset: wipe all cases, documents, emails, clients, tasks, and AI conversations. Archive SharePoint files. Users will re-sync emails from Outlook and classify from scratch with the new UX.

## Dependencies

- **Depends on:** ALL previous issues in this epic (OPS-187 to OPS-198)
- **Blocks:** None
- **Parallel with:** None (must be last)

## Context

The platform has accumulated experimental data from classification testing. A fresh start is needed to properly use the new conservative classification approach. Emails are recoverable from Outlook; SharePoint files will be archived.

## What Gets Deleted

| Entity                   | Action      | Notes                       |
| ------------------------ | ----------- | --------------------------- |
| **Cases**                | DELETE      | All cases and related data  |
| **Clients**              | DELETE      | Will be recreated as needed |
| **Documents**            | DELETE (DB) | SharePoint files archived   |
| **Emails**               | DELETE      | Re-syncs from Outlook       |
| **EmailAttachments**     | DELETE      | Re-syncs with emails        |
| **EmailCaseLinks**       | DELETE      | Junction table              |
| **Tasks**                | DELETE      | Including standalone tasks  |
| **AI Conversations**     | DELETE      | Fresh conversation history  |
| **CaseSummaries**        | DELETE      | Regenerated on demand       |
| **CommunicationEntries** | DELETE      | Timeline entries            |
| **ThreadSummaries**      | DELETE      | AI-generated summaries      |
| **PersonalContacts**     | KEEP        | User preferences            |
| **Users**                | KEEP        | Authentication still works  |
| **Firms**                | KEEP        | Organization structure      |

## What's Recoverable

| Data               | Source             | How                       |
| ------------------ | ------------------ | ------------------------- |
| Emails             | Outlook/Graph      | Auto re-sync              |
| Email Attachments  | Outlook/Graph      | Re-sync with emails       |
| Calendar Events    | Outlook            | Still in Outlook          |
| Uploaded Documents | SharePoint Archive | Manual recovery if needed |

## Requirements

### 1. Pre-Migration Checklist

- [ ] All OPS-187 to OPS-198 deployed and verified
- [ ] Production database backup taken
- [ ] SharePoint archive folder created
- [ ] Maintenance window scheduled (recommend off-hours)
- [ ] Team notified
- [ ] Rollback procedure documented

### 2. SharePoint Archive

Before DB wipe, archive SharePoint files:

```typescript
// Archive structure
SharePoint Site/
‚îú‚îÄ‚îÄ Documents/              ‚Üê Will be empty after migration
‚îú‚îÄ‚îÄ _Archive_2024-12-24/    ‚Üê All existing files moved here
‚îÇ   ‚îú‚îÄ‚îÄ [case-id-1]/
‚îÇ   ‚îú‚îÄ‚îÄ [case-id-2]/
‚îÇ   ‚îî‚îÄ‚îÄ ...
```

```typescript
async function archiveSharePointFiles() {
  const archiveFolderName = `_Archive_${new Date().toISOString().split('T')[0]}`;

  // Create archive folder
  await sharePointService.createFolder(archiveFolderName);

  // Get all case folders
  const caseFolders = await sharePointService.listFolders('Documents');

  // Move each to archive
  for (const folder of caseFolders) {
    await sharePointService.moveFolder(
      `Documents/${folder.name}`,
      `${archiveFolderName}/${folder.name}`
    );
    console.log(`Archived: ${folder.name}`);
  }

  console.log(`‚úÖ Archived ${caseFolders.length} folders to ${archiveFolderName}`);
}
```

### 3. Database Wipe Script

```typescript
// scripts/migrations/full-data-reset.ts

import { prisma } from '@legal-platform/database';

async function main() {
  console.log('üö® PRODUCTION DATA RESET - STARTING');
  console.log('=====================================\n');

  // 1. Count before
  const counts = {
    cases: await prisma.case.count(),
    clients: await prisma.client.count(),
    documents: await prisma.document.count(),
    emails: await prisma.email.count(),
    tasks: await prisma.task.count(),
    aiConversations: await prisma.aIConversation.count(),
  };
  console.log('Before wipe:', counts);

  // 2. Delete in dependency order (children before parents)
  console.log('\n--- Deleting data ---\n');

  // AI & Communication
  console.log('Deleting AI conversations...');
  await prisma.aIMessage.deleteMany({});
  await prisma.aIConversation.deleteMany({});

  console.log('Deleting thread summaries...');
  await prisma.threadSummary.deleteMany({});

  console.log('Deleting communication entries...');
  await prisma.communicationEntry.deleteMany({});

  // Email-related
  console.log('Deleting email extracted items...');
  await prisma.extractedDeadline.deleteMany({});
  await prisma.extractedCommitment.deleteMany({});
  await prisma.extractedActionItem.deleteMany({});
  await prisma.extractedQuestion.deleteMany({});
  await prisma.riskIndicator.deleteMany({});

  console.log('Deleting email drafts...');
  await prisma.emailDraft.deleteMany({});

  console.log('Deleting email case links...');
  await prisma.emailCaseLink.deleteMany({});

  console.log('Deleting email attachments...');
  await prisma.emailAttachment.deleteMany({});

  console.log('Deleting emails...');
  await prisma.email.deleteMany({});

  // Documents
  console.log('Deleting document versions...');
  await prisma.documentVersion.deleteMany({});

  console.log('Deleting document audit logs...');
  await prisma.documentAuditLog.deleteMany({});

  console.log('Deleting case documents...');
  await prisma.caseDocument.deleteMany({});

  console.log('Deleting documents...');
  await prisma.document.deleteMany({});

  console.log('Deleting document folders...');
  await prisma.documentFolder.deleteMany({});

  // Tasks
  console.log('Deleting task-related data...');
  await prisma.taskAttendee.deleteMany({});
  await prisma.taskDocumentLink.deleteMany({});
  await prisma.taskDelegation.deleteMany({});
  await prisma.task.deleteMany({});

  // Case-related
  console.log('Deleting case summaries...');
  await prisma.caseSummary.deleteMany({});

  console.log('Deleting case actors...');
  await prisma.caseActor.deleteMany({});

  console.log('Deleting case team...');
  await prisma.caseTeam.deleteMany({});

  console.log('Deleting case audit logs...');
  await prisma.caseAuditLog.deleteMany({});

  console.log('Deleting case rate history...');
  await prisma.caseRateHistory.deleteMany({});

  console.log('Deleting case approvals...');
  await prisma.caseApproval.deleteMany({});

  console.log('Deleting time entries...');
  await prisma.timeEntry.deleteMany({});

  console.log('Deleting cases...');
  await prisma.case.deleteMany({});

  // Clients
  console.log('Deleting clients...');
  await prisma.client.deleteMany({});

  // 3. Verify
  console.log('\n--- Verification ---\n');
  const after = {
    cases: await prisma.case.count(),
    clients: await prisma.client.count(),
    documents: await prisma.document.count(),
    emails: await prisma.email.count(),
    tasks: await prisma.task.count(),
    aiConversations: await prisma.aIConversation.count(),
  };
  console.log('After wipe:', after);

  // 4. Verify users/firms preserved
  const users = await prisma.user.count();
  const firms = await prisma.firm.count();
  console.log(`\n‚úÖ Preserved: ${users} users, ${firms} firms`);

  console.log('\n=====================================');
  console.log('üö® PRODUCTION DATA RESET - COMPLETE');
  console.log('\nNext steps:');
  console.log('1. Users can now sync emails from Outlook');
  console.log('2. Emails will arrive with classificationState: Pending');
  console.log('3. New classification UX will handle sorting');
}

main()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

### 4. Backup Procedure

```bash
# Take backup before migration
pg_dump -h <host> -U <user> -d <database> -F c -f backup-pre-reset-$(date +%Y%m%d).dump

# Or via Render Dashboard:
# 1. Go to legal-platform-db
# 2. Click "Backups" tab
# 3. Create manual backup with note "Pre-reset backup"
```

### 5. Rollback Procedure

If issues arise:

1. Stop all services
2. Restore from backup: `pg_restore -h <host> -U <user> -d <database> -c backup-pre-reset-YYYYMMDD.dump`
3. Deploy previous code version
4. Verify data restored
5. Investigate and fix before re-attempting

### 6. Execution Order

```bash
# 1. Take backup
pg_dump ... > backup-pre-reset.dump

# 2. Archive SharePoint (run from gateway)
pnpm tsx scripts/migrations/archive-sharepoint.ts

# 3. Wipe database
pnpm tsx scripts/migrations/full-data-reset.ts

# 4. Verify
pnpm tsx scripts/migrations/verify-reset.ts

# 5. Notify users they can sync emails
```

### 7. Post-Migration

After reset:

1. Users log in (authentication still works)
2. Users click "Sync" in /communications
3. All Outlook emails re-import with `classificationState: Pending`
4. New UX (inline assignment, sender-first sidebar) helps users classify
5. Fresh start with proper classifications

## Acceptance Criteria

- [ ] Pre-migration backup taken
- [ ] SharePoint files archived (not deleted)
- [ ] All cases deleted
- [ ] All clients deleted
- [ ] All documents deleted (DB only)
- [ ] All emails deleted
- [ ] All tasks deleted
- [ ] All AI conversations deleted
- [ ] Users and firms preserved
- [ ] PersonalContacts preserved
- [ ] Users can log in after reset
- [ ] Email sync works (emails re-import)
- [ ] New classification UX functional

## Files to Create

- `scripts/migrations/archive-sharepoint.ts`
- `scripts/migrations/full-data-reset.ts`
- `scripts/migrations/verify-reset.ts`

## Estimated Scope

Large - Requires coordination, backup, SharePoint archival, and careful execution.

---

## Important Warnings

‚ö†Ô∏è **DESTRUCTIVE OPERATION** - All business data will be deleted.

‚ö†Ô∏è **IRREVERSIBLE** without backup restore - Ensure backup is verified before proceeding.

‚ö†Ô∏è **SharePoint Archive** - Files moved, not deleted. Can be recovered if needed.

‚ö†Ô∏è **Maintenance Window** - Schedule during low-traffic period. Notify all users.

---

## Session Log

### 2025-12-24 - Scripts Created

Created all three migration scripts:

1. **`scripts/migrations/archive-sharepoint.ts`**
   - Uses MS Graph API to archive SharePoint case folders
   - Moves folders to `_Archive_{date}` folder (not delete)
   - Requires MS_ACCESS_TOKEN env var (delegated token with Sites.ReadWrite.All)
   - Supports `--dry-run` flag

2. **`scripts/migrations/full-data-reset.ts`**
   - Deletes all business data in correct dependency order (17 layers)
   - Preserves: Users, Firms, PersonalContacts, EmailSyncState
   - 5-second countdown before execution (safety)
   - Supports `--dry-run` flag
   - Shows before/after counts

3. **`scripts/migrations/verify-reset.ts`**
   - Runs 28 verification checks
   - Confirms data deletion and preservation
   - Checks schema integrity and email sync readiness
   - Returns exit code 1 on failures

**Tested:**

- `full-data-reset.ts --dry-run` - Shows correct data counts
- `verify-reset.ts` - Correctly shows data exists (pre-reset state)
- `archive-sharepoint.ts` - Fails gracefully without SharePoint config

**Ready for execution.** Waiting for:

1. Deploy all OPS-187 to OPS-198 to production
2. Take production database backup
3. Schedule maintenance window
4. Run the scripts in order
