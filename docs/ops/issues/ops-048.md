# OPS-048: AI Summary Generation Service

**Status:** Implementing | **Priority:** P1-High | **Type:** Feature
**Created:** 2025-12-19 | **Depends on:** OPS-046 | **Parallel with:** OPS-047, OPS-049

## Summary

Background worker service that generates AI-powered case summaries when triggered by the job queue.

## Background

Currently `CaseConversationSummaryPanel` generates summaries on-demand. This issue moves generation to a background service that:

1. Picks up jobs from the queue
2. Gathers all case data (not just communications)
3. Generates comprehensive summary via AI
4. Stores result in `CaseSummary` table

## Requirements

### 1. Summary Generation Worker

```typescript
// services/gateway/src/workers/case-summary.worker.ts

import { Worker } from 'bullmq';

const summaryWorker = new Worker(
  'case-summary',
  async (job) => {
    const { caseId } = job.data;
    await caseSummaryService.generateSummary(caseId);
  },
  {
    connection: redisConnection,
    concurrency: 2, // Process 2 summaries at a time
  }
);
```

### 2. Data Gathering

Collect all relevant case data for AI context:

```typescript
async gatherCaseContext(caseId: string): Promise<CaseContext> {
  const [caseData, emails, documents, notes, tasks] = await Promise.all([
    prisma.case.findUnique({
      where: { id: caseId },
      include: { client: true, contacts: true, teamMembers: true },
    }),
    prisma.email.findMany({
      where: { caseId },
      orderBy: { receivedAt: 'desc' },
      take: 50, // Last 50 emails
    }),
    prisma.document.findMany({
      where: { caseId },
      orderBy: { createdAt: 'desc' },
      take: 30,
    }),
    prisma.internalNote.findMany({
      where: { caseId },
      orderBy: { createdAt: 'desc' },
      take: 20,
    }),
    prisma.task.findMany({
      where: { caseId },
      orderBy: { updatedAt: 'desc' },
      take: 20,
    }),
  ]);

  return { caseData, emails, documents, notes, tasks };
}
```

### 3. AI Prompt Template

```typescript
const SUMMARY_PROMPT = `
Analizează următoarele date despre un dosar juridic și generează un rezumat structurat.

DOSAR: {caseTitle} ({caseNumber})
CLIENT: {clientName}
STATUS: {caseStatus}
TIP: {caseType}

EMAILURI RECENTE (ultimele {emailCount}):
{emailSummaries}

DOCUMENTE ({documentCount} total):
{documentList}

NOTE INTERNE ({noteCount}):
{noteSummaries}

SARCINI ({taskCount} total, {completedTasks} finalizate):
{taskSummaries}

Generează un răspuns JSON cu următoarea structură:
{
  "executiveSummary": "Rezumat de 2-3 propoziții despre starea actuală a dosarului",
  "currentStatus": "Descriere detaliată a statusului curent",
  "keyDevelopments": ["Dezvoltare 1", "Dezvoltare 2", ...],
  "openIssues": ["Problemă nerezolvată 1", "Problemă 2", ...]
}

Răspunde DOAR cu JSON valid, fără alte explicații.
`;
```

### 4. Summary Generation Function

```typescript
async generateSummary(caseId: string): Promise<void> {
  try {
    // 1. Gather context
    const context = await this.gatherCaseContext(caseId);
    if (!context.caseData) {
      throw new Error(`Case ${caseId} not found`);
    }

    // 2. Build prompt
    const prompt = this.buildPrompt(context);

    // 3. Call AI service
    const response = await aiService.generateCompletion({
      model: 'claude-3-haiku-20240307', // Fast model for summaries
      messages: [{ role: 'user', content: prompt }],
      max_tokens: 2000,
    });

    // 4. Parse response
    const summary = JSON.parse(response.content);

    // 5. Compute data version hash
    const dataVersionHash = this.computeHash(context);

    // 6. Store in database
    await prisma.caseSummary.upsert({
      where: { caseId },
      update: {
        executiveSummary: summary.executiveSummary,
        currentStatus: summary.currentStatus,
        keyDevelopments: summary.keyDevelopments,
        openIssues: summary.openIssues,
        generatedAt: new Date(),
        isStale: false,
        dataVersionHash,
        emailCount: context.emails.length,
        documentCount: context.documents.length,
        noteCount: context.notes.length,
        taskCount: context.tasks.length,
      },
      create: {
        caseId,
        executiveSummary: summary.executiveSummary,
        currentStatus: summary.currentStatus,
        keyDevelopments: summary.keyDevelopments,
        openIssues: summary.openIssues,
        generatedAt: new Date(),
        isStale: false,
        dataVersionHash,
        emailCount: context.emails.length,
        documentCount: context.documents.length,
        noteCount: context.notes.length,
        taskCount: context.tasks.length,
      },
    });

    console.log(`Generated summary for case ${caseId}`);
  } catch (error) {
    console.error(`Failed to generate summary for case ${caseId}:`, error);
    // Keep isStale = true so it retries later
    throw error;
  }
}
```

### 5. GraphQL Query

```graphql
type CaseSummary {
  id: ID!
  caseId: ID!
  executiveSummary: String!
  currentStatus: String!
  keyDevelopments: [String!]!
  openIssues: [String!]!
  generatedAt: DateTime!
  isStale: Boolean!
  emailCount: Int!
  documentCount: Int!
  noteCount: Int!
  taskCount: Int!
}

extend type Query {
  caseSummary(caseId: ID!): CaseSummary
}
```

## Acceptance Criteria

- [x] Background worker processes regeneration jobs
- [x] Data gathering collects emails, documents, notes, tasks
- [x] AI prompt generates structured Romanian summary
- [x] Result stored in CaseSummary table
- [x] GraphQL query exposes cached summary
- [x] Error handling keeps isStale=true on failure
- [ ] Run preflight verification
- [ ] Test locally with production data

## Files to Create/Modify

- `services/gateway/src/workers/case-summary.worker.ts` (new)
- `services/gateway/src/services/case-summary.service.ts`
- `services/gateway/src/graphql/schema/case-summary.graphql` (new)
- `services/gateway/src/graphql/resolvers/case-summary.resolvers.ts` (new)

## Testing

- Unit test: prompt building with various data combinations
- Unit test: JSON parsing handles edge cases
- Integration test: full flow from job to stored summary
- Manual test: verify Romanian output quality

## Session Log

### Session 1 (2025-12-19)

**Implemented:**

1. Created `CaseSummaryService` (`services/gateway/src/services/case-summary.service.ts`)
   - `generateSummary()` - generates AI summary from case data
   - `getCaseSummary()` - retrieves cached summary
   - `markSummaryStale()` - marks summary for regeneration
   - `getStaleSummaries()` - gets summaries needing regeneration
   - `getCasesWithoutSummary()` - finds cases without summaries
   - Uses AI service with Romanian prompts
   - Data version hashing for change detection

2. Created background worker (`services/gateway/src/workers/case-summary.worker.ts`)
   - Interval-based processing (default: 5 min)
   - Processes stale summaries first
   - Generates summaries for new cases
   - Configurable batch size and interval
   - Graceful shutdown support

3. Created GraphQL schema (`services/gateway/src/graphql/schema/case-summary.graphql`)
   - `CaseSummary` type
   - `caseSummary(caseId)` query
   - `isCaseSummaryStale(caseId)` query
   - `triggerCaseSummaryGeneration(caseId)` mutation
   - `markCaseSummaryStale(caseId)` mutation

4. Created resolvers (`services/gateway/src/graphql/resolvers/case-summary.resolvers.ts`)
   - Auth checks and firm validation
   - Field resolvers for JSON array fields

5. Registered in server:
   - Added resolver imports and spreads in `server.ts`
   - Added worker start/stop in `index.ts`

**Data Sources:**

- Case data with client and actors (CaseActor)
- Last 50 emails
- Last 30 documents (via CaseDocument link table)
- Last 20 internal notes (via CommunicationEntry with InternalNote channel)
- Last 20 tasks

**Next Steps:**

- Run preflight verification
- Test with production data locally
