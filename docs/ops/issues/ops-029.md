# OPS-029: AI Email Classification Service

**Status:** Verifying
**Priority:** P1-High
**Type:** Feature (Backend/AI)
**Created:** 2025-12-16
**Last Active:** 2025-12-16
**Sessions:** 2
**Blocked By:** OPS-027 (Schema ready) ✅
**Blocks:** OPS-030 (now integrated)
**Can Parallel With:** OPS-028

---

## Problem Statement

When a client has multiple cases, the platform currently imports ALL emails with that contact into a single case. We need an AI service that can:

1. Analyze email content and metadata
2. Match emails to the correct case with confidence scores
3. Handle special cases (courts, authorities) that appear in all cases
4. Flag uncertain classifications for human review

---

## Scope

### 1. Email Classification Service

New service: `services/ai-service/src/services/email-classification.service.ts`

```typescript
interface ClassificationResult {
  emailId: string;
  suggestedCaseId: string | null;
  confidence: number; // 0.0 - 1.0
  reasons: string[];
  alternativeCases: Array<{
    caseId: string;
    confidence: number;
    reason: string;
  }>;
  needsHumanReview: boolean;
  reviewReason?: string;
  matchType: 'actor' | 'reference' | 'keyword' | 'semantic' | 'none';
}

interface ClassificationContext {
  email: Email;
  candidateCases: Case[]; // Client's active cases with metadata
  globalSources: GlobalEmailSource[];
  caseActors: Map<string, CaseActor[]>; // caseId -> actors
}
```

### 2. Classification Algorithm

```
CLASSIFY EMAIL (email, candidateCases, globalSources):

1. CHECK GLOBAL SOURCES
   - If sender domain/address matches GlobalEmailSource (court, authority):
     → Set specialSource = true
     → Skip CaseActor matching (would match all cases)
     → Prioritize reference number extraction

2. EXTRACT IDENTIFIERS FROM EMAIL
   - Parse subject + body for reference numbers
   - Romanian court format: XXXX/Y/YYYY
   - Contract numbers, invoice numbers, etc.
   - Store: extractedReferences[]

3. IF specialSource:
   → Match extractedReferences against case.referenceNumbers
   → If single match with exact reference: confidence = 0.95
   → If multiple matches: needsHumanReview = true
   → If no match: needsHumanReview = true, reason = "No reference number found"

4. CASEACTOR MATCHING
   - Check sender email against CaseActor.email for each case
   - Check sender domain against CaseActor.emailDomains
   - If exact email match in single case: confidence = 0.90
   - If matches multiple cases: continue to content analysis

5. REFERENCE NUMBER MATCHING
   - Match extractedReferences against case.referenceNumbers
   - Exact match: confidence += 0.30

6. KEYWORD MATCHING
   - Check subject + bodyPreview against case.keywords
   - Each keyword match: confidence += 0.10 (max 0.30)

7. SEMANTIC ANALYSIS (if still uncertain)
   - Use Claude to compare email content with case.description
   - Use case.classificationNotes as context
   - AI returns: relevance score, reasoning

8. CALCULATE FINAL CONFIDENCE
   - Combine scores with weights
   - Apply thresholds:
     → > 0.85: AUTO_ASSIGN
     → 0.50 - 0.85: ASSIGN_WITH_REVIEW
     → < 0.50: NEEDS_HUMAN_REVIEW

9. RETURN ClassificationResult
```

### 3. Reference Number Extraction

Utility for extracting Romanian legal references:

```typescript
interface ExtractedReference {
  type: 'court_file' | 'contract' | 'invoice' | 'unknown';
  value: string;
  normalized: string; // Canonical form
  position: number; // Position in text
}

function extractReferences(text: string): ExtractedReference[] {
  // Court file: "Dosar nr. 1234/3/2024", "dosar 1234/3/2024", "1234/3/2024"
  // Contract: "Contract nr. 123/2024", "Contract #123"
  // Invoice: "Factura 123456"
}
```

### 4. GraphQL API

```graphql
type ClassificationResult {
  emailId: ID!
  suggestedCaseId: ID
  suggestedCase: Case
  confidence: Float!
  reasons: [String!]!
  alternativeCases: [AlternativeCase!]!
  needsHumanReview: Boolean!
  reviewReason: String
  matchType: MatchType!
}

type AlternativeCase {
  caseId: ID!
  case: Case!
  confidence: Float!
  reason: String!
}

enum MatchType {
  ACTOR
  REFERENCE
  KEYWORD
  SEMANTIC
  NONE
}

extend type Query {
  # Classify emails for a specific client's cases
  classifyEmailsForClient(clientId: ID!, emailIds: [ID!]!): [ClassificationResult!]!

  # Preview classification for email import
  previewEmailClassification(emailAddresses: [String!]!, clientId: ID!): EmailClassificationPreview!
}

type EmailClassificationPreview {
  totalEmails: Int!
  classifications: [ClassificationResult!]!
  byCase: [CaseClassificationSummary!]!
  needsReview: Int!
  unclassified: Int!
}

type CaseClassificationSummary {
  caseId: ID!
  case: Case!
  emailCount: Int!
  autoClassified: Int!
  needsReview: Int!
}
```

### 5. Confidence Thresholds (Configurable)

Store in firm settings or use defaults:

```typescript
const DEFAULT_THRESHOLDS = {
  autoAssign: 0.85, // Above this: assign without review
  needsReview: 0.5, // Below this: human must decide
  actorMatchWeight: 0.4,
  referenceMatchWeight: 0.3,
  keywordMatchWeight: 0.2,
  semanticWeight: 0.1,
};
```

---

## Acceptance Criteria

- [ ] EmailClassificationService implemented with full algorithm
- [ ] Reference number extraction works for Romanian court files
- [ ] Global source detection skips actor matching appropriately
- [ ] Confidence scores calculated correctly
- [ ] Multi-case conflicts flagged for review
- [ ] GraphQL queries return classification results
- [ ] Unit tests cover main classification scenarios
- [ ] Performance: <500ms per email for non-semantic matching

---

## Test Scenarios

1. **Single case client** - Email should match with high confidence
2. **Multi-case client, unique actor** - Match by CaseActor email
3. **Multi-case client, shared contact** - Fall back to content analysis
4. **Court email with file number** - Match by reference number
5. **Court email without file number** - Flag for review
6. **Email with keywords** - Boost confidence for matching case
7. **Ambiguous email** - Low confidence, needs review
8. **No matching case** - Unclassified

---

## Files to Create/Modify

### New Files

- `services/ai-service/src/services/email-classification.service.ts`
- `services/ai-service/src/utils/reference-extractor.ts`
- `services/gateway/src/graphql/schema/email-classification.graphql`
- `services/gateway/src/graphql/resolvers/email-classification.resolvers.ts`
- `services/ai-service/src/services/__tests__/email-classification.test.ts`

### Modified Files

- `services/gateway/src/index.ts` (register new resolvers)

---

## AI Prompt Design

For semantic analysis fallback:

```
You are classifying an email for a Romanian law firm.

EMAIL:
- From: ${from}
- Subject: ${subject}
- Preview: ${bodyPreview}
- Date: ${date}

CANDIDATE CASES FOR THIS CLIENT:

Case 1: ${case1.title}
- Type: ${case1.type}
- Description: ${case1.description}
- Keywords: ${case1.keywords}
- Classification notes: ${case1.classificationNotes}

Case 2: ${case2.title}
...

TASK:
Determine which case this email most likely belongs to.
Consider subject matter, terminology, and any references mentioned.

OUTPUT (JSON):
{
  "mostLikelyCaseIndex": 1,
  "confidence": 0.75,
  "reasoning": "Email discusses contract terms matching Case 1 description",
  "alternativeCase": {
    "caseIndex": 2,
    "confidence": 0.45,
    "reasoning": "Could relate to ongoing negotiation in Case 2"
  }
}
```

---

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

---

## Session Log

### Session 1 (2025-12-16)

**Work Completed:**

1. Created `reference-extractor.ts` utility:
   - Extracts Romanian court file numbers (format: XXXX/Y/YYYY)
   - Extracts contract and invoice numbers
   - Provides domain matching for email classification
   - Includes normalization for consistent comparison

2. Created `email-classification.service.ts`:
   - Multi-stage classification algorithm
   - Global source detection (courts, authorities skip actor matching)
   - Reference number extraction and matching
   - CaseActor email/domain matching
   - Keyword matching with configurable weights
   - Subject pattern matching (glob-style)
   - AI semantic analysis fallback for uncertain cases
   - Confidence score calculation with thresholds
   - Human review flagging for uncertain classifications

3. Created `email-classification.graphql` schema:
   - `ClassificationResult` type with confidence scores
   - `EmailClassificationPreview` for batch import preview
   - `CaseClassificationMetadata` for case settings
   - Query: `classifyEmailsForClient`, `previewEmailClassification`

4. Created `email-classification.resolvers.ts`:
   - Query resolvers for classification
   - Field resolvers for Case relations
   - Integrates with existing AI service

5. Registered resolvers in `server.ts`

6. Added 31 unit tests for reference extractor (all passing)

**Files Created:**

- `services/ai-service/src/utils/reference-extractor.ts`
- `services/ai-service/src/services/email-classification.service.ts`
- `services/gateway/src/graphql/schema/email-classification.graphql`
- `services/gateway/src/graphql/resolvers/email-classification.resolvers.ts`
- `services/ai-service/src/utils/__tests__/reference-extractor.test.ts`

**Files Modified:**

- `services/gateway/src/graphql/server.ts`

**Status:** TypeScript compiles without errors, unit tests pass

**Next Steps:**

- Run local verification with production data
- Test classification with real emails
- Consider adding classification service tests

---

### Session 2 (2025-12-16)

**OPS-030 Integration Added:**

The classification service has been extended with OPS-030 (Email Import with Classification Integration):

1. **Extended GraphQL Schema** (`email-classification.graphql`):
   - Added `EmailForClassification` type for preview display
   - Added `PreviewClassificationForImportInput` - derives client from caseId
   - Added `ExecuteClassifiedImportInput` for multi-case import execution
   - Added `ClassificationOverrideInput` for manual corrections
   - Added `CaseImportSummary` and `ClassifiedImportResult` types
   - New queries: `previewClassificationForImport`, `clientHasMultipleCases`
   - New mutation: `executeClassifiedImport`

2. **Extended Resolvers** (`email-classification.resolvers.ts`):
   - `previewClassificationForImport` - Preview with caseId (derives client)
   - `clientHasMultipleCases` - Check if multi-case flow needed
   - `executeClassifiedImport` - Execute import with overrides:
     - Links emails to multiple cases based on classification/overrides
     - Imports attachments per case
     - Creates contacts for primary case
     - Records activity for each case
     - Syncs to timeline

3. **Helper Functions Added**:
   - `findEmailsByParticipantsForClassification` - Raw SQL for participant lookup with hasAttachments

4. **Server Integration**:
   - Added `CaseImportSummary` field resolver
   - Mutation resolvers registered

**Current Files:**

- `services/ai-service/src/utils/reference-extractor.ts` - Reference extraction utility
- `services/ai-service/src/services/email-classification.service.ts` - Classification algorithm
- `services/gateway/src/graphql/schema/email-classification.graphql` - Full schema with OPS-030
- `services/gateway/src/graphql/resolvers/email-classification.resolvers.ts` - All resolvers
- `services/ai-service/src/utils/__tests__/reference-extractor.test.ts` - 31 tests passing

**Status:** Implementation complete, ready for verification
