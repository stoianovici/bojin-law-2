# OPS-098: Duration-Based Calendar Card Spanning

## Summary

Tasks with duration estimates visually span multiple days on the calendar when workload exceeds daily capacity. This provides at-a-glance workload visualization.

## Background

When multiple tasks are due on the same day and their combined duration exceeds a workday (8h), users need to start working earlier. Currently, all tasks appear stacked on their due date with no visual indication of required lead time.

## Requirements

### Acceptance Criteria

1. Tasks with `estimatedHours` can span multiple calendar days
2. Spanning calculated based on: task duration + other tasks' durations on same due date
3. Task card width proportional to days spanned (1, 2, or 3 days max)
4. Only date-only tasks span; time-specific tasks (meetings, court) remain single-day
5. Spanning respects weekends (configurable: skip or include)
6. Drag-and-drop works on spanning cards (moves due date, recalculates span)

### Visual Design

```
Example: Friday has 18h of tasks (Task A: 8h, Task B: 6h, Task C: 4h)
Assuming 8h workday capacity:

Wed         Thu         Fri
┌───────────────────────────────┐
│ Task A (8h) due Fri           │  ← Spans Wed-Fri (needs 3 days of work)
└───────────────────────────────┘
            ┌───────────────────┐
            │ Task B (6h)       │  ← Spans Thu-Fri
            └───────────────────┘
                        ┌───────┐
                        │Task C │  ← Single day (fits in remaining capacity)
                        └───────┘
```

### Algorithm

```typescript
function calculateTaskSpan(task: Task, allTasks: Task[]): number {
  // Only span date-only tasks with duration
  if (task.dueTime || !task.estimatedHours) return 1;

  const dueDate = new Date(task.dueDate);
  const sameDayTasks = allTasks.filter((t) => isSameDay(t.dueDate, dueDate) && t.estimatedHours);

  // Sort by duration descending (larger tasks get priority)
  sameDayTasks.sort((a, b) => (b.estimatedHours ?? 0) - (a.estimatedHours ?? 0));

  const DAILY_CAPACITY = 8; // hours
  let remainingCapacity = DAILY_CAPACITY;
  let daysNeeded = 1;

  for (const t of sameDayTasks) {
    const hours = t.estimatedHours ?? 0;
    if (hours > remainingCapacity) {
      // Need more days
      daysNeeded = Math.min(3, Math.ceil(hours / DAILY_CAPACITY));
    }
    if (t.id === task.id) {
      return daysNeeded;
    }
    remainingCapacity -= hours;
    if (remainingCapacity <= 0) {
      remainingCapacity = DAILY_CAPACITY;
    }
  }

  return 1;
}
```

### Configuration

- Daily capacity: 8 hours (could be user-configurable)
- Max span: 3 days
- Weekend handling: Skip weekends by default

## Implementation

### Files to Modify

1. **MultiWeekCalendarView.tsx** - Major refactor for spanning cards
2. **New utility: workloadDistribution.ts** - Spanning calculation algorithm
3. **CSS** - Multi-day card positioning (absolute positioning across grid cells)

### Technical Challenges

1. **Grid layout** - Cards need absolute positioning to span cells
2. **Overlapping** - Multiple spanning cards need vertical stacking
3. **Drag-and-drop** - Recalculate spans on drop
4. **Performance** - Recalculation on any task change

### UI States

1. **No duration** - Single-day card (current behavior)
2. **Has duration, fits** - Single-day card with duration badge
3. **Has duration, overloaded** - Spanning card with visual indicator

### Spanning Card Design

```
┌─────────────────────────────────────────────┐
│ ▌Task Title                          [8h]  │
│   Popescu v. SRL                           │
│   ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ ▸ Fri │  ← Progress bar + due indicator
└─────────────────────────────────────────────┘
```

## Risks

1. **Complexity** - Significantly more complex than current implementation
2. **User confusion** - Tasks appearing before their due date might confuse users
3. **Inaccurate durations** - Garbage in, garbage out
4. **Performance** - Recalculating on every change

## Mitigation

1. **Phased rollout** - Start with visual indicator only (no spanning), then add spanning
2. **Clear labeling** - Show "due Fri" on spanning cards
3. **Toggle** - Allow users to switch between simple and workload view
4. **Caching** - Memoize span calculations

## Priority

P3-Low (experimental, high effort)

## Dependencies

- OPS-097: AI Task Creation with Editable Duration Card (required - need duration data)

## Related Issues

- OPS-095: Task Date/Time Simplification
- OPS-096: Task Card Display Redesign
- OPS-097: AI Task Creation with Editable Duration Card

---

## Session Log

### Session 1 (2025-12-22)

**Phase 1 Implementation: Duration Badges**

Implemented duration badges across all task views as the first phase of this feature (per mitigation strategy - phased rollout).

**Changes Made:**

1. **MultiWeekCalendarView.tsx** (lines 218, 260-267)
   - Added `hasDuration` check for tasks with `estimatedHours > 0`
   - Display badge showing `{hours}h` in gray pill style
   - Badge positioned at top-right of task card
   - Added duration to aria-label for accessibility

2. **KanbanBoard.tsx** (lines 116, 132-141, 188, 195-201)
   - Added duration badge to TaskCard component
   - Added duration badge to TaskCardOverlay (drag preview)
   - Same visual style as calendar view

3. **ListView.tsx** (lines 335-346)
   - Added duration badge next to task title in table
   - Consistent styling with other views

**Visual Design:**

```
┌─────────────────────────────────────┐
│ Task Title                    [8h]  │  ← Gray pill badge
│ Case Name                           │
└─────────────────────────────────────┘
```

**Status:** Phase 1 Complete ✅

- TypeScript compilation: Passed
- Ready for manual verification with real data

**Next Phase (P2):** Implement actual spanning behavior when duration > daily capacity

---

### Session 2 (2025-12-22)

**Phase 2 Implementation: Duration-Based Calendar Card Spanning**

Implemented true CSS Grid spanning for calendar task cards based on user preferences:

- True spanning (single card spans multiple columns)
- Cumulative workload trigger (span based on total hours exceeding 8h capacity)
- Always active (no toggle needed)

**New Files Created:**

1. **`apps/web/src/utils/workloadDistribution.ts`**
   - Core algorithms for span calculation and row assignment
   - `calculateTaskSpan()` - determines days to span (1-3) based on cumulative workload
   - `assignRowsToSpanningTasks()` - greedy row assignment for vertical stacking
   - `calculateCardPosition()` - CSS positioning for absolute overlays
   - `buildSpanningTasksInfo()` - builds spanning info for all tasks
   - `getTotalRowsHeight()` - calculates total height for row assignments
   - Constants: DAILY_CAPACITY_HOURS=8, MAX_SPAN_DAYS=3, CARD_HEIGHT=72, CARD_GAP=4

2. **`apps/web/src/components/task/calendar/SpanningTaskCard.tsx`**
   - Spanning task card component with absolute positioning
   - Visual indicators: start day [Wed], end day ▸ Fri, duration badge [8h]
   - Drag-and-drop support preserved
   - Accessibility labels with full span information
   - Gradient background toward due date

3. **`apps/web/src/components/task/calendar/SpanningTaskLayer.tsx`**
   - Overlay layer that renders all spanning cards
   - Uses absolute positioning within week grid
   - Calculates row assignments and total height
   - Minimum one row height for layout stability

4. **`apps/web/src/components/task/calendar/index.ts`**
   - Barrel export for calendar components

**Modified Files:**

1. **`apps/web/src/components/task/MultiWeekCalendarView.tsx`**
   - Converted WeekRow from flexbox to CSS Grid (`grid-template-columns: 1fr 1fr 1fr 1fr 1fr 50px 50px`)
   - Added SpanningTaskLayer overlay for task rendering
   - Modified DayColumn to show headers only (drop zones preserved)
   - Removed inline TaskCard/DraggableTaskCard components (now in SpanningTaskCard)
   - Removed unused PRIORITY_STYLES constant

**Architecture:**

```
Before (Flexbox):                     After (CSS Grid + Overlay):
WeekRow (flex)                        WeekGrid (CSS Grid)
  └─ DayColumn (flex-child)             ├─ DayColumn (grid-cell, headers only)
       └─ TaskCard (stacked)            └─ SpanningTaskLayer (overlay)
                                              └─ SpanningTaskCard (positioned)
```

**Spanning Algorithm:**

1. Only date-only tasks with `estimatedHours` can span (time-specific tasks like meetings stay single-day)
2. Sort tasks on same due date by duration descending (larger tasks get spanning priority)
3. Walk through sorted tasks, track cumulative hours
4. When cumulative > 8h capacity, calculate span = ceil(taskHours/8), max 3 days
5. Span backward from due date (e.g., due Friday with 3-day span shows Wed-Fri)
6. Week boundary clipping (startDay = max(0, calculated))

**Row Assignment:**

- Greedy algorithm: process tasks by start day, assign to first available row
- Track occupied day-slots per row to avoid visual overlap
- Sort by start day, then span descending (longer spans first)

**Status:** Phase 2 Complete ✅

- TypeScript compilation (web): Passed
- Visual verification: Calendar renders with CSS Grid layout
- Task cards rendering in SpanningTaskLayer overlay
- Drag-and-drop preserved (cards draggable, drop zones functional)

**Note:** Current test tasks are time-specific (01:00), which don't span per algorithm. Tasks need `estimatedHours` and no specific time to trigger spanning behavior.

**Gateway pre-existing errors:** TypeScript errors in email.resolvers.ts (ClassificationAction type, PubSub asyncIterator) - unrelated to OPS-098
