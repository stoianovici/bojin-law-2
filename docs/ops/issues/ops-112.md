# OPS-112: Apollo Client Missing x-ms-access-token Header

| Field           | Value            |
| --------------- | ---------------- |
| **Status**      | Fixed            |
| **Type**        | Bug              |
| **Priority**    | P1-High          |
| **Created**     | 2025-12-23       |
| **Sessions**    | 1                |
| **Last Active** | 2025-12-23 16:00 |

## Description

The Apollo client is not passing the `x-ms-access-token` header to GraphQL requests. The token exists in MSAL localStorage but `getMsAccessToken()` returns `null`. This causes document preview and email operations to fail even though the backend works correctly when the token is manually provided.

**Root Cause Pattern**: Auth/Token Issues (Pattern #3 from root-cause-patterns.md)

## Reproduction Steps

1. User logs in via Microsoft Azure AD
2. Session cookie is created and valid
3. MSAL token cache expires or clears (e.g., browser close, cache cleared)
4. User returns - session cookie still valid, but MSAL cache empty
5. `getMsAccessToken()` returns `null` because `msalInstance.getAllAccounts()` is empty
6. Apollo client doesn't add `x-ms-access-token` header
7. Backend rejects email/preview operations with `MS_TOKEN_REQUIRED` error

## Root Cause

**Two issues identified:**

### 1. Race Condition - Token Getter Registration Timing

The `setMsAccessTokenGetter` is called in a `useEffect` with empty `[]` dependency in `AuthContext.tsx:513-516`. This runs AFTER first render, but early GraphQL requests may fire before registration completes.

```typescript
useEffect(() => {
  // Set up the token getter for Apollo client
  setMsAccessTokenGetter(() => getAccessTokenRef.current());
}, []); // Runs after first render - may be too late!
```

### 2. MSAL Cache Miss

Even when getter is registered, `getAccessToken()` returns `null` when:

- `state.msalAccount` is `null` (auth context not initialized yet)
- `msalInstance.getAllAccounts()` returns `[]` (user logged in via session cookie but MSAL cache expired)

## Fix Applied

Added promise-based waiting mechanism in Apollo authLink to handle race condition:

1. **Token getter ready signal** (`apollo-client.ts:16-20`):
   - Added `tokenGetterReady` promise that resolves when `setMsAccessTokenGetter` is called
   - This allows authLink to wait for the getter instead of failing immediately

2. **Wait function with timeout** (`apollo-client.ts:87-101`):

   ```typescript
   async function waitForTokenGetter(): Promise<boolean> {
     if (getMsAccessToken) return true;
     // Race between getter ready and 3-second timeout
     return Promise.race([readyPromise, timeoutPromise]);
   }
   ```

3. **Updated authLink** (`apollo-client.ts:103-129`):
   - Now waits for token getter to be available before attempting to get token
   - Gracefully proceeds without token if getter times out (for non-MS operations)
   - Maintains existing error handling for token acquisition failures

## Environment Strategy

| Mode                   | Command                        | Use When                     |
| ---------------------- | ------------------------------ | ---------------------------- |
| Local dev (default)    | `pnpm dev`                     | Feature development          |
| Production data        | `source .env.prod && pnpm dev` | Bug investigation, real data |
| Production-like Docker | `pnpm preview`                 | Pre-deploy verification      |
| Full parity check      | `pnpm preflight:full`          | Before any deployment        |

**Recommended for this issue**: Production data (to test with real MSAL state scenarios)

## Local Verification Status

| Step           | Status     | Date       | Notes                                           |
| -------------- | ---------- | ---------- | ----------------------------------------------- |
| Prod data test | ✅ Passed  | 2025-12-23 | Token correctly sent: `eyJ0eXAiOiJKV1QiLCJu...` |
| Preflight      | ⬜ Pending |            |                                                 |
| Docker test    | ⬜ Pending |            |                                                 |

**Verified**: Partial (token passing confirmed, full verification pending)

> Issue cannot be closed until all three steps pass

## Conventions to Follow

- Apollo client config in `apps/web/src/lib/apollo-client.ts`
- Auth context in `apps/web/src/contexts/AuthContext.tsx`
- Error handling should dispatch `ms-token-required` event for UI components

## Session Log

- [2025-12-23 16:00] Issue created. Bug discovered during OPS-110 SharePoint migration verification. Token exists in MSAL localStorage but getMsAccessToken() not returning it.
- [2025-12-23 16:15] Implemented fix - added promise-based waiting mechanism in Apollo authLink. TypeScript check passes.
- [2025-12-23 16:52] Fix verified - Console logs confirm token is being retrieved and passed: `getterReady: true getMsAccessToken: true` and `Token result: eyJ0eXAiOiJKV1QiLCJu...`. Preview still failing is a separate SharePoint service issue (OPS-109/110).

## Files Involved

- `apps/web/src/lib/apollo-client.ts` - Apollo client with authLink
- `apps/web/src/contexts/AuthContext.tsx` - getMsAccessToken function and token getter registration
- `apps/web/src/lib/msal-config.ts` - MSAL configuration
- `apps/web/src/providers/ApolloProvider.tsx` - Apollo provider setup

## Proposed Solution

1. **Add retry/wait logic** in authLink when token getter returns null but user appears authenticated
2. **Trigger proactive token refresh** when `MS_TOKEN_REQUIRED` error is detected
3. **Use MSAL's `acquireTokenSilent` with forceRefresh** as a fallback before giving up
4. Consider moving token getter registration to run synchronously or use lazy initialization pattern
