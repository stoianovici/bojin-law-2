# OPS-234: Feature Configuration Data Model & Service

**Type**: Feature
**Priority**: P1-High
**Status**: Completed
**Epic**: AI Batch Processing & Ops Dashboard

## Problem

No way to enable/disable AI features or set per-feature budget limits.

## Solution

Add `AIFeatureConfig` Prisma model and service for managing feature toggles.

### Data Model

```prisma
model AIFeatureConfig {
  id            String   @id @default(uuid())
  firmId        String
  feature       String

  enabled       Boolean  @default(true)

  // Budget controls (EUR for Romanian firm)
  monthlyBudgetEur  Decimal?  @db.Decimal(10, 2)
  dailyLimitEur     Decimal?  @db.Decimal(10, 2)

  // Batch job schedule (cron format)
  schedule      String?  // '0 3 * * *' for 3 AM daily

  updatedAt     DateTime @updatedAt
  updatedBy     String

  @@unique([firmId, feature])
}
```

### Feature List

```typescript
const AI_FEATURES = {
  // Request-time (triggered by user actions, logged but not scheduled)
  assistant_chat: { name: 'AI Assistant Chat', type: 'request' },
  email_classification: { name: 'Email Classification', type: 'request' },

  // Batch processors (scheduled nightly jobs)
  search_index: { name: 'Search Index Generator', type: 'batch', defaultSchedule: '0 3 * * *' },
  morning_briefings: { name: 'Morning Briefings', type: 'batch', defaultSchedule: '0 5 * * *' },
  case_health: { name: 'Case Health Scoring', type: 'batch', defaultSchedule: '0 3 * * *' },
  thread_summaries: { name: 'Thread Summaries', type: 'batch', defaultSchedule: '0 4 * * *' },
};
```

### Service Interface

```typescript
class AIFeatureConfigService {
  async isFeatureEnabled(firmId: string, feature: string): Promise<boolean>;
  async getFeatureConfig(firmId: string, feature: string): Promise<AIFeatureConfig>;
  async updateFeatureConfig(
    firmId: string,
    feature: string,
    config: Partial<AIFeatureConfig>
  ): Promise<AIFeatureConfig>;
  async getAllFeatures(firmId: string): Promise<AIFeatureConfig[]>;
  async getFeatureBudgetStatus(
    firmId: string,
    feature: string
  ): Promise<{ limitEur: number; spentEur: number; remainingEur: number }>;
}
```

## Acceptance Criteria

- [x] Prisma model created with migration
- [x] Service with CRUD operations
- [x] Default feature list seeded on first access per firm
- [x] Redis caching for fast `isFeatureEnabled` checks
- [x] Budget status calculation

## Files to Modify

- `packages/database/prisma/schema.prisma`
- `services/gateway/src/services/ai-feature-config.service.ts` (new)

## Dependencies

None - this is a foundation issue.

## Parallel Work

Can be done in parallel with OPS-232, OPS-233.
