# OPS-024: Email Import Not Completing - Attachments Not Imported

| Field           | Value      |
| --------------- | ---------- |
| **Status**      | Fixing     |
| **Type**        | Bug        |
| **Priority**    | P1-High    |
| **Created**     | 2025-12-14 |
| **Sessions**    | 11         |
| **Last Active** | 2025-12-15 |

---

## Current State

**Email import to Communications tab**: WORKING (61 emails imported)
**Attachment import to Documents panel**: FIX DEPLOYED - awaiting verification

---

## ROOT CAUSE IDENTIFIED (Session 11)

**Documents exist but CaseDocument links are missing.**

Session 11 diagnostics revealed:

- `orphanedDocumentIds: 0` - Documents DO exist in the database
- `upgradedWithDocument: 0` - No need to create new Documents
- `attachmentsAlreadyExist: 100+` - EmailAttachment records have documentId set

The Documents panel queries via CaseDocument to show documents for a specific case. Without CaseDocument links, documents don't appear even though they exist.

**Solution**: Detect and create missing CaseDocument links during import.

---

## Technical Investigation

### What's Working

1. MS access token IS being passed from frontend
2. Emails are being linked to cases correctly (61 emails)
3. Emails appear in Communications tab
4. Document records exist in database
5. EmailAttachment records have documentId set

### What Was NOT Working

1. CaseDocument records missing (link between Document and Case)
2. Documents don't appear in Documents panel because panel queries via CaseDocument

### Fix Applied (Session 11)

Added logic to detect when Documents exist but aren't linked to the current case:

```typescript
// If Document exists and email has caseId, check if CaseDocument exists
if (doc && email.caseId) {
  const caseDoc = await this.prisma.caseDocument.findFirst({
    where: {
      documentId: existing.documentId,
      caseId: email.caseId,
    },
  });

  // If Document exists but CaseDocument doesn't, create the link
  if (!caseDoc) {
    missingCaseDocument++;
    await this.prisma.caseDocument.create({
      data: {
        caseId: email.caseId,
        documentId: existing.documentId,
        linkedBy: email.userId,
        firmId: doc.firmId,
        isOriginal: true,
      },
    });
    linkedToCase++;
  }
}
```

---

## Diagnostic Infrastructure

### GraphQL `_debug` field on `EmailImportResult`:

```graphql
type AttachmentSyncDetail {
  emailId: String!
  graphMessageId: String!
  attachmentsFromGraph: Int!
  attachmentsSynced: Int!
  attachmentsSkipped: Int!
  attachmentsAlreadyExist: Int!
  upgradedWithDocument: Int!
  orphanedDocumentIds: Int!
  missingCaseDocument: Int! # NEW: Documents without CaseDocument link
  linkedToCase: Int! # NEW: CaseDocument links created
  emailCaseId: String
  errors: [String!]!
}
```

---

## Files Modified

### Session 11 (CaseDocument fix)

- `services/gateway/src/services/email-attachment.service.ts` - Added CaseDocument detection and creation
- `services/gateway/src/services/email-to-case.service.ts` - Pass new diagnostic fields
- `services/gateway/src/graphql/schema/email-import.graphql` - Added missingCaseDocument, linkedToCase fields
- `apps/web/src/hooks/useEmailImport.ts` - Request new diagnostic fields

### Previous Sessions

- `services/gateway/src/graphql/resolvers/email-import.resolvers.ts` - Diagnostic logging
- `services/gateway/src/services/unified-timeline.service.ts` - Timeline sync logging fix

---

## Commits

### Session 11 (2025-12-15)

- `a478b86` - fix(gateway): create missing CaseDocument links for email attachments

### Session 10 (2025-12-15)

- `26c6ca3` - fix(gateway): detect orphaned documentIds and upgrade attachments

### Session 9 (2025-12-15)

- `7ac1e5f` - feat(gateway): add emailCaseId diagnostic to attachment sync

### Session 8 (2025-12-15)

- `3ec7d36` - fix: upgrade existing attachments with Document records

### Sessions 4-5 (2025-12-14/15)

- `7b9ffb5` - fix: use logger instead of console.log in timeline sync
- `3c11300` - fix: add required Document fields for email attachment import
- `2e017e2` - fix: use valid DocumentStatus enum value (FINAL, not ACTIVE)
- `fef9f8f` - fix: fix CaseDocument fields (linkedBy + firmId required)
- `1670257` - fix(gateway): add diagnostic logging for attachment import
- `9bb4d78` - fix(gateway): add debug info to EmailImportResult for diagnosis

---

## Session Log

- [2025-12-14 18:00] Issue created. Initial triage identified Prisma JSON array query mismatch.

- [2025-12-14 15:52] Session 2: Fixed Prisma JSON query with raw PostgreSQL JSONB operators.

- [2025-12-14 16:17] Session 2: Fixed timeline sync - emails now linked but not in CommunicationEntry.

- [2025-12-14 18:42] Session 3: Fixed invisible logging (console.log → logger).

- [2025-12-14 18:50] Session 3: **Emails now appearing in Communications tab!** Verified working.

- [2025-12-14 18:59] Session 3: Fixed attachment import missing Document fields (clientId, firmId, uploadedBy).

- [2025-12-14 19:23] Session 4: Fixed invalid DocumentStatus enum (ACTIVE → FINAL).

- [2025-12-14 19:40] Session 4: Fixed CaseDocument fields (linkedBy + firmId).

- [2025-12-15 09:00] Session 5: Tested after Bug 6 fix - emails work (23 imported), attachments still 0.

- [2025-12-15 09:20] Session 5: Added diagnostic `_debug` field to EmailImportResult.

- [2025-12-15 10:55] Session 6: Found MSAL token issue - user needs to re-authenticate.

- [2025-12-15] Session 8: Discovered attachments exist in EmailAttachment table but without Document records. Implemented upgrade logic.

- [2025-12-15] Session 9: Added emailCaseId diagnostic. Confirmed email.caseId IS set.

- [2025-12-15] Session 10: Found documentId points to non-existent Documents (orphaned). Added orphan detection.

- [2025-12-15] Session 10: Test showed orphanedDocumentIds: 0, meaning Documents DO exist. But upgradedWithDocument: 0.

- [2025-12-15 16:22] Session 11 started. Continuing from: Fixing (orphan detection showed Documents exist)

- [2025-12-15 16:22] Session 11: **NEW ROOT CAUSE** - Documents exist but CaseDocument links are missing. The Documents panel queries via CaseDocument, so without links, documents don't appear.

- [2025-12-15 16:22] Session 11: Implemented fix to detect and create missing CaseDocument links. Added `missingCaseDocument` and `linkedToCase` diagnostic fields.

- [2025-12-15 16:22] Session 11: Deployed commit `a478b86`. Gateway and web building.

---

## Next Steps

1. **Wait for deployment** - Check status:

   ```bash
   curl -s -H "Authorization: Bearer rnd_xPmOVitvPACYNfeNEMSDH5ZQfSR0" \
     "https://api.render.com/v1/services/srv-d4pkv8q4i8rc73fq3mvg/deploys?limit=1" \
     | jq '.[0] | {status: .deploy.status, commit: .deploy.commit.id[0:7]}'
   ```

2. **Test the fix** - Run import and check console for:

   ```javascript
   {
     missingCaseDocument: N,  // Should be > 0 (Documents needing links)
     linkedToCase: N,         // Should be > 0 (Links created)
   }
   ```

3. **Verify Documents panel** - After import, documents should appear

4. **Close issue** - If documents appear, mark as resolved

---

## Useful Commands

```bash
# Resume this issue
/ops-continue 024

# Deploy gateway
./scripts/render/deploy.sh gateway

# Check deployment status
curl -s -H "Authorization: Bearer rnd_xPmOVitvPACYNfeNEMSDH5ZQfSR0" \
  "https://api.render.com/v1/services/srv-d4pkv8q4i8rc73fq3mvg/deploys?limit=1" \
  | jq '.[0].deploy | {status, commit: .commit.id[0:7]}'

# Build gateway locally
pnpm --filter gateway build
```

---
