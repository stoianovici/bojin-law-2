# OPS-024: Email Import Not Completing - Emails/Docs Not Imported

| Field           | Value            |
| --------------- | ---------------- |
| **Status**      | Verifying        |
| **Type**        | Bug              |
| **Priority**    | P1-High          |
| **Created**     | 2025-12-14       |
| **Sessions**    | 4                |
| **Last Active** | 2025-12-14 19:40 |

---

## Description

In Case Details -> Communications, the Email Import Wizard displays preview data correctly (email count, contacts found, attachment count) but fails to actually import the emails or documents. After completing the wizard:

1. No emails are linked to the case
2. No documents/attachments are imported
3. No contacts are created as CaseActors

Additionally, the email search appears to not search the entire mailbox - possibly finding fewer emails than expected.

---

## Related Issue

This is a bug in the feature implemented in **OPS-022** (Email-to-Case Timeline Integration). OPS-022 status shows "In Progress" - the implementation was completed but never fully tested.

---

## Symptoms Reported

1. **Email preview shows data** - Wizard Step 2 displays:
   - Number of emails found
   - Date range
   - Discovered contacts
   - Attachment count
2. **No actual import occurs** - After completing wizard:
   - No emails appear in case communications
   - No documents imported to case
   - Contacts not created
3. **Incomplete mailbox search** - Email search may not be finding all relevant emails

---

## Root Cause Analysis (Initial Triage)

### Critical Issues Identified

1. **Prisma JSON Array Query Mismatch** (MOST LIKELY ROOT CAUSE)
   - **Location**: `services/gateway/src/services/email-to-case.service.ts:293-306`
   - **Problem**: The query uses `array_contains` which looks for exact object matches:
     ```typescript
     toRecipients: {
       array_contains: [{ address }],
     }
     ```
   - **Issue**: Emails store recipients as `{ address: "email", name: "Name" }`, but query only provides `{ address }`. PostgreSQL JSON array comparison fails when objects have additional fields.
   - **Impact**: Only matches emails where user is in `from` field (uses `string_contains` workaround), not `toRecipients` or `ccRecipients`.

2. **Silent Failure on Import**
   - The mutation may be returning `success: true` even when no emails are actually linked
   - Need to verify error handling and return values

3. **Missing Attachment Import Token**
   - If `accessToken` is not passed to mutation, attachment import is silently skipped
   - Warning logged but not shown to user

### Secondary Issues

4. **No validation that preview data matches execution**
   - Emails could change between preview (Step 2) and execution (Step 4)
   - No confirmation of what was actually imported

5. **CaseActor duplicate handling**
   - May be silently failing if contacts already exist

---

## Reproduction Steps

1. Navigate to Case Details for any case
2. Go to Communications tab
3. Click "Importă din Email" button
4. Enter email address(es) in Step 1
5. Observe preview data in Step 2 (shows email count, contacts, attachments)
6. Assign roles to contacts in Step 3
7. Click "Importă" in Step 4
8. **Expected**: Emails linked to case, documents imported, contacts created
9. **Actual**: Nothing imported, case remains unchanged

---

## Fix Strategy

### Priority 1: Fix Email Search Query

Fix the Prisma query in `findEmailsByParticipants()` to properly search JSON arrays:

```typescript
// Current (broken):
toRecipients: {
  array_contains: [{ address }];
}

// Option A: Use raw SQL with JSON operators
// Option B: Use string_contains on serialized JSON
// Option C: Fetch all emails and filter in JS (inefficient but reliable)
```

### Priority 2: Add Import Result Verification

- Return detailed counts of what was actually modified
- Show explicit success/failure for each operation
- Surface errors to UI

### Priority 3: Debug Logging

- Add detailed logging at each import step
- Log actual Prisma queries being executed
- Log database state before/after

---

## Local Dev Environment

```bash
# Start all services
cd /Users/mio/Desktop/dev/Bojin-law\ 2
pnpm dev

# Services:
# - Frontend: http://localhost:3000
# - Gateway: http://localhost:4000/graphql (GraphQL Playground)

# Test GraphQL directly:
# 1. Open http://localhost:4000/graphql
# 2. Run previewEmailImport query with test email
# 3. Check returned data vs database
# 4. Run executeEmailImport mutation
# 5. Verify database changes with Prisma Studio:
npx prisma studio --schema=packages/database/prisma/schema.prisma
```

---

## Conventions to Follow

From `docs/project-conventions.md`:

- **Romanian UI text** - All user-facing labels in Romanian
- **Section dividers** - Use `// ====` to organize code sections
- **Service singleton pattern** - Export singleton instances
- **Error handling** - Throw errors for validation failures, GraphQL handles them
- **Logging** - Use existing logger patterns for debugging

---

## Session Log

- [2025-12-14 18:00] Issue created. Initial triage identified likely root cause: Prisma JSON array query mismatch in `findEmailsByParticipants()`. The `array_contains` operator requires exact object matches but emails store additional fields (name) alongside address. This causes To/CC recipient searches to fail, only matching From field via `string_contains` workaround.

- [2025-12-14 15:52] Session 2: Fixed the Prisma JSON array query. Replaced broken `array_contains` with raw PostgreSQL query using `jsonb_array_elements()` to properly search within JSON arrays. The new implementation:
  - Uses `$queryRawUnsafe` for PostgreSQL JSONB operators
  - Searches `from->>'address'` for the from field
  - Uses `EXISTS (SELECT 1 FROM jsonb_array_elements(...))` for toRecipients/ccRecipients
  - Maps snake_case DB columns back to camelCase for Prisma compatibility
  - Gateway compiles and runs successfully. Ready for production testing.

- [2025-12-14 16:17] Session 2 continued: Found second bug during production testing. Emails were linked to case (caseId set) but NOT synced to `CommunicationEntry` table. The Communications tab uses `UnifiedTimeline` component which fetches from `CommunicationEntry`, not directly from `Email` table. Added `unifiedTimelineService.syncEmailToCommunicationEntry()` call after bulk email linking. Gateway deployed.

- [2025-12-14 18:42] Session 3: Found third bug - `unified-timeline.service.ts` was using `console.log` instead of the `logger` utility used by other services. This caused sync-related logs to be invisible in Render production logs (different output stream). Replaced all `console.log` calls with `logger.info/warn` and added more detailed logging to diagnose the sync flow. Commit `7b9ffb5`, deploy triggered.

- [2025-12-14 18:50] Session 3 continued: **Emails now appearing in Communications tab!** User confirmed fix works.

- [2025-12-14 18:59] Session 3: Fixed attachment import. The `storeInOneDrive()` method in `email-attachment.service.ts` was missing required Document fields:
  - `clientId` - required relation to Client
  - `firmId` - required relation to Firm
  - `uploadedBy` - required relation to User (was using non-existent `createdBy`)
  - Used `DocumentStatus.ACTIVE` enum instead of string `'active'`
  - Added `CaseDocument` junction table link (Document doesn't have direct caseId field)
    Commit `3c11300`, deploy triggered.

- [2025-12-14 19:23] Session 4: Found Bug 5 - `DocumentStatus.ACTIVE` doesn't exist. Valid enum values are only `DRAFT`, `FINAL`, `ARCHIVED`. This caused silent Prisma validation error. Fixed to use `DocumentStatus.FINAL`. Commit `2e017e2`.

- [2025-12-14 19:40] Session 4: Found Bug 6 - `CaseDocument` junction table requires `linkedBy` (not `addedBy`) and `firmId` (was missing). Fixed both fields. Commit `fef9f8f`, deploy triggered. Awaiting verification that attachments appear in Documents panel.

---

## Files Involved

### Primary Investigation Targets

- `services/gateway/src/services/email-to-case.service.ts` - Main service with query logic
- `services/gateway/src/services/unified-timeline.service.ts` - Timeline sync (Bug 3 fix)
- `services/gateway/src/services/email-attachment.service.ts` - Attachment import (Bugs 4-6 fixes)
- `services/gateway/src/graphql/resolvers/email-import.resolvers.ts` - Resolver validation

### UI Components (for error display)

- `apps/web/src/components/case/EmailImportWizard.tsx` - Wizard UI
- `apps/web/src/hooks/useEmailImport.ts` - Hook with GraphQL calls

### Database Reference

- `packages/database/prisma/schema.prisma` - Email model structure

---
