# OPS-024: Email Import Not Completing - Attachments Not Imported

| Field           | Value            |
| --------------- | ---------------- |
| **Status**      | Root Cause Found |
| **Type**        | Bug              |
| **Priority**    | P1-High          |
| **Created**     | 2025-12-14       |
| **Sessions**    | 8                |
| **Last Active** | 2025-12-15       |

---

## Current State

**Email import to Communications tab**: WORKING (23 emails imported)
**Attachment import to Documents panel**: NOT WORKING (0 attachments imported)

The preview step correctly shows attachments exist (9 detected), but after import completes, 0 attachments are imported.

---

## ROOT CAUSE IDENTIFIED (Session 6)

**The MS access token is `null` when ExecuteEmailImport runs.**

Console logs show:

```
[Apollo] Got MS access token for operation: ExecuteEmailImport token: null
```

The MSAL session has expired and silent token refresh fails:

- `InteractionRequiredAuthError: AADSTS160021: Application requested a user session which does not exist`
- `BrowserAuthError: monitor_window_timeout: Token acquisition in iframe failed due to timeout`

The app falls back to session cookie auth (works for platform) but has no Graph API token for Microsoft operations like fetching attachment content.

**Solution**: Re-authenticate with Microsoft to get fresh tokens.

---

## Technical Investigation

### What's Working

1. MS access token IS being passed from frontend (Apollo logs confirm: `Got MS access token for operation: ExecuteEmailImport`)
2. Emails are being linked to cases correctly (23 emails)
3. Emails appear in Communications tab (via CommunicationEntry sync)
4. Preview correctly detects attachments exist (9 shown)

### What's NOT Working

1. Attachments return 0 imported
2. Documents are not being created in Documents panel
3. No visible errors in client-side logs

### Possible Root Causes (Under Investigation)

1. **`hasAttachments` flag mismatch** - Database `has_attachments` field might be `false` for emails that actually have attachments. Need to verify `emailsWithAttachmentsCount` from `_debug` output.

2. **Attachment sync silently failing** - OneDrive API calls might be failing, Graph API might return empty attachment list, or all attachments are inline images.

3. **Token not reaching service layer** - Apollo shows token sent, but need to verify `hadAccessToken` on server side via `_debug`.

---

## Diagnostic Infrastructure Added (Session 5)

### GraphQL `_debug` field on `EmailImportResult`:

```graphql
type EmailImportDebugInfo {
  hadAccessToken: Boolean!
  importAttachmentsRequested: Boolean!
  emailsWithAttachmentsCount: Int!
}
```

### Server-side logging in `email-to-case.service.ts`:

- Logs whether accessToken is available
- Logs `emailsWithAttachmentsCount`
- Logs sync results for each email

### Client-side logging in `useEmailImport.ts`:

- Logs full import result including `_debug` to console

---

## Files Modified

### Session 5 (Diagnostic additions)

- `services/gateway/src/graphql/resolvers/email-import.resolvers.ts` - Added logger import, diagnostic logging
- `services/gateway/src/services/email-to-case.service.ts` - Added `_debug` field population, diagnostic logging
- `services/gateway/src/graphql/schema/email-import.graphql` - Added `EmailImportDebugInfo` type
- `apps/web/src/hooks/useEmailImport.ts` - Added `_debug` to GraphQL fragment, console logging

### Previous Sessions (Bug fixes)

- `services/gateway/src/services/unified-timeline.service.ts` - Timeline sync logging fix
- `services/gateway/src/services/email-attachment.service.ts` - Document/CaseDocument field fixes

---

## Commits

### Session 4 (2025-12-14)

1. `7b9ffb5` - fix: use logger instead of console.log in timeline sync
2. `3c11300` - fix: add required Document fields for email attachment import
3. `2e017e2` - fix: use valid DocumentStatus enum value (FINAL, not ACTIVE)
4. `fef9f8f` - fix: fix CaseDocument fields (linkedBy + firmId required)

### Session 5 (2025-12-15)

5. `1670257` - fix(gateway): add diagnostic logging for attachment import
6. `9bb4d78` - fix(gateway): add debug info to EmailImportResult for diagnosis

---

## Session Log

- [2025-12-14 18:00] Issue created. Initial triage identified Prisma JSON array query mismatch.

- [2025-12-14 15:52] Session 2: Fixed Prisma JSON query with raw PostgreSQL JSONB operators.

- [2025-12-14 16:17] Session 2: Fixed timeline sync - emails now linked but not in CommunicationEntry.

- [2025-12-14 18:42] Session 3: Fixed invisible logging (console.log → logger).

- [2025-12-14 18:50] Session 3: **Emails now appearing in Communications tab!** Verified working.

- [2025-12-14 18:59] Session 3: Fixed attachment import missing Document fields (clientId, firmId, uploadedBy).

- [2025-12-14 19:23] Session 4: Fixed invalid DocumentStatus enum (ACTIVE → FINAL).

- [2025-12-14 19:40] Session 4: Fixed CaseDocument fields (linkedBy + firmId).

- [2025-12-15 09:00] Session 5: Tested after Bug 6 fix - emails work (23 imported), attachments still 0.

- [2025-12-15 09:20] Session 5: Added diagnostic `_debug` field to EmailImportResult. Deployed commits `1670257` and `9bb4d78`.

- [2025-12-15 09:25] Session 5: Test result shows MS token IS being sent from frontend (Apollo logs). Need to expand `[useEmailImport] Import result: Object` in console to see `_debug` values.

- [2025-12-15 10:55] Session 6: **ROOT CAUSE FOUND** - Console logs show `[Apollo] Got MS access token for operation: ExecuteEmailImport token: null`. MSAL session expired, silent refresh failing with `AADSTS160021`. User needs to re-authenticate with Microsoft.

- [2025-12-15] Session 7 started. Continuing from: Root Cause Found

- [2025-12-15] Session 8 started. Continuing from: Root Cause Found

- [2025-12-15] Session 8: Fixed console flooding from cid: image URLs. Added `sanitizeEmailHtml()` function to `EmailThreadView.tsx` and `TimelineEntryCard.tsx` that replaces `cid:` src attributes with a transparent placeholder before rendering, preventing ERR_UNKNOWN_URL_SCHEME errors.

---

## Next Steps

1. **Get `_debug` values** - In browser console, expand `[useEmailImport] Import result: Object` to see:
   - `hadAccessToken` - Was token received by server?
   - `emailsWithAttachmentsCount` - How many emails had `hasAttachments=true`?

2. **Based on `_debug` results**:
   - If `emailsWithAttachmentsCount = 0`: Check how `hasAttachments` is populated during email sync
   - If `emailsWithAttachmentsCount > 0` but 0 imported: Check Render logs for attachment sync errors

3. **Alternative**: Add attachment sync errors to the result `errors` array for client visibility

---

## Useful Commands

```bash
# Deploy gateway
./scripts/render/deploy.sh gateway

# Check deployment status
curl -s -H "Authorization: Bearer rnd_xPmOVitvPACYNfeNEMSDH5ZQfSR0" \
  "https://api.render.com/v1/services/srv-d4pkv8q4i8rc73fq3mvg/deploys?limit=1" \
  | jq '.[0].deploy | {status, commit: .commit.id[0:7]}'

# Build gateway locally
pnpm --filter gateway build
```

---
