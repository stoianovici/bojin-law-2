# OPS-092: Document Preview Fails with 400 Error

| Field           | Value            |
| --------------- | ---------------- |
| **Status**      | Resolved         |
| **Type**        | Bug              |
| **Priority**    | P1-High          |
| **Created**     | 2025-12-21       |
| **Sessions**    | 4                |
| **Last Active** | 2025-12-21 23:27 |

## Description

Document previews fail with "Previzualizare indisponibilă" (Preview unavailable) error. Clicking the "Previzualizare" button on any document in `/documents` shows error message "Nu s-a putut genera link-ul de previzualizare" (Could not generate preview link).

Browser console shows: `POST /api/graphql 400 (Bad Request)`

## Symptom Category

**Category A**: X Not Appearing in UI

## Investigation Summary

| Hypothesis             | Verdict       | Key Finding                                                    |
| ---------------------- | ------------- | -------------------------------------------------------------- |
| Frontend data fetching | ❌ Root cause | GraphQL query used `ID!` type but schema expects `UUID!`       |
| API resolver logic     | ✅ Clear      | Resolver works correctly when request passes schema validation |
| OneDrive service call  | ✅ Clear      | Try-catch with R2 fallback works correctly                     |
| Missing error handling | ✅ Fixed      | Added try-catch around OneDrive call in resolver               |

## Root Cause

**Primary cause**: GraphQL type mismatch in frontend query.

The frontend query in `useDocumentPreview.ts` used `$documentId: ID!` but the schema expects `$documentId: UUID!`. This caused GraphQL validation to fail with 400 error before the resolver even ran.

**Error message from gateway**:

```
Variable "$documentId" of type "ID!" used in position expecting type "UUID!"
```

**Secondary issue** (also fixed): The `documentPreviewUrl` resolver (`document.resolvers.ts:522-534`) called OneDrive service without error handling:

```typescript
// Line 522-534 - NO TRY-CATCH
const previewInfo = await oneDriveService.getPreviewUrl(
  accessToken,
  document.oneDriveId,
  document.fileType
);

if (previewInfo) {
  return {
    url: previewInfo.url,
    source: previewInfo.source,
    expiresAt: previewInfo.expiresAt,
  };
}
```

When the OneDrive API call fails (due to invalid/expired token, deleted file, or other MS Graph errors), the error propagates directly to the client as a 400 response instead of falling back to R2 storage.

**Contributing factors:**

1. User may be authenticated via session cookie but MSAL cache is empty (no MS token)
2. OneDrive item ID in database may be stale (file deleted from OneDrive)
3. MS Graph token may be expired
4. R2 fallback path (line 537-568) is never reached when OneDrive call throws

## Recommended Fix

### Option 1: Add try-catch with R2 fallback (Recommended)

```typescript
// Try OneDrive preview first
if (document.oneDriveId && context.accessToken) {
  try {
    const previewInfo = await oneDriveService.getPreviewUrl(
      context.accessToken,
      document.oneDriveId,
      document.fileType
    );

    if (previewInfo) {
      return {
        url: previewInfo.url,
        source: previewInfo.source,
        expiresAt: previewInfo.expiresAt,
      };
    }
  } catch (error) {
    logger.warn('OneDrive preview failed, falling back to R2', {
      documentId: args.documentId,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
    // Fall through to R2 fallback
  }
}

// R2 fallback (existing code at line 537-568)
```

### Option 2: Return null instead of throwing

If OneDrive fails and R2 is not available, return `null` gracefully instead of throwing, letting the frontend show "Download only" option.

## Fix Applied

**Session 2 (2025-12-21)**: Applied Option 1 - try-catch with R2 fallback

**Session 3 (2025-12-21)**: Fixed accessToken path + updated types

Changes to `services/gateway/src/graphql/resolvers/document.resolvers.ts`:

1. Combined `document.oneDriveId` and `context.user?.accessToken` into single condition
2. Wrapped OneDrive API call in try-catch block
3. On error, log warning with documentId/oneDriveId and fall through to R2 fallback
4. Fixed accessToken path from `context.accessToken` to `context.user?.accessToken`
5. Updated Context interface to include `accessToken?: string` in user object
6. Added `hasAccessToken` to debug logging for troubleshooting

```typescript
// Context type update (lines 19-29)
export interface Context {
  user?: {
    id: string;
    firmId: string;
    role: 'Partner' | 'Associate' | 'Paralegal' | 'BusinessOwner';
    email: string;
    accessToken?: string; // Story 5.1: MS access token for email/OneDrive operations
  };
  accessToken?: string; // Deprecated: use context.user.accessToken instead
}

// Try OneDrive preview first (supports Office docs + PDFs + images)
// OPS-092: Use context.user?.accessToken - the MS access token is stored in user context
if (document.oneDriveId && context.user?.accessToken) {
  try {
    const previewInfo = await oneDriveService.getPreviewUrl(
      context.user.accessToken,
      document.oneDriveId,
      document.fileType
    );

    if (previewInfo) {
      return {
        url: previewInfo.url,
        source: previewInfo.source,
        expiresAt: previewInfo.expiresAt,
      };
    }
  } catch (error) {
    // OPS-092: Log and fall through to R2 fallback instead of propagating error
    logger.warn('OneDrive preview failed, falling back to R2', {
      documentId: args.documentId,
      oneDriveId: document.oneDriveId,
      error: error instanceof Error ? error.message : 'Unknown error',
    });
    // Fall through to R2 fallback below
  }
}
```

## Environment Strategy

| Mode                   | Command                        | Use When                     |
| ---------------------- | ------------------------------ | ---------------------------- |
| Local dev (default)    | `pnpm dev`                     | Feature development          |
| Production data        | `source .env.prod && pnpm dev` | Bug investigation, real data |
| Production-like Docker | `pnpm preview`                 | Pre-deploy verification      |
| Full parity check      | `pnpm preflight:full`          | Before any deployment        |

**Recommended for this issue**: Local dev (bug is reproducible locally)

## Local Verification Status

| Step           | Status     | Date       | Notes                            |
| -------------- | ---------- | ---------- | -------------------------------- |
| Prod data test | ✅ Passed  | 2025-12-21 | Preview works with OneDrive URLs |
| Preflight      | ⬜ Pending |            |                                  |
| Docker test    | ⬜ Pending |            |                                  |

**Verified**: Partially (browser test passed)

## Session Log

- [2025-12-21 22:30] Issue created via /ops-investigate. Category: A. Root cause: Missing error handling around OneDrive service call in documentPreviewUrl resolver.
- [2025-12-21 23:00] Session 2 started. Applied fix: try-catch with R2 fallback. TypeScript compiles cleanly. Ready for verification.
- [2025-12-21 23:20] Session 3: Additional fixes applied and investigation continued.
- [2025-12-21 23:27] Session 4: Found actual root cause - ID vs UUID type mismatch. Fixed and verified with Playwright.

### Session 4 Findings (Final)

**Actual root cause discovered:**

- Added debug logging to GraphQL proxy which revealed the real error
- Error: `Variable "$documentId" of type "ID!" used in position expecting type "UUID!".`
- Frontend query used `ID!` but schema expected `UUID!`

**Fix applied:**
Changed `apps/web/src/hooks/useDocumentPreview.ts`:

```typescript
// Before (broken)
query GetDocumentPreviewUrl($documentId: ID!) { ... }
query GetAttachmentPreviewUrl($attachmentId: ID!) { ... }

// After (fixed)
query GetDocumentPreviewUrl($documentId: UUID!) { ... }
query GetAttachmentPreviewUrl($attachmentId: UUID!) { ... }
```

**Verification:**

- Tested with Playwright browser automation
- Preview button now opens document in iframe successfully
- No 400 errors in browser console
- All GraphQL requests return 200

## Files Involved

**Primary fix location:**

- `apps/web/src/hooks/useDocumentPreview.ts` (GraphQL query type fix: ID! → UUID!)

**Secondary fix location:**

- `services/gateway/src/graphql/resolvers/document.resolvers.ts` (lines 514-540, try-catch with R2 fallback)

**Related files:**

- `services/gateway/src/services/onedrive.service.ts` (getPreviewUrl method)
- `apps/web/src/components/preview/DocumentPreviewModal.tsx`

## Acceptance Criteria

1. Document preview works when OneDrive is available
2. Document preview falls back to R2 when OneDrive fails
3. Graceful error message shown when neither OneDrive nor R2 is available
4. No 400 errors in browser console for preview requests
