# OPS-046: Case Summary Data Model

**Status:** Implementing | **Priority:** P1-High | **Type:** Feature
**Created:** 2025-12-19 | **Blocks:** OPS-047, OPS-048, OPS-049, OPS-050
**Sessions:** 1 | **Last Active:** 2025-12-19

## Summary

Create the database schema foundation for persistent AI case summaries and unified event chronology.

## Background

Currently, case summaries are generated on-demand via `CaseConversationSummaryPanel` and not persisted. The new architecture requires:

1. Cached summaries that persist until new data arrives
2. Unified chronology aggregating events from all sources
3. Importance scoring for chronology filtering

## Acceptance Criteria

- [x] `CaseSummary` model created with all fields
- [x] `CaseEvent` model created with importance scoring
- [x] Enums for event types and importance levels
- [x] Schema pushed to local database successfully
- [x] Indexes for efficient querying (caseId, isStale, importance, occurredAt)

## Implementation

### CaseSummary Model

Added to `packages/database/prisma/schema.prisma`:

- `id` - cuid primary key
- `caseId` - unique foreign key to Case (cascade delete)
- `executiveSummary` - Text field for AI-generated summary
- `currentStatus` - Text field for current case status
- `keyDevelopments` - JSON array of key developments
- `openIssues` - JSON array of open issues
- `generatedAt` - Timestamp when summary was generated
- `isStale` - Boolean flag for staleness detection
- `dataVersionHash` - Hash to detect data changes
- `emailCount`, `documentCount`, `noteCount`, `taskCount` - Input counts

Indexes:

- `case_summaries_case_id_idx` - for case lookups
- `case_summaries_is_stale_idx` - for stale summary queries

### CaseEvent Model

Added to `packages/database/prisma/schema.prisma`:

- `id` - cuid primary key
- `caseId` - foreign key to Case (cascade delete)
- `eventType` - CaseEventType enum
- `sourceId` - ID of source record (for deduplication)
- `title` - Event title (500 chars)
- `description` - Optional event description
- `importance` - EventImportance enum (High/Medium/Low)
- `occurredAt` - When event occurred
- `actorId` - Optional foreign key to User (SetNull on delete)

Indexes:

- `case_events_case_id_occurred_at_idx` - chronological queries
- `case_events_case_id_importance_idx` - importance filtering
- `case_events_event_type_source_id_key` - unique constraint (prevents duplicates)

### Enums

```prisma
enum CaseEventType {
  DocumentUploaded
  DocumentSigned
  DocumentDeleted
  EmailReceived
  EmailSent
  EmailCourt
  NoteCreated
  NoteUpdated
  TaskCreated
  TaskCompleted
  CaseStatusChanged
  TeamMemberAdded
  ContactAdded
}

enum EventImportance {
  High
  Medium
  Low
}
```

### Case Model Updates

Added relations:

- `summary CaseSummary?` - optional one-to-one relation
- `events CaseEvent[]` - one-to-many relation

## Local Verification Status

| Step           | Status     | Date       | Notes                       |
| -------------- | ---------- | ---------- | --------------------------- |
| Prod data test | ⬜ Pending |            | Schema only - no UI changes |
| Preflight      | ✅ Passed  | 2025-12-19 | Build passes                |
| Docker test    | ⬜ Pending |            | Need to run                 |

**Verified**: No (schema-only, Docker test pending)

## Session Log

- [2025-12-19] Session 1 started. First implementation.
- [2025-12-19] Added CaseEventType and EventImportance enums
- [2025-12-19] Added CaseSummary model with all fields and indexes
- [2025-12-19] Added CaseEvent model with importance scoring
- [2025-12-19] Updated Case model with summary and events relations
- [2025-12-19] Updated User model with caseEventActions relation
- [2025-12-19] Schema pushed to local database successfully
- [2025-12-19] Verified tables and indexes created correctly

## Files Modified

- `packages/database/prisma/schema.prisma`

## Next Steps

1. Run `pnpm preflight` to verify build passes
2. Create migration file for production deployment
3. Proceed with OPS-047 (Event Triggers), OPS-048 (Summary Service), OPS-049 (Chronology Query)
