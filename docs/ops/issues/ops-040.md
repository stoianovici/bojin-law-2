# OPS-040: Court Email Detection & INSTANȚE Routing

**Status:** Open | **Priority:** P1-High | **Type:** Feature | **Created:** 2025-12-18

## Overview

Handle emails from courts and authorities separately. They match by case reference number (not contact) and have their own "folder" for unassigned items.

## Dependencies

- **Depends on:** OPS-035 (data model), OPS-038 (reference numbers on cases)
- **Blocks:** OPS-041
- **Parallel with:** OPS-038, OPS-039

## Context

Part of the Communications Architecture Rethink. Court emails are different:

- They come from institutional addresses (configured in GlobalEmailSource)
- They should NOT use contact matching
- They should match by case reference number in subject/body
- Unmatched court emails go to a special INSTANȚE folder (not NECLAR)

**Existing work:** GlobalEmailSource model exists with categories (Court, Notary, Bailiff, Authority, Other).

## Requirements

### 1. Court Email Detection

```typescript
async function isFromInstitution(email: Email): Promise<boolean> {
  const senderDomain = extractDomain(email.from);
  const senderEmail = extractEmail(email.from);

  const sources = await prisma.globalEmailSource.findMany({
    where: {
      firmId: email.firmId,
      OR: [{ domains: { has: senderDomain } }, { emails: { has: senderEmail } }],
    },
  });

  return sources.length > 0;
}
```

### 2. Court Email Classification Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                         COURT FLOW                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ Extract case #  │
                    │ from subject    │
                    │ and body        │
                    └────────┬────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ Match against   │
                    │ case reference  │
                    │ numbers         │
                    └────────┬────────┘
                              │
              ┌───────────────┴───────────────┐
              │                               │
         Found match                    No match
              │                               │
              ▼                               ▼
        Assign to case              Mark as COURT_UNASSIGNED
        (CLASSIFIED)                → INSTANȚE folder
```

### 3. Reference Number Matching

```typescript
async function classifyCourtEmail(email: Email): Promise<ClassificationResult> {
  // Extract all reference numbers from email
  const references = extractReferenceNumbers(`${email.subject} ${email.bodyContent}`);

  if (references.length === 0) {
    return {
      state: 'COURT_UNASSIGNED',
      reason: 'NO_REFERENCE_NUMBER',
    };
  }

  // Find cases with matching reference numbers
  const matchingCases = await prisma.case.findMany({
    where: {
      firmId: email.firmId,
      referenceNumbers: { hasSome: references },
    },
  });

  if (matchingCases.length === 0) {
    return {
      state: 'COURT_UNASSIGNED',
      reason: 'NO_MATCHING_CASE',
      extractedReferences: references,
    };
  }

  if (matchingCases.length === 1) {
    return {
      caseId: matchingCases[0].id,
      state: 'CLASSIFIED',
      confidence: 1.0,
      matchType: 'REFERENCE_NUMBER',
    };
  }

  // Multiple matches - should be rare, but handle it
  return {
    state: 'COURT_UNASSIGNED',
    reason: 'MULTIPLE_MATCHES',
    suggestedCases: matchingCases.map((c) => ({ id: c.id, reference: c.referenceNumbers })),
  };
}
```

### 4. INSTANȚE Folder Query

```graphql
# Get court emails not assigned to any case
query getUnassignedCourtEmails($userId: ID!) {
  unassignedCourtEmails(userId: $userId) {
    id
    subject
    from
    receivedDateTime
    extractedReferences # References found but no case match
    suggestedCases {
      # If multiple matches found
      id
      title
      referenceNumbers
    }
  }
}
```

### 5. Manual Assignment from INSTANȚE

When user assigns a court email to a case:

1. Set `caseId` on the email
2. Set `classificationState = CLASSIFIED`
3. Optionally: Offer to add the reference number to the case if it was extracted

```graphql
mutation assignCourtEmailToCase($emailId: ID!, $caseId: ID!, $addReference: Boolean) {
  assignCourtEmailToCase(emailId: $emailId, caseId: $caseId, addReference: $addReference) {
    email {
      id
      caseId
      classificationState
    }
    case {
      id
      referenceNumbers
    }
  }
}
```

## Acceptance Criteria

- [ ] Court/authority emails detected via GlobalEmailSource
- [ ] Reference numbers extracted from subject and body
- [ ] Exact match on reference number assigns to case
- [ ] No match → COURT_UNASSIGNED state
- [ ] Multiple matches → COURT_UNASSIGNED with suggestions
- [ ] Query for unassigned court emails (INSTANȚE folder)
- [ ] Manual assignment mutation works
- [ ] Option to add reference number to case during assignment
- [ ] Classification logged for audit
- [ ] No TypeScript errors

## Files to Modify

- `services/gateway/src/services/email-classification.service.ts` - court flow
- `services/gateway/src/graphql/schema/email-classification.graphql`
- `services/gateway/src/graphql/resolvers/email-classification.resolver.ts`
- Build on existing `GlobalEmailSource` queries

## Estimated Scope

Medium - Court-specific classification logic.

---

## Session Log

_(Add session notes here as work progresses)_
