# OPS-286: Timesheet billable checkbox cannot be toggled for team member entries

| Field        | Value                         |
| ------------ | ----------------------------- |
| **Status**   | Fixing (Verification Pending) |
| **Type**     | Bug                           |
| **Priority** | P1-High                       |
| **Created**  | 2025-12-27                    |

## Symptom

In the timesheet view (Fisa de Pontaj), Partners cannot toggle the "facturabil" checkbox for time entries that belong to other team members. The checkbox appears interactive but clicking it has no effect.

## Root Cause

**File**: `services/gateway/src/services/time-entry.service.ts:151-154`

The `updateTimeEntry` method enforces owner-only updates:

```typescript
// Only owner can update their own entries
if (existing.userId !== userId) {
  throw new Error('Unauthorized: Cannot update another user time entry');
}
```

However, the timesheet mode is specifically designed for Partners to review and manage team time entries. Partners should be able to toggle billable status for invoicing purposes without being the entry owner.

**Flow**:

1. Partner opens `/activitate-echipa` (Team Activity page)
2. Views timesheet entries for a case (may include other team members)
3. Clicks billable checkbox on team member's entry
4. Frontend calls `UpdateTimeEntryBillable` mutation
5. Backend rejects with "Unauthorized: Cannot update another user time entry"
6. UI silently fails (optimistic update reverts)

## Fix

Update `time-entry.service.ts` to allow Partners/BusinessOwners to update billable status:

```typescript
async updateTimeEntry(id: string, input: UpdateTimeEntryInput, userId: string): Promise<TimeEntry> {
  // Fetch existing entry AND the updating user's role
  const [existing, updatingUser] = await Promise.all([
    this.prisma.timeEntry.findUnique({
      where: { id },
      select: { id: true, userId: true, firmId: true },
    }),
    this.prisma.user.findUnique({
      where: { id: userId },
      select: { role: true, firmId: true },
    }),
  ]);

  if (!existing) {
    throw new Error('Time entry not found');
  }

  if (!updatingUser) {
    throw new Error('User not found');
  }

  // Partners and BusinessOwners can update any entry in their firm
  // Regular users can only update their own entries
  const isAdminRole = updatingUser.role === 'Partner' || updatingUser.role === 'BusinessOwner';
  const isSameFirm = existing.firmId === updatingUser.firmId;
  const isOwner = existing.userId === userId;

  if (!isOwner && !(isAdminRole && isSameFirm)) {
    throw new Error('Unauthorized: Cannot update another user time entry');
  }

  // ... rest of update logic
}
```

## Verification

- [ ] Partner can toggle billable status on team member entries
- [ ] Regular users cannot toggle billable on other users' entries
- [ ] Firm isolation still enforced (can't update entries from other firms)
- [x] Run `pnpm preflight`
- [ ] Test in `pnpm preview` with production data

## Session Log

| Date       | Summary                                                                                            |
| ---------- | -------------------------------------------------------------------------------------------------- |
| 2025-12-27 | Initial investigation - identified authorization issue in time-entry.service.ts                    |
| 2025-12-27 | Implemented fix: Partners/BusinessOwners can now update any entry in their firm. Preflight passed. |
