# OPS-113: Rule-Based Document Filtering

| Field           | Value      |
| --------------- | ---------- |
| **Status**      | Fixing     |
| **Type**        | Feature    |
| **Priority**    | P2-Medium  |
| **Created**     | 2024-12-23 |
| **Sessions**    | 2          |
| **Last Active** | 2024-12-23 |

## Description

Filter junk attachments during email import using rule-based filtering. Currently, ALL email attachments are imported when emails sync, including:

- Calendar invites (.ics files)
- Tiny images (< 5KB - tracking pixels, spacer images)
- Email signature images (logo.png, signature.jpg)
- Inline decorative images
- Outlook wrapper files (winmail.dat)

This clutters case document lists and wastes storage. Estimated 40-60% of email attachments are noise.

## Goals

1. **Reduce document clutter** - Filter obvious junk before it reaches case folders
2. **Preserve recoverability** - Track dismissed attachments so they can be recovered if needed
3. **Zero false positives on important docs** - Conservative rules, err on side of importing

## Approach: Rule-Based Filtering

Apply configurable filter rules during attachment sync. Rules check:

- File extension (.ics, .vcf, .gif)
- Content type (text/calendar, image/\*)
- File size (< 5KB images are likely noise)
- Filename patterns (image001.png, logo._, signature._)
- Inline flag (isInline from Graph API)

### Default Filter Rules

| Rule ID             | Name                         | Description                    | Action  |
| ------------------- | ---------------------------- | ------------------------------ | ------- |
| calendar-invites    | Calendar Invites             | .ics, .vcf, text/calendar      | dismiss |
| tiny-images         | Tiny Images (< 5KB)          | Tracking pixels, spacers       | dismiss |
| inline-small-images | Small Inline Images (< 20KB) | Email body decorations         | dismiss |
| email-cruft-images  | Email Cruft Images           | image001.png, img\d+.\*        | dismiss |
| signature-files     | Signature/Logo Files         | signature._, logo._, banner.\* | dismiss |
| animated-gifs       | Small Animated GIFs (< 50KB) | Animated signatures, emojis    | dismiss |
| winmail-dat         | Outlook Wrapper Files        | winmail.dat, ATT\*.dat         | dismiss |

### Filter Actions

- **dismiss**: Don't download/store content, create minimal tracking record
- **quarantine**: Store in R2 but don't link to case (future enhancement)
- **flag**: Import normally but mark for review (future enhancement)

## Implementation Plan

### Phase 1: Core Filter Service (MVP)

1. Create `DocumentFilterService` in `services/gateway/src/config/document-filter.config.ts`
   - Define FilterRule and FilterCondition types
   - Implement rule evaluation logic
   - Export DEFAULT_FILTER_RULES constant
   - Add `analyzeBatch()` for testing rules against existing data

2. Add schema fields for tracking dismissed attachments:

   ```prisma
   model EmailAttachment {
     // ... existing fields ...
     filterStatus    String?   // 'imported' | 'dismissed' | 'quarantined' | 'flagged'
     filterRuleId    String?   // Which rule matched
     filterReason    String?   // Human-readable reason
     dismissedAt     DateTime? // When filtered
   }
   ```

3. Integrate into `EmailAttachmentService.syncAllAttachments()`:
   - After non-file check, evaluate against filter rules
   - If dismissed: create minimal EmailAttachment record (no content download)
   - If imported: proceed with normal flow
   - Log filtering decisions

### Phase 2: UI for Dismissed Attachments (Future)

- Add "Atașamente respinse" (Dismissed attachments) section in case documents
- Allow "Importă oricum" (Import anyway) action
- Show filter stats: "847 atașamente respinse în ultimele 30 zile"

### Phase 3: Configurable Rules (Future)

- Store rules in database per firm
- Admin UI for enabling/disabling rules
- Custom rule creation

## Files Involved

### Primary Changes

- `services/gateway/src/config/document-filter.config.ts` (new)
- `services/gateway/src/services/email-attachment.service.ts` (modify syncAllAttachments)
- `packages/database/prisma/schema.prisma` (add EmailAttachment fields)

### Related (No Changes Needed)

- `services/gateway/src/services/email-sync.service.ts` (calls attachment service)
- `apps/legacy-import/` (could benefit from similar filtering in future)

## Acceptance Criteria

- [x] Filter rules configuration file with default rules
- [x] DocumentFilterService evaluates attachments against rules
- [x] Dismissed attachments tracked in database (not downloaded)
- [x] Filtering integrated into syncAllAttachments flow
- [x] Logging shows filter decisions
- [x] Migration for new EmailAttachment fields

## Testing Strategy

1. **Unit Tests**: DocumentFilterService rule evaluation
2. **Data Analysis**: Run `analyzeBatch()` against existing EmailAttachment data to validate rules
3. **Manual Test**: Sync emails with attachments, verify filtering works

## Environment Strategy

| Mode                   | Command                        | Use When                     |
| ---------------------- | ------------------------------ | ---------------------------- |
| Local dev (default)    | `pnpm dev`                     | Feature development          |
| Production data        | `source .env.prod && pnpm dev` | Analyze real attachment data |
| Production-like Docker | `pnpm preview`                 | Pre-deploy verification      |

**Recommended for this issue**: Local dev for implementation, then prod data to validate rules against real attachments

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

## Conventions to Follow

- Use section dividers (`// ====`) to organize Types and Service sections
- Export singleton instance of DocumentFilterService
- Romanian UI text for any user-facing strings
- JSDoc comments for service methods

## Session Log

- [2024-12-23] Issue created from /ops-ideate session. Comprehensive prototype designed with rule types, default rules, and integration points identified. Ready for implementation.
- [2024-12-23] Session 2 started. Continuing from: Open (ready for implementation)
- [2024-12-23] Session 2: Implementation complete. Created DocumentFilterService with 8 default rules, added EmailAttachment filter fields, integrated filtering into syncAllAttachments(). Preflight passed.

## Related Issues

- OPS-089: /documents Section with Folders (document organization)
- OPS-111: Document Grid UI with Thumbnails (document display)

## Estimated Impact

Based on typical email patterns:

- Calendar invites (.ics): ~5-10% of attachments
- Tiny images (< 5KB): ~20-30% of attachments
- Email signature images: ~10-15%
- Inline decorative: ~5-10%

**Total estimated reduction: 40-60% of attachment noise**
