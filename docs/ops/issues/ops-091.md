# OPS-091: Include Sent Emails in Thread Display

| Field    | Value                                 |
| -------- | ------------------------------------- |
| ID       | OPS-091                               |
| Title    | Include Sent Emails in Thread Display |
| Type     | Feature                               |
| Priority | P1-High                               |
| Status   | Verifying                             |
| Created  | 2025-12-21                            |
| Updated  | 2025-12-21                            |

---

## Problem Statement

Currently, the email sync only pulls from the Inbox folder (`/me/mailFolders/Inbox/messages`), excluding sent emails entirely. This breaks conversation flow in threads:

```
1. Client → Firm (received) ✓ visible
2. Firm → Client (sent)     ✗ missing
3. Client → Firm (received) ✓ visible
```

Users see messages 1 and 3, but their own reply (message 2) is missing, making threads confusing and hard to follow.

---

## Solution

Sync the Sent Items folder in addition to Inbox, then display both interleaved by date with visual distinction.

---

## Implementation Plan

### Phase 1: Data Layer

#### 1.1 Schema Update

Add `folderType` field to Email model:

```prisma
// schema.prisma - Email model
folderType    String?   @map("folder_type")  // 'inbox' | 'sent'
```

#### 1.2 Sync Sent Items

Extend `email-sync.service.ts`:

```typescript
// Add endpoint
sentMessages: '/me/mailFolders/SentItems/messages'

// Add sync method
async syncSentEmails(userId: string, accessToken: string) {
  const endpoint = '/me/mailFolders/SentItems/messages';
  // Same sync logic as inbox, but set folderType: 'sent'
}
```

**Key considerations:**

- Use delta sync for Sent Items (same pattern as Inbox)
- Set `folderType: 'sent'` on all emails from this folder
- Backfill existing inbox emails with `folderType: 'inbox'`

#### 1.3 Cleaning Pipeline

**No changes needed** - the existing categorization worker will automatically clean sent emails:

- Removes firm signature
- Removes quoted text (avoids duplication with previous message)
- Extracts only the new content written

---

### Phase 2: Display Layer

#### 2.1 Thread Query Update

Modify email thread queries to include sent emails:

- Interleave by `receivedDateTime` (or `sentDateTime` for sent)
- Return `folderType` in GraphQL response

#### 2.2 Visual Distinction

Update `EmailThreadView.tsx` and `MessageView.tsx`:

**Received emails** (current style):

- Full card treatment
- White/neutral background
- Full expand by default for latest

**Sent emails** (lighter treatment):

- Blue-tinted left border or subtle right offset
- Slightly more compact
- Collapsed by default (user knows what they wrote)
- "You" or "Dvs." as sender label

```
┌─────────────────────────────────────────┐
│ ○ Ion Popescu                  10 Dec   │  ← received
│   Re: Contract review                   │
│   Am primit documentele și am câteva... │
└─────────────────────────────────────────┘

          ┌─────────────────────────────────┐
          │ Dvs.                    11 Dec │  ← sent (compact)
          │ Bună ziua, vă trimit anex...   │
          └─────────────────────────────────┘

┌─────────────────────────────────────────┐
│ ○ Ion Popescu                  12 Dec   │  ← received
│   Re: Re: Contract review               │
│   Mulțumesc, am verificat și sunt...    │
└─────────────────────────────────────────┘
```

---

## Files to Modify

### Phase 1 (Data)

- `packages/database/prisma/schema.prisma` - Add `folderType` field
- `services/gateway/src/services/email-sync.service.ts` - Add Sent Items sync
- `services/gateway/src/config/graph.config.ts` - Add sent endpoint
- Migration script for backfilling existing emails

### Phase 2 (Display)

- `services/gateway/src/services/email-thread.service.ts` - Include sent in threads
- `services/gateway/src/graphql/schema/email.graphql` - Expose `folderType`
- `apps/web/src/components/email/EmailThreadView.tsx` - Visual distinction
- `apps/web/src/components/communication/MessageView.tsx` - Visual distinction

---

## Acceptance Criteria

- [x] Sent Items folder is synced alongside Inbox
- [x] Sent emails have `folderType: 'sent'` in database
- [x] Existing inbox emails backfilled with `folderType: 'inbox'`
- [x] Sent emails are cleaned (signatures, quoted text removed) - _existing cleaning pipeline handles this_
- [x] Threads display both sent and received emails interleaved by date
- [x] Sent emails have distinct visual treatment (compact, blue accent)
- [x] Sent emails collapsed by default in thread view
- [ ] "Show original" toggle works for sent emails - _pending verification_
- [x] Delta sync works for both folders - _simplified to full sync with skipDuplicates_

---

## Technical Notes

### Why not `/me/messages`?

Using the all-folders endpoint would include Drafts, Junk, Deleted Items. Syncing specific folders (Inbox + Sent) is cleaner and more predictable.

### Conversation threading

Microsoft Graph provides `conversationId` which already groups related emails. The threading logic should continue to work - we're just adding more emails to existing threads.

### Multi-user considerations

When multiple firm members are on a thread, all their sent emails should appear (each user syncs their own Sent Items). The `from` field distinguishes who sent what.

---

## Out of Scope

- Drafts folder sync
- Outbox/scheduling
- Sent email editing/recall

---

## References

- OPS-090: Email Content Cleaning (existing cleaning pipeline)
- OPS-008: Communications section overhaul
- Ideation session: Chat-style email display exploration

---

## Session Log

### 2025-12-21 - Issue Created

- Identified root cause: Inbox-only sync excludes sent emails
- Confirmed cleaning pipeline will handle sent emails automatically
- Defined two-phase approach: Data layer + Display layer
- Visual design: Compact sent emails with blue accent, collapsed by default

### 2025-12-21 - Session 1: Implementation Complete

**Phase 1 (Data Layer):**

- Added `folderType` field to Email schema in Prisma
- Created migration `20251221170000_add_email_folder_type`
- Fixed previous migration bug (Email → emails table name)
- Backfilled 1109 existing emails with `folderType: 'inbox'`
- Updated `email-sync.service.ts` to sync both Inbox and Sent Items
- Added `sentMessages` endpoint to graph.config.ts

**Phase 2 (Display Layer):**

- Added `folderType` to GraphQL schema and resolvers
- Updated `email-thread.service.ts` to include folderType
- Updated `EmailThreadView.tsx` with sent email visual distinction:
  - Blue-tinted left border + subtle right offset (ml-8)
  - "Dvs." label with sent icon badge
  - More compact padding (p-3 vs p-4)
  - Shows "Către: [recipients]" instead of sender name
  - Collapsed by default (latest non-sent email expanded)
- Added `folderType` to GraphQL fragment in useEmailSync.ts

**Status:** Ready for local verification
