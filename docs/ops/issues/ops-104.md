# OPS-104: Document Preview Fails for Non-Uploader Users

| Field             | Value                                    |
| ----------------- | ---------------------------------------- |
| **Status**        | Superseded                               |
| **Type**          | Bug                                      |
| **Priority**      | P1-High                                  |
| **Created**       | 2025-12-22                               |
| **Sessions**      | 3                                        |
| **Last Active**   | 2025-12-22 18:30                         |
| **Superseded By** | OPS-105 → OPS-111 (SharePoint Migration) |

## Description

Document previews are not visible for users assigned to the respective case. When a non-Partner user (Associate, Paralegal) who is assigned to a case tries to preview a document, they see "Previzualizare indisponibilă" (Preview unavailable) with the message "Nu s-a putut genera link-ul de previzualizare" (Could not generate preview link).

The same documents preview correctly for the Partner user who uploaded them.

## Symptom Category

**Category A**: X Not Appearing in UI

## Investigation Summary

| Hypothesis                   | Verdict       | Key Finding                                                                        |
| ---------------------------- | ------------- | ---------------------------------------------------------------------------------- |
| Frontend authorization       | ✅ Clear      | No role-based checks in frontend; delegates to backend                             |
| API resolver authorization   | ✅ Clear      | `canAccessDocument()` correctly authorizes case-assigned users                     |
| MS access token availability | ✅ Clear      | User re-authenticated with MSAL; token is available                                |
| OneDrive API path            | ❌ Root cause | Uses `/me/drive/items/` which refers to CURRENT user's drive, not document owner's |

## Root Cause

**The OneDrive API endpoints use `/me/drive/items/` which refers to the current authenticated user's personal OneDrive, not the document owner's OneDrive.**

**File:** `services/gateway/src/config/graph.config.ts` (line 116)

```typescript
driveItem: (itemId: string) => `/me/drive/items/${itemId}`,
```

**And in:** `services/gateway/src/services/onedrive.service.ts` (line 551)

```typescript
.api(`/me/drive/items/${oneDriveId}/preview`)
```

**Root Cause Chain:**

1. Partner (Lucian Bojin) uploads document → saved to HIS personal OneDrive (`bojinlucian-my.sharepoint.com/personal/lucian_bojin_bojin-law_com`)
2. Database stores `oneDriveId` (the item ID in Lucian's drive)
3. Associate (Oana Mititelu) tries to preview the document
4. System calls `/me/drive/items/${oneDriveId}/preview` using Oana's access token
5. `/me` refers to OANA's OneDrive, not Lucian's
6. File doesn't exist in Oana's OneDrive → API returns error/null
7. No R2 fallback available (document only in OneDrive) → preview returns null
8. Frontend shows "Preview unavailable"

**Evidence:**

- Tested with Playwright: Partner user sees preview, Associate user sees "Previzualizare indisponibilă"
- Network requests show all GraphQL calls return 200 OK (no auth errors)
- The document IS stored in Lucian's personal OneDrive (URL shows `bojinlucian-my.sharepoint.com/personal/lucian_bojin_bojin-law_com`)

## Recommended Fix

### Option 1: Store owner's drive context (Recommended)

1. Add `oneDriveUserId` field to Document model to track whose OneDrive the file is in
2. Update `graphEndpoints.driveItem` to accept owner context:
   ```typescript
   driveItemByOwner: (ownerId: string, itemId: string) => `/users/${ownerId}/drive/items/${itemId}`,
   ```
3. Update OneDrive service to use owner-aware endpoints
4. Requires `Files.Read.All` permission to read other users' drives

### Option 2: Use SharePoint Document Library (Better long-term)

1. Create a shared SharePoint document library for the firm
2. Store documents there instead of personal OneDrives
3. All firm members have access to the shared library
4. Update upload flow to use `/sites/{siteId}/drive/...` instead of `/me/drive/...`

### Option 3: App-only permissions with service principal

1. Configure app-only authentication for OneDrive access
2. Service can access any user's OneDrive with admin consent
3. Requires `Files.Read.All` application permission

## Fix Applied

**Session 2: Implemented Option 1 - Store owner's drive context**

### Changes Made:

1. **Schema Update** (`packages/database/prisma/schema.prisma`):
   - Added `oneDriveUserId` field to Document model to store the MS Graph user ID of the OneDrive owner

2. **Migration** (`packages/database/prisma/migrations/20251222180000_add_one_drive_user_id/migration.sql`):
   - Added column `one_drive_user_id` to documents table
   - Backfilled existing 393 documents with the uploader's `azureAdId`

3. **Graph Endpoints** (`services/gateway/src/config/graph.config.ts`):
   - Added `driveItemByOwner(ownerId, itemId)` endpoint: `/users/${ownerId}/drive/items/${itemId}`
   - Added `driveItemContentByOwner(ownerId, itemId)` endpoint

4. **OneDrive Service** (`services/gateway/src/services/onedrive.service.ts`):
   - Updated `getPreviewUrl()` to accept optional `oneDriveUserId` parameter
   - Updated `getDocumentDownloadLink()` to accept optional `oneDriveUserId` parameter
   - Updated `getFileThumbnail()` to accept optional `oneDriveUserId` parameter
   - All methods now use `/users/${ownerId}/drive/items/` when `oneDriveUserId` is provided

5. **Document Resolver** (`services/gateway/src/graphql/resolvers/document.resolvers.ts`):
   - Updated `documentPreviewUrl` resolver to pass `document.oneDriveUserId` to OneDrive service
   - Updated OneDrive upload mutation to capture and store `uploader.azureAdId` as `oneDriveUserId`

### How It Works Now:

1. When Partner uploads a document:
   - Document is saved to Partner's OneDrive
   - `oneDriveId` stores the file ID
   - `oneDriveUserId` stores Partner's MS Graph user ID (from `azureAdId`)

2. When Associate tries to preview:
   - System calls `/users/${oneDriveUserId}/drive/items/${oneDriveId}/preview`
   - This accesses Partner's OneDrive using Associate's token
   - **Requires `Files.Read.All` permission** (already configured in Azure app registration)

## Environment Strategy

| Mode                   | Command                        | Use When                     |
| ---------------------- | ------------------------------ | ---------------------------- |
| Local dev (default)    | `pnpm dev`                     | Feature development          |
| Production data        | `source .env.prod && pnpm dev` | Bug investigation, real data |
| Production-like Docker | `pnpm preview`                 | Pre-deploy verification      |
| Full parity check      | `pnpm preflight:full`          | Before any deployment        |

**Recommended for this issue**: Local dev with multiple user accounts for testing

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

> ⚠️ Issue cannot be closed until all three steps are ✅

## Session Log

- [2025-12-22 17:30] Issue created via /ops-investigate. Category: A. Root cause: OneDrive API uses `/me/drive/items/` which refers to current user's drive, not document owner's drive.
- [2025-12-22 18:00] Session 2 started. Implemented fix using Option 1 (store owner's drive context). Added `oneDriveUserId` field to Document model, updated OneDrive service methods to use owner-aware endpoints, migration includes backfill for existing 393 documents.
- [2025-12-22 18:30] **SUPERSEDED**. Investigation revealed fundamental limitation: `Files.Read.All` **delegated** permission does NOT grant access to other users' OneDrive files. Microsoft docs confirm: "the application can't access anything the signed-in user couldn't access." The `/users/{ownerId}/drive/items/` approach only works with **application** permissions (service principal with admin consent). Decision: migrate to SharePoint instead, which uses site-level permissions where all members can access all documents. See OPS-105 → OPS-111.

## Files Involved

**Modified files:**

- `packages/database/prisma/schema.prisma` - Added `oneDriveUserId` field to Document model
- `packages/database/prisma/migrations/20251222180000_add_one_drive_user_id/migration.sql` - Migration + backfill
- `services/gateway/src/config/graph.config.ts` - Added `driveItemByOwner` endpoint
- `services/gateway/src/services/onedrive.service.ts` - Updated preview/download/thumbnail methods
- `services/gateway/src/graphql/resolvers/document.resolvers.ts` - Pass `oneDriveUserId` to service

## Acceptance Criteria

1. Document preview works for ANY firm user assigned to a case containing the document
2. Preview works regardless of who uploaded the document
3. No changes to authorization logic (case assignment check remains)
4. Graceful fallback when preview is unavailable

---
