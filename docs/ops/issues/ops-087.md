# OPS-087: Document & Attachment Preview

**Type:** Feature
**Priority:** P2-Medium
**Status:** Open
**Created:** 2025-12-21

## Problem

Users cannot preview documents or email attachments inline. Currently:

- Email attachments in `/comms` only show metadata + download button
- Document detail pages show "Document preview not available" placeholder
- Users must download files to view them, slowing metadata/classification decisions

## Context

From ideation session:

- **Primary file types**: Word (.docx) and PDF
- **Storage**: Working documents live in OneDrive (R2 is only for temporary/task storage)
- **Use case**: Preview is for metadata decisions - read-only, needs to be large enough to assess content
- **Mobile**: Can link out to OneDrive app/web (no inline preview required)

## Solution

OneDrive-first preview leveraging existing Microsoft 365 integration:

### PDF Preview

- Native browser `<iframe>` with OneDrive download URL
- Works in all browsers without dependencies
- Full-page modal with zoom controls

### Word Preview

- Office Online embed: `https://view.officeapps.live.com/op/embed.aspx?src={encodedUrl}`
- Full fidelity rendering included with M365 subscription
- Read-only view sufficient for metadata decisions

### Mobile

- "Deschide în OneDrive" button → opens OneDrive app or web

## Implementation

### Phase 1: Preview Modal Component

- [ ] Create `DocumentPreviewModal.tsx` component
  - Large overlay (90vh height)
  - Document title + metadata summary header
  - Full preview area (iframe)
  - "Descarcă" download button
  - Close button (X + Escape key)
- [ ] Add content-type detection for routing (PDF vs Word vs other)
- [ ] Handle loading states and errors

### Phase 2: OneDrive Preview URLs

- [ ] Add `getPreviewUrl()` method to `onedrive.service.ts`
  - For PDFs: return download URL (browser renders natively)
  - For Word/Excel/PPT: return Office Online embed URL
- [ ] Add `previewUrl` field to Document GraphQL type
- [ ] Add `previewUrl` to EmailAttachment type (for OneDrive-stored attachments)

### Phase 3: Integration Points

- [ ] `/comms` - Add preview button to `EmailAttachmentsPanel.tsx`
- [ ] `/comms` - Add preview to `MessageView.tsx` attachment list
- [ ] `/documents` - Replace "preview not available" with actual preview
- [ ] Case documents tab - Enable preview from document list

### Phase 4: Edge Cases

- [ ] R2-stored attachments: Show "Descarcă" only (no preview)
- [ ] Unsupported file types: Show file icon + download button
- [ ] Large files: Show warning before loading
- [ ] Mobile viewport: "Deschide în OneDrive" button instead of embed

## Files Affected

**New:**

- `apps/web/src/components/preview/DocumentPreviewModal.tsx`
- `apps/web/src/components/preview/PreviewButton.tsx`
- `apps/web/src/hooks/useDocumentPreview.ts`

**Modified:**

- `services/gateway/src/services/onedrive.service.ts` - add preview URL generation
- `services/gateway/src/graphql/schema/document.graphql` - add previewUrl field
- `services/gateway/src/graphql/schema/email.graphql` - add previewUrl to attachment
- `services/gateway/src/graphql/resolvers/document.resolvers.ts` - resolve previewUrl
- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - resolve attachment previewUrl
- `apps/web/src/components/email/EmailAttachmentsPanel.tsx` - add preview button
- `apps/web/src/components/communication/MessageView.tsx` - add preview to attachments
- `apps/web/src/app/documents/page.tsx` - enable preview
- `apps/web/src/app/cases/[caseId]/documents/[documentId]/page.tsx` - replace placeholder

## Acceptance Criteria

1. Users can click an attachment in `/comms` and see inline preview
2. Users can preview documents in `/documents` without downloading
3. PDF files render in native browser viewer (iframe)
4. Word files render via Office Online embed
5. Preview modal is large enough for content assessment (~90vh)
6. Mobile shows "Deschide în OneDrive" link instead of embed
7. R2-stored files show download-only (no preview attempt)
8. Loading and error states are handled gracefully

## Notes

- Office Online embed is free with M365 subscription
- No additional JS libraries needed (no PDF.js, mammoth.js)
- Preview URLs may need to be generated on-demand (not cached)
- Consider adding preview to task attachments in future iteration

## Session Log

### 2025-12-21 - Issue Created

- Completed ideation session exploring 4 approaches
- Chose hybrid OneDrive-first approach based on:
  - Word/PDF are primary formats
  - Working docs already in OneDrive
  - Office Online provides full fidelity for Word
  - Native browser handles PDFs well
- Verified storage architecture: OneDrive for working docs, R2 for temp/tasks
