# OPS-256: AI Document Generation Should Create .docx Files in SharePoint

**Type**: Feature
**Priority**: P1-High
**Status**: Verifying
**Created**: 2025-12-26
**Implemented**: 2025-12-26

## Problem

When the AI Assistant generates a document (e.g., "Generează un contract de cesiune părți sociale"), it currently:

1. Returns the generated text content to the UI
2. Does NOT create an actual .docx file
3. Does NOT upload to SharePoint
4. Does NOT create a Document record in the database

This means users cannot:

- Open the generated document in Word
- Have their edits tracked/synced
- See the document in the case's document list

## Expected Behavior

When user confirms document generation:

1. AI generates text content (current flow - works)
2. **Convert to .docx format** using `docx` npm package
3. **Upload to SharePoint** using `sharePointService.uploadDocument()`
4. **Create Document record** in database with `sharePointItemId`
5. **Link to case** via `CaseDocument` junction table
6. Return the document so user can open in Word (`ms-word:ofe|u|{webUrl}`)

Future edits in Word should sync back (already works via OPS-182 lazy sync).

## Implementation Plan

### Phase 1: Add docx Package

```bash
pnpm --filter gateway add docx
```

### Phase 2: Create DocxGenerator Service

Create `services/gateway/src/services/docx-generator.service.ts`:

- Convert markdown/HTML content to .docx format
- Support legal document formatting (headers, paragraphs, lists)
- Add metadata (title, author, creation date)

### Phase 3: Modify Document Generation Flow

Update `action-executor.service.ts` `executeGenerateDocument()` to:

1. Generate text content (existing)
2. Convert to .docx (new)
3. Get case context for SharePoint folder path
4. Upload to SharePoint (new)
5. Create Document record with `sharePointItemId` (new)
6. Create CaseDocument link (new)
7. Return document ID and webUrl for Word opening

### Phase 4: Update AI Assistant Response

After document generation, AI should:

- Confirm document was created
- Provide "Deschide în Word" action button
- Show document in case's document list

## Key Files

- `services/gateway/src/services/action-executor.service.ts` - `executeGenerateDocument()`
- `services/gateway/src/services/document-generation.service.ts` - generates content
- `services/gateway/src/services/sharepoint.service.ts` - SharePoint upload
- `services/gateway/src/services/word-integration.service.ts` - Word sync

## Dependencies

- Existing OPS-248: document_drafting feature config (just completed)
- OPS-182: SharePoint sync on document access (existing)
- OPS-184: OneDrive to SharePoint migration (existing)

## Acceptance Criteria

- [x] AI-generated documents are saved as .docx files
- [x] Documents are uploaded to SharePoint in the case folder
- [x] Document records are created in the database
- [x] Documents appear in the case's document list
- [x] User can open generated documents in Word (via `ms-word:ofe|u|{webUrl}`)
- [x] Edits in Word are synced back to the system (existing functionality via OPS-182)

## Technical Notes

- The `docx` npm package creates Office Open XML format (.docx) natively
- SharePoint folder structure: `/Cases/{CaseNumber}/Documents/{filename}.docx`
- Need to handle file naming conflicts (append timestamp or version)
- Consider adding a "draft" status for AI-generated documents

## Implementation Notes (2025-12-26)

### Files Changed

1. **`services/gateway/src/services/docx-generator.service.ts`** (NEW)
   - Converts markdown/HTML to .docx using `docx` npm package
   - Supports headings (#-######), bold (\*_), italic (_), lists, horizontal rules
   - Adds firm name header and page numbers
   - Metadata: title, author, subject, creator

2. **`services/gateway/src/services/action-executor.service.ts`**
   - Modified `executeGenerateDocument()` to:
     - Generate .docx using `docxGeneratorService`
     - Upload to SharePoint via `sharePointService.uploadDocument()`
     - Create Document record with `sourceType: AI_GENERATED`
     - Link to case via CaseDocument
   - Stores SharePoint webUrl in metadata for "Open in Word" action

3. **`services/gateway/src/services/ai-assistant.service.ts`**
   - Updated `executeGenerateDocument()` with same changes as action-executor
   - This is the version used by direct AI tool calls

4. **`services/gateway/src/services/ai-tools.schema.ts`**
   - Updated `generate_document` tool description to explicitly instruct AI to use `search_cases` first when user mentions a case by name
   - Added note that caseId is required for SharePoint save

5. **`services/gateway/package.json`**
   - Added `docx` dependency

### Flow

```
User asks AI: "Generează un contract..."
→ AI generates markdown content
→ docxGeneratorService.markdownToDocx() creates .docx Buffer
→ sharePointService.uploadDocument() uploads to /Cases/{CaseNumber}/Documents/
→ Document record created with sharePointItemId
→ CaseDocument link created
→ Response includes: "Documentul a fost generat și salvat în SharePoint"
```

### Bug Fix: "Case not found" Error (Two Root Causes)

During testing, discovered that when user asks to generate a document for a case by name (not from case page), the AI wasn't properly passing the caseId:

**Root Cause 1: Tool schema didn't instruct AI to search first**

1. **Problem**: AI said "Am găsit dosarul X" then "Eroare: Case not found"
2. **Root cause**: `generate_document` tool description didn't instruct AI to use `search_cases` first
3. **Fix**: Updated tool schema to explicitly say:
   - "IMPORTANT: Necesită caseId valid pentru a salva documentul"
   - "Dacă utilizatorul menționează un dosar după nume, folosește MAI ÎNTÂI search_cases"
4. **Also found**: There were TWO `executeGenerateDocument` methods (ai-assistant.service.ts and action-executor.service.ts) - both needed updating

**Root Cause 2: AI using caseNumber instead of UUID** (VERIFIED FIX)

1. **Problem**: After first fix, AI still failed - gateway logs showed:
   - `search_cases` returned `id: '6d51aba7-3bd0-4a0a-b038-d848589aada0'`
   - But `generate_document` was called with `caseId: 'f8f501d6-2025-003'` (the case number!)
2. **Root cause**: Search results format showed both `[ID: uuid]` and `(caseNumber)`, AI confused them
3. **Fix** (ai-assistant.service.ts):
   - Changed output format from: `• [ID: ${c.id}] ${c.title} (${c.caseNumber})`
   - To: `• ${c.title} - ${c.status}\n  caseId: ${c.id}`
   - Added explicit instruction: "IMPORTANT: Pentru orice operațiune pe aceste dosare, folosește valoarea caseId de mai sus"
4. **Fix** (ai-tools.schema.ts):
   - Added to caseId description: "TREBUIE să fie un UUID (ex: 6d51aba7-...), NU numărul dosarului (care arată ca f8f501d6-2025-003)"
5. **Verification**: After fix, gateway logs show correct UUID being passed:
   ```
   confirmAction original input: {"caseId":"6d51aba7-3bd0-4a0a-b038-d848589aada0",...}
   ```

### Testing Status

- [x] AI calls `search_cases` first when case mentioned by name ✅
- [x] AI passes correct UUID (not caseNumber) to `generate_document` ✅
- [ ] .docx appears in SharePoint case folder (blocked by AI service network error)
- [ ] Document appears in case Documents tab
- [ ] "Open in Word" works (ms-word: protocol)
- [ ] Edit in Word syncs back (OPS-182)

**Note**: Further testing blocked by AI service network error (ECONNREFUSED to Anthropic API). This is a separate infrastructure issue.

## Related Issues

- OPS-248: Add document_drafting to AI Feature Config (completed)
- Story 3.3: Document Drafting QA (passed 90/100)
