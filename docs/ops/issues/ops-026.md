# [OPS-026] AI Thread Summary Agent for Communications Tab

| Field           | Value      |
| --------------- | ---------- |
| **Status**      | Fixing     |
| **Type**        | Feature    |
| **Priority**    | P2-Medium  |
| **Created**     | 2025-12-15 |
| **Sessions**    | 3          |
| **Last Active** | 2025-12-15 |

---

## Description

In case details → Communications tab, implement an AI agent that keeps an up-to-date summary of the entire email thread/conversation for the case. The summary should automatically refresh when new emails are added to the case.

**User Request:**

> "In case details -> communications we need to spin off an ai agent that keeps an up-to-date summary of the entire thread"

---

## Investigation Summary

| Component                   | Status    | Details                                                        |
| --------------------------- | --------- | -------------------------------------------------------------- |
| ThreadSummaryPanel          | ✅ Exists | `apps/web/src/components/communication/ThreadSummaryPanel.tsx` |
| CaseThreadSummariesPanel    | ✅ Exists | Shows multiple thread analyses per case                        |
| useThreadSummary hook       | ✅ Exists | `apps/web/src/hooks/useExtractedItems.ts`                      |
| useCaseThreadSummaries hook | ✅ Exists | Fetches all summaries for a case                               |
| ThreadAnalysis AI operation | ✅ Exists | Supported in AI service                                        |
| Background workers pattern  | ✅ Exists | `services/gateway/src/workers/`                                |

### Gap Analysis

The current implementation provides thread summaries, but they are:

1. **On-demand only** - Generated when user clicks "Analyze Thread" button
2. **Not auto-updating** - Don't refresh when new emails arrive in the case
3. **Not visible in CommunicationsTab** - The existing `CaseThreadSummariesPanel` is not integrated into the case Communications tab
4. **Per-thread granularity** - Each email thread gets its own summary, but there's no aggregated "case conversation summary"

### What's Needed

1. **Auto-trigger on email arrival** - When new emails are linked to a case, trigger summary regeneration
2. **Visible summary section** - Add a collapsible "AI Summary" panel to CommunicationsTab
3. **Case-level aggregate** - Optionally: aggregate all thread summaries into a single case conversation summary

---

## Recommended Implementation

### Option A: Quick Win - Integrate Existing Components

Add the existing `CaseThreadSummariesPanel` to `CommunicationsTab.tsx`:

```tsx
// In CommunicationsTab.tsx
import { CaseThreadSummariesPanel } from '../../communication/ThreadSummaryPanel';

// Add above UnifiedTimeline:
<CaseThreadSummariesPanel caseId={caseId} />;
```

**Pros:** Fast to implement, uses existing code
**Cons:** Still on-demand (user must click "Reanalyze")

### Option B: Auto-Update Worker

Create a background worker that monitors for new case emails and triggers thread analysis:

1. **Email arrival trigger** - In `email.resolvers.ts`, after linking email to case, publish event
2. **Worker processing** - New `case-thread-summary.worker.ts` listens for event, triggers analysis
3. **Real-time update** - Use GraphQL subscription to push updated summary to UI

**Files to modify:**

- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - Add event publishing
- `services/gateway/src/workers/case-thread-summary.worker.ts` - New worker
- `apps/web/src/components/case/tabs/CommunicationsTab.tsx` - Add summary panel
- `services/gateway/src/graphql/schema/communication-intelligence.graphql` - Add subscription

### Option C: Full Case Summary Agent (Most Comprehensive)

Build a dedicated "Case Conversation Agent" that:

1. Monitors all emails linked to a case
2. Maintains a rolling summary of the entire case conversation
3. Highlights key developments, action items, and position changes
4. Auto-updates in real-time via WebSocket/subscription

**New components needed:**

- `CaseSummaryAgent` - Backend agent service
- `CaseSummaryPanel` - Frontend display component
- `useCaseSummary` - React hook
- GraphQL schema additions

---

## Recommended Approach

**Start with Option A** for immediate visibility, then build **Option B** for auto-updates.

### Phase 1: Quick Integration (Option A)

- Add `CaseThreadSummariesPanel` to `CommunicationsTab`
- Estimated effort: 1 session

### Phase 2: Auto-Trigger (Option B)

- Add event-driven summary regeneration
- Estimated effort: 2-3 sessions

### Phase 3: Aggregate Summary (Option C - Optional)

- Build case-level aggregate summary
- Estimated effort: 3-4 sessions

---

## Files Involved

### Modified (Session 2)

- `apps/web/src/components/case/tabs/CommunicationsTab.tsx` - Integrated CaseConversationSummaryPanel
- `apps/web/src/components/communication/ThreadSummaryPanel.tsx` - Fixed missing import
- `services/gateway/src/graphql/schema/communication-intelligence.graphql` - Added types
- `services/gateway/src/graphql/resolvers/communication-intelligence.resolvers.ts` - Added mutation

### Created (Session 2)

- `apps/web/src/components/communication/CaseConversationSummaryPanel.tsx` - Frontend component
- `services/ai-service/src/services/case-conversation-summary.service.ts` - AI service (future use)

### For Phase 2 (Not Started)

- `services/gateway/src/graphql/resolvers/email.resolvers.ts` - Hook into email import
- Email import wizard or worker for auto-trigger

---

## Local Verification Status

| Step           | Status     | Date | Notes |
| -------------- | ---------- | ---- | ----- |
| Prod data test | ⬜ Pending |      |       |
| Preflight      | ⬜ Pending |      |       |
| Docker test    | ⬜ Pending |      |       |

**Verified**: No

> ⚠️ Issue cannot be closed until all three steps are ✅

---

## Session Log

- [2025-12-15] Issue created via /ops-investigate. This is a new feature request, not a bug. Existing thread summary infrastructure identified. Gap analysis completed. Three implementation options proposed.
- [2025-12-15] Session 2: Implemented Phase 1 - Full Case Conversation Summary Agent:
  - Created `CaseConversationSummaryPanel.tsx` frontend component
  - Added `generateCaseConversationSummary` GraphQL mutation
  - Added resolver that fetches all case emails and calls AI service
  - Summary includes: executive summary, chronology, key developments, current status, open issues, next steps
  - Fixed missing import bug in `ThreadSummaryPanel.tsx`
  - TypeScript compiles without errors. Ready for local verification.
- [2025-12-15] Session 3 started. Continuing from: Fixing (Phase 1 Complete). Goal: Local verification.
- [2025-12-16] Session 3 fixes:
  - Fixed AI service authentication: Added `AI_SERVICE_API_KEY=dev-ai-service-key` to both `services/gateway/.env` and `services/ai-service/.env`
  - Updated AI prompts to Romanian: System prompt and user prompt now fully in Romanian
  - Made prompts concise: Told AI the summary is for the representing lawyer, be brief and direct
  - Disabled response caching: Added `useCache: false` to always generate fresh summaries
  - Model: Using Claude Sonnet 4 (`claude-sonnet-4-20250514`)

---
